---
phase: 08-build-polish-output-timing-integration
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - /Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js
autonomous: true

must_haves:
  truths:
    - "Integration test verifies checkpoint → update → build workflow end-to-end"
    - "All v1.1 fixes verified working together in E2E test suite"
    - "Test validates Iron Law enforcement, checkpoint safety, and update rollback"
  artifacts:
    - path: "/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js"
      provides: "E2E test for complete v1.1 workflow"
      min_lines: 150
      exports: ["test workflow succeeds", "test Iron Law blocks without evidence", "test update rollback preserves state"]
  key_links:
    - from: "checkpoint-update-build.test.js"
      to: "StateGuard, UpdateTransaction, checkpoint system"
      via: "require statements and function calls"
      pattern: "require.*bin/lib"
---

<objective>
Create E2E integration test that verifies all v1.1 fixes work together in the checkpoint → update → build workflow.

Purpose: Individual unit tests verify components in isolation. This integration test ensures the complete workflow functions correctly: safe checkpoints (Phase 6), state guards with Iron Law (Phase 7), and update transactions with rollback (Phase 7) all work together.

Output: Comprehensive E2E test file covering the complete v1.1 workflow.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@/Users/callumcowie/repos/Aether/.planning/ROADMAP.md
@/Users/callumcowie/repos/Aether/.planning/REQUIREMENTS.md
@/Users/callumcowie/repos/Aether/.planning/phases/08-build-polish-output-timing-integration/08-RESEARCH.md
@/Users/callumcowie/repos/Aether/.planning/STATE.md

# Prior phase summaries for integration context
@/Users/callumcowie/repos/Aether/.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-06-SUMMARY.md
@/Users/callumcowie/repos/Aether/.planning/phases/07-core-reliability-state-guards-update-system/07-06-SUMMARY.md

# Reference existing E2E test for patterns
@/Users/callumcowie/repos/Aether/tests/e2e/update-rollback.test.js
@/Users/callumcowie/repos/Aether/tests/integration/state-guard-integration.test.js

# Reference modules under test
@/Users/callumcowie/repos/Aether/bin/lib/init.js
@/Users/callumcowie/repos/Aether/bin/lib/state-guard.js
@/Users/callumcowie/repos/Aether/bin/lib/update-transaction.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test file structure</name>
  <files>/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</files>
  <action>
    Create the E2E test file at tests/e2e/checkpoint-update-build.test.js with the following structure:

    1. Header comment explaining test purpose
    2. Require statements for:
       - ava (test framework)
       - fs, path, os (Node built-ins)
       - execSync (for CLI commands)
       - initializeRepo, isInitialized from bin/lib/init
       - UpdateTransaction from bin/lib/update-transaction
       - StateGuard, StateGuardError from bin/lib/state-guard
       - createCheckpoint from bin/cli.js (or implement inline)

    3. Test helper functions:
       - createTempDir(): Create temp directory for test isolation
       - cleanupTempDir(dir): Cleanup after tests
       - createValidEvidence(phase): Generate valid verification evidence for StateGuard

    4. Test configuration:
       - Use test.serial() for all tests (file system state is shared)
       - Set timeout appropriately for integration tests (60s)

    Reference tests/e2e/update-rollback.test.js for the established patterns.
  </action>
  <verify>head -50 /Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</verify>
  <done>E2E test file created with proper imports and helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Implement Test 1 - Complete workflow succeeds</name>
  <files>/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</files>
  <action>
    Add Test 1: "complete workflow succeeds" that verifies:

    1. Initialize a new repo using initializeRepo()
       - Verify isInitialized() returns true
       - Verify COLONY_STATE.json exists with correct structure

    2. Create a checkpoint using the checkpoint system
       - Verify checkpoint metadata file exists
       - Verify checkpoint only contains Aether-managed files (no user data)

    3. Verify StateGuard enforces Iron Law
       - Create StateGuard instance
       - Attempt to advance phase WITHOUT evidence - should throw StateGuardError
       - Advance phase WITH valid evidence - should succeed

    4. Verify state advancement
       - Read COLONY_STATE.json
       - Verify current_phase was updated
       - Verify events array contains phase transition event

    5. Verify audit trail
       - Check events array has proper structure
       - Verify event contains timestamp, type, worker attribution

    Assertions to include:
    - t.true(isInitialized(tmpDir))
    - t.truthy(checkpointResult.checkpoint_id)
    - t.true(fs.existsSync(checkpointPath))
    - await t.throwsAsync(() => guard.advancePhase(...), { instanceOf: StateGuardError })
    - t.is(result.status, 'transitioned')
    - t.is(state.current_phase, 1)
  </action>
  <verify>grep -A 5 "complete workflow succeeds" /Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js | head -10</verify>
  <done>Test 1 implemented covering initialization, checkpoint, and state advancement</done>
</task>

<task type="auto">
  <name>Task 3: Implement Test 2 - Iron Law enforcement</name>
  <files>/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</files>
  <action>
    Add Test 2: "Iron Law blocks advancement without evidence" that specifically tests:

    1. Initialize repo and set up StateGuard

    2. Test Iron Law enforcement (STATE-01 requirement):
       - Attempt to advance from phase 0 to 1 with EMPTY evidence object
       - Verify StateGuardError is thrown
       - Verify error code is E_IRON_LAW_VIOLATION
       - Verify error message mentions missing verification evidence

    3. Test idempotency (STATE-02 requirement):
       - Advance phase with valid evidence
       - Attempt to advance to SAME phase again
       - Verify it returns "already_complete" status (not an error)

    4. Test state lock (STATE-03 requirement):
       - Verify StateGuard acquires lock during transitions
       - Check that lock file exists during operation (may need to test indirectly)

    5. Test audit trail (STATE-04 requirement):
       - Verify events are logged with proper structure
       - Check event types include PHASE_TRANSITION

    Use the patterns from tests/unit/state-guard.test.js for reference on testing StateGuard behavior.
  </action>
  <verify>grep -A 5 "Iron Law blocks advancement" /Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js | head -10</verify>
  <done>Test 2 implemented covering Iron Law, idempotency, and audit trail</done>
</task>

<task type="auto">
  <name>Task 4: Implement Test 3 - Update rollback preserves state</name>
  <files>/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</files>
  <action>
    Add Test 3: "update rollback preserves state" that verifies:

    1. Initialize repo with known state
       - Set a specific goal in COLONY_STATE.json
       - Record initial state hash/content

    2. Create checkpoint before update (UPDATE-01 requirement)
       - Verify checkpoint is created
       - Store checkpoint reference

    3. Simulate update scenario
       - Create UpdateTransaction instance
       - Mock or simulate a sync operation

    4. Test automatic rollback on failure (UPDATE-03 requirement)
       - Trigger an update failure (can use dry-run or mock)
       - Verify rollback occurs automatically
       - Verify state is restored to pre-update condition

    5. Verify recovery commands (UPDATE-04 requirement)
       - Check that UpdateError includes recoveryCommands
       - Verify commands are displayed prominently

    6. Test error handling (UPDATE-05 requirement)
       - Test dirty repo detection (if applicable)
       - Test network failure handling (if applicable)
       - Verify clear error messages

    Reference tests/e2e/update-rollback.test.js for patterns on testing update rollback.
    The test may need to use mocking for some scenarios that are hard to trigger in E2E.
  </action>
  <verify>grep -A 5 "update rollback preserves state" /Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js | head -10</verify>
  <done>Test 3 implemented covering update rollback and error recovery</done>
</task>

<task type="auto">
  <name>Task 5: Run and verify E2E tests</name>
  <files>/Users/callumcowie/repos/Aether/tests/e2e/checkpoint-update-build.test.js</files>
  <action>
    Run the E2E tests to verify they pass:

    ```bash
    npm test -- tests/e2e/checkpoint-update-build.test.js
    ```

    If tests fail:
    1. Read the error output carefully
    2. Fix any import issues (check paths to bin/lib modules)
    3. Fix any async/await issues
    4. Adjust timeouts if tests are timing out
    5. Fix any assertion failures

    Also run the full test suite to ensure no regressions:
    ```bash
    npm test
    ```

    Verify the test count increased appropriately (should add 3 new E2E tests).
  </action>
  <verify>npm test -- tests/e2e/checkpoint-update-build.test.js 2>&1 | tail -20</verify>
  <done>All 3 E2E tests pass and full test suite still passes</done>
</task>

</tasks>

<verification>
1. File tests/e2e/checkpoint-update-build.test.js exists with 150+ lines
2. Test file includes 3 comprehensive E2E tests
3. All tests pass when run individually
4. Full test suite (npm test) still passes with no regressions
5. Tests cover: checkpoint safety, Iron Law enforcement, update rollback
</verification>

<success_criteria>
- Integration test verifies checkpoint → update → build workflow end-to-end
- All v1.1 fixes verified working together:
  - SAFE-01 to SAFE-04: Checkpoint safety verified
  - STATE-01 to STATE-04: State guards verified
  - UPDATE-01 to UPDATE-05: Update system verified
- Test suite passes with new E2E tests included
- Total test count increases by 3 (from 206 to 209)
</success_criteria>

<output>
After completion, create `.planning/phases/08-build-polish-output-timing-integration/08-02-SUMMARY.md`
</output>
