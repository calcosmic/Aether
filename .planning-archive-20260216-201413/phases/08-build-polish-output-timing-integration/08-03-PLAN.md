# Phase 8 Plan 03: Enhanced Commit Integration with AI Descriptions

## Overview

Enhance the **existing** Tier 2 commit suggestion system (Step 2.6 in continue.md, Step 4.6 in pause-colony.md) to generate memorable, specific commit messages by combining AI-provided descriptions with structured metadata.

**Key Innovation:** Replace generic "phase N complete" messages with AI descriptions like "implement task-based routing with precedence chain", combined with Scope/Patterns metadata for messages that humans remember and AI can parse.

## Background

- **Research Base:** `.planning/git-staging-research-1.6.md` (commit conventions), `.planning/git-staging-tier2.md` (Tier 2 design)
- **Current State:** Step 2.6 and Step 4.6 already exist with basic commit suggestion logic
- **Target State:** Same steps, enhanced to capture AI description and structured metadata

**Current commit message format:**
```
aether-milestone: phase 11 complete -- foraging specialization
```

**Target commit message format:**
```
aether-milestone: implement task-based routing with precedence chain (CLI > user > task > caste)

Scope: 11.01
Files: 2 files changed
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ENHANCED COMMIT SUGGESTION FLOW                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Existing Step 2.6:                                                      │
│  ┌─────────────┐    ┌──────────────┐    ┌────────────────────────┐     │
│  │ Call        │ -> │ Generate     │ -> │ Display suggestion     │     │
│  │ generate-   │    │ "milestone"  │    │ Ask Yes/Custom/No      │     │
│  │ commit-msg  │    │ type         │    │ Commit if yes          │     │
│  └─────────────┘    └──────────────┘    └────────────────────────┘     │
│                                                                          │
│  Enhanced Step 2.6:                                                      │
│  ┌─────────────┐    ┌──────────────┐    ┌────────────────────────┐     │
│  │ AI          │ -> │ Generate     │ -> │ Display enhanced       │     │
│  │ describes   │    │ "contextual" │    │ suggestion with        │     │
│  │ what we did │    │ type (new)   │    │ Scope, Files metadata  │     │
│  └─────────────┘    └──────────────┘    └────────────────────────┘     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## Implementation Tasks

### Task 1: Enhance `generate-commit-message` Function

**File:** `runtime/aether-utils.sh`

**Current state (lines 1334-1388):**
```bash
generate-commit-message)
  msg_type="${1:-milestone}"
  phase_id="${2:-0}"
  phase_name="${3:-unknown}"
  summary="${4:-}"
  # ... case statement with milestone|pause|fix
```

**Changes:**

1. **Extend parameter handling** (add new optional parameters):
```bash
generate-commit-message)
  msg_type="${1:-milestone}"
  phase_id="${2:-0}"
  phase_name="${3:-unknown}"
  ai_description="${4:-}"        # NEW: AI-provided description
  plan_num="${5:-01}"           # NEW: Plan number (e.g., "01")
```

2. **Add new "contextual" case** after existing cases:
```bash
case "$msg_type" in
  milestone)
    # EXISTING - unchanged for backward compatibility
    if [[ -n "$summary" ]]; then
      message="aether-milestone: phase ${phase_id} complete -- ${summary}"
    else
      message="aether-milestone: phase ${phase_id} complete -- ${phase_name}"
    fi
    body="All verification gates passed. User confirmed runtime behavior."
    ;;
  pause)
    # EXISTING - unchanged
    message="aether-checkpoint: session pause -- phase ${phase_id} in progress"
    body="Colony paused mid-session. Handoff document saved."
    ;;
  fix)
    # EXISTING - unchanged
    if [[ -n "$summary" ]]; then
      message="fix: ${summary}"
    else
      message="fix: resolve issue in phase ${phase_id}"
    fi
    body="Swarm-verified fix applied and tested."
    ;;
  contextual)
    # NEW: Contextual commit with AI description and metadata

    # Derive subsystem from phase name (e.g., "11-foraging-specialization" -> "foraging")
    subsystem=$(echo "$phase_name" | sed -E 's/^[0-9]+-//' | sed -E 's/-[0-9]+.*$//' | tr '-' ' ')
    [[ -z "$subsystem" ]] && subsystem="phase"

    # Count changed files
    files_changed=0
    if git rev-parse --git-dir >/dev/null 2>&1; then
      files_changed=$(git diff --stat HEAD 2>/dev/null | tail -1 | grep -oE '[0-9]+ file' | grep -oE '[0-9]+' || echo "0")
      if [[ "$files_changed" == "0" ]]; then
        files_changed=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
      fi
    fi

    # Build message with AI description
    if [[ -n "$ai_description" ]]; then
      message="aether-milestone: ${ai_description}"
    else
      # Fallback if no AI description provided
      message="aether-milestone: phase ${phase_id}.${plan_num} complete -- ${phase_name}"
    fi

    # Build structured body
    body="Scope: ${phase_id}.${plan_num}
Files: ${files_changed} files changed"

    # NEW: Return additional metadata for display
    json_ok "{\"message\":\"$message\",\"body\":\"$body\",\"files_changed\":$files_changed,\"subsystem\":\"$subsystem\",\"scope\":\"${phase_id}.${plan_num}\"}"
    exit 0
    ;;
  *)
    # EXISTING - unchanged
    message="aether-checkpoint: phase ${phase_id}"
    body=""
    ;;
esac

# EXISTING - unchanged truncation logic
if [[ ${#message} -gt 72 ]]; then
  message="${message:0:69}..."
fi

# EXISTING - unchanged JSON output for milestone/pause/fix types
json_ok "{\"message\":\"$message\",\"body\":\"$body\",\"files_changed\":$files_changed}"
```

**Backward compatibility note:** Existing calls using "milestone", "pause", or "fix" types continue to work exactly as before. The new "contextual" type is additive only.

### Task 2: Modify `continue.md` Step 2.6

**File:** `.claude/commands/ant/continue.md`

**Current Step 2.6 (lines 737-798):** Already has commit suggestion logic using "milestone" type.

**Enhancement:** Add AI description capture and use "contextual" type.

**Replace the current Step 2.6 content with:**

```markdown
### Step 2.6: Commit Suggestion (Optional)

**This step is non-blocking. Skipping does not affect phase advancement or any subsequent steps. Failure to commit has zero consequences.**

After the phase is advanced and changelog updated, suggest a commit to preserve the milestone.

#### Step 2.6.1: Capture AI Description

**As the AI, briefly describe what was accomplished in this phase.**

Look at:
1. The phase PLAN.md `<objective>` section (what we set out to do)
2. Tasks that were marked complete
3. Files that were modified (from git diff --stat)
4. Any patterns or decisions recorded

**Provide a brief, memorable description** (10-15 words, imperative mood):
- Good: "Implement task-based model routing with keyword detection and precedence chain"
- Good: "Fix build timing by removing background execution from worker spawns"
- Bad: "Phase complete" (too vague)
- Bad: "Modified files in bin/lib" (too mechanical)

Store this as `ai_description` for the commit message.

#### Step 2.6.2: Generate Enhanced Commit Message

```bash
bash .aether/aether-utils.sh generate-commit-message "contextual" {phase_id} "{phase_name}" "{ai_description}" {plan_number}
```

Parse the returned JSON to extract:
- `message` - the commit subject line
- `body` - structured metadata (Scope, Files)
- `files_changed` - file count
- `subsystem` - derived subsystem name
- `scope` - phase.plan format

**Check files changed:**
```bash
git diff --stat HEAD 2>/dev/null | tail -5
```
If not in a git repo or no changes detected, skip this step silently.

**Display the enhanced suggestion:**
```
──────────────────────────────────────────────────
Commit Suggestion
──────────────────────────────────────────────────

  AI Description: {ai_description}

  Formatted Message:
  {message}

  Metadata:
  Scope: {scope}
  Files: {files_changed} files changed
  Preview: {first 5 lines of git diff --stat}

──────────────────────────────────────────────────
```

**Use AskUserQuestion:**
```
Commit this milestone?

1. Yes, commit with this message
2. Yes, but let me edit the description
3. No, I'll commit later
```

**If option 1 ("Yes, commit with this message"):**
```bash
git add -A && git commit -m "{message}" -m "{body}"
```
Display: `Committed: {message} ({files_changed} files)`

**If option 2 ("Yes, but let me edit"):**
Use AskUserQuestion to get the user's custom description:
```
Enter your description (or press Enter to keep: '{ai_description}'):
```
Then regenerate the commit message with the new description and commit.

**If option 3 ("No, I'll commit later"):**
Display: `Skipped. Your changes are saved on disk but not committed.`

**Record the suggestion to prevent double-prompting:**
Set `last_commit_suggestion_phase` to `{phase_id}` in COLONY_STATE.json (add the field at the top level if it does not exist).

**Error handling:** If any git command fails (not a repo, merge conflict, pre-commit hook rejection), display the error output and continue to the next step. The commit suggestion is advisory only -- it never blocks the flow.

Continue to Step 2.7 (Context Clear Suggestion), then to Step 2.5 (Project Completion) or Step 3 (Display Result).
```

### Task 3: Modify `pause-colony.md` Step 4.6

**File:** `.claude/commands/ant/pause-colony.md`

**Current Step 4.6 (lines 99-169):** Already has commit suggestion logic using "pause" type.

**Enhancement:** Similar structure to continue.md, but adapted for pause context.

**Replace the current Step 4.6 content with:**

```markdown
### Step 4.6: Commit Suggestion (Optional)

**This step is non-blocking. Skipping does not affect the pause or any subsequent steps. Failure to commit has zero consequences.**

Before displaying the pause confirmation, check if the user has uncommitted work worth preserving.

**1. Check for uncommitted changes:**
```bash
git status --porcelain 2>/dev/null
```
If the output is empty (nothing to commit) or the command fails (not a git repo), skip this step silently and continue to Step 5.

**2. Check for double-prompting:**
Read `last_commit_suggestion_phase` from COLONY_STATE.json (already loaded in Step 1).
If `last_commit_suggestion_phase` equals the current phase, skip this step silently — the user was already prompted at POST-ADVANCE. Continue to Step 5.

**3. Capture AI Description:**

**As the AI, briefly describe what was in progress when pausing.**

Examples:
- "Mid-implementation of task-based routing, tests passing"
- "Completed model selection logic, integration tests pending"
- "Fixed file locking, ready for verification"

Store this as `ai_description`. If no clear description emerges, leave empty (will use fallback).

**4. Generate Enhanced Commit Message:**
```bash
bash .aether/aether-utils.sh generate-commit-message "contextual" {current_phase} "{phase_name}" "{ai_description}" {plan_number}
```

Parse the returned JSON to extract `message`, `body`, `files_changed`, `subsystem`, and `scope`.

**5. Display the enhanced suggestion:**
```
──────────────────────────────────────────────────
Commit Suggestion
──────────────────────────────────────────────────

  AI Description: {ai_description}

  Formatted Message:
  {message}

  Metadata:
  Scope: {scope}
  Files: {files_changed} files changed

──────────────────────────────────────────────────
```

**6. Use AskUserQuestion:**
```
Commit your work before pausing?

1. Yes, commit with this message
2. Yes, but let me edit the description
3. No, I'll commit later
```

**7. If option 1 ("Yes, commit with this message"):**
```bash
git add -A && git commit -m "{message}" -m "{body}"
```
Display: `Committed: {message} ({files_changed} files)`

**8. If option 2 ("Yes, but let me edit"):**
Prompt for custom description, then regenerate and commit.

**9. If option 3 ("No, I'll commit later"):**
Display: `Skipped. Your changes are saved on disk but not committed.`

**10. Record the suggestion:**
Set `last_commit_suggestion_phase` to `{current_phase}` in COLONY_STATE.json.

**Error handling:** If any git command fails, display the error and continue to Step 5.

Continue to Step 5.
```

## Commit Message Format

### Final Format (Following Research 1.6 Recommendation)

**Operational commits (milestones, checkpoints):**
```
aether-milestone: {ai_description}

Scope: {phase_id}.{plan_num}
Files: {N} files changed
```

**Example:**
```
aether-milestone: implement task-based model routing with precedence chain (CLI > user > task > caste)

Scope: 11.01
Files: 2 files changed
```

**Key characteristics:**
- **Namespaced prefix** (`aether-milestone:`) - distinguishes colony commits from human commits
- **AI description** - memorable, specific to what was done
- **Scope tag** - enables `git log --grep="Scope: 11."` filtering
- **Files count** - quick context on change size
- **72-char limit** on subject line (enforced with truncation)

## Testing Strategy

### Unit Tests for `generate-commit-message`

Test cases to verify (add to existing test suite):

```bash
# Test backward compatibility - old types still work
bash runtime/aether-utils.sh generate-commit-message milestone 8 "test-phase"
# Expected: {"message":"aether-milestone: phase 8 complete -- test-phase",...}

bash runtime/aether-utils.sh generate-commit-message pause 8 "test-phase"
# Expected: {"message":"aether-checkpoint: session pause -- phase 8 in progress",...}

# Test new contextual type
bash runtime/aether-utils.sh generate-commit-message contextual 8 "foraging-specialization" "implement task routing" 01
# Expected: {"message":"aether-milestone: implement task routing","scope":"8.01",...}

# Test contextual with empty description (fallback)
bash runtime/aether-utils.sh generate-commit-message contextual 8 "test-phase" "" 01
# Expected: {"message":"aether-milestone: phase 8.01 complete -- test-phase",...}

# Test 72-character truncation
bash runtime/aether-utils.sh generate-commit-message contextual 8 "test" "this is a very long description that exceeds seventy two characters limit" 01
# Expected: message truncated to 69 chars + "..."
```

### Integration Tests

1. **Continue flow:**
   - Run `/ant:continue` on a completed phase
   - Verify Step 2.6 displays enhanced suggestion with AI description field
   - Test all three options (Yes/Edit/No)

2. **Pause flow:**
   - Run `/ant:pause-colony` with uncommitted changes
   - Verify Step 4.6 displays enhanced suggestion
   - Verify double-prompt prevention works

3. **Edge cases:**
   - Non-git repo: should skip silently
   - No changes: should skip silently
   - Missing `last_commit_suggestion_phase`: should treat as null (allow suggestion)

## Rollout Plan

### Phase 1: Function Enhancement
1. Update `.aether/aether-utils.sh` (source of truth) with new "contextual" type
2. Test locally with various inputs
3. Verify backward compatibility (old types still work)

### Phase 2: Command Updates
1. Update `.claude/commands/ant/continue.md` Step 2.6
2. Update `.claude/commands/ant/pause-colony.md` Step 4.6
3. Test full flow in Aether repo

### Phase 3: Distribution
1. Run `npm install -g .` to update hub
2. Test in another repo with `aether update`
3. Document the enhancement in changelog

## Verification Checklist

- [ ] `generate-commit-message` supports new "contextual" type with AI description
- [ ] Backward compatibility verified: "milestone", "pause", "fix" types unchanged
- [ ] Subsystem derived correctly from phase name (e.g., "11-foraging-specialization" → "foraging")
- [ ] Scope format is `{phase_id}.{plan_num}` (e.g., "11.01")
- [ ] 72-character limit enforced on subject line
- [ ] `continue.md` Step 2.6 captures AI description before generating commit
- [ ] `pause-colony.md` Step 4.6 captures AI description for pause commits
- [ ] Double-prompt prevention works (`last_commit_suggestion_phase` tracking)
- [ ] Error handling for: non-git repo, no changes, missing state field
- [ ] Multi-line commit body uses `git commit -m "subject" -m "body"` format
- [ ] Empty AI description falls back gracefully

## Files Modified

| File | Change Type | Description |
|------|-------------|-------------|
| `.aether/aether-utils.sh` | Modify | Add "contextual" case to generate-commit-message function (source of truth) |
| `.claude/commands/ant/continue.md` | Modify | Enhance Step 2.6 with AI description capture |
| `.claude/commands/ant/pause-colony.md` | Modify | Enhance Step 4.6 with AI description capture |

## Notes

- **Step 2.6 and 4.6 already exist** - this plan enhances them, doesn't insert new steps
- **No PLAN.md parsing** - subsystem derived from phase name, not frontmatter
- **No LLM calls** - AI description comes from session context (you/me describing what we did)
- **Backward compatible** - existing calls to generate-commit-message continue to work
- **Deterministic** - same inputs produce same outputs every time

## References

- `.planning/git-staging-tier2.md` - Original Tier 2 design document
- `.planning/git-staging-research-1.6.md` - Commit message conventions research
- `.aether/aether-utils.sh` line 1334 - Existing generate-commit-message function (source of truth)
- `.claude/commands/ant/continue.md` line 737 - Existing Step 2.6
- `.claude/commands/ant/pause-colony.md` line 99 - Existing Step 4.6
