---
phase: 02-testing-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/bash/test-aether-utils.sh
  - tests/bash/test-helpers.sh
autonomous: true

must_haves:
  truths:
    - "Bash tests can be run with a single command"
    - "Tests verify aether-utils.sh subcommands return valid JSON"
    - "Tests verify error handling works correctly"
    - "Tests cover critical paths: validate-state, activity-log, flag operations"
  artifacts:
    - path: "tests/bash/test-aether-utils.sh"
      provides: "Bash integration test suite"
      min_lines: 150
    - path: "tests/bash/test-helpers.sh"
      provides: "Test helper functions"
      min_lines: 50
  key_links:
    - from: "tests/bash/test-aether-utils.sh"
      to: ".aether/aether-utils.sh"
      via: "bash command execution"
      pattern: "bash.*aether-utils.sh"
---

<objective>
Create Bash integration tests for aether-utils.sh subcommands to verify they return valid JSON and handle errors correctly.

Purpose: Ensure the 59 subcommands in aether-utils.sh work correctly and provide consistent JSON output.
Output: Bash test suite that can be run with a single command to verify aether-utils.sh functionality.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-testing-foundation/02-CONTEXT.md

@/Users/callumcowie/repos/Aether/.aether/aether-utils.sh
@/Users/callumcowie/repos/Aether/tests/e2e/test-install.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bash test helper utilities</name>
  <files>tests/bash/test-helpers.sh</files>
  <action>
    Create a test helper library for bash tests with the following utilities:

    1. assert_json_valid - Verify output is valid JSON using jq
    2. assert_json_field_equals - Check a specific JSON field value
    3. assert_ok_true - Verify {"ok":true} response
    4. assert_exit_code - Verify command exit status
    5. setup_test_env - Create temporary test environment
    6. teardown_test_env - Clean up temporary files
    7. run_test - Execute a test with setup/teardown
    8. test_summary - Print test results summary

    Follow the pattern from tests/e2e/test-install.sh for consistency.
    Use colors for pass/fail output (GREEN/RED).
    Track test counts (run/passed/failed).

    The helpers should be sourceable by other test files.
  </action>
  <verify>bash -n tests/bash/test-helpers.sh && echo "Syntax OK"</verify>
  <done>test-helpers.sh exists with all required helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create aether-utils.sh integration tests</name>
  <files>tests/bash/test-aether-utils.sh</files>
  <action>
    Create comprehensive bash integration tests for aether-utils.sh subcommands.

    Test the following critical subcommands:

    1. help - Returns valid JSON with commands array
    2. version - Returns {"ok":true,"result":"1.0.0"}
    3. validate-state colony - Returns valid validation result
    4. validate-state constraints - Returns valid validation result
    5. validate-state flags - Returns valid validation result
    6. activity-log-init - Initializes activity log correctly
    7. activity-log-read - Reads activity log correctly
    8. flag-list - Lists flags correctly (even if empty)
    9. generate-ant-name - Returns valid ant name
    10. error-summary - Returns valid error summary

    For each test:
    - Run the subcommand via bash .aether/aether-utils.sh <subcommand>
    - Verify exit code is 0 for success cases
    - Verify output is valid JSON
    - Verify expected fields exist

    Include error handling tests:
    - Invalid subcommand returns error
    - Missing arguments handled gracefully

    Add a test runner that:
    - Sources test-helpers.sh
    - Runs all tests
    - Prints summary (total/passed/failed)
    - Returns non-zero exit code if any tests fail
  </action>
  <verify>bash tests/bash/test-aether-utils.sh</verify>
  <done>test-aether-utils.sh exists with tests for all critical subcommands, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add test runner to package.json</name>
  <files>package.json</files>
  <action>
    Add npm scripts for running bash tests:

    1. "test:bash": "bash tests/bash/test-aether-utils.sh"
    2. Update "test" script to run both unit and bash tests if AVA is configured

    The test script should:
    - Run unit tests first (if they exist)
    - Run bash tests second
    - Exit with non-zero if either fails

    If the test script already runs AVA, modify it to also run bash tests:
    "test": "ava && bash tests/bash/test-aether-utils.sh"

    Or keep them separate:
    "test:unit": "ava"
    "test:bash": "bash tests/bash/test-aether-utils.sh"
    "test": "npm run test:unit && npm run test:bash"
  </action>
  <verify>grep -q 'test:bash' package.json && grep -q 'test-aether-utils.sh' package.json</verify>
  <done>package.json contains test:bash script that runs test-aether-utils.sh</done>
</task>

</tasks>

<verification>
- bash tests/bash/test-aether-utils.sh runs without errors
- All tests pass
- Tests verify JSON output is valid
- Tests verify exit codes are correct
- npm run test:bash works correctly
</verification>

<success_criteria>
- tests/bash/test-helpers.sh exists with reusable test utilities
- tests/bash/test-aether-utils.sh exists with tests for critical subcommands
- package.json has test:bash script
- All bash tests pass
- Tests cover: help, version, validate-state, activity-log, flag operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-testing-foundation/02-02-SUMMARY.md`
</output>
