---
phase: 07-core-reliability-state-guards-update-system
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - bin/lib/state-guard.js
  - bin/lib/event-types.js
  - tests/unit/state-guard-events.test.js
autonomous: true

must_haves:
  truths:
    - Every phase transition creates audit event in COLONY_STATE.json
    - Events have required fields: timestamp, type, worker, details
    - Event types are standardized and validated
    - Events array provides complete audit trail
  artifacts:
    - path: "bin/lib/event-types.js"
      provides: "Event type constants and validation"
      exports: ["EventTypes", "validateEvent", "createEvent"]
      min_lines: 80
    - path: "bin/lib/state-guard.js"
      provides: "Event recording in advancePhase"
      modifies: ["transitionState method", "addEvent method"]
    - path: "tests/unit/state-guard-events.test.js"
      provides: "Event audit trail tests"
      min_tests: 6
  key_links:
    - from: "StateGuard.advancePhase()"
      to: "state.events.push()"
      via: "addEvent() helper"
    - from: "createEvent()"
      to: "EventTypes constants"
      via: "type validation"
---

<objective>
Implement audit trail system that records all phase transitions in COLONY_STATE.json events array (STATE-04).

Purpose: Provide complete history of colony state changes for debugging and accountability.
Output: Event type constants, event creation helpers, and integration with StateGuard.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-reliability-state-guards-update-system/07-RESEARCH.md
@.aether/data/COLONY_STATE.json
@bin/lib/state-guard.js
</context>

<tasks>

<task type="auto">
  <name>Create event types module</name>
  <files>bin/lib/event-types.js</files>
  <action>
Create bin/lib/event-types.js with event type constants and helpers:

1. EventTypes constant object:
   - PHASE_TRANSITION: 'phase_transition'
   - PHASE_BUILD_STARTED: 'phase_build_started'
   - PHASE_BUILD_COMPLETED: 'phase_build_completed'
   - PHASE_ROLLED_BACK: 'phase_rolled_back'
   - CHECKPOINT_CREATED: 'checkpoint_created'
   - CHECKPOINT_RESTORED: 'checkpoint_restored'
   - UPDATE_STARTED: 'update_started'
   - UPDATE_COMPLETED: 'update_completed'
   - UPDATE_FAILED: 'update_failed'
   - IRON_LAW_VIOLATION: 'iron_law_violation'

2. validateEvent(event) function:
   - Check event has required fields: timestamp (ISO 8601), type (valid EventType), worker (string), details (object)
   - Return { valid: boolean, errors: string[] }
   - Validate timestamp format using regex or Date parsing
   - Validate type is in EventTypes values

3. createEvent(type, worker, details = {}) function:
   - Validate type is valid EventType
   - Return event object:
     {
       timestamp: new Date().toISOString(),
       type,
       worker: worker || process.env.WORKER_NAME || 'unknown',
       details
     }
   - Throw if type invalid

4. Export: module.exports = { EventTypes, validateEvent, createEvent };

Reference COLONY_STATE.json events array structure (lines 114-133) for event format.
Reference 07-RESEARCH.md lines 294-306 for EventTypes pattern.
  </action>
  <verify>node -e "const et = require('./bin/lib/event-types.js'); console.log('EventTypes:', Object.keys(et.EventTypes))"</verify>
  <done>Event types module created with all constants and helpers</done>
</task>

<task type="auto">
  <name>Integrate event recording into StateGuard</name>
  <files>bin/lib/state-guard.js</files>
  <action>
Extend bin/lib/state-guard.js to record audit events:

1. Import event-types at top:
   - const { EventTypes, createEvent } = require('./event-types');

2. addEvent(state, type, details) method:
   - Create event using createEvent(type, this.worker, details)
   - Push to state.events array
   - Return the created event

3. Modify transitionState(state, fromPhase, toPhase, evidence) method:
   - Update state.current_phase = toPhase
   - Update state.last_updated = new Date().toISOString()
   - Add phase_transition event:
     this.addEvent(state, EventTypes.PHASE_TRANSITION, {
       from: fromPhase,
       to: toPhase,
       evidence_id: evidence?.id || null,
       checkpoint_hash: evidence?.checkpoint_hash || null
     });
   - Return updated state

4. Add worker tracking:
   - Add worker property to constructor (default from env or 'state-guard')
   - Pass worker to all createEvent calls

5. Add getEvents(state, options) static method:
   - options: { type, since, limit }
   - Filter events by type if specified
   - Filter events by timestamp if since specified
   - Return limited number if limit specified
   - Return array of matching events

6. Add getLatestEvent(state, type) static method:
   - Return most recent event of given type
   - Return null if none found

Ensure all existing tests still pass after modifications.
  </action>
  <verify>npm test -- tests/unit/state-guard.test.js</verify>
  <done>StateGuard integrated with event recording, all existing tests pass</done>
</task>

<task type="auto">
  <name>Create event audit trail tests</name>
  <files>tests/unit/state-guard-events.test.js</files>
  <action>
Create tests/unit/state-guard-events.test.js for event-specific testing:

1. Test setup:
   - Mock fs and FileLock
   - Load StateGuard and EventTypes via proxyquire
   - Create state fixture with empty events array

2. Test: advancePhase creates phase_transition event
   - Call advancePhase(5, 6, evidence)
   - Assert saved state.events has new entry
   - Assert event.type === EventTypes.PHASE_TRANSITION
   - Assert event.details.from === 5 and event.details.to === 6
   - Assert event.timestamp is valid ISO 8601

3. Test: validateEvent accepts valid events
   - Create valid event with all required fields
   - Assert validateEvent(event).valid === true

4. Test: validateEvent rejects invalid events
   - Test missing timestamp
   - Test invalid type
   - Test missing worker
   - Each should return valid: false with appropriate errors

5. Test: createEvent generates correct structure
   - Call createEvent(EventTypes.CHECKPOINT_CREATED, 'TestWorker', { id: '123' })
   - Assert result has all required fields
   - Assert timestamp is recent (within 1 second)

6. Test: getEvents filters correctly
   - Setup state with multiple event types
   - Test filtering by type
   - Test filtering by since timestamp
   - Test limit option

7. Test: getLatestEvent returns most recent
   - Setup state with multiple phase_transition events
   - Assert getLatestEvent returns the last one

Use test.serial() for all tests.
  </action>
  <verify>npm test -- tests/unit/state-guard-events.test.js</verify>
  <done>All 6+ event audit trail tests pass</done>
</task>

</tasks>

<verification>
- Event types module loads without errors
- StateGuard records events during phase transitions
- All event tests pass
- Existing StateGuard tests still pass
</verification>

<success_criteria>
1. Event types module exists with all constants (STATE-04)
2. StateGuard records phase_transition events
3. Event validation works correctly
4. 6+ unit tests for event functionality
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-reliability-state-guards-update-system/07-03-SUMMARY.md`
</output>
