---
phase: 07-core-reliability-state-guards-update-system
plan: 05
type: execute
wave: 3
depends_on: ["07-04"]
files_modified:
  - bin/lib/update-transaction.js
  - bin/cli.js
  - bin/lib/errors.js
  - tests/unit/update-errors.test.js
autonomous: true

must_haves:
  truths:
    - Dirty repo detection shows clear error with stash instructions
    - Network failures during update are detected and reported
    - Partial update detection identifies incomplete syncs
    - All errors include specific recovery commands
  artifacts:
    - path: "bin/lib/update-transaction.js"
      provides: "Enhanced error detection and reporting"
      modifies: ["detectDirtyRepo", "detectPartialUpdate", "handleNetworkError"]
    - path: "bin/cli.js"
      provides: "Improved error messages in update flow"
    - path: "tests/unit/update-errors.test.js"
      provides: "Error handling tests"
      min_tests: 8
  key_links:
    - from: "detectDirtyRepo()"
      to: "git status --porcelain"
      via: "dirty file detection"
    - from: "detectPartialUpdate()"
      to: "manifest comparison"
      via: "file completeness check"
---

<objective>
Implement comprehensive error handling for update operations: dirty repo detection, network failure handling, and partial update detection (UPDATE-05).

Purpose: Provide clear, actionable error messages that help users recover from update failures.
Output: Enhanced error detection and reporting with specific recovery instructions.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-reliability-state-guards-update-system/07-RESEARCH.md
@bin/cli.js
@bin/lib/errors.js
@bin/lib/update-transaction.js
</context>

<tasks>

<task type="auto">
  <name>Implement dirty repo detection with clear messages</name>
  <files>bin/lib/update-transaction.js</files>
  <action>
Extend bin/lib/update-transaction.js with dirty repo detection:

1. detectDirtyRepo() method:
   - Execute: git status --porcelain
   - Parse output for modified files
   - Categorize files:
     - tracked: files git knows about (can be stashed)
     - untracked: new files not in git (cannot be stashed)
   - Return: { isDirty: boolean, tracked: string[], untracked: string[], staged: string[] }

2. validateRepoState() method:
   - Call detectDirtyRepo()
   - If dirty:
     - Create detailed error message:
       ```
       Cannot update: repository has uncommitted changes

       Modified files ({count}):
         - file1.js
         - file2.md

       Untracked files ({count}):
         - new-file.txt

       Options:
       1. Stash changes: git stash push -m "pre-update"
       2. Commit changes: git add . && git commit -m "wip"
       3. Discard changes: git checkout -- . (DANGER: loses work)

       After resolving, run: aether update
       ```
     - Throw UpdateError(E_REPO_DIRTY) with recovery commands
   - Return { clean: true } if no issues

3. Add E_REPO_DIRTY to UpdateError codes

4. Modify UpdateTransaction.execute():
   - Call validateRepoState() at start (before checkpoint)
   - Include dirty file info in error details

Reference existing isGitTracked() pattern in cli.js for file categorization.
  </action>
  <verify>node -e "const ut = require('./bin/lib/update-transaction.js'); const tx = new UpdateTransaction('.'); console.log('detectDirtyRepo:', typeof tx.detectDirtyRepo)"</verify>
  <done>Dirty repo detection implemented with detailed error messages</done>
</task>

<task type="auto">
  <name>Implement network failure and partial update detection</name>
  <files>bin/lib/update-transaction.js</files>
  <action>
Extend bin/lib/update-transaction.js with network and partial update handling:

1. checkHubAccessibility() method:
   - Check if HUB_DIR exists and is accessible
   - Verify source files exist before sync
   - Return { accessible: boolean, errors: string[] }
   - Throw UpdateError(E_HUB_INACCESSIBLE) if not accessible

2. detectPartialUpdate() method:
   - Compare expected files (from manifest) vs actual files on disk
   - Check for:
     - Missing files that should exist
     - Files with wrong sizes (incomplete writes)
     - Files with mismatched hashes
   - Return: { isPartial: boolean, missing: [], corrupted: [] }

3. verifySyncCompleteness() method:
   - Call after syncFiles()
   - Call detectPartialUpdate()
   - If partial detected:
     - Throw UpdateError(E_PARTIAL_UPDATE) with details:
       ```
       Update incomplete: {missing} files missing, {corrupted} files corrupted

       Missing files:
         - path/to/file1.js

       Corrupted files:
         - path/to/file2.js (hash mismatch)

       The update has been rolled back. Your workspace is unchanged.

       To retry: aether update
       ```

4. handleNetworkError(error) method:
   - Detect network-related errors (ETIMEDOUT, ECONNREFUSED, ENETUNREACH)
   - Enhance error with specific recovery:
     ```
     Network error during update: {message}

     Possible causes:
     - Hub directory not accessible: {HUB_DIR}
     - Network filesystem unavailable
     - Permission denied

     Recovery:
     1. Check network connectivity
     2. Verify hub exists: ls -la {HUB_DIR}
     3. Retry: aether update
     ```
   - Return enhanced UpdateError

5. Add new error codes:
   - E_HUB_INACCESSIBLE
   - E_PARTIAL_UPDATE
   - E_NETWORK_ERROR

6. Integrate into execute():
   - Call checkHubAccessibility() before sync
   - Wrap sync in try/catch with handleNetworkError()
   - Call verifySyncCompleteness() after sync

Reference existing manifest validation patterns in cli.js.
  </action>
  <verify>node -e "const ut = require('./bin/lib/update-transaction.js'); const tx = new UpdateTransaction('.'); console.log('Methods:', typeof tx.checkHubAccessibility, typeof tx.detectPartialUpdate)"</verify>
  <done>Network and partial update detection implemented</done>
</task>

<task type="auto">
  <name>Enhance CLI error display with recovery commands</name>
  <files>bin/cli.js</files>
  <action>
Modify bin/cli.js to display errors with prominent recovery commands:

1. Create formatUpdateError(error) helper:
   - Input: UpdateError or other error
   - Output: formatted string with:
     - Error code and message
     - Context details
     - Recovery commands in a highlighted box
     - Additional help links if applicable

2. Format example:
   ```
   ╔══════════════════════════════════════════════════════════════╗
   ║  UPDATE FAILED                                                ║
   ╚══════════════════════════════════════════════════════════════╝

   Error: E_REPO_DIRTY - Repository has uncommitted changes

   Details:
     Modified files: 3
     Untracked files: 1

   ╔══════════════════════════════════════════════════════════════╗
   ║  RECOVERY COMMANDS                                            ║
   ║                                                               ║
   ║  git stash push -m "pre-update"                               ║
   ║  aether update                                                ║
   ║                                                               ║
   ║  Or to discard changes (DANGER):                              ║
   ║  git checkout -- .                                            ║
   ╚══════════════════════════════════════════════════════════════╝

   Checkpoint ID: chk_20260214_143015 (for manual restore if needed)
   ```

3. Update update command error handler:
   - Catch UpdateError specifically
   - Call formatUpdateError()
   - Display to stderr
   - Exit with appropriate code

4. Ensure all error types are handled:
   - E_REPO_DIRTY: show stash/commit options
   - E_HUB_INACCESSIBLE: show hub check commands
   - E_PARTIAL_UPDATE: show retry command
   - E_NETWORK_ERROR: show network diagnostics
   - E_VERIFY_FAILED: show checkpoint restore

5. Use colors from bin/lib/colors.js for highlighting:
   - Red for error header
   - Yellow for recovery box
   - White for commands

Test error display by simulating each error type.
  </action>
  <verify>node -e "const {c} = require('./bin/lib/colors'); console.log(c.red('Error display'), c.yellow('working'))"</verify>
  <done>CLI error display enhanced with formatted recovery commands</done>
</task>

<task type="auto">
  <name>Create unit tests for error handling</name>
  <files>tests/unit/update-errors.test.js</files>
  <action>
Create tests/unit/update-errors.test.js for error handling tests:

1. Test setup:
   - Mock child_process.execSync for git commands
   - Mock fs for file operations
   - Load UpdateTransaction via proxyquire

2. Test: detectDirtyRepo identifies modified files
   - Setup: git status returns modified files
   - Call: transaction.detectDirtyRepo()
   - Assert: returns isDirty: true
   - Assert: tracked files listed correctly
   - Assert: untracked files listed correctly

3. Test: validateRepoState throws on dirty repo
   - Setup: repo has uncommitted changes
   - Call: transaction.validateRepoState()
   - Assert: throws UpdateError with E_REPO_DIRTY
   - Assert: error includes file lists
   - Assert: error includes recovery commands

4. Test: checkHubAccessibility detects missing hub
   - Setup: HUB_DIR doesn't exist
   - Call: transaction.checkHubAccessibility()
   - Assert: returns accessible: false
   - Assert: errors include path info

5. Test: detectPartialUpdate finds missing files
   - Setup: manifest expects file that doesn't exist
   - Call: transaction.detectPartialUpdate()
   - Assert: returns isPartial: true
   - Assert: missing files listed

6. Test: detectPartialUpdate finds corrupted files
   - Setup: file exists but hash doesn't match
   - Call: transaction.detectPartialUpdate()
   - Assert: returns corrupted files with hash info

7. Test: handleNetworkError enhances timeout errors
   - Setup: ETIMEDOUT error
   - Call: transaction.handleNetworkError(error)
   - Assert: returns UpdateError with E_NETWORK_ERROR
   - Assert: includes network diagnostics

8. Test: error recovery commands are actionable
   - For each error type:
     - Generate error
     - Assert recoveryCommands array exists
     - Assert commands are valid shell commands
     - Assert commands include cd to repo path

9. Test: UpdateError toString includes recovery box
   - Create UpdateError with recovery commands
   - Assert toString() contains formatted box
   - Assert commands are displayed prominently

Use test.serial() for all tests.
  </action>
  <verify>npm test -- tests/unit/update-errors.test.js</verify>
  <done>All 8+ error handling tests pass</done>
</task>

</tasks>

<verification>
- Dirty repo detection works and shows clear messages
- Network failure handling provides diagnostics
- Partial update detection identifies incomplete syncs
- All error tests pass
- Error display is user-friendly with recovery commands
</verification>

<success_criteria>
1. Dirty repo detection with clear stash instructions (UPDATE-05)
2. Network failure handling with diagnostics
3. Partial update detection and reporting
4. All errors include specific recovery commands
5. 8+ unit tests for error scenarios
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-reliability-state-guards-update-system/07-05-SUMMARY.md`
</output>
