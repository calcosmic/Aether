---
phase: 11-foraging-specialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/model-profiles.js
autonomous: true

must_haves:
  truths:
    - "Task containing 'design' routes to glm-5 automatically"
    - "Task containing 'implement' routes to kimi-k2.5 automatically"
    - "Model selection precedence is enforced: CLI override > user override > task routing > caste default"
    - "Routing decisions include source tracking for debugging"
  artifacts:
    - path: "bin/lib/model-profiles.js"
      provides: "Task-based model selection with keyword matching"
      exports: ["getModelForTask", "selectModelForTask"]
  key_links:
    - from: "selectModelForTask"
      to: "task_routing.complexity_indicators"
      via: "keyword substring matching"
      pattern: "normalizedTask.includes(keyword)"
---

<objective>
Implement task-based model routing by extending model-profiles.js with keyword detection.

Purpose: Enable intelligent model selection based on task content keywords, fulfilling MOD-06 requirement.
Output: Extended model-profiles.js with getModelForTask() and selectModelForTask() functions.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-foraging-specialization/11-RESEARCH.md
@/Users/callumcowie/repos/Aether/bin/lib/model-profiles.js
@/Users/callumcowie/repos/Aether/.aether/model-profiles.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getModelForTask() function</name>
  <files>bin/lib/model-profiles.js</files>
  <action>
Add a new function `getModelForTask(taskRouting, taskDescription)` that:
1. Returns null if taskRouting or taskDescription is falsy
2. Normalizes task description to lowercase
3. Iterates through taskRouting.complexity_indicators (complex, simple, validate)
4. For each indicator, checks if any keyword (case-insensitive) is a substring of the task description
5. Returns the model for the first matching complexity indicator
6. Returns taskRouting.default_model if no keywords match

Use simple substring matching (not regex word boundaries) as documented in research:
```javascript
const normalizedTask = taskDescription.toLowerCase();
const hasMatch = keywords.some(keyword =>
  normalizedTask.includes(keyword.toLowerCase())
);
```

Add JSDoc documentation for the function.
  </action>
  <verify>grep -q "function getModelForTask" bin/lib/model-profiles.js && echo "Function exists"</verify>
  <done>getModelForTask function exists with proper keyword matching logic</done>
</task>

<task type="auto">
  <name>Task 2: Add selectModelForTask() function with precedence</name>
  <files>bin/lib/model-profiles.js</files>
  <action>
Add a new function `selectModelForTask(profiles, caste, taskDescription, cliOverride = null)` that implements the precedence chain:

1. **CLI override** (highest): If cliOverride is provided and validateModel() returns valid, return { model: cliOverride, source: 'cli-override' }

2. **User override**: Check profiles.user_overrides[caste], if exists return { model: override, source: 'user-override' }

3. **Task-based routing**: If taskDescription and profiles.task_routing exist:
   - Call getModelForTask(profiles.task_routing, taskDescription)
   - If a model is returned, return { model: taskModel, source: 'task-routing' }

4. **Caste default**: Check profiles.worker_models[caste], if exists return { model: casteModel, source: 'caste-default' }

5. **Fallback**: Return { model: DEFAULT_MODEL, source: 'fallback' }

The function returns an object with `model` and `source` properties for tracking.

Add JSDoc documentation and export both new functions in module.exports.
  </action>
  <verify>grep -q "function selectModelForTask" bin/lib/model-profiles.js && grep -q "getModelForTask" bin/lib/model-profiles.js && node -e "const mp = require('./bin/lib/model-profiles'); console.log('Exports:', Object.keys(mp).filter(k => k.includes('Task')))"</verify>
  <done>selectModelForTask function exists with full precedence chain and both functions are exported</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for task routing</name>
  <files>test/model-profiles-task-routing.test.js</files>
  <action>
Create a new test file for task routing functionality with tests for:

1. getModelForTask:
   - Returns null when taskRouting is null
   - Returns null when taskDescription is empty
   - Matches "design" keyword and returns glm-5
   - Matches "implement" keyword and returns kimi-k2.5
   - Matches "test" keyword and returns minimax-2.5
   - Returns default_model when no keywords match
   - Case-insensitive matching ("DESIGN" matches "design")
   - Substring matching ("redesign" contains "design")

2. selectModelForTask:
   - CLI override takes precedence over everything
   - User override takes precedence over task routing
   - Task routing takes precedence over caste default
   - Caste default is used when no other matches
   - Fallback is used when nothing matches
   - Returns correct source for each precedence level

Use the existing test patterns from the codebase. Create mock profiles objects for testing.
  </action>
  <verify>npm test -- test/model-profiles-task-routing.test.js 2>&1 | grep -q "passed" && echo "Tests pass"</verify>
  <done>Unit tests exist and pass for both getModelForTask and selectModelForTask</done>
</task>

</tasks>

<verification>
1. Run tests: npm test -- test/model-profiles-task-routing.test.js
2. Manual verification: node -e "const mp = require('./bin/lib/model-profiles'); console.log(mp.selectModelForTask({worker_models: {builder: 'kimi-k2.5'}, task_routing: {default_model: 'kimi-k2.5', complexity_indicators: {complex: {keywords: ['design'], model: 'glm-5'}}}}, 'builder', 'Design new system'))"
3. Verify precedence chain works correctly
</verification>

<success_criteria>
- [ ] getModelForTask() correctly matches keywords using substring matching
- [ ] selectModelForTask() implements correct precedence: cli > user > task > caste > fallback
- [ ] Both functions exported from module.exports
- [ ] Unit tests pass with >90% coverage for new functions
- [ ] JSDoc documentation is complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-foraging-specialization/11-01-SUMMARY.md`
</output>
