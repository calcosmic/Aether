---
phase: 05-state-context-restoration
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/status.md
  - .claude/commands/ant/plan.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/pause-colony.md
  - .claude/commands/ant/resume-colony.md
autonomous: true

must_haves:
  truths:
    - "Every ant command loads state before executing"
    - "Resumption context displays automatically when HANDOFF.md exists"
    - "Handoff is cleaned up after successful resume display"
    - "State validation errors show clear recovery options"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "State loading integration with brief resumption context"
    - path: ".claude/commands/ant/status.md"
      provides: "Extended resumption context with last activity"
    - path: ".claude/commands/ant/pause-colony.md"
      provides: "Creates HANDOFF.md with full context"
    - path: ".claude/commands/ant/resume-colony.md"
      provides: "Full state restoration with handoff cleanup"
  key_links:
    - from: "ant commands"
      to: "state-loader.sh"
      via: "bash .aether/aether-utils.sh load-state"
    - from: "pause-colony"
      to: "HANDOFF.md"
      via: "Write tool creating handoff document"
    - from: "resume/build/plan/continue"
      to: "HANDOFF.md"
      via: "Display then remove handoff after load"
---

<objective>
Integrate state loading and context restoration into all ant commands.

Purpose: Ensure every command invocation loads state, displays resumption context when resuming from pause, and provides seamless session continuity.
Output: Updated ant command files with integrated state loading
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-state-context-restoration/05-CONTEXT.md
@.planning/phases/05-state-context-restoration/05-RESEARCH.md

@.claude/commands/ant/build.md
@.claude/commands/ant/status.md
@.claude/commands/ant/plan.md
@.claude/commands/ant/continue.md
@.claude/commands/ant/pause-colony.md
@.claude/commands/ant/resume-colony.md

@.aether/utils/state-loader.sh
@.aether/HANDOFF.md
</context>

<tasks>

<task type="auto">
  <name>Update build.md with state loading and brief context</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Update `.claude/commands/ant/build.md` to add state loading:

After Step 0 (version check), add new Step 0.5:

```markdown
### Step 0.5: Load Colony State

Run using Bash tool: `bash .aether/aether-utils.sh load-state`

If the command fails (non-zero exit or JSON has ok: false):
1. Parse error JSON
2. If error code is E_FILE_NOT_FOUND: "No colony initialized. Run /ant:init first." and stop
3. If validation error: Display error details with recovery suggestion and stop
4. For other errors: Display generic error and suggest /ant:status for diagnostics

If successful:
1. Parse the state JSON from result field
2. Check if goal is null - if so: "No colony initialized. Run /ant:init first." and stop
3. Extract current_phase and phase name from plan.phases[current_phase - 1].name
4. Display brief resumption context:
   ```
   ðŸ”„ Resuming: Phase X - Name
   ```
   (If HANDOFF.md exists, this provides orientation before the build proceeds)

After displaying context, run: `bash .aether/aether-utils.sh unload-state` to release the lock.
```

Update the rest of the command to work with the loaded state (state is now available from the load-state output).
  </action>
  <verify>
    grep -q "Step 0.5: Load Colony State" .claude/commands/ant/build.md && echo "build.md updated"
  </verify>
  <done>build.md has state loading step with brief resumption context display</done>
</task>

<task type="auto">
  <name>Update status.md with extended context and handoff cleanup</name>
  <files>.claude/commands/ant/status.md</files>
  <action>
Update `.claude/commands/ant/status.md`:

Replace the existing Step 1.5 (Show Resumption Context) with enhanced version:

```markdown
### Step 1.5: Load State and Show Resumption Context

Run using Bash tool: `bash .aether/aether-utils.sh load-state`

If successful and goal is not null:
1. Extract current_phase from state
2. Get phase name from plan.phases[current_phase - 1].name (or "(unnamed)")
3. Get last event timestamp from events array (last element)
4. Display extended resumption context:
   ```
   ðŸ”„ Resuming: Phase X - Name
      Last activity: timestamp
   ```

5. Check for HANDOFF.md existence in the load-state output or via separate check
6. If HANDOFF.md exists:
   - Display: "Resuming from paused session"
   - Read HANDOFF.md content for additional context
   - Remove HANDOFF.md after displaying (cleanup)

Run: `bash .aether/aether-utils.sh unload-state` to release lock.
```

The status command should use the loaded state for all subsequent steps instead of re-reading the file.
  </action>
  <verify>
    grep -q "Load State and Show Resumption Context" .claude/commands/ant/status.md && echo "status.md updated"
  </verify>
  <done>status.md has enhanced resumption context with handoff cleanup</done>
</task>

<task type="auto">
  <name>Update plan.md and continue.md with state loading</name>
  <files>.claude/commands/ant/plan.md, .claude/commands/ant/continue.md</files>
  <action>
Update `.claude/commands/ant/plan.md`:

Add Step 0.5 (same pattern as build.md):
- Load state via load-state
- Check goal is not null
- Display brief resumption context: "ðŸ”„ Resuming: Phase X - Name"
- Unload state

Update `.claude/commands/ant/continue.md`:

Add Step 0.5 (same pattern):
- Load state via load-state
- Check goal is not null
- Display brief resumption context
- Unload state

Both commands should fail gracefully if:
- State file not found (suggest /ant:init)
- Validation fails (show error details)
- Goal is null (colony not initialized)
  </action>
  <verify>
    grep -q "Step 0.5" .claude/commands/ant/plan.md && grep -q "Step 0.5" .claude/commands/ant/continue.md && echo "plan.md and continue.md updated"
  </verify>
  <done>plan.md and continue.md have state loading with brief resumption context</done>
</task>

<task type="auto">
  <name>Update pause-colony.md to set paused flag in state</name>
  <files>.claude/commands/ant/pause-colony.md</files>
  <action>
Update `.claude/commands/ant/pause-colony.md`:

After Step 4 (Write Handoff), add Step 4.6:

```markdown
### Step 4.6: Set Paused Flag in State

Use Read tool to get current COLONY_STATE.json.

Use Write tool to update COLONY_STATE.json with paused flag:
- Add field: `"paused": true`
- Add field: `"paused_at": "<ISO-8601 timestamp>"`
- Update last_updated timestamp

This flag indicates the colony is in a paused state and will be cleared on resume.
```

Update Step 5 (Display Confirmation) to mention the paused state is saved.
  </action>
  <verify>
    grep -q "Set Paused Flag in State" .claude/commands/ant/pause-colony.md && echo "pause-colony.md updated"
  </verify>
  <done>pause-colony.md sets paused flag in COLONY_STATE.json</done>
</task>

<task type="auto">
  <name>Update resume-colony.md with full restoration and cleanup</name>
  <files>.claude/commands/ant/resume-colony.md</files>
  <action>
Update `.claude/commands/ant/resume-colony.md`:

Replace Step 1 with enhanced version:

```markdown
### Step 1: Load State and Validate

Run using Bash tool: `bash .aether/aether-utils.sh load-state`

If successful:
1. Parse state from result
2. If goal is null: Show "No colony state found..." message and stop
3. Check if paused flag is true - if not, note "Colony was not paused, but resuming anyway"
4. Extract all state fields for display

Keep state loaded (don't unload yet) - we'll need it for the full display.
```

Add Step 6 (Clear Paused State):

```markdown
### Step 6: Clear Paused State and Cleanup

Use Write tool to update COLONY_STATE.json:
- Remove or set to false: `"paused": false`
- Remove: `"paused_at"` field
- Update last_updated timestamp
- Add event: `{timestamp, type: "colony_resumed", worker: "resume", details: "Session resumed"}`

Use Bash tool to remove HANDOFF.md: `rm -f .aether/HANDOFF.md`

Run: `bash .aether/aether-utils.sh unload-state` to release lock.
```

Update display to use the loaded state instead of re-reading files.
  </action>
  <verify>
    grep -q "Clear Paused State and Cleanup" .claude/commands/ant/resume-colony.md && echo "resume-colony.md updated"
  </verify>
  <done>resume-colony.md clears paused flag and removes HANDOFF.md on completion</done>
</task>

</tasks>

<verification>
- [ ] build.md has state loading with brief resumption context
- [ ] status.md has extended context with handoff cleanup
- [ ] plan.md has state loading with brief context
- [ ] continue.md has state loading with brief context
- [ ] pause-colony.md sets paused flag in state
- [ ] resume-colony.md clears paused flag and removes HANDOFF.md
- [ ] All commands handle load-state errors gracefully
</verification>

<success_criteria>
1. Every ant command loads state before executing (STATE-01)
2. Resumption context displays automatically when HANDOFF.md exists (STATE-02)
3. Handoff is cleaned up after successful resume
4. State validation errors show clear recovery options
5. Paused flag tracks colony pause/resume state
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-context-restoration/05-03-SUMMARY.md`
</output>
