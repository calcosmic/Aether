---
phase: 10-entombment-egg-laying
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - .claude/commands/ant/entomb.md
  - .opencode/commands/ant/entomb.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - User can run /ant:entomb to archive a completed colony
    - Entombment validates colony is complete before archiving
    - Entombment requires explicit user confirmation
    - Colony is copied to chambers with manifest, then reset
    - Failed/incomplete colonies cannot be entombed
  artifacts:
    - path: ".claude/commands/ant/entomb.md"
      provides: "Entomb command for Claude Code"
      contains: ["ant:entomb", "chamber", "manifest"]
    - path: ".opencode/commands/ant/entomb.md"
      provides: "Entomb command for OpenCode"
      contains: ["ant:entomb", "chamber", "manifest"]
  key_links:
    - from: ".claude/commands/ant/entomb.md"
      to: ".aether/aether-utils.sh"
      via: "bash subcommand calls"
      pattern: "bash .aether/aether-utils.sh chamber-"
---

<objective>
Implement the `/ant:entomb` command to archive completed colonies.

Purpose: Allow users to preserve colony history by entombing completed colonies in chambers with full metadata.
Output: entomb.md command files for both Claude Code and OpenCode
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-entombment-egg-laying/10-CONTEXT.md
@.planning/phases/10-entombment-egg-laying/10-RESEARCH.md
@.claude/commands/ant/init.md
@.claude/commands/ant/seal.md
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /ant:entomb command for Claude Code</name>
  <files>.claude/commands/ant/entomb.md</files>
  <action>
Create `.claude/commands/ant/entomb.md` following the pattern from init.md and seal.md:

**Frontmatter:**
```yaml
---
name: ant:entomb
description: "ğŸºğŸœğŸº Entomb completed colony in chambers"
---
```

**Instructions structure:**

### Step 1: Read State
- Read `.aether/data/COLONY_STATE.json`
- If missing or goal is null: "No colony to entomb. Run /ant:init first."

### Step 2: Validate Colony Can Be Entombed
Check preconditions (from RESEARCH.md Pattern 4):
- All phases must have status "completed" (or no phases exist)
- State must not be "EXECUTING"
- No critical errors in errors.records

If incomplete:
```
Cannot entomb incomplete colony.

Completed phases: X of Y
Remaining: {list incomplete phase names}

Run /ant:continue to complete remaining phases first.
```

### Step 3: Compute Milestone
- Run milestone detection (will be implemented in Plan 03)
- For now, extract from state.milestone or compute from phases
- Expected: "Sealed Chambers" or "Crowned Anthill"

### Step 4: User Confirmation (checkpoint behavior)
Display:
```
ğŸº â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   E N T O M B   C O L O N Y
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸº

Goal: {goal}
Phases: {completed}/{total} completed
Milestone: {milestone}

Archive will include:
  - COLONY_STATE.json
  - manifest.json (pheromone trails)

This will reset the active colony. Continue? (yes/no)
```

Wait for explicit "yes" response before proceeding.

### Step 5: Create Chamber
- Generate chamber name: `{sanitized_goal}-{timestamp}`
- Sanitize: lowercase, replace spaces with hyphens, remove special chars
- Timestamp: ISO-8601 basic format (no colons): date -u +%Y%m%d-%H%M%S
- Create directory: `.aether/chambers/{chamber_name}/`

### Step 6: Copy and Create Manifest
Use aether-utils.sh chamber-create:
```bash
bash .aether/aether-utils.sh chamber-create \
  ".aether/chambers/{chamber_name}" \
  ".aether/data/COLONY_STATE.json" \
  "{goal}" \
  {phases_completed} \
  {total_phases} \
  "{milestone}" \
  "{version}" \
  '{decisions_json}' \
  '{learnings_json}'
```

### Step 7: Verify and Reset
- Run chamber-verify to confirm integrity
- If verification fails: display error and stop
- If verified:
  - Backup: `mv COLONY_STATE.json COLONY_STATE.json.bak`
  - Reset state (see RESEARCH.md Pattern 2):
    - goal: null
    - state: "IDLE"
    - current_phase: 0
    - plan.phases: []
    - Preserve: memory.phase_learnings, memory.decisions, memory.instincts
  - Remove backup after successful reset

### Step 8: Display Result
```
ğŸº â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   C O L O N Y   E N T O M B E D
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸº

âœ… Colony archived successfully

ğŸ‘‘ Goal: {goal}
ğŸ“ Phases: {completed} completed
ğŸ† Milestone: {milestone}

ğŸ“¦ Chamber: .aether/chambers/{chamber_name}/

ğŸœ The colony rests. Its learnings are preserved.
   Run /ant:lay-eggs to begin anew.
```

Include edge case handling:
- Chamber name collision: append counter
- Missing files: note in output but continue
- State reset failures: restore from backup
  </action>
  <verify>
# Verify file structure
grep -q "name: ant:entomb" .claude/commands/ant/entomb.md
grep -q "chamber-create" .claude/commands/ant/entomb.md
grep -q "yes/no" .claude/commands/ant/entomb.md
echo "entomb.md structure validated"
  </verify>
  <done>entomb.md exists with complete command structure, user confirmation, and chamber integration</done>
</task>

<task type="auto">
  <name>Task 2: Mirror entomb command to OpenCode</name>
  <files>.opencode/commands/ant/entomb.md</files>
  <action>
Create `.opencode/commands/ant/entomb.md` as an exact copy of `.claude/commands/ant/entomb.md`.

The commands are identical between Claude Code and OpenCode.

Ensure the directory exists first: `.opencode/commands/ant/`
  </action>
  <verify>
test -f .opencode/commands/ant/entomb.md
diff .claude/commands/ant/entomb.md .opencode/commands/ant/entomb.md
echo "OpenCode mirror created and matches"
  </verify>
  <done>OpenCode entomb.md exists and is identical to Claude Code version</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Verify entomb command works end-to-end</name>
  <what-built>
/ant:entomb command that:
1. Validates colony is complete before archiving
2. Requires explicit user confirmation
3. Creates chamber with COLONY_STATE.json and manifest.json
4. Resets colony state while preserving pheromones (learnings/decisions)
5. Displays confirmation with chamber location
  </what-built>
  <how-to-verify>
1. Ensure you have a completed colony (all phases completed, state not EXECUTING)
2. Run `/ant:entomb`
3. Verify:
   - Confirmation prompt shows correct goal, phases, milestone
   - Typing "yes" proceeds, "no" cancels
   - Chamber is created in .aether/chambers/{goal}-{timestamp}/
   - manifest.json contains: entombed_at, goal, phases_completed, total_phases, milestone, version, decisions, learnings, files with hashes
   - COLONY_STATE.json is reset (goal: null, state: IDLE, phases: [])
   - Learnings and decisions are preserved in memory
   - Success message shows chamber location
4. Run `bash .aether/aether-utils.sh chamber-list` to verify chamber appears in list
  </how-to-verify>
  <resume-signal>Type "approved" if entomb works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] entomb.md exists for Claude Code
- [ ] entomb.md exists for OpenCode (mirror)
- [ ] Command validates colony completion before entombing
- [ ] User confirmation required before destructive operation
- [ ] Chamber created with proper naming convention
- [ ] Manifest includes all pheromone trail data
- [ ] State reset preserves memory while clearing progress
- [ ] Success display includes chamber location
</verification>

<success_criteria>
1. User can run `/ant:entomb` to archive completed colonies
2. Incomplete colonies are rejected with clear message
3. Entombment requires explicit "yes" confirmation
4. Chamber contains COLONY_STATE.json and manifest.json
5. Manifest includes date, goal, phases completed, learnings, decisions
6. Active colony is reset after successful entombment
</success_criteria>

<output>
After completion, create `.planning/phases/10-entombment-egg-laying/10-02-SUMMARY.md`
</output>
