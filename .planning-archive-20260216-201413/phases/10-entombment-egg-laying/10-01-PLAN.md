---
phase: 10-entombment-egg-laying
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
  - .aether/utils/chamber-utils.sh
autonomous: true

must_haves:
  truths:
    - Chamber directory structure can be created programmatically
    - Manifest files can be generated with proper schema
    - Chamber integrity can be verified via SHA256 hashes
    - Chamber listing returns sorted results by timestamp
  artifacts:
    - path: ".aether/utils/chamber-utils.sh"
      provides: "Chamber management utilities (create, verify, list)"
      exports: ["chamber_create", "chamber_verify", "chamber_list"]
    - path: ".aether/aether-utils.sh"
      provides: "Integration with existing utility layer"
      contains: "chamber-* subcommands"
  key_links:
    - from: ".aether/aether-utils.sh"
      to: ".aether/utils/chamber-utils.sh"
      via: "source command"
      pattern: "source.*chamber-utils.sh"
---

<objective>
Create chamber management utilities for colony lifecycle operations.

Purpose: Provide the foundational infrastructure for entombing colonies â€” directory management, manifest generation, and integrity verification.
Output: chamber-utils.sh with create, verify, and list functions; integration into aether-utils.sh
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-entombment-egg-laying/10-CONTEXT.md
@.planning/phases/10-entombment-egg-laying/10-RESEARCH.md
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chamber-utils.sh utility module</name>
  <files>.aether/utils/chamber-utils.sh</files>
  <action>
Create `.aether/utils/chamber-utils.sh` with the following functions:

**chamber_create(chamber_dir, state_file, goal, phases_completed, total_phases, milestone, version, decisions, learnings)**
- Creates chamber directory if it doesn't exist
- Copies COLONY_STATE.json to chamber
- Generates manifest.json with schema from RESEARCH.md:
  - entombed_at: ISO-8601 timestamp
  - goal: colony goal
  - phases_completed: count
  - total_phases: count
  - milestone: milestone name
  - version: computed version string
  - decisions: array of decision objects
  - learnings: array of learning objects
  - files: object with filename -> sha256 hash
- Computes SHA256 hash of COLONY_STATE.json using `shasum -a 256` or `sha256sum`
- Returns JSON: {"ok": true, "chamber_dir": "...", "manifest": {...}}

**chamber_verify(chamber_dir)**
- Reads manifest.json from chamber
- Re-computes SHA256 hash of COLONY_STATE.json
- Compares with manifest.files["COLONY_STATE.json"]
- Returns JSON: {"ok": true, "verified": true} or {"ok": false, "error": "hash mismatch"}

**chamber_list(chambers_root)**
- Lists all directories in .aether/chambers/
- For each, reads manifest.json
- Returns JSON array sorted by entombed_at descending:
  [{"name": "...", "goal": "...", "milestone": "...", "phases_completed": N, "entombed_at": "..."}]

**chamber_sanitize_goal(goal)**
- Converts goal to lowercase
- Replaces spaces/special chars with hyphens
- Removes non-alphanumeric chars except hyphens
- Returns sanitized string

Follow the same patterns as file-lock.sh and atomic-write.sh:
- Use `set -euo pipefail`
- JSON output via json_ok/json_err helpers
- Exit codes: 0 for success, 1 for error
  </action>
  <verify>
bash .aether/utils/chamber-utils.sh --help 2>/dev/null || echo "File created, testing functions..."
# Test chamber_create with mock data
mkdir -p /tmp/test-chamber
echo '{"goal":"test","version":"3.0"}' > /tmp/test-state.json
bash -c 'source .aether/utils/chamber-utils.sh && chamber_create /tmp/test-chamber/entomb-test /tmp/test-state.json "Test Goal" 5 5 "Sealed Chambers" "v1.0.0" "[]" "[]"' | jq -e '.ok == true'
  </verify>
  <done>chamber-utils.sh exists with all 4 functions, returns valid JSON, creates directories and manifests correctly</done>
</task>

<task type="auto">
  <name>Task 2: Integrate chamber commands into aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Modify `.aether/aether-utils.sh` to:

1. Source chamber-utils.sh after other utility files:
   ```bash
   [[ -f "$SCRIPT_DIR/utils/chamber-utils.sh" ]] && source "$SCRIPT_DIR/utils/chamber-utils.sh"
   ```

2. Add new subcommands to the case statement:
   - `chamber-create`: Wrapper around chamber_create function
     - Args: chamber_dir state_file goal phases_completed total_phases milestone version decisions_json learnings_json
     - Validate all args present
     - Call chamber_create and return result

   - `chamber-verify`: Wrapper around chamber_verify
     - Args: chamber_dir
     - Return verification result

   - `chamber-list`: Wrapper around chamber_list
     - Args: [chambers_root] (default to .aether/chambers/)
     - Return JSON array of chambers

3. Update the help output to include new commands:
   Add to commands array: "chamber-create", "chamber-verify", "chamber-list"

Ensure proper error handling:
- If chamber-utils.sh not found, return error
- If chamber_* functions fail, propagate error JSON
  </action>
  <verify>
bash .aether/aether-utils.sh help | jq -e '.commands | contains(["chamber-create", "chamber-verify", "chamber-list"])'
bash .aether/aether-utils.sh chamber-list 2>/dev/null | jq -e 'type == "array" or .ok == false' || true
  </verify>
  <done>aether-utils.sh includes chamber-* subcommands, help shows new commands, integration works</done>
</task>

<task type="auto">
  <name>Task 3: Create chambers directory structure</name>
  <files>.aether/chambers/.gitkeep</files>
  <action>
Create the chambers directory structure:

1. Create `.aether/chambers/` directory if it doesn't exist
2. Add `.aether/chambers/.gitkeep` to ensure directory is tracked in git
3. The directory should be empty initially (no chambers yet)

This provides the storage location for entombed colonies.
  </action>
  <verify>
ls -la .aether/chambers/
test -d .aether/chambers/ && echo "Chambers directory exists"
  </verify>
  <done>.aether/chambers/ directory exists and is git-tracked via .gitkeep</done>
</task>

</tasks>

<verification>
- [ ] chamber-utils.sh exists with 4 functions
- [ ] chamber_create generates valid manifest.json with all required fields
- [ ] chamber_verify detects hash mismatches
- [ ] chamber_list returns sorted JSON array
- [ ] aether-utils.sh includes chamber-* subcommands
- [ ] .aether/chambers/ directory exists
</verification>

<success_criteria>
1. Chamber utilities module is created and functional
2. Integration with aether-utils.sh provides CLI access
3. Chamber directory structure is ready for entombment operations
4. All functions return valid JSON and handle errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/10-entombment-egg-laying/10-01-SUMMARY.md`
</output>
