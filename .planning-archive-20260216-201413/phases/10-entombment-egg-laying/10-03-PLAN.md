---
phase: 10-entombment-egg-laying
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - .claude/commands/ant/lay-eggs.md
  - .opencode/commands/ant/lay-eggs.md
  - .claude/commands/ant/status.md
  - .aether/aether-utils.sh
autonomous: false
user_setup: []

must_haves:
  truths:
    - User can run /ant:lay-eggs to start a fresh colony
    - Lay-eggs requires a new goal and validates no active colony exists
    - Fresh colony inherits pheromones (learnings/decisions/instincts)
    - Milestone auto-detects from state (First Mound â†’ Crowned Anthill)
    - /ant:status displays current milestone
  artifacts:
    - path: ".claude/commands/ant/lay-eggs.md"
      provides: "Lay eggs command for Claude Code"
      contains: ["ant:lay-eggs", "First Eggs", "pheromones"]
    - path: ".opencode/commands/ant/lay-eggs.md"
      provides: "Lay eggs command for OpenCode"
      contains: ["ant:lay-eggs", "First Eggs", "pheromones"]
    - path: ".claude/commands/ant/status.md"
      provides: "Updated status with milestone display"
      contains: ["milestone", "ğŸ†"]
    - path: ".aether/aether-utils.sh"
      provides: "milestone-detect subcommand"
      contains: ["milestone-detect"]
  key_links:
    - from: ".claude/commands/ant/lay-eggs.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "state reset with preservation"
      pattern: "memory.(phase_learnings|decisions|instincts)"
    - from: ".claude/commands/ant/status.md"
      to: ".aether/aether-utils.sh"
      via: "milestone-detect subcommand"
      pattern: "bash .aether/aether-utils.sh milestone-detect"
---

<objective>
Implement `/ant:lay-eggs` command and milestone auto-detection.

Purpose: Enable users to start fresh colonies while preserving accumulated wisdom (pheromones), and automatically detect colony maturity milestones.
Output: lay-eggs.md commands, updated status.md with milestone display, milestone-detect utility
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-entombment-egg-laying/10-CONTEXT.md
@.planning/phases/10-entombment-egg-laying/10-RESEARCH.md
@.claude/commands/ant/init.md
@.claude/commands/ant/status.md
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add milestone detection to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add `milestone-detect` subcommand to `.aether/aether-utils.sh`:

**milestone-detect**
- Reads COLONY_STATE.json
- Implements algorithm from RESEARCH.md Pattern 3:

```javascript
// Milestone progression:
// First Mound â€” Colony initialized, no phases (v0.1)
// Open Chambers â€” 1+ phases complete (v0.x)
// Brood Stable â€” 3+ phases complete (v0.x)
// Ventilated Nest â€” 5+ phases complete (v0.x)
// Sealed Chambers â€” All phases complete (v1.x.x)
// Crowned Anthill â€” Explicitly sealed (v1.x.x)
```

Algorithm:
1. Extract: phases array, milestone field, errors.records
2. Count completed phases: phases.filter(p => p.status === 'completed').length
3. Check for critical errors: errors.records.some(e => e.severity === 'critical')
4. Determine milestone:
   - If critical errors: "Failed Mound"
   - If all phases completed:
     - If milestone === "Crowned Anthill": "Crowned Anthill"
     - Else: "Sealed Chambers"
   - If completed >= 5: "Ventilated Nest"
   - If completed >= 3: "Brood Stable"
   - If completed >= 1: "Open Chambers"
   - Else: "First Mound"
5. Compute version:
   - major = floor(total_phases / 10)
   - minor = total_phases % 10
   - patch = completed_count
   - version = `v${major}.${minor}.${patch}`

Return JSON:
```json
{
  "ok": true,
  "milestone": "Open Chambers",
  "version": "v0.3.2",
  "phases_completed": 2,
  "total_phases": 3,
  "progress_percent": 67
}
```

Add to help command list.
  </action>
  <verify>
bash .aether/aether-utils.sh milestone-detect | jq -e '.ok == true and .milestone != null'
bash .aether/aether-utils.sh help | jq -e '.commands | contains(["milestone-detect"])'
  </verify>
  <done>milestone-detect subcommand exists and returns correct milestone based on state</done>
</task>

<task type="auto">
  <name>Task 2: Update status.md to display milestone</name>
  <files>.claude/commands/ant/status.md</files>
  <action>
Modify `.claude/commands/ant/status.md`:

1. In Step 2.5 (Gather Dream Information), add a new step:
   **Step 2.6: Detect Milestone**
   - Run: `bash .aether/aether-utils.sh milestone-detect`
   - Extract: milestone, version, phases_completed, total_phases

2. In the display output (Step 3), add milestone line:
   ```
   ğŸ† Milestone: <milestone> (<version>)
   ```

   Place it after the "ğŸš© Flags" line and before "ğŸ’­ Dreams" line.

3. If milestone is "Failed Mound", show warning styling:
   ```
   ğŸ† Milestone: <milestone> âš ï¸ Colony has critical errors
   ```

Ensure the milestone detection is called every time status is displayed.
  </action>
  <verify>
grep -q "milestone-detect" .claude/commands/ant/status.md
grep -q "ğŸ† Milestone:" .claude/commands/ant/status.md
echo "status.md updated with milestone display"
  </verify>
  <done>status.md includes milestone detection call and displays milestone with version</done>
</task>

<task type="auto">
  <name>Task 3: Create /ant:lay-eggs command for Claude Code</name>
  <files>.claude/commands/ant/lay-eggs.md</files>
  <action>
Create `.claude/commands/ant/lay-eggs.md` following the pattern from init.md:

**Frontmatter:**
```yaml
---
name: ant:lay-eggs
description: "ğŸ¥šğŸœğŸ¥š Lay first eggs of new colony (First Eggs milestone)"
---
```

**Instructions structure:**

### Step 1: Validate Input
- If `$ARGUMENTS` is empty:
  ```
  Usage: /ant:lay-eggs "<new colony goal>"

  Start a fresh colony, preserving pheromones from prior colonies.
  Requires current colony to be entombed or reset.

  Example:
    /ant:lay-eggs "Build a REST API with authentication"
  ```
  Stop here.

### Step 2: Check Current Colony
- Read `.aether/data/COLONY_STATE.json`
- If goal is not null AND phases exist with status != "completed":
  ```
  Active colony exists: {goal}

  To start a new colony, you must first:
  1. Complete all phases, then /ant:entomb to archive
  2. Or manually reset by deleting .aether/data/COLONY_STATE.json

  Current: Phase {current_phase}, {phases_count} phases in plan
  ```
  Stop here.

### Step 3: Extract Preserved Knowledge
- Read current state to extract preserved fields:
  - `memory.phase_learnings` (all items)
  - `memory.decisions` (all items)
  - `memory.instincts` (all items with confidence >= 0.5)
- Store for use in Step 4

### Step 4: Create New Colony State
Generate new state following RESEARCH.md Pattern 2 (State Reset with Pheromone Preservation):

**Fields to preserve from old state:**
- memory.phase_learnings
- memory.decisions
- memory.instincts (high confidence only)

**Fields to reset:**
- goal: new goal from $ARGUMENTS
- state: "READY"
- current_phase: 0
- session_id: new session_{unix_timestamp}_{random}
- initialized_at: current ISO-8601 timestamp
- build_started_at: null
- plan: { generated_at: null, confidence: null, phases: [] }
- errors: { records: [], flagged_patterns: [] }
- signals: []
- graveyards: []
- events: [colony_initialized event with new goal]

**New milestone fields:**
- milestone: "First Mound"
- milestone_updated_at: current timestamp
- milestone_version: "v0.1.0"

Write to `.aether/data/COLONY_STATE.json`

### Step 5: Reset Constraints
Write `.aether/data/constraints.json`:
```json
{
  "version": "1.0",
  "focus": [],
  "constraints": []
}
```

### Step 6: Display Result
```
ğŸ¥š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   F I R S T   E G G S   L A I D
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ğŸ¥š

ğŸ‘‘ New colony goal:
   "{goal}"

ğŸ“‹ Session: {session_id}
ğŸ† Milestone: First Mound (v0.1.0)

{If inherited knowledge:}
ğŸ§  Inherited from prior colonies:
   {N} instinct(s) | {N} decision(s) | {N} learning(s)
{End if}

ğŸœ The colony begins anew.

   /ant:plan      ğŸ“‹ Chart the course
   /ant:colonize  ğŸ—ºï¸  Analyze existing code
```

Include edge case handling:
- If no prior knowledge: omit the inheritance section
- If prior colony had no phases: allow laying eggs without entombment
  </action>
  <verify>
grep -q "name: ant:lay-eggs" .claude/commands/ant/lay-eggs.md
grep -q "First Mound" .claude/commands/ant/lay-eggs.md
grep -q "memory.phase_learnings" .claude/commands/ant/lay-eggs.md
echo "lay-eggs.md structure validated"
  </verify>
  <done>lay-eggs.md exists with complete command structure, pheromone preservation, and First Eggs milestone</done>
</task>

<task type="auto">
  <name>Task 4: Mirror lay-eggs command to OpenCode</name>
  <files>.opencode/commands/ant/lay-eggs.md</files>
  <action>
Create `.opencode/commands/ant/lay-eggs.md` as an exact copy of `.claude/commands/ant/lay-eggs.md`.

The commands are identical between Claude Code and OpenCode.

Ensure the directory exists first.
  </action>
  <verify>
test -f .opencode/commands/ant/lay-eggs.md
diff .claude/commands/ant/lay-eggs.md .opencode/commands/ant/lay-eggs.md
echo "OpenCode mirror created and matches"
  </verify>
  <done>OpenCode lay-eggs.md exists and is identical to Claude Code version</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 5: Verify lay-eggs and milestone detection work</name>
  <what-built>
1. milestone-detect subcommand that computes milestone from state
2. Updated /ant:status that displays current milestone
3. /ant:lay-eggs command that:
   - Validates no active colony exists
   - Creates fresh colony with new goal
   - Preserves pheromones (learnings/decisions/instincts)
   - Sets milestone to "First Mound"
  </what-built>
  <how-to-verify>
1. First, test milestone detection:
   - Run `/ant:status` on current colony
   - Verify milestone line shows: "ğŸ† Milestone: X (vX.X.X)"
   - Run `bash .aether/aether-utils.sh milestone-detect | jq` to see raw output

2. Test lay-eggs (requires entombed or reset colony):
   - If you have an active colony, first run `/ant:entomb` and confirm
   - Run `/ant:lay-eggs "Test New Goal"`
   - Verify:
     - Error if active colony exists (unless all phases complete)
     - New COLONY_STATE.json created with goal
     - milestone: "First Mound"
     - Previous learnings/decisions preserved in memory
     - Success message shows inherited knowledge count

3. Test milestone progression:
   - After laying eggs, run `/ant:status`
   - Verify shows "First Mound"
   - Create a plan with phases, mark one complete
   - Run `/ant:status` again - should show "Open Chambers"
  </how-to-verify>
  <resume-signal>Type "approved" if lay-eggs and milestone detection work correctly</resume-signal>
</task>

</tasks>

<verification>
- [ ] milestone-detect subcommand exists in aether-utils.sh
- [ ] milestone-detect returns correct milestone based on phases completed
- [ ] status.md updated to call milestone-detect and display result
- [ ] lay-eggs.md exists for Claude Code
- [ ] lay-eggs.md exists for OpenCode (mirror)
- [ ] lay-eggs validates no active colony before proceeding
- [ ] lay-eggs preserves memory (learnings/decisions/instincts)
- [ ] lay-eggs sets milestone to "First Mound"
</verification>

<success_criteria>
1. User can run `/ant:lay-eggs "goal"` to start fresh colony
2. Active colonies block lay-eggs with clear message
3. Pheromones (learnings/decisions/instincts) carry forward
4. Milestone auto-detects: First Mound â†’ Open Chambers â†’ Brood Stable â†’ Ventilated Nest â†’ Sealed Chambers â†’ Crowned Anthill
5. /ant:status displays current milestone with version
</success_criteria>

<output>
After completion, create `.planning/phases/10-entombment-egg-laying/10-03-SUMMARY.md`
</output>
