---
phase: 06-foundation-safe-checkpoints-testing-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/unit/cli-hash.test.js
autonomous: true

must_haves:
  truths:
    - hashFileSync returns consistent SHA-256 hashes
    - hashFileSync handles missing files gracefully (returns null)
    - hashFileSync returns hash in 'sha256:hex' format
  artifacts:
    - path: "tests/unit/cli-hash.test.js"
      provides: "Unit tests for hashFileSync function"
      min_lines: 80
      contains: ["hashFileSync", "sha256", "test"]
  key_links:
    - from: "tests/unit/cli-hash.test.js"
      to: "bin/cli.js"
      via: "proxyquire('../bin/cli.js', { fs: mockFs })"
---

<objective>
Create comprehensive unit tests for hashFileSync function using sinon and proxyquire.

Purpose: Verify hashFileSync behavior including correct SHA-256 computation, error handling, and return format.
Output: tests/unit/cli-hash.test.js with passing tests.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-RESEARCH.md
@/Users/callumcowie/repos/Aether/bin/cli.js
@/Users/callumcowie/repos/Aether/tests/unit/helpers/mock-fs.js
</context>

<tasks>

<task type="auto">
  <name>Create unit tests for hashFileSync function</name>
  <files>tests/unit/cli-hash.test.js</files>
  <action>
    Create tests/unit/cli-hash.test.js with comprehensive tests for hashFileSync:

    Test structure (follow existing test patterns):
    ```javascript
    const test = require('ava');
    const sinon = require('sinon');
    const proxyquire = require('proxyquire');
    const crypto = require('crypto');

    // Setup mock fs for each test
    test.beforeEach(t => {
      t.context.mockFs = {
        readFileSync: sinon.stub()
      };

      // Load cli.js with mocked fs
      t.context.cli = proxyquire('../bin/cli.js', {
        fs: t.context.mockFs
      });
    });

    test.afterEach(t => {
      sinon.restore();
    });
    ```

    Tests to implement:

    1. 'hashFileSync returns correct SHA-256 hash for file content':
       - Mock readFileSync to return 'hello world'
       - Call hashFileSync('/test/file.txt')
       - Verify result matches expected SHA-256: 'sha256:' + crypto.createHash('sha256').update('hello world').digest('hex')

    2. 'hashFileSync returns consistent hash for same content':
       - Call hashFileSync twice with same mocked content
       - Verify both calls return identical hashes

    3. 'hashFileSync returns null for missing file':
       - Mock readFileSync to throw ENOENT error
       - Verify hashFileSync returns null

    4. 'hashFileSync returns null for permission error':
       - Mock readFileSync to throw EACCES error
       - Verify hashFileSync returns null

    5. 'hashFileSync handles empty file':
       - Mock readFileSync to return empty Buffer
       - Verify returns valid SHA-256 hash of empty content

    6. 'hashFileSync handles binary content':
       - Mock readFileSync to return Buffer with binary data
       - Verify returns valid hash

    7. 'hashFileSync returns hash in correct format':
       - Verify result starts with 'sha256:'
       - Verify hex portion is 64 characters

    Run tests with `npm run test:unit -- tests/unit/cli-hash.test.js` to verify.
  </action>
  <verify>npm run test:unit -- tests/unit/cli-hash.test.js</verify>
  <done>All 7+ tests pass for hashFileSync</done>
</task>

</tasks>

<verification>
- [ ] tests/unit/cli-hash.test.js exists
- [ ] All tests pass: `npm run test:unit -- tests/unit/cli-hash.test.js`
- [ ] Tests cover: correct hashing, consistency, error handling, edge cases
- [ ] Tests use sinon stubs and proxyquire for mocking
</verification>

<success_criteria>
- hashFileSync tests verify correct SHA-256 computation
- Error cases (missing file, permission denied) return null
- Hash format is validated ('sha256:' prefix + 64 hex chars)
- All tests pass with mocked filesystem
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-03-SUMMARY.md`
</output>
