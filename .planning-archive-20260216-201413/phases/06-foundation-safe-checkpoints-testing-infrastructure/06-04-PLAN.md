---
phase: 06-foundation-safe-checkpoints-testing-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/unit/cli-manifest.test.js
autonomous: true

must_haves:
  truths:
    - generateManifest returns object with generated_at timestamp
    - generateManifest includes file hashes for all files in directory
    - generateManifest excludes registry.json, version.json, manifest.json
    - validateManifest correctly validates manifest structure
    - validateManifest returns appropriate error messages for invalid manifests
  artifacts:
    - path: "tests/unit/cli-manifest.test.js"
      provides: "Unit tests for generateManifest and validateManifest functions"
      min_lines: 100
      contains: ["generateManifest", "validateManifest", "test"]
  key_links:
    - from: "tests/unit/cli-manifest.test.js"
      to: "bin/cli.js"
      via: "proxyquire('../bin/cli.js', { fs: mockFs })"
---

<objective>
Create comprehensive unit tests for generateManifest and validateManifest functions using sinon and proxyquire.

Purpose: Verify manifest generation and validation behavior including file discovery, hash inclusion, exclusions, and validation rules.
Output: tests/unit/cli-manifest.test.js with passing tests.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-RESEARCH.md
@/Users/callumcowie/repos/Aether/bin/cli.js
@/Users/callumcowie/repos/Aether/tests/unit/helpers/mock-fs.js
</context>

<tasks>

<task type="auto">
  <name>Create unit tests for generateManifest and validateManifest</name>
  <files>tests/unit/cli-manifest.test.js</files>
  <action>
    Create tests/unit/cli-manifest.test.js with comprehensive tests:

    Test structure:
    ```javascript
    const test = require('ava');
    const sinon = require('sinon');
    const proxyquire = require('proxyquire');

    test.beforeEach(t => {
      t.context.mockFs = {
        existsSync: sinon.stub(),
        readdirSync: sinon.stub(),
        readFileSync: sinon.stub(),
        mkdirSync: sinon.stub()
      };

      // Mock Dirent constructor
      t.context.mockDirent = (name, isDir = false) => ({
        name,
        isDirectory: () => isDir,
        isFile: () => !isDir
      });

      t.context.cli = proxyquire('../bin/cli.js', {
        fs: t.context.mockFs
      });
    });

    test.afterEach(t => {
      sinon.restore();
    });
    ```

    Tests for generateManifest:

    1. 'generateManifest returns object with generated_at timestamp':
       - Mock empty directory
       - Verify result has generated_at string in ISO format

    2. 'generateManifest includes files with hashes':
       - Mock directory with files: file1.txt, file2.txt
       - Mock readFileSync to return content
       - Verify result.files contains both files with 'sha256:' prefixed hashes

    3. 'generateManifest excludes registry.json, version.json, manifest.json':
       - Mock directory with excluded files
       - Verify they are not in result.files

    4. 'generateManifest skips files that cannot be hashed':
       - Mock readFileSync to throw error for one file
       - Verify that file is not in result.files

    5. 'generateManifest handles nested directories':
       - Mock nested structure: dir1/file.txt, dir2/sub/file.txt
       - Verify all files included with correct relative paths

    6. 'generateManifest handles empty directory':
       - Mock empty directory
       - Verify result.files is empty object

    Tests for validateManifest:

    7. 'validateManifest returns valid for correct manifest':
       - Pass valid manifest object
       - Verify returns { valid: true }

    8. 'validateManifest returns error for null manifest':
       - Pass null
       - Verify returns { valid: false, error: 'Manifest must be an object' }

    9. 'validateManifest returns error for missing generated_at':
       - Pass manifest without generated_at
       - Verify appropriate error

    10. 'validateManifest returns error for missing files':
        - Pass manifest without files field
        - Verify appropriate error

    11. 'validateManifest returns error for non-object files':
        - Pass manifest with files as array instead of object
        - Verify appropriate error

    Run tests with `npm run test:unit -- tests/unit/cli-manifest.test.js`.
  </action>
  <verify>npm run test:unit -- tests/unit/cli-manifest.test.js</verify>
  <done>All 11+ tests pass for generateManifest and validateManifest</done>
</task>

</tasks>

<verification>
- [ ] tests/unit/cli-manifest.test.js exists
- [ ] All tests pass: `npm run test:unit -- tests/unit/cli-manifest.test.js`
- [ ] Tests cover: manifest generation, file discovery, exclusions, validation
- [ ] Tests use sinon stubs and proxyquire for mocking
</verification>

<success_criteria>
- generateManifest tests verify correct file discovery and hashing
- Excluded files (registry.json, version.json, manifest.json) are not included
- validateManifest correctly validates manifest structure
- All validation error cases return appropriate messages
- All tests pass with mocked filesystem
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-04-SUMMARY.md`
</output>
