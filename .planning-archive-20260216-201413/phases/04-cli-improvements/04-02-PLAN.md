---
phase: 04-cli-improvements
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - bin/cli.js
autonomous: true

must_haves:
  truths:
    - "CLI uses commander.js for argument parsing instead of manual process.argv"
    - "All existing commands work: install, update, version, uninstall, help"
    - "Update command accepts all flags: --force, --all, --list, --dry-run, --quiet"
    - "Global error handlers remain functional"
    - "Exit codes follow sysexits.h conventions"
  artifacts:
    - path: "bin/cli.js"
      provides: "CLI entry point using commander.js"
      contains: ["require('commander')", ".command(", ".option(", ".action(", "program.parse()"]
      min_lines: 200
  key_links:
    - from: "bin/cli.js"
      to: "bin/lib/errors.js"
      via: "wrapCommand integration"
      pattern: "wrapCommand"
    - from: "bin/cli.js"
      to: "bin/lib/colors.js"
      via: "color output"
      pattern: "require\\('./lib/colors'\\)"
    - from: "bin/cli.js"
      to: "commander"
      via: "program setup"
      pattern: "require\\('commander'\\)"
---

<objective>
Migrate CLI from manual argument parsing to commander.js framework while preserving all existing functionality.

Purpose: Replace the switch-based command parsing with declarative commander.js API for better maintainability and auto-help generation.
Output: Refactored bin/cli.js using commander.js with all commands preserved.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-cli-improvements/04-CONTEXT.md
@.planning/phases/04-cli-improvements/04-RESEARCH.md

@/Users/callumcowie/repos/Aether/.planning/phases/04-cli-improvements/04-01-SUMMARY.md

@/Users/callumcowie/repos/Aether/bin/cli.js
@/Users/callumcowie/repos/Aether/bin/lib/errors.js
@/Users/callumcowie/repos/Aether/bin/lib/colors.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor CLI to use commander.js framework</name>
  <files>bin/cli.js</files>
  <action>
    Migrate bin/cli.js from manual process.argv parsing to commander.js.

    Current structure (preserve all logic):
    - Commands: install, update, version, uninstall, help
    - Update flags: --force, --all, --list, --dry-run, --quiet
    - Global: --quiet flag

    Implementation per RESEARCH.md Pattern 1 (Flat Command Structure):

    1. Import commander and colors:
       const { program } = require('commander');
       const c = require('./lib/colors');

    2. Setup program:
       program
         .name('aether')
         .description('Aether Colony - Multi-agent system using ant colony intelligence')
         .version(VERSION, '-v, --version', 'show version')
         .option('--no-color', 'disable colored output')
         .option('-q, --quiet', 'suppress output')
         .helpOption('-h, --help', 'show help');

    3. Handle --no-color globally:
       program.on('option:no-color', () => { process.env.NO_COLOR = '1'; });

    4. Define commands using .command() with .action():
       - install: no arguments, uses wrapCommand
       - update: options --force, --all, --list, --dry-run
       - version: no options
       - uninstall: no options, uses wrapCommand

    5. Preserve ALL existing logic:
       - All helper functions (copyDirSync, removeDirSync, etc.)
       - FeatureFlags class
       - wrapCommand function
       - Global error handlers (uncaughtException, unhandledRejection)
       - All constants and paths

    6. Replace switch statement with commander commands:
       - Move install case logic to install command action
       - Move update case logic to update command action
       - Move version case logic to version command action
       - Move uninstall case logic to uninstall command action

    7. End with: program.parse();

    Critical requirements:
    - Keep wrapCommand usage for async error handling
    - Keep all existing helper functions intact
    - Maintain quiet flag functionality
    - Maintain dry-run functionality
    - Preserve exit codes via getExitCode()

    Reference RESEARCH.md "Complete CLI Setup Pattern" for structure.
  </action>
  <verify>
    Run: node bin/cli.js --help
    Run: node bin/cli.js version
    Run: node bin/cli.js install --help
    Run: node bin/cli.js update --help
    Verify all commands show help correctly
  </verify>
  <done>
    bin/cli.js uses commander.js with all commands defined, --help works for all commands
  </done>
</task>

<task type="auto">
  <name>Task 2: Add colored output to all CLI commands</name>
  <files>bin/cli.js</files>
  <action>
    Integrate colors from bin/lib/colors.js into all CLI output.

    Color application points:

    1. Headers and titles:
       - Version header: c.header(`aether-colony v${VERSION}`)
       - Command headers in install/update/uninstall

    2. Success messages:
       - "Install complete" -> c.success()
       - "Updated:" messages -> c.success()
       - "Uninstall complete" -> c.success()

    3. Warnings:
       - Warning messages -> c.warning()
       - "Pruned:" messages -> c.warning()

    4. Errors:
       - Error output should remain JSON (structured errors)
       - But error messages in normal flow use c.error()

    5. Info/dim:
       - File paths -> c.dim()
       - Secondary info -> c.dim()

    6. Queen/Colony branding:
       - Queen-related messages -> c.queen()
       - Colony-related messages -> c.colony()

    Preserve --quiet functionality:
    - All console.log/console.error should respect quiet flag
    - Colors don't apply when quiet is true

    Implementation approach:
    - Import colors: const c = require('./lib/colors');
    - Replace log() function to use colors when not quiet
    - Apply colors to all user-facing strings

    Critical: Don't break JSON error output - structured errors must remain valid JSON.
  </action>
  <verify>
    Run: node bin/cli.js version (should show colored output)
    Run: node bin/cli.js --no-color version (should show plain output)
    Run: NO_COLOR=1 node bin/cli.js version (should show plain output)
    Verify colors apply correctly and respect flags
  </verify>
  <done>
    All CLI output uses semantic colors from bin/lib/colors.js, respects --no-color and NO_COLOR
  </done>
</task>

</tasks>

<verification>
- [ ] bin/cli.js uses commander.js (require('commander'))
- [ ] All 5 commands work: install, update, version, uninstall, help
- [ ] Update accepts all flags: --force, --all, --list, --dry-run, --quiet
- [ ] --help works for CLI and individual commands
- [ ] Colored output appears in normal mode
- [ ] --no-color disables colors
- [ ] NO_COLOR environment variable disables colors
- [ ] --quiet suppresses output
- [ ] Error handling still produces structured JSON
- [ ] Exit codes follow sysexits.h conventions
- [ ] All existing functionality preserved
</verification>

<success_criteria>
- Commander.js migration complete
- All commands functional with colored output
- Auto-help generation works
- Backward compatibility maintained (all existing flags work)
- Error handling preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-improvements/04-02-SUMMARY.md`
</output>
