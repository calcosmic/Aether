---
phase: 12-colony-visualization
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - .claude/commands/ant/swarm.md
  - .aether/utils/swarm-display.sh
  - bin/lib/caste-colors.js
autonomous: true
must_haves:
  truths:
    - /ant:swarm shows real-time display with "3 foragers excavating..." format
    - Each caste displays with both distinct color AND emoji together
    - Display updates live as ants start/complete work
    - Tool usage stats (Read/Grep/Edit/Bash counts) visible per ant
    - Trophallaxis metrics (token usage) shown per task
    - Chamber activity map shows active chambers with fire intensity (VIZ-07)
  artifacts:
    - path: .claude/commands/ant/swarm.md
      provides: Enhanced swarm command with real-time display
      contains: ["swarm-display.sh invocation", "activity tracking calls"]
    - path: .aether/utils/swarm-display.sh
      provides: Real-time display rendering script
      exports: ["render_swarm", "watch_swarm"]
    - path: bin/lib/caste-colors.js
      provides: Caste color definitions
      contains: ["builder: blue", "watcher: green", "scout: yellow", "chaos: red", "prime: magenta"]
  key_links:
    - from: swarm-display.sh
      to: .aether/data/swarm-display.json
      via: file polling (fswatch/inotifywait/fallback)
      pattern: "render_swarm reads JSON, outputs colored text"
    - from: ant:swarm command
      to: swarm-display.sh
      via: bash invocation
      pattern: "bash .aether/utils/swarm-display.sh"
    - from: caste-colors.js
      to: swarm-display.sh
      via: color definitions aligned
      pattern: "ANSI codes match: builder=\\033[34m (blue)"
    - from: swarm-display-update command
      to: .aether/data/swarm-display.json
      via: JSON update with chambers data
      pattern: "chambers object populated with activity counts"
---

<objective>
Implement the `/ant:swarm` real-time display command showing active ants with caste colors, emojis, tool usage stats, and trophallaxis metrics. Creates an immersive "3 foragers excavating..." experience with live updates.

Purpose: Delivers the core visualization experience (VIZ-01, VIZ-03, VIZ-04, VIZ-06, VIZ-07, VIZ-09) - the main user-facing feature of this phase.
Output: Enhanced swarm.md command, swarm-display.sh rendering script, and caste-colors.js for consistent theming.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-colony-visualization/12-RESEARCH.md
@/Users/callumcowie/repos/Aether/.claude/commands/ant/swarm.md
@/Users/callumcowie/repos/Aether/runtime/utils/watch-spawn-tree.sh
@/Users/callumcowie/repos/Aether/bin/lib/colors.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create caste-colors.js with color + emoji definitions</name>
  <files>bin/lib/caste-colors.js</files>
  <action>
Create bin/lib/caste-colors.js that exports caste styling information:

```javascript
const pc = require('picocolors');

// Caste definitions with colors and emojis (per CONTEXT.md decisions)
const CASTE_STYLES = {
  builder:  { color: 'blue',   emoji: 'üî®', ansi: '\033[34m', pc: pc.blue },
  watcher:  { color: 'green',  emoji: 'üëÅÔ∏è',  ansi: '\033[32m', pc: pc.green },
  scout:    { color: 'yellow', emoji: 'üîç', ansi: '\033[33m', pc: pc.yellow },
  chaos:    { color: 'red',    emoji: 'üé≤', ansi: '\033[31m', pc: pc.red },
  prime:    { color: 'magenta',emoji: 'üëë', ansi: '\033[35m', pc: pc.magenta }
};

// Get style for a caste (case-insensitive)
function getCasteStyle(caste) {
  const key = caste.toLowerCase();
  return CASTE_STYLES[key] || { color: 'reset', emoji: 'üêú', ansi: '\033[0m', pc: (s) => s };
}

// Format ant name with color and emoji: "üî® Builder" (both colored)
function formatAnt(name, caste) {
  const style = getCasteStyle(caste);
  return `${style.emoji} ${style.pc(name)}`;
}

// Format with ANSI codes (for bash scripts)
function formatAntAnsi(name, caste) {
  const style = getCasteStyle(caste);
  return `${style.ansi}${style.emoji} ${name}\033[0m`;
}

// Get all castes for iteration
function getCastes() {
  return Object.keys(CASTE_STYLES);
}

module.exports = {
  CASTE_STYLES,
  getCasteStyle,
  formatAnt,
  formatAntAnsi,
  getCastes
};
```

This provides a single source of truth for caste colors and emojis, used by both Node.js and bash scripts.
  </action>
  <verify>node -e "const c = require('./bin/lib/caste-colors.js'); console.log(c.formatAnt('Builder', 'builder'));" | grep -q "üî®" && echo "caste-colors.js working"</verify>
  <done>caste-colors.js exists, exports getCasteStyle/formatAnt/formatAntAnsi, builder=blue with üî® emoji</done>
</task>

<task type="auto">
  <name>Task 2: Create swarm-display.sh real-time rendering script</name>
  <files>.aether/utils/swarm-display.sh</files>
  <action>
Create .aether/utils/swarm-display.sh for real-time swarm display:

```bash
#!/bin/bash
# Real-time swarm activity display
# Usage: bash swarm-display.sh [swarm_id]

SWARM_ID="${1:-current}"
DATA_DIR="${DATA_DIR:-.aether/data}"
DISPLAY_FILE="$DATA_DIR/swarm-display.json"

# ANSI colors (matching caste-colors.js)
BLUE='\033[34m'
GREEN='\033[32m'
YELLOW='\033[33m'
RED='\033[31m'
MAGENTA='\033[35m'
BOLD='\033[1m'
UNDERLINE='\033[4m'
DIM='\033[2m'
RESET='\033[0m'

# Caste colors (must match caste-colors.js)
get_caste_color() {
  case "$1" in
    builder)  echo "$BLUE" ;;
    watcher)  echo "$GREEN" ;;
    scout)    echo "$YELLOW" ;;
    chaos)    echo "$RED" ;;
    prime)    echo "$MAGENTA" ;;
    *)        echo "$RESET" ;;
  esac
}

# Caste emojis (must match aether-utils.sh)
get_caste_emoji() {
  case "$1" in
    builder)  echo "üî®" ;;
    watcher)  echo "üëÅÔ∏è" ;;
    scout)    echo "üîç" ;;
    chaos)    echo "üé≤" ;;
    prime)    echo "üëë" ;;
    *)        echo "üêú" ;;
  esac
}

# Animated status phrases
get_status_phrase() {
  local caste="$1"
  local idx=$(($(date +%s) % 4))
  case "$caste" in
    builder)
      phrases=("excavating..." "building..." "forging..." "constructing...")
      ;;
    watcher)
      phrases=("observing..." "monitoring..." "watching..." "tracking...")
      ;;
    scout)
      phrases=("exploring..." "searching..." "investigating..." "probing...")
      ;;
    chaos)
      phrases=("disrupting..." "testing..." "probing..." "stressing...")
      ;;
    *)
      phrases=("working..." "foraging..." "excavating..." "tunneling...")
      ;;
  esac
  echo "${phrases[$idx]}"
}

# Format tool usage: "üìñ5 üîç3 ‚úèÔ∏è2 ‚ö°1"
format_tools() {
  local read="${1:-0}"
  local grep="${2:-0}"
  local edit="${3:-0}"
  local bash="${4:-0}"
  local result=""
  [[ "$read" -gt 0 ]] && result="${result}üìñ${read} "
  [[ "$grep" -gt 0 ]] && result="${result}üîç${grep} "
  [[ "$edit" -gt 0 ]] && result="${result}‚úèÔ∏è${edit} "
  [[ "$bash" -gt 0 ]] && result="${result}‚ö°${bash}"
  echo "$result"
}

# Format duration from seconds
format_duration() {
  local seconds="${1:-0}"
  if [[ "$seconds" -lt 60 ]]; then
    echo "${seconds}s"
  else
    local mins=$((seconds / 60))
    local secs=$((seconds % 60))
    echo "${mins}m${secs}s"
  fi
}

# Render the swarm display
render_swarm() {
  clear

  # Header
  echo -e "${BOLD}${MAGENTA}"
  cat << 'EOF'
       .-.
      (o o)  AETHER COLONY
      | O |  Swarm Activity
       `-`
EOF
  echo -e "${RESET}"
  echo -e "${DIM}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${RESET}"
  echo ""

  if [[ ! -f "$DISPLAY_FILE" ]]; then
    echo -e "${DIM}Waiting for swarm activity...${RESET}"
    echo ""
    echo -e "${DIM}0 foragers excavating...${RESET}"
    return
  fi

  # Read swarm data
  local swarm_data=$(cat "$DISPLAY_FILE" 2>/dev/null)
  if [[ -z "$swarm_data" ]]; then
    echo -e "${DIM}No active swarm data${RESET}"
    return
  fi

  # Check if we have active ants
  local total_active=$(echo "$swarm_data" | jq -r '.summary.total_active // 0')

  if [[ "$total_active" -eq 0 ]]; then
    echo -e "${DIM}No active foragers${RESET}"
    echo ""
    echo -e "${DIM}0 foragers excavating...${RESET}"
    return
  fi

  # Render each active ant
  echo "$swarm_data" | jq -r '.active_ants[] |
    "\(.name)|\(.caste)|\(.status)|\(.task // "")|\(.tools.read // 0)|\(.tools.grep // 0)|\(.tools.edit // 0)|\(.tools.bash // 0)|\(.tokens // 0)|\(.started_at // "")|\(.parent // "Queen")"' 2>/dev/null | \
  while IFS='|' read -r name caste status task read_count grep_count edit_count bash_count tokens started_at parent; do
    color=$(get_caste_color "$caste")
    emoji=$(get_caste_emoji "$caste")
    phrase=$(get_status_phrase "$caste")

    # Parent ants: bold + underline
    if [[ "$parent" == "Queen" ]] || [[ "$parent" == "Prime"* ]]; then
      style="${BOLD}${UNDERLINE}"
    else
      style="${BOLD}"
    fi

    # Format tools
    tools_str=$(format_tools "$read_count" "$grep_count" "$edit_count" "$bash_count")

    # Calculate elapsed time
    elapsed_str=""
    if [[ -n "$started_at" ]]; then
      started_ts=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$started_at" +%s 2>/dev/null || date -d "$started_at" +%s 2>/dev/null || echo "0")
      now_ts=$(date +%s)
      elapsed=$((now_ts - started_ts))
      if [[ $elapsed -gt 0 ]]; then
        elapsed_str="${DIM}($(format_duration $elapsed))${RESET}"
      fi
    fi

    # Trophallaxis (token) indicator
    token_str=""
    if [[ "$tokens" -gt 0 ]]; then
      token_str="${DIM}üçØ${tokens}${RESET}"
    fi

    # Truncate task if too long
    display_task="$task"
    [[ ${#display_task} -gt 35 ]] && display_task="${display_task:0:32}..."

    # Output line: "üî® Builder: excavating... Implement auth üìñ5 üîç3 (2m3s) üçØ1250"
    echo -e "${color}${emoji} ${style}${name}${RESET}${color}: ${phrase}${RESET} ${display_task}"
    echo -e "   ${tools_str} ${elapsed_str} ${token_str}"
    echo ""
  done

  # Chamber activity map (VIZ-07)
  echo -e "${DIM}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${RESET}"
  echo ""
  echo -e "${BOLD}Chamber Activity:${RESET}"

  # Show active chambers with fire intensity
  echo "$swarm_data" | jq -r '.chambers | to_entries[] | "\(.key)|\(.value.activity)|\(.value.icon)"' 2>/dev/null | \
  while IFS='|' read -r chamber activity icon; do
    if [[ "$activity" -gt 0 ]]; then
      # Fire intensity based on activity count
      if [[ "$activity" -ge 5 ]]; then
        fires="üî•üî•üî•"
      elif [[ "$activity" -ge 3 ]]; then
        fires="üî•üî•"
      else
        fires="üî•"
      fi
      echo -e "  ${icon} ${chamber//_/ } ${fires} (${activity} ants)"
    fi
  done

  # Summary line (VIZ-06: ant-themed presentation)
  echo ""
  echo -e "${DIM}${total_active} forager$([[ "$total_active" -eq 1 ]] || echo "s") excavating...${RESET}"
}

# Main loop with file watching
render_swarm

if command -v fswatch &>/dev/null; then
  fswatch -o "$DISPLAY_FILE" 2>/dev/null | while read; do render_swarm; done
elif command -v inotifywait &>/dev/null; then
  while inotifywait -q -e modify "$DISPLAY_FILE" 2>/dev/null; do render_swarm; done
else
  # Fallback: poll every 2 seconds
  while true; do sleep 2; render_swarm; done
fi
```

Make it executable: chmod +x .aether/utils/swarm-display.sh
  </action>
  <verify>head -20 .aether/utils/swarm-display.sh | grep -q "swarm-display.sh" && echo "Script created"</verify>
  <done>swarm-display.sh exists, is executable, contains render_swarm function with caste colors, emojis, tool formatting, and chamber activity map</done>
</task>

<task type="auto">
  <name>Task 3: Enhance ant:swarm command with real-time display integration</name>
  <files>.claude/commands/ant/swarm.md</files>
  <action>
Rewrite .claude/commands/ant/swarm.md to integrate real-time display:

1. Update the header description to mention real-time display:
```yaml
---
name: ant:swarm
description: "üî•üêúüó°Ô∏èüêúüî• Real-time colony swarm display + stubborn bug destroyer"
---
```

2. Add a new "Quick View" mode at the top:
```markdown
### Quick View Mode (No Arguments)

If `$ARGUMENTS` is empty or equals "--watch":

Run the real-time swarm display:
```bash
bash .aether/utils/swarm-display.sh
```

This shows:
- Active ants with caste colors and emojis (üî® Builder in blue, etc.)
- Tool usage stats per ant (üìñ5 üîç3 ‚úèÔ∏è2 ‚ö°1)
- Trophallaxis metrics (üçØ token consumption)
- Timing information (elapsed time per ant)
- Chamber activity map (which nest zones have active ants)
- Animated status phrases ("excavating...", "foraging...")

Display updates automatically as ants start/complete work.
Press Ctrl+C to exit.
```

3. Keep the existing bug destruction mode but rename section to "### Bug Destruction Mode (With Arguments)"

4. Add activity tracking calls throughout the bug destruction flow:
   - After Step 2 (Initialize): `bash .aether/aether-utils.sh swarm-display-init "{swarm_id}"`
   - After spawning each scout: `bash .aether/aether-utils.sh swarm-display-update "{scout_name}" "{caste}" "excavating" "{task}" "Queen"`
   - When scouts complete: Update status to "completed"
   - Track tool usage: When scouts report findings, update tool counts

5. Add to Step 5 (Deploy scouts) - track each spawn:
```markdown
Log each scout to swarm display:
```bash
bash .aether/aether-utils.sh swarm-display-update "GitArchaeologist-{swarm_id}" "scout" "excavating" "Git history investigation" "Queen" '{"read":0,"grep":0,"edit":0,"bash":3}' 0
```
```

6. Add cleanup in Step 10:
```markdown
Clear swarm display:
```bash
bash .aether/aether-utils.sh swarm-display-init "complete-{swarm_id}"
```
```

The command should support both modes:
- `/ant:swarm` - Show real-time display (new default)
- `/ant:swarm "bug description"` - Deploy bug destruction swarm (existing)
  </action>
  <verify>grep -q "Quick View Mode" .claude/commands/ant/swarm.md && grep -q "swarm-display.sh" .claude/commands/ant/swarm.md && echo "swarm.md enhanced"</verify>
  <done>swarm.md has Quick View mode with swarm-display.sh, Bug Destruction mode preserved, activity tracking calls added throughout</done>
</task>

<task type="auto">
  <name>Task 4: Verify VIZ-07 chamber activity data population</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Verify that the swarm-display-update command in aether-utils.sh properly populates chamber activity data for VIZ-07:

1. Check that swarm-display-update accepts and processes a "chamber" parameter
2. Ensure the JSON structure includes a "chambers" object with activity counts
3. Verify activity counts are incremented when ants are assigned to chambers

The expected JSON structure in .aether/data/swarm-display.json should be:
```json
{
  "chambers": {
    "tunnel_a": { "activity": 3, "icon": "üöá" },
    "chamber_b": { "activity": 1, "icon": "üèõÔ∏è" }
  }
}
```

If the chambers object is not being populated, update swarm-display-update to:
- Accept an optional chamber parameter (9th argument)
- Track activity counts per chamber
- Include chamber icons based on chamber name patterns
  </action>
  <verify>bash .aether/aether-utils.sh swarm-display-update test-ant builder excavating "test task" Queen '{"read":1}' 100 tunnel_a && cat .aether/data/swarm-display.json | jq -e '.chambers.tunnel_a.activity' && echo "Chamber activity populated"</verify>
  <done>swarm-display-update populates chamber activity counts, chambers object exists in swarm-display.json with activity and icon fields</done>
</task>

</tasks>

<verification>
1. Test caste-colors.js: `node -e "const c=require('./bin/lib/caste-colors.js'); console.log(c.formatAnt('Test','builder'));"` - should show blue text with üî®
2. Test swarm-display.sh initialization: `bash .aether/aether-utils.sh swarm-display-init test && bash .aether/utils/swarm-display.sh &` (kill after 2 seconds) - should render header
3. Verify ant:swarm command has both modes: `grep -A5 "Quick View" .claude/commands/ant/swarm.md` - should show real-time display instructions
4. Check color alignment: `grep "BLUE.*34m" .aether/utils/swarm-display.sh && grep "builder.*blue" bin/lib/caste-colors.js` - both should show blue for builder
5. Verify VIZ-07 chamber activity: `cat .aether/data/swarm-display.json | jq '.chambers'` - should show chamber activity counts with fire icons
</verification>

<success_criteria>
- caste-colors.js exists with builder=blue, watcher=green, scout=yellow, chaos=red, prime=magenta + emojis
- swarm-display.sh renders real-time display with ANSI colors, caste emojis, tool stats, tokens, timing
- swarm.md command has Quick View mode (real-time) and Bug Destruction mode (existing)
- Activity tracking integrated into bug destruction flow
- All caste color definitions are consistent between JS and bash
- VIZ-07 chamber activity map shows active chambers with fire intensity based on ant count
</success_criteria>

<output>
After completion, create `.planning/phases/12-colony-visualization/12-02-SUMMARY.md`
</output>
