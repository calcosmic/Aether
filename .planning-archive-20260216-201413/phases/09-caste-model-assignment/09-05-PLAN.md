---
phase: 09-caste-model-assignment
plan: 05
type: execute
wave: 5
depends_on: ["09-02"]
files_modified:
  - .claude/commands/ant/status.md
  - .claude/commands/ant/init.md
  - bin/lib/nestmate-loader.js
autonomous: true
must_haves:
  truths:
    - `/ant:status` shows dream count and last dream timestamp
    - Commands auto-load nestmate context (sibling projects)
    - TO-DOs and colony state are automatically recognized
  artifacts:
    - path: .claude/commands/ant/status.md
      provides: "Enhanced status with dream information"
      contains: "dreams"
    - path: .claude/commands/ant/init.md
      provides: "Auto-load context for nestmates"
      contains: "nestmate"
    - path: bin/lib/nestmate-loader.js
      provides: "Nestmate detection and context loading"
      exports: ["findNestmates", "loadNestmateContext"]
  key_links:
    - from: .claude/commands/ant/status.md
      to: .aether/dreams/
      via: "Bash tool ls"
      pattern: "dreams"
    - from: bin/lib/nestmate-loader.js
      to: sibling .aether/ directories
      via: "fs.readdirSync parent directory"
      pattern: "findNestmates"
---

<objective>
Implement quick wins: surface Dreams in `/ant:status` and add auto-load context for nestmates (sibling projects). Enable commands to automatically recognize and load TO-DOs and colony state.

Purpose: Enhance user experience by showing dream activity in status and enabling cross-project context awareness.
Output: Enhanced status command with dream info and automatic nestmate context loading.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-caste-model-assignment/09-RESEARCH.md
@.planning/phases/09-caste-model-assignment/09-CONTEXT.md
@/Users/callumcowie/repos/Aether/.claude/commands/ant/status.md
@/Users/callumcowie/repos/Aether/.claude/commands/ant/init.md
</context>

<tasks>

<task type="auto">
  <name>Enhance /ant:status with dream information</name>
  <files>.claude/commands/ant/status.md</files>
  <action>
    Modify .claude/commands/ant/status.md to include dream information in the display.

    After Step 2 (Compute Summary), add a new step to gather dream info:

    **Step 2.5: Gather Dream Information**

    Run using Bash tool: `ls -1 .aether/dreams/*.md 2>/dev/null | wc -l`

    Capture:
    - Dream count: number of .md files in .aether/dreams/
    - Latest dream: most recent file by name (files are timestamped: YYYY-MM-DD-HHMM.md)

    To get latest dream timestamp:
    ```bash
    ls -1 .aether/dreams/*.md 2>/dev/null | sort | tail -1 | sed 's/.*\/\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\)-\([0-9]\{4\}\).*/\1 \2/'
    ```

    Update the display output (Step 3) to include dream line:

    ```
    üëë Goal: <goal (truncated to 60 chars)>

    üìç Phase <N>/<M>: <phase name>
       Tasks: <completed>/<total> complete

    üéØ Focus: <focus_count> areas | üö´ Avoid: <constraints_count> patterns
    üß† Instincts: <total> learned (<high_confidence> strong)
    üö© Flags: <blockers> blockers | <issues> issues | <notes> notes
    üèÜ Milestone: <milestone>
    üí≠ Dreams: <count> recorded (latest: <timestamp>)  <-- NEW LINE
    ```

    If no dreams exist, show: `üí≠ Dreams: None recorded`

    Add the dream gathering logic before the display step, and include the dream line in the output template.
  </action>
  <verify>cat .claude/commands/ant/status.md | grep -A2 "Dreams:"</verify>
  <done>status.md includes dream count and latest timestamp in display</done>
</task>

<task type="auto">
  <name>Create nestmate-loader.js library</name>
  <files>bin/lib/nestmate-loader.js</files>
  <action>
    Create bin/lib/nestmate-loader.js for detecting and loading sibling projects:

    ```javascript
    const fs = require('fs');
    const path = require('path');

    /**
     * Find nestmate colonies (sibling directories with .aether/)
     * @param {string} currentRepoPath - Current repository path
     * @returns {Array<{name: string, path: string, goal: string|null}>} Nestmate info
     */
    function findNestmates(currentRepoPath) {
      const parentDir = path.dirname(currentRepoPath);
      const currentName = path.basename(currentRepoPath);

      try {
        const entries = fs.readdirSync(parentDir, { withFileTypes: true });
        const nestmates = [];

        for (const entry of entries) {
          if (!entry.isDirectory()) continue;
          if (entry.name === currentName) continue;
          if (entry.name.startsWith('.')) continue;

          const siblingPath = path.join(parentDir, entry.name);
          const aetherPath = path.join(siblingPath, '.aether');

          if (fs.existsSync(aetherPath)) {
            // Try to read colony goal from state
            let goal = null;
            try {
              const statePath = path.join(aetherPath, 'data', 'COLONY_STATE.json');
              if (fs.existsSync(statePath)) {
                const state = JSON.parse(fs.readFileSync(statePath, 'utf8'));
                goal = state.goal || null;
              }
            } catch (e) {
              // Ignore read errors
            }

            nestmates.push({
              name: entry.name,
              path: siblingPath,
              goal: goal
            });
          }
        }

        return nestmates;
      } catch (error) {
        return [];
      }
    }

    /**
     * Load TO-DOs from a nestmate
     * @param {string} nestmatePath - Path to nestmate repository
     * @returns {Array<{file: string, todos: string[]}>} TO-DO items
     */
    function loadNestmateTodos(nestmatePath) {
      const todos = [];
      const planningPath = path.join(nestmatePath, '.planning');

      try {
        // Look for TODO files in .planning/
        if (fs.existsSync(planningPath)) {
          const entries = fs.readdirSync(planningPath);
          for (const entry of entries) {
            if (entry.toLowerCase().includes('todo')) {
              const todoPath = path.join(planningPath, entry);
              const content = fs.readFileSync(todoPath, 'utf8');
              // Extract TODO items (lines starting with - [ ] or TODO:)
              const items = content.split('\n')
                .filter(line => line.match(/^\s*-\s*\[\s*\]|TODO:/i))
                .map(line => line.trim());

              if (items.length > 0) {
                todos.push({ file: entry, items });
              }
            }
          }
        }
      } catch (error) {
        // Ignore errors
      }

      return todos;
    }

    /**
     * Get colony state summary from a nestmate
     * @param {string} nestmatePath - Path to nestmate repository
     * @returns {Object|null} State summary
     */
    function getNestmateState(nestmatePath) {
      try {
        const statePath = path.join(nestmatePath, '.aether', 'data', 'COLONY_STATE.json');
        if (!fs.existsSync(statePath)) return null;

        const state = JSON.parse(fs.readFileSync(statePath, 'utf8'));
        return {
          goal: state.goal,
          state: state.state,
          currentPhase: state.current_phase,
          milestone: state.milestone
        };
      } catch (error) {
        return null;
      }
    }

    /**
     * Format nestmate info for display
     * @param {Array} nestmates - Nestmate array from findNestmates
     * @returns {string} Formatted string
     */
    function formatNestmates(nestmates) {
      if (nestmates.length === 0) {
        return 'No nestmates found.';
      }

      return nestmates.map(n => {
        const goal = n.goal ? ` - ${n.goal.substring(0, 40)}${n.goal.length > 40 ? '...' : ''}` : '';
        return `  ‚Ä¢ ${n.name}${goal}`;
      }).join('\n');
    }

    module.exports = {
      findNestmates,
      loadNestmateTodos,
      getNestmateState,
      formatNestmates
    };
    ```
  </action>
  <verify>node -e "const nl = require('./bin/lib/nestmate-loader'); console.log(Object.keys(nl))"</verify>
  <done>nestmate-loader.js exports all 4 functions</done>
</task>

<task type="auto">
  <name>Enhance /ant:init with nestmate detection</name>
  <files>.claude/commands/ant/init.md</files>
  <action>
    Modify .claude/commands/ant/init.md to auto-load nestmate context.

    After Step 1 (Initialize Colony State), add:

    **Step 1.5: Detect Nestmates**

    Run using Bash tool: `node -e "const nl = require('./bin/lib/nestmate-loader'); console.log(JSON.stringify(nl.findNestmates(process.cwd())))"`

    If nestmates are found:
    1. Display: `Nestmates found: N related colonies`
    2. List each nestmate with name and truncated goal
    3. Check for shared TO-DOs or cross-project dependencies

    Add a note in the output:
    ```
    üèòÔ∏è Nest Context: N sibling colonies detected
       Context from related projects will be automatically considered
       during planning and execution.
    ```

    Also enhance the command to load constraints from nestmates:

    **Step 3.5: Load Nestmate Constraints (Optional)**

    If nestmates exist and user confirms, load constraints from sibling projects:
    - Check `.aether/data/constraints.json` in each nestmate
    - Merge focus areas (avoiding duplicates)
    - Display merged constraints

    Update the final output to mention nestmate awareness:
    ```
    Colony initialized with nestmate awareness.
    N sibling colonies detected and will be considered during operations.
    ```
  </action>
  <verify>cat .claude/commands/ant/init.md | grep -i nestmate</verify>
  <done>init.md includes nestmate detection and context loading</done>
</task>

<task type="auto">
  <name>Add nestmate CLI commands</name>
  <files>bin/cli.js</files>
  <action>
    Add nestmate-related CLI commands to bin/cli.js:

    ```javascript
    const { findNestmates, formatNestmates, loadNestmateTodos } = require('./lib/nestmate-loader');

    // Nestmates command
    program
      .command('nestmates')
      .description('List sibling colonies (nestmates)')
      .action(wrapCommand(async () => {
        const repoPath = process.cwd();
        const nestmates = findNestmates(repoPath);

        if (nestmates.length === 0) {
          console.log('No nestmates found (sibling directories with .aether/).');
          return;
        }

        console.log(`Found ${nestmates.length} nestmate(s):\n`);
        console.log(formatNestmates(nestmates));
      }));

    // Context command (auto-load)
    program
      .command('context')
      .description('Show auto-loaded context including nestmates')
      .action(wrapCommand(async () => {
        const repoPath = process.cwd();

        // Load nestmates
        const nestmates = findNestmates(repoPath);
        console.log('=== Auto-Loaded Context ===\n');

        // Nestmates
        console.log(`Nestmates: ${nestmates.length} found`);
        if (nestmates.length > 0) {
          console.log(formatNestmates(nestmates));
        }

        // TO-DOs from nestmates
        console.log('\nCross-Project TO-DOs:');
        let hasTodos = false;
        for (const nestmate of nestmates) {
          const todos = loadNestmateTodos(nestmate.path);
          if (todos.length > 0) {
            hasTodos = true;
            console.log(`\n${nestmate.name}:`);
            for (const todo of todos) {
              console.log(`  ${todo.file}:`);
              for (const item of todo.items.slice(0, 5)) {
                console.log(`    ${item}`);
              }
              if (todo.items.length > 5) {
                console.log(`    ... and ${todo.items.length - 5} more`);
              }
            }
          }
        }
        if (!hasTodos) {
          console.log('  No cross-project TO-DOs found.');
        }
      }));
    ```

    These commands allow users to manually check nestmate context.
  </action>
  <verify>node bin/cli.js nestmates --help && node bin/cli.js context --help</verify>
  <done>nestmates and context CLI commands exist</done>
</task>

</tasks>

<verification>
- `/ant:status` shows dream count and latest dream timestamp
- Dreams line appears in status output with correct count
- `aether nestmates` lists sibling colonies with .aether/
- `aether context` shows cross-project TO-DOs
- `/ant:init` detects and mentions nestmates during initialization
- nestmate-loader.js correctly finds sibling directories
</verification>

<success_criteria>
1. status.md displays dream count and latest timestamp
2. nestmate-loader.js created with findNestmates, loadNestmateTodos, getNestmateState, formatNestmates
3. init.md enhanced with nestmate detection
4. CLI commands nestmates and context added
5. Cross-project TO-DOs are detected and displayed
6. Dream information correctly parsed from .aether/dreams/ filenames
</success_criteria>

<output>
After completion, create `.planning/phases/09-caste-model-assignment/09-05-SUMMARY.md`
</output>
