---
phase: 09-caste-model-assignment
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - .aether/aether-utils.sh
  - bin/lib/spawn-logger.js
autonomous: true
must_haves:
  truths:
    - Worker spawn logs include the actual model used for each spawn
    - Spawn tree visualization shows model information
    - Activity log records model assignments with timestamps
  artifacts:
    - path: .aether/aether-utils.sh
      provides: "Enhanced spawn-log command with model parameter"
      contains: "spawn-log.*model"
    - path: bin/lib/spawn-logger.js
      provides: "Spawn logging utilities with model tracking"
      exports: ["logSpawn", "formatSpawnTree"]
  key_links:
    - from: .aether/aether-utils.sh
      to: .aether/logs/spawn-tree.txt
      via: "spawn-log command"
      pattern: "spawn-tree.txt"
    - from: bin/lib/spawn-logger.js
      to: .aether/logs/activity.log
      via: "logActivity function"
      pattern: "activity.log"
---

<objective>
Implement logging of actual model used per worker spawn. Enhance spawn-log command to record model information and update spawn tree visualization to display models.

Purpose: Create audit trail of which models were actually used for each worker spawn, enabling debugging and verification of model routing.
Output: Enhanced logging that captures model information in spawn-tree.txt and activity.log.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-caste-model-assignment/09-RESEARCH.md
@.planning/phases/09-caste-model-assignment/09-CONTEXT.md
@.planning/phases/09-caste-model-assignment/09-01-PLAN.md
@.planning/phases/09-caste-model-assignment/09-02-PLAN.md
@.planning/phases/09-caste-model-assignment/09-03-PLAN.md
@/Users/callumcowie/repos/Aether/.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Enhance spawn-log command with model parameter</name>
  <files>.aether/aether-utils.sh</files>
  <action>
    Locate the spawn-log function in .aether/aether-utils.sh (around line 319 per RESEARCH.md).

    Modify to accept and record model information:

    1. Update function signature to accept model parameter:
       ```bash
       spawn-log() {
         local parent="$1"
         local caste="$2"
         local child="$3"
         local task="$4"
         local model="${5:-default}"  # NEW: model parameter with default
         local status="${6:-spawned}" # shifted from 5 to 6
         ...
       }
       ```

    2. Update spawn-tree.txt format to include model:
       OLD: `timestamp|parent|caste|child|task|status`
       NEW: `timestamp|parent|caste|child|task|model|status`

    3. Update all calls to spawn-log within aether-utils.sh to pass model:
       - Find all `spawn-log "$parent" "$caste" "$child" "$task"` calls
       - Change to `spawn-log "$parent" "$caste" "$child" "$task" "$model"`
       - Model should be determined from `model-profile get $caste` or passed from caller

    4. Update activity-log entries to include model:
       When logging spawn events, include model in the message:
       ```bash
       activity-log "SPAWN" "$parent" "$child ($caste): $task [model: $model]"
       ```

    5. Update spawn-tree display function to show model column:
       Modify the visualization to include model information in the output.

    Ensure backward compatibility: if model parameter not provided, use "default".
  </action>
  <verify>grep -n "spawn-log" .aether/aether-utils.sh | head -20</verify>
  <done>spawn-log function accepts model parameter and records it</done>
</task>

<task type="auto">
  <name>Create spawn-logger.js library for programmatic logging</name>
  <files>bin/lib/spawn-logger.js</files>
  <action>
    Create bin/lib/spawn-logger.js for programmatic spawn logging:

    ```javascript
    const fs = require('fs');
    const path = require('path');
    const { logActivity } = require('./logger');

    /**
     * Log a worker spawn event with model information
     * @param {string} repoPath - Repository root path
     * @param {Object} spawnInfo - Spawn details
     * @param {string} spawnInfo.parent - Parent ant name (e.g., "Queen")
     * @param {string} spawnInfo.caste - Worker caste (e.g., "builder")
     * @param {string} spawnInfo.child - Child ant name (e.g., "Builder-1")
     * @param {string} spawnInfo.task - Task description
     * @param {string} spawnInfo.model - Model used (e.g., "kimi-k2.5")
     * @param {string} spawnInfo.status - Spawn status (default: "spawned")
     * @returns {Promise<void>}
     */
    async function logSpawn(repoPath, { parent, caste, child, task, model, status = 'spawned' }) {
      const timestamp = new Date().toISOString();
      const logLine = `${timestamp}|${parent}|${caste}|${child}|${task}|${model}|${status}\n`;

      const spawnTreePath = path.join(repoPath, '.aether', 'logs', 'spawn-tree.txt');

      // Ensure logs directory exists
      const logsDir = path.dirname(spawnTreePath);
      if (!fs.existsSync(logsDir)) {
        fs.mkdirSync(logsDir, { recursive: true });
      }

      // Append to spawn tree log
      fs.appendFileSync(spawnTreePath, logLine);

      // Also log to activity log
      await logActivity('SPAWN', parent, `${child} (${caste}): ${task} [model: ${model}]`);
    }

    /**
     * Format spawn tree for display
     * @param {string} repoPath - Repository root path
     * @returns {string} Formatted tree
     */
    function formatSpawnTree(repoPath) {
      const spawnTreePath = path.join(repoPath, '.aether', 'logs', 'spawn-tree.txt');

      if (!fs.existsSync(spawnTreePath)) {
        return 'No spawn history found.';
      }

      const lines = fs.readFileSync(spawnTreePath, 'utf8').trim().split('\n');

      // Parse and format as tree
      // Group by parent, show caste emoji, model info
      // Format: Parent -> Child (caste) [model] - task

      return lines.map(line => {
        const [timestamp, parent, caste, child, task, model, status] = line.split('|');
        const casteEmoji = getCasteEmoji(caste);
        const statusEmoji = status === 'completed' ? '‚úì' : status === 'failed' ? '‚úó' : '‚óã';
        return `${statusEmoji} ${parent} ‚Üí ${casteEmoji} ${child} [${model}] - ${task}`;
      }).join('\n');
    }

    /**
     * Get emoji for caste
     */
    function getCasteEmoji(caste) {
      const emojis = {
        prime: 'üèõÔ∏è',
        builder: 'üî®',
        watcher: 'üëÅÔ∏è',
        oracle: 'üîÆ',
        scout: 'üîç',
        chaos: 'üé≤',
        architect: 'üìê',
        archaeologist: 'üè∫',
        colonizer: 'üå±',
        route_setter: 'üéØ'
      };
      return emojis[caste] || 'üêú';
    }

    module.exports = {
      logSpawn,
      formatSpawnTree,
      getCasteEmoji
    };
    ```

    Follow patterns from bin/lib/logger.js for consistency.
  </action>
  <verify>node -e "const sl = require('./bin/lib/spawn-logger'); console.log(Object.keys(sl))"</verify>
  <done>spawn-logger.js exports logSpawn, formatSpawnTree, getCasteEmoji</done>
</task>

<task type="auto">
  <name>Add spawn-log CLI command</name>
  <files>bin/cli.js</files>
  <action>
    Add a `spawn-log` command to bin/cli.js for programmatic access:

    ```javascript
    const { logSpawn, formatSpawnTree } = require('./lib/spawn-logger');

    // Spawn-log command
    program
      .command('spawn-log')
      .description('Log a worker spawn event')
      .requiredOption('-p, --parent <parent>', 'Parent ant name')
      .requiredOption('-c, --caste <caste>', 'Worker caste')
      .requiredOption('-n, --name <name>', 'Child ant name')
      .requiredOption('-t, --task <task>', 'Task description')
      .requiredOption('-m, --model <model>', 'Model used')
      .option('-s, --status <status>', 'Spawn status', 'spawned')
      .action(wrapCommand(async (options) => {
        const repoPath = process.cwd();
        await logSpawn(repoPath, {
          parent: options.parent,
          caste: options.caste,
          child: options.name,
          task: options.task,
          model: options.model,
          status: options.status
        });
        console.log(`Logged spawn: ${options.parent} ‚Üí ${options.name} (${options.caste}) [${options.model}]`);
      }));

    // Spawn-tree command (display)
    program
      .command('spawn-tree')
      .description('Display worker spawn tree with model information')
      .action(wrapCommand(async () => {
        const repoPath = process.cwd();
        const tree = formatSpawnTree(repoPath);
        console.log(tree);
      }));
    ```

    Place these commands in the CLI alongside other commands.
  </action>
  <verify>node bin/cli.js spawn-log --help</verify>
  <done>spawn-log and spawn-tree CLI commands exist</done>
</task>

</tasks>

<verification>
- `aether spawn-log --parent Queen --caste builder --name Builder-1 --task "Implement auth" --model kimi-k2.5` logs to spawn-tree.txt
- Spawn-tree.txt format includes model field: `timestamp|parent|caste|child|task|model|status`
- `aether spawn-tree` displays formatted tree with model information
- Activity log entries include model information
- Existing spawn-log calls in aether-utils.sh updated to pass model
</verification>

<success_criteria>
1. spawn-log command in aether-utils.sh accepts model parameter
2. spawn-tree.txt format updated to include model field
3. spawn-logger.js library created with logSpawn and formatSpawnTree
4. CLI commands spawn-log and spawn-tree added to bin/cli.js
5. Activity log entries include model information
6. Backward compatibility maintained (model defaults to "default")
</success_criteria>

<output>
After completion, create `.planning/phases/09-caste-model-assignment/09-04-SUMMARY.md`
</output>
