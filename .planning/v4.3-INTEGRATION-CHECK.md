# v4.3 Integration Check: Live Visibility & Auto-Learning

**Milestone:** v4.3 Live Visibility & Auto-Learning
**Phases:** 25 (Live Visibility), 26 (Auto-Learning)
**Date:** 2026-02-04

---

## Integration Check Complete

### Wiring Summary

**Connected:** 8 exports properly used across phases
**Orphaned:** 0 exports created but unused
**Missing:** 0 expected connections not found

### API Coverage (aether-utils.sh subcommands)

**Consumed:** 6/6 relevant subcommands have callers in build.md or continue.md
**Orphaned:** 0 subcommands with no callers

### Data Flow Integrity

**Intact:** 4 cross-file data flows verified
**Broken:** 0 data flows have breaks

### E2E Flows

**Complete:** 3 flows work end-to-end
**Broken:** 0 flows have breaks
**Minor Issues:** 2 display-level edge cases identified (non-blocking)

---

## Detailed Findings

### 1. Cross-Phase Wiring: Phase 25 -> Phase 26

#### 1a. build.md Step Structure Coexistence

Phase 25 restructured build.md Steps 5a/5b/5c. Phase 26 added Steps 7a-7e. The complete step sequence in build.md is:

```
Step 1: Validate
Step 2: Read State
Step 3: Compute Active Pheromones
Step 4: Update State
Step 4.5: Git Checkpoint
Step 5a: Spawn Phase Lead as Planner   <-- Phase 25
Step 5b: Plan Checkpoint                <-- Phase 25
Step 5c: Execute Plan                   <-- Phase 25
Step 5.5: Watcher Verification
Step 6: Record Outcome                  (bridge -- unchanged by either phase)
Step 7: Extract Learnings...            <-- Phase 26 (renamed + expanded)
  Step 7a: Extract Phase Learnings
  Step 7b: Emit FEEDBACK Pheromone
  Step 7c: Clean Expired Pheromones
  Step 7d: Write Auto-Learning Flag Event
  Step 7e: Display Results
```

**Verdict: CONNECTED.** Step 6 is intact as the bridge between Phase 25's execution (Steps 5a-5c) and Phase 26's learning extraction (Steps 7a-7e). No gaps, no overlaps. The step numbering is consistent and the display checklist at Step 7e (line 601-616 of build.md) accurately reflects all steps.

**Evidence:**
- `/Users/callumcowie/repos/Aether/.claude/commands/ant/build.md` lines 137-519: Steps 5a through 6 (Phase 25 territory)
- `/Users/callumcowie/repos/Aether/.claude/commands/ant/build.md` lines 519-663: Step 7 with substeps (Phase 26 territory)

#### 1b. Worker Results Data Flow (Step 5c -> Step 7a)

Phase 25's Step 5c produces `worker_results` (line 314). Phase 26's Step 7a reads these results to synthesize learnings.

**Verification:**
- Step 5c stores results: "Store worker result (report content, success/failure, task IDs) in `worker_results`" (build.md line 314)
- Step 7a reads them: "The Queen already has in memory from prior steps: worker_results (Step 5c), watcher_report (Step 5.5), errors.json and events.json (Step 6)" (build.md line 523)
- Step 7a requires worker attribution: "Each learning MUST be attributed to the worker/caste that produced it" (build.md line 525)

**Verdict: CONNECTED.** The data flow is explicitly documented. Step 7a references Step 5c's output by name and requires caste attribution, which is only possible with Step 5c's worker_results.

#### 1c. Activity Log and Learning Flag: No File Conflicts

Phase 25 writes to:
- `.aether/data/activity.log` (via activity-log-init in Step 5c, line 237)
- `.aether/data/activity-phase-{N}.log` (archival)

Phase 26 writes to:
- `.aether/data/memory.json` (Step 7a, line 542)
- `.aether/data/events.json` (Step 7d, line 583)
- `.aether/data/pheromones.json` (Step 7b, line 553)

**Verdict: NO CONFLICT.** The phases write to entirely different files. No race conditions or overwrite risks.

#### 1d. build.md -> continue.md Handoff (auto_learnings_extracted)

**Writer (build.md Step 7d, lines 581-593):**
```json
{
  "type": "auto_learnings_extracted",
  "source": "build",
  "content": "Auto-extracted <N> learnings from Phase <id>: <name>"
}
```

**Reader (continue.md Step 4, lines 95-97):**
- Checks for `type` == `"auto_learnings_extracted"`
- Checks `content` contains `"Phase <current_phase_number>:"`

**Verdict: CONNECTED.** The content field format `"Auto-extracted <N> learnings from Phase <id>: <name>"` will match the detection pattern `"Phase <current_phase_number>:"` because the content includes the phase number followed by a colon. The event type string matches exactly between writer and reader.

### 2. Export/Import Map

| Export | Source (Phase) | Consumer | Status |
|--------|---------------|----------|--------|
| `activity-log` subcommand | Phase 25 (aether-utils.sh) | build.md Step 5c (6 call sites), all 6 worker specs | CONNECTED |
| `activity-log-init` subcommand | Phase 25 (aether-utils.sh) | build.md Step 5c line 237 | CONNECTED |
| `activity-log-read` subcommand | Phase 25 (aether-utils.sh) | build.md Step 5c line 300 | CONNECTED |
| Worker Activity Log sections | Phase 25 (6 worker specs) | Workers spawned by build.md Step 5c | CONNECTED |
| Phase Lead as planner (Step 5a) | Phase 25 (build.md) | Step 5b/5c consume plan output | CONNECTED |
| Phase Build Report (Step 5c) | Phase 25 (build.md) | Step 5.5 watcher, Step 6, Step 7a | CONNECTED |
| Step 7a-7e learning extraction | Phase 26 (build.md) | Writes memory.json, pheromones.json, events.json | CONNECTED |
| `auto_learnings_extracted` event | Phase 26 (build.md Step 7d) | continue.md Step 4 duplicate detection | CONNECTED |

### 3. aether-utils.sh Subcommand Coverage

| Subcommand | Caller(s) | Status |
|-----------|-----------|--------|
| `activity-log` | build.md Step 5c (lines 260, 292, 296, 319), all 6 worker specs | CONSUMED |
| `activity-log-init` | build.md Step 5c (line 237) | CONSUMED |
| `activity-log-read` | build.md Step 5c (line 300) | CONSUMED |
| `memory-compress` | build.md Step 7a (line 544), continue.md Step 4 (line 137) | CONSUMED |
| `pheromone-validate` | build.md Step 7b (line 568), continue.md Step 4.5 (line 188) | CONSUMED |
| `pheromone-cleanup` | build.md Step 7c (line 579), continue.md Step 5 (line 228) | CONSUMED |

### 4. Spawn Outcomes Double-Count Guard

Phase 25's restructured Step 6 writes spawn_outcomes (build.md lines 511-517). Phase 26's Step 7a explicitly says "spawn_outcomes already updated in Step 6 -- do NOT update them here" (build.md line 549).

**Verdict: SAFE.** Phase 26 includes an explicit guard against double-counting.

### 5. E2E Flow Verification

#### Flow 1: Full Build Flow

```
/ant:build N
  -> Step 1-4.5: Validate, read state, compute pheromones, update state, git checkpoint
  -> Step 5a: Phase Lead produces plan (planning-only, no Task tool, no spawning)
  -> Step 5b: User confirms plan (max 3 iterations)
  -> Step 5c: Queen spawns workers sequentially
     -> activity-log-init (archives old log)
     -> For each wave, for each worker:
        -> activity-log START
        -> Read worker spec (includes Activity Log section from Phase 25)
        -> Task tool spawn
        -> activity-log COMPLETE/ERROR
        -> activity-log-read for this caste
        -> Store in worker_results
  -> Step 5.5: Watcher verification (reads Phase Build Report)
  -> Step 6: Record outcome (errors, events, spawn_outcomes)
  -> Step 7a: Extract learnings to memory.json (reads worker_results)
  -> Step 7b: Emit FEEDBACK pheromone (validated, logged)
  -> Step 7c: Clean expired pheromones
  -> Step 7d: Write auto_learnings_extracted event
  -> Step 7e: Display results (all sections have data sources)
```

**Verdict: COMPLETE.** Every step has its inputs available from prior steps. No missing data, no broken handoffs.

#### Flow 2: Build-then-Continue (Auto-Extraction Skip)

```
/ant:build N completes
  -> Step 7d writes: {"type": "auto_learnings_extracted", "content": "...Phase N:..."}

/ant:continue
  -> Step 1: Reads events.json (has auto_learnings_extracted event)
  -> Step 4: Duplicate detection finds matching event
     -> Outputs skip message with timestamp
     -> Skips Steps 4 and 4.5
  -> Step 5: Pheromone cleanup runs normally
  -> Step 6: Writes learnings_extracted + phase_advanced events
  -> Step 7: Updates colony state
  -> Step 8: Displays result
```

**Verdict: COMPLETE.** The flag event written by build.md is correctly detected by continue.md. The skip cascade (Step 4 + Step 4.5) is explicitly documented.

#### Flow 3: Interrupted Build (No Auto-Extraction)

```
/ant:build N fails or is interrupted before Step 7d
  -> No auto_learnings_extracted event written

/ant:continue
  -> Step 1: Reads events.json (no auto_learnings_extracted for this phase)
  -> Step 4: No matching event found -> proceeds with extraction
  -> Step 4: Extracts learnings from available data (tasks, errors, events)
  -> Step 4.5: Emits FEEDBACK pheromone (source: "auto:continue")
  -> Steps 5-8: Continue normally
```

**Verdict: COMPLETE.** When build does not reach Step 7d, the flag event is absent. continue.md correctly falls through to its own extraction logic. The `--force` override is also available as a safety valve.

### 6. Minor Issues (Non-Blocking)

#### Issue 1: continue.md Step 6 writes `learnings_extracted` event unconditionally

**Location:** `/Users/callumcowie/repos/Aether/.claude/commands/ant/continue.md` lines 237-244
**Severity:** Low (data hygiene)
**Description:** When Step 4 is skipped (auto-extraction detected), Step 6 still writes a `learnings_extracted` event with content `"Extracted <N> learnings from Phase <id>: <name>"`. This is slightly misleading because continue.md did not actually extract any learnings -- it skipped extraction. The `phase_advanced` event (lines 247-254) is always correct regardless.
**Impact:** The `learnings_extracted` event type from continue.md (`"learnings_extracted"`) is distinct from the build.md event type (`"auto_learnings_extracted"`), so the duplicate detection logic is not affected. This is purely a data accuracy concern -- an event claims extraction happened when it was skipped.
**Recommendation:** Consider guarding the `learnings_extracted` event write with a conditional based on whether Step 4 actually ran. Low priority.

#### Issue 2: continue.md Step 8 display template lacks skip-case rendering

**Location:** `/Users/callumcowie/repos/Aether/.claude/commands/ant/continue.md` lines 305-312
**Severity:** Low (display cosmetics)
**Description:** The Step 8 display template shows "Learnings Extracted:" and "Auto-Emitted Pheromones:" unconditionally. When Step 4 was skipped, there are no learnings to display and no pheromones were emitted by continue.md. The LLM executor would likely render this contextually (e.g., showing the skip message instead), but the template does not provide explicit guidance for the skip case.
**Impact:** No functional impact. The LLM executor has sufficient context from Step 4's skip message to adjust the display.
**Recommendation:** Consider adding a conditional note in the template like `{if Step 4 was skipped: "Learnings: auto-extracted during build (see /ant:build output)"}`. Low priority.

---

## Pheromone Source Attribution

Both build.md and continue.md emit pheromones with distinct `source` fields:

| Command | Source | When |
|---------|--------|------|
| build.md Step 7b | `"auto:build"` | Always after build completes |
| continue.md Step 4.5 | `"auto:continue"` | Only if build did NOT auto-extract |

This means in the normal flow (build succeeds fully), only `auto:build` pheromones are emitted. In the interrupted flow, `auto:continue` pheromones are emitted. No duplicate pheromone emission occurs.

---

## Summary

v4.3 integration is solid. Both phases modified build.md in non-overlapping regions (Phase 25: Steps 5a-5c, Phase 26: Step 7 substeps) with Step 6 serving as an unchanged bridge. The cross-command handoff via `auto_learnings_extracted` event is correctly wired: build.md writes it (Step 7d), continue.md reads it (Step 4). All 3 aether-utils.sh subcommands added by Phase 25 are consumed by build.md and/or the worker specs. No orphaned exports, no missing connections, no broken flows. Two low-severity display/data-hygiene issues identified but neither affects functionality.
