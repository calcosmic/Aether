---
phase: 37-command-trim-utilities
plan: 04
type: execute
wave: 2
depends_on: [37-01, 37-02, 37-03]
files_modified:
  - runtime/aether-utils.sh
  - commands/ant/focus.md
  - commands/ant/redirect.md
  - commands/ant/feedback.md
  - commands/ant/status.md
  - commands/ant/colonize.md
autonomous: true

must_haves:
  truths:
    - "aether-utils.sh contains only essential functions"
    - "Both command directories are in sync"
    - "Total system lines approaching ~1,800 target"
  artifacts:
    - path: "runtime/aether-utils.sh"
      provides: "Minimal shell utilities"
      max_lines: 85
    - path: "commands/ant/focus.md"
      provides: "Synced focus command"
      max_lines: 50
    - path: "commands/ant/redirect.md"
      provides: "Synced redirect command"
      max_lines: 50
    - path: "commands/ant/feedback.md"
      provides: "Synced feedback command"
      max_lines: 50
    - path: "commands/ant/status.md"
      provides: "Synced status command"
      max_lines: 90
    - path: "commands/ant/colonize.md"
      provides: "Synced colonize command"
      max_lines: 165
  key_links:
    - from: "runtime/aether-utils.sh"
      to: "COLONY_STATE.json"
      via: "jq validation"
      pattern: "validate-state"
---

<objective>
Reduce aether-utils.sh from 317 lines to ~80 lines and sync command directories.

Purpose: Remove obsolete pheromone functions from Phase 36 and ensure both command directories have updated files.
Output: Minimal utility script and synchronized command directories.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-command-trim-utilities/37-CONTEXT.md
@.planning/phases/37-command-trim-utilities/37-RESEARCH.md

# Prior plan summaries (for updated command content)
@.planning/phases/37-command-trim-utilities/37-01-SUMMARY.md
@.planning/phases/37-command-trim-utilities/37-02-SUMMARY.md
@.planning/phases/37-command-trim-utilities/37-03-SUMMARY.md

# Source file to reduce
@runtime/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce aether-utils.sh to ~80 lines</name>
  <files>runtime/aether-utils.sh</files>
  <action>
Rewrite aether-utils.sh keeping only essential functions:

```bash
#!/bin/bash
# Aether Colony Utilities - Minimal Edition
# Provides: validate-state, error-add, pheromone-validate, activity-log

set -euo pipefail

DATA_DIR=".aether/data"

# === State Validation ===

validate-state() {
  local type="${1:-colony}"
  case "$type" in
    colony)
      jq -e 'has("goal") and has("state")' "$DATA_DIR/COLONY_STATE.json" > /dev/null 2>&1
      ;;
    all)
      jq -e 'has("goal") and has("state") and has("signals") and has("plan")' "$DATA_DIR/COLONY_STATE.json" > /dev/null 2>&1
      ;;
    *)
      echo "Usage: validate-state [colony|all]" >&2
      return 1
      ;;
  esac
}

# === Error Management ===

error-add() {
  local msg="$1"
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  jq --arg msg "$msg" --arg ts "$ts" \
    '.errors += [{"message": $msg, "timestamp": $ts}]' \
    "$DATA_DIR/COLONY_STATE.json" > "$DATA_DIR/COLONY_STATE.json.tmp" && \
    mv "$DATA_DIR/COLONY_STATE.json.tmp" "$DATA_DIR/COLONY_STATE.json"
}

# === Signal Validation ===

pheromone-validate() {
  local content="$1"
  local max_len="${2:-500}"
  if [ ${#content} -gt $max_len ]; then
    echo "Signal content exceeds $max_len chars" >&2
    return 1
  fi
}

# === Activity Logging ===

activity-log() {
  local action="$1"
  local ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  jq --arg action "$action" --arg ts "$ts" \
    '.events += [$ts + "|" + $action]' \
    "$DATA_DIR/COLONY_STATE.json" > "$DATA_DIR/COLONY_STATE.json.tmp" && \
    mv "$DATA_DIR/COLONY_STATE.json.tmp" "$DATA_DIR/COLONY_STATE.json"
}

# === Help ===

show-help() {
  cat << 'EOF'
Aether Utilities:
  validate-state [colony|all]  - Check state file structure
  error-add <message>          - Add error to state
  pheromone-validate <content> - Check signal content length
  activity-log <action>        - Log activity event
EOF
}

case "${1:-}" in
  help|--help|-h) show-help ;;
esac
```

Remove these obsolete functions:
- pheromone-batch (TTL filtering now inline)
- pheromone-cleanup (filter-on-read replaces)
- pheromone-decay (TTL replaced decay)
- pheromone-effective (no strength calculation)
- memory-compress (inline or remove)
- spawn-check (Bayesian tracking removed)
- error-pattern-check (unused)
- error-summary (inline where used)
- learning-promote (defer to future phase)
- learning-inject (defer to future phase)
- activity-log-init (inline or remove)
- activity-log-read (inline or remove)
  </action>
  <verify>wc -l runtime/aether-utils.sh shows <= 85 lines</verify>
  <done>aether-utils.sh reduced to ~80 lines with only essential functions</done>
</task>

<task type="auto">
  <name>Task 2: Sync commands/ant/ with .claude/commands/ant/</name>
  <files>commands/ant/focus.md, commands/ant/redirect.md, commands/ant/feedback.md, commands/ant/status.md, commands/ant/colonize.md</files>
  <action>
Copy the updated command files from .claude/commands/ant/ to commands/ant/:

1. Copy focus.md, redirect.md, feedback.md (from Plan 01)
2. Copy status.md (from Plan 02)
3. Copy colonize.md (from Plan 03)

Use: cp .claude/commands/ant/{focus,redirect,feedback,status,colonize}.md commands/ant/

Verify both directories have matching content for these 5 files.
  </action>
  <verify>diff .claude/commands/ant/focus.md commands/ant/focus.md shows no differences (repeat for all 5 files)</verify>
  <done>Both command directories synchronized with reduced command files</done>
</task>

<task type="auto">
  <name>Task 3: Verify total system line count</name>
  <files>N/A - verification only</files>
  <action>
Count total lines across the v5.1 simplified system:

Key files to count:
- .claude/commands/ant/*.md (all command files)
- runtime/aether-utils.sh
- runtime/workers.md (from Phase 35)

Calculate total and compare to ~1,800 line target.

Report:
- Total lines before Phase 37: [number]
- Total lines after Phase 37: [number]
- Reduction achieved: [percentage]
- Target achieved: [yes/no/close]
  </action>
  <verify>wc -l on all command and runtime files, sum matches ~1,800 target</verify>
  <done>Total system lines verified against ~1,800 target</done>
</task>

</tasks>

<verification>
- [ ] aether-utils.sh <= 85 lines
- [ ] Contains: validate-state, error-add, pheromone-validate, activity-log
- [ ] Does not contain: pheromone-batch, pheromone-cleanup, decay functions
- [ ] commands/ant/ synced with .claude/commands/ant/ for 5 updated files
- [ ] Total system lines approaching ~1,800 target
- [ ] No broken references to removed utility functions
</verification>

<success_criteria>
aether-utils.sh reduced from 317 lines to ~80 lines (~75% reduction).
Both command directories synchronized.
Total system lines verified against ~1,800 target.
</success_criteria>

<output>
After completion, create `.planning/phases/37-command-trim-utilities/37-04-SUMMARY.md`
</output>
