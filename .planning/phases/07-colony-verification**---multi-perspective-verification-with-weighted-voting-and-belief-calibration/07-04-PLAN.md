---
phase: 07-colony-verification
plan: 04
type: execute
wave: 3
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - .aether/workers/watcher-ant.md
autonomous: true

must_haves:
  truths:
    - "Watcher Ant can spawn 4 specialized Watchers in parallel"
    - "Parallel spawning uses Task tool (from Phase 6 pattern)"
    - "Each spawned Watcher inherits context from parent"
    - "Watcher waits for all 4 votes before aggregating"
    - "Vote aggregation uses vote-aggregator.sh utilities"
    - "Spawned Watchers follow spawning safeguards (depth limit, circuit breaker)"
  artifacts:
    - path: ".aether/workers/watcher-ant.md"
      provides: "Base Watcher prompt with parallel spawning section"
      contains: "Spawn Parallel Verifiers section with Task tool usage"
      exports: ["spawn_verification_watchers", "aggregate_verification_votes"]
  key_links:
    - from: "watcher-ant.md"
      to: "security-watcher.md"
      via: "Task tool spawns Security Watcher specialist"
      pattern: "Task:.*Security Watcher"
    - from: "watcher-ant.md"
      to: "performance-watcher.md"
      via: "Task tool spawns Performance Watcher specialist"
      pattern: "Task:.*Performance Watcher"
    - from: "watcher-ant.md"
      to: "quality-watcher.md"
      via: "Task tool spawns Quality Watcher specialist"
      pattern: "Task:.*Quality Watcher"
    - from: "watcher-ant.md"
      to: "test-coverage-watcher.md"
      via: "Task tool spawns Test-Coverage Watcher specialist"
      pattern: "Task:.*Test-Coverage Watcher"
    - from: "watcher-ant.md"
      to: "vote-aggregator.sh"
      via: "Sources vote aggregation utilities after spawns complete"
      pattern: "source.*vote-aggregator\\.sh"
---

<objective>
Integrate parallel Watcher spawning into the base Watcher Ant prompt. This enables Watcher Ant to spawn 4 specialized Watchers (Security, Performance, Quality, Test-Coverage) in parallel using the Task tool pattern from Phase 6, then aggregate their votes using the vote-aggregator.sh utilities.

Purpose: Enable true parallel verification where 4 domain specialists work simultaneously, reducing verification latency from 4√ó sequential to parallel execution.

Output: Updated watcher-ant.md with "Spawn Parallel Verifiers" section that spawns all 4 Watchers, waits for completion, and aggregates votes.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-colony-verification**---multi-perspective-verification-with-weighted-voting-and-belief-calibration/07-CONTEXT.md
@.planning/phases/07-colony-verification**---multi-perspective-verification-with-weighted-voting-and-belief-calibration/07-RESEARCH.md
@.aether/workers/watcher-ant.md
@.aether/workers/security-watcher.md
@.aether/workers/performance-watcher.md
@.aether/workers/quality-watcher.md
@.aether/workers/test-coverage-watcher.md
@.aether/utils/spawn-tracker.sh
@.aether/utils/vote-aggregator.sh
@.aether/utils/issue-deduper.sh
@.aether/utils/weight-calculator.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Spawn Parallel Verifiers section to watcher-ant.md</name>
  <files>.aether/workers/watcher-ant.md</files>
  <action>
Update .aether/workers/watcher-ant.md:

**Find the existing "Spawn Parallel Verifiers" section (around line 137) and replace with complete implementation:**

Replace the placeholder table with full implementation:

```markdown
### 5. Spawn Parallel Verifiers

For critical work or phase completion, spawn 4 specialized Watcher perspectives in parallel:

| Perspective | Spawn | Purpose |
|------------|-------|---------|
| Security | Security Watcher | Vulnerabilities, auth issues, input validation |
| Performance | Performance Watcher | Complexity, bottlenecks, resource usage |
| Quality | Quality Watcher | Maintainability, readability, conventions |
| Test Coverage | Test-Coverage Watcher | Coverage, edge cases, assertions |

#### When to Spawn Parallel Verifiers

Spawn all 4 Watchers in parallel when:
- Phase completion verification is needed
- Critical security or performance concerns exist
- Queen requests comprehensive verification
- High-stakes implementation (auth, payments, data migrations)

#### How to Spawn Parallel Verifiers

**Step 1: Prepare work context**

Before spawning, prepare the work context JSON:

```bash
WORK_CONTEXT=$(jq -n \
    --arg goal "$(jq -r '.queen_intention.goal' .aether/data/COLONY_STATE.json)" \
    --arg work_description "{what_was_built}" \
    --arg acceptance_criteria "{acceptance_criteria}" \
    '{
        goal: $goal,
        work: $work_description,
        acceptance_criteria: $acceptance_criteria,
        files_affected: ["file1.ts", "file2.py"],
        timestamp: "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
    }'
)
```

**Step 2: Check resource constraints**

```bash
# Source spawn tracking functions
source .aether/utils/spawn-tracker.sh

# Check if spawn is allowed
if ! can_spawn; then
    echo "Cannot spawn verification watchers: resource constraints"
    # Fall back to single-Watcher verification
    return 1
fi
```

**Step 3: Spawn 4 Watchers in parallel using Task tool**

```bash
# Create verification output directory
mkdir -p .aether/verification/votes

# Get current timestamp for vote file naming
TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
VERIFICATION_ID="verification_${TIMESTAMP}"

# Record spawn events (4 spawns = 4 budget consumed)
spawn_id_security=$(record_spawn "watcher" "security_watcher" "Multi-perspective verification")
spawn_id_performance=$(record_spawn "watcher" "performance_watcher" "Multi-perspective verification")
spawn_id_quality=$(record_spawn "watcher" "quality_watcher" "Multi-perspective verification")
spawn_id_test=$(record_spawn "watcher" "test_coverage_watcher" "Multi-perspective verification")

# Spawn 4 Watchers in parallel (background tasks for true parallelism)
# Each Watcher returns JSON vote to .aether/verification/votes/

Task: Security Watcher <<EOF
Task: Security Watcher

## Inherited Context

### Queen's Goal
$(jq -r '.queen_intention.goal' .aether/data/COLONY_STATE.json)

### Work Context
${WORK_CONTEXT}

### Active Pheromone Signals
$(cat .aether/data/pheromones.json | jq -r '.active_pheromones')

### Working Memory (Recent Context)
$(cat .aether/data/memory.json | jq -r '.working_memory[0:5]')

## Your Task

Perform security-focused verification on the provided work context.

## Output Requirements

After verification, output your vote JSON to:
.aether/verification/votes/security_${TIMESTAMP}.json

Your vote MUST follow this format:
{
  "watcher": "security",
  "decision": "APPROVE" | "REJECT",
  "weight": <current weight from watcher_weights.json>,
  "issues": [...],
  "timestamp": "<ISO_8601_timestamp>"
}
EOF

# Repeat Task tool calls for Performance, Quality, Test-Coverage Watchers...
# (Same structure, different specialist type)

Task: Performance Watcher <<EOF
[Same structure as Security Watcher, but Performance specialist]
Output to: .aether/verification/votes/performance_${TIMESTAMP}.json
EOF

Task: Quality Watcher <<EOF
[Same structure as Security Watcher, but Quality specialist]
Output to: .aether/verification/votes/quality_${TIMESTAMP}.json
EOF

Task: Test-Coverage Watcher <<EOF
[Same structure as Security Watcher, but Test-Coverage specialist]
Output to: .aether/verification/votes/test_coverage_${TIMESTAMP}.json
EOF

# Wait for all 4 background tasks to complete
wait

# Verify all 4 vote files exist
VOTE_COUNT=$(ls -1 .aether/verification/votes/*_${TIMESTAMP}.json 2>/dev/null | wc -l)
if [ "$VOTE_COUNT" -ne 4 ]; then
    echo "ERROR: Expected 4 votes, got $VOTE_COUNT"
    # Record spawn failures
    record_outcome "$spawn_id_security" "failure" "Vote file not created"
    record_outcome "$spawn_id_performance" "failure" "Vote file not created"
    record_outcome "$spawn_id_quality" "failure" "Vote file not created"
    record_outcome "$spawn_id_test" "failure" "Vote file not created"
    return 1
fi
```

**Step 4: Aggregate votes using vote-aggregator.sh**

```bash
# Source vote aggregation utilities
source .aether/utils/vote-aggregator.sh
source .aether/utils/issue-deduper.sh

# Combine all 4 vote files into aggregated array
VOTES_FILE=".aether/verification/votes/aggregated_${TIMESTAMP}.json"
jq -s '.' .aether/verification/votes/*_${TIMESTAMP}.json > "$VOTES_FILE"

# Calculate supermajority (includes Critical veto check)
SUPERMAJORITY_RESULT=$(calculate_supermajority "$VOTES_FILE")
echo "Supermajority Result: $SUPERMAJORITY_RESULT"

# Dedupe and prioritize issues
AGGREGATED_ISSUES=$(dedupe_and_prioritize "$VOTES_FILE")
echo "$AGGREGATED_ISSUES" | jq '.' > ".aether/verification/issues/aggregated_${TIMESTAMP}.json"

# Record votes in COLONY_STATE.json (outcome = "pending" until phase completes)
for vote_file in .aether/verification/votes/*_${TIMESTAMP}.json; do
    watcher=$(jq -r '.watcher' "$vote_file")
    decision=$(jq -r '.decision' "$vote_file")
    issues=$(jq '.issues' "$vote_file")
    record_vote_outcome "$watcher" "$decision" "$issues" "$VERIFICATION_ID"
done

# Record spawn outcomes
record_outcome "$spawn_id_security" "success" "Security vote cast: $decision"
record_outcome "$spawn_id_performance" "success" "Performance vote cast: $decision"
record_outcome "$spawn_id_quality" "success" "Quality vote cast: $decision"
record_outcome "$spawn_id_test" "success" "Test-Coverage vote cast: $decision"
```

**Step 5: Output verification result**

```markdown
üêú Multi-Perspective Verification Complete

Verification ID: {VERIFICATION_ID}
Supermajority: {SUPERMAJORITY_RESULT}
Votes: 4/4 collected

Aggregated Issues:
{Critical/High/Medium/Low breakdown}

Top Issues:
1. {severity}: {description} ({watcher})
2. {severity}: {description} ({watcher})
...

Recommendation: {APPROVED if supermajority achieved, REJECTED otherwise}
```

#### Spawn Safeguards

The spawning system includes these safeguards (from Phase 6):

- **Depth limit**: Max 3 levels (prevents infinite chains)
- **Circuit breaker**: 3 failures ‚Üí 30-minute cooldown
- **Spawn budget**: Max 10 spawns per phase (4 Watchers = 4 budget)
- **Same-specialist cache**: Prevents duplicate spawns

All safeguards from spawn-tracker.sh apply to verification Watcher spawns.

#### Verification Without Parallel Spawning

If resource constraints prevent parallel spawning (can_spawn returns false):
- Fall back to single-Watcher verification (base Watcher capabilities)
- Perform standard validation without spawning specialists
- Still use vote-aggregator.sh for consistent output format

#### Example: Complete Parallel Verification Workflow

```bash
# 1. Prepare context
WORK_CONTEXT=$(jq -n '{goal: "Build authentication system", work: "Login endpoint", ...}')

# 2. Check constraints
source .aether/utils/spawn-tracker.sh
can_spawn || { echo "Cannot spawn"; return 1; }

# 3. Spawn 4 Watchers in parallel
TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
Task: Security Watcher <<EOF [...]
Task: Performance Watcher <<EOF [...]
Task: Quality Watcher <<EOF [...]
Task: Test-Coverage Watcher <<EOF [...]
wait

# 4. Aggregate votes
source .aether/utils/vote-aggregator.sh
calculate_supermajority ".aether/verification/votes/aggregated_${TIMESTAMP}.json"

# 5. Output result
echo "Verification: APPROVED"
```
```

**Key implementation details:**
1. Uses Task tool pattern from Phase 6 (context inheritance, spawn lifecycle)
2. Spawns 4 Watchers in parallel (no sequential dependencies)
3. Waits for all 4 to complete before aggregating
4. Uses vote-aggregator.sh for supermajority calculation
5. Uses issue-deduper.sh for issue aggregation
6. Records votes in COLONY_STATE.json with outcome="pending"
7. Records spawn outcomes via spawn-tracker.sh
8. Fallback to single-Watcher if can_spawn fails

**Location in watcher-ant.md:** Replace the existing "Spawn Parallel Verifiers" section (after "Workflow" section, before "Capability Gap Detection")
  </action>
  <verify>
grep -q "Spawn Parallel Verifiers" .aether/workers/watcher-ant.md
grep -q "Task: Security Watcher" .aether/workers/watcher-ant.md
grep -q "Task: Performance Watcher" .aether/workers/watcher-ant.md
grep -q "Task: Quality Watcher" .aether/workers/watcher-ant.md
grep -q "Task: Test-Coverage Watcher" .aether/workers/watcher-ant.md
grep -q "vote-aggregator.sh" .aether/workers/watcher-ant.md
grep -q "calculate_supermajority" .aether/workers/watcher-ant.md
  </verify>
  <done>watcher-ant.md has complete Spawn Parallel Verifiers section with Task tool spawning, vote aggregation, safeguards, fallback logic</done>
</task>

</tasks>

<verification>
1. Verify watcher-ant.md has complete Spawn Parallel Verifiers section:
   - When to spawn (phase completion, critical work, Queen request)
   - How to spawn (5-step process)
   - Task tool calls for all 4 Watchers
   - Vote aggregation using vote-aggregator.sh
   - Issue deduping using issue-deduper.sh
   - Spawn outcome recording
   - Fallback logic if can_spawn fails

2. Verify Task tool calls include context inheritance:
   - Queen's Goal from COLONY_STATE.json
   - Work context JSON
   - Active pheromones
   - Working memory

3. Verify vote file locations:
   - security_TIMESTAMP.json
   - performance_TIMESTAMP.json
   - quality_TIMESTAMP.json
   - test_coverage_TIMESTAMP.json

4. Verify aggregation flow:
   - Wait for all 4 spawns
   - Verify 4 vote files exist
   - Calculate supermajority
   - Dedupe issues
   - Record votes in state

5. Verify safeguards mentioned:
   - Depth limit
   - Circuit breaker
   - Spawn budget (4 spawns)
   - Same-specialist cache
</verification>

<success_criteria>
1. watcher-ant.md has complete Spawn Parallel Verifiers section
2. Includes Task tool calls for all 4 Watchers
3. Includes vote aggregation logic
4. Includes spawn safeguards
5. Includes fallback for resource constraints
6. Follows Phase 6 spawning pattern (spawn-tracker.sh, record_spawn, record_outcome)
7. Wave 3 complete, ready for Wave 4 (issue management and supermajority testing)
</success_criteria>

<output>
After completion, create `.planning/phases/07-colony-verification---multi-perspective-verification-with-weighted-voting-and-belief-calibration/07-04-SUMMARY.md` with:
- Watcher Ant updated with parallel spawning section
- 4 Watchers spawn in parallel via Task tool
- Vote aggregation integrated
- Wave 3 complete, ready for Wave 4
</output>
