---
phase: 12-colony-visualization
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - .claude/commands/ant/tunnels.md
  - .aether/utils/chamber-compare.sh
autonomous: true
must_haves:
  truths:
    - User can compare two entombed chambers side-by-side
    - Pheromone trails (decisions, learnings) shown for both chambers
    - Differences highlighted between chambers
    - Comparison includes: phases, decisions count, learnings count, duration
  artifacts:
    - path: .claude/commands/ant/tunnels.md
      provides: Enhanced tunnels command with comparison mode
      contains: ["comparison mode", "side-by-side display", "diff highlighting"]
    - path: .aether/utils/chamber-compare.sh
      provides: Chamber comparison utilities
      exports: ["chamber_compare", "chamber_diff"]
  key_links:
    - from: ant:tunnels command
      to: chamber-compare.sh
      via: "bash .aether/utils/chamber-compare.sh"
      pattern: "tunnels <chamber1> <chamber2> triggers comparison"
    - from: chamber-compare.sh
      to: .aether/chambers/
      via: manifest.json reading
      pattern: "reads manifest from each chamber directory"
---

<objective>
Implement chamber comparison feature (LIFE-07) allowing users to compare pheromone trails across two entombed colonies. Shows side-by-side diff of decisions, learnings, phases completed, and other metadata.

Purpose: Enables users to understand how colonies evolved and what knowledge was preserved across different iterations.
Output: Enhanced tunnels.md command with comparison mode and chamber-compare.sh utility script.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-colony-visualization/12-RESEARCH.md
@/Users/callumcowie/repos/Aether/.claude/commands/ant/tunnels.md
@/Users/callumcowie/repos/Aether/.aether/utils/chamber-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chamber-compare.sh utility script</name>
  <files>.aether/utils/chamber-compare.sh</files>
  <action>
Create .aether/utils/chamber-compare.sh for chamber comparison:

```bash
#!/bin/bash
# Chamber comparison utilities
# Usage: bash chamber-compare.sh <chamber_a> <chamber_b>

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CHAMBERS_DIR="${CHAMBERS_DIR:-.aether/chambers}"

# JSON output helpers
json_ok() { printf '{"ok":true,"result":%s}\n' "$1"; }
json_err() {
  local message="${2:-$1}"
  printf '{"ok":false,"error":"%s"}\n' "$message" >&2
  exit 1
}

# Load chamber manifest
load_chamber() {
  local chamber_name="$1"
  local manifest_file="$CHAMBERS_DIR/$chamber_name/manifest.json"

  if [[ ! -f "$manifest_file" ]]; then
    json_err "Chamber not found: $chamber_name"
  fi

  cat "$manifest_file"
}

# Compare two chambers
cmd="${1:-help}"
shift 2>/dev/null || true

case "$cmd" in
  help)
    cat <<'EOF'
{"ok":true,"commands":["compare","diff","stats"],"description":"Chamber comparison utilities"}
EOF
    ;;

  compare)
    chamber_a="${1:-}"
    chamber_b="${2:-}"
    [[ -z "$chamber_a" || -z "$chamber_b" ]] && json_err "Usage: compare <chamber_a> <chamber_b>"

    # Load both manifests
    manifest_a=$(load_chamber "$chamber_a")
    manifest_b=$(load_chamber "$chamber_b")

    # Extract key fields for comparison
    result=$(jq -n \
      --arg a_name "$chamber_a" \
      --arg b_name "$chamber_b" \
      --argjson a "$manifest_a" \
      --argjson b "$manifest_b" \
      '{
        chamber_a: {
          name: $a_name,
          goal: $a.goal,
          milestone: $a.milestone,
          version: $a.version,
          phases_completed: $a.phases_completed,
          total_phases: $a.total_phases,
          entombed_at: $a.entombed_at,
          decisions_count: ($a.decisions | length),
          learnings_count: ($a.learnings | length)
        },
        chamber_b: {
          name: $b_name,
          goal: $b.goal,
          milestone: $b.milestone,
          version: $b.version,
          phases_completed: $b.phases_completed,
          total_phases: $b.total_phases,
          entombed_at: $b.entombed_at,
          decisions_count: ($b.decisions | length),
          learnings_count: ($b.learnings | length)
        },
        comparison: {
          phases_diff: ($b.phases_completed - $a.phases_completed),
          decisions_diff: (($b.decisions | length) - ($a.decisions | length)),
          learnings_diff: (($b.learnings | length) - ($a.learnings | length)),
          same_milestone: ($a.milestone == $b.milestone),
          time_between: (
            (($b.entombed_at | fromdateiso8601) - ($a.entombed_at | fromdateiso8601)) / 86400 | floor
          )
        }
      }')

    json_ok "$result"
    ;;

  diff)
    chamber_a="${1:-}"
    chamber_b="${2:-}"
    [[ -z "$chamber_a" || -z "$chamber_b" ]] && json_err "Usage: diff <chamber_a> <chamber_b>"

    manifest_a=$(load_chamber "$chamber_a")
    manifest_b=$(load_chamber "$chamber_b")

    # Find decisions in B but not in A (new decisions)
    # Find learnings in B but not in A (new learnings)
    result=$(jq -n \
      --arg a_name "$chamber_a" \
      --arg b_name "$chamber_b" \
      --argjson a "$manifest_a" \
      --argjson b "$manifest_b" \
      '{
        new_decisions: [
          $b.decisions[] | select(
            .content as $content |
            $a.decisions | map(.content) | contains([$content]) | not
          )
        ],
        new_learnings: [
          $b.learnings[] | select(
            .content as $content |
            $a.learnings | map(.content) | contains([$content]) | not
          )
        ],
        preserved_decisions: [
          $a.decisions[] | select(
            .content as $content |
            $b.decisions | map(.content) | contains([$content])
          )
        ],
        preserved_learnings: [
          $a.learnings[] | select(
            .content as $content |
            $b.learnings | map(.content) | contains([$content])
          )
        ]
      }')

    json_ok "$result"
    ;;

  stats)
    chamber_a="${1:-}"
    chamber_b="${2:-}"
    [[ -z "$chamber_a" || -z "$chamber_b" ]] && json_err "Usage: stats <chamber_a> <chamber_b>"

    manifest_a=$(load_chamber "$chamber_a")
    manifest_b=$(load_chamber "$chamber_b")

    # Calculate detailed statistics
    result=$(jq -n \
      --arg a_name "$chamber_a" \
      --arg b_name "$chamber_b" \
      --argjson a "$manifest_a" \
      --argjson b "$manifest_b" \
      '{
        summary: {
          a_phases: $a.phases_completed,
          b_phases: $b.phases_completed,
          growth: "\($b.phases_completed - $a.phases_completed) phases",
          a_duration_days: null,
          b_duration_days: null
        },
        knowledge_transfer: {
          decisions_preserved: ($a.decisions | map(.content) | intersection($b.decisions | map(.content)) | length),
          decisions_new: ($b.decisions | map(.content) - ($a.decisions | map(.content)) | length),
          learnings_preserved: ($a.learnings | map(.content) | intersection($b.learnings | map(.content)) | length),
          learnings_new: ($b.learnings | map(.content) - ($a.learnings | map(.content)) | length)
        },
        evolution: {
          milestone_changed: ($a.milestone != $b.milestone),
          from_milestone: $a.milestone,
          to_milestone: $b.milestone,
          version_delta: "\($a.version) ‚Üí \($b.version)"
        }
      }')

    json_ok "$result"
    ;;

  *)
    json_err "Unknown command: $cmd. Use: compare, diff, stats"
    ;;
esac
```

Make it executable: chmod +x .aether/utils/chamber-compare.sh
  </action>
  <verify>test -x .aether/utils/chamber-compare.sh && bash .aether/utils/chamber-compare.sh help | grep -q "compare" && echo "chamber-compare.sh created"</verify>
  <done>chamber-compare.sh exists, is executable, has compare/diff/stats commands that return valid JSON</done>
</task>

<task type="auto">
  <name>Task 2: Add comparison mode to ant:tunnels command</name>
  <files>.claude/commands/ant/tunnels.md</files>
  <action>
Enhance .claude/commands/ant/tunnels.md to support comparison mode:

1. Update description:
```yaml
---
name: ant:tunnels
description: "üï≥Ô∏èüêúüï≥Ô∏è Explore tunnels (browse archived colonies, compare chambers)"
---
```

2. Add new section "### Step 5: Chamber Comparison Mode (Two Arguments)"

Insert after Step 4 (before Implementation Notes):

```markdown
### Step 5: Chamber Comparison Mode (Two Arguments)

If two arguments provided (chamber names separated by space):
- Treat as: `/ant:tunnels <chamber_a> <chamber_b>`
- Run comparison: `bash .aether/utils/chamber-compare.sh compare <chamber_a> <chamber_b>`

If either chamber not found:
```
Chamber not found: {chamber_name}

Available chambers:
{list from chamber-list}
```
Stop here.

Display comparison header:
```
üï≥Ô∏è ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   C H A M B E R   C O M P A R I S O N
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üï≥Ô∏è

üì¶ {chamber_a}  vs  üì¶ {chamber_b}
```

Display side-by-side comparison:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ {chamber_a}         ‚îÇ {chamber_b}         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üëë {goal_a}         ‚îÇ üëë {goal_b}         ‚îÇ
‚îÇ                     ‚îÇ                     ‚îÇ
‚îÇ üèÜ {milestone_a}    ‚îÇ üèÜ {milestone_b}    ‚îÇ
‚îÇ    {version_a}      ‚îÇ    {version_b}      ‚îÇ
‚îÇ                     ‚îÇ                     ‚îÇ
‚îÇ üìç {phases_a} done  ‚îÇ üìç {phases_b} done  ‚îÇ
‚îÇ    of {total_a}     ‚îÇ    of {total_b}     ‚îÇ
‚îÇ                     ‚îÇ                     ‚îÇ
‚îÇ üß† {decisions_a}    ‚îÇ üß† {decisions_b}    ‚îÇ
‚îÇ    decisions        ‚îÇ    decisions        ‚îÇ
‚îÇ                     ‚îÇ                     ‚îÇ
‚îÇ üí° {learnings_a}    ‚îÇ üí° {learnings_b}    ‚îÇ
‚îÇ    learnings        ‚îÇ    learnings        ‚îÇ
‚îÇ                     ‚îÇ                     ‚îÇ
‚îÇ üìÖ {date_a}         ‚îÇ üìÖ {date_b}         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Display growth metrics:
```
üìà Growth Between Chambers:
   Phases: +{phases_diff} ({phases_a} ‚Üí {phases_b})
   Decisions: +{decisions_diff} new
   Learnings: +{learnings_diff} new
   Time: {time_between} days apart
```

If phases_diff > 0: show "üìà Colony grew"
If phases_diff < 0: show "üìâ Colony reduced (unusual)"
If same_milestone: show "üèÜ Same milestone reached"
If milestone changed: show "üèÜ Milestone advanced: {milestone_a} ‚Üí {milestone_b}"

Display pheromone trail diff (new decisions/learnings in B):
```bash
bash .aether/utils/chamber-compare.sh diff <chamber_a> <chamber_b>
```

Parse result and show:
```
üß† New Decisions in {chamber_b}:
   {N} new architectural decisions
   {if N <= 5, list them; else show first 3 + "...and {N-3} more"}

üí° New Learnings in {chamber_b}:
   {N} new validated learnings
   {if N <= 5, list them; else show first 3 + "...and {N-3} more"}
```

Display knowledge preservation:
```
üìö Knowledge Preservation:
   {preserved_decisions} decisions carried forward
   {preserved_learnings} learnings carried forward
```

Footer:
```
Run /ant:tunnels to see all chambers
Run /ant:tunnels <chamber> to view single chamber details
```

Stop here.
```

3. Update the argument handling logic at the top:
```markdown
### Argument Handling

- No arguments: Show chamber list (Step 4)
- One argument: Show single chamber detail (Step 3)
- Two arguments: Compare two chambers (Step 5)
- More than two: "Too many arguments. Use: /ant:tunnels [chamber1] [chamber2]"
```

This enables users to run `/ant:tunnels chamber-a chamber-b` to see side-by-side comparison.
  </action>
  <verify>grep -q "Chamber Comparison Mode" .claude/commands/ant/tunnels.md && grep -q "chamber-compare.sh" .claude/commands/ant/tunnels.md && echo "Comparison mode added"</verify>
  <done>tunnels.md has Chamber Comparison Mode section with side-by-side display, growth metrics, pheromone diff, and knowledge preservation stats</done>
</task>

</tasks>

<verification>
1. Test chamber-compare.sh help: `bash .aether/utils/chamber-compare.sh help`
2. Verify tunnels.md has comparison: `grep -A5 "Two Arguments" .claude/commands/ant/tunnels.md`
3. Check side-by-side table format in tunnels.md: `grep -A20 "side-by-side" .claude/commands/ant/tunnels.md`
</verification>

<success_criteria>
- chamber-compare.sh exists with compare, diff, and stats commands
- All commands return valid JSON with chamber metadata
- tunnels.md supports two-argument comparison mode
- Side-by-side comparison table displays all key metrics
- Growth metrics calculated and displayed (phases, decisions, learnings, time)
- Pheromone trail diff shows new decisions/learnings
- Knowledge preservation stats displayed
</success_criteria>

<output>
After completion, create `.planning/phases/12-colony-visualization/12-04-SUMMARY.md`
</output>
