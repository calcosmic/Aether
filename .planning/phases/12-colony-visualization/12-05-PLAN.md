---
phase: 12-colony-visualization
plan: 05
type: execute
wave: 3
depends_on: ["12-02", "12-03"]
files_modified:
  - .aether/aether-utils.sh
  - .aether/utils/swarm-display.sh
  - .aether/utils/watch-spawn-tree.sh
  - .aether/data/view-state.json
autonomous: true
must_haves:
  truths:
    - Tunnel view (spawn tree) supports expand/collapse for nested agents
    - Progress bars show live excavation status for long operations
    - View state persists across sessions
    - Deep nesting (depth 3+) collapsed by default
  artifacts:
    - path: .aether/aether-utils.sh
      provides: View state management commands
      contains: ["view-state-init", "view-state-get", "view-state-set", "view-state-toggle"]
    - path: .aether/utils/swarm-display.sh
      provides: Enhanced display with progress bars
      contains: ["progress bar rendering", "excavation animation"]
    - path: .aether/utils/watch-spawn-tree.sh
      provides: Collapsible tree view
      contains: ["expand/collapse state", "depth-based collapsing"]
    - path: .aether/data/view-state.json
      provides: Persistent view state
      contains: ["expanded_items", "collapsed_items", "default_depth"]
  key_links:
    - from: aether-utils.sh
      to: .aether/data/view-state.json
      via: view-state-* commands
      pattern: "view-state-init creates view-state.json"
    - from: watch-spawn-tree.sh
      to: .aether/data/view-state.json
      via: read/write view state
      pattern: "jq '.tunnel_view.expanded' view-state.json"
    - from: swarm-display.sh
      to: .aether/data/swarm-display.json
      via: progress field in JSON
      pattern: "jq '.active_ants[].progress'"
---

<objective>
Add polish features: collapsible tunnel views for nested agent spawns (VIZ-02) and live excavation progress bars (VIZ-08). These features enhance the visualization experience with interactive controls and real-time progress indication.

Purpose: Completes the remaining visualization requirements with interactive features that make the display more usable for complex colonies with deep spawn hierarchies.
Output: Enhanced display scripts with collapsible views, progress bars, and view state persistence.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-colony-visualization/12-RESEARCH.md
@/Users/callumcowie/repos/Aether/.aether/utils/watch-spawn-tree.sh
@/Users/callumcowie/repos/Aether/.aether/utils/swarm-display.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add view state management utilities to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add view state management commands to aether-utils.sh:

1. `view-state-init`
   - Create .aether/data/view-state.json if doesn't exist
   - Initialize with default structure:
   ```json
   {
     "version": "1.0",
     "swarm_display": {
       "expanded": [],
       "collapsed": [],
       "default_expand_depth": 2
     },
     "tunnel_view": {
       "expanded": [],
       "collapsed": ["__depth_3_plus__"],
       "default_expand_depth": 2,
       "show_completed": true
     }
   }
   ```
   - Use atomic_write

2. `view-state-get <view_name> [key]`
   - Read view-state.json
   - Return specific view (swarm_display or tunnel_view) or specific key
   - If view_name missing, return entire state
   - Return JSON

3. `view-state-set <view_name> <key> <value>`
   - Update specific key in specific view
   - Handle array values (expanded/collapsed)
   - Use atomic_write
   - Return JSON with updated state

4. `view-state-toggle <view_name> <item>`
   - Toggle item between expanded and collapsed
   - If item in expanded, move to collapsed (and vice versa)
   - Return new state of item

5. `view-state-expand <view_name> <item>`
   - Add item to expanded list, remove from collapsed
   - Return JSON ok

6. `view-state-collapse <view_name> <item>`
   - Add item to collapsed list, remove from expanded
   - Return JSON ok

These utilities support VIZ-02 (collapsible tunnel view) by providing persistent state management.

Add to help command list.
  </action>
  <verify>bash .aether/aether-utils.sh help | grep -q "view-state" && echo "View state commands added"</verify>
  <done>aether-utils.sh has view-state-init, view-state-get, view-state-set, view-state-toggle, view-state-expand, view-state-collapse commands</done>
</task>

<task type="auto">
  <name>Task 2: Enhance watch-spawn-tree.sh with collapsible views</name>
  <files>.aether/utils/watch-spawn-tree.sh</files>
  <action>
Enhance .aether/utils/watch-spawn-tree.sh to support collapsible views:

1. Add view state integration at the top:
```bash
# View state file
VIEW_STATE_FILE="$DATA_DIR/view-state.json"

# Load view state
load_view_state() {
  if [[ -f "$VIEW_STATE_FILE" ]]; then
    cat "$VIEW_STATE_FILE" 2>/dev/null || echo '{}'
  else
    echo '{"tunnel_view":{"expanded":[],"collapsed":["__depth_3_plus__"],"default_expand_depth":2,"show_completed":true}}'
  fi
}

# Check if item is expanded
is_expanded() {
  local item="$1"
  local depth="${2:-1}"
  local view_state=$(load_view_state)

  # Check if explicitly expanded
  if echo "$view_state" | jq -e ".tunnel_view.expanded | contains([\"$item\"])" >/dev/null 2>&1; then
    return 0
  fi

  # Check if depth-based auto-collapse applies
  local default_depth=$(echo "$view_state" | jq -r '.tunnel_view.default_expand_depth // 2')
  if [[ "$depth" -gt "$default_depth" ]]; then
    # Check if __depth_3_plus__ is in collapsed (indicating auto-collapse enabled)
    if echo "$view_state" | jq -e '.tunnel_view.collapsed | contains(["__depth_3_plus__"])' >/dev/null 2>&1; then
      return 1  # Collapsed by depth
    fi
  fi

  # Check if explicitly collapsed
  if echo "$view_state" | jq -e ".tunnel_view.collapsed | contains([\"$item\"])" >/dev/null 2>&1; then
    return 1
  fi

  return 0  # Default to expanded
}
```

2. Modify render_worker function to respect collapsed state:
```bash
render_worker() {
  local name="$1"
  local indent="$2"
  local depth="$3"
  local is_last="$4"

  [[ " ${printed[*]} " =~ " $name " ]] && return
  printed+=("$name")

  emoji=$(get_emoji "${worker_caste[$name]}")
  status="${worker_status[$name]}"
  color=$(get_status_color "$status")
  task="${worker_task[$name]}"

  # Check if collapsed
  local collapsed=false
  local child_count=0

  # Count children
  for child in "${!workers[@]}"; do
    if [[ "${workers[$child]}" == "$name" ]]; then
      child_count=$((child_count + 1))
    fi
  done

  # Check collapse state (only if has children)
  if [[ $child_count -gt 0 ]] && ! is_expanded "$name" "$depth"; then
    collapsed=true
  fi

  # Truncate task for display
  [[ ${#task} -gt 30 ]] && task="${task:0:27}..."

  # Tree connectors
  if [[ "$is_last" == "true" ]]; then
    connector="‚îî‚îÄ‚îÄ"
  else
    connector="‚îú‚îÄ‚îÄ"
  fi

  # Show expand/collapse indicator
  local expand_indicator=""
  if [[ $child_count -gt 0 ]]; then
    if [[ "$collapsed" == "true" ]]; then
      expand_indicator="‚ñ∂ [$child_count hidden] "
    else
      expand_indicator="‚ñº "
    fi
  fi

  echo -e "${indent}${DIM}${connector}${RESET} ${emoji} ${color}${name}${RESET}: ${expand_indicator}${task} ${DIM}[depth $depth]${RESET}"

  # Render children if not collapsed
  if [[ "$collapsed" != "true" ]]; then
    local children=()
    for child in "${!workers[@]}"; do
      if [[ "${workers[$child]}" == "$name" ]]; then
        children+=("$child")
      fi
    done

    local child_count=${#children[@]}
    local child_idx=0
    for child in "${children[@]}"; do
      child_idx=$((child_idx + 1))
      local child_is_last="false"
      [[ $child_idx -eq $child_count ]] && child_is_last="true"

      local child_indent="${indent}    "
      if [[ "$is_last" != "true" ]]; then
        child_indent="${indent}${DIM}‚îÇ${RESET}   "
      fi

      render_worker "$child" "$child_indent" $((depth + 1)) "$child_is_last"
    done
  fi
}
```

3. Add keyboard shortcut hints in footer:
```bash
# In render_tree, after summary:
echo ""
echo -e "${DIM}Controls: e+<name> to expand, c+<name> to collapse${RESET}"
```

4. Update header to mention collapsible view:
```bash
cat << 'EOF'
       .-.
      (o o)  AETHER COLONY
      | O |  Spawn Tree (Collapsible)
       `-`
EOF
```

This implements VIZ-02 (collapsible tunnel view) with depth-based auto-collapse.
  </action>
  <verify>grep -q "is_expanded" .aether/utils/watch-spawn-tree.sh && grep -q "‚ñ∂ \[.* hidden\]" .aether/utils/watch-spawn-tree.sh && echo "Collapsible view added"</verify>
  <done>watch-spawn-tree.sh has is_expanded function, expand/collapse indicators (‚ñ∂/‚ñº), depth-based auto-collapse, and child count display</done>
</task>

<task type="auto">
  <name>Task 3: Add progress bars and excavation animation to swarm-display.sh</name>
  <files>.aether/utils/swarm-display.sh</files>
  <action>
Enhance .aether/utils/swarm-display.sh with progress bars and excavation animation (VIZ-08):

1. Add progress bar rendering function:
```bash
# Render progress bar
render_progress_bar() {
  local percent="${1:-0}"
  local width="${2:-20}"

  # Clamp percent to 0-100
  [[ "$percent" -lt 0 ]] && percent=0
  [[ "$percent" -gt 100 ]] && percent=100

  local filled=$((percent * width / 100))
  local empty=$((width - filled))

  local bar=""
  for ((i=0; i<filled; i++)); do bar+="‚ñà"; done
  for ((i=0; i<empty; i++)); do bar+="‚ñë"; done

  echo "[$bar] $percent%"
}

# Get animated spinner
get_spinner() {
  local spinners=("‚†ã" "‚†ô" "‚†π" "‚†∏" "‚†º" "‚†¥" "‚†¶" "‚†ß" "‚†á" "‚†è")
  local idx=$(($(date +%s) % 10))
  echo "${spinners[$idx]}"
}
```

2. Modify ant rendering to include progress:
```bash
# In render_swarm, when rendering each ant:
echo "$swarm_data" | jq -r '.active_ants[] |
  "\(.name)|\(.caste)|\(.status)|\(.task // "")|\(.tools.read // 0)|\(.tools.grep // 0)|\(.tools.edit // 0)|\(.tools.bash // 0)|\(.tokens // 0)|\(.started_at // "")|\(.parent // "Queen")|\(.progress // 0)"' 2>/dev/null | \
while IFS='|' read -r name caste status task read_count grep_count edit_count bash_count tokens started_at parent progress; do
  # ... existing setup code ...

  # Show progress bar if progress > 0
  if [[ "$progress" -gt 0 ]]; then
    progress_bar=$(render_progress_bar "$progress" 15)
    echo -e "   ${DIM}${progress_bar}${RESET}"
  fi

  # Show spinner for active work
  if [[ "$status" == "excavating" ]] || [[ "$status" == "working" ]]; then
    spinner=$(get_spinner)
    echo -e "   ${DIM}${spinner} ${phrase}${RESET}"
  fi

  echo ""
done
```

3. Add excavation animation phrases based on progress:
```bash
get_excavation_phrase() {
  local caste="$1"
  local progress="${2:-0}"

  if [[ "$progress" -lt 25 ]]; then
    echo "üöß Starting excavation..."
  elif [[ "$progress" -lt 50 ]]; then
    echo "‚õèÔ∏è  Digging deeper..."
  elif [[ "$progress" -lt 75 ]]; then
    echo "ü™® Moving earth..."
  elif [[ "$progress" -lt 100 ]]; then
    echo "üèóÔ∏è  Almost there..."
  else
    echo "‚úÖ Excavation complete!"
  fi
}
```

4. Update swarm-display-update command in aether-utils.sh to accept progress parameter:
```bash
# In swarm-display-update, add optional progress parameter:
progress="${8:-0}"
# ... include in JSON update
```

This implements VIZ-08 (live excavation progress bars) with animated indicators.
  </action>
  <verify>grep -q "render_progress_bar" .aether/utils/swarm-display.sh && grep -q "get_spinner" .aether/utils/swarm-display.sh && echo "Progress bars added"</verify>
  <done>swarm-display.sh has render_progress_bar function, get_spinner for animation, progress display in ant rendering, and excavation phrases based on progress percentage</done>
</task>

</tasks>

<verification>
1. Test view state commands: `bash .aether/aether-utils.sh view-state-init && cat .aether/data/view-state.json`
2. Test collapsible view: `bash .aether/utils/watch-spawn-tree.sh` (check for ‚ñ∂/‚ñº indicators)
3. Test progress bar: Add progress field to swarm-display.json and verify rendering
4. Check integration: Ensure swarm-display.sh reads progress from JSON
</verification>

<success_criteria>
- aether-utils.sh has view-state-* commands for managing collapsed/expanded state
- view-state.json created with default structure including tunnel_view settings
- watch-spawn-tree.sh shows expand/collapse indicators (‚ñ∂/‚ñº)
- Depth 3+ items auto-collapsed by default
- swarm-display.sh renders progress bars for ants with progress > 0
- Animated spinner shown for active excavations
- All changes use atomic writes and return valid JSON
</success_criteria>

<output>
After completion, create `.planning/phases/12-colony-visualization/12-05-SUMMARY.md`
</output>
