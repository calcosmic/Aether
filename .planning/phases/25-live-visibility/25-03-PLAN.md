---
phase: 25-live-visibility
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "Phase Lead produces a task assignment plan but does NOT spawn any workers"
    - "Queen displays the plan and asks user to confirm before executing"
    - "Queen spawns workers sequentially, displaying condensed results after each worker returns"
    - "Activity log is cleared at phase start via activity-log-init"
    - "Progress bar updates after each worker completes"
    - "Wave boundaries are visually displayed"
    - "Failed workers are retried up to 2 times with failure context"
    - "Watcher still runs after all workers complete"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Restructured build flow with Steps 5a, 5b, 5c"
      contains: "Step 5a"
  key_links:
    - from: ".claude/commands/ant/build.md Step 5a"
      to: "Phase Lead"
      via: "Task tool spawn"
      pattern: "MUST NOT use the Task tool.*MUST NOT spawn"
    - from: ".claude/commands/ant/build.md Step 5b"
      to: "user"
      via: "plan display and confirmation prompt"
      pattern: "Proceed with this plan"
    - from: ".claude/commands/ant/build.md Step 5c"
      to: "aether-utils.sh activity-log"
      via: "bash command calls"
      pattern: "activity-log"
    - from: ".claude/commands/ant/build.md Step 5c"
      to: "worker specs"
      via: "Task tool spawn with spec content"
      pattern: "WORKER SPEC"
---

<objective>
Restructure build.md Step 5 into three sub-steps: Phase Lead as planner only (5a), user plan checkpoint (5b), and Queen-driven sequential worker execution with activity log display (5c). Update Step 7 to reflect new flow.

Purpose: VIS-02 and VIS-03 require the Queen to spawn workers directly (not delegated to Phase Lead) and display results incrementally. This is the core architectural shift: execution control moves from depth 1 (Phase Lead) to depth 0 (Queen/build.md). The Phase Lead becomes a planner, and the Queen becomes the executor.

Output: build.md with restructured Steps 5a/5b/5c, updated Step 5.5 (Watcher receives accumulated results), and updated Step 7 display.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-live-visibility/25-RESEARCH.md
@.planning/phases/25-live-visibility/25-CONTEXT.md
@.claude/commands/ant/build.md
@.aether/aether-utils.sh
@.aether/workers/builder-ant.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Step 5 as Steps 5a, 5b, 5c</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Read the current build.md (513 lines). Replace the existing "### Step 5: Spawn Phase Lead" section (lines ~127-271) with three new sub-steps. Keep Steps 1-4.5 and Steps 5.5-7 intact (though Steps 5.5 and 7 will be updated in Task 2).

**Step 5a: Spawn Phase Lead as Planner**

Replace the Phase Lead Task tool prompt entirely. The new prompt must:

1. Tell the Phase Lead it is a PLANNER, not an executor
2. Explicitly forbid Task tool usage and worker spawning: "You MUST NOT use the Task tool. You MUST NOT spawn any workers. Your ONLY job is to produce a task assignment plan."
3. Include the same colony context (goal, phase, tasks, pheromones, caste sensitivity table)
4. Remove all delegation protocol, spawn instructions, and HOW TO SPAWN sections
5. Specify the output format:

```
Phase Lead Task Assignment Plan
================================

Wave 1 (independent):
  1. {caste_emoji} {caste}-ant: {task description} (tasks {ids})
  2. {caste_emoji} {caste}-ant: {task description} (tasks {ids})

Wave 2 (depends on Wave 1):
  3. {caste_emoji} {caste}-ant: {task description} (tasks {ids})
     Needs: {what from Wave 1}

Worker count: {N}
Wave count: {N}
```

6. Include worker caste reference (castes and emoji, but NOT spawn mechanics):
```
Available worker castes:
  üó∫Ô∏èüêú colonizer-ant ‚Äî Explore/index codebase
  üìãüêú route-setter-ant ‚Äî Plan and break down work (rarely needed as worker)
  üî®üêú builder-ant ‚Äî Implement code, run commands
  üîçüêú scout-ant ‚Äî Research, find information
  üèõÔ∏èüêú architect-ant ‚Äî Synthesize knowledge, extract patterns
```

7. Include the visual identity block (Phase Lead emoji, visual output format)
8. Keep the header output before spawning:
```
Phase {id}: {name}

Colony is planning...
```

**Step 5b: Plan Checkpoint**

After the Phase Lead returns:

1. Display the Phase Lead's task assignment plan to the user verbatim
2. Ask: "Proceed with this plan? (yes / describe changes)"
3. If user says "yes" or equivalent: proceed to Step 5c
4. If user describes changes: Re-run the Phase Lead (Step 5a) with the user's feedback appended to the prompt as a constraint: "The user reviewed your previous plan and requested these changes: {user_feedback}. Produce a revised plan."
5. After re-run, display revised plan and ask again. Maximum 3 plan iterations before proceeding with the latest plan.

**Step 5c: Execute Plan**

This is the core execution loop. Structure it as clear sequential instructions:

1. **Initialize activity log:**
   ```
   bash .aether/aether-utils.sh activity-log-init {phase_number} "{phase_name}"
   ```

2. **Parse the plan:** Extract waves and worker assignments from the Phase Lead's plan output. Track: wave number, caste, task description, task IDs, dependencies.

3. **Initialize counters:** `completed_workers = 0`, `total_workers = {from plan}`, `worker_results = []`

4. **For each wave in the plan:**

   Display wave header:
   ```
   --- Wave {N}/{total_waves} ---
   ```

   For each worker assignment in this wave:

   a. **Announce spawn:**
      ```
      Spawning {caste_emoji} {caste}-ant for: {task_description}...
      ```

   b. **Log START:**
      ```
      bash .aether/aether-utils.sh activity-log "START" "{caste}-ant" "{task_description}"
      ```

   c. **Read worker spec:** Use Read tool to read `.aether/workers/{caste}-ant.md`

   d. **Spawn worker via Task tool** with `subagent_type="general-purpose"` and this prompt structure:
      ```
      --- WORKER SPEC ---
      {full contents of the caste's spec file}

      --- ACTIVE PHEROMONES ---
      {pheromone block from Step 3 with effective signals computed for this caste}

      --- TASK ---
      {task_description}

      Colony goal: "{goal}"
      Phase {id}: {phase_name}

      Task details:
      {for each task ID assigned to this worker, include the full task description and depends_on from PROJECT_PLAN.json}

      {if this worker has dependencies on previous workers:}
      Context from previous workers:
      {relevant results from prior workers in this phase}

      You are at depth 1.
      ```

   e. **After worker returns:**
      - Log COMPLETE (or ERROR if worker reported failure):
        ```
        bash .aether/aether-utils.sh activity-log "COMPLETE" "{caste}-ant" "{task_description}"
        ```
      - Read activity log entries for this worker:
        ```
        bash .aether/aether-utils.sh activity-log-read "{caste}-ant"
        ```
      - Increment `completed_workers`
      - Display condensed summary:
        ```
        {caste_emoji} {caste}-ant: {task_description}
          Result: {COMPLETE or ERROR}
          Files: {count of created/modified from worker report}
          {if error: brief error description}

          {progress_bar} {completed_workers}/{total_workers} workers complete
        ```
        Where progress bar: `filled = round(completed / total * 20)`, use filled characters and empty characters, total width 20.

      - Store worker result (report content, success/failure, task IDs) in `worker_results` for use by subsequent workers and Step 5.5.

   f. **If worker failed and retry count < 2:**
      - Log retry:
        ```
        bash .aether/aether-utils.sh activity-log "ERROR" "{caste}-ant" "retry {N}: {error_summary}"
        ```
      - Spawn a NEW worker (same caste, same task) with failure context appended:
        ```
        Previous attempt failed because: {error_description}. Try a different approach.
        ```
      - Increment retry counter for this task

   g. **If worker failed and retry count >= 2:**
      - Display: "Task failed after 2 retries. Continuing with remaining tasks."
      - Mark task as failed in tracking
      - Continue to next worker

5. After all waves complete, compile a "Phase Build Report" from all `worker_results`. This replaces what was previously the Phase Lead's delegation log. Format:
   ```
   Phase Build Report
   ==================

   Workers spawned: {total}
   Completed: {success_count}
   Failed: {fail_count}

   Per-worker results:
   {for each worker: caste, task, result, files created/modified}

   Files Modified:
     Created: {combined list}
     Modified: {combined list}

   Issues: {any failures or errors}
   ```

**Prompt length management:** The new Step 5 content is longer than the old version. To compensate:
- Remove the old "--- DELEGATION PROTOCOL (MANDATORY) ---" section (no longer needed -- Phase Lead doesn't delegate)
- Remove the old "--- HOW TO SPAWN ---" section from the Phase Lead prompt (moved to Queen level)
- Keep the Phase Lead prompt concise (planning instructions only, ~60 lines vs current ~140 lines)
- Keep the execution loop instructions as a clear template, not verbose prose

Target: build.md should stay under 700 lines total (currently 513, budget ~180 new lines net).
  </action>
  <verify>
1. Read the updated build.md and confirm:
   - Step 5a exists with Phase Lead as planner (no Task tool, no spawn instructions)
   - Step 5b exists with plan checkpoint and user confirmation
   - Step 5c exists with sequential worker execution loop
   - Phase Lead prompt contains "MUST NOT use the Task tool" and "MUST NOT spawn"
   - Step 5c references `activity-log-init`, `activity-log`, `activity-log-read` subcommands
   - Progress bar formula is documented
   - Retry logic with max 2 retries is documented
   - Wave boundary display is documented

2. Confirm old Step 5 content is fully replaced (no remnants of delegation protocol or spawn instructions in Phase Lead prompt)

3. Count total lines: `wc -l .claude/commands/ant/build.md` -- should be under 700
  </verify>
  <done>
Step 5 is replaced by 5a (Phase Lead planner), 5b (user checkpoint), and 5c (Queen execution loop with activity log integration, progress bars, wave boundaries, and retry logic). Phase Lead prompt has zero spawn/delegation mechanics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Steps 5.5 and 7 for new flow</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
**Update Step 5.5 (Watcher Verification):**

The current Step 5.5 passes "the full report returned by the Phase Lead ant from Step 5" to the Watcher. Replace this reference:

Change:
```
--- PHASE LEAD REPORT ---
{the full report returned by the Phase Lead ant from Step 5}
```

To:
```
--- PHASE BUILD REPORT ---
{the Phase Build Report compiled at the end of Step 5c, containing all worker results}
```

Also update the watcher task description: change "Read the files that were modified during this phase (identified in the Phase Lead report)" to "Read the files that were modified during this phase (identified in the Phase Build Report)".

The rest of Step 5.5 remains unchanged (watcher spec, pheromones, success criteria, quality scoring).

**Update Step 7 (Display Results):**

The current Step 7 display includes:

```
Colony Activity:
  {Phase Lead's delegation log}
```

Replace with:

```
Colony Activity:
  {Per-worker results from Step 5c -- for each worker: caste, task, result}
  Activity Log: .aether/data/activity.log ({line_count} entries)
```

Update the step progress checklist to reflect new step names:
```
  Step 1: Validate
  Step 2: Read State
  Step 3: Compute Active Pheromones
  Step 4: Update State
  Step 4.5: Git Checkpoint
  Step 5a: Phase Lead Planning
  Step 5b: Plan Checkpoint
  Step 5c: Execute Workers
  Step 5.5: Watcher Verification
  Step 6: Record Outcome
  Step 7: Display Results
```

Remove the "/ant:continue" warning at the bottom of Step 7 display. It currently says:
```
IMPORTANT: Run /ant:continue to extract learnings before building the next phase.
Skipping /ant:continue means phase learnings are lost and the feedback loop breaks.
```

This will be addressed in Phase 26 (auto-learning). For now, keep it as-is -- Phase 26 will modify it. Actually, do NOT remove this warning. Leave it unchanged for Phase 26 to handle.

**Update the header output** in Step 5 area. The current header:
```
+=====================================================+
|  AETHER COLONY :: BUILD                              |
+=====================================================+
```
Keep this header, but move it to display BEFORE Step 5a (it's currently inside the Phase Lead prompt, which is wrong -- it should be displayed by the Queen before spawning the Phase Lead).

Also update Step 6 (Record Outcome). The current step references "the ant's report" (meaning the Phase Lead report). Update all such references to use "the Phase Build Report from Step 5c" and "worker results". Specifically:
- "Mark tasks as completed or failed based on the ant's report" -> "Mark tasks as completed or failed based on worker results from Step 5c"
- "Record Spawn Outcomes" section: update to track each worker spawned during Step 5c, not just castes mentioned in a Phase Lead report. The Queen has explicit knowledge of which castes were spawned (it did the spawning), so this is now deterministic, not parsed from a report.
  </action>
  <verify>
1. Read the updated build.md and confirm:
   - Step 5.5 references "Phase Build Report" not "Phase Lead report"
   - Step 7 displays per-worker results and activity log reference
   - Step 7 progress checklist has updated step names (5a, 5b, 5c)
   - Step 6 references worker results from Step 5c
   - Colony header is displayed by Queen, not inside Phase Lead prompt
   - The /ant:continue warning is still present at the bottom of Step 7

2. Confirm no orphaned references to old Step 5 flow:
   ```
   grep -i "phase lead report" .claude/commands/ant/build.md
   ```
   Should return zero matches (replaced by "Phase Build Report")

3. Confirm file is well-structured and under 700 lines
  </verify>
  <done>
Steps 5.5, 6, and 7 reference the new Phase Build Report and worker results from Step 5c. Step 7 progress checklist reflects new sub-steps. Colony header displayed by Queen. Spawn outcome tracking is deterministic (Queen knows exactly which castes it spawned).
  </done>
</task>

</tasks>

<verification>
- build.md has Steps 5a, 5b, 5c replacing old Step 5
- Phase Lead prompt is planning-only (zero spawn/delegation mechanics)
- User plan checkpoint exists in Step 5b
- Worker execution loop in Step 5c uses activity log subcommands
- Progress bar, wave boundaries, retry logic all documented
- Watcher receives Phase Build Report (accumulated worker results)
- Step 7 shows per-worker results
- No references to "Phase Lead report" remain (all changed to "Phase Build Report")
- File is under 700 lines
- All existing steps (1-4.5, 6) still functional
</verification>

<success_criteria>
build.md orchestrates the full new flow: Phase Lead plans -> user confirms -> Queen spawns workers sequentially with activity log integration, progress display, and retry logic -> Watcher verifies -> results displayed. The Phase Lead never spawns workers. The user sees incremental progress.
</success_criteria>

<output>
After completion, create `.planning/phases/25-live-visibility/25-03-SUMMARY.md`
</output>
