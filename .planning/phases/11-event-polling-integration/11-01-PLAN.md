---
phase: 11-event-polling-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/builder-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/architect-ant.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Worker Ant calls get_events_for_subscriber() at execution start"
    - "Worker Ant subscribes to caste-specific event topics"
    - "Worker Ant calls mark_events_delivered() after processing events"
    - "Worker Ant receives only events matching its subscription criteria"
    - "Different Worker Ant castes subscribe to different event topics based on role"
  artifacts:
    - path: ".aether/workers/colonizer-ant.md"
      provides: "Colonizer Ant event polling section"
      contains: "Check Events"
    - path: ".aether/workers/route-setter-ant.md"
      provides: "Route-setter Ant event polling section"
      contains: "Check Events"
    - path: ".aether/workers/builder-ant.md"
      provides: "Builder Ant event polling section"
      contains: "Check Events"
    - path: ".aether/workers/watcher-ant.md"
      provides: "Watcher Ant event polling section"
      contains: "Check Events"
    - path: ".aether/workers/scout-ant.md"
      provides: "Scout Ant event polling section"
      contains: "Check Events"
    - path: ".aether/workers/architect-ant.md"
      provides: "Architect Ant event polling section"
      contains: "Check Events"
  key_links:
    - from: ".aether/workers/*.md"
      to: ".aether/utils/event-bus.sh"
      via: "source .aether/utils/event-bus.sh"
      pattern: "source.*event-bus\\.sh"
    - from: ".aether/workers/*.md"
      to: "get_events_for_subscriber()"
      via: "Event polling function call"
      pattern: "get_events_for_subscriber"
    - from: ".aether/workers/*.md"
      to: "mark_events_delivered()"
      via: "Event delivery tracking"
      pattern: "mark_events_delivered"
---

<objective>
Add event polling infrastructure to all 6 base Worker Ant caste prompts, enabling asynchronous coordination without persistent processes.

Purpose: Enable Worker Ants to detect and react to colony events by polling the event bus at execution boundaries, completing the reactive architecture begun in Phase 9.

Output: 6 updated Worker Ant prompts (colonizer, route-setter, builder, watcher, scout, architect) with "Check Events" sections that poll for caste-specific events.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-event-polling-integration/11-RESEARCH.md
@.aether/utils/event-bus.sh
@.aether/workers/colonizer-ant.md
@.aether/workers/builder-ant.md
@.aether/workers/watcher-ant.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Event Polling to Base Caste Worker Ants (6 files)</name>
  <files>.aether/workers/colonizer-ant.md, .aether/workers/route-setter-ant.md, .aether/workers/builder-ant.md, .aether/workers/scout-ant.md</files>
  <action>
For each of the 6 base caste Worker Ant files, add a "0. Check Events" section at the START of the "Your Workflow" section (before step 1).

The new section should follow this template, customized per caste:

```markdown
## Your Workflow

### 0. Check Events

Before starting work, check for colony events:

```bash
# Source event bus
source .aether/utils/event-bus.sh

# Get events for this Worker Ant
my_caste="<caste_name>"  # e.g., "colonizer", "builder", etc.
my_id="${CASTE_ID:-$(basename "$0" .md)}"
events=$(get_events_for_subscriber "$my_id" "$my_caste")

# Process events if present
if [ "$events" != "[]" ]; then
  echo "üì® Received $(echo "$events" | jq 'length') events"

  # Check for errors (high priority for all castes)
  error_count=$(echo "$events" | jq -r '[.[] | select(.topic == "error")] | length')
  if [ "$error_count" -gt 0 ]; then
    echo "‚ö†Ô∏è Errors detected - review events before proceeding"
  fi

  # Caste-specific event handling
  # (see caste-specific subscriptions below)
fi

# Always mark events as delivered
mark_events_delivered "$my_id" "$my_caste" "$events"
```

### Subscribe to Event Topics

When first initialized, subscribe to relevant event topics:

```bash
# Subscribe to caste-specific topics
subscribe_to_events "$my_id" "$my_caste" "<topic_1>" '{}'
subscribe_to_events "$my_id" "$my_caste" "<topic_2>" '{}'
```

Replace `<topic_1>`, `<topic_2>` with caste-specific topics from the list below.
```

**Caste-specific event subscriptions:**

| Caste | Primary Topics | Rationale |
|-------|---------------|-----------|
| **colonizer** | phase_complete, spawn_request, error | Responds to phase completion for new colonization, spawn requests for specialist coordination |
| **route-setter** | phase_complete, task_started, error | Tracks phase progress and task starts for route planning |
| **builder** | task_started, task_completed, error | Reacts to task events for implementation coordination |
| **watcher** | task_completed, task_failed, error, phase_complete | Monitors task outcomes and phase completion for verification |
| **scout** | spawn_request, error, phase_complete | Handles spawn requests and explores after phase completion |
| **architect** | phase_complete, task_completed, task_failed, error | Designs solutions based on phase and task outcomes |

**Important:**
- Insert the "0. Check Events" section BEFORE the existing "1. Receive Task/Signal/Work" section
- Keep all existing workflow steps, just renumber them (1‚Üí2, 2‚Üí3, etc.)
- Add caste-specific topic subscriptions based on the table above
- Each caste should subscribe to at least 2-3 topics relevant to their role
- ALL castes should subscribe to "error" topic (high priority)
  </action>
  <verify>
# Verify event polling sections were added correctly
for caste in colonizer route-setter builder watcher scout architect; do
  echo "Checking $caste-ant.md..."
  grep -q "### 0\. Check Events" ".aether/workers/$caste-ant.md" && echo "‚úì Check Events section present" || echo "‚úó Missing Check Events section"
  grep -q "get_events_for_subscriber" ".aether/workers/$caste-ant.md" && echo "‚úì get_events_for_subscriber call present" || echo "‚úó Missing get_events_for_subscriber"
  grep -q "mark_events_delivered" ".aether/workers/$caste-ant.md" && echo "‚úì mark_events_delivered call present" || echo "‚úó Missing mark_events_delivered"
  grep -q "subscribe_to_events" ".aether/workers/$caste-ant.md" && echo "‚úì subscribe_to_events call present" || echo "‚úó Missing subscribe_to_events"
  echo ""
done
  </verify>
  <done>
All 6 base caste Worker Ant prompts have "0. Check Events" section with:
- Event bus sourcing (source .aether/utils/event-bus.sh)
- Event polling call (get_events_for_subscriber)
- Event processing logic (error detection)
- Event delivery tracking (mark_events_delivered)
- Caste-specific subscriptions (subscribe_to_events with relevant topics)
  </done>
</task>

</tasks>

<verification>
1. All 6 base caste Worker Ant files have "0. Check Events" section before their first workflow step
2. Each caste subscribes to at least 2-3 event topics relevant to their role
3. All castes subscribe to "error" topic for high-priority error detection
4. Event polling logic includes error detection and caste-specific handling
5. mark_events_delivered() is called after event processing to prevent reprocessing
</verification>

<success_criteria>
1. grep "### 0\. Check Events" .aether/workers/*-ant.md returns 6 matches (one per base caste)
2. grep "get_events_for_subscriber" .aether/workers/*-ant.md returns 6 matches
3. grep "mark_events_delivered" .aether/workers/*-ant.md returns 6 matches
4. grep "subscribe_to_events" .aether/workers/*-ant.md returns at least 12 matches (2+ per caste)
5. Each caste's subscriptions match their role (e.g., watcher subscribes to task_completed, task_failed)
</success_criteria>

<output>
After completion, create `.planning/phases/11-event-polling-integration/11-01-SUMMARY.md`
</output>
