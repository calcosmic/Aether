---
phase: 11-event-polling-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/workers/security-watcher.md
  - .aether/workers/performance-watcher.md
  - .aether/workers/quality-watcher.md
  - .aether/workers/test-coverage-watcher.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Specialist Watcher calls get_events_for_subscriber() at execution start"
    - "Specialist Watcher subscribes to specialist-specific event topics"
    - "Specialist Watcher calls mark_events_delivered() after processing events"
    - "Specialist Watcher receives only events matching its subscription criteria"
    - "Different specialist Watchers subscribe to different event topics based on specialization"
  artifacts:
    - path: ".aether/workers/security-watcher.md"
      provides: "Security Watcher event polling section"
      contains: "Check Events"
    - path: ".aether/workers/performance-watcher.md"
      provides: "Performance Watcher event polling section"
      contains: "Check Events"
    - path: ".aether/workers/quality-watcher.md"
      provides: "Quality Watcher event polling section"
      contains: "Check Events"
    - path: ".aether/workers/test-coverage-watcher.md"
      provides: "Test-Coverage Watcher event polling section"
      contains: "Check Events"
  key_links:
    - from: ".aether/workers/*-watcher.md"
      to: ".aether/utils/event-bus.sh"
      via: "source .aether/utils/event-bus.sh"
      pattern: "source.*event-bus\\.sh"
    - from: ".aether/workers/*-watcher.md"
      to: "get_events_for_subscriber()"
      via: "Event polling function call"
      pattern: "get_events_for_subscriber"
    - from: ".aether/workers/*-watcher.md"
      to: "mark_events_delivered()"
      via: "Event delivery tracking"
      pattern: "mark_events_delivered"
---

<objective>
Add event polling infrastructure to all 4 specialist Watcher prompts, enabling asynchronous event-driven verification without persistent processes.

Purpose: Enable specialist Watchers to detect and react to colony events by polling the event bus, allowing them to respond to task completions, failures, and errors relevant to their specialization.

Output: 4 updated specialist Watcher prompts (security, performance, quality, test-coverage) with "Check Events" sections that poll for specialization-specific events.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-event-polling-integration/11-RESEARCH.md
@.aether/utils/event-bus.sh
@.aether/workers/security-watcher.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Event Polling to Specialist Watchers (4 files)</name>
  <files>.aether/workers/security-watcher.md, .aether/workers/performance-watcher.md, .aether/workers/quality-watcher.md, .aether/workers/test-coverage-watcher.md</files>
  <action>
For each of the 4 specialist Watcher files, add a "0. Check Events" section at the START of the "Your Workflow" section (before step 1).

The new section should follow this template, customized per specialist:

```markdown
## Your Workflow

### 0. Check Events

Before starting work, check for colony events:

```bash
# Source event bus
source .aether/utils/event-bus.sh

# Get events for this specialist Watcher
my_caste="<specialist_watcher_name>"  # e.g., "security-watcher", "performance-watcher", etc.
my_id="${CASTE_ID:-$(basename "$0" .md)}"
events=$(get_events_for_subscriber "$my_id" "$my_caste")

# Process events if present
if [ "$events" != "[]" ]; then
  echo "üì® Received $(echo "$events" | jq 'length') events"

  # Check for errors related to this specialty
  error_count=$(echo "$events" | jq -r '[.[] | select(.topic == "error")] | length')
  if [ "$error_count" -gt 0 ]; then
    echo "‚ö†Ô∏è Errors detected - review events before verification"
  fi

  # Check for task failures (high priority for verification)
  failed_count=$(echo "$events" | jq -r '[.[] | select(.topic == "task_failed")] | length')
  if [ "$failed_count" -gt 0 ]; then
    echo "‚ö†Ô∏è Task failures detected - may require deeper verification"
  fi

  # Specialist-specific event handling
  # (see specialist-specific subscriptions below)
fi

# Always mark events as delivered
mark_events_delivered "$my_id" "$my_caste" "$events"
```

### Subscribe to Event Topics

When first initialized, subscribe to relevant event topics:

```bash
# Subscribe to specialist-specific topics with filter criteria
subscribe_to_events "$my_id" "$my_caste" "task_completed" '{<filter_criteria>}'
subscribe_to_events "$my_id" "$my_caste" "task_failed" '{}'
subscribe_to_events "$my_id" "$my_caste" "error" '{"category": "<specialty>"}'
```

Replace `<filter_criteria>` and `<specialty>` with specialist-specific values from the table below.
```

**Specialist-specific event subscriptions:**

| Specialist | Primary Topics | Filter Criteria | Rationale |
|------------|---------------|-----------------|-----------|
| **security-watcher** | task_completed, task_failed, error | category: "security" | Monitors for security-related issues in completed/failed tasks |
| **performance-watcher** | task_completed, task_failed, error | category: "performance" | Monitors for performance-related issues in completed/failed tasks |
| **quality-watcher** | task_completed, task_failed, error | category: "quality" | Monitors for quality-related issues in completed/failed tasks |
| **test-coverage-watcher** | task_completed, task_failed, error | category: "testing" or missing coverage | Monitors for testing gaps and coverage issues |

**Filter criteria examples:**
- security-watcher: `{"category": "security"}` or `{"severity": "Critical"}` (for Critical severity issues)
- performance-watcher: `{"category": "performance"}` or `{"type": "performance_optimization"}`
- quality-watcher: `{"category": "quality"}` or `{"type": "code_review"}`
- test-coverage-watcher: `{"category": "testing"}` or `{"type": "coverage_check"}`

**Important:**
- Insert the "0. Check Events" section BEFORE the existing "1. Receive Work to Verify" section
- Keep all existing workflow steps, just renumber them (1‚Üí2, 2‚Üí3, etc.)
- Add specialist-specific subscriptions with filter criteria
- All specialists should subscribe to "error" topic with their specialty filter
- All specialists should subscribe to "task_failed" (high priority for verification)
  </action>
  <verify>
# Verify event polling sections were added correctly
for specialist in security performance quality test-coverage; do
  echo "Checking $specialist-watcher.md..."
  grep -q "### 0\. Check Events" ".aether/workers/$specialist-watcher.md" && echo "‚úì Check Events section present" || echo "‚úó Missing Check Events section"
  grep -q "get_events_for_subscriber" ".aether/workers/$specialist-watcher.md" && echo "‚úì get_events_for_subscriber call present" || echo "‚úó Missing get_events_for_subscriber"
  grep -q "mark_events_delivered" ".aether/workers/$specialist-watcher.md" && echo "‚úì mark_events_delivered call present" || echo "‚úó Missing mark_events_delivered"
  grep -q "subscribe_to_events" ".aether/workers/$specialist-watcher.md" && echo "‚úì subscribe_to_events call present" || echo "‚úó Missing subscribe_to_events"
  echo ""
done
  </verify>
  <done>
All 4 specialist Watcher prompts have "0. Check Events" section with:
- Event bus sourcing (source .aether/utils/event-bus.sh)
- Event polling call (get_events_for_subscriber)
- Event processing logic (error and task failure detection)
- Event delivery tracking (mark_events_delivered)
- Specialist-specific subscriptions (subscribe_to_events with filter criteria)
  </done>
</task>

</tasks>

<verification>
1. All 4 specialist Watcher files have "0. Check Events" section before their first workflow step
2. Each specialist subscribes to at least 3 event topics with filter criteria
3. All specialists subscribe to "error" topic with specialty-specific filter
4. Event polling logic includes error detection and task failure detection
5. mark_events_delivered() is called after event processing to prevent reprocessing
</verification>

<success_criteria>
1. grep "### 0\. Check Events" .aether/workers/*-watcher.md returns 4 matches (one per specialist)
2. grep "get_events_for_subscriber" .aether/workers/*-watcher.md returns 4 matches
3. grep "mark_events_delivered" .aether/workers/*-watcher.md returns 4 matches
4. grep "subscribe_to_events" .aether/workers/*-watcher.md returns at least 12 matches (3+ per specialist)
5. Each specialist's subscriptions include filter criteria relevant to their specialization
</success_criteria>

<output>
After completion, create `.planning/phases/11-event-polling-integration/11-02-SUMMARY.md`
</output>
