---
phase: 30-automation
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "After a build completes, the output includes max 3 natural language pheromone recommendations based on build outcomes"
    - "Recommendations reference specific observations from the build (not generic boilerplate)"
    - "Between-wave urgent recommendations appear when reviewer finds CRITICAL issues"
    - "At project completion (all phases done), a tech debt report is generated and displayed"
    - "Tech debt report aggregates flagged patterns, error distribution, and unresolved high-severity items"
    - "Tech debt report is both displayed in terminal and persisted to .aether/data/tech-debt-report.md"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Pheromone recommendations in Step 7e and between-wave urgent recommendations in Step 5c.i"
      contains: "Pheromone Recommendations"
    - path: ".claude/commands/ant/continue.md"
      provides: "Tech debt report generation at project completion"
      contains: "Tech Debt Report"
  key_links:
    - from: "build.md Step 7e"
      to: "worker_results + watcher_report + errors.json"
      via: "Queen synthesizes recommendations from build data"
      pattern: "Pheromone Recommendations"
    - from: "continue.md Step 2"
      to: "errors.json + activity.log + memory.json"
      via: "Aggregation of cross-phase data for tech debt"
      pattern: "TECH DEBT REPORT"
---

<objective>
Add pheromone recommendations to build output and tech debt report to project completion.

Purpose: Colony surfaces actionable guidance after builds (AUTO-03) and aggregates persistent issues at project end (INT-06). Users get proactive intelligence instead of having to interpret raw build results.

Output: Updated build.md with pheromone recommendation section in Step 7e (and between-wave urgent recs in Step 5c.i), updated continue.md with tech debt report generation in Step 2.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-automation/30-CONTEXT.md
@.planning/phases/30-automation/30-RESEARCH.md
@.planning/phases/30-automation/30-01-SUMMARY.md
@.claude/commands/ant/build.md
@.claude/commands/ant/continue.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pheromone recommendations to build output (AUTO-03)</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Add a "Pheromone Recommendations" section to build.md in TWO places:

**A. Between-wave urgent recommendations (Step 5c.i addition):**

In the reviewer logic added by Plan 01 (Step 5c.i), after the reviewer returns with CRITICAL findings AND a rebuild is triggered, add an immediate recommendation display:

```
If critical_count > 0 (regardless of rebuild iteration):
  Display:
    Recommendation: The colony detected critical issues in {area from findings}. Consider pausing after this build to investigate.
```

This is a single inline recommendation that appears immediately when urgent patterns emerge. It does NOT count toward the max-3 end-of-build recommendations.

**B. End-of-build recommendations (Step 7e addition):**

Add a new subsection to Step 7e AFTER the existing "Auto-Emitted Pheromones" display and BEFORE the "Next:" block. This subsection is titled "Pheromone Recommendations".

Instructions for the Queen to follow:

1. **Analyze build outcomes** to generate max 3 recommendations. Sources:
   - worker_results from Step 5c (which tasks succeeded/failed, error summaries)
   - watcher_report from Step 5.5 (quality score, issues found)
   - errors.json flagged_patterns (recurring cross-phase issues)
   - Per-wave reviewer findings from Step 5c.i (if reviewer ran)

2. **Trigger patterns** (recommend when these signals are detected):
   - Repeated test failures in same module -> suggest focusing colony on stabilizing that module
   - Quality score < 6 -> suggest redirect signal to avoid specific anti-pattern found
   - Multiple workers touching related files -> suggest focus on consistency in that layer
   - Clean build, high quality -> note strong patterns worth continuing
   - Flagged error patterns from errors.json -> suggest redirect to avoid recurring pattern

3. **Format constraints** (per CONTEXT.md decisions):
   - Natural language descriptive guidance, NOT copy-paste commands
   - Must reference SPECIFIC observations from THIS build
   - Must suggest a DIRECTION, not a specific action
   - Maximum 3 suggestions, force prioritization

4. **Display format:**

```
Pheromone Recommendations:
  Based on this build's outcomes:

  1. {natural language recommendation}
     Signal: {specific observation that triggered this}

  2. {natural language recommendation}
     Signal: {specific observation}

  These are suggestions, not commands. Use /ant:focus or /ant:redirect to act on them.
```

If no meaningful patterns emerge from the build data:
```
  No specific recommendations -- build was clean.
```

IMPORTANT: Recommendations must sound like a senior engineer's observations, NOT automated alerts. They must NOT start with "Run:" or "/ant:" or be formatted as commands.
  </action>
  <verify>
Read the updated build.md. Confirm:
1. Between-wave urgent recommendation exists in Step 5c.i after CRITICAL detection
2. "Pheromone Recommendations" section exists in Step 7e after "Auto-Emitted Pheromones"
3. Max 3 recommendations constraint is explicit
4. Natural language constraint is explicit (NOT commands)
5. Trigger patterns listed (test failures, low quality, file convergence, clean build, flagged patterns)
6. Display format includes "Signal:" attribution for each recommendation
7. Clean build fallback message exists
  </verify>
  <done>
Build output includes max 3 natural language pheromone recommendations referencing specific build observations, plus between-wave urgent recommendations on CRITICAL findings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tech debt report at project completion (INT-06)</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Modify continue.md Step 2 to generate a tech debt report when all phases are complete.

Currently, Step 2 detects "no next phase" and outputs:
```
All phases complete. Colony has finished the project plan.
```

Add a new Step 2.5 ("Generate Tech Debt Report") that runs ONLY when Step 2 detects all phases are complete (the "no next phase" branch). This step executes BEFORE the "All phases complete" output.

**Step 2.5: Generate Tech Debt Report (Project Completion)**

1. **Gather data** (all reads can be parallel):
   - Read `.aether/data/errors.json` (if not already in memory from Step 1)
   - Run: `bash .aether/aether-utils.sh error-summary`
   - Run: `bash .aether/aether-utils.sh error-pattern-check`
   - Read `.aether/data/memory.json` (for phase_learnings)
   - Read `.aether/data/activity.log` (for cross-phase activity patterns)

2. **Synthesize the report:**

Display:
```
TECH DEBT REPORT
================

Project: {goal from COLONY_STATE.json}
Phases Completed: {count of completed phases}
Total Build Time: {estimate from activity log timestamps -- first to last entry}

Persistent Issues:
{for each entry in errors.json flagged_patterns:}
  {category} ({count} occurrences, phases {first_seen} - {last_seen}):
    {description}

{if no flagged_patterns:}
  None -- no recurring error patterns detected.

Error Summary:
  Total: {total from error-summary}
  By Severity: Critical: {n}, High: {n}, Medium: {n}, Low: {n}
  By Category: {category}: {n}, ...

{if total == 0:}
  No errors recorded during project execution.

Unresolved High-Severity Items:
  {errors from errors.json with severity "critical" or "high" that were never followed by a corresponding fix or resolution}

{if none:}
  None -- all high-severity items were addressed.

Phase Quality Trend:
  {for each phase_learning in memory.json:}
  Phase {phase}: {phase_name} -- {errors_encountered} errors
  {extract watcher quality scores from events.json if available}

Recommendations:
  {1-3 actionable items synthesized from the patterns above}
  {e.g., "The {category} error pattern persisted across {N} phases -- consider adding automated {category} checks to your CI pipeline."}
```

3. **Persist the report:**
   Write the full report to `.aether/data/tech-debt-report.md` (both display AND file persistence per research recommendation).

4. **Then proceed** with the existing "All phases complete" output and the /ant:status / /ant:plan suggestions.

Also update the Step 2 output to mention the tech debt report:
```
All phases complete. Colony has finished the project plan.
  Tech debt report: .aether/data/tech-debt-report.md

  /ant:status   View final colony status
  /ant:plan     Generate a new plan (will replace current)
```

IMPORTANT: This step ONLY triggers when all phases are complete. It must NOT run on normal continue calls (mid-project). The conditional is: "If there is no next phase (current is the last phase)" -- the existing condition in Step 2.
  </action>
  <verify>
Read the updated continue.md. Confirm:
1. Step 2.5 exists with "Tech Debt Report" heading
2. Step 2.5 is conditional on "no next phase" (project completion only)
3. Data gathering uses error-summary, error-pattern-check, memory.json, activity.log
4. Report format includes: Persistent Issues, Error Summary, Unresolved Items, Quality Trend, Recommendations
5. Report is written to `.aether/data/tech-debt-report.md`
6. "All phases complete" message updated to reference tech-debt-report.md
7. Normal continue flow (mid-project) is NOT affected
  </verify>
  <done>
When all phases are complete, continue.md generates a comprehensive tech debt report aggregating flagged patterns, error distribution, unresolved high-severity items, and quality trends. Report is displayed in terminal and persisted to .aether/data/tech-debt-report.md.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read build.md and verify pheromone recommendations section in Step 7e
2. Read build.md and verify between-wave urgent recommendation in Step 5c.i
3. Read continue.md and verify Step 2.5 tech debt report only triggers on project completion
4. Confirm tech debt report includes all required sections (Persistent Issues, Error Summary, Unresolved Items, Quality Trend, Recommendations)
5. Confirm max 3 recommendation limit in build.md
6. Confirm tech debt report output path is .aether/data/tech-debt-report.md
</verification>

<success_criteria>
- build.md Step 7e: Pheromone recommendations section with max 3 natural language suggestions based on build data
- build.md Step 5c.i: Between-wave urgent recommendation on CRITICAL findings
- continue.md Step 2.5: Tech debt report at project completion with error aggregation, quality trends, and actionable recommendations
- Tech debt report persisted to .aether/data/tech-debt-report.md
- No changes to mid-project continue flow
</success_criteria>

<output>
After completion, create `.planning/phases/30-automation/30-02-SUMMARY.md`
</output>
