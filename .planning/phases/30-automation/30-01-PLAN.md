---
phase: 30-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "After each builder wave completes, a reviewer ant spawns in advisory mode and displays findings inline"
    - "Only CRITICAL severity findings trigger a wave rebuild (max 2 iterations per wave)"
    - "Reviewer is skipped in LIGHTWEIGHT mode and for single-worker waves"
    - "When a worker fails twice, a debugger ant spawns to diagnose and patch the failure"
    - "Debugger preserves the original worker's approach (patch, not rewrite)"
    - "If debugger cannot fix, task is marked failed and build continues"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Advisory reviewer spawn after each wave, debugger spawn on retry failure"
      contains: "ADVISORY REVIEWER"
  key_links:
    - from: "build.md Step 5c.i"
      to: "watcher-ant.md"
      via: "Task tool spawn with advisory mode override"
      pattern: "ADVISORY REVIEWER"
    - from: "build.md Step 5c.f2"
      to: "builder-ant.md"
      via: "Task tool spawn with debugger constraints"
      pattern: "DEBUGGER ANT"
---

<objective>
Add auto-spawned reviewer and debugger to build.md execution loop.

Purpose: After each builder wave, a reviewer catches issues early before they cascade. When a worker fails twice, a debugger diagnoses and patches the failure instead of giving up. This closes AUTO-01 and AUTO-02 requirements.

Output: Updated build.md with reviewer (Step 5c.i) and debugger (Step 5c.f2) integrated into the execution loop.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-automation/30-CONTEXT.md
@.planning/phases/30-automation/30-RESEARCH.md
@.claude/commands/ant/build.md
@.aether/workers/watcher-ant.md
@.aether/workers/builder-ant.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add advisory reviewer spawn after each wave (Step 5c.i)</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Insert a new Step 5c.i ("Post-Wave Advisory Review") in build.md AFTER Step 5c.h (Post-Wave Conflict Check) and BEFORE the "proceed to next wave" transition. This step runs inside the per-wave loop.

The step must include:

1. **Mode + wave-size check**: Read COLONY_STATE.json mode field. Skip reviewer entirely if mode is "LIGHTWEIGHT" OR if this wave had only 1 worker (single-worker waves have no cross-worker interaction to review). Display: "Reviewer skipped ({reason})." and continue to next wave.

2. **Reviewer spawn**: Read `.aether/workers/watcher-ant.md`. Spawn reviewer via Task tool with `subagent_type="general-purpose"`. The prompt must include:
   - Full contents of watcher-ant.md as `--- WORKER SPEC ---`
   - Active pheromones block from Step 3 as `--- ACTIVE PHEROMONES ---`
   - A `--- TASK ---` section stating:
     - "You are being spawned as a post-wave ADVISORY REVIEWER."
     - Phase id and name, wave N of total_waves
     - List of workers in this wave with their caste, task, and result summary
     - Mission: Read modified files, run Execution Verification, run Quality checks, produce findings with severity (CRITICAL, HIGH, MEDIUM, LOW)
     - EXPLICIT constraint: "You are in ADVISORY mode. Your findings will be DISPLAYED to the user but will NOT block progress. Only CRITICAL severity findings will trigger a rebuild. Be concise -- this runs after every wave."
     - Severity boundary definitions:
       - CRITICAL: Code does not run (syntax errors, import failures, launch crashes), security vulnerabilities, data corruption risk
       - HIGH: Tests fail, missing major requirements, breaking existing functionality
       - MEDIUM: Code quality issues, missing edge cases, convention violations
       - LOW: Style issues, minor improvements, documentation gaps
     - Required output structure: `findings` array of {severity, description, location, recommendation}, `critical_count` number, `summary` one-line

3. **Post-reviewer logic (Queen handles)**:
   - Parse `critical_count` from reviewer report
   - Display reviewer summary inline (plain text for now -- ANSI colors added in Plan 03)
   - If `critical_count > 0` AND `wave_rebuild_count < 2`:
     - Display: "CRITICAL issue detected. Rebuilding wave {N}..."
     - Increment wave_rebuild_count
     - Re-run this wave's workers with findings appended to their prompts: "Previous attempt had CRITICAL issues: {findings}. Fix these."
   - If `critical_count > 0` AND `wave_rebuild_count >= 2`:
     - Display: "CRITICAL issues persist after 2 rebuilds. Continuing to next wave."
   - If `critical_count == 0`:
     - Display summary and continue to next wave

4. **Activity log**: Log reviewer spawn and result:
   - `bash .aether/aether-utils.sh activity-log "SPAWN" "queen" "reviewer for wave {N}"`
   - After reviewer returns: `bash .aether/aether-utils.sh activity-log "COMPLETE" "reviewer" "{summary}"`

Also update the Step 7e step progress checklist to include "Step 5c.i: Post-Wave Review" after "Step 5c: Execute Workers".

IMPORTANT: Do NOT create a new reviewer-ant.md file. The reviewer reuses watcher-ant.md with advisory mode in the spawn prompt. Do NOT modify watcher-ant.md.
  </action>
  <verify>
Read the updated build.md. Confirm:
1. Step 5c.i exists after Step 5c.h
2. Mode check skips reviewer for LIGHTWEIGHT
3. Single-worker wave check skips reviewer
4. The reviewer spawn prompt includes "ADVISORY REVIEWER" and "ADVISORY mode"
5. Rebuild logic checks critical_count with max 2 iterations
6. Step 7e checklist updated
  </verify>
  <done>
Advisory reviewer spawns after each wave (except LIGHTWEIGHT mode and single-worker waves), displays findings inline, only CRITICAL triggers rebuild (max 2), non-critical findings are displayed but do not block.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add debugger spawn on worker retry failure (Step 5c.f2)</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify the worker retry logic in build.md Step 5c to add a debugger step between the worker's retry and the "give up" state.

Current flow (Steps 5c.f and 5c.g):
- f: Worker fails, retry count < 2 -> spawn retry
- g: Worker fails, retry count >= 2 -> "Task failed after 2 retries"

New flow:
- f: Worker fails (attempt 1), retry count < 1 -> spawn retry (UNCHANGED -- worker gets one retry attempt)
- f2: Worker retry also failed (retry count >= 1) -> spawn debugger-ant (NEW)
- g: If debugger fixed -> mark task complete; If debugger failed -> mark task failed and continue (REPLACES old g)

For Step 5c.f2, add:

1. **Log debugger spawn**:
   `bash .aether/aether-utils.sh activity-log "SPAWN" "queen" "debugger-ant for: {task_description}"`

2. **Debugger spawn**: Read `.aether/workers/builder-ant.md`. Spawn debugger via Task tool with `subagent_type="general-purpose"`. The prompt must include:
   - Full contents of builder-ant.md as `--- WORKER SPEC ---`
   - Active pheromones block from Step 3 as `--- ACTIVE PHEROMONES ---`
   - A `--- TASK ---` section stating:
     - "You are being spawned as a DEBUGGER ANT."
     - "A worker failed its task twice. Your job: diagnose the failure and fix it."
     - Failed task description, failed caste, first attempt error, second attempt error, files involved
     - Mission: Read files, DIAGNOSE root cause, identify MINIMAL patch, apply fix, run verification, report
     - EXPLICIT constraints:
       - "PATCH the existing code. Do NOT rewrite from scratch."
       - "Preserve the original worker's approach and intent."
       - "If the failure is in a test, fix the code to pass the test (not the other way around)."
       - "If you cannot diagnose the issue, report UNDIAGNOSABLE with your analysis."
     - Required output structure: `diagnosis` string, `fix_applied` boolean, `files_modified` array, `verification` pass/fail with details

3. **Post-debugger logic (Queen handles)**:
   - If debugger reports `fix_applied == true`:
     - Mark task as completed
     - Log: `bash .aether/aether-utils.sh activity-log "COMPLETE" "debugger-ant" "Fixed: {diagnosis}"`
     - Display: "Debugger fixed: {diagnosis}"
   - If debugger reports `fix_applied == false` or "UNDIAGNOSABLE":
     - Infer task criticality: if the failed task directly maps to a phase success criterion, treat as critical (display warning to user); if supporting task, skip and continue
     - Log: `bash .aether/aether-utils.sh activity-log "ERROR" "debugger-ant" "Could not fix: {diagnosis}"`
     - Display: "Debugger could not fix: {diagnosis}. Task {skipped|flagged for review}."
     - Mark task as failed
     - Continue to next worker

4. **Remove old Step 5c.g** ("Task failed after 2 retries") and replace with the debugger-based flow above.

IMPORTANT: Do NOT create a new debugger-ant.md file. The debugger reuses builder-ant.md with diagnostic constraints in the spawn prompt. Do NOT modify builder-ant.md. The retry count threshold in Step 5c.f changes from `< 2` to `< 1` (worker gets exactly one retry before debugger).
  </action>
  <verify>
Read the updated build.md. Confirm:
1. Step 5c.f retry threshold is `< 1` (one retry only)
2. Step 5c.f2 exists with debugger spawn logic
3. Debugger prompt includes "DEBUGGER ANT" and "PATCH" constraints
4. Old Step 5c.g "after 2 retries" is replaced with debugger flow
5. Post-debugger logic handles both fix_applied true and false
6. Criticality inference mentioned for non-fixable tasks
  </verify>
  <done>
When a worker fails twice, a debugger ant spawns using builder-ant.md spec with patch-only constraints. Debugger attempts to diagnose and fix. If fix succeeds, task continues. If fix fails, task is marked failed with criticality-aware handling. Old "give up after 2 retries" behavior is replaced.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read the full build.md and verify Step 5c flow is: spawn worker -> result -> retry if failed (max 1) -> debugger if retry failed -> post-wave conflict check -> advisory review
2. Confirm no new worker spec files were created (no reviewer-ant.md or debugger-ant.md)
3. Confirm the step ordering is correct: 5c.f (retry) -> 5c.f2 (debugger) -> 5c.g (post-debugger) -> 5c.h (conflict check) -> 5c.i (reviewer)
4. Verify LIGHTWEIGHT mode check in Step 5c.i
</verification>

<success_criteria>
- build.md Step 5c.i: Advisory reviewer spawns after each wave for STANDARD/FULL mode with 2+ workers, displays findings inline, only CRITICAL triggers rebuild (max 2 iterations)
- build.md Step 5c.f2: Debugger spawns after worker retry failure, patches existing code, reports diagnosis
- No new worker spec files created
- Existing build.md steps (1-5b, 5.5, 6, 7) remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/30-automation/30-01-SUMMARY.md`
</output>
