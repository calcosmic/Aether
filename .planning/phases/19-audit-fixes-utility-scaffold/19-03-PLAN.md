---
phase: 19-audit-fixes-utility-scaffold
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified:
  - .aether/aether-utils.sh
  - .claude/commands/ant/ant.md
  - .claude/commands/ant/init.md
autonomous: true

must_haves:
  truths:
    - "bash .aether/aether-utils.sh help prints available subcommands and exits 0"
    - "bash .aether/aether-utils.sh version outputs JSON with ok:true"
    - "bash .aether/aether-utils.sh nonexistent exits non-zero with JSON error to stderr"
    - "aether-utils.sh sources file-lock.sh and atomic-write.sh successfully"
    - "ant.md documents how the colony system works"
    - "init.md help text explains the colony initialization process"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "Utility scaffold with subcommand dispatch"
      min_lines: 30
    - path: ".claude/commands/ant/ant.md"
      provides: "Updated help text with colony system description"
      contains: "HOW IT WORKS"
    - path: ".claude/commands/ant/init.md"
      provides: "Init command with colony documentation in help text"
      contains: "colony"
  key_links:
    - from: ".aether/aether-utils.sh"
      to: ".aether/utils/file-lock.sh"
      via: "source command"
      pattern: "source.*file-lock\\.sh"
    - from: ".aether/aether-utils.sh"
      to: ".aether/utils/atomic-write.sh"
      via: "source command"
      pattern: "source.*atomic-write\\.sh"
---

<objective>
Create the aether-utils.sh scaffold with subcommand dispatch and document colony mode in ant.md and init.md.

Purpose: Phase 20 will add real utility modules (pheromone math, state validation, memory ops, error tracking) to aether-utils.sh. This plan creates the scaffold that Phase 20 populates -- entry point, shared infrastructure sourcing, JSON output helpers, and subcommand dispatch. Also completes the last audit fix (FIX-11) by documenting how the colony system works.

Output: Working aether-utils.sh scaffold, updated documentation in ant.md and init.md.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-audit-fixes-utility-scaffold/19-RESEARCH.md
@.aether/utils/atomic-write.sh
@.aether/utils/file-lock.sh
@.claude/commands/ant/ant.md
@.claude/commands/ant/init.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aether-utils.sh scaffold</name>
  <files>
    .aether/aether-utils.sh
  </files>
  <action>
Create `.aether/aether-utils.sh` with the following content. This is a NEW file -- it does not exist yet.

```bash
#!/bin/bash
# Aether Colony Utility Layer
# Single entry point for deterministic colony operations
#
# Usage: bash .aether/aether-utils.sh <subcommand> [args...]
#
# All subcommands output JSON to stdout.
# Non-zero exit on error with JSON error message to stderr.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AETHER_ROOT="$(cd "$SCRIPT_DIR/.." && pwd 2>/dev/null || echo "$SCRIPT_DIR")"
DATA_DIR="$SCRIPT_DIR/data"

# Source shared infrastructure
source "$SCRIPT_DIR/utils/file-lock.sh"
source "$SCRIPT_DIR/utils/atomic-write.sh"

# --- JSON output helpers ---
# Success: JSON to stdout, exit 0
json_ok() { printf '{"ok":true,"result":%s}\n' "$1"; }

# Error: JSON to stderr, exit 1
json_err() { printf '{"ok":false,"error":"%s"}\n' "$1" >&2; exit 1; }

# --- Subcommand dispatch ---
cmd="${1:-help}"
shift 2>/dev/null || true

case "$cmd" in
  help)
    cat <<'EOF'
{"ok":true,"commands":["help","version"],"description":"Aether Colony Utility Layer â€” deterministic ops for the ant colony"}
EOF
    ;;
  version)
    json_ok '"0.1.0"'
    ;;
  *)
    json_err "Unknown command: $cmd"
    ;;
esac
```

Key design decisions (from research and v4.0 decisions):
- Location is `.aether/aether-utils.sh` (NOT in utils/ subdirectory) so it can be called as `bash .aether/aether-utils.sh help`
- SCRIPT_DIR resolves to `.aether/` so it can find `utils/` and `data/` relative to itself
- AETHER_ROOT goes one level up to the project root
- DATA_DIR points to `.aether/data/` where all state files live
- Sources both file-lock.sh and atomic-write.sh for shared infrastructure (UTIL-02)
- json_ok outputs to stdout (UTIL-03), json_err outputs to stderr and exits 1 (UTIL-04)
- help subcommand outputs JSON listing available commands (UTIL-03)
- Unknown commands get JSON error and non-zero exit (UTIL-04)
- set -euo pipefail for strict error handling
- Under 50 lines -- Phase 20 will add modules within the 300-line total budget
- Uses simple case statement dispatch (not getopt/getopts) per research recommendation

Make the file executable: `chmod +x .aether/aether-utils.sh`
  </action>
  <verify>
Run: `bash .aether/aether-utils.sh help` -- must output JSON with "ok":true and list of commands, exit 0.
Run: `bash .aether/aether-utils.sh version` -- must output `{"ok":true,"result":"0.1.0"}`, exit 0.
Run: `bash .aether/aether-utils.sh nonexistent 2>/dev/null; echo $?` -- must print exit code 1 (non-zero).
Run: `bash .aether/aether-utils.sh nonexistent 2>&1 1>/dev/null` -- must contain `"ok":false` and `"error"`.
Run: `wc -l < .aether/aether-utils.sh` -- must be under 50 lines.
  </verify>
  <done>
aether-utils.sh exists at .aether/aether-utils.sh, dispatches subcommands, sources shared infrastructure, outputs JSON to stdout on success, exits non-zero with JSON error on failure. UTIL-01, UTIL-02, UTIL-03, UTIL-04 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document colony system in ant.md and init.md</name>
  <files>
    .claude/commands/ant/ant.md
    .claude/commands/ant/init.md
  </files>
  <action>
1. **FIX-11 in ant.md:** Read `.claude/commands/ant/ant.md`. The existing "HOW IT WORKS" section (lines 62-67) is brief. Expand it to include colony system documentation. Replace the HOW IT WORKS section content (keep the heading) with:

```
HOW IT WORKS

  The Aether Colony is a multi-agent system inspired by ant colony intelligence.

  Colony Lifecycle:
    1. INIT: Queen sets intention (goal). Colony mobilizes. State: IDLE -> READY.
    2. PLAN: Route-setter decomposes goal into phases. State: READY -> PLANNING -> READY.
    3. BUILD: Workers execute phases. Spawn sub-workers as needed. State: READY -> EXECUTING.
    4. CONTINUE: Queen approves phase, extracts learnings. Advances to next phase.
    5. Repeat BUILD/CONTINUE until all phases complete.

  Pheromone System:
    Signals decay over time (exponential half-life). Workers sense signals
    and adjust behavior. FOCUS attracts, REDIRECT repels, FEEDBACK calibrates.

  Autonomy Model:
    Workers spawn sub-workers autonomously (max depth 3, max 5 active).
    Bayesian confidence tracks spawn success rates per caste.
    Phase boundaries are control points -- emergence happens within phases.

  State Files (.aether/data/):
    COLONY_STATE.json  Colony goal, state, workers, spawn outcomes
    pheromones.json    Active pheromone signals with decay
    PROJECT_PLAN.json  Phase breakdown and task tracking
    errors.json        Error records and flagged patterns
    memory.json        Phase learnings and decisions
    events.json        Colony event log
```

2. **FIX-11 in init.md:** Read `.claude/commands/ant/init.md`. In the Step 1 help text (the usage output shown when $ARGUMENTS is empty, lines 16-27), add a brief description of what initialization does. Update the output block to:

```
Aether Colony

  Initialize the colony with a goal. This creates the colony state,
  resets all workers to idle, emits an INIT pheromone, and prepares
  state files (errors, memory, events) for tracking.

  Usage: /ant:init "<your goal here>"

  Examples:
    /ant:init "Build a REST API with authentication"
    /ant:init "Create a soothing sound application"
    /ant:init "Design a calculator CLI tool"
```

Do NOT change any other part of init.md (Steps 2-7 remain unchanged).
  </action>
  <verify>
Run: `grep -c "Colony Lifecycle" .claude/commands/ant/ant.md` -- must return 1.
Run: `grep -c "Pheromone System" .claude/commands/ant/ant.md` -- must return 1.
Run: `grep -c "State Files" .claude/commands/ant/ant.md` -- must return 1.
Run: `grep -c "Initialize the colony" .claude/commands/ant/init.md` -- must return 1.
  </verify>
  <done>
ant.md documents colony lifecycle, pheromone system, autonomy model, and state files. init.md help text explains what initialization does. FIX-11 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `bash .aether/aether-utils.sh help` exits 0, outputs JSON with commands array (UTIL-01, UTIL-03)
2. `bash .aether/aether-utils.sh version` outputs `{"ok":true,"result":"0.1.0"}` (UTIL-03)
3. `bash .aether/aether-utils.sh bad_command 2>/dev/null; echo $?` returns 1 (UTIL-04)
4. `grep 'source.*file-lock.sh' .aether/aether-utils.sh && grep 'source.*atomic-write.sh' .aether/aether-utils.sh` both match (UTIL-02)
5. `grep 'Colony Lifecycle' .claude/commands/ant/ant.md` matches (FIX-11)
6. `grep 'Initialize the colony' .claude/commands/ant/init.md` matches (FIX-11)
</verification>

<success_criteria>
- UTIL-01: aether-utils.sh exists with subcommand dispatch
- UTIL-02: Sources file-lock.sh and atomic-write.sh
- UTIL-03: All subcommands output JSON to stdout
- UTIL-04: Non-zero exit on error with JSON error message
- FIX-11: Colony system documented in ant.md and init.md
</success_criteria>

<output>
After completion, create `.planning/phases/19-audit-fixes-utility-scaffold/19-03-SUMMARY.md`
</output>
