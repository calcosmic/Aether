---
phase: 19-audit-fixes-utility-scaffold
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/data/COLONY_STATE.json
  - .aether/data/pheromones.json
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "COLONY_STATE.json has flat top-level fields: .goal, .state, .current_phase"
    - "No command references queen_intention.goal, colony_status.state, or nested phase paths"
    - "Pheromone signals all use created_at (not emitted_at) as the timestamp field"
    - "Worker statuses in COLONY_STATE.json are lowercase strings"
    - "source .aether/utils/atomic-write.sh succeeds and acquire_lock is available"
  artifacts:
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Canonical v3 flat schema with spawn_outcomes"
      contains: "\"goal\":"
    - path: ".aether/data/pheromones.json"
      provides: "Canonical v3 pheromone schema with signals array"
      contains: "\"signals\":"
    - path: ".claude/commands/ant/continue.md"
      provides: "Fixed auto-emit pheromone template with created_at"
      contains: "created_at"
  key_links:
    - from: ".claude/commands/ant/init.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Write tool with flat schema"
      pattern: "\"goal\":"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/data/pheromones.json"
      via: "Auto-emit pheromone with created_at field"
      pattern: "created_at"
---

<objective>
Canonicalize the v3 flat schema for all state files and verify all commands use consistent field paths.

Purpose: The committed COLONY_STATE.json has the old v1/v2 nested schema (queen_intention.goal, colony_status.state, worker_ants with nested objects). The working directory has the correct v3 flat schema. This plan commits the v3 schema as canonical and fixes the one remaining field inconsistency (continue.md uses emitted_at instead of created_at for auto-emitted pheromones).

Output: Canonical state files committed, all commands verified consistent.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-audit-fixes-utility-scaffold/19-RESEARCH.md
@.aether/data/COLONY_STATE.json
@.aether/data/pheromones.json
@.claude/commands/ant/continue.md
@.claude/commands/ant/init.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit canonical v3 state files and verify FIX-01</name>
  <files>
    .aether/data/COLONY_STATE.json
    .aether/data/pheromones.json
  </files>
  <action>
1. Verify FIX-01 is already resolved by running: `source .aether/utils/atomic-write.sh && type acquire_lock`. Confirm it succeeds. This is verify-only -- do not modify the utility files.

2. Write the canonical COLONY_STATE.json to `.aether/data/COLONY_STATE.json` with the v3 flat schema. This REPLACES the old nested schema. The canonical reset state is:

```json
{
  "goal": null,
  "state": "IDLE",
  "current_phase": 0,
  "session_id": null,
  "initialized_at": null,
  "workers": {
    "colonizer": "idle",
    "route-setter": "idle",
    "builder": "idle",
    "watcher": "idle",
    "scout": "idle",
    "architect": "idle"
  },
  "spawn_outcomes": {
    "colonizer":    {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0},
    "route-setter": {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0},
    "builder":      {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0},
    "watcher":      {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0},
    "scout":        {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0},
    "architect":    {"alpha": 1, "beta": 1, "total_spawns": 0, "successes": 0, "failures": 0}
  }
}
```

Note: Worker statuses MUST be lowercase ("idle", not "IDLE"). This satisfies FIX-09.

3. Write the canonical pheromones.json to `.aether/data/pheromones.json`:

```json
{
  "signals": []
}
```

This uses the `signals` array (not `active_pheromones`) with the v3 field names (`content`, `created_at`, `half_life_seconds`). The file is empty at reset -- signals get created by init.md and pheromone commands.
  </action>
  <verify>
Run: `source .aether/utils/atomic-write.sh && type acquire_lock` -- must succeed.
Run: `python3 -c "import json; d=json.load(open('.aether/data/COLONY_STATE.json')); assert 'goal' in d and 'state' in d and 'current_phase' in d and 'queen_intention' not in d and 'colony_status' not in d; print('COLONY_STATE canonical')"` -- must print "COLONY_STATE canonical".
Run: `python3 -c "import json; d=json.load(open('.aether/data/pheromones.json')); assert 'signals' in d and 'active_pheromones' not in d; print('pheromones canonical')"` -- must print "pheromones canonical".
  </verify>
  <done>
COLONY_STATE.json has flat .goal, .state, .current_phase at root with no nested legacy fields. pheromones.json has signals array. All worker statuses are lowercase. FIX-01 verified working. FIX-02, FIX-09 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix pheromone field consistency and verify command paths</name>
  <files>
    .claude/commands/ant/continue.md
  </files>
  <action>
1. Fix FIX-07 in continue.md: In the Step 4.5 auto-emit pheromone templates, change `"emitted_at"` to `"created_at"` in BOTH the FEEDBACK pheromone template (around line 133) and the REDIRECT pheromone template (around line 147). Keep the `"source"` and `"auto"` fields -- they are additive metadata that does not conflict with the schema. Also add an `"id"` field to each template using the pattern `"id": "auto_<unix_timestamp>_<4_random_hex>"` to match the id pattern used in other pheromone signals.

The FEEDBACK template should become:
```json
{
  "id": "auto_<unix_timestamp>_<4_random_hex>",
  "type": "FEEDBACK",
  "content": "...",
  "strength": 0.5,
  "half_life_seconds": 21600,
  "created_at": "<ISO-8601 UTC>",
  "source": "auto:continue",
  "auto": true
}
```

The REDIRECT template should become:
```json
{
  "id": "auto_<unix_timestamp>_<4_random_hex>",
  "type": "REDIRECT",
  "content": "...",
  "strength": 0.9,
  "half_life_seconds": 86400,
  "created_at": "<ISO-8601 UTC>",
  "source": "auto:continue",
  "auto": true
}
```

2. Verify FIX-03: Read all 13 command .md files in `.claude/commands/ant/` and confirm NONE reference:
   - `queen_intention.goal` or `queen_intention`
   - `colony_status.state` or `colony_status.current_phase`
   - `worker_ants` (as a field name with nested objects)
   - `active_pheromones` (as an array name)

All commands should use: `.goal`, `.state`, `.current_phase`, `.workers`, `.signals` (in pheromones.json).

Report findings. If any command uses old paths, fix it. Based on research, all v3 commands already use flat paths -- this is a verification pass.
  </action>
  <verify>
Run: `grep -r "queen_intention\|colony_status\|active_pheromones\|worker_ants" .claude/commands/ant/*.md` -- must return no results.
Run: `grep -c "emitted_at" .claude/commands/ant/continue.md` -- must return 0 (all replaced with created_at).
Run: `grep -c "created_at" .claude/commands/ant/continue.md` -- must return at least 2 (both templates).
  </verify>
  <done>
All commands use canonical flat field paths. continue.md auto-emit templates use created_at (not emitted_at) and include id fields. FIX-03, FIX-07 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `source .aether/utils/atomic-write.sh && type acquire_lock` exits 0 (FIX-01)
2. `python3 -c "import json; d=json.load(open('.aether/data/COLONY_STATE.json')); print(d.get('goal'), d.get('state'), d.get('current_phase'))"` prints `None IDLE 0` with no nested fields (FIX-02)
3. `grep -r "queen_intention\|colony_status\|active_pheromones\|emitted_at" .claude/commands/ant/*.md` returns nothing (FIX-03, FIX-07)
4. All worker values in COLONY_STATE.json are lowercase (FIX-09)
</verification>

<success_criteria>
- FIX-01: Verified (already working)
- FIX-02: COLONY_STATE.json committed with flat schema
- FIX-03: All 13 commands verified using flat paths
- FIX-07: continue.md auto-emit uses created_at
- FIX-09: Worker statuses are lowercase in canonical state
</success_criteria>

<output>
After completion, create `.planning/phases/19-audit-fixes-utility-scaffold/19-01-SUMMARY.md`
</output>
