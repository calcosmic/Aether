---
phase: 19-audit-fixes-utility-scaffold
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - .aether/utils/atomic-write.sh
  - .claude/commands/ant/status.md
autonomous: true

must_haves:
  truths:
    - "Backup directory is .aether/data/backups/ (not .aether/backups/)"
    - "At most 3 backups retained per file (MAX_BACKUPS=3)"
    - "Temp files use PID and timestamp in their names"
    - "status.md removes expired pheromones after displaying them"
    - "Commands include guidance to verify JSON validity when reading state files"
  artifacts:
    - path: ".aether/utils/atomic-write.sh"
      provides: "Hardened atomic write with correct backup dir and rotation limit"
      contains: "data/backups"
    - path: ".claude/commands/ant/status.md"
      provides: "Status command that cleans expired pheromones during reads"
      contains: "Clean Expired"
  key_links:
    - from: ".aether/utils/atomic-write.sh"
      to: ".aether/data/backups/"
      via: "BACKUP_DIR variable"
      pattern: "BACKUP_DIR.*data/backups"
    - from: ".claude/commands/ant/status.md"
      to: ".aether/data/pheromones.json"
      via: "Write tool to remove expired signals"
      pattern: "Write.*pheromones"
---

<objective>
Harden state operations -- fix backup directory and rotation, verify temp file uniqueness, add state validation guidance, and clean expired pheromones on read.

Purpose: The shell utilities have two config mismatches (backup directory at .aether/backups/ should be .aether/data/backups/, MAX_BACKUPS=5 should be 3). The status command computes pheromone decay for display but does not clean expired signals. Commands lack guidance for handling corrupted state files.

Output: Hardened atomic-write.sh, status.md with pheromone cleanup, state validation guidance in key commands.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-audit-fixes-utility-scaffold/19-RESEARCH.md
@.aether/utils/atomic-write.sh
@.claude/commands/ant/status.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix atomic-write.sh backup directory and rotation limit</name>
  <files>
    .aether/utils/atomic-write.sh
  </files>
  <action>
Read `.aether/utils/atomic-write.sh` and make these specific changes:

1. **FIX-06 -- Backup directory:** Change line 32 from:
   ```bash
   BACKUP_DIR="$AETHER_ROOT/.aether/backups"
   ```
   To:
   ```bash
   BACKUP_DIR="$AETHER_ROOT/.aether/data/backups"
   ```

2. **FIX-06 -- Rotation limit:** Change line 38 from:
   ```bash
   MAX_BACKUPS=5
   ```
   To:
   ```bash
   MAX_BACKUPS=3
   ```

3. **FIX-04 -- Verify temp file uniqueness:** Confirm that the temp file pattern on lines 52 and 107 uses `.$$.$(date +%s%N).tmp` which includes both PID ($$) and timestamp (date +%s%N). This should already be correct -- verify only, do not change if already correct.

4. **FIX-05 -- jq exit code checking:** This file uses `python3` for JSON validation (not jq), so FIX-05 does not apply here. The jq error checking pattern will be established in the aether-utils.sh scaffold (Plan 19-03). No changes needed in atomic-write.sh for FIX-05.

Do NOT change anything else in atomic-write.sh. The file-lock.sh sourcing (lines 10-22), atomic_write function, atomic_write_from_file function, create_backup, rotate_backups, restore_backup, list_backups, and cleanup_temp_files should remain unchanged.
  </action>
  <verify>
Run: `grep 'BACKUP_DIR=' .aether/utils/atomic-write.sh` -- must contain `.aether/data/backups` (not `.aether/backups`).
Run: `grep 'MAX_BACKUPS=' .aether/utils/atomic-write.sh` -- must show `MAX_BACKUPS=3`.
Run: `grep -c '\.\$\$\.\$(date' .aether/utils/atomic-write.sh` -- must return 2 (both temp file patterns use PID+timestamp).
Run: `source .aether/utils/atomic-write.sh` -- must succeed without errors.
  </verify>
  <done>
atomic-write.sh creates backups in .aether/data/backups/, retains at most 3 backups per file, and temp files use PID+timestamp suffixes. FIX-04, FIX-05 (scoped), FIX-06 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pheromone cleanup to status.md and state validation guidance</name>
  <files>
    .claude/commands/ant/status.md
  </files>
  <action>
Read `.claude/commands/ant/status.md` and make these changes:

1. **FIX-10 -- Clean expired pheromones during reads:** After Step 2 (Compute Pheromone Decay), add a new Step 2.5 that writes the cleaned pheromones back to disk. Insert between Step 2 and Step 3:

```markdown
### Step 2.5: Clean Expired Pheromones

If any signals were marked as expired in Step 2 (current_strength < 0.05), remove them from the `signals` array and use the Write tool to write the cleaned `pheromones.json` back to disk. This ensures expired signals are garbage-collected during normal status checks.

If no signals are expired, skip this step (do not rewrite the file unnecessarily).
```

Update the step progress display in Step 3 to include the new step. Add between Step 2 and Step 3 in the progress list:
```
  âœ“ Step 2.5: Clean Expired Pheromones
```

2. **FIX-08 -- State validation guidance:** Add a validation note at the end of Step 1 (after the parallel reads):

```markdown
**Validation:** After reading each state file, verify the content is valid JSON. If any file contains invalid JSON (corrupted data), output an error message:

```
  WARNING: <filename> contains invalid data.
  Recovery: Run /ant:init to reinitialize state files.
```

Continue displaying status for the files that are valid. Skip sections for corrupted files.
```

Do NOT restructure or rewrite other parts of status.md. These are two surgical additions.
  </action>
  <verify>
Run: `grep -c "Clean Expired" .claude/commands/ant/status.md` -- must return at least 1.
Run: `grep -c "Validation" .claude/commands/ant/status.md` -- must return at least 1.
Run: `grep -c "Step 2.5" .claude/commands/ant/status.md` -- must return at least 2 (heading + progress line).
  </verify>
  <done>
status.md cleans expired pheromones during reads (FIX-10) and includes state validation guidance (FIX-08). Expired signals are removed from pheromones.json when status is displayed.
  </done>
</task>

</tasks>

<verification>
1. `grep 'BACKUP_DIR=' .aether/utils/atomic-write.sh | grep 'data/backups'` returns a match (FIX-06 directory)
2. `grep 'MAX_BACKUPS=3' .aether/utils/atomic-write.sh` returns a match (FIX-06 rotation)
3. `grep -c '\.\$\$\.\$(date' .aether/utils/atomic-write.sh` returns 2 (FIX-04 temp uniqueness)
4. `grep 'Clean Expired' .claude/commands/ant/status.md` returns a match (FIX-10)
5. `grep 'Validation' .claude/commands/ant/status.md` returns a match (FIX-08)
6. `source .aether/utils/atomic-write.sh` succeeds (no regressions)
</verification>

<success_criteria>
- FIX-04: Temp files verified using PID+timestamp pattern
- FIX-05: Scoped to shell utilities (no jq in .md files; pattern established for 19-03)
- FIX-06: Backup dir is .aether/data/backups/, MAX_BACKUPS=3
- FIX-08: State validation guidance added to status.md
- FIX-10: Expired pheromones cleaned during status reads
</success_criteria>

<output>
After completion, create `.planning/phases/19-audit-fixes-utility-scaffold/19-02-SUMMARY.md`
</output>
