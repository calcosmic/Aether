---
phase: 23-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - .aether/workers/architect-ant.md
  - .aether/workers/builder-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/watcher-ant.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "All 6 worker specs contain a Spawn Gate section that calls spawn-check before spawning"
    - "All 6 worker specs contain a Post-Action Validation section with validate-state call"
    - "continue.md calls pheromone-validate before writing auto-emitted pheromones"
    - "build.md Step 5 includes depth context (You are at depth 1) in the spawn prompt"
    - "Worker spec spawn instructions tell ants to propagate depth to children"
  artifacts:
    - path: ".aether/workers/architect-ant.md"
      provides: "Spawn gate and post-action validation for architect caste"
      contains: "spawn-check"
    - path: ".aether/workers/builder-ant.md"
      provides: "Spawn gate and post-action validation for builder caste"
      contains: "spawn-check"
    - path: ".aether/workers/colonizer-ant.md"
      provides: "Spawn gate and post-action validation for colonizer caste"
      contains: "spawn-check"
    - path: ".aether/workers/route-setter-ant.md"
      provides: "Spawn gate and post-action validation for route-setter caste"
      contains: "spawn-check"
    - path: ".aether/workers/scout-ant.md"
      provides: "Spawn gate and post-action validation for scout caste"
      contains: "spawn-check"
    - path: ".aether/workers/watcher-ant.md"
      provides: "Spawn gate and post-action validation for watcher caste"
      contains: "spawn-check"
    - path: ".claude/commands/ant/continue.md"
      provides: "Pheromone validation gate before auto-pheromone writing"
      contains: "pheromone-validate"
    - path: ".claude/commands/ant/build.md"
      provides: "Depth context in spawn prompt"
      contains: "depth 1"
  key_links:
    - from: ".aether/workers/*.md spawn gate"
      to: ".aether/aether-utils.sh spawn-check"
      via: "bash command in spec instructions"
      pattern: "aether-utils\\.sh spawn-check"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/aether-utils.sh pheromone-validate"
      via: "bash command in auto-pheromone step"
      pattern: "aether-utils\\.sh pheromone-validate"
    - from: ".aether/workers/*.md post-action"
      to: ".aether/aether-utils.sh validate-state"
      via: "bash command in post-action checklist"
      pattern: "aether-utils\\.sh validate-state colony"
---

<objective>
Wire spawn-check and pheromone-validate enforcement gates into worker specs, continue.md, and build.md.

Purpose: The subcommands from Plan 01 are useless unless the specs and commands call them. This plan adds: (1) a mandatory spawn gate to all 6 worker specs (ENFO-02), (2) pheromone validation to continue.md (ENFO-04), (3) a post-action validation checklist to all 6 worker specs (ENFO-05), and (4) depth context to build.md spawn prompt.

Output: All 6 worker specs have hard enforcement gates replacing advisory spawn limits. continue.md validates pheromone content before writing. build.md bootstraps depth tracking.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-enforcement/23-RESEARCH.md
@.planning/phases/23-enforcement/23-01-SUMMARY.md
@.aether/workers/architect-ant.md
@.aether/workers/builder-ant.md
@.aether/workers/colonizer-ant.md
@.aether/workers/route-setter-ant.md
@.aether/workers/scout-ant.md
@.aether/workers/watcher-ant.md
@.claude/commands/ant/continue.md
@.claude/commands/ant/build.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spawn gate and post-action validation to all 6 worker specs (ENFO-02, ENFO-05)</name>
  <files>
    .aether/workers/architect-ant.md
    .aether/workers/builder-ant.md
    .aether/workers/colonizer-ant.md
    .aether/workers/route-setter-ant.md
    .aether/workers/scout-ant.md
    .aether/workers/watcher-ant.md
  </files>
  <action>
Read all 6 worker spec files. Each one gets TWO insertions and ONE edit:

**Insertion 1 -- Spawn Gate (ENFO-02):**

Each spec has a "You Can Spawn Other Ants" section with this structure:
1. Section header
2. "When you encounter a capability gap..." intro
3. "Available castes and their spec files:" list
4. "To spawn:" numbered instructions
5. "Spawn Confidence Check" section
6. "Spawning Scenario" section
7. "Spawn limits:" at the end

Insert the Spawn Gate block BETWEEN the caste list (item 3) and "To spawn:" (item 4). The gate goes after the last caste bullet point and before the "**To spawn:**" line.

Text to insert (IDENTICAL in all 6 specs):

```markdown

### Spawn Gate (Mandatory)

Before spawning, you MUST pass the spawn-check gate. Use the Bash tool to run:
```
bash .aether/aether-utils.sh spawn-check <your_depth>
```

Where `<your_depth>` is your current spawn depth (1 if spawned by the build command, 2 if spawned by another ant, 3 if spawned by a sub-ant).

This returns JSON: `{"ok":true,"result":{"pass":true|false,...}}`.

**If `pass` is false: DO NOT SPAWN.** Report the blocked spawn to your parent:
```
Spawn blocked: {reason} (active_workers: {N}, depth: {N})
Task that needed spawning: {description}
```

**If `pass` is true:** Proceed to the confidence check and then spawn.

If the command fails, DO NOT SPAWN. Treat failure as a blocked spawn.
```

**Edit 1 -- Update Spawn Limits text:**

Find the "Spawn limits:" section at the end of the spawning section. Replace it with:

```markdown
**Spawn limits (enforced by spawn-check):**
- Max 5 active workers colony-wide
- Max depth 3 (ant -> sub-ant -> sub-sub-ant, no deeper)
- If spawn-check fails, don't spawn -- report the gap to parent
```

Also update the "To spawn:" numbered instructions. In step 4 (the Task tool call), add depth propagation. After the existing TASK content, add this line to the prompt template: `You are at depth <your_depth + 1>.`

**Insertion 2 -- Post-Action Validation Checklist (ENFO-05):**

Each spec has a quality standards section (named differently per caste -- "Quality Standards" in most, "Implementation Principles" in builder, "Planning Heuristics" in route-setter, "Output Format" in watcher). Insert a NEW section AFTER the quality-related section and BEFORE the "You Can Spawn Other Ants" section.

Text to insert (IDENTICAL in all 6 specs):

```markdown

## Post-Action Validation (Mandatory)

Before reporting your results, complete these deterministic checks:

1. **State Validation:** Use the Bash tool to run:
   ```
   bash .aether/aether-utils.sh validate-state colony
   ```
   If `pass` is false, include the validation failure in your report.

2. **Spawn Accounting:** Report your spawn count: "Spawned: {N}/5 sub-ants". Confirm you did not exceed depth limits.

3. **Report Format:** Verify your report follows the Output Format section above.

Include check results at the end of your report:
```
Post-Action Validation:
  State: {pass|fail}
  Spawns: {N}/5 (depth {your_depth}/3)
  Format: {pass|fail}
```
```

**Important constraints:**
- Do NOT modify existing quality standards sections -- the new section is ADDITIVE
- Do NOT rewrite the entire spawning section -- only insert the gate and update spawn limits
- All 6 specs get the exact same gate text and exact same post-action checklist (consistency is critical)
- Verify insertion points by reading each file first -- the research notes that watcher-ant.md has different line numbers from the other 5 (spawning section starts at line 266 vs ~156)
  </action>
  <verify>
For each of the 6 worker spec files, confirm:

```bash
# All 6 specs contain the spawn gate
grep -l "spawn-check" .aether/workers/*.md | wc -l
# Expected: 6

# All 6 specs contain the post-action validation
grep -l "Post-Action Validation" .aether/workers/*.md | wc -l
# Expected: 6

# All 6 specs contain the updated spawn limits reference
grep -l "enforced by spawn-check" .aether/workers/*.md | wc -l
# Expected: 6

# All 6 specs contain depth propagation
grep -l "your_depth + 1" .aether/workers/*.md | wc -l
# Expected: 6

# Existing quality standards sections still present (not deleted)
grep -l "Quality Standards\|Implementation Principles\|Planning Heuristics" .aether/workers/*.md | wc -l
# Expected: 6 (one match per file)
```
  </verify>
  <done>
- All 6 worker specs contain "### Spawn Gate (Mandatory)" section with `aether-utils.sh spawn-check` call
- All 6 worker specs contain "## Post-Action Validation (Mandatory)" section with `validate-state colony` call
- All 6 worker specs have updated "Spawn limits (enforced by spawn-check)" text
- All 6 worker specs propagate depth to child ants in spawn instructions
- Existing quality standards sections are preserved unchanged
- Gate text is identical across all 6 specs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pheromone validation to continue.md and depth context to build.md (ENFO-04)</name>
  <files>
    .claude/commands/ant/continue.md
    .claude/commands/ant/build.md
  </files>
  <action>
**Edit 1 -- continue.md pheromone validation (ENFO-04):**

Read `.claude/commands/ant/continue.md`. Find the auto-pheromone step (around lines 135-184) where pheromones are constructed and appended to pheromones.json. The key line is "Append these to the `signals` array in `pheromones.json`" (around line 171).

Insert BEFORE that append instruction:

```markdown
Before appending each pheromone, validate its content. Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-validate "<the pheromone content string>"
```

This returns JSON: `{"ok":true,"result":{"pass":true|false,...}}`.

**If `pass` is false:** Do not append this pheromone. Instead, append a rejection event to events.json:
```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "pheromone_rejected",
  "source": "continue",
  "content": "Auto-pheromone rejected: <reason> (length: <N>, min: 20)",
  "timestamp": "<ISO-8601 UTC>"
}
```

**If `pass` is true:** Proceed to append the pheromone.

If the command fails (non-zero exit), skip validation and append the pheromone anyway (fail-open for auto-emitted pheromones).
```

**Edit 2 -- build.md depth bootstrapping:**

Read `.claude/commands/ant/build.md`. Find Step 5 where the Phase Lead ant is spawned via the Task tool (around lines 104-175). In the TASK prompt that gets passed to the spawned ant, add this line near the start of the task context:

```
You are at depth 1. When spawning sub-ants, tell them: "You are at depth 2."
```

This bootstraps the depth chain so that spawn-check receives correct depth values.

**Important constraints:**
- Do NOT modify the pheromone construction logic -- only add a validation gate BEFORE the append step
- The validation uses fail-open on command errors (pheromone still gets written if shell fails), fail-closed on content errors (pheromone rejected if too short/empty)
- For build.md, only add the depth context line -- do NOT restructure the Step 5 prompt
  </action>
  <verify>
```bash
# continue.md contains pheromone-validate call
grep "pheromone-validate" .claude/commands/ant/continue.md
# Expected: match for aether-utils.sh pheromone-validate

# continue.md contains pheromone_rejected event pattern
grep "pheromone_rejected" .claude/commands/ant/continue.md
# Expected: match

# build.md contains depth context
grep "depth 1" .claude/commands/ant/build.md
# Expected: match for "You are at depth 1"

# build.md contains depth propagation instruction
grep "depth 2" .claude/commands/ant/build.md
# Expected: match
```
  </verify>
  <done>
- continue.md calls `aether-utils.sh pheromone-validate` before appending auto-pheromones
- continue.md logs `pheromone_rejected` event when validation fails
- continue.md uses fail-open on command errors, fail-closed on content errors
- build.md Step 5 includes "You are at depth 1" in spawn prompt
- build.md includes depth propagation instruction for child ants
  </done>
</task>

</tasks>

<verification>
Run these checks across all modified files:

1. `grep -rl "spawn-check" .aether/workers/ .claude/commands/ant/build.md` -- should match 7 files (6 workers + build.md references depth)
2. `grep -rl "pheromone-validate" .claude/commands/ant/continue.md` -- should match 1 file
3. `grep -rl "Post-Action Validation" .aether/workers/` -- should match 6 files
4. `grep -rl "enforced by spawn-check" .aether/workers/` -- should match 6 files
5. Verify no files were accidentally truncated: `wc -l .aether/workers/*.md .claude/commands/ant/continue.md .claude/commands/ant/build.md` -- all files should be LONGER than before (insertions, not replacements)
</verification>

<success_criteria>
- ENFO-02: All 6 worker specs have mandatory spawn-check gate before spawning
- ENFO-04: continue.md validates pheromone content before writing, with rejection event logging
- ENFO-05: All 6 worker specs have post-action validation checklist with validate-state call
- Depth bootstrapping: build.md tells Phase Lead it's at depth 1, worker specs propagate depth to children
- No existing content removed -- all changes are insertions or minor edits to spawn limits text
</success_criteria>

<output>
After completion, create `.planning/phases/23-enforcement/23-02-SUMMARY.md`
</output>
