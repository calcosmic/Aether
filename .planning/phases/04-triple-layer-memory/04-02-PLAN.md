---
phase: 04-triple-layer-memory
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .aether/workers/architect-ant.md
  - .aether/utils/memory-compress.sh
autonomous: true
must_haves:
  truths:
    - "DAST compression is implemented as an LLM prompt pattern (not code)"
    - "DAST compression achieves 2.5x compression ratio while preserving semantics"
    - "Short-term Memory schema stores compressed sessions with metadata"
  artifacts:
    - path: ".aether/workers/architect-ant.md"
      provides: "DAST compression prompt pattern"
      contains: "DAST compression instructions with preserve/discard rules"
    - path: ".aether/utils/memory-compress.sh"
      provides: "Compression trigger and session management functions"
      exports: ["compress_working_to_short_term", "create_short_term_session"]
    - path: ".aether/data/memory.json"
      provides: "Short-term Memory storage"
      contains: "short_term_memory.sessions array"
  key_links:
    - from: ".aether/workers/architect-ant.md"
      to: ".aether/data/memory.json"
      via: "LLM reads Working Memory items and produces compressed session"
      pattern: "DAST.*2.5x.*compression"
    - from: ".aether/utils/memory-compress.sh"
      to: ".aether/utils/memory-ops.sh"
      via: "source memory-ops.sh for access to Working Memory"
      pattern: "source.*memory-ops.sh"
---

<objective>
Implement DAST compression prompt pattern and Short-term Memory schema for compressed session storage.

Purpose: DAST (Discriminative Abstractive Summarization Technique) enables LLM-driven semantic compression at 2.5x ratio, preserving decisions/outcomes while discarding exploration
Output: Architect Ant has DAST compression prompt, Short-term Memory schema ready for compressed sessions
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-triple-layer-memory/04-RESEARCH.md

# Key Patterns to Follow
@.aether/workers/architect-ant.md - existing compression workflow (lines 121-136)
@.claude/commands/ant/init.md - jq + atomic-write pattern
@.aether/utils/memory-ops.sh - Working Memory operations (from 04-01)
@.aether/data/memory.json - Short-term Memory schema
</context>

<tasks>

<task type="auto">
  <name>Enhance DAST compression prompt in Architect Ant</name>
  <files>.aether/workers/architect-ant.md</files>
  <action>
Update the "Compress Using DAST" section in architect-ant.md (around line 121-136) with more detailed DAST instructions:

Replace/enhance the existing DAST section with:

## DAST Compression Task

You are compressing Working Memory to Short-term Memory using **DAST (Discriminative Abstractive Summarization Technique)** with a 2.5x compression ratio.

### Input Analysis
First, read Working Memory:
```bash
jq '.working_memory.items' .aether/data/memory.json
```

Count items and estimate tokens:
```bash
jq '[.working_memory.items[].token_count] | add' .aether/data/memory.json
```

### Compression Rules

**PRESERVE (High Value):**
- **Decisions with rationale**: "We chose X because Y" - captures reasoning
- **Outcomes and results**: "Implemented caching, reduced latency 40%" - measurable impact
- **Learned preferences**: "Queen prefers functional over OOP" - guides future
- **Constraints**: "Must avoid synchronous patterns" - prevents mistakes
- **Solutions**: "Fixed by adding database index on user_id" - reusable knowledge
- **Blockers encountered and resolved**: What blocked progress and how

**DISCARD (Low Value):**
- **Exploration**: "Trying option 1...", "Maybe try X...", "Hmm, interesting..."
- **Failed attempts** (unless lessons learned): "That didn't work", "Wrong approach"
- **Redundant context**: Repeated explanations, obvious statements
- **Intermediate steps**: "Reading file...", "Checking...", "Running test..."

### Compression Process

1. **Analyze all Working Memory items**: Group by type and relevance
2. **Extract high-value items**: relevance_score > 0.7 or type=decision
3. **Synthesize into session summary**: 2-3 sentences capturing the essence
4. **Create key_decisions array**: Each with decision + rationale
5. **Create outcomes array**: Each with result + impact
6. **Create high_value_items array**: Items to preserve for pattern extraction

### Output Format

Produce this JSON structure for Short-term Memory:

```json
{
  "id": "phase_{phase_number}_{timestamp}",
  "session_id": "phase_{phase_number}_{timestamp}",
  "compressed_at": "ISO-8601",
  "original_tokens": {original_count},
  "compressed_tokens": {actual_count},
  "compression_ratio": {actual_ratio},
  "phase": {phase_number},
  "summary": "2-3 sentence overview of what was accomplished",
  "key_decisions": [
    {"decision": "Chose PostgreSQL", "rationale": "ACID compliance needed for transactions"}
  ],
  "outcomes": [
    {"result": "Implemented caching layer", "impact": "Reduced latency 40%"}
  ],
  "high_value_items": [
    {"content": "Item content", "relevance_score": 0.9, "type": "preference"}
  ]
}
```

**Target Ratio**: Achieve ~2.5x compression (original_tokens / compressed_tokens â‰ˆ 2.5)

The compression is complete when you have produced the JSON above.
  </action>
  <verify>
```bash
# Verify Architect Ant has enhanced DAST prompt
grep -A 20 "## DAST Compression Task" .aether/workers/architect-ant.md
grep "PRESERVE.*High Value" .aether/workers/architect-ant.md
grep "DISCARD.*Low Value" .aether/workers/architect-ant.md
grep "2.5x compression" .aether/workers/architect-ant.md
```
  </verify>
  <done>
Architect Ant has detailed DAST compression prompt with explicit preserve/discard rules, output format specification, and 2.5x ratio target.
  </done>
</task>

<task type="auto">
  <name>Create compression utility functions</name>
  <files>.aether/utils/memory-compress.sh</files>
  <action>
Create .aether/utils/memory-compress.sh with compression management functions:

1. **create_short_term_session(phase, compressed_json)**
   - Parse compressed_json (output from Architect Ant's DAST compression)
   - Validate required fields: id, session_id, compressed_at, summary, key_decisions, outcomes
   - Calculate compression_ratio: original_tokens / compressed_tokens
   - Add session to short_term_memory.sessions array via jq
   - Increment short_term_memory.current_sessions
   - Use atomic-write.sh
   - Return session_id

2. **clear_working_memory()**
   - Set working_memory.items to empty array []
   - Set working_memory.current_tokens to 0
   - Use atomic-write.sh

3. **get_compression_stats()**
   - Return compression metrics from memory.json
   - Show total_compressions, average_compression_ratio, evictions

Source .aether/utils/memory-ops.sh for access to Working Memory functions.

Reference init.md jq pattern and 04-RESEARCH.md lines 440-492.
  </action>
  <verify>
```bash
# Source and test functions
source .aether/utils/memory-compress.sh

# Test with sample compressed session
compressed_json='{
  "id": "phase_1_test",
  "session_id": "phase_1_test",
  "compressed_at": "2026-02-01T12:00:00Z",
  "original_tokens": 10000,
  "compressed_tokens": 4000,
  "phase": 1,
  "summary": "Test session",
  "key_decisions": [],
  "outcomes": [],
  "high_value_items": []
}'

session_id=$(create_short_term_session 1 "$compressed_json")
echo "Created session: $session_id"

# Verify session added
jq '.short_term_memory.sessions | length' .aether/data/memory.json

# Test stats
get_compression_stats
```
  </verify>
  <done>
Compression utility functions create Short-term sessions from Architect Ant's DAST output, clear Working Memory after compression, and report compression statistics.
  </done>
</task>

<task type="auto">
  <name>Verify Short-term Memory schema is complete</name>
  <files>.aether/data/memory.json</files>
  <action>
Verify that memory.json has complete Short-term Memory schema.

Check that short_term_memory section includes:
- max_sessions: 10
- current_sessions: 0
- compression_ratio: 2.5
- compression_method: "DAST"
- sessions: [] (array to store compressed sessions)
- session_schema with all required fields
- eviction_policy: "LRU"

The schema should already exist in memory.json. Verify it's complete and matches the requirements.
  </action>
  <verify>
```bash
# Verify Short-term Memory schema
jq '.short_term_memory | has("max_sessions", "current_sessions", "sessions", "session_schema")' .aether/data/memory.json
jq '.short_term_memory.max_sessions' .aether/data/memory.json
jq '.short_term_memory.compression_ratio' .aether/data/memory.json
```
  </verify>
  <done>
Short-term Memory schema is complete with max_sessions=10, compression_ratio=2.5, DAST method, and session schema defined.
  </done>
</task>

</tasks>

<verification>
1. Architect Ant prompt has enhanced DAST compression instructions
2. Prompt specifies preserve/discard rules with examples
3. Prompt specifies 2.5x compression ratio target
4. Prompt specifies JSON output format for compressed sessions
5. memory-compress.sh functions work correctly
6. Short-term sessions can be created from compressed JSON
7. Working Memory can be cleared after compression
8. Compression stats can be retrieved
9. Short-term Memory schema is complete in memory.json
</verification>

<success_criteria>
- DAST compression is implemented as LLM prompt pattern (not code algorithm)
- Architect Ant can compress Working Memory items following preserve/discard rules
- Short-term Memory receives compressed sessions with proper metadata
- Compression ratio tracked and reported
- Functions use atomic writes via atomic-write.sh
</success_criteria>

<output>
After completion, create `.planning/phases/04-triple-layer-memory/04-02-SUMMARY.md` with:
- DAST compression prompt implemented in Architect Ant
- Compression utility functions created
- Short-term Memory schema verified
</output>
