---
phase: 04-triple-layer-memory
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - .aether/utils/memory-compress.sh
  - .aether/data/memory.json
autonomous: true
must_haves:
  truths:
    - "Short-term Memory evicts oldest session when exceeding 10 sessions (LRU policy)"
    - "Long-term Memory stores persistent patterns with associative links"
    - "Patterns extracted from Short-term sessions with confidence scoring"
  artifacts:
    - path: ".aether/utils/memory-compress.sh"
      provides: "Short-term LRU eviction and Long-term pattern extraction"
      exports: ["evict_short_term_session", "extract_pattern_to_long_term", "extract_high_value_patterns"]
    - path: ".aether/data/memory.json"
      provides: "Long-term Memory storage"
      contains: "long_term_memory.patterns array"
  key_links:
    - from: ".aether/utils/memory-compress.sh"
      to: ".aether/data/memory.json"
      via: "jq operations on short_term_memory.sessions and long_term_memory.patterns"
      pattern: "jq.*short_term_memory|long_term_memory"
    - from: ".aether/utils/memory-compress.sh"
      to: ".aether/utils/atomic-write.sh"
      via: "atomic_write_from_file calls"
      pattern: "atomic_write_from_file"
---

<objective>
Implement Short-term LRU eviction (max 10 sessions) and Long-term Memory pattern extraction from high-value items.

Purpose: Short-term Memory has limited capacity (10 sessions), Long-term Memory stores persistent patterns discovered across sessions
Output: LRU eviction for Short-term sessions, pattern extraction functions for Long-term Memory
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-triple-layer-memory/04-RESEARCH.md

# Key Patterns to Follow
@.aether/utils/memory-compress.sh - compression functions from 04-02
@.aether/utils/memory-ops.sh - LRU pattern from 04-01
@.claude/commands/ant/init.md - jq + atomic-write pattern
@.aether/data/memory.json - Short-term and Long-term Memory schemas
@.aether/workers/architect-ant.md - pattern extraction workflow (lines 138-250)
</context>

<tasks>

<task type="auto">
  <name>Implement Short-term LRU eviction</name>
  <files>.aether/utils/memory-compress.sh</files>
  <action>
Add evict_short_term_session() function to memory-compress.sh:

**evict_short_term_session()**
- Get current_sessions count from memory.json
- If current_sessions <= max_sessions (10), return 0 (no eviction needed)
- Before evicting, check oldest session's high_value_items for patterns:
  - Call extract_high_value_patterns() on session's high_value_items
- Sort sessions by compressed_at ascending (oldest first) via jq sort_by
- Remove oldest session from short_term_memory.sessions array
- Decrement short_term_memory.current_sessions
- Increment metrics.short_term_evictions counter
- Use atomic-write.sh

Reference 04-RESEARCH.md lines 531-564 for Short-term LRU pattern.
Reference Working Memory LRU from 04-01 for similar implementation.

Eviction happens automatically when create_short_term_session would exceed 10 sessions.
  </action>
  <verify>
```bash
# Source and test
source .aether/utils/memory-compress.sh

# Create 11 sessions to trigger eviction
for i in {1..11}; do
  session_json="{
    \"id\": \"test_session_$i\",
    \"session_id\": \"test_session_$i\",
    \"compressed_at\": \"2026-02-01T$(printf '%02d' $i):00:00Z\",
    \"original_tokens\": 10000,
    \"compressed_tokens\": 4000,
    \"phase\": $i,
    \"summary\": \"Test session $i\",
    \"key_decisions\": [],
    \"outcomes\": [],
    \"high_value_items\": []
  }"
  create_short_term_session $i "$session_json"
  sleep 1  # Ensure different timestamps
done

# Verify only 10 sessions exist
jq '.short_term_memory.current_sessions' .aether/data/memory.json

# Verify oldest session was evicted
jq '.short_term_memory.sessions | map(.id) | sort' .aether/data/memory.json

# Verify eviction counter incremented
jq '.metrics.short_term_evictions' .aether/data/memory.json
```
  </verify>
  <done>
Short-term Memory LRU eviction removes oldest session when exceeding 10 sessions. Before eviction, high-value items are checked for pattern extraction.
  </done>
</task>

<task type="auto">
  <name>Implement Long-term pattern extraction</name>
  <files>.aether/utils/memory-compress.sh</files>
  <action>
Add pattern extraction functions to memory-compress.sh:

1. **extract_pattern_to_long_term(pattern_type, pattern_content, confidence, context)**
   - Generate pattern_id: "pattern_$(date +%s)_$(md5sum | cut -c1-8)"
   - Timestamp: ISO-8601 format
   - Add pattern to long_term_memory.patterns array via jq with:
     - id, type (success_pattern|failure_pattern|preference|constraint)
     - pattern (content)
     - confidence (0.0-1.0)
     - occurrences (1 for new pattern)
     - created_at, last_seen (timestamp)
     - associative_links: []
     - metadata.context, related_castes: [], related_phases: []
   - Use atomic-write.sh
   - Return pattern_id

2. **extract_high_value_patterns(session_id)**
   - Get session's high_value_items from short_term_memory.sessions
   - For each item with relevance_score > 0.8:
     - Check if similar pattern exists in long_term_memory.patterns
     - If exists: increment occurrences, update confidence, update last_seen
     - If not exists: call extract_pattern_to_long_term
   - For items appearing 3+ times across sessions (pattern detection):
     - Determine pattern_type based on content
     - Extract with higher confidence (0.5 + occurrences * 0.1, max 1.0)

Reference 04-RESEARCH.md lines 566-620 for pattern extraction pattern.
Reference architect-ant.md lines 219-250 for pattern examples.

3. **detect_patterns_across_sessions()**
   - Scan all short_term_memory.sessions for repeated patterns
   - Count occurrences of similar high_value_items
   - For patterns appearing 3+ times, call extract_pattern_to_long_term
   - Update metrics.total_pattern_extractions
  </action>
  <verify>
```bash
# Source and test
source .aether/utils/memory-compress.sh

# Add a pattern manually
pattern_id=$(extract_pattern_to_long_term "success_pattern" "API Error Handling: Try-catch with specific exceptions" 0.9 "FastAPI endpoints")
echo "Created pattern: $pattern_id"

# Verify pattern in long-term memory
jq ".long_term_memory.patterns[] | select(.id == \"$pattern_id\")" .aether/data/memory.json

# Test pattern detection (add similar items to multiple sessions)
# Then run detect_patterns_across_sessions
detect_patterns_across_sessions

# Verify patterns extracted
jq '.long_term_memory.patterns | length' .aether/data/memory.json
jq '.metrics.total_pattern_extractions' .aether/data/memory.json
```
  </verify>
  <done>
Long-term Memory stores patterns extracted from high-value items. Patterns detected across 3+ sessions get higher confidence. Pattern types: success, failure, preference, constraint.
  </done>
</task>

<task type="auto">
  <name>Verify Long-term Memory schema is complete</name>
  <files>.aether/data/memory.json</files>
  <action>
Verify that memory.json has complete Long-term Memory schema.

Check that long_term_memory section includes:
- patterns: [] (array to store patterns)
- pattern_schema with all required fields (id, type, pattern, confidence, occurrences, created_at, last_seen, associative_links, metadata)
- learned_preferences.focus_preferences: []
- learned_preferences.redirect_constraints: []

The schema should already exist in memory.json. Verify it's complete and matches the requirements.
  </action>
  <verify>
```bash
# Verify Long-term Memory schema
jq '.long_term_memory | has("patterns", "pattern_schema", "learned_preferences")' .aether/data/memory.json
jq '.long_term_memory.pattern_schema.type' .aether/data/memory.json
jq '.long_term_memory.pattern_schema.associative_links' .aether/data/memory.json
```
  </verify>
  <done>
Long-term Memory schema is complete with patterns array, pattern schema (id, type, pattern, confidence, occurrences, timestamps, associative_links, metadata), and learned_preferences.
  </done>
</task>

</tasks>

<verification>
1. evict_short_term_session removes oldest session when exceeding 10
2. Before eviction, high-value items are checked for patterns
3. extract_pattern_to_long_term creates patterns with full metadata
4. extract_high_value_patterns detects patterns from session items
5. detect_patterns_across_sessions finds repeated patterns
6. Patterns appearing 3+ times get higher confidence
7. Pattern types: success_pattern, failure_pattern, preference, constraint
8. Long-term Memory schema verified complete
9. Metrics track pattern extractions
</verification>

<success_criteria>
- Short-term LRU eviction triggers at 10 sessions, removes oldest
- Long-term Memory receives extracted patterns from high-value items
- Pattern detection works across sessions (3+ occurrences)
- Confidence scoring based on occurrences (0.5 + occurrences * 0.1)
- Associative links array initialized for future use
</success_criteria>

<output>
After completion, create `.planning/phases/04-triple-layer-memory/04-03-SUMMARY.md` with:
- Short-term LRU eviction implemented
- Long-term pattern extraction implemented
- Schema verification complete
</output>
