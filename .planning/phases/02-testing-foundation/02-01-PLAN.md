---
phase: 02-testing-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tests/unit/validate-state.test.js
  - tests/unit/colony-state.test.js
autonomous: true

must_haves:
  truths:
    - "AVA test framework is installed and configured"
    - "Tests can be run with npm test"
    - "Tests verify COLONY_STATE.json structure is valid"
    - "Tests detect duplicate keys in JSON objects"
  artifacts:
    - path: "package.json"
      provides: "AVA test script and devDependency"
      contains: '"ava":'
    - path: "tests/unit/validate-state.test.js"
      provides: "State validation tests"
      min_lines: 50
    - path: "tests/unit/colony-state.test.js"
      provides: "COLONY_STATE.json specific tests"
      min_lines: 80
  key_links:
    - from: "tests/unit/colony-state.test.js"
      to: ".aether/data/COLONY_STATE.json"
      via: "fs.readFileSync"
      pattern: "COLONY_STATE.json"
---

<objective>
Set up AVA test framework and create unit tests that verify COLONY_STATE.json structure and detect duplicate keys.

Purpose: Establish automated testing infrastructure to catch Oracle-discovered bugs (duplicate keys, timestamp ordering) and prevent regressions.
Output: Working AVA test suite with tests for state validation and duplicate key detection.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-testing-foundation/02-CONTEXT.md

@/Users/callumcowie/repos/Aether/.aether/data/COLONY_STATE.json
@/Users/callumcowie/repos/Aether/package.json
@/Users/callumcowie/repos/Aether/test/sync-dir-hash.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure AVA test framework</name>
  <files>package.json</files>
  <action>
    Add AVA as a devDependency to package.json with a test script.

    Requirements:
    - Add "ava": "^6.0.0" to devDependencies
    - Add "test": "ava" to scripts section
    - Configure AVA to look for tests in tests/unit/ directory
    - Use ES modules or CommonJS consistently with existing codebase

    The existing codebase uses CommonJS (require/module.exports), so configure AVA for CommonJS compatibility.

    Do NOT run npm install - just update package.json. The user will run npm install separately.
  </action>
  <verify>grep -q '"ava"' package.json && grep -q '"test".*ava' package.json</verify>
  <done>package.json contains AVA devDependency and test script</done>
</task>

<task type="auto">
  <name>Task 2: Create COLONY_STATE.json validation tests</name>
  <files>tests/unit/colony-state.test.js</files>
  <action>
    Create comprehensive tests for COLONY_STATE.json that verify:

    1. JSON is valid and parses correctly
    2. Required fields exist: version, goal, state, current_phase, plan, memory, errors, events
    3. Events array is in chronological order (each timestamp >= previous)
    4. No duplicate keys exist in the JSON structure
    5. Task objects in plan.phases don't have duplicate "status" keys

    For duplicate key detection, use a custom JSON parser approach or regex check since standard JSON.parse allows duplicates (last one wins).

    Test structure:
    - Load COLONY_STATE.json from .aether/data/COLONY_STATE.json
    - Test each validation criterion separately
    - Provide clear error messages on failure

    Reference the Oracle findings in 02-CONTEXT.md for the specific bugs to catch.
  </action>
  <verify>node tests/unit/colony-state.test.js (or npm test if AVA is installed)</verify>
  <done>Test file exists with tests for: valid JSON, chronological events, duplicate key detection</done>
</task>

<task type="auto">
  <name>Task 3: Create state validation utility tests</name>
  <files>tests/unit/validate-state.test.js</files>
  <action>
    Create tests for the validate-state subcommand in aether-utils.sh.

    Test that:
    1. validate-state colony returns valid JSON with correct structure
    2. validate-state constraints returns valid JSON
    3. validate-state flags returns valid JSON
    4. All validation checks include a "pass" field

    Use child_process.execSync to call the bash script and verify output.

    Test structure:
    - Test each validation type (colony, constraints, flags)
    - Verify JSON output structure
    - Verify all checks pass for current valid state files
  </action>
  <verify>bash .aether/aether-utils.sh validate-state colony | jq -e '.ok == true'</verify>
  <done>Test file exists with tests for all validate-state subcommands</done>
</task>

</tasks>

<verification>
- npm test runs without errors
- All new tests pass
- Tests specifically catch the Oracle-discovered bugs (duplicate keys, out-of-order timestamps)
</verification>

<success_criteria>
- AVA configured in package.json with test script
- tests/unit/colony-state.test.js exists and tests COLONY_STATE.json structure
- tests/unit/validate-state.test.js exists and tests aether-utils.sh validate-state
- Tests verify: valid JSON, chronological events, no duplicate keys
</success_criteria>

<output>
After completion, create `.planning/phases/02-testing-foundation/02-01-SUMMARY.md`
</output>
