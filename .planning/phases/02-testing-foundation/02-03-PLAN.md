---
phase: 02-testing-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - .aether/data/COLONY_STATE.json
  - bin/cli.js
  - tests/unit/colony-state.test.js
autonomous: true

must_haves:
  truths:
    - "COLONY_STATE.json has no duplicate 'status' keys in task objects"
    - "Events array is in chronological order (timestamps ascending)"
    - "Tests detect and fail on duplicate keys"
    - "Tests detect and fail on out-of-order timestamps"
  artifacts:
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Clean state file without Oracle bugs"
      validates: "No duplicate keys, chronological events"
    - path: "tests/unit/colony-state.test.js"
      provides: "Updated tests that verify bugs are fixed"
      contains: "test for duplicate keys, test for chronological order"
  key_links:
    - from: "tests/unit/colony-state.test.js"
      to: ".aether/data/COLONY_STATE.json"
      via: "test assertions"
      pattern: "expect.*duplicate|expect.*chronological"
---

<objective>
Fix the Oracle-discovered bugs in COLONY_STATE.json and verify the fixes with tests.

Purpose: Resolve the two remaining Oracle bugs (duplicate status keys, out-of-order timestamps) and ensure tests catch these issues if they reoccur.
Output: Clean COLONY_STATE.json with bugs fixed and passing tests that verify the fixes.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-testing-foundation/02-CONTEXT.md

@/Users/callumcowie/repos/Aether/.aether/data/COLONY_STATE.json
@/Users/callumcowie/repos/Aether/.aether/oracle/archive/2026-02-13-200332-progress.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix COLONY_STATE.json for duplicate keys</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
    Audit COLONY_STATE.json for duplicate keys and fix any found.

    Oracle reported:
    - Task 1.1 had duplicate "status" keys in the JSON structure
    - This was in an archived version at lines 24-26 and 34

    Steps:
    1. Read the entire COLONY_STATE.json file
    2. Check for duplicate keys in:
       - Task objects (look for duplicate "status" keys)
       - Any other objects that might have duplicates
    3. If duplicates found, remove them keeping only the last value
    4. Ensure the file remains valid JSON

    Note: Standard JSON.parse allows duplicate keys (last one wins), so use a
    custom check or carefully review the file structure.

    The current file may already be clean (Oracle was reviewing an archived version),
    but verify thoroughly.
  </action>
  <verify>jq '.plan.phases[0].tasks[0] | keys | length' .aether/data/COLONY_STATE.json | grep -q '4' (should have 4 keys: id, description, status, assignee)</verify>
  <done>COLONY_STATE.json audited, any duplicate keys removed</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix event timestamp ordering</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
    Audit the events array in COLONY_STATE.json for chronological ordering.

    Oracle reported:
    - Events at lines 173-175 had timestamps before initialization
    - 2026-02-13T11:18:15Z, 2026-02-13T11:20:00Z, 2026-02-13T11:30:00Z
    - vs initialization at 2026-02-13T16:00:00Z

    Steps:
    1. Extract all events from COLONY_STATE.json
    2. Verify each event timestamp >= previous event timestamp
    3. If out-of-order events found:
       - Sort events by timestamp
       - Or remove events that are clearly from a different session
    4. Ensure events are in chronological order

    The current file may already be clean, but verify thoroughly.
    Check that events are ordered: colony_initialized -> swarm_completed -> work_completed
  </action>
  <verify>jq '[.events[].timestamp] | . == sort' .aether/data/COLONY_STATE.json | grep -q 'true'</verify>
  <done>Events array is in chronological order</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for Oracle bugs</name>
  <files>tests/unit/colony-state.test.js</files>
  <action>
    Update or create tests that specifically verify the Oracle bugs are fixed.

    Add tests for:

    1. Duplicate key detection:
       - Test that detects duplicate keys in JSON objects
       - Specifically check task objects don't have duplicate "status" keys
       - Use a regex or custom parser to detect duplicates

    2. Chronological event ordering:
       - Test that events array is sorted by timestamp
       - Verify each event timestamp >= previous timestamp
       - Parse ISO 8601 timestamps and compare

    3. Test with intentional failures:
       - Create test cases with known-bad data to verify tests catch issues
       - Document what the tests are protecting against

    Example test structure:
    ```javascript
    test('no duplicate keys in task objects', t => {
      const content = fs.readFileSync(COLONY_STATE_PATH, 'utf8');
      // Check for duplicate "status" keys in task definitions
      const taskMatches = content.match(/"id":\s*"[\d.]+"[\s\S]*?"status":\s*"\w+"[\s\S]*?"status":/g);
      t.is(taskMatches, null, 'Found duplicate status keys in tasks');
    });

    test('events are in chronological order', t => {
      const state = JSON.parse(fs.readFileSync(COLONY_STATE_PATH, 'utf8'));
      for (let i = 1; i < state.events.length; i++) {
        const prev = new Date(state.events[i-1].timestamp);
        const curr = new Date(state.events[i].timestamp);
        t.true(curr >= prev, `Event ${i} timestamp out of order`);
      }
    });
    ```

    Run the tests to verify they pass with the current clean COLONY_STATE.json.
  </action>
  <verify>npm test (or node tests/unit/colony-state.test.js)</verify>
  <done>Tests exist for duplicate key detection and chronological ordering, all tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Verify existing tests still pass</name>
  <files>N/A (verification only)</files>
  <action>
    Run all existing tests to ensure they still pass.

    Existing tests to run:
    1. test/sync-dir-hash.test.js
    2. test/user-modification-detection.test.js
    3. test/namespace-isolation.test.js
    4. tests/e2e/test-install.sh (if appropriate for current state)

    Steps:
    1. Run each existing test file
    2. Verify all pass
    3. Document any failures

    If any tests fail:
    - Determine if failure is related to Phase 2 changes
    - Fix if related, document if pre-existing

    Update package.json test scripts if needed to include all tests.
  </action>
  <verify>node test/sync-dir-hash.test.js && node test/user-modification-detection.test.js && node test/namespace-isolation.test.js</verify>
  <done>All existing tests pass (sync-dir-hash, user-modification-detection, namespace-isolation)</done>
</task>

</tasks>

<verification>
- COLONY_STATE.json has no duplicate keys
- Events array is in chronological order
- Tests detect duplicate keys (verified with intentional test case)
- Tests detect out-of-order timestamps (verified with intentional test case)
- All existing tests pass
</verification>

<success_criteria>
- COLONY_STATE.json audited and any duplicate keys removed
- Events array verified to be in chronological order
- tests/unit/colony-state.test.js includes regression tests for Oracle bugs
- All existing tests continue to pass (TEST-03 requirement)
</success_criteria>

<output>
After completion, create `.planning/phases/02-testing-foundation/02-03-SUMMARY.md`
</output>
