---
phase: 06-foundation-safe-checkpoints-testing-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/unit/cli-sync.test.js
autonomous: true

must_haves:
  truths:
    - syncDirWithCleanup copies files from source to destination
    - syncDirWithCleanup skips files with matching hashes (idempotent)
    - syncDirWithCleanup removes files in destination not in source
    - syncDirWithCleanup creates directories as needed
    - syncDirWithCleanup handles dry-run mode correctly
    - syncDirWithCleanup is idempotent (running twice produces same result)
  artifacts:
    - path: "tests/unit/cli-sync.test.js"
      provides: "Unit tests for syncDirWithCleanup function"
      min_lines: 150
      contains: ["syncDirWithCleanup", "idempotent", "test"]
  key_links:
    - from: "tests/unit/cli-sync.test.js"
      to: "bin/cli.js"
      via: "proxyquire('../bin/cli.js', { fs: mockFs })"
---

<objective>
Create comprehensive unit tests for syncDirWithCleanup function using sinon and proxyquire, with focus on idempotency property tests.

Purpose: Verify sync behavior including copy logic, hash-based skipping, cleanup, and idempotency guarantees.
Output: tests/unit/cli-sync.test.js with passing tests including property-based idempotency tests.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-RESEARCH.md
@/Users/callumcowie/repos/Aether/bin/cli.js
@/Users/callumcowie/repos/Aether/tests/unit/helpers/mock-fs.js
</context>

<tasks>

<task type="auto">
  <name>Create unit tests for syncDirWithCleanup with idempotency tests</name>
  <files>tests/unit/cli-sync.test.js</files>
  <action>
    Create tests/unit/cli-sync.test.js with comprehensive tests:

    Test structure:
    ```javascript
    const test = require('ava');
    const sinon = require('sinon');
    const proxyquire = require('proxyquire');

    test.beforeEach(t => {
      t.context.mockFs = {
        existsSync: sinon.stub(),
        readdirSync: sinon.stub(),
        mkdirSync: sinon.stub(),
        copyFileSync: sinon.stub(),
        readFileSync: sinon.stub(),
        unlinkSync: sinon.stub(),
        rmdirSync: sinon.stub(),
        chmodSync: sinon.stub()
      };

      t.context.mockDirent = (name, isDir = false) => ({
        name,
        isDirectory: () => isDir,
        isFile: () => !isDir
      });

      t.context.cli = proxyquire('../bin/cli.js', {
        fs: t.context.mockFs
      });
    });

    test.afterEach(t => {
      sinon.restore();
    });
    ```

    Tests for syncDirWithCleanup:

    1. 'syncDirWithCleanup copies all files from source to destination':
       - Mock source with 2 files
       - Mock destination doesn't exist
       - Verify copyFileSync called for both files
       - Verify result.copied === 2

    2. 'syncDirWithCleanup creates destination directory if missing':
       - Mock existsSync returns false for dest
       - Verify mkdirSync called with recursive: true

    3. 'syncDirWithCleanup skips files with matching hashes (idempotent)':
       - Mock source and dest both have same file
       - Mock readFileSync returns same content for both
       - Verify copyFileSync NOT called
       - Verify result.skipped === 1

    4. 'syncDirWithCleanup copies files with different hashes':
       - Mock source and dest both have file
       - Mock readFileSync returns different content
       - Verify copyFileSync IS called
       - Verify result.copied === 1

    5. 'syncDirWithCleanup removes files in destination not in source':
       - Mock source with file1.txt
       - Mock dest with file1.txt and file2.txt
       - Verify unlinkSync called for file2.txt
       - Verify result.removed contains 'file2.txt'

    6. 'syncDirWithCleanup handles dry-run mode':
       - Pass { dryRun: true }
       - Verify copyFileSync NOT called
       - Verify unlinkSync NOT called
       - Verify result.copied === number of source files

    7. 'syncDirWithCleanup sets executable permissions on .sh files':
       - Mock source with script.sh
       - Verify chmodSync called with 0o755

    8. 'syncDirWithCleanup creates nested directories':
       - Mock source with dir/subdir/file.txt
       - Verify mkdirSync called for each level

    9. 'syncDirWithCleanup handles copy errors gracefully':
       - Mock copyFileSync throws error for one file
       - Verify continues with other files
       - Verify result.skipped incremented

    10. 'syncDirWithCleanup is idempotent - second run copies nothing':
        - First sync: 3 files copied
        - Reset stubs but keep same hash mocks
        - Second sync: 0 files copied, 3 skipped
        - Verify result.copied === 0

    11. 'syncDirWithCleanup is idempotent - cleanup removes nothing on second run':
        - First sync: sets up destination
        - Second sync with same source: nothing removed
        - Verify result.removed is empty

    12. 'syncDirWithCleanup cleans up empty directories after removal':
        - Mock dest with dir/file.txt
        - Source doesn't have dir/
        - Verify unlinkSync for file
        - Verify rmdirSync for dir

    Run tests with `npm run test:unit -- tests/unit/cli-sync.test.js`.
  </action>
  <verify>npm run test:unit -- tests/unit/cli-sync.test.js</verify>
  <done>All 12+ tests pass including idempotency property tests</done>
</task>

</tasks>

<verification>
- [ ] tests/unit/cli-sync.test.js exists
- [ ] All tests pass: `npm run test:unit -- tests/unit/cli-sync.test.js`
- [ ] Tests cover: copy, skip, cleanup, dry-run, idempotency
- [ ] Idempotency tests verify running twice produces same state
- [ ] Tests use sinon stubs and proxyquire for mocking
</verification>

<success_criteria>
- syncDirWithCleanup tests verify correct copy behavior
- Hash-based skipping is tested and working
- Cleanup removes stale files and empty directories
- Idempotency property verified (second run copies nothing)
- Dry-run mode correctly previews changes without modifying
- All tests pass with mocked filesystem
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-05-SUMMARY.md`
</output>
