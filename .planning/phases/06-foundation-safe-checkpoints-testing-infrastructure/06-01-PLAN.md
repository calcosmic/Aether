---
phase: 06-foundation-safe-checkpoints-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - tests/unit/helpers/mock-fs.js
autonomous: true

must_haves:
  truths:
    - sinon and proxyquire are installed as dev dependencies
    - package-lock.json is updated with new dependencies
    - Mock filesystem helper exists for reuse across tests
  artifacts:
    - path: "package.json"
      contains: "sinon" and "proxyquire" in devDependencies
    - path: "tests/unit/helpers/mock-fs.js"
      provides: "Reusable fs mocking utilities"
      min_lines: 50
  key_links:
    - from: "tests/unit/*.test.js"
      to: "tests/unit/helpers/mock-fs.js"
      via: "require('./helpers/mock-fs')"
---

<objective>
Install testing dependencies (sinon + proxyquire) and create reusable mock filesystem helper for unit testing CLI functions.

Purpose: Establish the testing infrastructure foundation needed for deterministic verification of sync, hash, and manifest functions.
Output: Updated package.json with dev dependencies, package-lock.json, and reusable mock-fs.js helper.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-RESEARCH.md
@/Users/callumcowie/repos/Aether/package.json
@/Users/callumcowie/repos/Aether/tests/unit/spawn-tree.test.js
</context>

<tasks>

<task type="auto">
  <name>Install sinon and proxyquire dev dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
    Run `npm install --save-dev sinon@^19.0.0 proxyquire@^2.1.3` to install the mocking libraries.

    Verify the installation succeeded by checking:
    1. package.json now has sinon and proxyquire in devDependencies
    2. package-lock.json was updated with resolved versions
    3. node_modules/ contains sinon and proxyquire directories

    If installation fails, check Node.js version (must be >=16) and npm connectivity.
  </action>
  <verify>npm list sinon proxyquire --depth=0</verify>
  <done>sinon and proxyquire appear in package.json devDependencies and are installed in node_modules/</done>
</task>

<task type="auto">
  <name>Create reusable mock-fs.js helper</name>
  <files>tests/unit/helpers/mock-fs.js</files>
  <action>
    Create tests/unit/helpers/mock-fs.js with reusable fs mocking utilities:

    1. `createMockFs()` - Returns a mock fs object with sinon stubs for:
       - existsSync
       - readFileSync
       - writeFileSync
       - mkdirSync
       - readdirSync (with Dirent support)
       - copyFileSync
       - unlinkSync
       - rmdirSync
       - statSync
       - chmodSync

    2. `createMockDirent(name, isDirectory)` - Helper to create mock Dirent objects

    3. `resetMockFs(mockFs)` - Resets all stubs between tests

    4. `setupMockFiles(mockFs, fileMap)` - Convenience function to set up mock file contents:
       ```javascript
       setupMockFiles(mockFs, {
         '/test/file.txt': 'content',
         '/test/dir': null  // directory
       });
       ```

    Follow the pattern from 06-RESEARCH.md Example 2. Use sinon.stub() for all methods.
    Ensure the mock supports both string and Buffer content for readFileSync/writeFileSync.
  </action>
  <verify>node -e "const mockFs = require('./tests/unit/helpers/mock-fs.js'); console.log('exports:', Object.keys(mockFs))"</verify>
  <done>tests/unit/helpers/mock-fs.js exists and exports createMockFs, createMockDirent, resetMockFs, setupMockFiles</done>
</task>

</tasks>

<verification>
- [ ] `npm list sinon proxyquire` shows both packages installed
- [ ] package.json contains sinon (^19.0.0) and proxyquire (^2.1.3) in devDependencies
- [ ] tests/unit/helpers/mock-fs.js exists and is require-able
- [ ] Mock fs helper exports all expected functions
</verification>

<success_criteria>
- sinon and proxyquire installed as dev dependencies
- package-lock.json updated with resolved versions
- tests/unit/helpers/mock-fs.js created with reusable mocking utilities
- All helper functions are properly exported and functional
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-01-SUMMARY.md`
</output>
