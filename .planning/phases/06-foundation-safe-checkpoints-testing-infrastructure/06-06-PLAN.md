---
phase: 06-foundation-safe-checkpoints-testing-infrastructure
plan: 06
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified:
  - package-lock.json
  - bin/cli.js
  - .aether/checkpoints/
autonomous: false

must_haves:
  truths:
    - package-lock.json is committed to git for deterministic builds
    - All unit tests pass (existing + new)
    - Checkpoint command works end-to-end
    - Checkpoint system never captures user data
    - Test suite runs in under 10 seconds
  artifacts:
    - path: "package-lock.json"
      provides: "Deterministic dependency tree"
      condition: "committed to git"
    - path: "bin/cli.js"
      provides: "Working checkpoint command"
      condition: "checkpoint create/list/restore/verify all functional"
    - path: ".aether/checkpoints/"
      provides: "Checkpoint storage"
      condition: "metadata files created and valid"
  key_links:
    - from: "checkpoint command"
      to: "SYSTEM_FILES allowlist"
      via: "getAllowlistedFiles() - only allowlisted files checkpointed"
    - from: "checkpoint metadata"
      to: "hashFileSync()"
      via: "SHA-256 hashes for integrity"
---

<objective>
Commit package-lock.json for deterministic builds, run full test suite, and verify checkpoint system works end-to-end without capturing user data.

Purpose: Complete Phase 6 by ensuring deterministic builds, comprehensive test coverage, and safe checkpoint operation.
Output: Committed package-lock.json, passing test suite, verified checkpoint system.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-RESEARCH.md
@/Users/callumcowie/repos/Aether/package.json
@/Users/callumcowie/repos/Aether/bin/cli.js
</context>

<tasks>

<task type="auto">
  <name>Ensure package-lock.json is committed</name>
  <files>package-lock.json</files>
  <action>
    Verify package-lock.json status and ensure it's committed:

    1. Check if package-lock.json is tracked by git:
       `git ls-files package-lock.json`

    2. If not tracked, stage and commit it:
       - `git add package-lock.json`
       - `git commit -m "chore: commit package-lock.json for deterministic builds"`

    3. Verify it's committed:
       `git log --oneline -1 -- package-lock.json`

    4. Verify npm ci works for deterministic install:
       `npm ci --dry-run 2>&1 | head -20`

    Note: package-lock.json should already exist from 06-01 (sinon/proxyquire install).
    This task ensures it's properly committed for TEST-01 requirement.
  </action>
  <verify>git ls-files package-lock.json && git diff --cached --name-only | grep -q package-lock.json || git diff --name-only | grep -q package-lock.json || echo "already committed"</verify>
  <done>package-lock.json is committed to git and npm ci works</done>
</task>

<task type="auto">
  <name>Run full test suite and verify all tests pass</name>
  <files>tests/unit/*.test.js</files>
  <action>
    Run the complete test suite to verify all tests pass:

    1. Run all unit tests:
       `npm run test:unit`

    2. Verify test output:
       - All existing tests still pass (colony-state, validate-state, oracle-regression, state-loader, spawn-tree)
       - New tests pass (cli-hash, cli-manifest, cli-sync)
       - Total test count increased appropriately
       - Test execution time is under 10 seconds

    3. If any tests fail:
       - Investigate and fix the failures
       - Re-run until all pass

    4. Record test metrics:
       - Total tests passed
       - Execution time
       - Coverage (if available)
  </action>
  <verify>npm run test:unit 2>&1 | tail -20</verify>
  <done>All unit tests pass with execution time under 10 seconds</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify checkpoint system works and doesn't capture user data</name>
  <what-built>
    Safe checkpoint system with:
    - `aether checkpoint create [message]` - Creates checkpoint of allowlisted files only
    - `aether checkpoint list` - Lists all checkpoints with metadata
    - `aether checkpoint restore <id>` - Restores from checkpoint
    - `aether checkpoint verify <id>` - Verifies checkpoint integrity
  </what-built>
  <how-to-verify>
    1. Test checkpoint create:
       ```
       cd /Users/callumcowie/repos/Aether
       node bin/cli.js checkpoint create "Test checkpoint"
       ```
       Expected: Checkpoint created with ID, shows file count, no errors

    2. Verify checkpoint metadata:
       ```
       ls -la .aether/checkpoints/
       cat .aether/checkpoints/chk_*.json
       ```
       Expected: JSON file exists with checkpoint_id, created_at, files (hashes), excluded list

    3. Verify user data NOT included:
       - Check that .aether/data/, .aether/dreams/, .aether/oracle/ are NOT in checkpoint
       - Check that TO-DOs.md is NOT in checkpoint (if exists)
       - Only SYSTEM_FILES from allowlist should be present

    4. Test checkpoint list:
       ```
       node bin/cli.js checkpoint list
       ```
       Expected: Shows checkpoint ID, date, message, file count

    5. Test checkpoint verify:
       ```
       node bin/cli.js checkpoint verify <checkpoint-id>
       ```
       Expected: Shows integrity check results, all hashes match

    6. Test checkpoint restore (optional - verify in test repo):
       ```
       node bin/cli.js checkpoint restore <checkpoint-id>
       ```
       Expected: Files restored from git stash, confirmation message

    7. Verify git stash was used:
       ```
       git stash list
       ```
       Expected: Shows stash entry with "aether-checkpoint-<id>" message
  </how-to-verify>
  <resume-signal>Type "approved" if checkpoint system works correctly and doesn't capture user data, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] package-lock.json is committed to git
- [ ] `npm ci` works for deterministic builds
- [ ] All unit tests pass (existing + new)
- [ ] Test suite runs in under 10 seconds
- [ ] `aether checkpoint create` works
- [ ] Checkpoint metadata includes file hashes
- [ ] User data directories are excluded from checkpoints
- [ ] `aether checkpoint list` displays checkpoints
- [ ] `aether checkpoint verify` checks integrity
</verification>

<success_criteria>
- package-lock.json committed for deterministic builds (TEST-01)
- All 6 requirements from TEST-02 through TEST-06 satisfied
- All 4 requirements from SAFE-01 through SAFE-04 satisfied
- Checkpoint system verified working without user data risk
- Full test suite passes in under 10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation-safe-checkpoints-testing-infrastructure/06-06-SUMMARY.md`
</output>
