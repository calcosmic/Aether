---
phase: 29-colony-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "Phase Lead defaults tasks to parallel unless a specific dependency or file overlap exists"
    - "Phase Lead displays wave structure with file paths per worker so user sees parallelism strategy"
    - "Phase Lead auto-approves plans for simple phases (<=4 tasks, <=2 workers, <=2 waves, no shared files)"
    - "LIGHTWEIGHT mode auto-approves all plans regardless of complexity threshold"
    - "FULL mode always requires user approval regardless of simplicity"
    - "Post-wave conflict detection checks activity log for same-file modifications by different workers"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Aggressive wave parallelism, auto-approval, post-wave conflict detection"
      contains: "DEFAULT.*parallel"
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Read mode field for auto-approval logic"
      pattern: "COLONY_STATE.*mode"
    - from: "build.md Step 5a"
      to: "build.md Step 5c"
      via: "Phase Lead plan output consumed by execution loop"
      pattern: "Phase Lead.*plan"
---

<objective>
Add aggressive wave parallelism (INT-03), Phase Lead auto-approval (INT-04), and mode-aware behavior to build.md.

Purpose: Independent tasks run in parallel by default instead of sequentially, simple phases skip the approval checkpoint to reduce friction, and colony mode (set during colonization) controls how aggressively the build operates.

Output: Updated build.md with enhanced Phase Lead parallelism prompt, auto-approval logic in Step 5b, post-wave conflict detection, and mode-conditional watcher skip for LIGHTWEIGHT.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-colony-intelligence/29-RESEARCH.md
@.planning/phases/29-colony-intelligence/29-01-SUMMARY.md
@.claude/commands/ant/build.md
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Phase Lead prompt for aggressive parallelism</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify the Phase Lead prompt in Step 5a of build.md. Keep the existing prompt structure but add/modify these sections:

**1. Add DEFAULT-PARALLEL instruction after the CONFLICT PREVENTION RULE:**

```
--- DEFAULT-PARALLEL RULE ---
CRITICAL: Tasks are PARALLEL by default. Only serialize when you have a specific reason.

For EACH task, list the files it will likely create or modify.
Two tasks are INDEPENDENT if they have zero file overlap AND no explicit dependency.
Independent tasks go in the SAME wave with different workers.
Tasks are DEPENDENT if they share files or one needs the other's output.
Dependent tasks go in SEQUENTIAL waves or the SAME worker.

DEFAULT: Assume tasks are parallel unless you can identify a specific dependency.
Do NOT default to sequential ordering just because tasks are numbered sequentially.
```

**2. Add file-path display requirement to the output format:**

Update the Phase Lead output format to include file paths per worker:

```
Wave 1 ({N} parallel workers):
  1. {caste_emoji} {caste}-ant: {task description} (tasks {ids}) -> {file paths}
  2. {caste_emoji} {caste}-ant: {task description} (tasks {ids}) -> {file paths}

Wave 2 (depends on Wave 1):
  3. {caste_emoji} {caste}-ant: {task description} (tasks {ids}) -> {file paths}
     Needs: {what from Wave 1}

Parallelism: {parallel_count}/{total_count} tasks in Wave 1 ({percentage}%)
Worker count: {N}
Wave count: {N}
```

The "Parallelism:" line is new -- it shows how much work runs in parallel.

**3. Add mode-aware parallelism instruction:**

Add after the DEFAULT-PARALLEL RULE:

```
--- MODE-AWARE PARALLELISM ---
Read COLONY_STATE.json mode field.
- LIGHTWEIGHT: max 1 worker per wave (serialized execution)
- STANDARD: normal parallelism (default behavior)
- FULL: aggressive parallelism, up to 4 concurrent workers per wave

If mode field is null or missing, use STANDARD behavior.
```

**What NOT to change in Step 5a:**
- Keep the CONFLICT PREVENTION RULE exactly as-is
- Keep the caste sensitivity table
- Keep the visual identity instruction
- Keep the "You MUST NOT use the Task tool" constraint
  </action>
  <verify>
Read build.md Step 5a and confirm:
1. DEFAULT-PARALLEL RULE exists after CONFLICT PREVENTION RULE
2. "Assume tasks are parallel unless" instruction is present
3. Output format includes file paths per worker ("-> {file paths}")
4. "Parallelism:" summary line in output format
5. MODE-AWARE PARALLELISM section references COLONY_STATE.json mode
6. LIGHTWEIGHT/STANDARD/FULL behaviors described
7. Existing CONFLICT PREVENTION RULE unchanged
  </verify>
  <done>Phase Lead defaults to parallel task assignment with file-path visibility and mode-aware parallelism limits.</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-approval and mode-aware behavior to build.md</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify Step 5b (Plan Checkpoint) and Step 5.5 (Watcher Verification) in build.md.

**Step 5b changes -- replace the current content with:**

```
### Step 5b: Plan Checkpoint

After the Phase Lead returns:

**Auto-Approval Check:**
Read COLONY_STATE.json. Check the `mode` field.

If mode is "LIGHTWEIGHT": auto-approve the plan. Skip user confirmation.
Display: "Plan auto-approved (LIGHTWEIGHT mode). Proceeding to execution..."
Go to Step 5b-post.

If mode is "STANDARD" or "FULL" (or mode is null/missing):
  Count from the Phase Lead's plan:
  - task_count: total tasks assigned
  - worker_count: total workers assigned
  - wave_count: total waves
  - shared_files: whether any two workers in the same wave list the same file path

  If mode is "STANDARD" AND task_count <= 4 AND worker_count <= 2 AND wave_count <= 2 AND shared_files == false:
    Auto-approve. Display: "Plan auto-approved (simple phase: {tasks} tasks, {workers} workers, {waves} waves). Proceeding to execution..."
    Go to Step 5b-post.

  Otherwise (FULL mode, or STANDARD mode above threshold):
    1. Display the Phase Lead's task assignment plan to the user verbatim
    2. Ask: "Proceed with this plan? (yes / describe changes)"
    3. If user says "yes" or equivalent: proceed to Step 5b-post
    4. If user describes changes: Re-run Step 5a with the user's feedback appended
    5. After re-run, display revised plan and ask again
    6. Maximum 3 plan iterations before proceeding with the latest plan
```

**Step 5c addition -- post-wave conflict detection:**

After each wave completes in Step 5c (after step 4.e for the last worker in a wave), add:

```
**Post-Wave Conflict Check (best-effort):**
After all workers in this wave return, read the activity log entries for this wave's workers:
  `bash .aether/aether-utils.sh activity-log-read "{caste}-ant"`

For each pair of workers in this wave, compare their CREATED and MODIFIED log entries for file path overlap.

If two workers in the same wave show MODIFIED or CREATED entries for the SAME file path:
  HALT execution. Display:
  ```
  CONFLICT DETECTED: Workers {A} and {B} both modified {file_path}

  This wave's changes may have overwritten each other.
  Options:
    1. Review the file and continue
    2. Rollback to git checkpoint: git reset --hard {checkpoint_hash}
  ```
  Wait for user input before continuing to the next wave.

If no conflicts detected, proceed to the next wave silently.
```

**Step 5.5 changes -- mode-aware watcher skip:**

Add a conditional at the TOP of Step 5.5:

```
**Mode Check:** Read COLONY_STATE.json mode field.
If mode is "LIGHTWEIGHT": Skip watcher verification entirely. Display:
  "Watcher verification skipped (LIGHTWEIGHT mode)."
Proceed directly to Step 6.

Otherwise: Continue with mandatory watcher verification as-is.
```

**What NOT to change:**
- Step 5b-post (Record Plan Decisions) stays exactly as-is
- Step 5c execution loop stays the same except for the post-wave addition
- Step 5.5 watcher spawn prompt stays the same (only add the conditional skip at the top)
- All steps after 5.5 stay unchanged
  </action>
  <verify>
Read build.md and confirm:
1. Step 5b reads COLONY_STATE.json mode field
2. LIGHTWEIGHT auto-approves unconditionally
3. STANDARD auto-approves when task_count<=4 AND worker_count<=2 AND wave_count<=2 AND no shared files
4. FULL always requires user approval
5. Post-wave conflict check exists in Step 5c after each wave
6. Conflict detection compares activity log CREATED/MODIFIED entries
7. Step 5.5 has LIGHTWEIGHT skip conditional at top
8. Step 5b-post unchanged
  </verify>
  <done>Build command auto-approves simple plans, skips watcher for LIGHTWEIGHT mode, and detects post-wave file conflicts.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read the full build.md and verify steps flow logically
2. Grep for "COLONY_STATE" in build.md to confirm mode is read in Steps 5a, 5b, 5.5
3. Grep for "DEFAULT.*parallel" to confirm default-parallel instruction exists
4. Grep for "auto-approve" to confirm approval logic in Step 5b
5. Grep for "CONFLICT DETECTED" to confirm post-wave check exists
6. Verify no broken step references from the modifications
7. Confirm CONFLICT PREVENTION RULE still exists unchanged
</verification>

<success_criteria>
1. Phase Lead defaults to parallel task assignment (DEFAULT-PARALLEL RULE)
2. Phase Lead shows file paths and parallelism percentage in output
3. Auto-approval works: LIGHTWEIGHT always, STANDARD for simple phases, FULL never
4. Post-wave conflict detection halts on same-file modifications
5. LIGHTWEIGHT mode skips watcher verification
6. Existing CONFLICT PREVENTION RULE preserved
</success_criteria>

<output>
After completion, create `.planning/phases/29-colony-intelligence/29-03-SUMMARY.md`
</output>
