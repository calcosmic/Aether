---
phase: 29-colony-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/colonize.md
  - .aether/data/COLONY_STATE.json
autonomous: true

must_haves:
  truths:
    - "colonize spawns 3 colonizer ants with distinct lenses (Structure, Patterns, Stack) via sequential Task tool calls"
    - "colonizer reports are synthesized into a unified report with disagreements flagged explicitly"
    - "project complexity is detected via file count, directory depth, and language count before colonizer spawns"
    - "colony mode (LIGHTWEIGHT/STANDARD/FULL) is stored in COLONY_STATE.json mode field after colonization"
    - "LIGHTWEIGHT mode skips multi-colonizer and uses single colonizer"
  artifacts:
    - path: ".claude/commands/ant/colonize.md"
      provides: "Multi-colonizer synthesis + complexity detection + mode setting"
      contains: "Colonizer 1.*Structure"
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Colony state with mode field schema"
      contains: "mode"
  key_links:
    - from: ".claude/commands/ant/colonize.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Write tool sets mode field after complexity detection"
      pattern: "mode.*LIGHTWEIGHT|STANDARD|FULL"
---

<objective>
Add multi-colonizer synthesis (INT-01), adaptive complexity mode (ARCH-03), and colony overhead adaptation (INT-07) to the colonize command.

Purpose: Colony gains multiple independent perspectives during codebase analysis and adapts its overhead to project size, so small projects run lean and large projects get full scrutiny.

Output: Updated colonize.md with 3-colonizer spawning, synthesis step, complexity detection, and mode setting. Updated COLONY_STATE.json schema with mode field.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-colony-intelligence/29-RESEARCH.md
@.claude/commands/ant/colonize.md
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add complexity detection and mode setting to colonize.md</name>
  <files>.claude/commands/ant/colonize.md, .aether/data/COLONY_STATE.json</files>
  <action>
Modify colonize.md to add a new Step 2.5 (between current Step 2 and Step 3) for complexity detection:

**Step 2.5: Detect Project Complexity**

Use the Bash tool to count:
1. Source files (exclude node_modules, .git, dist, build, test, tests, __tests__, spec):
   `find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.py" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.rb" -o -name "*.php" -o -name "*.swift" -o -name "*.kt" -o -name "*.c" -o -name "*.cpp" -o -name "*.cs" \) -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/test/*" -not -path "*/tests/*" -not -path "*/__tests__/*" -not -path "*/spec/*" | wc -l`

2. Max directory depth (exclude node_modules, .git):
   `find . -type d -not -path "*/node_modules/*" -not -path "*/.git/*" | awk -F/ '{print NF}' | sort -n | tail -1`

3. Language count:
   `find . -type f -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -oE '\.[^./]+$' | sort -u | grep -cE '\.(ts|js|py|go|rs|java|rb|php|swift|kt|c|cpp|cs)'`

Classify mode:
- LIGHTWEIGHT: <20 source files AND <3 directories deep AND 1 language
- FULL: >200 source files OR >6 directories deep OR >3 languages OR monorepo detected (multiple package.json/Cargo.toml/go.mod in different directories)
- STANDARD: everything else

After Step 7 (Reset State), update COLONY_STATE.json to include:
```json
"mode": "<LIGHTWEIGHT|STANDARD|FULL>",
"mode_set_at": "<ISO-8601 UTC>",
"mode_indicators": {
  "source_files": <count>,
  "max_depth": <count>,
  "languages": <count>
}
```

Add these fields to the existing Write in Step 7. Do NOT create a separate write.

Also update the COLONY_STATE.json default schema file to include `"mode": null, "mode_set_at": null, "mode_indicators": null` so the field exists from init.

**LIGHTWEIGHT mode behavior in colonize.md:** When mode is LIGHTWEIGHT, Step 4 should spawn only 1 colonizer (the existing single-colonizer pattern), NOT 3. Add a conditional at the top of Step 4: "If mode is LIGHTWEIGHT (from Step 2.5), use the existing single-colonizer pattern in Step 4-LITE below. Otherwise, use the multi-colonizer pattern in Step 4."
  </action>
  <verify>
Read the modified colonize.md and confirm:
1. Step 2.5 exists with all 3 complexity detection commands
2. Mode classification logic matches thresholds (LIGHTWEIGHT <20 files AND <3 depth AND 1 lang; FULL >200 files OR >6 depth OR >3 langs; STANDARD otherwise)
3. COLONY_STATE.json write in Step 7 includes mode, mode_set_at, mode_indicators
4. LIGHTWEIGHT conditional exists in Step 4
  </verify>
  <done>Complexity detection runs during colonization and sets mode field in COLONY_STATE.json. LIGHTWEIGHT projects skip multi-colonizer.</done>
</task>

<task type="auto">
  <name>Task 2: Add multi-colonizer synthesis to colonize.md</name>
  <files>.claude/commands/ant/colonize.md</files>
  <action>
Replace the current Step 4 (single colonizer spawn) with a multi-colonizer pattern. Keep the existing single-colonizer as "Step 4-LITE" for LIGHTWEIGHT mode.

**Step 4: Spawn Three Colonizer Ants (STANDARD/FULL mode)**

Condition: Only run this step if mode from Step 2.5 is STANDARD or FULL. If LIGHTWEIGHT, skip to Step 4-LITE.

Spawn 3 colonizer ants SEQUENTIALLY via Task tool (subagent_type="general-purpose"). Each gets the same prompt header as the current Step 4 but with a distinct specialization lens.

**Colonizer 1 (Structure):**
Mission: Architecture and organization ONLY.
- Directory structure and module boundaries
- Main entry points and how they connect
- Build system and scripts
- Dependency graph between modules
- File organization conventions
Do NOT analyze code quality or tech stack details.

**Colonizer 2 (Patterns):**
Mission: Code quality and conventions ONLY.
- Naming conventions (files, variables, functions, classes)
- Design patterns in use (and anti-patterns)
- Error handling approach
- Code style and formatting
- Documentation patterns
Sample 5-10 representative files. Do NOT map the full directory structure.

**Colonizer 3 (Stack):**
Mission: Technology and dependencies ONLY.
- Languages and frameworks (with versions)
- Dependency health (outdated? vulnerable?)
- Configuration approach (env vars, config files, hardcoded)
- Build/deploy pipeline
- External service integrations
Check package manifests. Do NOT review individual source files.

Each colonizer outputs:
```
COLONIZER {N} ({LENS}) REPORT
Findings:
  - category: "<structure|patterns|stack>"
    finding: "<specific observation>"
    confidence: <HIGH|MEDIUM|LOW>
    evidence: "<file path or pattern>"
```

Save individual reports to `.aether/temp/colonizer-{1,2,3}-report.txt`.

**Step 4.5: Synthesize Colonizer Reports**

The Queen (main agent, NOT a separate Task tool spawn) synthesizes:
1. Collect all 3 reports
2. Group findings by topic (architecture, tech stack, conventions, concerns)
3. Where 2+ colonizers agree: include as HIGH confidence
4. Where colonizers disagree: flag explicitly:
```
DISAGREEMENT: {topic}
  Colonizer {N} ({Lens}): {view}
  Colonizer {M} ({Lens}): {opposing view}
  Resolution: User decision needed
```
5. Produce unified synthesis report for display in Step 6

**Step 4-LITE: Single Colonizer (LIGHTWEIGHT mode)**

Keep the existing Step 4 content as-is for LIGHTWEIGHT projects. This is the current single-colonizer pattern.

Update Step 5 (Persist Findings) to save the synthesis report (not individual reports) to memory.json. The content field should summarize the unified synthesis, not a single colonizer's view.

Update Step 6 (Display Results) to show the synthesis report. Individual colonizer reports are NOT displayed -- only referenced as "stored in .aether/temp/".
  </action>
  <verify>
Read the modified colonize.md and confirm:
1. Step 4 spawns 3 colonizers with distinct lenses (Structure, Patterns, Stack)
2. Each colonizer has a focused mission that explicitly excludes other lenses
3. Step 4.5 exists with synthesis logic including disagreement flagging
4. Step 4-LITE exists with the original single-colonizer pattern
5. Step 5 saves synthesis report to memory.json
6. Step 6 displays synthesis report, not individual reports
  </verify>
  <done>colonize spawns 3 specialized colonizers, synthesizes findings with disagreement flagging, and displays unified report. LIGHTWEIGHT mode falls back to single colonizer.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read the full colonize.md and verify all steps flow logically (1 -> 2 -> 2.5 -> 3 -> 4/4-LITE -> 4.5 -> 5 -> 6 -> 7 -> 8)
2. Verify COLONY_STATE.json has mode field in schema
3. Verify no broken step references (renumbering is consistent)
4. Verify LIGHTWEIGHT conditional is clear and correctly placed
5. Grep for "mode" in colonize.md to confirm it appears in complexity detection, colonizer conditional, and state write
</verification>

<success_criteria>
1. colonize.md contains complexity detection that classifies projects as LIGHTWEIGHT/STANDARD/FULL
2. colonize.md spawns 3 colonizers with distinct lenses for STANDARD/FULL and 1 colonizer for LIGHTWEIGHT
3. Colonizer reports are synthesized with disagreement flagging
4. COLONY_STATE.json schema includes mode, mode_set_at, mode_indicators fields
5. Mode is persisted in Step 7 state write
</success_criteria>

<output>
After completion, create `.planning/phases/29-colony-intelligence/29-01-SUMMARY.md`
</output>
