---
phase: 02-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
autonomous: true
requirements:
  - CMD-01
  - ERR-03

must_haves:
  truths:
    - "/ant:lay-eggs can check session freshness"
    - "/ant:lay-eggs outputs valid JSON for session state"
    - "Error messages are user-friendly with plain English"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "session-is-stale and session-summary functions"
      contains: "json_ok.*is_stale.*true"
  key_links:
    - from: "session-is-stale"
      to: "json_ok function"
      via: "function call"
      pattern: "json_ok.*is_stale"
---

<objective>
Fix JSON output in session-is-stale and session-summary functions.

Purpose: These functions are called by /ant:lay-eggs (CMD-01) and other commands. They currently output raw text/boolean instead of JSON, breaking downstream parsing. Also apply user-friendly error messages per ERR-03.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-infrastructure/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Fix session-is-stale to output JSON</name>
  <files>.aether/aether-utils.sh</files>
  <action>
1. Read lines 3792-3820 of .aether/aether-utils.sh to find session-is-stale function
2. Locate where it echoes "true" or "false"
3. Replace with json_ok '{"is_stale":true}' and json_ok '{"is_stale":false}'
4. Ensure proper JSON boolean (not string) - no quotes around true/false

Reference the pattern from spawn-can-spawn (line ~1537) which uses json_ok correctly.
  </action>
  <verify>
grep -n "json_ok.*is_stale" .aether/aether-utils.sh
  </verify>
  <done>session-is-stale returns {"is_stale":true} or {"is_stale":false} (valid JSON)</done>
</task>

<task type="auto">
  <name>Fix session-summary to output JSON</name>
  <files>.aether/aether-utils.sh</files>
  <action>
1. Read lines 3848-3880 of .aether/aether-utils.sh to find session-summary function
2. Locate where it echoes formatted text like "Goal: $goal"
3. Add --json flag handling that outputs JSON via json_ok
4. Keep text output as default for backward compatibility, but add JSON mode

Example: json_ok "{\"goal\":\"$goal\",\"phase\":$phase}"
  </action>
  <verify>
grep -n "json_ok.*goal" .aether/aether-utils.sh
  </verify>
  <done>session-summary --json returns valid JSON with goal and phase fields</done>
</task>

</tasks>

<verification>
Run: bash .aether/aether-utils.sh session-is-stale
Verify output is valid JSON: echo '{"is_stale":true}' | jq .
</verification>

<success_criteria>
1. session-is-stale outputs valid JSON (parseable by jq)
2. session-summary --json outputs valid JSON
3. No raw "true"/"false" text output from session-is-stale
4. All error messages use json_err with user-friendly text (per ERR-03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-infrastructure/02-01-SUMMARY.md`
</output>
