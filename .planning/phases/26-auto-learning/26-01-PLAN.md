---
phase: 26-auto-learning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "After /ant:build completes, phase learnings appear in memory.json without running /ant:continue"
    - "After /ant:build completes, a FEEDBACK pheromone exists in pheromones.json with source auto:build"
    - "Running /ant:continue after a successful build prints a skip message and does not duplicate learnings"
    - "Running /ant:continue after an interrupted build (no flag event) extracts learnings normally"
    - "Learnings are attributed to specific worker castes, not generic boilerplate"
    - "The auto_learnings_extracted event includes the phase number for phase-specific matching"
    - "memory-compress is called after writing learnings to enforce the 20-learning cap"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Auto-learning extraction in Step 7 (substeps 7a-7e)"
      contains: "auto_learnings_extracted"
    - path: ".claude/commands/ant/continue.md"
      provides: "Duplicate detection in Step 4"
      contains: "auto_learnings_extracted"
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: "events.json"
      via: "auto_learnings_extracted event written after successful extraction"
      pattern: "auto_learnings_extracted"
    - from: ".claude/commands/ant/continue.md"
      to: "events.json"
      via: "checks for auto_learnings_extracted event before extracting"
      pattern: "auto_learnings_extracted"
    - from: ".claude/commands/ant/build.md"
      to: "memory.json"
      via: "appends phase learning entry to phase_learnings array"
      pattern: "phase_learnings"
    - from: ".claude/commands/ant/build.md"
      to: "pheromones.json"
      via: "appends FEEDBACK pheromone after validation"
      pattern: "pheromone-validate"
---

<objective>
Add automatic learning extraction to build.md Step 7 and duplicate detection to continue.md Step 4, so phase learnings are captured without requiring a manual /ant:continue call.

Purpose: Closes the learning feedback loop -- currently users must remember to run /ant:continue after every build or learnings are lost. This makes learning extraction automatic and reliable.

Output: Modified build.md with multi-part Step 7 (extract learnings, emit pheromones, display results) and modified continue.md with duplicate detection that skips extraction when build already handled it.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-auto-learning/26-RESEARCH.md
@.planning/phases/26-auto-learning/26-CONTEXT.md
@.claude/commands/ant/build.md
@.claude/commands/ant/continue.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-learning extraction to build.md Step 7</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Replace the current Step 7 (lines 519-574, display-only) with a multi-part Step 7 that extracts learnings, emits pheromones, and then displays results. The new Step 7 has five substeps:

**Step 7a: Extract Phase Learnings**
- Read `.aether/data/memory.json`
- The Queen already has in memory from prior steps: worker_results (Step 5c), watcher_report (Step 5.5), errors.json and events.json (Step 6), PROJECT_PLAN.json task outcomes (Step 6). Explicitly state this -- no redundant file reads needed.
- Synthesize actionable learnings from worker outcomes, watcher report, errors, and events. Each learning MUST be attributed to the worker/caste that produced it (e.g., "builder-ant: bcrypt 12 rounds caused 800ms delay"). Capture both successes AND failures. Even clean phases get learnings ("X approach worked well").
- Include a quality guard: "Each learning must reference a specific event, error, or outcome. Generic learnings like 'Phase completed successfully' are not acceptable."
- Append a learning entry to memory.json `phase_learnings` array using the established format:
  ```json
  {
    "id": "learn_<unix_timestamp>_<4_random_hex>",
    "phase": <phase_number>,
    "phase_name": "<name>",
    "learnings": ["<caste>: <specific learning>", ...],
    "errors_encountered": <count>,
    "timestamp": "<ISO-8601 UTC>"
  }
  ```
- Write updated memory.json
- Run: `bash .aether/aether-utils.sh memory-compress`
- If memory-compress reports `compressed:true`, note the before/after learning count in the Step 7e display so eviction is visible to the user (per CONTEXT.md decision)
- Do NOT update spawn_outcomes here -- Step 6 already handles this. Add a comment: "spawn_outcomes already updated in Step 6"

**Step 7b: Emit FEEDBACK Pheromone**
- Read `.aether/data/pheromones.json` (if not already in memory)
- Always emit a FEEDBACK pheromone with balanced summary of what worked + what failed. Include the actual learnings in the pheromone body so colony can read them without checking memory.json.
  ```json
  {
    "id": "auto_<unix_timestamp>_<4_random_hex>",
    "type": "FEEDBACK",
    "content": "<balanced summary>",
    "strength": 0.5,
    "half_life_seconds": 21600,
    "created_at": "<ISO-8601 UTC>",
    "source": "auto:build",
    "auto": true
  }
  ```
- Validate via: `bash .aether/aether-utils.sh pheromone-validate "<content>"`
  - If pass:false -> skip pheromone, log pheromone_rejected event
  - If pass:true -> append to pheromones.json
  - If command fails -> append anyway (fail-open)
- Conditionally emit REDIRECT pheromone if `errors.json` has `flagged_patterns` entries related to this phase (same logic as continue.md Step 4.5). Use `source: "auto:build"`.
- Log `pheromone_auto_emitted` event for each emitted pheromone (source: "build")

**Step 7c: Clean Expired Pheromones**
- Run: `bash .aether/aether-utils.sh pheromone-cleanup`

**Step 7d: Write Auto-Learning Flag Event**
- Append to events.json:
  ```json
  {
    "id": "evt_<unix_timestamp>_<4_random_hex>",
    "type": "auto_learnings_extracted",
    "source": "build",
    "content": "Auto-extracted <N> learnings from Phase <id>: <name>",
    "timestamp": "<ISO-8601 UTC>"
  }
  ```
- If events array exceeds 100 entries, trim oldest to 100
- Write updated events.json and pheromones.json

**Step 7e: Display Results (updated from current Step 7)**
- Keep the existing display structure (step progress checklist, git checkpoint, colony activity, task results, caste pheromone sensitivity, watcher report)
- Update the step progress checklist to include the new substeps:
  ```
  ‚úì Step 7a: Extract Phase Learnings
  ‚úì Step 7b: Emit Pheromones
  ‚úì Step 7c: Clean Expired Pheromones
  ‚úì Step 7d: Write Events
  ‚úì Step 7e: Display Results
  ```
- Add new sections after the Watcher Report:
  ```
  üìö Learnings Extracted:
    - <learning 1>
    - <learning 2>
    {if memory-compress trimmed: "‚ö†Ô∏è Memory compressed: <before> -> <after> learnings (oldest evicted)"}

  üß™ Auto-Emitted Pheromones:
    FEEDBACK (0.5, 6h): "<first 80 chars>"
    {if REDIRECT emitted:}
    REDIRECT (0.9, 24h): "<first 80 chars>"
  ```
- REMOVE the "/ant:continue" warning block entirely (the one that says "IMPORTANT: Run /ant:continue to extract learnings...")
- Update Next Steps to make /ant:continue optional:
  ```
  Next:
    /ant:continue            Advance to next phase
    /ant:feedback "<note>"   Give feedback first
    /ant:status              View full colony status
  ```

**Line budget:** Target ~120 lines for the new Step 7 (replacing ~55 lines). Net increase ~65 lines. Total build.md should not exceed ~640 lines. If you find yourself exceeding this, compress the learning extraction instructions -- the Queen has all data in memory, it doesn't need verbose instructions. Keep it concise.

**Critical anti-patterns to avoid:**
- Do NOT duplicate spawn_outcomes update (Step 6 already does this)
- Do NOT change the memory.json schema -- use the exact same format as continue.md
- Do NOT use a separate flag file -- use events.json with the auto_learnings_extracted event type
- Use `source: "auto:build"` (not "auto:continue") for all pheromones and events from build.md
  </action>
  <verify>
1. Read the modified build.md and verify:
   - Step 7 has substeps 7a through 7e
   - The `auto_learnings_extracted` event is written in Step 7d
   - The FEEDBACK pheromone uses `source: "auto:build"`
   - The /ant:continue warning is removed
   - memory-compress is called after writing to memory.json
   - Total line count is under 700
2. Search for "spawn_outcomes" in Step 7 -- it should NOT appear (only in Step 6)
3. Search for "/ant:continue" in the warning section -- it should only appear in the Next Steps menu, not as a required action
  </verify>
  <done>
build.md Step 7 extracts phase learnings into memory.json, emits FEEDBACK pheromone (and conditional REDIRECT) into pheromones.json, writes auto_learnings_extracted flag event to events.json, runs memory-compress, and displays learnings/pheromones in the results output. The /ant:continue warning is replaced with /ant:continue as optional for phase advancement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add duplicate detection to continue.md Step 4</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Add a duplicate detection check at the beginning of Step 4 in continue.md. This prevents double-extraction when the user runs /ant:continue after a build that already auto-extracted learnings.

**At the top of Step 4 (before "Review the completed phase by analyzing:"), add:**

A preamble paragraph that says:

Before extracting learnings, check `events.json` (already in memory from Step 1) for an event where:
- `type` is `"auto_learnings_extracted"`
- `content` contains `"Phase <current_phase_number>:"`

If such an event is found:
- Output: `"üìö Learnings already captured during build (auto-extracted at <event_timestamp>) -- skipping extraction."`
- Skip the rest of Step 4 AND Step 4.5 (pheromone emission)
- Proceed directly to Step 5

If no matching event is found, OR if `$ARGUMENTS` contains "force" or "--force":
- Proceed with the existing extraction logic unchanged

**Also update Step 4.5** to add a note at the top: "If Step 4 was skipped due to auto-extraction detection, skip this step as well and proceed to Step 5."

**Do NOT change any other part of continue.md.** The rest of Step 4, Step 4.5, and all other steps remain exactly as they are.

**Ensure the phase-specific matching is correct:** The check must match the CURRENT phase number in the event content, not just any auto_learnings_extracted event. This prevents false matches from previous phases. The pattern `"Phase <N>:"` in the content field ensures phase-specific matching.
  </action>
  <verify>
1. Read the modified continue.md and verify:
   - Step 4 starts with the auto_learnings_extracted flag check
   - The check matches on BOTH event type AND current phase number in content
   - The skip message is present
   - A "force" override is supported via $ARGUMENTS
   - Step 4.5 has a note about skipping if Step 4 was skipped
   - All other steps (1, 2, 3, 5, 6, 7, 8) are completely unchanged
2. Count the added lines -- should be approximately 10-15 lines in Step 4 and 1-2 lines in Step 4.5
  </verify>
  <done>
continue.md Step 4 checks events.json for an auto_learnings_extracted event matching the current phase before running extraction. If found, it prints a skip message and jumps to Step 5. If not found (or if --force is passed), it proceeds with normal extraction. Step 4.5 is also skipped when Step 4 is skipped.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify end-to-end:

1. **build.md integrity:**
   - Total line count under 700
   - Steps 1 through 6 completely unchanged
   - Step 7 has substeps 7a (learnings), 7b (pheromones), 7c (cleanup), 7d (flag event), 7e (display)
   - No reference to spawn_outcomes in Step 7
   - /ant:continue warning removed from display

2. **continue.md integrity:**
   - Total line count has increased by approximately 10-15 lines
   - Steps 1, 2, 3, 5, 6, 7, 8 completely unchanged
   - Step 4 has duplicate detection preamble
   - Step 4.5 has skip-if-4-skipped note

3. **Flag mechanism consistency:**
   - build.md writes event type `auto_learnings_extracted` with content containing `"Phase <N>: <name>"`
   - continue.md checks for event type `auto_learnings_extracted` with content containing `"Phase <current_phase>:"`
   - These patterns match -- the flag written by build will be detected by continue

4. **Source attribution:**
   - build.md pheromones use `source: "auto:build"`
   - continue.md pheromones still use `source: "auto:continue"` (unchanged)

5. **Requirements coverage:**
   - LEARN-01: build.md Step 7a reads errors/events/outcomes, synthesizes learnings, writes to memory.json
   - LEARN-02: build.md Step 7b emits FEEDBACK pheromone validated via pheromone-validate
   - LEARN-03: continue.md Step 4 detects auto_learnings_extracted event and skips if present
</verification>

<success_criteria>
- build.md Step 7 automatically extracts phase learnings and emits FEEDBACK pheromone after every build
- continue.md detects when learnings were already extracted and skips duplicate extraction
- memory-compress is called to enforce the 20-learning cap
- The auto_learnings_extracted event flag is phase-specific (includes phase number)
- No /ant:continue warning in build.md display (it's now optional, not required)
- All three requirements (LEARN-01, LEARN-02, LEARN-03) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/26-auto-learning/26-01-SUMMARY.md`
</output>
