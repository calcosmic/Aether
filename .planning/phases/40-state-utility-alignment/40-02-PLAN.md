---
phase: 40-state-utility-alignment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - runtime/aether-utils.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "runtime/aether-utils.sh matches ~/.aether/aether-utils.sh"
    - "No pheromone decay math exists in aether-utils.sh"
    - "No separate file validation (pheromones.json, errors.json, memory.json, events.json)"
  artifacts:
    - path: "runtime/aether-utils.sh"
      provides: "Minimal utility script matching ~/.aether version"
      min_lines: 80
      max_lines: 100
  key_links:
    - from: "~/.aether/aether-utils.sh"
      to: "runtime/aether-utils.sh"
      via: "File copy during installation"
      pattern: "validate-state.*colony"
---

<objective>
Sync utility scripts: copy runtime/aether-utils.sh to ~/.aether/aether-utils.sh, replacing the 372-line legacy version with the 85-line minimal version.

Purpose: The runtime version has the correct simplified functions that work with COLONY_STATE.json only. The ~/.aether version still has decay math and separate file validation that should be removed.

Output: ~/.aether/aether-utils.sh updated to minimal version (85 lines), runtime version unchanged.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@runtime/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy runtime/aether-utils.sh to ~/.aether/</name>
  <files>~/.aether/aether-utils.sh</files>
  <action>
Use Bash to copy the minimal runtime version to the global location:

```bash
cp runtime/aether-utils.sh ~/.aether/aether-utils.sh
```

This replaces the 372-line legacy version with the 85-line minimal version.

The minimal version provides these commands (from runtime/aether-utils.sh):
- help
- validate-state [colony|all]
- pheromone-validate
- error-add
- activity-log

Functions REMOVED from old version (no longer needed):
- pheromone-decay (decay math)
- pheromone-effective (sensitivity math)
- pheromone-batch (reads pheromones.json)
- pheromone-cleanup (writes pheromones.json)
- memory-compress (reads/writes memory.json)
- error-pattern-check (reads errors.json)
- error-summary (reads errors.json)
- spawn-check (uses old validation)
- activity-log-init (complex archiving)
- activity-log-read (reads log)
- learning-promote (global learnings)
- learning-inject (global learnings)
- version

The new validate-state only validates COLONY_STATE.json (colony or all mode both check COLONY_STATE.json).
  </action>
  <verify>wc -l ~/.aether/aether-utils.sh && grep -c "pheromone-decay\|pheromone-batch\|memory-compress" ~/.aether/aether-utils.sh</verify>
  <done>~/.aether/aether-utils.sh is ~85 lines with no pheromone-decay, pheromone-batch, or memory-compress functions</done>
</task>

<task type="auto">
  <name>Task 2: Update runtime/aether-utils.sh source path</name>
  <files>runtime/aether-utils.sh</files>
  <action>
Check if the SCRIPT_DIR logic in runtime/aether-utils.sh correctly sources utils/ files.

Current (line 14):
```bash
source "$SCRIPT_DIR/utils/file-lock.sh"
source "$SCRIPT_DIR/utils/atomic-write.sh"
```

This assumes utils/ is a sibling of the script. When copied to ~/.aether/, this will fail because utils/ won't exist there.

Fix: Make the source paths work in both locations:

```bash
# Source shared infrastructure (from runtime/ or ~/.aether/)
if [[ -f "$SCRIPT_DIR/utils/file-lock.sh" ]]; then
  source "$SCRIPT_DIR/utils/file-lock.sh"
  source "$SCRIPT_DIR/utils/atomic-write.sh"
elif [[ -f "$SCRIPT_DIR/../runtime/utils/file-lock.sh" ]]; then
  source "$SCRIPT_DIR/../runtime/utils/file-lock.sh"
  source "$SCRIPT_DIR/../runtime/utils/atomic-write.sh"
else
  # Fallback: inline minimal implementations
  acquire_lock() { :; }
  release_lock() { :; }
  atomic_write() { echo "$2" > "$1"; }
fi
```

Actually, check if atomic_write and file-lock are even needed in the minimal version. Looking at the code:
- validate-state: Only reads, no writes
- pheromone-validate: Only computes, no writes
- error-add: Uses atomic_write
- activity-log: Only appends, no atomic needed

Option A: Keep the sources, copy utils/ to ~/.aether/utils/
Option B: Inline atomic_write in aether-utils.sh (simple: `echo "$2" > "$1"`)

Choose Option B - simpler, no extra files needed.

Update runtime/aether-utils.sh to inline the atomic_write function:
```bash
# Inline atomic write (no external dependency)
atomic_write() {
  local file="$1" content="$2"
  echo "$content" > "$file"
}
```

Remove the source lines for file-lock.sh and atomic-write.sh.
  </action>
  <verify>bash runtime/aether-utils.sh help</verify>
  <done>runtime/aether-utils.sh runs without external file-lock.sh/atomic-write.sh dependencies</done>
</task>

<task type="auto">
  <name>Task 3: Re-copy updated version to ~/.aether/</name>
  <files>~/.aether/aether-utils.sh</files>
  <action>
After Task 2 updates runtime/aether-utils.sh to be self-contained:

```bash
cp runtime/aether-utils.sh ~/.aether/aether-utils.sh
```

Verify the installed version works:
```bash
bash ~/.aether/aether-utils.sh help
```

Expected output:
```json
{"ok":true,"commands":["help","validate-state","pheromone-validate","error-add","activity-log"],"description":"Aether Colony Utilities - Minimal Edition"}
```
  </action>
  <verify>bash ~/.aether/aether-utils.sh help && wc -l ~/.aether/aether-utils.sh</verify>
  <done>~/.aether/aether-utils.sh is self-contained, runs successfully, ~85-90 lines</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Utility script works from ~/.aether/:
   ```bash
   bash ~/.aether/aether-utils.sh help
   ```
   Should return JSON with available commands.

2. No decay functions:
   ```bash
   grep -c "pheromone-decay\|pheromone-batch\|memory-compress" ~/.aether/aether-utils.sh
   ```
   Should return 0.

3. No external source dependencies:
   ```bash
   grep "^source" ~/.aether/aether-utils.sh
   ```
   Should return empty (no source lines).

4. Line count reasonable:
   ```bash
   wc -l ~/.aether/aether-utils.sh
   ```
   Should be ~85-95 lines.
</verification>

<success_criteria>
1. ~/.aether/aether-utils.sh matches runtime/aether-utils.sh
2. Both versions are self-contained (no external source dependencies)
3. Both versions work when run directly with `bash script.sh help`
4. Neither version contains pheromone-decay, pheromone-batch, or memory-compress functions
5. Total line count is ~85-95 lines
</success_criteria>

<output>
After completion, create `.planning/phases/40-state-utility-alignment/40-02-SUMMARY.md`
</output>
