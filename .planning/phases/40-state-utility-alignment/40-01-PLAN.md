---
phase: 40-state-utility-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/ant.md
  - .claude/commands/ant/plan.md
  - .claude/commands/ant/build.md
  - .claude/commands/ant/organize.md
  - .claude/commands/ant/pause-colony.md
  - .claude/commands/ant/resume-colony.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/init.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "No command calls pheromone-batch from aether-utils.sh"
    - "No command calls pheromone-cleanup from aether-utils.sh"
    - "No command calls memory-compress from aether-utils.sh"
    - "ant.md documents single COLONY_STATE.json with nested sections"
    - "Commands read signals directly from COLONY_STATE.json via jq"
  artifacts:
    - path: ".claude/commands/ant/ant.md"
      provides: "Correct documentation of state structure"
      contains: "COLONY_STATE.json"
    - path: ".claude/commands/ant/plan.md"
      provides: "Inline signal reading"
      pattern: "COLONY_STATE.*signals"
    - path: ".claude/commands/ant/build.md"
      provides: "Inline signal reading"
      pattern: "COLONY_STATE.*signals"
  key_links:
    - from: "All commands"
      to: "COLONY_STATE.json"
      via: "Direct jq queries"
      pattern: 'jq.*COLONY_STATE\.json'
---

<objective>
Remove all calls to legacy utility functions (pheromone-batch, pheromone-cleanup, memory-compress) from commands and update documentation.

Purpose: Commands should read signals inline from COLONY_STATE.json using jq, not call utility functions that read separate files. This completes the state consolidation.

Output: 8 updated command files with inline signal reading.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/36-signal-simplification/36-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ant.md documentation</name>
  <files>.claude/commands/ant/ant.md</files>
  <action>
Update the "State Files" section (lines 81-87) to document the single COLONY_STATE.json structure.

Replace:
```
  State Files (.aether/data/):
    COLONY_STATE.json  Colony goal, state, workers, spawn outcomes
    pheromones.json    Active pheromone signals with decay
    PROJECT_PLAN.json  Phase breakdown and task tracking
    errors.json        Error records and flagged patterns
    memory.json        Phase learnings and decisions
    events.json        Colony event log
```

With:
```
  State File (.aether/data/):
    COLONY_STATE.json  Unified colony state containing:
      - goal, state, current_phase, workers, spawn_outcomes
      - plan.phases (phase breakdown and task tracking)
      - signals (pheromone signals with TTL expiration)
      - memory (phase learnings, decisions, patterns)
      - errors (records, flagged patterns)
      - events (colony event log)
```

Also update line 73-74 about the Pheromone System:
- Change "Signals decay over time (exponential half-life)" to "Signals have TTL expiration (expires_at timestamp)"

Also update line 78 in the Autonomy Model section:
- Remove or replace the Bayesian reference "Bayesian confidence tracks spawn success rates per caste"
- Replace with: "Spawn outcomes tracked per caste (success/fail counts)" to accurately reflect the simplified tracking without Bayesian terminology (per SIMP-05)
  </action>
  <verify>grep -A8 "State File" .claude/commands/ant/ant.md && grep -A3 "Autonomy Model" .claude/commands/ant/ant.md</verify>
  <done>ant.md documents single COLONY_STATE.json with nested sections, no mention of separate files, no Bayesian reference</done>
</task>

<task type="auto">
  <name>Task 2: Update signal-reading commands</name>
  <files>.claude/commands/ant/plan.md, .claude/commands/ant/build.md, .claude/commands/ant/organize.md, .claude/commands/ant/pause-colony.md, .claude/commands/ant/resume-colony.md</files>
  <action>
For each command that calls `pheromone-batch`:

**plan.md (line 35):**
Replace Step 3 "Compute Active Pheromones" instructions:

Old:
```
Use the Bash tool to run:
bash ~/.aether/aether-utils.sh pheromone-batch

This returns JSON: {"ok":true,"result":[...signals with current_strength...]}
```

New:
```
Read active signals from COLONY_STATE.json `signals` array.

Filter signals where:
- `expires_at` is null (permanent signals like INIT), OR
- `expires_at` > current timestamp (not expired)

If `signals` array is empty or all expired, treat as "no active pheromones."
```

**build.md (lines 110-117):**
Replace Step 4 "Compute Active Pheromones" similarly:

Old:
```
Use the Bash tool to run:
bash ~/.aether/aether-utils.sh pheromone-batch

This returns JSON: {"ok":true,"result":[...signals with current_strength...]}
```

New:
```
Read active signals from COLONY_STATE.json `signals` array (already loaded in Step 1).

Filter signals where:
- `expires_at` is null (permanent signals like INIT), OR
- `expires_at` > current timestamp (not expired)

If no active signals after filtering, treat as "no active pheromones."
```

Remove references to "current_strength" and replace with TTL filtering.

**organize.md (lines 30-35):**
Same pattern - replace pheromone-batch call with inline reading from COLONY_STATE.json signals.

**pause-colony.md (lines 18-23):**
Same pattern - read signals from COLONY_STATE.json, filter by expires_at.

**resume-colony.md (lines 28-33):**
Same pattern - read signals from COLONY_STATE.json, filter by expires_at.
  </action>
  <verify>grep -r "pheromone-batch" .claude/commands/ant/</verify>
  <done>No command contains "pheromone-batch" - all read signals inline from COLONY_STATE.json</done>
</task>

<task type="auto">
  <name>Task 3: Update continue.md and init.md</name>
  <files>.claude/commands/ant/continue.md, .claude/commands/ant/init.md</files>
  <action>
**continue.md:**
- Line 68: Remove `bash ~/.aether/aether-utils.sh pheromone-cleanup` call
  Rationale: With TTL-based signals, cleanup happens on read (filtering expired). No separate cleanup needed.
  Replace with: "Expired signals are filtered on read. No explicit cleanup needed."

- Line 71: Remove `bash ~/.aether/aether-utils.sh memory-compress` call
  Rationale: Memory is now in COLONY_STATE.json, compression is handled by cap enforcement (30 decisions, 50 events).
  Replace with: "Memory compression handled by cap enforcement when writing (30 decisions max, 50 events max)."

**init.md:**
- Lines 111-116: Update validate-state call

Old:
```
bash ~/.aether/aether-utils.sh validate-state all
This validates COLONY_STATE.json and returns {"ok":true,"result":{"pass":true|false,"files":[...]}}
```

New:
```
bash ~/.aether/aether-utils.sh validate-state colony
This validates COLONY_STATE.json structure and returns {"ok":true,"result":{"pass":true|false}}
```

Rationale: "validate-state all" validates 5 separate files. "validate-state colony" validates only COLONY_STATE.json.
  </action>
  <verify>grep -E "(pheromone-cleanup|memory-compress|validate-state all)" .claude/commands/ant/*.md</verify>
  <done>No command calls pheromone-cleanup, memory-compress, or validate-state all</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No legacy utility calls:
   ```bash
   grep -r "pheromone-batch\|pheromone-cleanup\|memory-compress\|validate-state all" .claude/commands/ant/
   ```
   Should return empty (no matches).

2. Commands reference COLONY_STATE.json signals:
   ```bash
   grep -l "signals" .claude/commands/ant/*.md
   ```
   Should include plan.md, build.md, organize.md, pause-colony.md, resume-colony.md.

3. Documentation updated:
   ```bash
   grep "COLONY_STATE.json.*Unified\|TTL expiration" .claude/commands/ant/ant.md
   ```
   Should find matches showing updated docs.

4. No Bayesian reference:
   ```bash
   grep -i "bayesian" .claude/commands/ant/ant.md
   ```
   Should return empty (no matches).
</verification>

<success_criteria>
1. Zero commands call pheromone-batch, pheromone-cleanup, or memory-compress
2. Zero commands call validate-state all (use validate-state colony)
3. ant.md documents single COLONY_STATE.json structure
4. All commands read signals from COLONY_STATE.json signals array
5. TTL filtering (expires_at) replaces decay math in all commands
6. No Bayesian terminology in ant.md (per SIMP-05)
</success_criteria>

<output>
After completion, create `.planning/phases/40-state-utility-alignment/40-01-SUMMARY.md`
</output>
