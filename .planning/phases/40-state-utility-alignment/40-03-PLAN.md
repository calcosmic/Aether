---
phase: 40-state-utility-alignment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/init.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "No command calls non-existent utility functions (activity-log-init, error-summary, learning-promote)"
    - "All signals use TTL schema (priority, expires_at) not legacy schema (strength, half_life_seconds)"
    - "INIT signal uses priority: high and expires_at: null"
    - "FEEDBACK/REDIRECT signals use priority: normal/high and expires_at timestamp"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Valid utility calls only"
      pattern: "activity-log"
    - path: ".claude/commands/ant/init.md"
      provides: "TTL signal schema for INIT"
      contains: "priority"
    - path: ".claude/commands/ant/continue.md"
      provides: "TTL signal schema for auto-emitted signals"
      contains: "expires_at"
  key_links:
    - from: "init.md INIT signal"
      to: "COLONY_STATE.json signals"
      via: "priority + expires_at fields"
      pattern: '"priority".*"expires_at"'
    - from: "continue.md FEEDBACK signal"
      to: "COLONY_STATE.json signals"
      via: "priority + expires_at fields"
      pattern: '"priority".*"expires_at"'
---

<objective>
Fix remaining verification gaps: remove calls to non-existent utility functions and update signal emissions to use TTL schema.

Purpose: Close the two gaps identified in 40-VERIFICATION.md to complete Phase 40 with all success criteria verified.

Output: 3 command files updated with valid utility calls and consistent TTL signal schema.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/40-state-utility-alignment/40-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove non-existent utility calls from build.md</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Line 265 calls `activity-log-init` which doesn't exist in the minimal aether-utils.sh.

Replace:
```
**1. Initialize activity log:**
```
bash ~/.aether/aether-utils.sh activity-log-init {phase_number} "{phase_name}"
```
```

With:
```
**1. Log phase start:**
```
bash ~/.aether/aether-utils.sh activity-log "PHASE_START" "queen" "Phase {phase_number}: {phase_name}"
```
```

The `activity-log` function exists in the minimal version. `activity-log-init` was removed during simplification. This single log entry replaces the initialization.
  </action>
  <verify>grep -n "activity-log" .claude/commands/ant/build.md</verify>
  <done>build.md uses activity-log (exists) not activity-log-init (removed)</done>
</task>

<task type="auto">
  <name>Task 2: Remove non-existent utility references from continue.md</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Two references to non-existent functions:

**Line 77 (Step 2.5 Tech Debt Report):**
Replace:
```
1. Gather: `errors.records`, `errors.flagged_patterns`, run `error-summary`, read activity.log
```

With:
```
1. Gather: `errors.records`, `errors.flagged_patterns` from COLONY_STATE.json, read activity.log
```

Rationale: `error-summary` was removed. Error records are already in COLONY_STATE.json.

**Line 85 (Step 2.5b Promote Learnings):**
Replace:
```
Otherwise: Analyze `memory.phase_learnings`, categorize as promotable vs project-specific, prompt user, run `learning-promote` for selections.
```

With:
```
Otherwise: Analyze `memory.phase_learnings`, categorize as promotable vs project-specific, and display them for user to manually incorporate into their global learnings.
```

Rationale: `learning-promote` was removed. Learnings are displayed for manual promotion rather than automated.
  </action>
  <verify>grep -n "error-summary\|learning-promote" .claude/commands/ant/continue.md</verify>
  <done>continue.md has no references to error-summary or learning-promote</done>
</task>

<task type="auto">
  <name>Task 3: Update signal schemas to TTL format</name>
  <files>.claude/commands/ant/init.md, .claude/commands/ant/continue.md</files>
  <action>
**init.md lines 82-90 (INIT signal in Step 3):**

Replace the signals array entry:
```json
"signals": [
  {
    "id": "init_<unix_timestamp>",
    "type": "INIT",
    "content": "<the user's goal>",
    "strength": 1.0,
    "half_life_seconds": null,
    "created_at": "<ISO-8601 timestamp>"
  }
],
```

With TTL schema:
```json
"signals": [
  {
    "id": "init_<unix_timestamp>",
    "type": "INIT",
    "content": "<the user's goal>",
    "priority": "high",
    "expires_at": null,
    "created_at": "<ISO-8601 timestamp>"
  }
],
```

Also update line 107 comment:
Replace: "INIT signals have no half-life (null) and persist forever."
With: "INIT signals have no expiration (expires_at: null) and persist forever."

**continue.md lines 66-67 (Step 2 auto-emit signals):**

Replace:
```
4. **Emit FEEDBACK pheromone:** `{type: "FEEDBACK", content: "<what worked/didn't>", strength: 0.5, half_life_seconds: 21600, source: "auto:continue", auto: true}`
5. **Emit REDIRECT if flagged_patterns exist:** strength 0.9, half_life 86400
```

With TTL schema:
```
4. **Emit FEEDBACK pheromone:** `{type: "FEEDBACK", content: "<what worked/didn't>", priority: "normal", expires_at: "<6 hours from now ISO-8601>", source: "auto:continue", auto: true}`
5. **Emit REDIRECT if flagged_patterns exist:** `{type: "REDIRECT", content: "<pattern to avoid>", priority: "high", expires_at: "<24 hours from now ISO-8601>", source: "auto:continue", auto: true}`
```

Priority mapping from old strength:
- strength 0.9-1.0 = high
- strength 0.4-0.8 = normal
- strength < 0.4 = low

TTL mapping from old half_life:
- 21600 seconds (6 hours) = 6 hour expires_at
- 86400 seconds (24 hours) = 24 hour expires_at
  </action>
  <verify>grep -n "priority\|expires_at\|strength\|half_life" .claude/commands/ant/init.md .claude/commands/ant/continue.md</verify>
  <done>init.md and continue.md use TTL schema (priority, expires_at) not legacy schema (strength, half_life_seconds)</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No non-existent utility calls:
   ```bash
   grep -r "activity-log-init\|error-summary\|learning-promote" .claude/commands/ant/*.md
   ```
   Should return empty (no matches).

2. No legacy signal schema:
   ```bash
   grep -r "strength.*half_life\|half_life_seconds" .claude/commands/ant/init.md .claude/commands/ant/continue.md
   ```
   Should return empty (no matches).

3. TTL schema in use:
   ```bash
   grep "priority\|expires_at" .claude/commands/ant/init.md .claude/commands/ant/continue.md
   ```
   Should show priority and expires_at fields.
</verification>

<success_criteria>
1. Zero calls to activity-log-init (use activity-log instead)
2. Zero references to error-summary (gather from COLONY_STATE.json directly)
3. Zero references to learning-promote (display for manual promotion)
4. init.md INIT signal uses priority: "high" and expires_at: null
5. continue.md FEEDBACK/REDIRECT signals use priority and expires_at timestamps
6. No references to strength or half_life_seconds in signal emissions
</success_criteria>

<output>
After completion, create `.planning/phases/40-state-utility-alignment/40-03-SUMMARY.md`
</output>
