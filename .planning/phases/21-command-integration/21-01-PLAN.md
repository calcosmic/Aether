---
phase: 21-command-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/status.md
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/init.md
autonomous: true

must_haves:
  truths:
    - "status.md instructs Claude to run pheromone-batch via Bash tool instead of computing decay inline"
    - "status.md instructs Claude to run pheromone-cleanup via Bash tool instead of manually filtering expired signals"
    - "build.md instructs Claude to run pheromone-batch via Bash tool instead of computing decay inline"
    - "build.md instructs Claude to run error-add via Bash tool instead of manually constructing error JSON"
    - "continue.md instructs Claude to run pheromone-cleanup via Bash tool instead of computing decay and filtering inline"
    - "init.md instructs Claude to run validate-state all via Bash tool after all state files are created"
  artifacts:
    - path: ".claude/commands/ant/status.md"
      provides: "Pheromone decay via pheromone-batch, cleanup via pheromone-cleanup"
      contains: "aether-utils.sh pheromone-batch"
    - path: ".claude/commands/ant/build.md"
      provides: "Pheromone decay via pheromone-batch, error logging via error-add"
      contains: "aether-utils.sh error-add"
    - path: ".claude/commands/ant/continue.md"
      provides: "Pheromone cleanup via pheromone-cleanup"
      contains: "aether-utils.sh pheromone-cleanup"
    - path: ".claude/commands/ant/init.md"
      provides: "Post-init validation via validate-state all"
      contains: "aether-utils.sh validate-state all"
  key_links:
    - from: ".claude/commands/ant/status.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool invocation of pheromone-batch and pheromone-cleanup"
      pattern: "bash .aether/aether-utils.sh pheromone-(batch|cleanup)"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool invocation of pheromone-batch and error-add"
      pattern: "bash .aether/aether-utils.sh (pheromone-batch|error-add)"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool invocation of pheromone-cleanup"
      pattern: "bash .aether/aether-utils.sh pheromone-cleanup"
    - from: ".claude/commands/ant/init.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool invocation of validate-state all"
      pattern: "bash .aether/aether-utils.sh validate-state all"
---

<objective>
Integrate aether-utils.sh into the 4 core command prompts (status.md, build.md, continue.md, init.md) so that deterministic operations -- pheromone decay math, expired signal cleanup, error logging, and state validation -- are delegated to shell calls instead of computed inline by the LLM.

Purpose: Makes pheromone math, error recording, and state validation reliable instead of LLM-approximated. Completes INT-01, INT-02, INT-03, INT-05.
Output: 4 updated command files with Bash tool invocations replacing inline computation blocks.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-command-integration/21-RESEARCH.md
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate pheromone-batch and pheromone-cleanup into status.md and build.md</name>
  <files>
    .claude/commands/ant/status.md
    .claude/commands/ant/build.md
  </files>
  <action>
**status.md -- Replace Step 2 (lines 39-46):**

Replace the inline decay formula block with:

```markdown
### Step 2: Compute Pheromone Decay

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-batch
```

This returns JSON: `{"ok":true,"result":[...signals with current_strength...]}`. Parse the `result` array. Each signal object includes a `current_strength` field with the decayed value. Signals with `current_strength < 0.05` are effectively expired.

If the command fails (file not found, invalid JSON), treat as "no active pheromones."
```

**status.md -- Replace Step 2.5 (lines 47-51):**

Replace the inline expired signal removal with:

```markdown
### Step 2.5: Clean Expired Pheromones

If any signals from Step 2 had `current_strength < 0.05`, use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-cleanup
```

This removes expired signals from `pheromones.json` and returns `{"ok":true,"result":{"removed":N,"remaining":N}}`.

If no signals are expired, skip this step.
```

Keep ALL surrounding content (Step 1, Step 3 display formatting, header, sections) IDENTICAL. Only replace the computation method in Steps 2 and 2.5. The bar rendering in Step 3 still uses `current_strength` values -- just sourced from pheromone-batch output now instead of inline math.

**build.md -- Replace Step 3 (lines 41-58):**

Replace the inline decay formula and bar rendering instructions with:

```markdown
### Step 3: Compute Active Pheromones

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-batch
```

This returns JSON: `{"ok":true,"result":[...signals with current_strength...]}`. Parse the `result` array. Filter out signals where `current_strength < 0.05`.

If the command fails, treat as "no active pheromones."

Format:

```
ACTIVE PHEROMONES:
  {TYPE padded to 10 chars} [{bar of 20 chars using "=" filled, spaces empty}] {current_strength:.2f}
    "{content}"
```

Where the bar uses `round(current_strength * 20)` filled `=` characters and spaces for the remainder.

If no active signals after filtering:
```
  (no active pheromones)
```
```

Keep ALL other steps in build.md IDENTICAL.
  </action>
  <verify>
Read status.md and confirm: (1) "bash .aether/aether-utils.sh pheromone-batch" appears in Step 2, (2) "bash .aether/aether-utils.sh pheromone-cleanup" appears in Step 2.5, (3) no inline decay formula `e^(-0.693` remains. Read build.md and confirm: (1) "bash .aether/aether-utils.sh pheromone-batch" appears in Step 3, (2) no inline decay formula remains, (3) bar rendering instructions preserved.
  </verify>
  <done>status.md delegates pheromone decay to pheromone-batch and cleanup to pheromone-cleanup. build.md delegates pheromone decay to pheromone-batch. No inline exponential decay formula remains in either file. Display formatting is unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate error-add into build.md, pheromone-cleanup into continue.md, and validate-state into init.md</name>
  <files>
    .claude/commands/ant/build.md
    .claude/commands/ant/continue.md
    .claude/commands/ant/init.md
  </files>
  <action>
**build.md -- Replace error logging in Step 6 (lines 243-295):**

Find the two blocks where errors are manually constructed as JSON (ant failure errors and watcher HIGH/CRITICAL errors). Replace the manual JSON construction with error-add calls. The replacement should be:

For the ant failure error logging block (around lines 243-258), replace with:

```markdown
**Log Errors:** If the ant reported any failures or issues in its report:

For each failure, use the Bash tool to run:
```
bash .aether/aether-utils.sh error-add "<category>" "<severity>" "<description>"
```

Where `category` is one of: syntax, import, runtime, type, spawning, phase, verification, api, file, logic, performance, security. And `severity` is one of: critical, high, medium, low.

Each call returns `{"ok":true,"result":"<error_id>"}`. Note the returned error IDs for event logging.
```

For the watcher issue error logging block (around lines 260-265), replace with:

```markdown
**Log Watcher Issues:** For each issue in the watcher report with severity `HIGH` or `CRITICAL`, use the Bash tool to run:
```
bash .aether/aether-utils.sh error-add "verification" "<severity_lowercased>" "<description>"
```
```

IMPORTANT: Keep pattern flagging inline (the "Check Pattern Flagging" block around lines 278-295). Pattern flagging stays as LLM responsibility -- `error-add` does not handle pattern detection. The LLM still reads errors.json, counts by category, and writes flagged_patterns entries.

Keep ALL other parts of Step 6 IDENTICAL (PROJECT_PLAN.json updates, COLONY_STATE.json updates, event writing, spawn outcomes, 50-entry cap note -- though note that error-add handles the 50-entry cap automatically).

Remove the manual JSON template for error records (the ```json block with id, category, severity, etc.) since error-add handles ID generation, timestamp, and atomic write.

**continue.md -- Replace Step 5 (lines 171-178):**

Replace the inline decay computation and cleanup with:

```markdown
### Step 5: Clean Expired Pheromones

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-cleanup
```

This removes signals with `current_strength` below 0.05 from `pheromones.json` and returns `{"ok":true,"result":{"removed":N,"remaining":N}}`. The cleanup result (removed count) can be mentioned in the display output.
```

Keep ALL other steps in continue.md IDENTICAL.

**init.md -- Add validation step between Step 6 and Step 7:**

After the existing Step 6 (Write Init Event) and before Step 7 (Display Result), insert a new step:

```markdown
### Step 6.5: Validate State Files

Use the Bash tool to run:
```
bash .aether/aether-utils.sh validate-state all
```

This validates all state files (COLONY_STATE.json, pheromones.json, errors.json, memory.json, events.json) and returns `{"ok":true,"result":{"pass":true|false,"files":[...]}}`.

If `pass` is false, output a warning identifying which file(s) failed validation. This catches initialization bugs immediately.
```

Also update the Step 7 step progress display to include the new step:

```
  ✓ Step 1: Validate Input
  ✓ Step 2: Read Current State
  ✓ Step 3: Write Colony State
  ✓ Step 4: Create State Files
  ✓ Step 5: Emit INIT Pheromone
  ✓ Step 6: Write Init Event
  ✓ Step 6.5: Validate State Files
  ✓ Step 7: Display Result
```
  </action>
  <verify>
Read build.md and confirm: (1) "bash .aether/aether-utils.sh error-add" appears in Step 6, (2) manual error JSON template (with id, category, severity fields) is removed, (3) pattern flagging logic is still present. Read continue.md and confirm: (1) "bash .aether/aether-utils.sh pheromone-cleanup" appears in Step 5, (2) no inline decay formula remains. Read init.md and confirm: (1) Step 6.5 exists with "bash .aether/aether-utils.sh validate-state all", (2) step progress display includes Step 6.5.
  </verify>
  <done>build.md delegates error logging to error-add (pattern flagging stays inline). continue.md delegates pheromone cleanup to pheromone-cleanup. init.md validates state files via validate-state all after initialization. No inline decay formulas or manual error JSON construction remain.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full integration:

1. Search all 4 command files for remaining inline decay formula: grep for `e\^(-0.693` or `0.693 \* elapsed` -- should return zero matches.
2. Search for manual error JSON construction in build.md: grep for `"id": "err_` template -- should be gone (error-add handles this).
3. Confirm each utility call appears:
   - `pheromone-batch` in status.md and build.md
   - `pheromone-cleanup` in status.md and continue.md
   - `error-add` in build.md
   - `validate-state all` in init.md
4. Confirm pattern flagging logic is preserved in build.md (not accidentally removed).
5. Confirm all display formatting (bars, headers, sections) is unchanged in all files.
</verification>

<success_criteria>
- status.md Step 2 calls `bash .aether/aether-utils.sh pheromone-batch` and Step 2.5 calls `pheromone-cleanup`
- build.md Step 3 calls `bash .aether/aether-utils.sh pheromone-batch`
- build.md Step 6 calls `bash .aether/aether-utils.sh error-add` for each error, with pattern flagging preserved inline
- continue.md Step 5 calls `bash .aether/aether-utils.sh pheromone-cleanup`
- init.md has Step 6.5 calling `bash .aether/aether-utils.sh validate-state all`
- No inline exponential decay formula exists in any of the 4 files
- All display formatting, headers, and non-computation content is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/21-command-integration/21-01-SUMMARY.md`
</output>
