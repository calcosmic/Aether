---
phase: 27-bug-fixes-safety-foundation
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "When a worker encounters an error, the entry in errors.json includes a phase field with the correct phase number"
    - "After a build phase executes, memory.json decisions array contains entries from that phase"
    - "When two tasks in the same phase touch the same file, the Phase Lead assigns them to the same worker"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Phase-aware error logging, decision recording, conflict prevention rule"
      contains: "CONFLICT PREVENTION RULE"
  key_links:
    - from: "build.md Step 6 error-add calls"
      to: "aether-utils.sh error-add"
      via: "4th positional argument passing current phase number"
      pattern: "error-add.*\\$.*phase"
    - from: "build.md Step 5b-post decision logging"
      to: "memory.json decisions array"
      via: "jq append with phase field"
      pattern: "decisions.*phase"
    - from: "build.md Step 5a Phase Lead prompt"
      to: "Phase Lead plan output"
      via: "CONFLICT PREVENTION RULE prompt injection"
      pattern: "CONFLICT PREVENTION RULE"
    - from: "build.md Step 5c Queen validation"
      to: "Phase Lead plan"
      via: "file overlap scan before worker execution"
      pattern: "file.*overlap"
---

<objective>
Wire three changes into build.md: pass phase numbers to error-add calls (BUG-03 wiring), add decision logging steps after plan approval and watcher verification (BUG-04), and inject conflict prevention rule into Phase Lead prompt with Queen-side validation backup (INT-02).

Purpose: build.md is the Queen's execution script. These changes ensure errors are traceable to phases, decisions are recorded during execution (not just pheromone commands), and parallel workers never conflict on the same file.
Output: Updated build.md with all three concerns integrated into existing step structure.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-bug-fixes-safety-foundation/27-RESEARCH.md
@.planning/phases/27-bug-fixes-safety-foundation/27-01-SUMMARY.md
@.claude/commands/ant/build.md
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire phase numbers to error-add calls and add decision logging (BUG-03 wiring, BUG-04)</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Make two changes to `.claude/commands/ant/build.md`:

**Change 1: Pass phase number to ALL error-add calls (BUG-03 wiring)**

In Step 6 "Record Outcome", find every occurrence of:
```
bash .aether/aether-utils.sh error-add "<category>" "<severity>" "<description>"
```

And change to:
```
bash .aether/aether-utils.sh error-add "<category>" "<severity>" "<description>" <phase_number>
```

There are two error-add call patterns in Step 6:
1. The general failure logging block (~line 409-413): Add `{phase_number}` (the phase ID from $ARGUMENTS) as 4th arg
2. The watcher issues logging block (~line 417-420): Add `{phase_number}` as 4th arg

The phase number is already available as the parsed phase ID from Step 1/Step 2 (it comes from `$ARGUMENTS`). Make sure the instruction text makes clear that the Queen should pass the current phase number being built.

Specifically, update the error-add instruction at ~line 410 from:
```
bash .aether/aether-utils.sh error-add "<category>" "<severity>" "<description>"
```
to:
```
bash .aether/aether-utils.sh error-add "<category>" "<severity>" "<description>" <phase_number>
```

And update the watcher issues error-add at ~line 419 from:
```
bash .aether/aether-utils.sh error-add "verification" "<severity_lowercased>" "<description>"
```
to:
```
bash .aether/aether-utils.sh error-add "verification" "<severity_lowercased>" "<description>" <phase_number>
```

Where `<phase_number>` refers to the current phase ID being built (from $ARGUMENTS).

**Change 2: Add decision logging steps (BUG-04)**

Insert a NEW step after Step 5b (Plan Checkpoint) and before Step 5c (Execute Plan). Call it "Step 5b-post: Record Plan Decisions". Add this markdown content:

```markdown
### Step 5b-post: Record Plan Decisions

After the plan is approved, record strategic decisions to memory.json.

Read `.aether/data/memory.json`. Synthesize 2-3 strategic decisions from the approved plan (e.g., task groupings, caste assignments, wave structure rationale, conflict prevention merges). Do NOT log every individual task assignment -- only strategic choices.

Append each decision to the `decisions` array:

```json
{
  "id": "dec_<unix_timestamp>_<4_random_hex>",
  "type": "plan",
  "content": "<strategic decision -- e.g. 'Grouped tasks 3.1+3.2 to single builder because both modify routes/index.ts'>",
  "context": "Phase <id> plan -- <brief plan summary>",
  "phase": <current_phase_number>,
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `decisions` array exceeds 30 entries, remove the oldest entries to keep only 30.

Write the updated memory.json.
```

Also insert a decision logging instruction after Step 5.5 (Watcher Verification), before Step 6. Add this content after the "Store the watcher's report" sentence at the end of Step 5.5:

```markdown
**Record Quality Decision:** Read `.aether/data/memory.json` (if not already in memory). Append a quality decision to the `decisions` array:

```json
{
  "id": "dec_<unix_timestamp>_<4_random_hex>",
  "type": "quality",
  "content": "<watcher verdict -- e.g. 'Phase 3 approved at 7/10, deferred 2 medium issues to tech debt'>",
  "context": "Phase <id> watcher verification",
  "phase": <current_phase_number>,
  "timestamp": "<ISO-8601 UTC>"
}
```

Cap at 30 entries (remove oldest if exceeded). Write updated memory.json.
```

Do NOT change the step numbering of existing steps (Step 5c remains Step 5c, Step 6 remains Step 6).
  </action>
  <verify>
Read the modified build.md and verify:
1. All `error-add` calls in Step 6 include a 4th argument for phase number
2. Step 5b-post exists between Step 5b and Step 5c with decision logging instructions
3. Step 5.5 includes the quality decision recording instruction
4. The decision JSON schema includes `"phase": <current_phase_number>` field
5. The 30-entry cap instruction is present in both decision logging locations
  </verify>
  <done>
All error-add calls in build.md pass the current phase number as 4th argument. Decision logging happens at two points: after plan approval (strategic decisions) and after watcher verification (quality decisions). Both respect the 30-entry cap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conflict prevention rule to Phase Lead prompt with Queen-side backup (INT-02)</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Make two changes to `.claude/commands/ant/build.md` for same-file conflict prevention:

**Change 1: Add conflict prevention rule to Phase Lead prompt (Step 5a)**

In Step 5a, find the line `Available worker castes:` in the Phase Lead prompt (around line 181). BEFORE the "Available worker castes:" line, insert this block:

```
--- CONFLICT PREVENTION RULE ---
CRITICAL: Tasks that modify the SAME FILE must be assigned to the SAME WORKER.

Before creating your plan:
1. For each task, identify which files it will likely create or modify
2. If two tasks reference the same file path, they MUST go to the same worker in the same wave
3. If unsure about file overlap, group tasks conservatively (same worker)

This prevents parallel write conflicts where one builder overwrites another's work.

Example:
  Task 3.1: Add auth routes to src/routes/index.ts
  Task 3.2: Add API routes to src/routes/index.ts
  -> Both touch src/routes/index.ts -> assign to SAME builder-ant

  Task 3.3: Create middleware at src/middleware/auth.ts
  -> Different file -> can go to a different builder-ant

```

Place this AFTER the `--- CASTE SENSITIVITY TABLE ---` section and BEFORE the `Available worker castes:` line.

**Change 2: Add Queen-side file overlap validation in Step 5c**

In Step 5c "Execute Plan", find the instruction "**2. Parse the plan:**" (around line 240). After the parse instruction and before "**3. Initialize counters:**", insert a new validation step:

```markdown
**2b. Validate file overlap (Queen backup check):**

Before executing workers, scan the parsed plan for file conflicts. For each pair of worker assignments in the SAME wave:
1. Extract file paths mentioned in their task descriptions (look for paths like `src/...`, `*.ts`, `*.js`, etc.)
2. If two workers in the same wave reference the same file path, MERGE those task assignments into a single worker
3. Log the merge: `bash .aether/aether-utils.sh activity-log "MERGE" "queen" "Merged tasks for {worker_a} and {worker_b}: shared file {filepath}"`

This is a backup check. If the Phase Lead followed the CONFLICT PREVENTION RULE correctly, no merges will be needed. But LLM instruction following is probabilistic, so the Queen validates.
```

Do NOT renumber existing steps. Keep Step 5c numbering intact -- this is sub-step 2b within Step 5c.
  </action>
  <verify>
Read the modified build.md and verify:
1. The CONFLICT PREVENTION RULE block appears in the Phase Lead prompt (Step 5a), between the caste sensitivity table and "Available worker castes:"
2. The rule includes the example with tasks 3.1/3.2/3.3 showing same-file grouping
3. Step 5c contains a "2b. Validate file overlap" sub-step between "2. Parse the plan" and "3. Initialize counters"
4. The Queen backup check includes the activity-log merge logging command
5. No existing step numbers or content were removed
  </verify>
  <done>
Phase Lead prompt includes CONFLICT PREVENTION RULE with clear examples. Queen has backup validation in Step 5c that scans for file overlap between same-wave workers and merges if needed. Two-layer defense is in place.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Read build.md and search for all `error-add` calls -- every one in Step 6 must have a 4th `<phase_number>` argument
2. Verify Step 5b-post exists with decision logging JSON schema containing `"phase"` field
3. Verify Step 5.5 contains quality decision recording with `"phase"` field
4. Verify "CONFLICT PREVENTION RULE" text appears in Step 5a Phase Lead prompt
5. Verify Step 5c contains "2b. Validate file overlap" Queen backup check
6. Count total lines in build.md -- should be ~750-780 lines (was 663, adding ~90-120 lines of new content)
</verification>

<success_criteria>
- BUG-03 wiring: Every error-add call in build.md passes phase number. When a worker hits an error during Phase 5, the error entry in errors.json will have `"phase": 5` instead of `"phase": null`.
- BUG-04: memory.json decisions array gets populated during build execution. Two logging points: post-plan-approval (strategic) and post-watcher (quality). 2-3 decisions per phase, 30-entry cap.
- INT-02: Phase Lead is instructed to group same-file tasks to same worker. Queen validates before spawning and merges if Phase Lead missed an overlap.
</success_criteria>

<output>
After completion, create `.planning/phases/27-bug-fixes-safety-foundation/27-02-SUMMARY.md`
</output>
