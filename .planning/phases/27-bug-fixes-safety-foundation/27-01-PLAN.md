---
phase: 27-bug-fixes-safety-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "A FOCUS pheromone emitted 30 minutes ago shows lower effective strength than when emitted"
    - "Pheromone decay math produces monotonically decreasing values for any positive elapsed time"
    - "After running 3 phases, activity.log contains entries from all 3 phases"
    - "error-add accepts an optional 4th argument for phase number and stores it correctly"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "Fixed pheromone-decay, pheromone-batch, pheromone-cleanup, activity-log-init, error-add"
      contains: "max.*elapsed.*0"
  key_links:
    - from: "pheromone-decay"
      to: "jq exp()"
      via: "three defensive guards: clamp elapsed >= 0, skip if > 10 half-lives, cap at initial strength"
      pattern: "max.*0.*\\$elapsed"
    - from: "activity-log-init"
      to: "activity.log"
      via: "cp (archive) + >> (append header) instead of mv + > (truncate)"
      pattern: ">>"
    - from: "error-add"
      to: "errors.json"
      via: "optional 4th positional arg parsed as phase number"
      pattern: "phase_val.*4.*null"
---

<objective>
Fix three critical bugs in aether-utils.sh: pheromone decay math that grows instead of decaying (BUG-01), activity log that overwrites instead of appending across phases (BUG-02), and error entries missing phase attribution (BUG-03).

Purpose: These are foundation fixes -- every subsequent v4.4 feature depends on correct pheromone signals, persistent activity history, and phase-attributed errors.
Output: Patched aether-utils.sh with defensive decay guards, append-mode activity logging, and phase-aware error-add.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-bug-fixes-safety-foundation/27-RESEARCH.md
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add defensive guards to pheromone decay math (BUG-01)</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Modify THREE subcommands in `.aether/aether-utils.sh` to add defensive decay guards. The root cause is that negative elapsed time (from future timestamps or clock drift) flips the exponential decay into exponential growth.

**1. `pheromone-decay` (lines 44-48):** Replace the existing jq expression with:
```bash
pheromone-decay)
  [[ $# -ge 3 ]] || json_err "Usage: pheromone-decay <strength> <elapsed_seconds> <half_life>"
  json_ok "$(jq -n --arg s "$1" --arg e "$2" --arg h "$3" '
    ($s|tonumber) as $strength |
    ([$e|tonumber, 0] | max) as $elapsed |
    ($h|tonumber) as $half_life |
    if $elapsed > ($half_life * 10) then
      {strength: 0}
    else
      ($strength * ((-0.693147180559945 * $elapsed / $half_life) | exp)) as $decayed |
      {strength: ([$decayed, $strength] | min | . * 1000000 | round / 1000000)}
    end
  ')"
  ;;
```
Three guards:
- Guard 1: `max(elapsed, 0)` -- clamp negative elapsed to zero
- Guard 2: `elapsed > half_life * 10` -> return 0 (skip computation for very old signals)
- Guard 3: `min(decayed, strength)` -- cap result at initial strength (belt-and-suspenders)

**2. `pheromone-batch` (lines 54-62):** Replace the jq expression with:
```bash
pheromone-batch)
  [[ -f "$DATA_DIR/pheromones.json" ]] || json_err "pheromones.json not found"
  now=$(date -u +%s)
  json_ok "$(jq --arg now "$now" '.signals | map(. + {
    current_strength: (
      if .half_life_seconds == null then .strength
      else
        (($now|tonumber) - (.created_at | sub("\\.[0-9]+Z$";"Z") | fromdate)) as $elapsed |
        if $elapsed < 0 then .strength
        elif $elapsed > (.half_life_seconds * 10) then 0
        else
          (.strength * ((-0.693147180559945 * $elapsed / .half_life_seconds) | exp)) as $d |
          if $d > .strength then .strength else $d end
        end
      end | . * 1000 | round / 1000)
  })' "$DATA_DIR/pheromones.json")" || json_err "Failed to read pheromones.json"
  ;;
```

**3. `pheromone-cleanup` (lines 64-75):** Replace the jq filter with guarded version:
```bash
pheromone-cleanup)
  [[ -f "$DATA_DIR/pheromones.json" ]] || json_err "pheromones.json not found"
  now=$(date -u +%s)
  before=$(jq '.signals | length' "$DATA_DIR/pheromones.json")
  result=$(jq --arg now "$now" '.signals |= map(select(
    .half_life_seconds == null or
    (
      (($now|tonumber) - (.created_at | sub("\\.[0-9]+Z$";"Z") | fromdate)) as $elapsed |
      if $elapsed < 0 then true
      elif $elapsed > (.half_life_seconds * 10) then false
      else
        (.strength * ((-0.693147180559945 * $elapsed / .half_life_seconds) | exp)) >= 0.05
      end
    )
  ))' "$DATA_DIR/pheromones.json") || json_err "Failed to process pheromones.json"
  atomic_write "$DATA_DIR/pheromones.json" "$result"
  after=$(echo "$result" | jq '.signals | length')
  json_ok "{\"removed\":$((before - after)),\"remaining\":$after}"
  ;;
```

Do NOT change any other subcommands. Do NOT change json_ok, json_err, or the dispatch structure.
  </action>
  <verify>
Run these bash commands to verify decay guards work:

```bash
# Test 1: Normal decay -- strength should decrease
bash .aether/aether-utils.sh pheromone-decay 1.0 1800 3600
# Expected: strength ~0.707 (half-life 3600s, 1800s elapsed = half decay)

# Test 2: Negative elapsed -- strength should NOT exceed initial
bash .aether/aether-utils.sh pheromone-decay 0.7 -500 3600
# Expected: strength 0.7 (clamped, not grown)

# Test 3: Very old signal -- should be zero
bash .aether/aether-utils.sh pheromone-decay 1.0 100000 3600
# Expected: strength 0 (elapsed > 10 * half_life)

# Test 4: Zero elapsed -- strength unchanged
bash .aether/aether-utils.sh pheromone-decay 0.5 0 3600
# Expected: strength 0.5
```

All four tests must produce expected results. Test 2 is the critical regression test for the original bug.
  </verify>
  <done>
pheromone-decay with negative elapsed returns initial strength (not grown). pheromone-decay with positive elapsed returns lower strength. pheromone-batch and pheromone-cleanup have matching guards. No existing tests broken.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix activity log append and error-add phase attribution (BUG-02, BUG-03)</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Modify TWO subcommands in `.aether/aether-utils.sh`:

**1. `activity-log-init` (lines 236-250):** Replace with append-mode logic:
```bash
activity-log-init)
  phase_num="${1:-}"
  phase_name="${2:-}"
  [[ -z "$phase_num" ]] && json_err "Usage: activity-log-init <phase_num> [phase_name]"
  log_file="$DATA_DIR/activity.log"
  archive_file="$DATA_DIR/activity-phase-${phase_num}.log"
  # Copy current log to per-phase archive (preserve combined log intact)
  if [ -f "$log_file" ] && [ -s "$log_file" ]; then
    # Handle retry scenario: don't overwrite existing archive
    if [ -f "$archive_file" ]; then
      archive_file="$DATA_DIR/activity-phase-${phase_num}-$(date -u +%s).log"
    fi
    cp "$log_file" "$archive_file"
  fi
  # Append phase header to combined log (NOT truncate)
  ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  echo "" >> "$log_file"
  echo "# Phase $phase_num: ${phase_name:-unnamed} -- $ts" >> "$log_file"
  archived_flag="false"
  [ -f "$archive_file" ] && archived_flag="true"
  json_ok "{\"archived\":$archived_flag}"
  ;;
```

Key changes from current code:
- `mv` replaced with `cp` (preserve combined log, create archive copy)
- `>` (truncate) replaced with `>>` (append) for writing the phase header
- Added retry-safe archive naming (timestamp suffix if archive already exists)
- After 3 phases, `activity.log` contains all entries from all 3 phases

**2. `error-add` (lines 180-191):** Add optional 4th parameter for phase number:
```bash
error-add)
  [[ $# -ge 3 ]] || json_err "Usage: error-add <category> <severity> <description> [phase]"
  [[ -f "$DATA_DIR/errors.json" ]] || json_err "errors.json not found"
  id="err_$(date -u +%s)_$(head -c 2 /dev/urandom | od -An -tx1 | tr -d ' ')"
  ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  phase_val="${4:-null}"
  if [[ "$phase_val" =~ ^[0-9]+$ ]]; then
    phase_jq="$phase_val"
  else
    phase_jq="null"
  fi
  updated=$(jq --arg id "$id" --arg cat "$1" --arg sev "$2" --arg desc "$3" --argjson phase "$phase_jq" --arg ts "$ts" '
    .errors += [{id:$id, category:$cat, severity:$sev, description:$desc, root_cause:null, phase:$phase, task_id:null, timestamp:$ts}] |
    if (.errors|length) > 50 then .errors = .errors[-50:] else . end
  ' "$DATA_DIR/errors.json") || json_err "Failed to update errors.json"
  atomic_write "$DATA_DIR/errors.json" "$updated"
  json_ok "\"$id\""
  ;;
```

Key changes from current code:
- Usage string updated to show optional `[phase]` parameter
- New `phase_val` variable captures 4th arg (defaults to `null`)
- Regex check `^[0-9]+$` ensures phase is a number before passing to jq
- `--argjson phase "$phase_jq"` passes as number (not string) to jq
- Backward compatible: existing 3-arg calls still work (phase defaults to null)

Do NOT change the help subcommand's command list. Do NOT modify error-pattern-check or error-summary.
  </action>
  <verify>
Run these bash commands to verify:

```bash
# Test activity-log-init: create a fake log, then init a new phase
echo "[10:00:00] START builder-ant: test task" > .aether/data/activity.log
bash .aether/aether-utils.sh activity-log-init 2 "test-phase"
# Verify combined log has BOTH the old entry and new phase header
cat .aether/data/activity.log
# Expected: contains "[10:00:00] START builder-ant: test task" AND "# Phase 2: test-phase"

# Test error-add with phase:
bash .aether/aether-utils.sh error-add "syntax" "high" "test error" 3
# Expected: {"ok":true,"result":"err_..."}
# Verify phase is stored as number 3 (not string, not null):
jq '.errors[-1].phase' .aether/data/errors.json
# Expected: 3

# Test error-add backward compatibility (no phase):
bash .aether/aether-utils.sh error-add "syntax" "low" "test no phase"
# Expected: {"ok":true,"result":"err_..."}
jq '.errors[-1].phase' .aether/data/errors.json
# Expected: null
```
  </verify>
  <done>
activity-log-init appends phase headers instead of truncating (combined log preserves all phases). error-add accepts optional 4th arg for phase number, stores as number in JSON, defaults to null for backward compatibility.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run `bash .aether/aether-utils.sh pheromone-decay 0.7 -500 3600` -- result must be `{"strength":0.7}` (not grown)
2. Run `bash .aether/aether-utils.sh pheromone-decay 1.0 1800 3600` -- result must show strength < 1.0
3. Simulate 3-phase activity log init and verify all entries preserved in activity.log
4. Run `bash .aether/aether-utils.sh error-add "test" "low" "desc" 5` and verify phase=5 in errors.json
5. Run `bash .aether/aether-utils.sh error-add "test" "low" "desc"` and verify phase=null (backward compat)
6. Run `bash .aether/aether-utils.sh version` to confirm script still loads without syntax errors
</verification>

<success_criteria>
- BUG-01: Pheromone decay NEVER produces strength > initial value. Three guards present in pheromone-decay, pheromone-batch, pheromone-cleanup.
- BUG-02: activity.log contains entries from ALL phases after multi-phase execution. No truncation at phase boundaries.
- BUG-03: error-add accepts optional phase parameter. Phase stored as number in errors.json. Backward compatible with 3-arg calls.
</success_criteria>

<output>
After completion, create `.planning/phases/27-bug-fixes-safety-foundation/27-01-SUMMARY.md`
</output>
