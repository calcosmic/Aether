---
phase: 31-architecture-evolution
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
  - .aether/workers/builder-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/architect-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "Workers can signal sub-spawn needs via SPAWN REQUEST blocks in their output"
    - "Queen parses SPAWN REQUEST blocks and spawns sub-workers after wave completes"
    - "Depth-2 workers are told they cannot sub-spawn and Queen ignores any SPAWN REQUEST from them"
    - "Delegation tree is displayed visually in build output with parent-child relationships"
    - "spawn_tree is recorded in COLONY_STATE.json tracking parent-child delegation chains"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Queen-mediated spawn tree engine in Step 5c"
      contains: "SPAWN REQUEST"
    - path: ".aether/workers/builder-ant.md"
      provides: "Updated spawn instructions with SPAWN REQUEST format"
      contains: "Requesting Sub-Spawns"
    - path: ".aether/aether-utils.sh"
      provides: "Updated spawn-check with max_depth 2 and validate-state with spawn_tree"
      contains: "max_depth.*2"
  key_links:
    - from: ".aether/workers/builder-ant.md"
      to: ".claude/commands/ant/build.md"
      via: "SPAWN REQUEST output parsed by Queen"
      pattern: "SPAWN REQUEST"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "spawn_tree write after sub-spawn fulfillment"
      pattern: "spawn_tree"
---

<objective>
Implement the Queen-mediated spawn tree engine and update all worker specs.

Purpose: ARCH-02 requires hierarchical task delegation. Claude Code's platform constraint prevents subagents from spawning subagents directly (Task tool unavailable to subagents). The solution is Queen-mediated delegation: workers signal sub-spawn needs via structured SPAWN REQUEST output, the Queen parses these after each wave, and spawns sub-workers directly. The delegation chain is recorded in COLONY_STATE.json spawn_tree and displayed visually. All 6 worker specs must be updated to replace the stale "You Can Spawn Other Ants" section with the new "Requesting Sub-Spawns" pattern and correct depth limits (max 2, not 3).

Output: Modified build.md with spawn tree engine, all 6 updated worker specs, and updated aether-utils.sh (spawn-check depth limit + validate-state spawn_tree).
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-architecture-evolution/31-CONTEXT.md
@.planning/phases/31-architecture-evolution/31-RESEARCH.md
@.claude/commands/ant/build.md
@.aether/workers/builder-ant.md
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spawn tree engine to build.md</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Read `.claude/commands/ant/build.md`. Make the following targeted modifications. Keep additions concise (~40-50 lines total) to avoid pushing build.md past effective length limits.

**1. Add SPAWN REQUEST parsing after Step 5c.e (worker return):**

After the existing step e (worker returns, logs COMPLETE/ERROR, displays summary), add a new sub-step **e2**:

```markdown
e2. **Parse SPAWN requests from worker output:**
    If the worker's result text contains one or more `SPAWN REQUEST:` blocks:
    For each SPAWN REQUEST block, extract: caste, reason, task, context, files.

    Validate depth: The current worker is at depth 1 (spawned by Queen).
    Sub-spawn would be depth 2 -- ALLOWED (max depth is 2).

    Queue each valid request for post-wave fulfillment:
    ```
    queued_sub_spawns.append({
      parent_id: "<wave>_<caste>_<index>",
      caste: <requested_caste>,
      task: <requested_task>,
      context: <context_from_request>,
      files: <files_from_request>,
      parent_pheromone_context: <pheromone block for parent worker>
    })
    ```

    Cap: Maximum 2 sub-spawns per wave. If more requested, take the first 2 and log:
    ```
    bash .aether/aether-utils.sh activity-log "SKIP" "queen" "Excess SPAWN REQUEST ignored (cap 2/wave)"
    ```
```

**2. Add post-wave sub-spawn fulfillment step:**

After step i (Post-Wave Advisory Review) and before the loop continues to the next wave, add a new sub-step **j**:

```markdown
j. **Fulfill SPAWN requests from this wave:**

   If `queued_sub_spawns` is empty for this wave: skip to next wave.

   For each queued sub-spawn:

   1. Record in spawn_tree (will be written to COLONY_STATE.json in Step 6):
      ```
      spawn_tree[sub_worker_id] = {
        id: "<phase>_sub_<caste>_<index>",
        caste: requested_caste,
        task: requested_task,
        depth: 2,
        parent: parent_id,
        children: [],
        status: "pending",
        phase: current_phase_number,
        wave: current_wave_number
      }
      ```
      Also add sub_worker_id to parent's `children` array in spawn_tree.

   2. Log sub-spawn:
      ```
      bash .aether/aether-utils.sh activity-log "SPAWN" "queen" "sub-{caste}-ant for: {task} (requested by {parent_id})"
      ```

   3. Display sub-spawn announcement using Bash tool:
      ```
      bash -c 'printf "  \e[{caste_color}m%-14s\e[0m %s (sub-spawn for %s)\n" "[SUB-{CASTE}]" "{task}" "{parent_id}"'
      ```

   4. Read the caste's spec file. Spawn via Task tool with `subagent_type="general-purpose"`:
      ```
      --- WORKER SPEC ---
      {full contents of the caste's spec file}

      --- ACTIVE PHEROMONES ---
      {pheromone block from Step 3}

      --- PARENT CONTEXT ---
      Parent worker: {parent caste} - {parent task}
      Parent pheromone context (FOCUS/REDIRECT): {inherited from parent}

      --- TASK ---
      {sub-task from SPAWN REQUEST}

      You are at depth 2. You CANNOT request further sub-spawns.
      If you need additional work done, handle it inline.
      ```

   5. After sub-worker returns:
      - Update spawn_tree entry: status -> "completed" or "failed"
      - Log: `bash .aether/aether-utils.sh activity-log "COMPLETE" "sub-{caste}-ant" "{task}"`
      - Display completion:
        ```
        bash -c 'printf "  \e[{caste_color}m%-14s\e[0m %s ... \e[32mCOMPLETE\e[0m\n" "[SUB-{CASTE}]" "{task}"'
        ```
```

**3. Add spawn_tree initialization:**

In Step 5c, after "3. Initialize counters:" add:
```
Initialize spawn_tree: `spawn_tree = {}`. Also initialize: `queued_sub_spawns = []` (reset per wave).
```

**4. Record spawn_tree in Step 6 (Record Outcome):**

In Step 6, in the COLONY_STATE.json update section, add:
```
- If `spawn_tree` is not empty, write `spawn_tree` to COLONY_STATE.json
- If `spawn_tree` is empty, write `spawn_tree: {}` to COLONY_STATE.json
```

Also ensure depth-1 workers are recorded in spawn_tree. After Step 5c.d (spawn worker), add each depth-1 worker to spawn_tree:
```
spawn_tree[worker_id] = {
  id: "<phase>_wave<N>_<caste><index>",
  caste: caste,
  task: task_description,
  depth: 1,
  parent: "queen",
  children: [],
  status: "pending",
  phase: current_phase_number,
  wave: current_wave_number
}
```
Update status to "completed" or "failed" in step e based on worker result.

**5. Add Delegation Tree visual to Step 7e (Display Results):**

In Step 7e, after the "Colony Activity:" section, add a delegation tree display:

```markdown
Display the Delegation Tree header using Bash tool (bold yellow):
```
bash -c 'printf "\n\e[1;33mDelegation Tree:\e[0m\n"'
bash -c 'printf "  \e[1;33mQueen\e[0m\n"'
```

For each entry in spawn_tree where depth == 1:
```
bash -c 'printf "  ‚îú‚îÄ‚îÄ \e[{caste_color}m%s\e[0m: %s [\e[32m%s\e[0m]\n" "{caste}" "{task}" "{status}"'
```
For each child of that entry (depth == 2):
```
bash -c 'printf "  ‚îÇ   ‚îî‚îÄ‚îÄ \e[{caste_color}m%s\e[0m (sub): %s [\e[32m%s\e[0m]\n" "{caste}" "{task}" "{status}"'
```

If spawn_tree is empty, display:
```
bash -c 'printf "  (no delegation -- all tasks handled directly)\n"'
```

**6. Update Step 7e progress checklist:**

Add after "Step 5c: Execute Workers":
```
  ‚úì Step 5c.j: Fulfill Sub-Spawns
```

**Important constraints:**
- Keep total additions to build.md under 50 lines of new content
- Do NOT restructure existing steps -- only insert new sub-steps
- The spawn tree engine is a post-wave step, keeping the core execution loop unchanged
- Depth-2 worker prompts MUST include "You are at depth 2. You CANNOT request further sub-spawns."
  </action>
  <verify>
Read build.md and verify:
1. Step 5c.e2 exists (SPAWN REQUEST parsing)
2. Step 5c.j exists (post-wave sub-spawn fulfillment)
3. spawn_tree initialization in Step 5c
4. spawn_tree recording in Step 6
5. Delegation Tree visual in Step 7e
6. Depth-2 prompt includes "You CANNOT request further sub-spawns"
7. Sub-spawn cap of 2 per wave is documented
8. Total build.md line count is under ~1100 lines
  </verify>
  <done>
build.md has the complete Queen-mediated spawn tree engine. Workers' SPAWN REQUEST output is parsed after each worker returns, sub-spawns are fulfilled between waves, spawn_tree is recorded in COLONY_STATE.json, and delegation tree is displayed visually with ANSI colors in the build output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all worker specs and aether-utils.sh spawn-check/validate-state</name>
  <files>
    .aether/workers/builder-ant.md
    .aether/workers/watcher-ant.md
    .aether/workers/colonizer-ant.md
    .aether/workers/scout-ant.md
    .aether/workers/architect-ant.md
    .aether/workers/route-setter-ant.md
    .aether/aether-utils.sh
  </files>
  <action>
**Part A: Update all 6 worker specs**

For each of the 6 worker spec files in `.aether/workers/`:
- builder-ant.md
- watcher-ant.md
- colonizer-ant.md
- scout-ant.md
- architect-ant.md
- route-setter-ant.md

Read each file and replace the **"## You Can Spawn Other Ants"** section (from the heading through the end of the "Spawn limits" note, including the Spawn Gate, Spawn Confidence Check, Spawning Scenario subsections, and the spawn limits bullet list) with the following new section:

```markdown
## Requesting Sub-Spawns

If you encounter a sub-task that is genuinely INDEPENDENT from your main task and would benefit from a separate specialist worker, include a SPAWN REQUEST block in your output:

```
SPAWN REQUEST:
  caste: builder-ant
  reason: "Need to implement auth middleware separately from routes"
  task: "Create src/middleware/auth.ts with JWT validation logic"
  context: "Parent task is implementing auth routes. Middleware is independent."
  files: ["src/middleware/auth.ts"]
```

The Queen will read your SPAWN REQUEST and spawn a sub-worker on your behalf after the current wave completes.

**Rules:**
- Only use SPAWN REQUEST for truly independent sub-tasks you CANNOT handle inline
- If you can handle the task yourself, DO handle it yourself
- Maximum 1-2 SPAWN REQUESTs per worker -- do not fragment your work
- You are at depth {your_depth}. If your depth is 2, you CANNOT include SPAWN REQUESTs -- handle everything inline
- The sub-worker will inherit your pheromone context (FOCUS/REDIRECT)

**Available castes to request:**
- `builder-ant` -- Implement code, run commands
- `watcher-ant` -- Test, validate, quality check
- `colonizer-ant` -- Explore and index codebase
- `scout-ant` -- Research, find information
- `architect-ant` -- Synthesize knowledge, extract patterns
- `route-setter-ant` -- Plan and break down work

**Spawn limits:**
- Max depth 2 (Queen -> you -> sub-worker via Queen, no deeper)
- Maximum 2 sub-spawns per wave (enforced by Queen)
- If you are at depth 2, any SPAWN REQUEST will be ignored by the Queen
```

Also update the **Post-Action Validation** section in each worker spec. Find the line that shows spawns/depth and update the max depth from 3 to 2:

Change:
```
  üêú Spawns: {N}/5 (depth {your_depth}/3)
```
To:
```
  üêú Spawns: {N}/5 (depth {your_depth}/2)
```

**Part B: Update aether-utils.sh spawn-check**

Read `.aether/aether-utils.sh`. Find the `spawn-check)` case. Update:

1. Change `max_depth: 3` to `max_depth: 2`
2. Change the pass condition from `$depth < 3` to `$depth < 2` (depth 1 workers CAN sub-spawn, depth 2 workers CANNOT)
3. Change the depth_limit check from `$depth >= 3` to `$depth >= 2`

The updated spawn-check should be:
```bash
spawn-check)
  depth="${1:-1}"
  [[ -f "$DATA_DIR/COLONY_STATE.json" ]] || json_err "COLONY_STATE.json not found"
  json_ok "$(jq --arg d "$depth" '
    (.workers | to_entries | map(select(.value != "idle")) | length) as $active |
    ($d | tonumber) as $depth |
    {
      pass: ($active < 5 and $depth < 2),
      active_workers: $active,
      max_workers: 5,
      current_depth: $depth,
      max_depth: 2
    } | if .pass == false then
      . + {reason: (if $active >= 5 then "worker_limit" elif $depth >= 2 then "depth_limit" else "unknown" end)}
    else . end
  ' "$DATA_DIR/COLONY_STATE.json")"
  ;;
```

**Part C: Update aether-utils.sh validate-state colony**

Read `.aether/aether-utils.sh`. Find the `validate-state` -> `colony)` case. Add an optional spawn_tree check that passes if spawn_tree is missing (backward compatibility) but validates structure if present.

Update the colony validation jq expression to add a spawn_tree check:

```jq
def chk(f;t): if has(f) then (if (.[f]|type) as $a | t | any(. == $a) then "pass" else "fail: \(f) is \(.[f]|type), expected \(t|join("|"))" end) else "fail: missing \(f)" end;
def opt(f;t): if has(f) then (if (.[f]|type) as $a | t | any(. == $a) then "pass" else "fail: \(f) is \(.[f]|type), expected \(t|join("|"))" end) else "pass" end;
{file:"COLONY_STATE.json", checks:[
  chk("goal";["null","string"]),
  chk("state";["string"]),
  chk("current_phase";["number"]),
  chk("workers";["object"]),
  chk("spawn_outcomes";["object"]),
  opt("spawn_tree";["object"])
]} | . + {pass: ([.checks[] | select(. == "pass")] | length) == (.checks | length)}
```

The `opt` function passes when the field is absent (backward compat) but validates type when present.
  </action>
  <verify>
1. Read each of the 6 worker specs and verify:
   - "You Can Spawn Other Ants" section is gone
   - "Requesting Sub-Spawns" section is present
   - SPAWN REQUEST format example is included
   - Max depth references say 2 (not 3)
   - Post-Action Validation shows depth X/2 (not X/3)

2. Run: `bash .aether/aether-utils.sh spawn-check 1` -- should return pass:true (depth 1 can sub-spawn)
3. Run: `bash .aether/aether-utils.sh spawn-check 2` -- should return pass:false, reason:depth_limit (depth 2 cannot sub-spawn)
4. Run: `bash .aether/aether-utils.sh validate-state colony` -- should still pass (spawn_tree is optional)
  </verify>
  <done>
All 6 worker specs updated with Requesting Sub-Spawns section (SPAWN REQUEST output format, max depth 2, rules for when to sub-spawn). spawn-check enforces depth limit of 2. validate-state accepts optional spawn_tree field. No worker spec references max depth 3 anymore.
  </done>
</task>

</tasks>

<verification>
1. build.md contains spawn tree engine (SPAWN REQUEST parsing, sub-spawn fulfillment, spawn_tree recording, delegation tree visual)
2. All 6 worker specs have "Requesting Sub-Spawns" section, not "You Can Spawn Other Ants"
3. No file in .aether/workers/ references "Max depth 3"
4. spawn-check returns pass:false for depth >= 2
5. validate-state colony accepts optional spawn_tree field
6. Delegation tree visual in Step 7e shows parent-child relationships with ANSI colors
7. Depth-2 workers receive "You CANNOT request further sub-spawns" in their prompt
</verification>

<success_criteria>
- Workers signal sub-spawn needs via SPAWN REQUEST blocks in output
- Queen parses SPAWN REQUESTs and spawns sub-workers between waves (max 2 per wave)
- spawn_tree recorded in COLONY_STATE.json with parent-child-depth structure
- Depth enforcement: depth-2 workers told they cannot sub-spawn, Queen ignores their requests
- Delegation tree displayed in build output with ANSI colors
- All 6 worker specs consistently reference depth 2 limit and SPAWN REQUEST format
- spawn-check and validate-state updated for new depth limits and spawn_tree field
</success_criteria>

<output>
After completion, create `.planning/phases/31-architecture-evolution/31-03-SUMMARY.md`
</output>
