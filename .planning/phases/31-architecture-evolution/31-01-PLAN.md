---
phase: 31-architecture-evolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "User can promote project learnings to global tier at end-of-project"
    - "Global learnings file exists at ~/.aether/learnings.json after first promotion"
    - "50-entry cap is enforced on global learnings"
    - "Auto-continue mode skips promotion (no blocking on interactive input)"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "learning-promote subcommand"
      contains: "learning-promote"
    - path: ".claude/commands/ant/continue.md"
      provides: "Learning promotion UX at project completion"
      contains: "Promote Learnings"
  key_links:
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/aether-utils.sh"
      via: "learning-promote subcommand call"
      pattern: "aether-utils\\.sh learning-promote"
    - from: ".aether/aether-utils.sh"
      to: "~/.aether/learnings.json"
      via: "mkdir -p + file creation"
      pattern: "global_dir.*HOME.*\\.aether"
---

<objective>
Add the global learnings file management infrastructure and promotion UX.

Purpose: ARCH-01 requires a two-tier learning system. This plan creates the foundation -- the `learning-promote` subcommand in aether-utils.sh that manages ~/.aether/learnings.json (creating the directory and file on first use, enforcing the 50-entry cap), and the promotion UX in continue.md Step 2.5 that presents project learnings and lets the user choose which to promote at end-of-project.

Output: Two modified files -- aether-utils.sh with `learning-promote` and `learning-inject` subcommands, and continue.md with the promotion flow added after the tech debt report.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-architecture-evolution/31-CONTEXT.md
@.planning/phases/31-architecture-evolution/31-RESEARCH.md
@.aether/aether-utils.sh
@.claude/commands/ant/continue.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add learning-promote and learning-inject subcommands to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Read `.aether/aether-utils.sh`. Add two new subcommands before the `*)` catch-all case at the end of the case statement. Also update the `help` command's JSON to include the two new subcommands in the commands array.

**Subcommand 1: `learning-promote`**

Add the following case block:

```bash
learning-promote)
  [[ $# -ge 3 ]] || json_err "Usage: learning-promote <content> <source_project> <source_phase> [tags]"
  content="$1"
  source_project="$2"
  source_phase="$3"
  tags="${4:-}"

  global_dir="$HOME/.aether"
  global_file="$global_dir/learnings.json"
  mkdir -p "$global_dir"

  if [[ ! -f "$global_file" ]]; then
    echo '{"learnings":[],"version":1}' > "$global_file"
  fi

  id="global_$(date -u +%s)_$(head -c 2 /dev/urandom | od -An -tx1 | tr -d ' ')"
  ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  if [[ -n "$tags" ]]; then
    tags_json=$(echo "$tags" | jq -R 'split(",")')
  else
    tags_json="[]"
  fi

  current_count=$(jq '.learnings | length' "$global_file")
  if [[ $current_count -ge 50 ]]; then
    json_ok "{\"promoted\":false,\"reason\":\"cap_reached\",\"current_count\":$current_count,\"cap\":50}"
    exit 0
  fi

  updated=$(jq --arg id "$id" --arg content "$content" --arg sp "$source_project" \
    --argjson phase "$source_phase" --argjson tags "$tags_json" --arg ts "$ts" '
    .learnings += [{
      id: $id,
      content: $content,
      source_project: $sp,
      source_phase: $phase,
      tags: $tags,
      promoted_at: $ts
    }]
  ' "$global_file") || json_err "Failed to update learnings.json"

  echo "$updated" > "$global_file"
  json_ok "{\"promoted\":true,\"id\":\"$id\",\"count\":$((current_count + 1)),\"cap\":50}"
  ;;
```

**Subcommand 2: `learning-inject`**

Add the following case block:

```bash
learning-inject)
  [[ $# -ge 1 ]] || json_err "Usage: learning-inject <tech_keywords_csv>"
  keywords="$1"

  global_file="$HOME/.aether/learnings.json"

  if [[ ! -f "$global_file" ]]; then
    json_ok '{"learnings":[],"count":0}'
    exit 0
  fi

  json_ok "$(jq --arg kw "$keywords" '
    ($kw | split(",") | map(ascii_downcase | ltrimstr(" ") | rtrimstr(" "))) as $keywords |
    .learnings | map(
      select(
        .tags as $tags |
        ($keywords | any(. as $k | $tags | any(ascii_downcase | contains($k))))
      )
    ) | {learnings: ., count: length}
  ' "$global_file")"
  ;;
```

**Update help command:** In the `help)` case, add `"learning-promote","learning-inject"` to the commands JSON array.

**Verify no syntax errors** by running the script with `help`.
  </action>
  <verify>
Run: `bash .aether/aether-utils.sh help` -- should list learning-promote and learning-inject in the commands array.

Run: `bash .aether/aether-utils.sh learning-promote "test learning content here" "test project" 1 "typescript,react"` -- should return `{"ok":true,"result":{"promoted":true,...}}` and create `~/.aether/learnings.json`.

Run: `bash .aether/aether-utils.sh learning-inject "typescript"` -- should return the learning just promoted.

Run: `bash .aether/aether-utils.sh learning-inject "python"` -- should return empty learnings (no match).

Clean up test data: `rm ~/.aether/learnings.json` (only if no pre-existing file was there).
  </verify>
  <done>
Both subcommands are functional. learning-promote creates ~/.aether/ and learnings.json on first use, appends entries with proper schema, enforces 50-entry cap. learning-inject filters by tag keyword match and returns empty gracefully when file doesn't exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add learning promotion UX to continue.md Step 2.5</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Read `.claude/commands/ant/continue.md`. Find Step 2.5 (Generate Tech Debt Report). After the existing tech debt report logic (after "3. Persist the report:" and writing to tech-debt-report.md), add a new sub-step **Step 2.5b: Promote Learnings to Global Tier**.

Insert the following content BETWEEN the persist step and the "4. Display completion message and stop:" step. The completion message display must be updated to also mention learnings promotion.

**Add Step 2.5b:**

```markdown
### Step 2.5b: Promote Learnings to Global Tier

After generating the tech debt report, offer learning promotion.

**Auto-continue guard:** If `auto_mode` is true (set in Step 0), skip this entire step. Display:
  "Global learning promotion available. Run /ant:continue (without --all) to promote learnings."
Proceed to Step 2.5c.

**If auto_mode is false:**

1. Read `.aether/data/memory.json` phase_learnings array (already in memory from Step 1)
2. If phase_learnings is empty: display "No project learnings to promote." and skip to Step 2.5c

3. Analyze each learning and categorize:
   - **Promotion candidates:** Learnings that reference specific tech, patterns, or practices applicable across projects
     - Example good candidate: "bcrypt with 12 rounds causes 800ms delay -- use 10 rounds"
     - Example good candidate: "Integration tests caught missing error handlers that unit tests missed"
   - **Project-specific:** Learnings too tied to this project's details
     - Example: "Phase 3 had 2 errors"
     - Example: "Auth routes needed 3 retries"

4. Display learnings with promotion suggestions:
   ```
   PROJECT LEARNINGS:

   Candidates for global promotion (applicable across projects):
     [1] "<learning text>" (Phase <N>)
     [2] "<learning text>" (Phase <N>)

   Project-specific (not recommended for promotion):
     [-] "<learning text>" (Phase <N>)

   Which learnings would you like to promote? (numbers, "all candidates", or "none")
   ```

5. Wait for user selection.

6. For each selected learning:
   - Read `COLONY_STATE.json` for the `goal` field (source_project)
   - Infer tags from the colonization decision in memory.json (look for the `type: "colonization"` decision entry -- extract tech stack keywords like language names, framework names, domain keywords)
   - Run:
     ```
     bash .aether/aether-utils.sh learning-promote "<learning_content>" "<goal>" <phase_number> "<comma_separated_tags>"
     ```
   - If result contains `"promoted":true`: note success
   - If result contains `"reason":"cap_reached"`:
     - Display: "Global learnings at capacity (50/50). Remove an existing learning to make room."
     - Read `~/.aether/learnings.json` and display existing learnings with indices
     - Ask user which to remove (by index)
     - Remove the selected entry from the file using jq, then retry the promotion

7. Display promotion result:
   ```
   Promoted {N} learnings to global tier.
     ~/.aether/learnings.json ({count}/50 entries)
   ```
```

**Update the completion message** in Step 2.5's "4. Display completion message and stop:" section to include the global learnings file reference:

```
All phases complete. Colony has finished the project plan.
  Tech debt report: .aether/data/tech-debt-report.md
  Global learnings: ~/.aether/learnings.json ({count}/50 entries, or "none promoted" if skipped)

  /ant:status   View final colony status
  /ant:plan     Generate a new plan (will replace current)
```

**Important:** Do NOT restructure or rewrite existing content. Insert the new sub-step cleanly between the existing persist and display steps.
  </action>
  <verify>
Read the modified continue.md and verify:
1. Step 2.5b exists between the tech debt report persist and the completion message
2. The auto_mode guard is present (skips promotion in --all mode)
3. The learning-promote subcommand call syntax is correct
4. The cap_reached handling is present
5. The completion message mentions global learnings
  </verify>
  <done>
continue.md contains the learning promotion UX at end-of-project. Auto-continue mode skips promotion. Users can select learnings to promote with tag inference from colonization findings. Cap enforcement with curation flow is present.
  </done>
</task>

</tasks>

<verification>
1. `bash .aether/aether-utils.sh help` lists both new subcommands
2. `bash .aether/aether-utils.sh learning-promote` with valid args creates ~/.aether/learnings.json
3. `bash .aether/aether-utils.sh learning-inject` with matching keywords returns promoted learnings
4. continue.md Step 2.5b is present and correctly structured
5. Auto-continue mode guard prevents blocking on promotion
</verification>

<success_criteria>
- learning-promote subcommand creates ~/.aether/ directory and learnings.json on first use
- learning-promote enforces 50-entry cap and returns cap_reached when full
- learning-inject filters by tag match and returns empty gracefully
- continue.md presents promotion UX at end-of-project after tech debt report
- Auto-continue (--all) skips promotion with informative message
</success_criteria>

<output>
After completion, create `.planning/phases/31-architecture-evolution/31-01-SUMMARY.md`
</output>
