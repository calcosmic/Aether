---
phase: 31-architecture-evolution
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - .claude/commands/ant/colonize.md
autonomous: true

must_haves:
  truths:
    - "Global learnings are injected as FEEDBACK pheromones after colonization"
    - "Only relevant learnings are injected (filtered by tech stack match)"
    - "No global learnings file is handled gracefully (not an error)"
    - "Injected learnings are visible to user with content preview"
  artifacts:
    - path: ".claude/commands/ant/colonize.md"
      provides: "Global learning injection step (Step 5.5)"
      contains: "Inject Global Learnings"
  key_links:
    - from: ".claude/commands/ant/colonize.md"
      to: ".aether/aether-utils.sh"
      via: "learning-inject subcommand call"
      pattern: "aether-utils\\.sh learning-inject"
    - from: ".claude/commands/ant/colonize.md"
      to: ".aether/data/pheromones.json"
      via: "FEEDBACK pheromone emission for each relevant learning"
      pattern: "global:inject"
---

<objective>
Add global learning injection to colonize.md after colonization findings are persisted.

Purpose: ARCH-01 requires global learnings to be injected as FEEDBACK pheromones when starting new projects. Injection happens after colonization (not during init) because colonization provides the tech stack context needed for relevance filtering. This plan adds Step 5.5 to colonize.md that calls the learning-inject subcommand (created in Plan 01), filters by tech stack, and emits FEEDBACK pheromones with 24-hour half-life for each relevant learning.

Output: Modified colonize.md with new Step 5.5 between Step 5 (Persist Findings) and Step 6 (Display Results).
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-architecture-evolution/31-CONTEXT.md
@.planning/phases/31-architecture-evolution/31-RESEARCH.md
@.planning/phases/31-architecture-evolution/31-01-SUMMARY.md
@.claude/commands/ant/colonize.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global learning injection Step 5.5 to colonize.md</name>
  <files>.claude/commands/ant/colonize.md</files>
  <action>
Read `.claude/commands/ant/colonize.md`. Find Step 5 (Persist Findings) and Step 6 (Display Results). Insert a new **Step 5.5: Inject Global Learnings** between them.

**Add Step 5.5:**

```markdown
### Step 5.5: Inject Global Learnings

After persisting colonization findings, inject relevant global learnings as FEEDBACK pheromones.

1. **Check for global learnings file:**
   Run:
   ```
   bash .aether/aether-utils.sh learning-inject "<tech_keywords>"
   ```

   Where `<tech_keywords>` is a comma-separated list of technology keywords extracted from the colonization findings just persisted in Step 5. Derive these from:
   - Languages detected (e.g., "typescript", "python", "go")
   - Frameworks detected (e.g., "react", "express", "django")
   - Domain keywords (e.g., "api", "frontend", "cli")

   Example: for a TypeScript React project, run:
   ```
   bash .aether/aether-utils.sh learning-inject "typescript,react,frontend"
   ```

   This returns JSON: `{"ok":true,"result":{"learnings":[...],"count":N}}`

2. **If count is 0 or learnings array is empty:** Display "No matching global learnings found." and skip to Step 6.

3. **For each relevant learning returned:**
   Read `.aether/data/pheromones.json` (if not already in memory from Step 2).

   Append a FEEDBACK pheromone to the `signals` array:
   ```json
   {
     "id": "global_inject_<unix_timestamp>_<4_random_hex>",
     "type": "FEEDBACK",
     "content": "Global learning: <learning.content>",
     "strength": 0.5,
     "half_life_seconds": 86400,
     "created_at": "<ISO-8601 UTC>",
     "source": "global:inject",
     "auto": true
   }
   ```

   Before appending, validate the content:
   ```
   bash .aether/aether-utils.sh pheromone-validate "Global learning: <learning.content>"
   ```
   - If pass:false -> skip this learning (content too short)
   - If pass:true -> append to signals array
   - If command fails -> append anyway (fail-open)

4. **Write updated pheromones.json** with the injected FEEDBACK pheromones.

5. **Display injected learnings** using Bash tool (bold yellow -- Queen color):
   ```
   bash -c 'printf "\n\e[1;33m%-14s\e[0m Injected %d global learnings as FEEDBACK pheromones:\n" "[QUEEN]" {count}'
   ```
   For each injected learning:
   ```
   bash -c 'printf "  \e[33mFEEDBACK\e[0m (0.5, 24h): %s\n" "<first 80 chars of learning content>"'
   ```

   Note: 24-hour half-life (vs normal 6-hour FEEDBACK) ensures learnings persist through the planning phase.
```

**Update Step 6 (Display Results):** In the step progress checkmarks section, add a new line after the Step 5 checkmark:
```
bash -c 'printf "  \e[32mâœ“\e[0m Step 5.5: Inject Global Learnings\n"'
```

**Important:** Do NOT restructure existing steps. Insert Step 5.5 cleanly between Step 5 and Step 6. Preserve all existing content.
  </action>
  <verify>
Read the modified colonize.md and verify:
1. Step 5.5 exists between Step 5 (Persist Findings) and Step 6 (Display Results)
2. The learning-inject subcommand call is present with tech_keywords parameter
3. FEEDBACK pheromone schema includes source: "global:inject" and half_life_seconds: 86400
4. Pheromone-validate call is present before appending
5. Display output shows injected learnings count and content preview
6. Step 6 progress checkmarks include Step 5.5
  </verify>
  <done>
colonize.md injects relevant global learnings as FEEDBACK pheromones after colonization. Learnings are filtered by tech stack keywords from colonization findings. Missing file handled gracefully. Injected learnings displayed to user with content preview. 24-hour half-life ensures persistence through planning phase.
  </done>
</task>

</tasks>

<verification>
1. colonize.md Step 5.5 exists and references learning-inject subcommand
2. FEEDBACK pheromone emission includes correct schema (source: "global:inject", half_life_seconds: 86400, strength: 0.5)
3. Graceful handling when ~/.aether/learnings.json doesn't exist (empty result, no error)
4. Step 6 progress display includes Step 5.5 checkmark
</verification>

<success_criteria>
- colonize.md has Step 5.5 that calls learning-inject with tech keywords from colonization
- Relevant global learnings emitted as FEEDBACK pheromones with 24h half-life
- No global learnings file is not an error (returns 0 matches)
- Injected learnings are displayed to user with content and count
- memory.json phase_learnings are distinct from global ~/.aether/learnings.json (two independent tiers)
</success_criteria>

<output>
After completion, create `.planning/phases/31-architecture-evolution/31-02-SUMMARY.md`
</output>
