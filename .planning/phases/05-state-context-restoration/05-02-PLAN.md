---
phase: 05-state-context-restoration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/utils/spawn-tree.sh
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "Spawn tree can be reconstructed from spawn-tree.txt"
    - "Parent-child relationships are preserved across sessions"
    - "Spawn depth calculation works from reconstructed tree"
    - "Active spawns can be queried from loaded tree"
  artifacts:
    - path: ".aether/utils/spawn-tree.sh"
      provides: "Spawn tree parsing and reconstruction"
      min_lines: 100
    - path: ".aether/aether-utils.sh"
      provides: "spawn-tree-load subcommand"
      exports: ["spawn-tree-load", "spawn-tree-active"]
  key_links:
    - from: "spawn-tree.sh"
      to: "spawn-tree.txt"
      via: "line-by-line parsing of pipe-delimited format"
    - from: "spawn-tree.sh"
      to: "COLONY_STATE.json"
      via: "cross-reference spawn IDs with events"
---

<objective>
Implement spawn tree persistence and reconstruction across sessions.

Purpose: Ensure the complete spawn history with parent-child relationships is preserved and can be reconstructed when the colony resumes.
Output: spawn-tree.sh module with tree reconstruction functions
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-state-context-restoration/05-CONTEXT.md
@.planning/phases/05-state-context-restoration/05-RESEARCH.md

@.aether/data/spawn-tree.txt
@.aether/aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Create spawn-tree.sh reconstruction module</name>
  <files>.aether/utils/spawn-tree.sh</files>
  <action>
Create `.aether/utils/spawn-tree.sh` with spawn tree reconstruction functions:

1. `parse_spawn_tree(file_path)` - Parse spawn-tree.txt into structured data:
   - Read file line by line
   - Parse spawn events: `timestamp|parent|caste|child|task|spawned`
   - Parse completion events: `timestamp|ant_name|status|summary`
   - Build associative arrays (use Bash 3.2 compatible indexed arrays with name mapping)
   - Store: parent, caste, task, status, children_ids, timestamp, completed_at
   - Output JSON representation of spawn tree

2. `get_spawn_depth(ant_name)` - Calculate depth in tree:
   - If ant_name is "Queen", return 0
   - If ant not found, return 1 (default)
   - Traverse parent chain with safety limit of 5 levels
   - Return depth count

3. `get_active_spawns()` - List currently active spawns:
   - Filter spawns where status is "active" or "spawned" (not "completed"/"failed")
   - Return array of {name, caste, parent, task, spawned_at}

4. `get_spawn_children(ant_name)` - Get direct children:
   - Return array of child names for given parent

5. `get_spawn_lineage(ant_name)` - Get full ancestry:
   - Return array from ant up to Queen (inclusive)
   - Example: ["Forge-34", "Queen"] for depth 1

6. `reconstruct_tree_json()` - Full tree as JSON:
   - Output complete spawn tree in JSON format
   - Include all spawns with their relationships
   - Include metadata: total_count, active_count, completed_count

Use patterns from RESEARCH.md SpawnTree JavaScript class, adapted for Bash.
Handle edge cases: missing parent, circular references (safety limit), empty tree file.

File format from spawn-tree.txt:
- Spawn: `timestamp|parent|caste|child_name|task_description|spawned`
- Complete: `timestamp|ant_name|completed|summary`
  </action>
  <verify>
    test -f .aether/utils/spawn-tree.sh && grep -q "parse_spawn_tree" .aether/utils/spawn-tree.sh && echo "Spawn tree module created"
  </verify>
  <done>spawn-tree.sh exists with parse_spawn_tree, get_spawn_depth, get_active_spawns, get_spawn_children, get_spawn_lineage, reconstruct_tree_json functions</done>
</task>

<task type="auto">
  <name>Add spawn-tree subcommands to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add spawn-tree subcommands to aether-utils.sh:

1. `spawn-tree-load` - Load and output full tree:
```bash
spawn-tree-load)
  source "$SCRIPT_DIR/utils/spawn-tree.sh" 2>/dev/null || {
    json_err "$E_FILE_NOT_FOUND" "spawn-tree.sh not found"
    exit 1
  }
  tree_json=$(reconstruct_tree_json)
  json_ok "$tree_json"
  ;;
```

2. `spawn-tree-active` - List active spawns:
```bash
spawn-tree-active)
  source "$SCRIPT_DIR/utils/spawn-tree.sh" 2>/dev/null || {
    json_err "$E_FILE_NOT_FOUND" "spawn-tree.sh not found"
    exit 1
  }
  active=$(get_active_spawns)
  json_ok "$active"
  ;;
```

3. `spawn-tree-depth` - Get depth for specific ant:
```bash
spawn-tree-depth)
  ant_name="${1:-}"
  [[ -z "$ant_name" ]] && json_err "$E_VALIDATION_FAILED" "Usage: spawn-tree-depth <ant_name>"
  source "$SCRIPT_DIR/utils/spawn-tree.sh" 2>/dev/null || {
    json_err "$E_FILE_NOT_FOUND" "spawn-tree.sh not found"
    exit 1
  }
  depth=$(get_spawn_depth "$ant_name")
  json_ok "{\"ant\":\"$ant_name\",\"depth\":$depth}"
  ;;
```

Update help command to include new spawn-tree-* commands.
  </action>
  <verify>
    bash .aether/aether-utils.sh spawn-tree-load >/dev/null 2>&1 && echo "spawn-tree-load works"
  </verify>
  <done>All spawn-tree subcommands work and appear in help</done>
</task>

<task type="auto">
  <name>Test spawn tree reconstruction</name>
  <files>tests/unit/spawn-tree.test.js</files>
  <action>
Create test file `tests/unit/spawn-tree.test.js`:

1. "spawn-tree-load returns valid tree JSON":
   - Run `bash .aether/aether-utils.sh spawn-tree-load`
   - Parse JSON
   - Assert ok: true
   - Assert result has spawns array, metadata object

2. "spawn-tree-active returns only active spawns":
   - Run spawn-tree-active
   - Assert all returned spawns have status "active" or "spawned"
   - Assert no "completed" or "failed" spawns in list

3. "spawn-tree-depth returns correct depth":
   - Test "Queen" returns 0
   - Test known depth-1 spawn returns 1
   - Test unknown ant returns 1 (default)

4. "parse_spawn_tree handles parent-child relationships":
   - Verify child correctly linked to parent
   - Verify children_ids array populated

5. "spawn tree handles missing file gracefully":
   - Temporarily rename spawn-tree.txt
   - Assert empty tree or appropriate error
   - Restore file

6. "spawn depth calculation has safety limit":
   - Verify depth calculation stops at 5 levels (prevents infinite loops)

Use existing test patterns from colony-state.test.js.
  </action>
  <verify>
    npm test -- tests/unit/spawn-tree.test.js
  </verify>
  <done>All spawn-tree tests pass (6/6)</done>
</task>

</tasks>

<verification>
- [ ] spawn-tree.sh exists with all reconstruction functions
- [ ] spawn-tree-load outputs valid JSON tree
- [ ] spawn-tree-active lists only active spawns
- [ ] spawn-tree-depth calculates correctly
- [ ] Parent-child relationships preserved in reconstruction
- [ ] Tests pass: npm test -- tests/unit/spawn-tree.test.js
</verification>

<success_criteria>
1. Spawn tree can be fully reconstructed from spawn-tree.txt (STATE-03)
2. Parent-child relationships are preserved across sessions
3. Spawn depth calculation works correctly
4. Active spawns can be queried
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-context-restoration/05-02-SUMMARY.md`
</output>
