---
phase: 11-foraging-specialization
plan: 04
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - .claude/commands/ant/build.md
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "User can run '/ant:build 1 --model glm-5' to force glm-5 for all workers in Phase 1"
    - "CLI --model flag takes precedence over user overrides and task routing"
    - "Model selection source is logged as 'cli-override' when --model is used"
    - "Invalid --model values are rejected with helpful error message"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "--model flag parsing in build command"
      contains: "--model"
    - path: ".aether/aether-utils.sh"
      provides: "model-profile get command with optional override"
      adds: "model validation helper"
  key_links:
    - from: "build.md argument parsing"
      to: "selectModelForTask cliOverride parameter"
      via: "model-profile get with override"
      pattern: "--model.*selectModelForTask"
---

<objective>
Integrate per-command --model flag support into the spawn flow, enabling users to override model selection for a single command.

Purpose: Fulfill MOD-08 requirement for one-time model overrides via CLI flag.
Output: Updated build.md command and aether-utils.sh with --model flag parsing and validation.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-foraging-specialization/11-RESEARCH.md
@/Users/callumcowie/repos/Aether/.claude/commands/ant/build.md
@/Users/callumcowie/repos/Aether/.aether/aether-utils.sh
@/Users/callumcowie/repos/Aether/bin/lib/model-profiles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --model flag parsing to build.md</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify the build.md command to parse and handle the --model flag:

1. **Update Step 1 argument parsing** (around line 52-70):
   - Add detection for `--model <model>` or `-m <model>` flag
   - Extract the model value if flag is present
   - Store in `cli_model_override` variable (null if not provided)

   ```markdown
   **Parse $ARGUMENTS:**
   1. Extract the phase number (first argument)
   2. Check remaining arguments for flags:
      - If contains `--verbose` or `-v`: set `verbose_mode = true`
      - If contains `--model <name>` or `-m <name>`: set `cli_model_override = <name>`
      - Otherwise: set defaults
   ```

2. **Add model validation** (new step after argument parsing):
   - If `cli_model_override` is set:
     - Validate the model exists using `bash .aether/aether-utils.sh model-profile validate <model>`
     - If invalid: display error and stop
     - If valid: display "Using override model: {model}"

3. **Update Step 5.1 Model Assignment** (around line 319-330):
   - Change from using `model-profile get` to `model-profile select`
   - Pass the task description and CLI override:
   ```markdown
   ```bash
   # Get model assignment for this caste with task-based routing
   model_info=$(bash .aether/aether-utils.sh model-profile select "{caste}" "{task_description}" "{cli_model_override}")
   model=$(echo "$model_info" | jq -r '.result.model')
   source=$(echo "$model_info" | jq -r '.result.source')

   # Log model assignment with source
   bash .aether/aether-utils.sh activity-log "MODEL" "Queen" "{ant_name} ({caste}): assigned to $model (source: $source)"
   ```
   ```

4. **Update help text** in the usage section:
   ```markdown
   Usage: /ant:build <phase_number> [--verbose|-v] [--model <model>|-m <model>]

   Options:
     --verbose, -v       Show full completion details (spawn tree, TDD, patterns)
     --model, -m <name>  Override model for this build (one-time)
   ```
  </action>
  <verify>grep -q "\-\-model" .claude/commands/ant/build.md && grep -q "cli_model_override" .claude/commands/ant/build.md && echo "--model flag parsing added"</verify>
  <done>build.md parses --model flag, validates it, and passes to model selection</done>
</task>

<task type="auto">
  <name>Task 2: Add model-profile select command to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add a new `model-profile select` command to aether-utils.sh that uses the JavaScript library:

1. **Add new command handler** in the model-profile section (after existing model-profile commands):
   ```bash
   select)
     # Usage: model-profile select <caste> <task_description> [cli_override]
     # Returns: JSON with model and source
     caste="$2"
     task_description="$3"
     cli_override="${4:-}"

     # Create a temporary Node.js script to call the library
     node_script=$(cat << 'NODESCRIPT'
     const { loadModelProfiles, selectModelForTask } = require('./bin/lib/model-profiles');
     const caste = process.argv[2];
     const taskDescription = process.argv[3];
     const cliOverride = process.argv[4] || null;

     try {
       const profiles = loadModelProfiles('.');
       const result = selectModelForTask(profiles, caste, taskDescription, cliOverride);
       console.log(JSON.stringify({ ok: true, result }));
     } catch (error) {
       console.log(JSON.stringify({ ok: false, error: error.message }));
       process.exit(1);
     }
NODESCRIPT
)

     result=$(echo "$node_script" | node - "$caste" "$task_description" "$cli_override")
     echo "$result"
     ;;
   ```

2. **Add model-profile validate command** (for validating override values):
   ```bash
   validate)
     # Usage: model-profile validate <model_name>
     # Returns: JSON with valid boolean
     model_name="$2"

     node_script=$(cat << 'NODESCRIPT'
     const { loadModelProfiles, validateModel } = require('./bin/lib/model-profiles');
     const modelName = process.argv[2];

     try {
       const profiles = loadModelProfiles('.');
       const validation = validateModel(profiles, modelName);
       console.log(JSON.stringify({ ok: true, result: validation }));
     } catch (error) {
       console.log(JSON.stringify({ ok: false, error: error.message }));
     }
NODESCRIPT
)

     result=$(echo "$node_script" | node - "$model_name")
     echo "$result"
     ;;
   ```

3. **Update the model-profile help text** to include new commands:
   ```bash
   echo "Usage: model-profile <command> [args]"
   echo ""
   echo "Commands:"
   echo "  get <caste>                    Get model for caste"
   echo "  set <caste> <model>            Set user override"
   echo "  reset <caste>                  Reset user override"
   echo "  list                           List all assignments"
   echo "  select <caste> <task> [model]  Select model with task routing"
   echo "  validate <model>               Validate model name"
   ```
  </action>
  <verify>grep -q "model-profile select" .aether/aether-utils.sh && grep -q "model-profile validate" .aether/aether-utils.sh && echo "model-profile commands added"</verify>
  <done>aether-utils.sh has model-profile select and validate commands</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for CLI override integration</name>
  <files>test/cli-override.test.js</files>
  <action>
Create unit tests for the CLI override functionality:

1. **Test model-profile select command:**
   - Returns correct model for caste default
   - Returns CLI override when provided
   - Returns task-routing model when no CLI override
   - Returns user override when no CLI override (user override > task routing)
   - Returns CLI override even when user override exists (CLI > user)
   - Returns correct source for each case

2. **Test model-profile validate command:**
   - Returns valid: true for known models (kimi-k2.5, glm-5, minimax-2.5)
   - Returns valid: false for unknown models
   - Returns list of valid models in error case

3. **Test argument parsing patterns:**
   - Parse "1 --model glm-5" -> phase=1, model=glm-5
   - Parse "1 -m glm-5" -> phase=1, model=glm-5
   - Parse "1 --verbose --model glm-5" -> phase=1, verbose=true, model=glm-5
   - Parse "1" -> phase=1, model=null

4. **Integration test:**
   - End-to-end: call model-profile select with all override types
   - Verify JSON output structure

Use temporary directories and mock model-profiles.yaml for test isolation.
  </action>
  <verify>npm test -- test/cli-override.test.js 2>&1 | grep -E "(passed|failed)" | tail -1</verify>
  <done>CLI override tests pass with >90% coverage</done>
</task>

</tasks>

<verification>
1. Run tests: npm test -- test/cli-override.test.js
2. Manual test: `bash .aether/aether-utils.sh model-profile validate glm-5` -> should return valid: true
3. Manual test: `bash .aether/aether-utils.sh model-profile select builder "implement feature" "glm-5"` -> should return glm-5 with source: cli-override
4. Manual test: `bash .aether/aether-utils.sh model-profile select builder "design system" ""` -> should return glm-5 with source: task-routing
5. Verify build.md help text shows --model option
</verification>

<success_criteria>
- [ ] build.md parses --model and -m flags correctly
- [ ] Invalid model names are rejected with helpful error
- [ ] aether-utils.sh model-profile select returns correct model with source
- [ ] aether-utils.sh model-profile validate returns correct validation
- [ ] CLI override takes precedence over user override and task routing
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-foraging-specialization/11-04-SUMMARY.md`
</output>
