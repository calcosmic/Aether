---
phase: 20-utility-modules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "Running `aether-utils pheromone-decay 1.0 3600 3600` outputs JSON with strength approximately 0.5"
    - "Running `aether-utils pheromone-effective 0.9 0.8` outputs JSON with effective_signal 0.72"
    - "Running `aether-utils pheromone-batch` reads pheromones.json and outputs all signals with current_strength computed"
    - "Running `aether-utils pheromone-cleanup` removes signals where current strength is below 0.05"
    - "Running `aether-utils pheromone-combine 0.8 0.3` outputs JSON with net_effect, dominant, and ratio fields"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "Pheromone math subcommands (decay, effective, batch, cleanup, combine)"
      contains: "pheromone-decay)"
  key_links:
    - from: ".aether/aether-utils.sh"
      to: ".aether/data/pheromones.json"
      via: "jq read in pheromone-batch and pheromone-cleanup"
      pattern: "pheromones\\.json"
    - from: ".aether/aether-utils.sh"
      to: ".aether/utils/atomic-write.sh"
      via: "atomic_write call in pheromone-cleanup"
      pattern: "atomic_write"
---

<objective>
Add all 5 pheromone math subcommands to aether-utils.sh: pheromone-decay, pheromone-effective, pheromone-batch, pheromone-cleanup, pheromone-combine.

Purpose: Deterministic pheromone calculations replace LLM-approximated math. These are the most frequently used utility operations (9 command files reference the decay formula).
Output: aether-utils.sh with 5 new case branches, ~40 lines added.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-utility-modules/20-RESEARCH.md
@.aether/aether-utils.sh
@.aether/utils/atomic-write.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 5 pheromone subcommands to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add 5 new case branches to the case dispatch in aether-utils.sh, BEFORE the `*)` catch-all. Also update the help text to list the new commands.

**1. pheromone-decay** (PHER-01): Pure computation. 3 required args: strength, elapsed_seconds, half_life.
```bash
pheromone-decay)
  [[ $# -ge 3 ]] || json_err "Usage: pheromone-decay <strength> <elapsed_seconds> <half_life>"
  json_ok "$(jq -n --arg s "$1" --arg e "$2" --arg h "$3" \
    '{strength: (($s|tonumber) * ((-0.693147180559945 * ($e|tonumber) / ($h|tonumber)) | exp) | . * 1000000 | round / 1000000)}')"
  ;;
```

**2. pheromone-effective** (PHER-02): Pure computation. 2 required args: sensitivity, strength.
```bash
pheromone-effective)
  [[ $# -ge 2 ]] || json_err "Usage: pheromone-effective <sensitivity> <strength>"
  json_ok "$(jq -n --arg sens "$1" --arg str "$2" \
    '{effective_signal: (($sens|tonumber) * ($str|tonumber) | . * 1000000 | round / 1000000)}')"
  ;;
```

**3. pheromone-batch** (PHER-03): Reads pheromones.json. Computes current_strength for each signal using decay formula. Null half_life_seconds means signal persists at original strength.
```bash
pheromone-batch)
  [[ -f "$DATA_DIR/pheromones.json" ]] || json_err "pheromones.json not found"
  local now; now=$(date -u +%s)
  json_ok "$(jq --arg now "$now" '.signals | map(. + {
    current_strength: (
      if .half_life_seconds == null then .strength
      else .strength * ((-0.693147180559945 * (($now|tonumber) - (.created_at | sub("\\.[0-9]+Z$";"Z") | fromdate)) / .half_life_seconds) | exp)
      end | . * 1000 | round / 1000)
  })' "$DATA_DIR/pheromones.json")" || json_err "Failed to read pheromones.json"
  ;;
```
Note: The `sub("\\.[0-9]+Z$";"Z")` strips fractional seconds before fromdate (Pitfall 1 from research).

**4. pheromone-cleanup** (PHER-04): Reads pheromones.json, removes signals where current strength < 0.05, writes back via atomic_write. Reports how many removed.
```bash
pheromone-cleanup)
  [[ -f "$DATA_DIR/pheromones.json" ]] || json_err "pheromones.json not found"
  local now; now=$(date -u +%s)
  local before; before=$(jq '.signals | length' "$DATA_DIR/pheromones.json")
  local result; result=$(jq --arg now "$now" '.signals |= map(select(
    .half_life_seconds == null or
    (.strength * ((-0.693147180559945 * (($now|tonumber) - (.created_at | sub("\\.[0-9]+Z$";"Z") | fromdate)) / .half_life_seconds) | exp)) >= 0.05
  ))' "$DATA_DIR/pheromones.json") || json_err "Failed to process pheromones.json"
  atomic_write "$DATA_DIR/pheromones.json" "$result"
  local after; after=$(echo "$result" | jq '.signals | length')
  json_ok "{\"removed\":$((before - after)),\"remaining\":$after}"
  ;;
```

**5. pheromone-combine** (PHER-05): Pure computation. 2 required args: signal1_strength, signal2_strength. Returns net_effect = max(0, s1-s2), dominant, and ratio.
```bash
pheromone-combine)
  [[ $# -ge 2 ]] || json_err "Usage: pheromone-combine <signal1_strength> <signal2_strength>"
  json_ok "$(jq -n --arg s1 "$1" --arg s2 "$2" '{
    net_effect: ((($s1|tonumber) - ($s2|tonumber)) | if . < 0 then 0 else . end | . * 1000 | round / 1000),
    dominant: (if ($s1|tonumber) >= ($s2|tonumber) then "signal1" else "signal2" end),
    ratio: (if ($s2|tonumber) == 0 then null else (($s1|tonumber) / ($s2|tonumber)) | . * 1000 | round / 1000 end)
  }')"
  ;;
```

**Help text update:** Replace the help case to list all pheromone commands:
```
"commands":["help","version","pheromone-decay","pheromone-effective","pheromone-batch","pheromone-cleanup","pheromone-combine"]
```

All commands MUST be placed as case branches BEFORE the `*)` catch-all. The `set -euo pipefail` and sourcing at the top remain unchanged.
  </action>
  <verify>
Run all 5 pheromone commands and confirm JSON output:

```bash
# Decay: 1.0 strength at exactly one half-life should yield ~0.5
bash .aether/aether-utils.sh pheromone-decay 1.0 3600 3600

# Effective: 0.9 * 0.8 = 0.72
bash .aether/aether-utils.sh pheromone-effective 0.9 0.8

# Combine: 0.8 - 0.3 = 0.5 net effect
bash .aether/aether-utils.sh pheromone-combine 0.8 0.3

# Help lists new commands
bash .aether/aether-utils.sh help

# Error handling: missing args returns non-zero with JSON error
bash .aether/aether-utils.sh pheromone-decay 2>/dev/null; echo "exit: $?"
```

For batch and cleanup, test with a pheromones.json file if one exists, or create a minimal test fixture.
  </verify>
  <done>
All 5 pheromone subcommands produce correct JSON output. `pheromone-decay 1.0 3600 3600` yields strength ~0.5. `pheromone-effective 0.9 0.8` yields 0.72. Missing args return non-zero exit with JSON error on stderr. Help text lists all pheromone commands.
  </done>
</task>

</tasks>

<verification>
1. `bash .aether/aether-utils.sh pheromone-decay 1.0 3600 3600` outputs `{"ok":true,"result":{"strength":0.5}}` (exactly 0.5)
2. `bash .aether/aether-utils.sh pheromone-effective 0.9 0.8` outputs `{"ok":true,"result":{"effective_signal":0.72}}`
3. `bash .aether/aether-utils.sh pheromone-combine 0.8 0.3` outputs JSON with net_effect 0.5, dominant "signal1"
4. `bash .aether/aether-utils.sh pheromone-decay` (no args) exits non-zero with JSON error on stderr
5. Total line count of aether-utils.sh is under 100 (scaffold 47 + ~40 pheromone lines)
6. `wc -l .aether/aether-utils.sh` confirms line count
</verification>

<success_criteria>
- PHER-01: pheromone-decay computes exponential decay correctly (verified with 1-half-life test)
- PHER-02: pheromone-effective multiplies sensitivity by strength
- PHER-03: pheromone-batch reads pheromones.json and adds current_strength to each signal
- PHER-04: pheromone-cleanup removes expired signals (strength < 0.05) and writes atomically
- PHER-05: pheromone-combine outputs net_effect, dominant, and ratio
- All commands return JSON to stdout on success, JSON to stderr on error with non-zero exit
</success_criteria>

<output>
After completion, create `.planning/phases/20-utility-modules/20-01-SUMMARY.md`
</output>
