---
phase: 06-autonomous-emergence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/utils/spawn-decision.sh
  - .aether/workers/builder-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/architect-ant.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Worker Ant can analyze task requirements and detect capability gaps"
    - "Worker Ant can determine which specialist caste is needed for a task"
    - "Worker Ant uses semantic analysis when direct mapping is unavailable"
    - "Spawn decision uses multi-factor scoring (gap, priority, load, budget, resources)"
    - "Specialist mapping uses capability keywords and semantic fallback"
  artifacts:
    - path: ".aether/utils/spawn-decision.sh"
      provides: "Capability gap detection and specialist selection logic"
      exports: ["analyze_task_requirements", "compare_capabilities", "detect_capability_gaps", "calculate_spawn_score", "map_gap_to_specialist"]
    - path: ".aether/workers/builder-ant.md"
      provides: "Builder Ant with spawning decision section"
      contains: "Capability Gap Detection"
    - path: ".aether/workers/colonizer-ant.md"
      provides: "Colonizer Ant with spawning decision section"
      contains: "Capability Gap Detection"
    - path: ".aether/workers/route-setter-ant.md"
      provides: "Route-setter Ant with spawning decision section"
      contains: "Capability Gap Detection"
    - path: ".aether/workers/scout-ant.md"
      provides: "Scout Ant with spawning decision section"
      contains: "Capability Gap Detection"
    - path: ".aether/workers/watcher-ant.md"
      provides: "Watcher Ant with spawning decision section"
      contains: "Capability Gap Detection"
    - path: ".aether/workers/architect-ant.md"
      provides: "Architect Ant with spawning decision section"
      contains: "Capability Gap Detection"
  key_links:
    - from: ".aether/workers/builder-ant.md"
      to: ".aether/utils/spawn-decision.sh"
      via: "source spawn-decision.sh in spawning decision section"
      pattern: "source.*spawn-decision\\.sh"
    - from: ".aether/data/worker_ants.json"
      to: ".aether/utils/spawn-decision.sh"
      via: "caste capabilities used for comparison"
      pattern: "capabilities"
---

<objective>
Implement capability gap detection logic and specialist type mapping for autonomous Worker Ant spawning.

Purpose: Enable Worker Ants to autonomously detect when a task requires capabilities outside their caste and determine which specialist to spawn.

Output: Worker Ants with spawning decision logic that analyzes task requirements, compares to own capabilities, detects gaps, and maps to appropriate specialist castes.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-CONTEXT.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-RESEARCH.md
@.aether/data/worker_ants.json
@.aether/workers/builder-ant.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spawn-decision.sh with capability gap detection functions</name>
  <files>.aether/utils/spawn-decision.sh</files>
  <action>
Create .aether/utils/spawn-decision.sh with the following functions:

1. **analyze_task_requirements(task_description)**
   - Extract technical domains: [database, frontend, backend, api, security, testing, performance, devops]
   - Extract frameworks: [react, vue, django, fastapi, etc.]
   - Extract skills: [analysis, planning, implementation, validation]
   - Output: JSON array of required capabilities

2. **compare_capabilities(caste, required_capabilities)**
   - Read caste capabilities from .aether/data/worker_ants.json
   - Compare required vs available capabilities
   - Identify gaps: capabilities in required but not in available
   - Output: JSON object with {gaps: [], coverage_percentage: float}

3. **detect_capability_gaps(gaps, task_type, failure_count)**
   - Explicit domain mismatch: gaps array not empty
   - Failure after attempts: failure_count > 0
   - Pattern recognition: check meta_learning.spawn_history for similar tasks
   - Output: "spawn" | "attempt" decision with reason

4. **calculate_spawn_score(gap_score, priority, load, budget_remaining, resources)**
   - Multi-factor scoring formula:
     ```
     spawn_score = (
         gap_score * 0.40 +
         priority * 0.20 +
         load * 0.15 +
         budget_remaining * 0.15 +
         resources * 0.10
     )
     ```
   - Return: float score (0.0 - 1.0)
   - Threshold: 0.6 (spawn if >= 0.6)

5. **map_gap_to_specialist(gaps, task_description)**
   - Use worker_ants.json specialist_mappings.capability_to_caste for direct lookup
   - Fallback to semantic analysis of task_description and gaps
   - Return: specialist caste name and specialization description

All functions use bash with jq for JSON parsing. Source atomic-write.sh for any state operations.
</action>
  <verify>
```bash
# Test script execution
chmod +x .aether/utils/spawn-decision.sh
source .aether/utils/spawn-decision.sh

# Test analyze_task_requirements
result=$(analyze_task_requirements "Create React component with database integration")
echo "$result" | jq -e '.required_capabilities | length > 0' > /dev/null

# Test compare_capabilities
result=$(compare_capabilities "builder" '["database","react"]')
echo "$result" | jq -e '.gaps | length > 0' > /dev/null

# Test calculate_spawn_score
result=$(calculate_spawn_score 0.8 0.9 0.3 0.7 0.8)
[ "$result" = "0.68" ] && echo "Score calculation correct"

# Test map_gap_to_specialist
result=$(map_gap_to_specialist '["database"]' "Database schema migration")
echo "$result" | jq -e '.caste == "scout"' > /dev/null
```
</verify>
  <done>
- spawn-decision.sh exists and is executable
- All 5 functions implemented and tested
- Functions output valid JSON
- Capability detection logic works for various task types
- Specialist mapping returns correct caste for known capabilities
</done>
</task>

<task type="auto">
  <name>Task 2: Add spawning decision section to all 6 Worker Ant prompts</name>
  <files>.aether/workers/builder-ant.md, .aether/workers/colonizer-ant.md, .aether/workers/route-setter-ant.md, .aether/workers/scout-ant.md, .aether/workers/watcher-ant.md, .aether/workers/architect-ant.md</files>
  <action>
Add "## Capability Gap Detection" section to each Worker Ant prompt, before the existing "## Autonomous Spawning" section.

For each Worker Ant, the section should include:

```markdown
## Capability Gap Detection

Before attempting any task, assess whether you need specialist support.

### Step 1: Extract Task Requirements

Given: "{task_description}"

Required capabilities:
- Technical: [database, frontend, backend, api, security, testing, performance, devops]
- Frameworks: [react, vue, django, fastapi, etc.]
- Skills: [analysis, planning, implementation, validation]

### Step 2: Compare to Your Capabilities

Your capabilities ({CASTE_NAME} Ant):
- {capabilities from worker_ants.json for this caste}

### Step 3: Identify Gaps

Explicit mismatch examples:
- "database schema migration" → Requires database expertise (check if you have it)
- "React component library" → Requires frontend specialization (check if you have it)
- "API rate limiting" → Requires API design expertise (check if you have it)

### Step 4: Calculate Spawn Score

Use multi-factor scoring:
```bash
gap_score=0.8        # Large capability gap (0-1)
priority=0.9         # High priority task (0-1)
load=0.3             # Colony lightly loaded (0-1, inverted)
budget_remaining=0.7 # 7/10 spawns available (0-1)
resources=0.8        # System resources available (0-1)

spawn_score = (
    0.8 * 0.40 +     # gap_score
    0.9 * 0.20 +     # priority
    0.3 * 0.15 +     # load (inverted)
    0.7 * 0.15 +     # budget_remaining
    0.8 * 0.10       # resources
) = 0.68
```

Decision: If spawn_score >= 0.6, spawn specialist. Otherwise, attempt task.

### Step 5: Map Gap to Specialist

Capability gap → Specialist caste:
- database → scout (Scout with database expertise)
- react → builder (Builder with React specialization)
- api → route_setter (Route-setter with API design focus)
- testing → watcher (Watcher with testing specialization)
- security → watcher (Watcher with security focus)
- performance → architect (Architect with performance optimization)
- documentation → scout (Scout with documentation expertise)
- infrastructure → builder (Builder with infrastructure focus)

If no direct mapping, use semantic analysis of task description.

### Spawn Decision

After analysis:
- If spawn_score >= 0.6: Proceed to "Check Resource Constraints" in existing spawning section
- If spawn_score < 0.6: Attempt task yourself, monitor for difficulties
```

Customize the capabilities list for each caste based on worker_ants.json.
</action>
  <verify>
```bash
# Verify all workers have the section
for worker in builder-ant colonizer-ant route-setter-ant scout-ant watcher-ant architect-ant; do
  if ! grep -q "## Capability Gap Detection" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing Capability Gap Detection section"
    exit 1
  fi
  echo "PASS: ${worker} has Capability Gap Detection section"
done
```
</verify>
  <done>
- All 6 Worker Ant prompts have "## Capability Gap Detection" section
- Section appears before existing "## Autonomous Spawning" section
- Each caste has correct capabilities listed from worker_ants.json
- Spawn decision threshold (0.6) documented
- Specialist mapping table included
- Clear flow from gap detection to resource constraints
</done>
</task>

</tasks>

<verification>
## Overall Verification

1. **spawn-decision.sh exists and works**
   - Script is executable: `test -x .aether/utils/spawn-decision.sh`
   - All functions defined: `declare -F | grep -E "(analyze_task_requirements|compare_capabilities|detect_capability_gaps|calculate_spawn_score|map_gap_to_specialist)"`

2. **Worker Ant prompts updated**
   - All 6 workers have capability gap detection section
   - Section content is caste-specific (correct capabilities)
   - Multi-factor scoring formula documented
   - Specialist mapping table included

3. **Integration verified**
   - spawn-decision.sh sourced in worker ant prompts
   - Capability gap detection flows into existing autonomous spawning section
   - Resource constraints mentioned (will be implemented in Wave 2)
</verification>

<success_criteria>
- Worker Ants can analyze task requirements and detect capability gaps
- Worker Ants use multi-factor scoring to decide whether to spawn (threshold 0.6)
- Worker Ants map capability gaps to appropriate specialist castes
- Semantic analysis fallback handles novel capability gaps
- All 6 Worker Ant prompts have consistent spawning decision logic
- spawn-decision.sh provides reusable functions for capability analysis
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-01-SUMMARY.md` with:
- Functions implemented in spawn-decision.sh
- Worker Ants updated with capability gap detection
- Verification results
- Any issues encountered and resolutions
</output>
