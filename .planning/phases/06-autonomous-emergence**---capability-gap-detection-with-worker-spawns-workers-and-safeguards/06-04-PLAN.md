---
phase: 06-autonomous-emergence
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - .aether/utils/spawn-outcome-tracker.sh
  - .aether/data/COLONY_STATE.json
  - .aether/utils/spawn-tracker.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Spawn outcomes recorded in meta_learning section for Phase 8"
    - "Successful spawns increment specialist confidence score"
    - "Failed spawns decrement specialist confidence score"
    - "Confidence scores start at 0.5 and range from 0.0 to 1.0"
    - "Spawn outcome history tracks specialist performance over time"
  artifacts:
    - path: ".aether/utils/spawn-outcome-tracker.sh"
      provides: "Meta-learning outcome tracking"
      exports: ["record_successful_spawn", "record_failed_spawn", "get_specialist_confidence"]
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Meta-learning state"
      contains: "meta_learning.specialist_confidence, meta_learning.spawn_outcomes"
    - path: ".aether/utils/spawn-tracker.sh"
      provides: "Updated to call outcome tracking"
      contains: "record_outcome calls spawn-outcome-tracker functions"
  key_links:
    - from: ".aether/utils/spawn-tracker.sh"
      to: ".aether/utils/spawn-outcome-tracker.sh"
      via: "record_outcome calls confidence tracking functions"
      pattern: "record_successful_spawn|record_failed_spawn"
    - from: ".aether/utils/spawn-outcome-tracker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq updates to meta_learning section"
      pattern: "meta_learning\\..*confidence|spawn_outcomes"
    - from: ".aether/data/COLONY_STATE.json"
      to: "Phase 8"
      via: "Confidence scores used for Bayesian updating"
      pattern: "specialist_confidence"
---

<objective>
Implement spawn outcome tracking for meta-learning.

Purpose: Record spawn success/failure for Phase 8 Bayesian confidence scoring with asymmetric penalty (failures hurt more than successes help).

Output: spawn-outcome-tracker.sh with confidence scoring, updated spawn-tracker.sh integrated with outcome tracking, and COLONY_STATE.json with meta-learning sections.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-CONTEXT.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-RESEARCH.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-03-SUMMARY.md
@.aether/utils/spawn-tracker.sh
@.aether/data/COLONY_STATE.json
@.aether/utils/atomic-write.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update COLONY_STATE.json schema with meta_learning section</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
Update .aether/data/COLONY_STATE.json to add meta_learning section for confidence scoring.

Add to root level (extending existing meta_learning structure):

```json
{
  "meta_learning": {
    "total_spawns": 0,
    "successful_spawns": 0,
    "failed_spawns": 0,
    "active_specialist_types": [],
    "deprecated_specialist_types": [],
    "capability_confidence": {},
    "spawn_history": [],
    "generalization_matrix": {},
    "specialist_confidence": {},
    "spawn_outcomes": [],
    "last_updated": null
  }
}
```

The specialist_confidence object will store confidence scores:
```json
{
  "specialist_confidence": {
    "database_specialist": {
      "database": 0.7,
      "schema_migration": 0.8
    },
    "frontend_specialist": {
      "react": 0.9,
      "vue": 0.6
    }
  }
}
```

The spawn_outcomes array will track all spawn events:
```json
{
  "spawn_outcomes": [
    {
      "spawn_id": "spawn_1234567890",
      "specialist": "database_specialist",
      "task_type": "database",
      "outcome": "success",
      "timestamp": "2026-02-01T18:00:00Z"
    }
  ]
}
```

Use jq to update the existing meta_learning section:

```bash
jq '
  .meta_learning.specialist_confidence = {} |
  .meta_learning.spawn_outcomes = [] |
  .meta_learning.last_updated = null
' .aether/data/COLONY_STATE.json > /tmp/colony_state.tmp
```

Use atomic-write.sh to write the updated state.
</action>
  <verify>
```bash
# Verify meta_learning schema updated
jq -e '.meta_learning.specialist_confidence | type == "object"' .aether/data/COLONY_STATE.json
jq -e '.meta_learning.spawn_outcomes | type == "array"' .aether/data/COLONY_STATE.json
jq -e '.meta_learning | has("last_updated")' .aether/data/COLONY_STATE.json

# Verify schema is valid JSON
jq empty .aether/data/COLONY_STATE.json
```
</verify>
  <done>
- COLONY_STATE.json updated with meta_learning.specialist_confidence
- COLONY_STATE.json updated with meta_learning.spawn_outcomes
- COLONY_STATE.json updated with meta_learning.last_updated
- Schema is valid JSON
- Compatible with existing meta_learning structure
</done>
</task>

<task type="auto">
  <name>Task 2: Create spawn-outcome-tracker.sh with confidence scoring</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Create .aether/utils/spawn-outcome-tracker.sh with the following functions:

1. **record_successful_spawn(specialist_type, task_type, spawn_id)**
   - Increment confidence score for specialist-task pairing:
     - Get current confidence (default 0.5 if not exists)
     - Add 0.1 to confidence
     - Max confidence capped at 1.0
   - Add entry to spawn_outcomes array:
     ```json
     {
       "spawn_id": "spawn_1234567890",
       "specialist": "database_specialist",
       "task_type": "database",
       "outcome": "success",
       "timestamp": "2026-02-01T18:00:00Z"
     }
     ```
   - Update last_updated timestamp
   - Use atomic-write.sh for all updates

2. **record_failed_spawn(specialist_type, task_type, spawn_id, failure_reason)**
   - Decrement confidence score for specialist-task pairing:
     - Get current confidence (default 0.5 if not exists)
     - Subtract 0.15 from confidence (asymmetric penalty)
     - Min confidence capped at 0.0
   - Add entry to spawn_outcomes array with failure reason:
     ```json
     {
       "spawn_id": "spawn_1234567890",
       "specialist": "database_specialist",
       "task_type": "database",
       "outcome": "failure",
       "reason": "Could not connect to database",
       "timestamp": "2026-02-01T18:00:00Z"
     }
     ```
   - Update last_updated timestamp
   - Use atomic-write.sh for all updates

3. **get_specialist_confidence(specialist_type, task_type)**
   - Read specialist_confidence from meta_learning
   - Return confidence score for specialist-task pairing
   - Default to 0.5 if no history exists
   - Output: float confidence score (0.0 - 1.0)

Confidence scoring rules:
- Start at 0.5 (neutral)
- Success: +0.1 (up to max 1.0)
- Failure: -0.15 (down to min 0.0, asymmetric penalty)
- Asymmetric penalty makes failures more impactful
- This feeds Phase 8 Bayesian updating

All functions:
- Source .aether/utils/atomic-write.sh
- Use jq for all JSON operations
- Use atomic writes for all state updates
- Export functions for use in other scripts
</action>
  <verify>
```bash
# Test script execution
chmod +x .aether/utils/spawn-outcome-tracker.sh
source .aether/utils/spawn-outcome-tracker.sh

# Test get_specialist_confidence (default)
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.5" ]; then
  echo "PASS: Default confidence is 0.5"
fi

# Test record_successful_spawn
record_successful_spawn "database_specialist" "database" "spawn_123"

# Verify confidence incremented
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.6" ]; then
  echo "PASS: Success incremented confidence to 0.6"
fi

# Test another success (should go to 0.7)
record_successful_spawn "database_specialist" "database" "spawn_124"
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.7" ]; then
  echo "PASS: Second success incremented confidence to 0.7"
fi

# Test record_failed_spawn
record_failed_spawn "database_specialist" "database" "spawn_125" "Connection timeout"

# Verify confidence decremented (asymmetric penalty)
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.55" ]; then
  echo "PASS: Failure decremented confidence by 0.15 to 0.55"
fi

# Verify spawn_outcomes recorded
outcome_count=$(jq -r '.meta_learning.spawn_outcomes | length' .aether/data/COLONY_STATE.json)
if [ "$outcome_count" -eq 3 ]; then
  echo "PASS: 3 outcomes recorded"
fi
```
</verify>
  <done>
- spawn-outcome-tracker.sh exists and is executable
- All 3 functions implemented and tested
- Confidence scores start at 0.5
- Success increments by 0.1 (max 1.0)
- Failure decrements by 0.15 (min 0.0, asymmetric)
- spawn_outcomes array tracks all events
- All state updates use atomic writes
</done>
</task>

<task type="auto">
  <name>Task 3: Update spawn-tracker.sh to integrate outcome tracking</name>
  <files>.aether/utils/spawn-tracker.sh</files>
  <action>
Update .aether/utils/spawn-tracker.sh to integrate confidence scoring:

1. **Source spawn-outcome-tracker.sh**
   - Add `source .aether/utils/spawn-outcome-tracker.sh` at top of file

2. **Update record_outcome() to call confidence tracking**
   - After updating spawn_history and performance_metrics
   - If outcome is "success":
     - Extract specialist_type from spawn_history
     - Derive task_type from task_context or use "general"
     - Call record_successful_spawn(specialist_type, task_type, spawn_id)
   - If outcome is "failure":
     - Extract specialist_type from spawn_history
     - Derive task_type from task_context or use "general"
     - Extract failure_reason from notes parameter
     - Call record_failed_spawn(specialist_type, task_type, spawn_id, failure_reason)

3. **Add task_type derivation logic**
   - Create helper function derive_task_type(task_context)
   - Use spawn-decision.sh's analyze_task_requirements if available
   - Fallback: simple keyword matching for common task types
   - Return: task_type string (database, frontend, backend, api, testing, security, etc.)

4. **Update exports**
   - Export get_specialist_confidence for use in spawning decisions
   - This allows Worker Ants to check confidence before spawning

Updated record_outcome() flow:
1. Update spawn_history entry with outcome, completed_at, notes
2. Update performance_metrics (successful_spawns or failed_spawns)
3. Decrement depth
4. Derive task_type from task_context
5. Call record_successful_spawn() or record_failed_spawn()
</action>
  <verify>
```bash
# Test integration
source .aether/utils/spawn-tracker.sh

# Record a spawn
spawn_id=$(record_spawn "builder" "database_specialist" "Database schema migration")

# Record successful outcome
record_outcome "$spawn_id" "success" "Migration completed"

# Verify confidence updated
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.6" ]; then
  echo "PASS: Integration updated confidence on success"
fi

# Record another spawn and failure
spawn_id2=$(record_spawn "builder" "database_specialist" "Database backup")
record_outcome "$spawn_id2" "failure" "Could not connect to database"

# Verify confidence decreased
confidence=$(get_specialist_confidence "database_specialist" "database")
if [ "$confidence" = "0.45" ]; then
  echo "PASS: Integration decreased confidence on failure"
fi

# Verify spawn_outcomes recorded
outcome_count=$(jq -r '.meta_learning.spawn_outcomes | length' .aether/data/COLONY_STATE.json)
if [ "$outcome_count" -gt 0 ]; then
  echo "PASS: Outcomes tracked in meta_learning"
fi
```
</verify>
  <done>
- spawn-tracker.sh sources spawn-outcome-tracker.sh
- record_outcome() calls confidence tracking functions
- task_type derived from task_context
- Confidence scores updated on spawn completion
- get_specialist_confidence() exported for spawning decisions
- Meta-learning data populated for Phase 8
</done>
</task>

</tasks>

<verification>
## Overall Verification

1. **COLONY_STATE.json schema updated**
   - meta_learning.specialist_confidence object exists
   - meta_learning.spawn_outcomes array exists
   - meta_learning.last_updated timestamp exists

2. **spawn-outcome-tracker.sh works**
   - record_successful_spawn() increments confidence by 0.1
   - record_failed_spawn() decrements confidence by 0.15
   - get_specialist_confidence() returns current score
   - Confidence capped at 1.0 max, 0.0 min
   - All state updates use atomic writes

3. **spawn-tracker.sh integrated**
   - record_outcome() calls confidence tracking
   - task_type derived from task_context
   - Meta-learning data populated automatically

4. **Integration verified**
   - All spawning safeguards work together
   - Meta-learning foundation ready for Phase 8
   - Confidence scores will feed Bayesian updating
</verification>

<success_criteria>
- Spawn outcomes tracked in meta_learning section
- Confidence scores updated for each spawn event
- Confidence scores start at 0.5, range 0.0-1.0
- Success: +0.1, Failure: -0.15 (asymmetric penalty)
- Meta-learning data ready for Phase 8 Bayesian updating
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-04-SUMMARY.md` with:
- COLONY_STATE.json schema changes
- Functions implemented in spawn-outcome-tracker.sh
- Integration with spawn-tracker.sh
- Verification results
- Any issues encountered and resolutions
</output>
