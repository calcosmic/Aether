---
phase: 06-autonomous-emergence
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .aether/utils/spawn-tracker.sh
  - .aether/data/COLONY_STATE.json
  - .aether/workers/builder-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/architect-ant.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Worker Ant can spawn specialist via Task tool with inherited context"
    - "Spawned specialist inherits parent's goal, pheromones, working memory, and constraints"
    - "Resource budget limits total spawns to 10 per phase"
    - "Spawn counter increments when specialist spawned"
    - "Spawn history records spawn events for debugging and meta-learning"
  artifacts:
    - path: ".aether/utils/spawn-tracker.sh"
      provides: "Resource budget enforcement and spawn tracking"
      exports: ["can_spawn", "record_spawn", "record_outcome"]
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Spawn tracking state"
      contains: "resource_budgets, spawn_tracking"
    - path: ".aether/workers/builder-ant.md"
      provides: "Task tool spawning with context inheritance template"
      contains: "Task tool spawn call with inherited context"
  key_links:
    - from: ".aether/workers/builder-ant.md"
      to: ".aether/utils/spawn-tracker.sh"
      via: "source spawn-tracker.sh before spawning"
      pattern: "source.*spawn-tracker\\.sh"
    - from: ".aether/utils/spawn-tracker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq atomic writes to update spawn counters"
      pattern: "jq.*resource_budgets|spawn_tracking"
    - from: ".aether/data/pheromones.json"
      to: "spawned specialist context"
      via: "pheromone signals passed in inherited context"
      pattern: "pheromones"
    - from: ".aether/data/memory.json"
      to: "spawned specialist context"
      via: "working memory items passed in inherited context"
      pattern: "working.*memory"
---

<objective>
Implement Task tool spawning with context inheritance and spawn budget tracking.

Purpose: Enable Worker Ants to spawn specialists via Claude Code Task tool with full context inheritance, while enforcing resource budget limits (max 10 spawns per phase).

Output: spawn-tracker.sh with resource enforcement functions, COLONY_STATE.json updated with spawn tracking, and Worker Ant prompts updated with Task tool spawning template.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-CONTEXT.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-RESEARCH.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-01-SUMMARY.md
@.aether/data/COLONY_STATE.json
@.aether/utils/atomic-write.sh
@.aether/utils/file-lock.sh
@.aether/data/pheromones.json
@.aether/data/memory.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update COLONY_STATE.json schema with spawn tracking sections</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
Update .aether/data/COLONY_STATE.json to add spawn tracking sections to the existing schema.

Add to root level:

```json
{
  "resource_budgets": {
    "max_spawns_per_phase": 10,
    "current_spawns": 0,
    "max_spawn_depth": 3,
    "circuit_breaker_trips": 0,
    "circuit_breaker_cooldown_until": null
  },
  "spawn_tracking": {
    "depth": 0,
    "total_spawns": 0,
    "spawn_history": [],
    "failed_specialist_types": [],
    "cooldown_specialists": [],
    "circuit_breaker_history": []
  },
  "performance_metrics": {
    "successful_spawns": 0,
    "failed_spawns": 0,
    "avg_spawn_duration_seconds": 0
  }
}
```

These sections should be added to the existing COLONY_STATE.json structure using jq:

```bash
jq '
  .resource_budgets = {
    "max_spawns_per_phase": 10,
    "current_spawns": 0,
    "max_spawn_depth": 3,
    "circuit_breaker_trips": 0,
    "circuit_breaker_cooldown_until": null
  } |
  .spawn_tracking = {
    "depth": 0,
    "total_spawns": 0,
    "spawn_history": [],
    "failed_specialist_types": [],
    "cooldown_specialists": [],
    "circuit_breaker_history": []
  } |
  .performance_metrics = {
    "successful_spawns": 0,
    "failed_spawns": 0,
    "avg_spawn_duration_seconds": 0
  }
' .aether/data/COLONY_STATE.json > /tmp/colony_state.tmp
```

Use atomic-write.sh to write the updated state.
</action>
  <verify>
```bash
# Verify schema updated
jq -e '.resource_budgets.max_spawns_per_phase == 10' .aether/data/COLONY_STATE.json
jq -e '.spawn_tracking.depth == 0' .aether/data/COLONY_STATE.json
jq -e '.performance_metrics.successful_spawns == 0' .aether/data/COLONY_STATE.json

# Verify arrays exist
jq -e '.spawn_tracking.spawn_history | type == "array"' .aether/data/COLONY_STATE.json
jq -e '.spawn_tracking.failed_specialist_types | type == "array"' .aether/data/COLONY_STATE.json
```
</verify>
  <done>
- COLONY_STATE.json updated with resource_budgets section
- COLONY_STATE.json updated with spawn_tracking section
- COLONY_STATE.json updated with performance_metrics section
- All spawn counters initialized to 0
- Schema is valid JSON
</done>
</task>

<task type="auto">
  <name>Task 2: Create spawn-tracker.sh with resource enforcement functions</name>
  <files>.aether/utils/spawn-tracker.sh</files>
  <action>
Create .aether/utils/spawn-tracker.sh with the following functions:

1. **can_spawn()**
   - Check spawn budget: current_spawns < max_spawns_per_phase (10)
   - Check spawn depth: depth < max_spawn_depth (3)
   - Check circuit breaker: circuit_breaker_trips < 3
   - Check cooldown: circuit_breaker_cooldown_until < now (if set)
   - Use file-lock.sh to prevent concurrent spawn decisions
   - Return: 0 (can spawn) or 1 (cannot spawn) with error message

2. **record_spawn(parent_caste, specialist_type, task_context)**
   - Generate spawn_id: "spawn_$(date +%s)"
   - Increment current_spawns in resource_budgets
   - Increment depth in spawn_tracking
   - Increment total_spawns in spawn_tracking
   - Add entry to spawn_history array:
     ```json
     {
       "id": "spawn_1234567890",
       "parent": "builder",
       "specialist": "database_specialist",
       "task": "Database schema migration",
       "timestamp": "2026-02-01T18:00:00Z",
       "depth": 1,
       "outcome": "pending"
     }
     ```
   - Use atomic-write.sh for all updates
   - Return: spawn_id

3. **record_outcome(spawn_id, outcome, notes)**
   - Find spawn_history entry by spawn_id
   - Update outcome: "success" or "failure"
   - Add completed_at timestamp
   - Add notes (failure reason or success details)
   - Update performance_metrics:
     - If success: increment successful_spawns
     - If failure: increment failed_spawns
   - Decrement spawn_tracking.depth
   - Use atomic-write.sh for all updates

All functions:
- Source .aether/utils/atomic-write.sh
- Source .aether/utils/file-lock.sh
- Use jq for all JSON operations
- Use atomic writes for all state updates
- Export functions for use in Worker Ant prompts
</action>
  <verify>
```bash
# Test script execution
chmod +x .aether/utils/spawn-tracker.sh
source .aether/utils/spawn-tracker.sh

# Test can_spawn (should succeed with fresh state)
if can_spawn; then
  echo "PASS: can_spawn allows spawn"
else
  echo "FAIL: can_spawn blocked spawn unexpectedly"
fi

# Test record_spawn
spawn_id=$(record_spawn "builder" "database_specialist" "Test task")
echo "Spawn ID: $spawn_id"
if [[ $spawn_id == spawn_* ]]; then
  echo "PASS: record_spawn returned valid spawn_id"
fi

# Verify state updated
current_spawns=$(jq -r '.resource_budgets.current_spawns' .aether/data/COLONY_STATE.json)
if [ "$current_spawns" -gt 0 ]; then
  echo "PASS: Spawn counter incremented"
fi

# Test record_outcome
record_outcome "$spawn_id" "success" "Task completed successfully"

# Verify outcome recorded
outcome=$(jq -r ".spawn_tracking.spawn_history[] | select(.id == \"$spawn_id\") | .outcome" .aether/data/COLONY_STATE.json)
if [ "$outcome" == "success" ]; then
  echo "PASS: Outcome recorded correctly"
fi
```
</verify>
  <done>
- spawn-tracker.sh exists and is executable
- All 3 functions implemented and tested
- Functions use file locks for concurrent spawn prevention
- All state updates use atomic writes
- Spawn history tracks spawn events with metadata
- Performance metrics track success/failure counts
</done>
</task>

<task type="auto">
  <name>Task 3: Add Task tool spawning template to all Worker Ant prompts</name>
  <files>.aether/workers/builder-ant.md, .aether/workers/colonizer-ant.md, .aether/workers/route-setter-ant.md, .aether/workers/scout-ant.md, .aether/workers/watcher-ant.md, .aether/workers/architect-ant.md</files>
  <action>
Update the existing "## Autonomous Spawning" section in each Worker Ant prompt.

Replace the existing Task tool example with a comprehensive template that includes:

```markdown
## Autonomous Spawning

### Check Resource Constraints

Before spawning, verify resource limits:

```bash
# Source spawn tracking functions
source .aether/utils/spawn-tracker.sh

# Check if spawn is allowed
if ! can_spawn; then
  echo "Cannot spawn specialist: resource constraints"
  # Handle constraint - attempt task yourself or report to parent
fi
```

### Spawn Specialist via Task Tool

When spawning a specialist, use this template:

```
Task: {specialist_type} Specialist

## Inherited Context

### Queen's Goal
{from COLONY_STATE.json: goal or queen_intention}

### Active Pheromone Signals
{from pheromones.json: active_pheromones, filtered by relevance}
- FOCUS: {context} (strength: {strength})
- REDIRECT: {context} (strength: {strength})

### Working Memory (Recent Context)
{from memory.json: working_memory, sorted by relevance_score}
- {item.content} (relevance: {item.relevance_score})

### Constraints (from REDIRECT pheromones)
{from memory.json: short_term patterns with type=constraint}
- {pattern.content}

### Parent Context
Parent caste: {your_caste}
Parent task: {your_current_task}
Spawn depth: {current_depth + 1}/3
Spawn ID: {spawn_id_from_record_spawn()}

## Your Specialization

You are a {specialist_type} specialist with expertise in:
- {capability_1}
- {capability_2}
- {capability_3}

Your parent ({parent_caste} Ant) detected a capability gap and spawned you.

## Your Task

{specific_specialist_task}

## Execution Instructions

1. Use your specialized expertise to complete the task
2. Respect inherited constraints (from REDIRECT pheromones)
3. Follow active focus areas (from FOCUS pheromones)
4. Add findings to working memory via memory-ops.sh
5. Report outcome to parent using the template below

## Outcome Report Template

After completing (or failing) the task, report:

```
## Spawn Outcome

Spawn ID: {spawn_id}
Specialist: {specialist_type}
Task: {task_description}

Result: [✓ SUCCESS | ✗ FAILURE]

What was accomplished:
{for success: what was done}

What went wrong:
{for failure: error, what was tried}

Recommendations:
{for parent: what to do next}
```

Parent Ant will use this outcome to call record_outcome().
```

### Record Spawn Event

Before calling Task tool, record the spawn:

```bash
# Record spawn event
spawn_id=$(record_spawn "{your_caste}" "{specialist_type}" "{task_context}")
echo "Spawn ID: $spawn_id"
```

### Record Spawn Outcome

After specialist completes, record outcome:

```bash
# Record successful spawn
record_outcome "$spawn_id" "success" "Specialist completed task successfully"

# OR record failed spawn
record_outcome "$spawn_id" "failure" "Reason for failure"
```
```

Ensure this template appears AFTER the "Capability Gap Detection" section added in 06-01.
</action>
  <verify>
```bash
# Verify all workers have updated spawning section
for worker in builder-ant colonizer-ant route-setter-ant scout-ant watcher-ant architect-ant; do
  if ! grep -q "source .aether/utils/spawn-tracker.sh" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing spawn-tracker.sh source"
    exit 1
  fi
  if ! grep -q "## Inherited Context" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing Inherited Context section"
    exit 1
  fi
  if ! grep -q "record_outcome" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing record_outcome call"
    exit 1
  fi
  echo "PASS: ${worker} has complete spawning template"
done
```
</verify>
  <done>
- All 6 Worker Ant prompts have source spawn-tracker.sh
- Task tool template includes all inherited context sections
- Template shows Queen's Goal, Pheromones, Working Memory, Constraints
- Template shows Parent Context (caste, task, spawn depth, spawn ID)
- Template includes specialist specialization description
- Template includes execution instructions
- Template includes outcome report template
- record_spawn() called before Task tool
- record_outcome() called after specialist completes
</done>
</task>

</tasks>

<verification>
## Overall Verification

1. **COLONY_STATE.json updated**
   - resource_budgets section exists with max_spawns_per_phase=10
   - spawn_tracking section exists with depth=0, spawn_history=[]
   - performance_metrics section exists with success/failure counters

2. **spawn-tracker.sh works**
   - can_spawn() checks budget, depth, circuit breaker, cooldown
   - record_spawn() creates spawn history entries with spawn_id
   - record_outcome() updates spawn history and performance metrics
   - All functions use atomic writes and file locks

3. **Worker Ant prompts updated**
   - All workers source spawn-tracker.sh
   - Task tool template includes full context inheritance
   - record_spawn() called before Task tool
   - record_outcome() called after specialist completes

4. **Integration verified**
   - Capability detection (06-01) flows into resource constraints
   - Resource constraints checked before spawning
   - Context inheritance template complete
   - Spawn lifecycle tracked from creation to outcome
</verification>

<success_criteria>
- Worker Ants can spawn specialists via Task tool
- Spawned specialists inherit full context (goal, pheromones, memory, constraints)
- Resource budget limits spawns to 10 per phase
- Every spawn event is tracked with spawn_id
- Spawn outcomes are recorded for meta-learning
- No spawn can exceed resource constraints
- Concurrent spawns prevented by file locks
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-02-SUMMARY.md` with:
- COLONY_STATE.json schema changes
- Functions implemented in spawn-tracker.sh
- Task tool spawning template added to Worker Ants
- Verification results
- Any issues encountered and resolutions
</output>
