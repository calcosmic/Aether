---
phase: 06-autonomous-emergence
plan: 05
type: execute
wave: 5
depends_on: ["06-04"]
files_modified:
  - .aether/utils/test-spawning-safeguards.sh
  - .aether/workers/builder-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/architect-ant.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Spawn depth limit prevents infinite spawn chains (max 3 levels)"
    - "Circuit breaker triggers after 3 failed spawns of same specialist type"
    - "Circuit breaker cooldown prevents spawning failed specialist for 30 minutes"
    - "Same-specialist cache prevents spawning identical specialist for same task"
    - "All spawning safeguards verified by automated test suite"
  artifacts:
    - path: ".aether/utils/test-spawning-safeguards.sh"
      provides: "Comprehensive safeguard verification test suite"
      exports: ["test_depth_limit", "test_circuit_breaker", "test_spawn_budget", "test_confidence_scoring"]
    - path: ".aether/workers/builder-ant.md"
      provides: "Updated with safeguard verification instructions"
      contains: "Testing safeguards section"
  key_links:
    - from: ".aether/utils/test-spawning-safeguards.sh"
      to: ".aether/utils/spawn-tracker.sh"
      via: "tests can_spawn, record_spawn, record_outcome"
      pattern: "can_spawn|record_spawn|record_outcome"
    - from: ".aether/utils/test-spawning-safeguards.sh"
      to: ".aether/utils/circuit-breaker.sh"
      via: "tests circuit breaker functions"
      pattern: "check_circuit_breaker|record_spawn_failure"
    - from: ".aether/utils/test-spawning-safeguards.sh"
      to: ".aether/utils/spawn-outcome-tracker.sh"
      via: "tests confidence scoring"
      pattern: "record_successful_spawn|get_specialist_confidence"
---

<objective>
Create verification test suite and update Worker Ants with safeguard testing guidance.

Purpose: Verify all spawning safeguards (depth limit, circuit breaker, spawn budget, same-specialist cache, confidence scoring) work correctly and prevent infinite loops.

Output: test-spawning-safeguards.sh with comprehensive test suite, Worker Ant prompts updated with safeguard verification instructions, and confirmation that all safeguards prevent infinite loops.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-CONTEXT.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-RESEARCH.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-04-SUMMARY.md
@.aether/utils/spawn-tracker.sh
@.aether/utils/circuit-breaker.sh
@.aether/utils/spawn-outcome-tracker.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test-spawning-safeguards.sh with comprehensive safeguard tests</name>
  <files>.aether/utils/test-spawning-safeguards.sh</files>
  <action>
Create .aether/utils/test-spawning-safeguards.sh with comprehensive tests for all spawning safeguards.

Test suite should verify:

1. **Depth limit prevents infinite chains**
   - Set depth to 3 (max)
   - Attempt spawn (should fail)
   - Verify error message mentions depth limit
   - Reset depth
   - Verify spawn succeeds

2. **Circuit breaker triggers after 3 failures**
   - Record 3 failed spawns of same specialist
   - Verify circuit_breaker_trips = 3
   - Verify cooldown_until timestamp set
   - Attempt spawn (should fail)
   - Verify error message mentions circuit breaker

3. **Spawn budget limits spawns**
   - Set current_spawns to 10
   - Attempt spawn (should fail)
   - Verify error message mentions spawn budget
   - Reset current_spawns
   - Verify spawn succeeds

4. **Same-specialist cache prevents duplicates**
   - Record pending spawn of specialist
   - Attempt spawn same specialist for same task
   - Verify detection in Worker Ant logic

5. **Confidence scoring works**
   - Record success, verify confidence +0.1
   - Record failure, verify confidence -0.15
   - Verify confidence capped at 1.0 max
   - Verify confidence floored at 0.0 min

6. **Meta-learning data populated**
   - Verify spawn_outcomes array populated
   - Verify specialist_confidence object updated
   - Verify last_updated timestamp set

Create test script with:
- Test setup/teardown
- Clear pass/fail output
- Summary report at end
- Exit code 0 if all pass, 1 if any fail
</action>
  <verify>
```bash
# Run test suite
chmod +x .aether/utils/test-spawning-safeguards.sh
bash .aether/utils/test-spawning-safeguards.sh

# Should see output like:
# Testing depth limit... PASS
# Testing circuit breaker... PASS
# Testing spawn budget... PASS
# Testing confidence scoring... PASS
# Testing meta-learning... PASS
#
# Summary: 5/5 tests passed

# Verify exit code
if [ $? -eq 0 ]; then
  echo "PASS: All safeguard tests passed"
else
  echo "FAIL: Some safeguard tests failed"
fi
```
</verify>
  <done>
- test-spawning-safeguards.sh exists and is executable
- All 6 safeguard categories tested
- Depth limit test passes
- Circuit breaker test passes
- Spawn budget test passes
- Same-specialist cache test passes
- Confidence scoring test passes
- Meta-learning data test passes
- Test suite produces clear pass/fail output
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete spawning safeguard system with all 6 safeguards (depth limit, circuit breaker, spawn budget, same-specialist cache, confidence scoring, meta-learning)</what-built>
  <how-to-verify>
Run the test suite to verify all safeguards work:

```bash
cd /Users/callumcowie/repos/Aether
bash .aether/utils/test-spawning-safeguards.sh
```

Expected output:
- All 6 safeguard tests should PASS
- Summary should show "6/6 tests passed"
- Exit code should be 0

Then manually verify the safeguard behavior by:
1. Check that COLONY_STATE.json has all tracking sections
2. Verify test-spawning-safeguards.sh contains comprehensive tests
3. Verify Worker Ant prompts have safeguard sections
4. Review test output to confirm no infinite loops are possible
  </how-to-verify>
  <resume-signal>Type "approved" if all safeguards work correctly, or describe issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Update Worker Ant prompts with safeguard verification guidance</name>
  <files>.aether/workers/builder-ant.md, .aether/workers/colonizer-ant.md, .aether/workers/route-setter-ant.md, .aether/workers/scout-ant.md, .aether/workers/watcher-ant.md, .aether/workers/architect-ant.md</files>
  <action>
Add a "## Testing Safeguards" section to each Worker Ant prompt after the "## Circuit Breakers" section.

```markdown
## Testing Safeguards

To verify spawning safeguards work correctly, run the test suite:

```bash
bash .aether/utils/test-spawning-safeguards.sh
```

This tests:
- Depth limit (prevents infinite chains)
- Circuit breaker (triggers after 3 failures)
- Spawn budget (max 10 per phase)
- Same-specialist cache (prevents duplicates)
- Confidence scoring (tracks specialist performance)
- Meta-learning data (populates correctly)

All tests should pass. If any test fails, investigate the safeguard before spawning specialists.

### Safeguard Behavior Summary

| Safeguard | Trigger | Behavior | Reset |
|-----------|---------|----------|-------|
| Depth limit | depth >= 3 | Blocks spawn, consolidates work | Auto on specialist completion |
| Circuit breaker | 3 failures of same type | 30-min cooldown | Auto after cooldown or manual reset |
| Spawn budget | current_spawns >= 10 | Blocks spawn, phase limit | Auto on phase reset |
| Same-specialist cache | Pending spawn of same type | Waits for existing | Auto on specialist completion |

### Manual Reset

If you've resolved the underlying issue and want to retry spawns:

```bash
source .aether/utils/circuit-breaker.sh
reset_circuit_breaker
```

This is useful after fixing the root cause of repeated failures.
```

Ensure this section is integrated with existing circuit breaker documentation.
</action>
  <verify>
```bash
# Verify all workers have testing safeguards section
for worker in builder-ant colonizer-ant route-setter-ant scout-ant watcher-ant architect-ant; do
  if ! grep -q "## Testing Safeguards" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing Testing Safeguards section"
    exit 1
  fi
  if ! grep -q "test-spawning-safeguards.sh" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing test suite reference"
    exit 1
  fi
  echo "PASS: ${worker} has Testing Safeguards section"
done
```
</verify>
  <done>
- All 6 Worker Ant prompts have "## Testing Safeguards" section
- Section includes test suite command
- Section includes safeguard behavior summary table
- Section includes manual reset instructions
- Section integrated with existing circuit breaker documentation
</done>
</task>

</tasks>

<verification>
## Overall Verification

1. **test-spawning-safeguards.sh works**
   - All 6 safeguard categories tested
   - Depth limit test passes
   - Circuit breaker test passes
   - Spawn budget test passes
   - Same-specialist cache test passes
   - Confidence scoring test passes
   - Meta-learning data test passes
   - Clear pass/fail output
   - Exit code 0 if all pass, 1 if any fail

2. **Worker Ant prompts updated**
   - All workers have "## Testing Safeguards" section
   - Test suite command documented
   - Safeguard behavior summary table included
   - Manual reset instructions included

3. **Safeguards verified**
   - Depth limit prevents infinite chains
   - Circuit breaker triggers on 3 failures
   - Spawn budget enforced (max 10)
   - Same-specialist cache prevents duplicates
   - Confidence scoring works correctly
   - Meta-learning data populated

4. **Integration verified**
   - All safeguards work together
   - No infinite loops possible
   - Meta-learning foundation ready for Phase 8
</verification>

<success_criteria>
- All spawning safeguards tested and verified
- Test suite confirms no infinite loops possible
- Worker Ants have safeguard testing guidance
- Meta-learning data ready for Phase 8 Bayesian updating
- Phase 06 complete and ready for execution
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-05-SUMMARY.md` with:
- Test suite implementation
- Test results (all safeguards passing)
- Worker Ant prompt updates
- Verification that no infinite loops are possible
- Confirmation that Phase 06 is complete
- Any issues encountered and resolutions
</output>
