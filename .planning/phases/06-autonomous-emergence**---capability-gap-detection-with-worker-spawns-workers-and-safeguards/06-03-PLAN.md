---
phase: 06-autonomous-emergence
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - .aether/utils/circuit-breaker.sh
  - .aether/utils/spawn-tracker.sh
  - .aether/data/COLONY_STATE.json
  - .aether/workers/builder-ant.md
  - .aether/workers/colonizer-ant.md
  - .aether/workers/route-setter-ant.md
  - .aether/workers/scout-ant.md
  - .aether/workers/watcher-ant.md
  - .aether/workers/architect-ant.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Spawn depth limit prevents infinite spawn chains (max 3 levels)"
    - "Circuit breaker triggers after 3 failed spawns of same specialist type"
    - "Circuit breaker cooldown prevents spawning failed specialist for 30 minutes"
    - "Same-specialist cache prevents spawning identical specialist for same task"
    - "Depth decrements when specialist completes, parent can spawn again"
  artifacts:
    - path: ".aether/utils/circuit-breaker.sh"
      provides: "Circuit breaker logic for failed spawn detection"
      exports: ["check_circuit_breaker", "record_spawn_failure", "trigger_circuit_breaker_cooldown", "reset_circuit_breaker"]
    - path: ".aether/utils/spawn-tracker.sh"
      provides: "Updated with depth limit enforcement"
      contains: "depth tracking and decrement logic"
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Circuit breaker state"
      contains: "circuit_breaker_trips, circuit_breaker_cooldown_until, cooldown_specialists"
  key_links:
    - from: ".aether/utils/circuit-breaker.sh"
      to: ".aether/utils/spawn-tracker.sh"
      via: "check_circuit_breaker called in can_spawn"
      pattern: "check_circuit_breaker"
    - from: ".aether/utils/circuit-breaker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq updates to circuit breaker state"
      pattern: "circuit_breaker_trips|circuit_breaker_cooldown_until"
    - from: ".aether/utils/spawn-tracker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "depth tracking in spawn_tracking"
      pattern: "spawn_tracking.depth"
---

<objective>
Implement spawn depth limit and circuit breaker to prevent infinite spawn loops.

Purpose: Prevent infinite spawn chains through depth limiting (max 3 levels: parent → child → grandchild) and circuit breaker (3 failed spawns → 30-minute cooldown).

Output: circuit-breaker.sh with failed spawn detection, updated spawn-tracker.sh with depth enforcement, and Worker Ant prompts updated with safeguard checks.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-CONTEXT.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-RESEARCH.md
@.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-02-SUMMARY.md
@.aether/utils/spawn-tracker.sh
@.aether/data/COLONY_STATE.json
@.aether/utils/atomic-write.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create circuit-breaker.sh with failed spawn detection</name>
  <files>.aether/utils/circuit-breaker.sh</files>
  <action>
Create .aether/utils/circuit-breaker.sh with the following functions:

1. **check_circuit_breaker(specialist_type)**
   - Check circuit_breaker_trips in resource_budgets
   - Check circuit_breaker_cooldown_until timestamp
   - If cooldown_until set and > now, check if expired
   - If expired, call reset_circuit_breaker() automatically
   - If trips >= 3, return 1 (circuit breaker active)
   - Return: 0 (can spawn) or 1 (circuit breaker active) with message

2. **record_spawn_failure(specialist_type, spawn_id, failure_reason)**
   - Count recent failures of this specialist_type in spawn_history
   - Increment circuit_breaker_trips in resource_budgets
   - Add specialist_type to failed_specialist_types array
   - Add entry to circuit_breaker_history:
     ```json
     {
       "specialist": "database_specialist",
       "failures": 3,
       "reason": "Specialist could not connect to database",
       "timestamp": "2026-02-01T18:00:00Z"
     }
     ```
   - If failures >= 3, call trigger_circuit_breaker_cooldown()
   - Use atomic-write.sh for all updates

3. **trigger_circuit_breaker_cooldown(specialist_type)**
   - Calculate cooldown timestamp: now + 30 minutes
   - Use date command for timestamp calculation:
     - macOS: `date -u -v+30M +"%Y-%m-%dT%H:%M:%SZ"`
     - Linux: `date -u -d "+30 minutes" +"%Y-%m-%dT%H:%M:%SZ"`
   - Set circuit_breaker_cooldown_until in resource_budgets
   - Add specialist_type to cooldown_specialists array
   - Use atomic-write.sh for updates
   - Print warning message with cooldown expiration

4. **reset_circuit_breaker()**
   - Set circuit_breaker_trips = 0 in resource_budgets
   - Set circuit_breaker_cooldown_until = null in resource_budgets
   - Clear failed_specialist_types array
   - Use atomic-write.sh for updates
   - Print success message

All functions:
- Source .aether/utils/atomic-write.sh
- Use jq for all JSON operations
- Use atomic writes for all state updates
- Export functions for use in other scripts
</action>
  <verify>
```bash
# Test script execution
chmod +x .aether/utils/circuit-breaker.sh
source .aether/utils/circuit-breaker.sh

# Test check_circuit_breaker (should succeed with fresh state)
if check_circuit_breaker "database_specialist"; then
  echo "PASS: Circuit breaker allows spawn"
else
  echo "FAIL: Circuit breaker blocked spawn unexpectedly"
fi

# Test record_spawn_failure
record_spawn_failure "database_specialist" "spawn_123" "Connection timeout"

# Verify trip count incremented
trips=$(jq -r '.resource_budgets.circuit_breaker_trips' .aether/data/COLONY_STATE.json)
if [ "$trips" -eq 1 ]; then
  echo "PASS: Circuit breaker trip incremented"
fi

# Test 3 failures trigger cooldown
record_spawn_failure "database_specialist" "spawn_124" "Connection timeout"
record_spawn_failure "database_specialist" "spawn_125" "Connection timeout"

# Verify cooldown set
cooldown=$(jq -r '.resource_budgets.circuit_breaker_cooldown_until' .aether/data/COLONY_STATE.json)
if [ -n "$cooldown" ] && [ "$cooldown" != "null" ]; then
  echo "PASS: Circuit breaker cooldown triggered"
fi

# Test check_circuit_breaker after cooldown
if ! check_circuit_breaker "database_specialist"; then
  echo "PASS: Circuit breaker blocks spawn during cooldown"
fi

# Test reset_circuit_breaker
reset_circuit_breaker

# Verify reset
trips=$(jq -r '.resource_budgets.circuit_breaker_trips' .aether/data/COLONY_STATE.json)
if [ "$trips" -eq 0 ]; then
  echo "PASS: Circuit breaker reset successful"
fi
```
</verify>
  <done>
- circuit-breaker.sh exists and is executable
- All 4 functions implemented and tested
- check_circuit_breaker prevents spawning when trips >= 3 or cooldown active
- record_spawn_failure increments trips and triggers cooldown at 3 failures
- trigger_circuit_breaker_cooldown sets 30-minute cooldown timestamp
- reset_circuit_breaker clears all circuit breaker state
- All state updates use atomic writes
</done>
</task>

<task type="auto">
  <name>Task 2: Update spawn-tracker.sh with depth limit enforcement</name>
  <files>.aether/utils/spawn-tracker.sh</files>
  <action>
Update .aether/utils/spawn-tracker.sh to add depth limit enforcement:

1. **Update can_spawn() to check depth**
   - Add depth check after existing budget check
   - Read spawn_tracking.depth from COLONY_STATE.json
   - Read resource_budgets.max_spawn_depth from COLONY_STATE.json
   - If depth >= max_spawn_depth, return 1 with error message
   - Error message: "Max spawn depth reached: {depth}/{max_depth}. Task must be handled at current level."

2. **Update record_spawn() to increment depth**
   - After incrementing current_spawns, increment depth
   - Ensure depth is incremented atomically with other counters
   - Store depth in spawn_history entry

3. **Update record_outcome() to decrement depth**
   - After updating spawn_history entry and performance_metrics, decrement depth
   - Use jq: `.spawn_tracking.depth |= max(0; . - 1)`
   - Ensure depth never goes below 0

4. **Source circuit-breaker.sh in can_spawn()**
   - Add `source .aether/utils/circuit-breaker.sh` at top of file
   - Add circuit breaker check in can_spawn() after depth check
   - Call check_circuit_breaker with specialist_type parameter
   - Return 1 if circuit breaker active

Updated can_spawn() flow:
1. Acquire file lock
2. Check spawn budget (current_spawns < max_spawns_per_phase)
3. Check spawn depth (depth < max_spawn_depth)
4. Check circuit breaker (trips < 3 and cooldown expired)
5. Release lock
6. Return 0 if all checks pass, 1 if any check fails
</action>
  <verify>
```bash
# Test depth limit
source .aether/utils/spawn-tracker.sh

# Set depth to 3 (max)
jq '.spawn_tracking.depth = 3' .aether/data/COLONY_STATE.json > /tmp/colony.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/colony.tmp

# Test can_spawn with max depth
if ! can_spawn; then
  echo "PASS: can_spawn blocks spawn at max depth"
else
  echo "FAIL: can_spawn allowed spawn at max depth"
fi

# Reset depth
jq '.spawn_tracking.depth = 0' .aether/data/COLONY_STATE.json > /tmp/colony.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/colony.tmp

# Test spawn increments depth
spawn_id=$(record_spawn "builder" "database_specialist" "Test task")
depth=$(jq -r '.spawn_tracking.depth' .aether/data/COLONY_STATE.json)
if [ "$depth" -eq 1 ]; then
  echo "PASS: Spawn incremented depth to 1"
fi

# Test outcome decrements depth
record_outcome "$spawn_id" "success" "Test complete"
depth=$(jq -r '.spawn_tracking.depth' .aether/data/COLONY_STATE.json)
if [ "$depth" -eq 0 ]; then
  echo "PASS: Outcome decremented depth to 0"
fi
```
</verify>
  <done>
- can_spawn() checks depth before allowing spawn
- record_spawn() increments depth when spawning
- record_outcome() decrements depth when specialist completes
- Depth never goes below 0
- Depth limit prevents infinite spawn chains
- Circuit breaker checked in can_spawn()
- All checks use atomic state operations
</done>
</task>

<task type="auto">
  <name>Task 3: Add same-specialist cache and safeguard checks to Worker Ants</name>
  <files>.aether/workers/builder-ant.md, .aether/workers/colonizer-ant.md, .aether/workers/route-setter-ant.md, .aether/workers/scout-ant.md, .aether/workers/watcher-ant.md, .aether/workers/architect-ant.md</files>
<action>
Update the "### Check Resource Constraints" section in each Worker Ant prompt to include same-specialist cache check.

Add after the can_spawn() check:

```markdown
### Check Same-Specialist Cache

Before spawning, verify we haven't already spawned this specialist type for this task:

```bash
# Check for existing spawns of same specialist for same task
existing_spawn=$(jq -r "
  .spawn_tracking.spawn_history |
  map(select(.specialist == \"$SPECIALIST_TYPE\" and .task == \"$TASK_CONTEXT\" and .outcome == \"pending\")) |
  length
" "$COLONY_STATE")

if [ "$existing_spawn" -gt 0 ]; then
  echo "Specialist $SPECIALIST_TYPE already spawned for this task"
  echo "Waiting for existing specialist to complete"
  # Don't spawn - wait for existing specialist
fi
```

### Circuit Breaker Checks

The `can_spawn()` function now checks:
1. **Spawn budget**: current_spawns < 10 per phase
2. **Spawn depth**: depth < 3 (prevents infinite chains)
3. **Circuit breaker**: trips < 3 and cooldown expired

If circuit breaker is triggered:
- 3 failed spawns of same specialist type
- 30-minute cooldown period
- Error message shows which specialist is blocked and when cooldown expires
```

Also add a "## Circuit Breakers" section update (if it exists) or add it with:

```markdown
## Circuit Breakers

Stop spawning if:
- **3 failed spawns** → Cooldown period triggered
- **Depth limit 3 reached** → Consolidate work at current level
- **Phase spawn limit (10)** → Complete current work first
- **Same-specialist cache hit** → Wait for existing specialist

### Circuit Breaker Reset

Circuit breaker auto-resets after 30-minute cooldown.
To manually reset, use:

```bash
source .aether/utils/circuit-breaker.sh
reset_circuit_breaker
```

This is useful if you've resolved the underlying issue and want to retry spawns.
```

Ensure this content is integrated with existing spawning sections.
</action>
  <verify>
```bash
# Verify all workers have same-specialist cache check
for worker in builder-ant colonizer-ant route-setter-ant scout-ant watcher-ant architect-ant; do
  if ! grep -q "Same-Specialist Cache" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing same-specialist cache check"
    exit 1
  fi
  if ! grep -q "Circuit Breaker Checks" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing circuit breaker checks section"
    exit 1
  fi
  if ! grep -q "reset_circuit_breaker" ".aether/workers/${worker}.md"; then
    echo "FAIL: ${worker} missing reset_circuit_breaker reference"
    exit 1
  fi
  echo "PASS: ${worker} has complete safeguard checks"
done
```
</verify>
  <done>
- All 6 Worker Ant prompts have same-specialist cache check
- All workers check for existing pending spawns of same specialist
- All workers document circuit breaker checks (budget, depth, trips)
- Circuit breaker reset instructions included
- Safeguard section integrated with existing spawning sections
- Clear guidance on when spawning is blocked and why
</done>
</task>

</tasks>

<verification>
## Overall Verification

1. **circuit-breaker.sh works**
   - check_circuit_breaker() prevents spawns after 3 failures
   - record_spawn_failure() increments trips and triggers cooldown
   - trigger_circuit_breaker_cooldown() sets 30-minute cooldown timestamp
   - reset_circuit_breaker() clears all circuit breaker state
   - Auto-reset when cooldown expires

2. **spawn-tracker.sh updated**
   - can_spawn() now checks depth limit
   - Depth increments on spawn, decrements on completion
   - Circuit breaker checked in can_spawn()
   - All safeguard checks prevent spawning

3. **Worker Ant prompts updated**
   - Same-specialist cache prevents duplicate spawns
   - Circuit breaker checks documented
   - Reset instructions included
   - Clear guidance on safeguard behavior

4. **Integration verified**
   - Depth limit prevents infinite spawn chains (parent → child → grandchild → stop)
   - Circuit breaker prevents retrying failed specialists
   - Same-specialist cache prevents redundant spawns
   - All safeguards use atomic state operations
</verification>

<success_criteria>
- Spawn depth limited to 3 levels (prevents infinite chains)
- Circuit breaker triggers after 3 failed spawns
- Circuit breaker cooldown lasts 30 minutes
- Same-specialist cache prevents duplicate spawns
- All safeguards use atomic writes
- Circuit breaker auto-resets after cooldown
- Manual reset available via reset_circuit_breaker()
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-emergence**---capability-gap-detection-with-worker-spawns-workers-and-safeguards/06-03-SUMMARY.md` with:
- Functions implemented in circuit-breaker.sh
- Updates to spawn-tracker.sh for depth enforcement
- Same-specialist cache added to Worker Ants
- Verification results
- Any issues encountered and resolutions
</output>
