---
phase: 20-distribution-simplification
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - CLAUDE.md
  - .opencode/OPENCODE.md
  - RUNTIME UPDATE ARCHITECTURE.md
  - .claude/rules/aether-specific.md
  - .claude/rules/aether-development.md
  - .claude/rules/git-workflow.md
  - .aether/CONTEXT.md
  - .aether/docs/queen-commands.md
  - .aether/docs/QUEEN-SYSTEM.md
  - .aether/docs/RECOVERY-PLAN.md
  - CHANGELOG.md
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02
  - PIPE-03

must_haves:
  truths:
    - "No documentation file references runtime/ as an active directory"
    - "Architecture diagrams show .aether/ -> hub direct flow (no runtime/ intermediary)"
    - "CHANGELOG.md has a v4.0.0 entry explaining the structural change"
    - "Developer instructions say 'edit .aether/, commit, npm install -g .' (no sync step)"
    - "RECOVERY-PLAN.md updated to reflect that the destructive update loop it describes is resolved"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Updated architecture documentation without runtime/ references"
    - path: ".opencode/OPENCODE.md"
      provides: "Updated OpenCode docs without runtime/ references"
    - path: "RUNTIME UPDATE ARCHITECTURE.md"
      provides: "Updated architecture doc reflecting direct packaging"
    - path: "CHANGELOG.md"
      provides: "v4.0.0 changelog entry documenting the structural change"
      contains: "v4.0.0"
    - path: ".claude/rules/aether-specific.md"
      provides: "Updated rules without runtime/ staging references"
    - path: ".claude/rules/aether-development.md"
      provides: "Updated dev context without runtime/ references, ISSUE-004 marked fixed"
    - path: ".claude/rules/git-workflow.md"
      provides: "Updated git workflow without sync-to-runtime references"
    - path: ".aether/docs/queen-commands.md"
      provides: "Updated queen command docs without runtime/ template reference"
    - path: ".aether/docs/QUEEN-SYSTEM.md"
      provides: "Updated example output without runtime/ path"
    - path: ".aether/docs/RECOVERY-PLAN.md"
      provides: "Updated recovery plan reflecting resolved runtime/ issue"
  key_links:
    - from: "CLAUDE.md architecture diagram"
      to: "bin/cli.js setupHub()"
      via: "Documentation matches code flow"
      pattern: "\\.aether.*hub"
---

<objective>
Update all documentation to reflect the simplified distribution pipeline. Every file that references runtime/ as an active directory, sync-to-runtime.sh as a script, or the 3-step edit-sync-package workflow must be updated. Add a CHANGELOG.md entry for v4.0.0.

Purpose: Per locked decision, documentation updates are part of this phase -- not deferred. Users and future Claude sessions must see the current architecture, not the old one. This includes 11 documentation files spanning architecture docs, rule files, .aether/ docs, and the changelog.

Output: All docs accurately describe the direct .aether/ -> hub pipeline. CHANGELOG explains the v4.0.0 change. RECOVERY-PLAN.md updated to reflect the resolved issue.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-01-SUMMARY.md

@CLAUDE.md
@.opencode/OPENCODE.md
@RUNTIME UPDATE ARCHITECTURE.md
@.claude/rules/aether-specific.md
@.claude/rules/aether-development.md
@.claude/rules/git-workflow.md
@.aether/CONTEXT.md
@.aether/docs/queen-commands.md
@.aether/docs/QUEEN-SYSTEM.md
@.aether/docs/RECOVERY-PLAN.md
@CHANGELOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update architecture documentation (CLAUDE.md, OPENCODE.md, RUNTIME UPDATE ARCHITECTURE.md)</name>
  <files>
    CLAUDE.md
    .opencode/OPENCODE.md
    RUNTIME UPDATE ARCHITECTURE.md
  </files>
  <action>
**CLAUDE.md changes:**

The "How Development Works" section has an ASCII diagram and flow description that references runtime/. Update all of these:

1. **ASCII box** (around lines 22-28): Remove the `runtime/` line and the sync script description. Replace with description showing .aether/ published directly with private dirs excluded by .npmignore. The box should convey:
   ```
   .aether/           -> SOURCE OF TRUTH (edit this, published directly)
   .aether/data/      -> LOCAL ONLY (excluded from package by .npmignore)
   .aether/dreams/    -> LOCAL ONLY (excluded from package by .npmignore)
   ```

2. **"Where to edit" table** (around lines 30-35): Remove any row about runtime/ being staging. Ensure `.aether/` row says it syncs directly to hub.

3. **"After editing system files" workflow** (around line 51): Change `npm install -g .   # Auto-syncs .aether/ -> runtime/, then pushes to hub` to `npm install -g .   # Validates .aether/, then pushes to hub`

4. **Critical Architecture section** (around lines 58-68): Rewrite to describe the direct pipeline. Remove all mentions of sync-to-runtime.sh. Remove `runtime/` from the flow diagram. The new flow is:
   ```
   .aether/ (source of truth) -> npm install -g . -> ~/.aether/ (hub) -> aether update -> target repos
   ```
   Remove the `runtime/ (STAGING)` line from the directory tree. Remove references to the sync script.

5. **Key Directories table** (around lines 95-105): Remove the `runtime/` row entirely. Update `.aether/` row to show direct sync: `-> ~/.aether/system/`.

**OPENCODE.md changes:**

Mirror the same changes as CLAUDE.md -- the OPENCODE.md has the same architecture sections with runtime/ references. Specifically:
1. ASCII box: remove runtime/ staging line
2. Development workflow: update npm install comment
3. Architecture section: rewrite to match CLAUDE.md
4. Key Directories table: remove runtime/ row

**RUNTIME UPDATE ARCHITECTURE.md:**

This file (179 lines) describes the distribution architecture in detail with extensive runtime/ references. It documents the "destructive update loop" problem that Phase 20 resolves. Major rewrite:

1. Update the title/header to reflect the v4.0 simplified architecture
2. Replace all references to "runtime/ staging" with the direct .aether/ packaging approach
3. Update all flow diagrams to show .aether/ -> hub (no runtime/ intermediary)
4. Update the description of what `npm install -g .` does (validates via validate-package.sh, not syncs via sync-to-runtime.sh)
5. Remove any references to sync-to-runtime.sh as an active script
6. Add a historical note: "Prior to v4.0, a runtime/ staging directory was used as an intermediary. This was removed in v4.0 to eliminate maintenance burden and the destructive update loop risk."
7. The document should now describe:
   - .aether/ is source of truth AND directly packaged (private dirs excluded by .npmignore)
   - npm install -g . runs validate-package.sh, then calls setupHub() which syncs to hub
   - Hub sync uses exclude-based approach (shouldExcludeFromHub with HUB_EXCLUDE_DIRS)
   - aether update uses syncAetherToRepo (exclude-based) for system files
   - All three distribution paths (system, commands, agents) are unified in setupHub()
  </action>
  <verify>
    Run `grep -c 'runtime/' CLAUDE.md` -- should return 0.
    Run `grep -c 'runtime/' .opencode/OPENCODE.md` -- should return 0.
    Run `grep -c 'sync-to-runtime' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md"` -- should return 0.
    `grep -c 'runtime/' "RUNTIME UPDATE ARCHITECTURE.md"` -- should return 0 or only in historical context (e.g., "Prior to v4.0, runtime/ was used...").
  </verify>
  <done>
    All three architecture documents accurately describe the v4.0 direct-packaging pipeline. No references to runtime/ as an active directory. No references to sync-to-runtime.sh as an active script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update rules, .aether/ docs, CONTEXT.md, and add CHANGELOG entry</name>
  <files>
    .claude/rules/aether-specific.md
    .claude/rules/aether-development.md
    .claude/rules/git-workflow.md
    .aether/CONTEXT.md
    .aether/docs/queen-commands.md
    .aether/docs/QUEEN-SYSTEM.md
    .aether/docs/RECOVERY-PLAN.md
    CHANGELOG.md
  </files>
  <action>
**.claude/rules/aether-specific.md changes:**

1. **Source of Truth box** (line 7): Remove `runtime/           -> STAGING (auto-populated, DO NOT EDIT)`. Replace with a note that .aether/ is published directly with private dirs excluded by .npmignore. Keep `.aether/           -> SOURCE OF TRUTH (edit this)`.
2. **Distribution Flow** (around line 29): Update the step from "Run `npm install -g .` to sync to `runtime/` and push to hub" to "Run `npm install -g .` to validate and push to hub".

**.claude/rules/aether-development.md changes:**

1. **Architecture Decisions table** (line 11): Update the `.aether/` row. Change the Why column from "runtime/ is auto-generated staging" to ".aether/ published directly, private dirs excluded by .npmignore".
2. **Row about sync script** (line 12): Change "Sync script, not manual copy" to "Validation script, not copy script". Update the file reference from `bin/sync-to-runtime.sh` to `bin/validate-package.sh`.
3. **"Edit .aether/, NOT runtime/"** warning (line 17): Simplify to just "Edit .aether/" -- there's no runtime/ to warn about anymore.
4. **ISSUE-004** (around line 30): This bug was about template path hardcoded to runtime/. Mark it as FIXED: `**Status:** FIXED -- Phase 20: runtime/ eliminated, template resolved via hub or .aether/ paths`.

**.claude/rules/git-workflow.md changes:**

1. **Pre-commit Hooks section** (lines 31-33): Remove "Block direct edits to `runtime/` (edit `.aether/` instead)" and "Run sync script before commit" and "Stage synced changes automatically". Replace with:
   - "Run package validation on `.aether/` changes (non-blocking)"
   - "Verify required files exist in `.aether/`"
2. **Sync Workflow section** (lines 41-42): Remove the sync-to-runtime.sh reference. Update to show the new workflow: edit .aether/, commit, npm install -g . (validates .aether/ and pushes to hub).

**.aether/CONTEXT.md changes:**

1. **Line 102:** The table row says `runtime/` is auto-populated on publish. Update to: `.aether/` IS the source of truth -- published directly to npm (private dirs excluded by .npmignore)`. Match the wording style of the surrounding table.

**.aether/docs/queen-commands.md changes:**

1. **Line 27:** Currently says "Searches for template in: hub system path, then local runtime/". Change to: "Searches for template in: hub system path, then local .aether/templates/"

**.aether/docs/QUEEN-SYSTEM.md changes:**

1. **Line 88:** The example JSON output shows `"source": "runtime/templates/QUEEN.md.template"`. Change to `"source": ".aether/templates/QUEEN.md.template"` (or the hub path `"~/.aether/system/templates/QUEEN.md.template"` -- use whichever is more likely in the dev repo context).

**.aether/docs/RECOVERY-PLAN.md changes:**

This file documents the "destructive update loop" problem caused by the runtime/ staging directory. Phase 20 resolves this problem entirely. The document needs substantial updating:

1. **Add a prominent status banner** at the top (after the header): `**Status: RESOLVED (v4.0)** -- The runtime/ staging directory was eliminated in v4.0. The destructive update loop described below is no longer possible. This document is retained for historical context.`
2. **The Problem section** (lines 9-30): Add a note that this describes the pre-v4.0 architecture and is now resolved. The flow diagram showing runtime/ -> hub -> .aether/ is historical.
3. **Anti-Patterns section** (lines 230-242): This section has contradictory advice ("DO NOT: Treat .aether/ as source of truth" vs "DO: Edit .aether/ as the source of truth"). Both points are now irrelevant -- .aether/ IS the source of truth and is published directly. Add a note: "As of v4.0, .aether/ is published directly. There is no runtime/ to sync, so the anti-patterns above no longer apply."
4. **Recovery Steps** (lines 119-211): All of these reference runtime/ extensively. Add a note at the top: "These recovery steps applied to the pre-v4.0 pipeline and are no longer needed. The runtime/ directory has been removed."
5. **Step 5** (lines 197-211) and **Next Steps** (line 271): The text "Consider future architecture -- Remove runtime/ and use .aether/ directly?" -- this has now been done. Update to note it's been completed in v4.0.

Be thorough but practical -- the document is retained for historical context, so don't delete content. Add status markers and resolution notes instead.

**CHANGELOG.md:**

Add a v4.0.0 entry at the top of the file (before existing entries). Format:

```markdown
## v4.0.0 -- Distribution Simplification

**Breaking change:** The `runtime/` staging directory has been removed. The npm package now reads directly from `.aether/`, with private directories (data/, dreams/, oracle/, etc.) excluded by `.npmignore`.

### Changed
- `.aether/` is now directly included in the npm package (private dirs excluded)
- `bin/validate-package.sh` replaces `bin/sync-to-runtime.sh` -- validates required files, no copying
- Hub sync uses exclude-based approach instead of triplicate 59-62 file allowlists
- Pre-commit hook repurposed for validation (no more runtime/ sync)
- `aether update` uses `syncAetherToRepo` (exclude-based) for all system file distribution
- All three distribution paths (system files, commands, agents) unified in `setupHub()`

### Removed
- `runtime/` staging directory -- eliminated entirely
- `bin/sync-to-runtime.sh` -- replaced by validation-only script
- `SYSTEM_FILES` allowlist arrays in cli.js and update-transaction.js
- `copySystemFiles()` and `syncSystemFilesWithCleanup()` functions

### Added
- `bin/validate-package.sh` -- pre-packaging validation with `--dry-run` mode
- Private data exposure guard -- blocks packaging if .npmignore doesn't cover private dirs
- Migration message for users upgrading from v3.x
- `npm pack --dry-run` recommended for verifying package contents

### Fixed
- ISSUE-004: Template path hardcoded to runtime/ -- resolved by eliminating runtime/ entirely

### Migration
- Run `npm install -g aether-colony` to get v4.0
- Your colony state and data are unaffected
- The only change is how the package is built -- distributed content is identical
```
  </action>
  <verify>
    Run `grep -c 'runtime/' .claude/rules/aether-specific.md` -- should return 0.
    Run `grep -c 'runtime/' .claude/rules/aether-development.md` -- should return 0 (or only as historical reference for ISSUE-004 fix note).
    Run `grep -c 'sync-to-runtime' .claude/rules/git-workflow.md` -- should return 0.
    Run `grep -c 'runtime/' .aether/CONTEXT.md` -- should return 0.
    Run `grep -c 'runtime/' .aether/docs/queen-commands.md` -- should return 0.
    Verify CHANGELOG.md has v4.0.0 section at the top.
    Verify RECOVERY-PLAN.md has RESOLVED status banner.
    Run `grep 'runtime/' .aether/docs/QUEEN-SYSTEM.md` -- should return 0.
  </verify>
  <done>
    All 8 documentation files updated to reflect v4.0 pipeline. .aether/CONTEXT.md updated. .aether/docs/ files (queen-commands, QUEEN-SYSTEM, RECOVERY-PLAN) all cleaned. CHANGELOG.md has comprehensive v4.0.0 entry. RECOVERY-PLAN.md marked as RESOLVED with historical context preserved. All rule files guide developers to the correct workflow.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'runtime/' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md" .claude/rules/ .aether/CONTEXT.md .aether/docs/queen-commands.md .aether/docs/QUEEN-SYSTEM.md` -- zero matches for runtime/ as an active directory path
2. `grep -rn 'sync-to-runtime' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md" .claude/rules/ .aether/CONTEXT.md` -- zero matches
3. CHANGELOG.md contains `## v4.0.0` section
4. Architecture diagrams in CLAUDE.md and OPENCODE.md show direct .aether/ -> hub flow
5. RECOVERY-PLAN.md has RESOLVED status
</verification>

<success_criteria>
- Zero active runtime/ references in any documentation file (historical notes in RECOVERY-PLAN.md are acceptable)
- Zero sync-to-runtime.sh references as an active script in any documentation file
- CHANGELOG.md documents the v4.0.0 structural change with migration guidance
- Architecture diagrams and flow descriptions match the actual v4.0 code
- Rules files guide developers to the correct workflow (edit .aether/, validate, push to hub)
- RECOVERY-PLAN.md preserved as historical document with RESOLVED status
- queen-commands.md and QUEEN-SYSTEM.md updated with correct template paths
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-03-SUMMARY.md`
</output>
