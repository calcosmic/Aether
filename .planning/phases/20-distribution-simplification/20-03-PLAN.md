---
phase: 20-distribution-simplification
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - CLAUDE.md
  - .opencode/OPENCODE.md
  - RUNTIME UPDATE ARCHITECTURE.md
  - .claude/rules/aether-specific.md
  - .claude/rules/aether-development.md
  - .claude/rules/git-workflow.md
  - .aether/CONTEXT.md
  - CHANGELOG.md
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02
  - PIPE-03

must_haves:
  truths:
    - "No documentation file references runtime/ as an active directory"
    - "Architecture diagrams show .aether/ -> hub direct flow (no runtime/ intermediary)"
    - "CHANGELOG.md has a v4.0.0 entry explaining the structural change"
    - "Developer instructions say 'edit .aether/, commit, npm install -g .' (no sync step)"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Updated architecture documentation without runtime/ references"
    - path: ".opencode/OPENCODE.md"
      provides: "Updated OpenCode docs without runtime/ references"
    - path: "RUNTIME UPDATE ARCHITECTURE.md"
      provides: "Updated architecture doc reflecting direct packaging"
    - path: "CHANGELOG.md"
      provides: "v4.0.0 changelog entry documenting the structural change"
    - path: ".claude/rules/aether-specific.md"
      provides: "Updated rules without runtime/ staging references"
    - path: ".claude/rules/aether-development.md"
      provides: "Updated dev context without runtime/ references"
    - path: ".claude/rules/git-workflow.md"
      provides: "Updated git workflow without sync-to-runtime references"
  key_links:
    - from: "CLAUDE.md architecture diagram"
      to: "bin/cli.js setupHub()"
      via: "Documentation matches code flow"
      pattern: "\\.aether.*hub"
---

<objective>
Update all documentation to reflect the simplified distribution pipeline. Every file that references runtime/ as an active directory, sync-to-runtime.sh as a script, or the 3-step edit-sync-package workflow must be updated. Add a CHANGELOG.md entry for v4.0.0.

Purpose: Per locked decision, documentation updates are part of this phase — not deferred. Users and future Claude sessions must see the current architecture, not the old one.

Output: All docs accurately describe the direct .aether/ -> hub pipeline. CHANGELOG explains the v4.0.0 change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-01-SUMMARY.md

@CLAUDE.md
@.opencode/OPENCODE.md
@RUNTIME UPDATE ARCHITECTURE.md
@.claude/rules/aether-specific.md
@.claude/rules/aether-development.md
@.claude/rules/git-workflow.md
@.aether/CONTEXT.md
@CHANGELOG.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update architecture documentation (CLAUDE.md, OPENCODE.md, RUNTIME UPDATE ARCHITECTURE.md)</name>
  <files>
    CLAUDE.md
    .opencode/OPENCODE.md
    RUNTIME UPDATE ARCHITECTURE.md
  </files>
  <action>
**CLAUDE.md changes:**

The "How Development Works" section has an ASCII diagram and flow description that references runtime/. Update all of these:

1. **ASCII box** (around line 22-28): Remove `runtime/           → STAGING (auto-populated on publish)` and `A sync script copies .aether/ → runtime/ before packaging.`. Replace with description showing .aether/ published directly with private dirs excluded by .npmignore.

2. **Table** (around line 30-35): Remove the row about runtime/ being staging. Update `.aether/` row to say it syncs directly to hub.

3. **Development workflow** (around line 51): Change `npm install -g .   # Auto-syncs .aether/ → runtime/, then pushes to hub` to `npm install -g .   # Validates .aether/, then pushes to hub`

4. **Critical Architecture** section (around line 58): Rewrite to describe the direct pipeline. Remove all mentions of sync-to-runtime.sh. Remove `runtime/` from the flow diagram. The new flow is:
   ```
   .aether/ (edit) → npm install -g . → ~/.aether/system/ (hub) → aether update → target repos
   ```

5. **Key Directories table** (around line 95-105): Remove the `runtime/` row entirely. Update `.aether/` row to show direct sync path: `→ ~/.aether/system/`.

**OPENCODE.md changes:**

Mirror the same changes as CLAUDE.md — the OPENCODE.md has the same architecture sections with runtime/ references. Specifically:
1. ASCII box: remove runtime/ staging line
2. Development workflow: update npm install comment
3. Architecture section: rewrite to match CLAUDE.md
4. Key Directories table: remove runtime/ row

**RUNTIME UPDATE ARCHITECTURE.md:**

This file has ~14 runtime/ references and describes the distribution architecture in detail. This is a significant rewrite:
1. Replace all references to "runtime/ staging" with the direct .aether/ packaging approach
2. Update all flow diagrams to show .aether/ -> hub (no runtime/ intermediary)
3. Update the description of what `npm install -g .` does (validates, not syncs)
4. Remove any references to sync-to-runtime.sh
5. Keep the file's overall structure — it's still useful as an architecture reference — just update the content to reflect the v4.0 pipeline

Be thorough — this is the detailed architecture document. It should accurately describe:
- .aether/ is source of truth AND directly packaged (private dirs excluded by .npmignore)
- npm install -g . runs validate-package.sh, then pushes to hub
- Hub sync uses exclude-based approach (not allowlist)
- aether update uses syncAetherToRepo (exclude-based) for system files
  </action>
  <verify>
    Run `grep -c 'runtime/' CLAUDE.md` — should return 0.
    Run `grep -c 'runtime/' .opencode/OPENCODE.md` — should return 0.
    Run `grep -c 'runtime/' "RUNTIME UPDATE ARCHITECTURE.md"` — should return 0 (or only in historical context like "previously used runtime/").
    Run `grep -c 'sync-to-runtime' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md"` — should return 0.
  </verify>
  <done>
    All three architecture documents accurately describe the v4.0 direct-packaging pipeline. No references to runtime/ as an active directory. No references to sync-to-runtime.sh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update rules files, CONTEXT.md, and add CHANGELOG entry</name>
  <files>
    .claude/rules/aether-specific.md
    .claude/rules/aether-development.md
    .claude/rules/git-workflow.md
    .aether/CONTEXT.md
    CHANGELOG.md
  </files>
  <action>
**.claude/rules/aether-specific.md changes:**

1. **Source of Truth box** (line 7): Remove `runtime/           → STAGING (auto-populated, DO NOT EDIT)`. Replace with a note that .aether/ is published directly (private dirs excluded).
2. **Distribution Flow** (around line 29): Change `npm install -g .` comment from syncing to runtime/ to validating and pushing to hub.

**.claude/rules/aether-development.md changes:**

1. **Architecture Decisions table** (line 11): Update the row about `.aether/` being source of truth — remove "runtime/ is auto-generated staging" from the Why column. Replace with ".aether/ published directly, private dirs excluded by .npmignore".
2. **Row about sync script** (line 12): Remove or update the "Sync script, not manual copy" row. Replace with "Validation script, not copy script" or similar. Update file reference from `bin/sync-to-runtime.sh` to `bin/validate-package.sh`.
3. **"Edit .aether/, NOT runtime/"** warning (line 17): Simplify to just "Edit .aether/" — there's no runtime/ to warn about.
4. **ISSUE-004** (line 30): This bug was about template path hardcoded to runtime/. This is now fixed by Phase 20 — mark it as FIXED or remove the entry if it's in the "Critical" section.

**.claude/rules/git-workflow.md changes:**

1. **Pre-commit Hooks** section (lines 31-33): Remove "Block direct edits to `runtime/`" and "Run sync script before commit". Replace with "Run package validation on .aether/ changes".
2. **Sync Workflow** (lines 41-42): Remove the sync-to-runtime.sh reference. Update to show the new workflow: edit .aether/, commit, npm install -g . (validates and pushes to hub).

**.aether/CONTEXT.md changes:**

1. **Line 102:** The row says `runtime/` is auto-populated on publish. Update to reflect that .aether/ is now published directly.

**CHANGELOG.md:**

Add a v4.0.0 entry at the top of the file (before existing entries). Format:

```markdown
## v4.0.0 — Distribution Simplification

**Breaking change:** The `runtime/` staging directory has been removed. The npm package now reads directly from `.aether/`, with private directories (data/, dreams/, oracle/, etc.) excluded by `.npmignore`.

### Changed
- `.aether/` is now directly included in the npm package (private dirs excluded)
- `bin/validate-package.sh` replaces `bin/sync-to-runtime.sh` — validates required files, no copying
- Hub sync uses exclude-based approach instead of 83-file allowlist
- Pre-commit hook repurposed for validation (no more runtime/ sync)
- `aether update` uses `syncAetherToRepo` (exclude-based) for all system file distribution

### Removed
- `runtime/` staging directory — eliminated entirely
- `bin/sync-to-runtime.sh` — replaced by validation-only script
- `SYSTEM_FILES` allowlist arrays in cli.js and update-transaction.js
- `copySystemFiles()` and `syncSystemFilesWithCleanup()` functions

### Added
- `bin/validate-package.sh` — pre-packaging validation with `--dry-run` mode
- Private data exposure guard — blocks packaging if .npmignore doesn't cover private dirs
- Migration message for users upgrading from v3.x
- `npm pack --dry-run` recommended for verifying package contents

### Migration
- Run `npm install -g aether-colony` to get v4.0
- Your colony state and data are unaffected
- The only change is how the package is built — distributed content is identical
```
  </action>
  <verify>
    Run `grep -c 'runtime/' .claude/rules/aether-specific.md` — should return 0.
    Run `grep -c 'runtime/' .claude/rules/aether-development.md` — should return 0 (or only as historical reference for ISSUE-004 fix).
    Run `grep -c 'sync-to-runtime' .claude/rules/git-workflow.md` — should return 0.
    Verify CHANGELOG.md has v4.0.0 section at the top.
    Run `grep -c 'runtime/' .aether/CONTEXT.md` — should return 0.
  </verify>
  <done>
    All rule files updated to reflect v4.0 pipeline. .aether/CONTEXT.md updated. CHANGELOG.md has comprehensive v4.0.0 entry with breaking change notice, what changed, what was removed, what was added, and migration instructions.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'runtime/' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md" .claude/rules/ .aether/CONTEXT.md` — zero matches for runtime/ as an active directory
2. `grep -rn 'sync-to-runtime' CLAUDE.md .opencode/OPENCODE.md "RUNTIME UPDATE ARCHITECTURE.md" .claude/rules/ .aether/CONTEXT.md` — zero matches
3. CHANGELOG.md contains `## v4.0.0` section
4. Architecture diagrams in CLAUDE.md and OPENCODE.md show direct .aether/ -> hub flow
</verification>

<success_criteria>
- Zero active runtime/ references in any documentation file
- Zero sync-to-runtime.sh references in any documentation file
- CHANGELOG.md documents the v4.0.0 structural change with migration guidance
- Architecture diagrams and flow descriptions match the actual v4.0 code
- Rules files guide developers to the correct workflow (edit .aether/, validate, push to hub)
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-03-SUMMARY.md`
</output>
