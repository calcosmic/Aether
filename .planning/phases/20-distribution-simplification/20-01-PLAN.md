---
phase: 20-distribution-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .npmignore
  - .gitignore
  - bin/validate-package.sh
  - bin/sync-to-runtime.sh
  - bin/cli.js
  - bin/lib/update-transaction.js
  - .aether/data/checkpoint-allowlist.json
  - runtime/
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02

must_haves:
  truths:
    - "npm pack --dry-run shows .aether/ files but NOT .aether/data/, .aether/dreams/, .aether/oracle/, .aether/checkpoints/, .aether/locks/, .aether/temp/"
    - "npm install -g . syncs .aether/ directly to ~/.aether/system/ without runtime/ intermediary"
    - "aether update on target repos uses exclude-based sync (not allowlist) for system files"
    - "bin/validate-package.sh verifies required files exist and blocks on private data exposure"
    - "runtime/ directory and sync-to-runtime.sh no longer exist in the repo"
    - "Migration message shown when upgrading from pre-4.0 version"
  artifacts:
    - path: "bin/validate-package.sh"
      provides: "Pre-packaging validation (required files check + private data guard + dry-run mode)"
      min_lines: 30
    - path: "package.json"
      provides: "Direct .aether/ packaging config with validation scripts, version 4.0.0"
      contains: ".aether/"
    - path: ".npmignore"
      provides: "Private directory exclusions for .aether/ subdirs"
      contains: ".aether/data/"
    - path: "bin/cli.js"
      provides: "setupHub reads from .aether/ not runtime/, SYSTEM_FILES removed"
      contains: "path.join(PACKAGE_DIR, '.aether')"
    - path: "bin/lib/update-transaction.js"
      provides: "Exclude-based sync replaces allowlist-based sync, SYSTEM_FILES removed"
  key_links:
    - from: "package.json"
      to: ".npmignore"
      via: "files field includes .aether/, .npmignore excludes private subdirs"
      pattern: '\.aether/'
    - from: "bin/cli.js setupHub()"
      to: ".aether/"
      via: "PACKAGE_DIR + .aether path resolution"
      pattern: "path\\.join\\(PACKAGE_DIR.*\\.aether"
    - from: "bin/validate-package.sh"
      to: "package.json prepublishOnly"
      via: "npm lifecycle script invocation"
      pattern: "validate-package"
---

<objective>
Restructure the npm distribution pipeline so the package reads directly from `.aether/` instead of the `runtime/` staging directory. Delete `runtime/` and `sync-to-runtime.sh` entirely. Replace the allowlist-based sync with an exclude-based approach. Add pre-packaging validation and migration messaging.

Purpose: Eliminate the runtime/ indirection that requires maintaining triplicate allowlists (cli.js, update-transaction.js, sync-to-runtime.sh â€” already out of sync) and a copy script. Simplify from a 3-step flow (edit -> sync -> package) to a 2-step flow (edit -> package with validation).

Output: Working direct-packaging pipeline with validation, private data guards, migration support, and all allowlist-based code removed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-CONTEXT.md

@package.json
@.npmignore
@.gitignore
@bin/cli.js
@bin/lib/update-transaction.js
@bin/sync-to-runtime.sh
@.aether/data/checkpoint-allowlist.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure npm packaging and create validation script</name>
  <files>
    package.json
    .npmignore
    .gitignore
    bin/validate-package.sh
    .aether/data/checkpoint-allowlist.json
  </files>
  <action>
**package.json changes:**

1. In the `files` array (line 14), replace `"runtime/"` with `".aether/"`. Keep all other entries unchanged.

2. Update lifecycle scripts (lines 21-24):
   - `"preinstall"`: change from `"bash bin/sync-to-runtime.sh 2>/dev/null || true"` to `"bash bin/validate-package.sh 2>/dev/null || true"`
   - `"prepublishOnly"`: change from `"bash bin/sync-to-runtime.sh"` to `"bash bin/validate-package.sh"`
   - Remove `"postpublish": "rm -rf runtime/"` entirely (no runtime/ to clean up)

3. Bump version from `"3.1.19"` to `"4.0.0"` (major version bump per user decision -- structural breaking change).

**.npmignore changes:**

The current `.npmignore` has `.aether/` on line 3 which excludes the ENTIRE `.aether/` directory. This must be changed:

1. Remove the blanket `.aether/` exclusion (line 3).
2. Add specific private directory/file exclusions in a new "Aether private directories" section:
   ```
   # Aether private directories (never publish)
   .aether/data/
   .aether/dreams/
   .aether/oracle/
   .aether/checkpoints/
   .aether/locks/
   .aether/temp/
   .aether/archive/
   .aether/chambers/
   .aether/examples/
   .aether/__pycache__/

   # Aether private files (never publish)
   .aether/ledger.jsonl
   .aether/manifest.json
   .aether/registry.json
   .aether/version.json
   .aether/HANDOFF.md
   .aether/HANDOFF_AETHER_DEV_2026-02-15.md
   .aether/PHASE-0-ANALYSIS.md
   .aether/DIAGNOSIS_PROMPT.md
   .aether/RESEARCH-SHARED-DATA.md
   .aether/diagnose-self-reference.md
   .aether/pheromone_system.py
   .aether/semantic_layer.py
   ```
3. Keep all existing exclusion entries (`.planning/`, `.ralph/`, `.cache/`, etc.) unchanged.

**.gitignore changes:**

Remove the `runtime/` entry and associated comments from `.gitignore` (around lines 106-108). It was there because runtime/ was auto-generated; now there is nothing to ignore.

**bin/validate-package.sh (CREATE):**

Create a new validation script that replaces sync-to-runtime.sh. The script:

1. Shebang: `#!/bin/bash`, `set -euo pipefail`
2. Header comment explaining it replaces sync-to-runtime.sh as pre-packaging validation
3. Resolve AETHER_DIR to the `.aether/` directory relative to the script location: `AETHER_DIR="$(cd "$(dirname "$0")/../.aether" && pwd)"`
4. Resolve REPO_ROOT: `REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"`
5. Define REQUIRED_FILES array with critical files that must exist: `aether-utils.sh`, `workers.md`, `CONTEXT.md`, `model-profiles.yaml`, `docs/README.md`, `utils/atomic-write.sh`, `utils/error-handler.sh`, `utils/file-lock.sh`, `templates/QUEEN.md.template`, `rules/aether-colony.md`
6. Loop REQUIRED_FILES and exit 1 with error message if any missing
7. Define PRIVATE_DIRS array: `data`, `dreams`, `oracle`, `checkpoints`, `locks`, `temp`, `archive`, `chambers`
8. For each private dir: if it exists under .aether/ AND `.aether/$dir/` is NOT found in the `.npmignore` file at repo root, emit ERROR and exit 1 (hard block per Claude's discretion -- known private dirs are a safety-critical concern)
9. Support `--dry-run` flag: when passed, run `npm pack --dry-run 2>&1` and exit. This implements the user's requested dry-run mode using npm's built-in capability (per research: don't hand-roll a file listing script).
10. Print "Package validation passed." on success
11. Make executable: `chmod +x bin/validate-package.sh`

**.aether/data/checkpoint-allowlist.json changes:**

Remove `"runtime/**/*"` from the `system_files` array (line 12). The runtime/ directory no longer exists, so it should not be in the checkpoint allowlist.
  </action>
  <verify>
    Run `bash bin/validate-package.sh` and confirm it prints "Package validation passed."
    Run `bash bin/validate-package.sh --dry-run` and confirm it shows npm pack output with .aether/ files but no private directories.
    Verify `npm pack --dry-run 2>&1 | grep -c 'runtime/'` returns 0 (no runtime/ files).
    Verify `npm pack --dry-run 2>&1 | grep -c '.aether/'` returns a positive number.
    Verify `npm pack --dry-run 2>&1 | grep -c '.aether/data/'` returns 0 (private dirs excluded).
    Verify checkpoint-allowlist.json no longer contains "runtime".
  </verify>
  <done>
    package.json has .aether/ in files (not runtime/), version is 4.0.0, validation scripts reference validate-package.sh, postpublish removed. .npmignore excludes specific .aether/ private subdirectories but not .aether/ itself. validate-package.sh passes, --dry-run shows correct file set. checkpoint-allowlist.json cleaned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update distribution code in cli.js and update-transaction.js, delete runtime/ and sync script</name>
  <files>
    bin/cli.js
    bin/lib/update-transaction.js
    bin/sync-to-runtime.sh
    runtime/
  </files>
  <action>
**bin/cli.js changes:**

1. **Delete SYSTEM_FILES array** (lines 379-439, ~60 lines). Delete the entire array and its preceding comment. This becomes obsolete -- the exclude-based approach replaces it.

2. **Delete copySystemFiles function** (lines 441-456). No longer needed -- was used for allowlist-based copy.

3. **Delete syncSystemFilesWithCleanup function** (lines 628-677). No longer needed -- replaced by syncAetherToRepo.

4. **Add `rules` to HUB_EXCLUDE_DIRS** (line 878). Currently `['data', 'dreams', 'checkpoints', 'locks', 'temp']`. Add `'rules'` because rules are synced by a separate dedicated step at line 1114. This keeps behavior identical to the current pipeline where rules were never in the runtime/ staging directory's general sync. After adding: `['data', 'dreams', 'checkpoints', 'locks', 'temp', 'rules']`.

5. **Update setupHub() -- main system sync** (lines 1048-1058):
   - Change `const runtimeSrc = path.join(PACKAGE_DIR, 'runtime');` to `const aetherSrc = path.join(PACKAGE_DIR, '.aether');`
   - Update the condition and call: `if (fs.existsSync(aetherSrc)) { const result = syncAetherToHub(aetherSrc, HUB_SYSTEM_DIR); ... }`
   - Update the comment from "Sync runtime/" to "Sync .aether/ -> ~/.aether/system/ (direct packaging, no staging)"

6. **Add migration message in setupHub()** after the hub system sync result logging block. Use the existing `prevManifest` variable that's already loaded in setupHub():
   ```javascript
   // Migration message for users upgrading from pre-4.0 (runtime/ era)
   if (prevManifest && prevManifest.version && prevManifest.version.startsWith('3.')) {
     log('');
     log('  Distribution pipeline simplified (v4.0 change):');
     log('  - runtime/ staging directory has been removed');
     log('  - .aether/ is now published directly (private dirs excluded)');
     log('  - Your colony state and data are unaffected');
     log('  - See CHANGELOG.md for details');
     log('');
   }
   ```
   Place this after the hub system sync result logging, before the command sync section.

7. **Update setupHub() -- rules sync** (lines 1111-1119):
   - Change `const rulesSrc = path.join(PACKAGE_DIR, 'runtime', 'rules');` to `const rulesSrc = path.join(PACKAGE_DIR, '.aether', 'rules');`
   - Update comment similarly

8. **Update the comment near CHECKPOINT_ALLOWLIST** (around line 681-682): Change the comment "runtime/ is generated during publish only, not checkpointed" to "runtime/ was removed in v4.0 -- .aether/ published directly".

9. **Search for any remaining `runtime/` string references** in cli.js and update or remove them. Expected: after all above changes, zero path references to runtime/ should remain.

**bin/lib/update-transaction.js changes:**

1. **Delete SYSTEM_FILES array** (lines 179-240, 62 entries). Delete the entire array and the comment above it ("must match bin/sync-to-runtime.sh SYSTEM_FILES exactly").

2. **Delete the syncSystemFilesWithCleanup method** (lines 718-768). It uses SYSTEM_FILES and is no longer needed.

3. **Verify the execute() method** (around line 951-966). It should already be using `syncAetherToRepo()` for system file sync. If it also calls `syncSystemFilesWithCleanup`, replace that call with `syncAetherToRepo`. The exclude-based method at line 789 already correctly handles directory walking + exclusion via EXCLUDE_DIRS.

4. **Add `archive` and `chambers` to EXCLUDE_DIRS** (line 173). Currently: `['data', 'dreams', 'checkpoints', 'locks', 'temp', 'agents', 'commands', 'rules']`. Add `'archive'` and `'chambers'` -- these are private directories that should never sync to target repos.

5. **Remove any remaining references to sync-to-runtime.sh** in comments.

**Delete sync-to-runtime.sh:**

Run `git rm bin/sync-to-runtime.sh` to remove the sync script. Per locked decision: no archive copy, clean removal.

**Delete runtime/ directory:**

Run `git rm -r runtime/` to remove the entire runtime/ staging directory. If runtime/ is gitignored and not tracked, use `rm -rf runtime/` instead. Per locked decision: clean removal, no redirect, no README stub.

Verify:
1. `ls runtime/` returns "No such file or directory"
2. `ls bin/sync-to-runtime.sh` returns "No such file or directory"
  </action>
  <verify>
    Grep for "runtime/" in bin/cli.js -- should return zero path-reference matches (only historical comments about removal are acceptable).
    Grep for "SYSTEM_FILES" in bin/cli.js -- should return zero matches.
    Grep for "SYSTEM_FILES" in bin/lib/update-transaction.js -- should return zero matches.
    Grep for "syncSystemFilesWithCleanup" in both files -- should return zero matches.
    `test ! -d runtime/` exits 0 (directory gone).
    `test ! -f bin/sync-to-runtime.sh` exits 0 (file gone).
    Run `npm test` -- all tests should pass (some bash tests may need updates in Plan 02).
    Run `bash bin/validate-package.sh` -- should still pass.
  </verify>
  <done>
    cli.js setupHub reads from .aether/ not runtime/. HUB_EXCLUDE_DIRS includes 'rules'. SYSTEM_FILES arrays deleted from both files. syncSystemFilesWithCleanup removed from both files. Migration message added for pre-4.0 upgrades. EXCLUDE_DIRS includes archive and chambers. runtime/ directory and sync-to-runtime.sh fully deleted from repo.
  </done>
</task>

</tasks>

<verification>
1. `bash bin/validate-package.sh` -- passes with "Package validation passed."
2. `bash bin/validate-package.sh --dry-run` -- shows .aether/ files, no runtime/ files, no private directories
3. `npm test` -- tests pass (some bash tests may need updates in Plan 02)
4. `grep -r "runtime/" bin/cli.js bin/lib/update-transaction.js` -- no active runtime/ path references
5. `grep -r "SYSTEM_FILES" bin/cli.js bin/lib/update-transaction.js` -- no SYSTEM_FILES arrays
6. `test ! -d runtime/ && test ! -f bin/sync-to-runtime.sh` -- both deleted
7. `grep "runtime" .aether/data/checkpoint-allowlist.json` -- no matches
</verification>

<success_criteria>
- runtime/ directory does not exist
- sync-to-runtime.sh does not exist
- npm package includes .aether/ files directly (excluding private directories)
- Hub sync reads from .aether/ not runtime/
- aether update uses exclude-based sync (not allowlist) for system files
- Migration message appears for pre-4.0 upgrades
- validate-package.sh provides dry-run mode and private data guard
- checkpoint-allowlist.json cleaned of runtime/ reference
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-01-SUMMARY.md`
</output>
