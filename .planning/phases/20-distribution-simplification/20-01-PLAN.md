---
phase: 20-distribution-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .npmignore
  - .gitignore
  - bin/validate-package.sh
  - bin/sync-to-runtime.sh
  - bin/cli.js
  - bin/lib/update-transaction.js
  - runtime/
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02

must_haves:
  truths:
    - "npm pack --dry-run shows .aether/ files but NOT .aether/data/, .aether/dreams/, .aether/oracle/, .aether/checkpoints/, .aether/locks/, .aether/temp/"
    - "npm install -g . syncs .aether/ directly to ~/.aether/system/ without runtime/ intermediary"
    - "aether update on target repos cleans up files removed from distribution"
    - "bin/validate-package.sh verifies required files exist and blocks on private data exposure"
    - "runtime/ directory and sync-to-runtime.sh no longer exist in the repo"
    - "Migration message shown when upgrading from pre-4.0 version"
  artifacts:
    - path: "bin/validate-package.sh"
      provides: "Pre-packaging validation (required files check + private data guard)"
      min_lines: 30
    - path: "package.json"
      provides: "Direct .aether/ packaging config with validation scripts"
      contains: ".aether/"
    - path: ".npmignore"
      provides: "Private directory exclusions for .aether/ subdirs"
      contains: ".aether/data/"
    - path: "bin/cli.js"
      provides: "setupHub reads from .aether/ not runtime/"
      contains: "path.join(PACKAGE_DIR, '.aether')"
    - path: "bin/lib/update-transaction.js"
      provides: "Exclude-based sync replaces allowlist-based sync"
  key_links:
    - from: "package.json"
      to: ".npmignore"
      via: "files field includes .aether/, .npmignore excludes private subdirs"
      pattern: '\.aether/'
    - from: "bin/cli.js setupHub()"
      to: ".aether/"
      via: "PACKAGE_DIR + .aether path resolution"
      pattern: "path\\.join\\(PACKAGE_DIR.*\\.aether"
    - from: "bin/validate-package.sh"
      to: "package.json prepublishOnly"
      via: "npm lifecycle script invocation"
      pattern: "validate-package"
---

<objective>
Restructure the npm distribution pipeline so the package reads directly from `.aether/` instead of the `runtime/` staging directory. Delete `runtime/` and `sync-to-runtime.sh` entirely. Replace the allowlist-based sync with an exclude-based approach. Add pre-packaging validation and migration messaging.

Purpose: Eliminate the runtime/ indirection that requires maintaining duplicate allowlists and a copy script. Simplify from a 3-step flow (edit -> sync -> package) to a 2-step flow (edit -> package with validation).

Output: Working direct-packaging pipeline with validation, private data guards, and migration support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-CONTEXT.md

@package.json
@.npmignore
@.gitignore
@bin/cli.js
@bin/lib/update-transaction.js
@bin/sync-to-runtime.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure npm packaging and create validation script</name>
  <files>
    package.json
    .npmignore
    .gitignore
    bin/validate-package.sh
  </files>
  <action>
**package.json changes:**

1. Replace `"runtime/"` with `".aether/"` in the `files` array. Keep all other entries unchanged.

2. Update lifecycle scripts:
   - `"preinstall"`: change from `"bash bin/sync-to-runtime.sh 2>/dev/null || true"` to `"bash bin/validate-package.sh 2>/dev/null || true"`
   - `"prepublishOnly"`: change from `"bash bin/sync-to-runtime.sh"` to `"bash bin/validate-package.sh"`
   - Remove `"postpublish": "rm -rf runtime/"` entirely (no runtime/ to clean up)

3. Bump version from `"3.1.19"` to `"4.0.0"` (major version bump per user decision — structural breaking change).

**.npmignore changes:**

The current `.npmignore` has `.aether/` on line 3 which excludes the ENTIRE `.aether/` directory. This must be changed:

1. Remove the blanket `.aether/` exclusion (line 3).
2. Add specific private directory exclusions in a new "Aether private directories" section:
   ```
   # Aether private directories (never publish)
   .aether/data/
   .aether/dreams/
   .aether/oracle/
   .aether/checkpoints/
   .aether/locks/
   .aether/temp/
   .aether/archive/
   .aether/chambers/
   .aether/ledger.jsonl
   .aether/HANDOFF.md
   .aether/HANDOFF_AETHER_DEV_2026-02-15.md
   .aether/PHASE-0-ANALYSIS.md
   .aether/DIAGNOSIS_PROMPT.md
   .aether/pheromone_system.py
   .aether/semantic_layer.py
   .aether/__pycache__/
   ```
3. Keep all existing exclusion entries (`.planning/`, `.ralph/`, `.cache/`, etc.) unchanged.

**.gitignore changes:**

Remove the `runtime/` entry from `.gitignore` (it was there because runtime/ was auto-generated and shouldn't be committed; now there's nothing to ignore).

**bin/validate-package.sh (CREATE):**

Create a new validation script that replaces sync-to-runtime.sh. The script:

1. Shebang: `#!/bin/bash`, `set -euo pipefail`
2. Resolve AETHER_DIR to the `.aether/` directory relative to the script location
3. Define REQUIRED_FILES array with critical files that must exist: `aether-utils.sh`, `workers.md`, `CONTEXT.md`, `model-profiles.yaml`, `docs/README.md`, `utils/atomic-write.sh`, `utils/error-handler.sh`, `utils/file-lock.sh`, `templates/QUEEN.md.template`, `rules/aether-colony.md`
4. Loop REQUIRED_FILES and exit 1 with error message if any missing
5. Define PRIVATE_DIRS array: `data`, `dreams`, `oracle`, `checkpoints`, `locks`, `temp`, `archive`, `chambers`
6. Check each private dir — if it exists AND is not covered by `.npmignore`, emit ERROR and exit 1 (hard block). To check `.npmignore` coverage, grep for `.aether/$dir/` in the `.npmignore` file at repo root.
7. Support `--dry-run` flag: when passed, run `npm pack --dry-run 2>&1` and exit. This implements the user's requested dry-run mode.
8. Print "Package validation passed." on success
9. Make executable: `chmod +x`
  </action>
  <verify>
    Run `bash bin/validate-package.sh` and confirm it prints "Package validation passed."
    Run `bash bin/validate-package.sh --dry-run` and confirm it shows npm pack output with .aether/ files but no private directories.
    Verify `npm pack --dry-run 2>&1 | grep -c 'runtime/'` returns 0 (no runtime/ files).
    Verify `npm pack --dry-run 2>&1 | grep -c '.aether/'` returns a positive number.
    Verify `npm pack --dry-run 2>&1 | grep -c '.aether/data/'` returns 0 (private dirs excluded).
  </verify>
  <done>
    package.json has .aether/ in files (not runtime/), validation scripts reference validate-package.sh, version is 4.0.0, .npmignore excludes private .aether/ subdirectories but not .aether/ itself, validate-package.sh passes with --dry-run showing correct file set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update distribution code in cli.js and update-transaction.js</name>
  <files>
    bin/cli.js
    bin/lib/update-transaction.js
  </files>
  <action>
**bin/cli.js changes:**

1. **Delete SYSTEM_FILES array** (lines 379-439). Delete the entire array and its preceding comment. This becomes obsolete — the exclude-based approach replaces it.

2. **Delete copySystemFiles function** (lines 441-456). No longer needed.

3. **Update setupHub() — main system sync** (lines 1048-1058):
   - Change `const runtimeSrc = path.join(PACKAGE_DIR, 'runtime');` to `const aetherSrc = path.join(PACKAGE_DIR, '.aether');`
   - Update the condition and call: `if (fs.existsSync(aetherSrc)) { const result = syncAetherToHub(aetherSrc, HUB_SYSTEM_DIR); ... }`
   - Update the comment from "Sync runtime/ -> ~/.aether/system/" to "Sync .aether/ -> ~/.aether/system/ (direct packaging, no staging)"

4. **Update setupHub() — rules sync** (lines 1111-1119):
   - Change `const rulesSrc = path.join(PACKAGE_DIR, 'runtime', 'rules');` to `const rulesSrc = path.join(PACKAGE_DIR, '.aether', 'rules');`
   - Update comment similarly

5. **Add migration message in setupHub()** after the hub system sync block (after the existing result logging). Add a version check:
   ```javascript
   // Migration message for users upgrading from pre-4.0 (runtime/ era)
   const versionFile = path.join(HUB_DIR, 'manifest.json');
   const prevVersion = prevManifest && prevManifest.version ? prevManifest.version : null;
   if (prevVersion && prevVersion.startsWith('3.')) {
     log('');
     log('  Distribution pipeline simplified (v4.0 change):');
     log('  - runtime/ staging directory has been removed');
     log('  - .aether/ is now published directly (private dirs excluded)');
     log('  - Your colony state and data are unaffected');
     log('  - See CHANGELOG.md for details');
     log('');
   }
   ```
   Place this after the hub system sync result logging, before the legacy directory cleanup block.

6. **Update the comment on CHECKPOINT_ALLOWLIST** (around line 681-682): Change the comment that says "runtime/ is generated during publish only, not checkpointed" to "runtime/ was removed in v4.0 — .aether/ published directly".

7. **Check for any remaining runtime/ string references** in cli.js and update them. The research found these specific locations — verify and clean up any that remain after the above changes.

**bin/lib/update-transaction.js changes:**

1. **Delete SYSTEM_FILES array** (lines 178-240). Delete the entire array and its "must match bin/sync-to-runtime.sh" comment.

2. **Replace syncSystemFilesWithCleanup usage.** Find where `syncSystemFilesWithCleanup` is called in the `execute()` method (around line 966). The current flow calls `syncSystemFilesWithCleanup` for system files and then separate syncs for commands/agents. Replace the `syncSystemFilesWithCleanup` call with `syncAetherToRepo` — the exclude-based method that already exists and correctly handles directory walking + exclusion via EXCLUDE_DIRS.

   The current execute() call chain is:
   - `this.syncSystemFilesWithCleanup(this.HUB_SYSTEM_DIR, repoAether, ...)` for system files

   Change to:
   - `this.syncAetherToRepo(this.HUB_SYSTEM_DIR, repoAether, ...)` for system files

   This leverages the existing EXCLUDE_DIRS list which already covers: `['data', 'dreams', 'checkpoints', 'locks', 'temp', 'agents', 'commands', 'rules']`.

3. **Delete the syncSystemFilesWithCleanup method** (lines 718-768). It is no longer called.

4. **Verify EXCLUDE_DIRS** (line 173) covers the right directories. Current: `['data', 'dreams', 'checkpoints', 'locks', 'temp', 'agents', 'commands', 'rules']`. This is correct — agents/commands/rules are synced separately via their own paths; data/dreams/checkpoints/locks/temp are private.

5. **Add `archive` and `chambers` to EXCLUDE_DIRS** if not already present. These are private directories in .aether/ that should never sync to target repos.
  </action>
  <verify>
    Grep for "runtime" in bin/cli.js — should return zero matches (or only in comments explaining the removal).
    Grep for "SYSTEM_FILES" in bin/cli.js — should return zero matches.
    Grep for "SYSTEM_FILES" in bin/lib/update-transaction.js — should return zero matches.
    Grep for "syncSystemFilesWithCleanup" in bin/lib/update-transaction.js — should return zero matches.
    Run `npm test` — all 446 tests should pass.
  </verify>
  <done>
    cli.js setupHub reads from .aether/ not runtime/, SYSTEM_FILES arrays deleted from both files, syncSystemFilesWithCleanup replaced by syncAetherToRepo, migration message added for pre-4.0 upgrades, all tests passing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Delete runtime/ directory and sync-to-runtime.sh</name>
  <files>
    bin/sync-to-runtime.sh
    runtime/
  </files>
  <action>
**Delete sync-to-runtime.sh:**

Run `git rm bin/sync-to-runtime.sh` to remove the sync script from the repository. Per locked decision: no archive copy, clean removal.

**Delete runtime/ directory:**

Run `git rm -r runtime/` to remove the entire runtime/ staging directory. If runtime/ is gitignored and not tracked, use `rm -rf runtime/` instead.

Check `.gitignore` for `runtime/` entry — this should have been removed in Task 1. If `runtime/` was gitignored (not tracked), there's nothing to `git rm`. Just delete the directory with `rm -rf runtime/`.

**Verify clean state:**

After deletion, verify:
1. `ls runtime/` returns "No such file or directory"
2. `ls bin/sync-to-runtime.sh` returns "No such file or directory"
3. No remaining references to either file in active code paths
  </action>
  <verify>
    `test ! -d runtime/` exits 0 (directory does not exist).
    `test ! -f bin/sync-to-runtime.sh` exits 0 (file does not exist).
    `npm test` still passes after deletions.
    `bash bin/validate-package.sh` still passes.
  </verify>
  <done>
    runtime/ directory and sync-to-runtime.sh completely removed. No runtime/ staging exists. Pipeline operates directly from .aether/.
  </done>
</task>

</tasks>

<verification>
1. `bash bin/validate-package.sh` — passes with "Package validation passed."
2. `bash bin/validate-package.sh --dry-run` — shows .aether/ files, no runtime/ files, no private directories
3. `npm test` — all tests pass (some test file updates may be needed in Plan 02)
4. `grep -r "runtime/" bin/cli.js bin/lib/update-transaction.js` — no active runtime/ references
5. `grep -r "SYSTEM_FILES" bin/cli.js bin/lib/update-transaction.js` — no SYSTEM_FILES arrays
6. `test ! -d runtime/ && test ! -f bin/sync-to-runtime.sh` — both deleted
</verification>

<success_criteria>
- runtime/ directory does not exist
- sync-to-runtime.sh does not exist
- npm package includes .aether/ files directly (excluding private directories)
- Hub sync reads from .aether/ not runtime/
- aether update uses exclude-based sync (not allowlist) for system files
- Migration message appears for pre-4.0 upgrades
- validate-package.sh provides dry-run mode and private data guard
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-01-SUMMARY.md`
</output>
