---
phase: 20-distribution-simplification
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - .git/hooks/pre-commit
  - .aether/aether-utils.sh
  - .aether/data/checkpoint-allowlist.json
  - .claude/commands/ant/build.md
  - .opencode/commands/ant/build.md
  - .aether/docs/known-issues.md
  - tests/bash/test-aether-utils.sh
autonomous: true
requirements:
  - PIPE-03

must_haves:
  truths:
    - "Pre-commit hook validates .aether/ integrity instead of syncing runtime/"
    - "aether-utils.sh has zero runtime/ path references in active code"
    - "queen-init template lookup no longer checks runtime/templates/"
    - "Build commands (Claude + OpenCode) no longer include runtime in checkpoint stash targets"
    - "ISSUE-004 (template path hardcoded to runtime/) marked as FIXED in known-issues.md"
    - "All bash tests pass after runtime/ reference cleanup"
  artifacts:
    - path: ".git/hooks/pre-commit"
      provides: "Validation-only pre-commit hook (no runtime/ sync)"
      min_lines: 10
    - path: ".aether/aether-utils.sh"
      provides: "Shell utility with all runtime/ path references removed"
    - path: ".claude/commands/ant/build.md"
      provides: "Build command with runtime removed from checkpoint stash targets"
    - path: ".opencode/commands/ant/build.md"
      provides: "Build command mirror with runtime removed from checkpoint stash targets"
    - path: ".aether/docs/known-issues.md"
      provides: "ISSUE-004 marked as FIXED, runtime/**/* removed from safe-files listing"
    - path: "tests/bash/test-aether-utils.sh"
      provides: "Updated tests without runtime/ path assumptions"
  key_links:
    - from: ".git/hooks/pre-commit"
      to: "bin/validate-package.sh"
      via: "Hook calls validation script on .aether/ changes"
      pattern: "validate-package"
    - from: ".aether/aether-utils.sh queen-init"
      to: ".aether/templates/QUEEN.md.template"
      via: "Template lookup array (runtime/ path removed)"
      pattern: "templates/QUEEN.md.template"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/checkpoint-allowlist.json"
      via: "Build checkpoint stash targets must match allowlist"
      pattern: "aether-checkpoint"
---

<objective>
Update the pre-commit hook, clean runtime/ references from shell code, build commands, known-issues docs, and update bash tests. The pre-commit hook currently blocks runtime/ edits and auto-runs sync-to-runtime.sh -- both behaviors must be replaced with validation-only logic. Shell utility references to runtime/ paths are dead code. Build commands still include runtime in checkpoint stash targets.

Purpose: Complete the pipeline simplification by removing all runtime/ references from shell code, hooks, build commands, and operational docs, ensuring the system operates cleanly without the old staging directory.

Output: Clean pre-commit hook, shell utilities with no runtime/ dead paths, build commands updated, known-issues updated, passing tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-01-SUMMARY.md

@.git/hooks/pre-commit
@.aether/aether-utils.sh
@.claude/commands/ant/build.md
@.opencode/commands/ant/build.md
@.aether/docs/known-issues.md
@tests/bash/test-aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite pre-commit hook and update build commands</name>
  <files>
    .git/hooks/pre-commit
    .claude/commands/ant/build.md
    .opencode/commands/ant/build.md
  </files>
  <action>
**Pre-commit hook (.git/hooks/pre-commit):**

Replace the entire pre-commit hook (currently 43 lines) with a simplified version. The current hook (1) blocks direct runtime/ edits, (2) runs sync-to-runtime.sh, (3) stages synced runtime/ changes. After Plan 01, runtime/ doesn't exist and there's nothing to sync.

New hook behavior:
1. Shebang `#!/bin/bash`, `set -euo pipefail`
2. Comment header: `# Aether Pre-Commit Hook (v2 -- simplified pipeline, runtime/ removed in v4.0)`
3. Check if `.aether/` files are staged for commit using `git diff --cached --name-only | grep -q '^\.aether/'`
4. If yes, run `bash bin/validate-package.sh 2>/dev/null || echo "Package validation completed with warnings"` -- non-blocking (per Claude's discretion: warn but don't block commits). This is a repurposed validation check replacing the old sync trigger.
5. Exit 0 (non-blocking -- validation is advisory)

Do NOT include any runtime/ references. Do NOT include lint checks that didn't exist in the original hook. Keep it simple and focused.

**Build commands -- .claude/commands/ant/build.md:**

At lines 165-166, the checkpoint stash target list includes `runtime` in both the change-check and stash-push commands:
- Line 165: `.aether .claude/commands/ant .claude/commands/st .opencode runtime bin`
- Line 166: same list in the `git stash push` command

Remove `runtime` from both lines. The updated lists should be:
`.aether .claude/commands/ant .claude/commands/st .opencode bin`

**Build commands -- .opencode/commands/ant/build.md:**

Mirror the same change at lines 155-156. Remove `runtime` from both the change-check and stash-push target directory lists:
- Line 155: remove `runtime` from the list
- Line 156: remove `runtime` from the stash push command
  </action>
  <verify>
    Read `.git/hooks/pre-commit` and confirm:
    - No references to `runtime/`
    - No references to `sync-to-runtime.sh`
    - References `validate-package.sh`
    - Exits 0 (non-blocking)
    Grep for `runtime` in `.claude/commands/ant/build.md` -- should return zero matches for `runtime` as a directory target (the word "runtime" may appear in other contexts like "runtime behavior").
    Grep for `runtime` in `.opencode/commands/ant/build.md` -- same check.
  </verify>
  <done>
    Pre-commit hook validates .aether/ instead of syncing runtime/. Build commands (both Claude and OpenCode) no longer include runtime in checkpoint stash targets. No runtime/ directory references remain in any of these files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean runtime/ references from aether-utils.sh, known-issues, and update tests</name>
  <files>
    .aether/aether-utils.sh
    .aether/docs/known-issues.md
    tests/bash/test-aether-utils.sh
  </files>
  <action>
**aether-utils.sh changes (6 locations identified by research):**

1. **Line 316 (CONTEXT block):** The text says `runtime/` is auto-populated on publish. Update to remove the runtime/ reference. Change to reflect the new direct-packaging architecture: `.aether/ is published directly (private dirs excluded by .npmignore)`.

2. **Line 1724 (target_dirs in autofix-checkpoint):** The `target_dirs` string includes `runtime` in the space-separated list. Remove `runtime` from this list. The remaining dirs should be: `.aether .claude/commands/ant .claude/commands/st .opencode bin`

3. **Line 3379 (queen-init template lookup comment):** The comment says something like `Order: hub (system/) -> dev (runtime/) -> repo local -> legacy`. Update to: `Order: hub (system/) -> dev (.aether/) -> repo local -> legacy`

4. **Line 3383 (queen-init template lookup array):** Remove `"$AETHER_ROOT/runtime/templates/QUEEN.md.template"` from the template paths array. The lookup order after removal should be:
   - `"$HOME/.aether/system/templates/QUEEN.md.template"` (hub -- primary)
   - `"$AETHER_ROOT/.aether/templates/QUEEN.md.template"` (dev repo -- secondary)
   - `"$HOME/.aether/templates/QUEEN.md.template"` (legacy hub -- fallback)

5. **Line 3405 (queen-init error message):** Remove `"runtime/templates/QUEEN.md.template"` from the `templates_checked` JSON array in the error message. The array should list only the three remaining paths.

6. **Lines 3792-3793 (system file classification):** Remove the `elif [[ "$file" == runtime/* ]]; then is_system=true` branch from the file classification logic. This branch classified runtime/ files as system files -- with runtime/ deleted, the branch is dead code.

**NOTE:** The research also found "runtime behavior" at line 2029. This is NOT a path reference -- leave it unchanged.

**known-issues.md changes:**

1. **Line 26 (System Files safe list):** Remove `runtime/**/*`, `bin/**/*` entry. Wait -- only remove `runtime/**/*`. The `bin/**/*` entry is still valid. Actually, looking at the file, line 26 reads `- `runtime/**/*`, `bin/**/*``. These are listed as "safe" system files for the checkpoint. Remove `runtime/**/*` from this line. The line should become just `- `bin/**/*`` or merge with the preceding line.

2. **Lines 144-149 (ISSUE-004):** Update the status of ISSUE-004 from open to FIXED. The issue was "Template path hardcoded to runtime/" with workaround "Use git clone instead of npm install". Phase 20 resolves this by removing the runtime/ template path entirely. Update:
   - Add `**Status:** FIXED -- Phase 20: runtime/ template path removed from queen-init lookup array. Template is now found via hub path or .aether/templates/ path.`
   - Strike through the workaround line or remove it
   - Move to the "Fixed Issues" section or add a FIXED marker inline

3. **Workarounds Summary table** (line 227): Update the ISSUE-004 row to show it's fixed -- strike through or update similarly to how BUG-005/BUG-002 are shown as fixed.

**tests/bash/test-aether-utils.sh changes:**

Research identified test references that assume runtime/ exists:

1. **Lines 745-746 (queen-init test setup):** The test simulates an npm-installed user by removing `runtime/templates/`. After Phase 20, runtime/ doesn't exist, so this `rm -rf "$tmp_dir/runtime"` line is dead code. Remove it and update the test comment to reflect the new architecture.

2. **Line 754 (real_template path):** The variable `local real_template="$PROJECT_ROOT/runtime/templates/QUEEN.md.template"` looks up the template from runtime/. Change to: `local real_template="$PROJECT_ROOT/.aether/templates/QUEEN.md.template"` -- this is the dev-repo lookup path.

3. **Lines 810-811 (another queen-init test):** Same pattern -- `rm -rf "$tmp_dir/runtime"` is dead code. Remove it and update the comment.

**NOTE:** Lines 910, 939, 968 contain "runtime" as in "runtime error" (not the runtime/ directory). Leave these unchanged.
  </action>
  <verify>
    Run `grep -n 'runtime/' .aether/aether-utils.sh` -- should return zero matches for path references (only "runtime behavior" style non-path references may remain).
    Run `grep -n 'runtime/' tests/bash/test-aether-utils.sh` -- should return zero matches for runtime/ directory references.
    Run `grep -n 'runtime/' .aether/docs/known-issues.md` -- should return zero matches (ISSUE-004 reworded without path reference).
    Run `npm run test:bash` -- all bash tests pass.
    Run `npm test` -- all tests pass.
  </verify>
  <done>
    aether-utils.sh has zero runtime/ path references. queen-init looks up templates from hub -> .aether/ -> legacy (no runtime/ in chain). autofix-checkpoint no longer targets runtime/. System file classification no longer has runtime/* branch. ISSUE-004 marked as FIXED. known-issues safe-files list cleaned. Bash tests updated to use .aether/ paths. All tests passing.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'runtime/' .git/hooks/pre-commit` -- no matches
2. `grep -n 'runtime/' .aether/aether-utils.sh | grep -v 'runtime behavior'` -- no matches
3. `grep -n 'runtime/' tests/bash/test-aether-utils.sh | grep -v 'runtime error'` -- no matches
4. `grep -n 'runtime/' .aether/docs/known-issues.md` -- no matches
5. `grep -n ' runtime ' .claude/commands/ant/build.md .opencode/commands/ant/build.md` -- no matches for runtime as a stash target
6. `npm run test:bash` -- all bash tests pass
7. `npm test` -- all 446+ tests pass
</verification>

<success_criteria>
- Pre-commit hook no longer references runtime/ or sync-to-runtime.sh
- Pre-commit hook calls validate-package.sh for .aether/ validation
- aether-utils.sh has no runtime/ directory path references
- queen-init template lookup uses hub -> .aether/ -> legacy (no runtime/)
- Build commands (both platforms) exclude runtime from checkpoint targets
- ISSUE-004 marked as FIXED in known-issues.md
- All bash tests and unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-02-SUMMARY.md`
</output>
