---
phase: 20-distribution-simplification
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - .git/hooks/pre-commit
  - .aether/aether-utils.sh
  - tests/bash/test-aether-utils.sh
autonomous: true
requirements:
  - PIPE-03

must_haves:
  truths:
    - "Pre-commit hook validates .aether/ integrity instead of syncing runtime/"
    - "aether-utils.sh has zero references to runtime/ in active code paths"
    - "queen-init template lookup no longer checks runtime/templates/"
    - "All bash tests pass after runtime/ reference cleanup"
  artifacts:
    - path: ".git/hooks/pre-commit"
      provides: "Validation-only pre-commit hook (no runtime/ sync)"
      min_lines: 10
    - path: ".aether/aether-utils.sh"
      provides: "Shell utility with runtime/ references removed"
    - path: "tests/bash/test-aether-utils.sh"
      provides: "Updated tests without runtime/ path assumptions"
  key_links:
    - from: ".git/hooks/pre-commit"
      to: "bin/validate-package.sh"
      via: "Hook calls validation script on .aether/ changes"
      pattern: "validate-package"
    - from: ".aether/aether-utils.sh queen-init"
      to: ".aether/templates/QUEEN.md.template"
      via: "Template lookup array (runtime/ path removed)"
      pattern: "templates/QUEEN.md.template"
---

<objective>
Update the pre-commit hook for the simplified pipeline, clean runtime/ references from aether-utils.sh, and update bash tests. The pre-commit hook currently blocks runtime/ edits and auto-runs sync-to-runtime.sh — both behaviors must be replaced with validation-only logic. Shell utility references to runtime/ paths are dead code that should be cleaned up.

Purpose: Complete the pipeline simplification by removing all runtime/ references from shell code and hooks, ensuring the system operates cleanly without the old staging directory.

Output: Clean pre-commit hook, shell utilities with no runtime/ dead paths, passing bash tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-distribution-simplification/20-RESEARCH.md
@.planning/phases/20-distribution-simplification/20-01-SUMMARY.md

@.git/hooks/pre-commit
@.aether/aether-utils.sh
@tests/bash/test-aether-utils.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite pre-commit hook for simplified pipeline</name>
  <files>
    .git/hooks/pre-commit
  </files>
  <action>
Replace the entire pre-commit hook with a simplified version. The current hook (1) blocks direct runtime/ edits, (2) runs sync-to-runtime.sh, (3) stages synced runtime/ changes. After Phase 20, runtime/ doesn't exist and there's nothing to sync.

New hook behavior:
1. Shebang `#!/bin/bash`, `set -euo pipefail`
2. Comment header: `# Aether Pre-Commit Hook (v2 — simplified pipeline, runtime/ removed in v4.0)`
3. When `.aether/` files are staged for commit, run `bash bin/validate-package.sh 2>/dev/null || echo "Package validation completed with warnings"` — non-blocking (per Claude's discretion: warn but don't block commits). This is a repurposed validation check replacing the old sync trigger.
4. Keep the existing lint check section (step 3 of the old hook, lines 36-40) — it runs `npm run lint` non-blockingly.
5. `exit 0`

Do NOT include any runtime/ references in the new hook. The hook no longer needs to check for runtime/ edits or stage runtime/ changes.
  </action>
  <verify>
    Read `.git/hooks/pre-commit` and confirm:
    - No references to `runtime/`
    - No references to `sync-to-runtime.sh`
    - References `validate-package.sh`
    - Exits 0 (non-blocking)
  </verify>
  <done>
    Pre-commit hook validates .aether/ files instead of syncing runtime/. No runtime/ references remain. Hook is non-blocking (validation warns, lint warns, both non-fatal).
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean runtime/ references from aether-utils.sh and update tests</name>
  <files>
    .aether/aether-utils.sh
    tests/bash/test-aether-utils.sh
  </files>
  <action>
**aether-utils.sh changes:**

Research identified 6 runtime/ references. Clean up each:

1. **Line 315 (CONTEXT block):** The row says `runtime/` is auto-populated on publish. Update to remove the runtime/ reference. Change the text to reflect the new direct-packaging architecture. The exact line is in a table/comment describing architecture — update it to say `.aether/` is published directly.

2. **Line 1723 (target_dirs in checkpoint logic):** The `target_dirs` string includes `runtime` in the list. Remove `runtime` from this space-separated list. The remaining dirs should be: `.aether .claude/commands/ant .claude/commands/st .opencode bin`

3. **Line 2029:** This is a string containing "runtime behavior" (as in "the program's runtime behavior", not the `runtime/` directory). Leave this unchanged — it's not a path reference.

4. **Line 3351 (queen-init template lookup comment):** The comment says `Order: hub (system/) -> dev (runtime/) -> repo local -> legacy`. Update to: `Order: hub (system/) -> dev (.aether/) -> repo local -> legacy`

5. **Line 3355 (queen-init template lookup array):** Remove `"$AETHER_ROOT/runtime/templates/QUEEN.md.template"` from the template paths array. The lookup order after removal should be:
   - `"$HOME/.aether/system/templates/QUEEN.md.template"` (hub — primary)
   - `"$AETHER_ROOT/.aether/templates/QUEEN.md.template"` (dev repo — secondary)
   - `"$HOME/.aether/templates/QUEEN.md.template"` (legacy hub — fallback)

6. **Line 3377 (queen-init error message):** Remove `"runtime/templates/QUEEN.md.template"` from the checked-paths JSON array in the error message. The array should list only the three remaining paths.

7. **Line 3734 (system file classification):** Remove the `elif [[ "$file" == runtime/* ]]; then` branch from the file classification logic. This branch classified runtime/ files as system files — with runtime/ deleted, the branch is dead code.

**tests/bash/test-aether-utils.sh changes:**

Research identified test references at lines 745, 746, 754, 810, 811:

1. **Lines 745-746 (queen-init test setup):** The test simulates an npm-installed user by removing `runtime/templates/`. After Phase 20, runtime/ doesn't exist, so this `rm -rf "$tmp_dir/runtime"` line is dead code. Remove it and update the comment.

2. **Line 754 (real_template path):** The variable `local real_template="$PROJECT_ROOT/runtime/templates/QUEEN.md.template"` looks up the template from runtime/. After Phase 20, this should be `"$PROJECT_ROOT/.aether/templates/QUEEN.md.template"` instead. This is the dev-repo lookup path.

3. **Lines 810-811 (another queen-init test):** Same pattern — `rm -rf "$tmp_dir/runtime"` is dead code. Remove it and update the comment.

4. **Lines 910, 939, 968 (ERR-04 runtime tests):** These test names contain "runtime" as in "runtime error" (not the runtime/ directory). Leave these unchanged — they're testing error handling at runtime, not testing the runtime/ directory.

5. **Line 1207 (summary comment):** Contains "runtime error code tests" — same as above, leave unchanged.
  </action>
  <verify>
    Run `grep -n 'runtime/' .aether/aether-utils.sh` — should return zero matches for path references (only "runtime behavior" style non-path references may remain).
    Run `grep -n 'runtime/' tests/bash/test-aether-utils.sh` — should return zero matches for runtime/ directory references.
    Run `npm run test:bash` — all bash tests pass.
    Run `npm test` — all tests pass.
  </verify>
  <done>
    aether-utils.sh has zero runtime/ path references. queen-init looks up templates from hub -> .aether/ -> legacy (no runtime/ in chain). Bash tests updated to reflect new paths. All tests passing.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'runtime/' .git/hooks/pre-commit` — no matches
2. `grep -n 'runtime/' .aether/aether-utils.sh | grep -v 'runtime behavior'` — no matches
3. `grep -n 'runtime/' tests/bash/test-aether-utils.sh | grep -v 'runtime —\|runtime error'` — no matches
4. `npm run test:bash` — all bash tests pass
5. `npm test` — all 446+ tests pass
</verification>

<success_criteria>
- Pre-commit hook no longer references runtime/ or sync-to-runtime.sh
- Pre-commit hook calls validate-package.sh for .aether/ validation
- aether-utils.sh has no runtime/ directory path references
- queen-init template lookup uses hub -> .aether/ -> legacy (no runtime/)
- All bash tests and unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-distribution-simplification/20-02-SUMMARY.md`
</output>
