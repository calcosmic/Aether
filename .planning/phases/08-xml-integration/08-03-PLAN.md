---
phase: 08-xml-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
  - .claude/commands/ant/seal.md
  - .aether/commands/claude/seal.md
  - .opencode/commands/ant/seal.md
  - .aether/commands/opencode/seal.md
autonomous: true
requirements: [XML-01, XML-02, XML-03]

must_haves:
  truths:
    - "colony-archive-xml subcommand produces a single combined XML file with pheromone, wisdom, and registry sections"
    - "Only active pheromone signals are included in the archive (inactive/expired excluded)"
    - "Running /ant:seal automatically exports colony-archive.xml to .aether/exchange/ (best-effort, non-blocking)"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "colony-archive-xml subcommand"
      contains: "colony-archive-xml)"
    - path: ".claude/commands/ant/seal.md"
      provides: "XML export step in seal ceremony"
      contains: "colony-archive-xml"
    - path: ".opencode/commands/ant/seal.md"
      provides: "XML export step in seal ceremony (OpenCode)"
      contains: "colony-archive-xml"
  key_links:
    - from: ".claude/commands/ant/seal.md"
      to: ".aether/aether-utils.sh"
      via: "bash .aether/aether-utils.sh colony-archive-xml"
      pattern: "colony-archive-xml"
    - from: ".aether/aether-utils.sh (colony-archive-xml)"
      to: ".aether/exchange/pheromone-xml.sh"
      via: "source + xml-pheromone-export"
      pattern: "source.*pheromone-xml.sh"
---

<objective>
Build the `colony-archive-xml` combined export subcommand in aether-utils.sh and wire best-effort XML export into the /ant:seal command.

Purpose: The combined archive function produces a single `colony-archive.xml` file containing all three data types (pheromones, wisdom, registry) in namespaced sections. Seal triggers this automatically as a milestone snapshot. This is the foundation that entomb (plan 04) will also use with hard-stop semantics.

Output:
- New `colony-archive-xml` subcommand in aether-utils.sh
- Updated seal.md (Claude Code + OpenCode) with XML export step
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-xml-integration/08-RESEARCH.md

@.aether/aether-utils.sh (lines 4405-4678 — existing XML subcommands)
@.aether/exchange/pheromone-xml.sh
@.aether/exchange/wisdom-xml.sh
@.aether/exchange/registry-xml.sh
@.aether/utils/xml-core.sh
@.claude/commands/ant/seal.md
@.opencode/commands/ant/seal.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add colony-archive-xml combined export subcommand to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Add a new `colony-archive-xml` subcommand in the XML Exchange Commands section of aether-utils.sh (after the `registry-import-xml` case at line ~4678, before the Session Continuity section).

**Usage:** `colony-archive-xml <output_file> [--active-only]`
- Default output: `.aether/exchange/colony-archive.xml`
- `--active-only` flag defaults to true (always filter active pheromones for archive purposes)

**Implementation steps:**

1. **Check xmllint availability** using `command -v xmllint`. If missing, `json_err` with install guidance.

2. **Filter active-only pheromone signals** before export:
```bash
# Create temp file with active-only pheromones
cax_tmp_pheromones=$(mktemp)
if [[ -f "$DATA_DIR/pheromones.json" ]]; then
  jq '{
    version: .version,
    colony_id: .colony_id,
    generated_at: .generated_at,
    signals: [.signals[] | select(.active == true)]
  }' "$DATA_DIR/pheromones.json" > "$cax_tmp_pheromones" 2>/dev/null
else
  echo '{"version":"1.0","colony_id":"unknown","generated_at":"","signals":[]}' > "$cax_tmp_pheromones"
fi
```

3. **Export each section to temp XML files** using existing subcommand functions:
```bash
cax_tmp_dir=$(mktemp -d)

# Pheromone section (using filtered active-only)
source "$SCRIPT_DIR/exchange/pheromone-xml.sh"
xml-pheromone-export "$cax_tmp_pheromones" "$cax_tmp_dir/pheromones.xml" 2>/dev/null

# Wisdom section
source "$SCRIPT_DIR/exchange/wisdom-xml.sh"
# Use existing wisdom export — it handles missing files gracefully
cax_wisdom_input="$DATA_DIR/queen-wisdom.json"
if [[ ! -f "$cax_wisdom_input" ]]; then
  # Try extracting from COLONY_STATE.json (same logic as wisdom-export-xml)
  cax_wisdom_input="$cax_tmp_dir/wisdom-input.json"
  # ... (reuse existing wisdom-export-xml fallback logic)
fi
xml-wisdom-export "$cax_wisdom_input" "$cax_tmp_dir/wisdom.xml" 2>/dev/null

# Registry section
source "$SCRIPT_DIR/exchange/registry-xml.sh"
cax_registry_input="$DATA_DIR/colony-registry.json"
# ... (reuse existing registry-export-xml on-demand generation logic)
xml-registry-export "$cax_registry_input" "$cax_tmp_dir/registry.xml" 2>/dev/null
```

4. **Build combined XML** by extracting inner content from each section's XML file and wrapping in a `<colony-archive>` root element:
```bash
cax_output="${1:-$SCRIPT_DIR/exchange/colony-archive.xml}"
mkdir -p "$(dirname "$cax_output")"

cax_colony_id=$(jq -r '.goal // "unknown"' "$DATA_DIR/COLONY_STATE.json" 2>/dev/null | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | sed 's/^-//;s/-$//')
cax_sealed_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
cax_pheromone_count=$(jq '.signals | length' "$cax_tmp_pheromones" 2>/dev/null || echo 0)

# Build combined XML with namespace prefixes per section
cat > "$cax_output" << ARCHIVE_EOF
<?xml version="1.0" encoding="UTF-8"?>
<colony-archive
    xmlns="http://aether.colony/schemas/archive/1.0"
    colony_id="$cax_colony_id"
    sealed_at="$cax_sealed_at"
    version="1.0.0"
    pheromone_count="$cax_pheromone_count">
ARCHIVE_EOF

# Append pheromone section (strip XML declaration, keep root element with its namespace)
if [[ -f "$cax_tmp_dir/pheromones.xml" ]]; then
  sed '1{/<?xml/d;}' "$cax_tmp_dir/pheromones.xml" >> "$cax_output"
fi

# Append wisdom section
if [[ -f "$cax_tmp_dir/wisdom.xml" ]]; then
  sed '1{/<?xml/d;}' "$cax_tmp_dir/wisdom.xml" >> "$cax_output"
fi

# Append registry section
if [[ -f "$cax_tmp_dir/registry.xml" ]]; then
  sed '1{/<?xml/d;}' "$cax_tmp_dir/registry.xml" >> "$cax_output"
fi

# Close root element
echo '</colony-archive>' >> "$cax_output"
```

5. **Validate well-formedness** of the combined file using xmllint:
```bash
if xmllint --noout "$cax_output" 2>/dev/null; then
  cax_valid=true
else
  cax_valid=false
fi
```
Note: Skip XSD validation of the wrapper (per research recommendation). Each section was already validated individually by its exchange script.

6. **Cleanup temp files** and return JSON result:
```bash
rm -rf "$cax_tmp_dir" "$cax_tmp_pheromones"
json_ok "{\"path\":\"$cax_output\",\"valid\":$cax_valid,\"colony_id\":\"$cax_colony_id\",\"pheromone_count\":$cax_pheromone_count}"
```

**Variable naming:** All variables prefixed with `cax_` (colony-archive-xml) per codebase convention.

**Error handling:** If any individual section export fails, the combined archive still includes whatever sections succeeded. The `2>/dev/null` on each export allows partial results. The well-formedness check at the end catches structural issues.
  </action>
  <verify>
Run: `bash .aether/aether-utils.sh colony-archive-xml /tmp/test-archive.xml`

Expected: JSON response with `{"ok":true,"result":{"path":"/tmp/test-archive.xml",...}}` and the file contains `<colony-archive>` with pheromone, wisdom, and registry sections. Verify active-only filter by checking that no `active="false"` signals appear in the pheromone section.

Also verify: `xmllint --noout /tmp/test-archive.xml` returns 0 (well-formed XML).
  </verify>
  <done>
colony-archive-xml subcommand exists in aether-utils.sh, produces a single combined XML file with all three data types, filters to active-only pheromone signals, and validates as well-formed XML.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire best-effort XML export into /ant:seal (Claude Code + OpenCode)</name>
  <files>.claude/commands/ant/seal.md, .aether/commands/claude/seal.md, .opencode/commands/ant/seal.md, .aether/commands/opencode/seal.md</files>
  <action>
Add a new step to seal.md **between Step 6 (Write CROWNED-ANTHILL.md) and Step 7 (Display Ceremony)** — call it **Step 6.5: Export XML Archive (best-effort)**. Apply to all 4 copies (Claude Code live + SoT, OpenCode live + SoT).

**Claude Code seal.md — add after the CROWNED-ANTHILL.md write, before the ceremony display:**

```markdown
### Step 6.5: Export XML Archive (best-effort)

Export colony data as a combined XML archive. This is best-effort — seal proceeds even if XML export fails.

\`\`\`bash
# Check if xmllint is available
if command -v xmllint >/dev/null 2>&1; then
  xml_result=$(bash .aether/aether-utils.sh colony-archive-xml ".aether/exchange/colony-archive.xml" 2>&1)
  xml_ok=$(echo "$xml_result" | jq -r '.ok // false' 2>/dev/null)
  if [[ "$xml_ok" == "true" ]]; then
    xml_path=$(echo "$xml_result" | jq -r '.result.path // ""' 2>/dev/null)
    xml_pheromone_count=$(echo "$xml_result" | jq -r '.result.pheromone_count // 0' 2>/dev/null)
    xml_export_line="XML Archive: colony-archive.xml (${xml_pheromone_count} active signals)"
  else
    xml_export_line="XML Archive: export failed (non-blocking)"
  fi
else
  xml_export_line="XML Archive: skipped (xmllint not available)"
fi
\`\`\`

Store `xml_export_line` for display in Step 7.
```

**Update Step 7 display** to include the XML line. In the ceremony output block, after `Seal Document: .aether/CROWNED-ANTHILL.md`, add:
```
{xml_export_line}
```

This is a discretion choice: show a brief confirmation line (not silent). It tells the user XML was exported without cluttering the ceremony.

**All 4 copies — apply identical changes:**
1. `.claude/commands/ant/seal.md` — Claude Code live copy
2. `.aether/commands/claude/seal.md` — Source of truth (Claude)
3. `.opencode/commands/ant/seal.md` — OpenCode live copy
4. `.aether/commands/opencode/seal.md` — Source of truth (OpenCode)

All copies receive the same Step 6.5 and the same display line addition to the ceremony output.

**Key constraints per CONTEXT.md:**
- Best-effort only — seal must NOT fail if XML export fails
- Export to `.aether/exchange/colony-archive.xml` (the live exchange directory, consistent with existing pheromones.xml, queen-wisdom.xml files already there)
- No standalone export command — this is the only trigger alongside entomb
  </action>
  <verify>
Read both seal.md files and confirm:
1. Step 6.5 exists with colony-archive-xml call
2. The best-effort pattern is used — XML failure is handled via conditional branching (if/else on `$xml_ok`), no `exit` or `return 1` appears in the XML export block (seal never fails on XML)
3. xml_export_line appears in the ceremony display
4. Both Claude Code and OpenCode versions match
  </verify>
  <done>
/ant:seal automatically exports colony-archive.xml to .aether/exchange/ during the seal ceremony. Export is best-effort: failure produces an informational line but does not block sealing. Both Claude Code and OpenCode copies updated identically.
  </done>
</task>

</tasks>

<verification>
1. `bash .aether/aether-utils.sh colony-archive-xml /tmp/test-archive.xml` — returns ok JSON, file is well-formed XML
2. `/tmp/test-archive.xml` contains `<colony-archive>` wrapper with pheromone, wisdom, registry child sections
3. Pheromone section contains only active signals (no `active="false"`)
4. seal.md (both copies) contain Step 6.5 with colony-archive-xml call and best-effort pattern
5. Ceremony display includes XML archive status line
</verification>

<success_criteria>
- colony-archive-xml subcommand produces valid combined XML with all 3 data types
- Active-only pheromone filter works correctly
- Seal command triggers XML export automatically (best-effort)
- Both Claude Code and OpenCode seal copies updated
- No regression in existing seal ceremony behavior
</success_criteria>

<output>
After completion, create `.planning/phases/08-xml-integration/08-03-SUMMARY.md`
</output>
