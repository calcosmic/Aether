---
phase: 08-xml-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/aether-utils.sh
autonomous: true
requirements: [XML-01]

must_haves:
  truths:
    - "pheromone-export-xml subcommand exists in aether-utils.sh"
    - "pheromone-import-xml subcommand exists in aether-utils.sh"
    - "pheromone-validate-xml subcommand exists in aether-utils.sh"
    - "Export reads pheromones.json and produces valid XML"
    - "Import reads XML and merges signals into pheromones.json"
    - "Graceful degradation when xmllint/xmlstarlet not available"
  artifacts:
    - path: ".aether/aether-utils.sh"
      provides: "pheromone-export-xml, pheromone-import-xml, pheromone-validate-xml subcommands"
  key_links:
    - from: ".aether/aether-utils.sh"
      to: ".aether/exchange/pheromone-xml.sh"
      via: "source command loads exchange functions"
      pattern: "source.*pheromone-xml\\.sh"
    - from: ".aether/aether-utils.sh"
      to: ".aether/data/pheromones.json"
      via: "reads pheromone data for export"
      pattern: "pheromones\\.json"
---

<objective>
Add pheromone XML exchange subcommands to aether-utils.sh that wire in the existing pheromone-xml.sh exchange script.

Purpose: The pheromone-xml.sh script has full JSON-to-XML and XML-to-JSON conversion, validation, and merge capabilities, but nothing in the system calls it. This plan adds 3 subcommands to aether-utils.sh that bridge the gap.
Output: Working pheromone-export-xml, pheromone-import-xml, and pheromone-validate-xml subcommands
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-xml-integration/08-CONTEXT.md
@.aether/exchange/pheromone-xml.sh
@.aether/utils/xml-core.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pheromone XML subcommands to aether-utils.sh</name>
  <files>.aether/aether-utils.sh</files>
  <action>
  Add 3 new subcommands to the main case statement in aether-utils.sh, after the existing pheromone-expire subcommand (around line 4300).

  **1. pheromone-export-xml subcommand:**
  ```
  pheromone-export-xml)
    # Usage: pheromone-export-xml [output_file]
    # Exports pheromones.json to XML format
    # Default output: .aether/exchange/pheromones.xml
  ```
  Implementation:
  - Source `.aether/exchange/pheromone-xml.sh` (use SCRIPT_DIR to find it)
  - Check if pheromones.json exists, error if not
  - Default output path: `.aether/exchange/pheromones.xml`
  - Allow override via first argument
  - Call `xml-pheromone-export "$DATA_DIR/pheromones.json" "$output_file"`
  - Return JSON result from the exchange function

  **2. pheromone-import-xml subcommand:**
  ```
  pheromone-import-xml)
    # Usage: pheromone-import-xml <xml_file>
    # Imports pheromone signals from XML into pheromones.json
  ```
  Implementation:
  - Source `.aether/exchange/pheromone-xml.sh`
  - Require xml_file argument, error if missing
  - Check if xml_file exists, error if not
  - Call `xml-pheromone-import "$xml_file"` to get JSON
  - Parse the resulting JSON and merge signals into existing pheromones.json
  - Use jq to merge: add imported signals to .signals array, deduplicate by id
  - Return JSON result with signal count

  **3. pheromone-validate-xml subcommand:**
  ```
  pheromone-validate-xml)
    # Usage: pheromone-validate-xml <xml_file>
    # Validates pheromone XML against XSD schema
  ```
  Implementation:
  - Source `.aether/exchange/pheromone-xml.sh`
  - Require xml_file argument, error if missing
  - Call `xml-pheromone-validate "$xml_file" ".aether/schemas/pheromone.xsd"`
  - Return validation result

  **Graceful degradation pattern for all 3:**
  Before sourcing the exchange script, check if xmllint is available. If not, return a clear error:
  ```bash
  if ! command -v xmllint >/dev/null 2>&1; then
    json_err "$E_TOOL_NOT_FOUND" "xmllint not available — XML features require libxml2 (install: xcode-select --install on macOS)"
    exit 1
  fi
  ```

  **Ensure mkdir -p for exchange directory:**
  ```bash
  mkdir -p "$SCRIPT_DIR/exchange"
  ```
  </action>
  <verify>
  1. Run `bash .aether/aether-utils.sh pheromone-export-xml` — should export pheromones.json to XML
  2. Run `bash .aether/aether-utils.sh pheromone-validate-xml .aether/schemas/examples/pheromone-example.xml` — should validate
  3. Verify graceful error when xmllint missing (can't easily test, but check code path exists)
  4. Verify all 3 subcommands appear in the case statement
  </verify>
  <done>Pheromone XML subcommands added to aether-utils.sh</done>
</task>

</tasks>

<verification>
1. pheromone-export-xml reads pheromones.json and produces valid XML output
2. pheromone-import-xml reads XML and can merge into pheromones.json
3. pheromone-validate-xml validates against XSD schema
4. Graceful error message when xmllint not available
5. Exchange directory created if missing
</verification>

<success_criteria>
- 3 new subcommands in aether-utils.sh for pheromone XML operations
- Exchange scripts properly sourced and called
- JSON results returned in standard format
- Graceful degradation for missing tools
</success_criteria>

<output>
After completion, create `.planning/phases/08-xml-integration/08-01-SUMMARY.md`
</output>
