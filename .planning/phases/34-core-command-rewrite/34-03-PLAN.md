---
phase: 34-core-command-rewrite
plan: 03
type: execute
wave: 3
depends_on: ["34-01", "34-02"]
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "build -> continue handoff works without state loss"
    - "State survives context boundaries (can /clear between build and continue)"
    - "Orphan EXECUTING state is detected and handled"
    - "Line count targets met (build <450, continue <180)"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Verified build command"
      max_lines: 450
    - path: ".claude/commands/ant/continue.md"
      provides: "Verified continue command"
      max_lines: 180
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: ".claude/commands/ant/continue.md"
      via: "EXECUTING state + SUMMARY.md detection"
      pattern: 'state.*EXECUTING.*SUMMARY'
---

<objective>
Verify build/continue integration and polish both commands

Purpose: Ensure the start-of-next-command state pattern works correctly across context boundaries
Output: Verified, polished build.md and continue.md that work together seamlessly
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-core-command-rewrite/34-CONTEXT.md
@.planning/phases/34-core-command-rewrite/34-RESEARCH.md
@.planning/phases/34-core-command-rewrite/34-01-SUMMARY.md
@.planning/phases/34-core-command-rewrite/34-02-SUMMARY.md
@.claude/commands/ant/build.md
@.claude/commands/ant/continue.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify state handoff pattern</name>
  <files>.claude/commands/ant/build.md, .claude/commands/ant/continue.md</files>
  <action>
Read both build.md and continue.md. Verify the state handoff pattern is correctly implemented:

**Build Side (check these are present):**
1. Step 2 writes EXECUTING state before workers spawn
2. Step 2 writes build_started_at timestamp
3. Step 2 sets phase status to "in_progress"
4. NO Step 6 equivalent (Record Outcome) that writes task completion
5. NO Step 7a equivalent (Extract Learnings)
6. NO Step 7b equivalent (Emit Pheromones)
7. Ends with display output and Next commands

**Continue Side (check these are present):**
1. Step 1 reads state and checks for EXECUTING
2. Step 1 implements SUMMARY.md detection
3. Step 1 handles orphan EXECUTING (stale build detection)
4. Step 2 performs full state reconciliation:
   - Updates task statuses based on detection
   - Extracts learnings
   - Emits pheromones
   - Updates spawn_outcomes
   - Advances current_phase
   - Sets state to READY
5. Step 3 displays results

**Cross-command Contract:**
- build.md writes: state=EXECUTING, build_started_at, phase status=in_progress
- continue.md reads: state (checks EXECUTING), build_started_at (checks stale), SUMMARY.md (checks exists)
- continue.md writes: state=READY, task statuses, learnings, pheromones, current_phase++

If any mismatches found, fix them to ensure the contract is consistent.
  </action>
  <verify>
- build.md Step 2 writes state=EXECUTING
- build.md does NOT have Record Outcome step
- continue.md Step 1 checks for state=EXECUTING
- continue.md Step 1 checks SUMMARY.md existence
- continue.md Step 2 writes state=READY
  </verify>
  <done>State handoff pattern verified and any mismatches fixed</done>
</task>

<task type="auto">
  <name>Task 2: Final polish and line count verification</name>
  <files>.claude/commands/ant/build.md, .claude/commands/ant/continue.md</files>
  <action>
Check line counts and apply final polish:

1. Run `wc -l .claude/commands/ant/build.md`
   - Target: under 450 lines
   - If over, identify sections to trim further (verbose comments, redundant instructions)

2. Run `wc -l .claude/commands/ant/continue.md`
   - Target: under 180 lines
   - If over, identify sections to trim further

3. Polish both files:
   - Ensure step numbers are sequential and correct
   - Ensure all @references to files are accurate
   - Remove any orphaned comments or dead code
   - Ensure ANSI color codes in build.md are correct (reference Color Reference block)
   - Ensure continue.md --all mode still works (preserve Step 1.5 logic)

4. Verify preserved functionality per CONTEXT.md:
   - ANSI color output preserved
   - Banners and decorative boxes preserved
   - Pheromone bar display preserved
   - Full worker spawn output preserved
   - Detailed error output preserved

If line targets not met, document what remains and why (e.g., "visual identity requirements prevent further reduction").
  </action>
  <verify>
- `wc -l .claude/commands/ant/build.md` shows under 450 lines (or documented reason why not)
- `wc -l .claude/commands/ant/continue.md` shows under 180 lines (or documented reason why not)
- Step numbers are sequential in both files
- Visual identity elements preserved
  </verify>
  <done>Line counts verified and both commands polished</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `wc -l .claude/commands/ant/build.md` - target under 450
2. Run `wc -l .claude/commands/ant/continue.md` - target under 180
3. Total reduction: from 1,614 lines (1,080 + 534) to under 630 lines (61% reduction)
4. Verify build -> continue contract is documented clearly
5. Verify orphan state handling works
</verification>

<success_criteria>
- build.md under 450 lines (from 1,080 = 58% reduction)
- continue.md under 180 lines (from 534 = 66% reduction)
- State handoff pattern verified working
- Orphan EXECUTING state handled gracefully
- Visual identity preserved (colors, banners, pheromone bars)
- --all mode preserved in continue.md
</success_criteria>

<output>
After completion, create `.planning/phases/34-core-command-rewrite/34-03-SUMMARY.md`
</output>
