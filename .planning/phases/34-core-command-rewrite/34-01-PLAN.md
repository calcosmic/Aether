---
phase: 34-core-command-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "build.md writes EXECUTING state before spawning workers"
    - "build.md does NOT write task completion status"
    - "build.md does NOT extract learnings"
    - "build.md does NOT emit pheromones"
    - "build.md displays results without step-by-step checklist"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Simplified build command"
      max_lines: 450
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Writes EXECUTING state only"
      pattern: 'state.*EXECUTING'
---

<objective>
Rewrite build.md to implement start-of-next-command state pattern

Purpose: Solve the orphaned EXECUTING status problem by having build write minimal state before workers, leaving completion detection to continue.md
Output: Simplified build.md (~400 lines from 1,080) that spawns workers and displays results without end-of-command state writes
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-core-command-rewrite/34-CONTEXT.md
@.planning/phases/34-core-command-rewrite/34-RESEARCH.md
@.claude/commands/ant/build.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure build.md with minimal state write</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Rewrite build.md with the following structure (target ~400 lines):

**Step 1: Validate + Read State** (merge existing Steps 1-2)
- Validate $ARGUMENTS is a phase number
- Read COLONY_STATE.json, extract: goal, state, current_phase, plan.phases, signals, mode
- Validation checks (goal exists, plan exists, phase exists, not already completed)

**Step 2: Update State (Minimal)** (rewrite existing Step 4)
- Set state="EXECUTING"
- Set current_phase to the phase number
- Set workers.builder="active"
- Add build_started_at timestamp (ISO-8601)
- Set phase status to "in_progress" in plan.phases[N]
- Append phase_started event to events array
- Write COLONY_STATE.json
- CRITICAL: Do NOT update task statuses, learnings, pheromones, or spawn_outcomes

**Step 3: Git Checkpoint** (keep existing Step 4.5)
- Create pre-build commit for rollback capability
- Store commit hash for display

**Step 4: Compute Active Pheromones** (move existing Step 3 here, simplified)
- Run pheromone-batch utility
- Format active pheromones display
- Keep per-caste sensitivity table computation for worker prompts

**Step 5: Execute Phase** (merge existing Steps 5a-5c)
- Spawn Phase Lead for task assignment plan
- Plan checkpoint (auto-approve logic stays)
- Record plan decisions
- Execute workers via Task tool
- Worker retry and debugger logic (existing)
- Post-wave conflict check (existing)
- Post-wave advisory review (existing)
- Fulfill sub-spawns (existing)
- Compile Phase Build Report

**Step 6: Watcher Verification** (keep existing Step 5.5)
- Spawn mandatory watcher
- Get quality_score and recommendation

**Step 7: Display Results** (consolidate existing Steps 7c-7e)
- Display BUILD COMPLETE banner
- Display Phase info, Git Checkpoint, Colony Activity
- Display Delegation Tree
- Display Task Results
- Display Watcher Report (including Execution Verification)
- Display Pheromone Recommendations (max 3)
- Display Next commands: /ant:continue, /ant:feedback, /ant:status
- REMOVE: Step progress checklist (17 lines)
- REMOVE: Caste Pheromone Sensitivity table in output
- REMOVE: Persistence confirmation step
- REMOVE: Steps 6, 7a, 7b from current build (moved to continue)

**PRESERVE:**
- Color Reference comment block at top
- ANSI colored output (banners, caste colors)
- Pheromone bar display
- Full worker spawn output
- Detailed error output

**REMOVE (move to continue.md):**
- Step 6: Record Outcome (task status updates, error logging, spawn_outcomes)
- Step 7a: Extract Phase Learnings
- Step 7b: Emit FEEDBACK Pheromone
- Step 7c: Clean Expired Pheromones
- Step 7d: Write Auto-Learning Flag Event
- Step 7f: Persistence Confirmation

The key architectural change: build.md ends after displaying results. It does NOT write final state.
  </action>
  <verify>
- File exists at .claude/commands/ant/build.md
- Line count is under 450 lines (check with `wc -l`)
- Contains "state.*EXECUTING" write in Step 2
- Does NOT contain "Step 7a: Extract Phase Learnings"
- Does NOT contain "Step 7b: Emit FEEDBACK Pheromone"
- Does NOT contain "Step 7f: Persistence Confirmation"
- Contains Step 7: Display Results with BUILD COMPLETE banner
- Contains /ant:continue in Next commands section
  </verify>
  <done>build.md restructured with minimal state write, no end-of-command state updates, displays results only</done>
</task>

<task type="auto">
  <name>Task 2: Add build_started_at tracking field</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
In the Step 2: Update State section, ensure the build_started_at field is written to COLONY_STATE.json:

```json
{
  "build_started_at": "<ISO-8601 UTC timestamp>"
}
```

This field will be used by continue.md to:
1. Detect if a build ran (state==EXECUTING + build_started_at exists)
2. Check for stale builds (build_started_at is old)
3. Track build duration for metrics

The field should be written as a top-level field in COLONY_STATE.json alongside state, current_phase, etc.
  </action>
  <verify>
- build.md Step 2 mentions writing build_started_at field
- Field is described as ISO-8601 timestamp
  </verify>
  <done>build_started_at tracking field documented in build.md</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `wc -l .claude/commands/ant/build.md` - should be under 450 lines
2. Verify build.md has clear step structure (Steps 1-7)
3. Verify no end-of-command state writes (no Step 6 Record Outcome equivalent)
4. Verify display sections preserved (banners, colors, worker output)
</verification>

<success_criteria>
- build.md reduced from 1,080 lines to under 450 lines
- Writes EXECUTING state and build_started_at before workers spawn
- Does NOT write task completion status
- Does NOT extract learnings
- Does NOT emit pheromones
- Displays results with preserved visual identity
- Ends with "Next: /ant:continue" guidance
</success_criteria>

<output>
After completion, create `.planning/phases/34-core-command-rewrite/34-01-SUMMARY.md`
</output>
