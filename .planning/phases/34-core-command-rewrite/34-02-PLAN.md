---
phase: 34-core-command-rewrite
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "continue.md detects completed work via SUMMARY.md existence"
    - "continue.md reconciles task status based on output file detection"
    - "continue.md extracts learnings (moved from build.md)"
    - "continue.md emits pheromones (moved from build.md)"
    - "continue.md handles orphan EXECUTING state gracefully"
  artifacts:
    - path: ".claude/commands/ant/continue.md"
      provides: "Completion detection and state reconciliation"
      max_lines: 180
  key_links:
    - from: ".claude/commands/ant/continue.md"
      to: ".planning/phases"
      via: "Checks SUMMARY.md existence"
      pattern: 'SUMMARY.md.*exists'
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Reconciles state from file detection"
      pattern: 'state.*READY'
---

<objective>
Rewrite continue.md to detect completed work and reconcile state

Purpose: Implement the "state at start of next command" pattern by having continue detect what build accomplished via output files, then update state accordingly
Output: Simplified continue.md (~150 lines from 534) that handles completion detection, state reconciliation, and phase advancement
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-core-command-rewrite/34-CONTEXT.md
@.planning/phases/34-core-command-rewrite/34-RESEARCH.md
@.planning/phases/34-core-command-rewrite/34-01-SUMMARY.md
@.claude/commands/ant/continue.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add detection and reconciliation logic</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Rewrite continue.md with the following structure (target ~150 lines):

**Step 0: Parse Arguments** (keep existing)
- Check for --all flag
- Set auto_mode accordingly

**Step 1: Read State + Detect Completion** (merge and expand existing Step 1)
- Read COLONY_STATE.json
- Extract all fields (goal, state, current_phase, plan.phases, signals, errors, memory, events, build_started_at)
- Validation checks (goal exists, plan exists)

**New Detection Logic:**
If state == "EXECUTING":
  1. A build ran. Detect what completed:
     - Check if `.planning/phases/{phase}/SUMMARY.md` exists (primary completion signal)
     - Check activity.log for worker completions
     - Check git log for commits since build_started_at

  2. Reconcile task status:
     - For each task in plan.phases[N].tasks:
       - If output file exists: mark task "completed"
       - If output missing but worker ran: mark task "failed"
       - If worker didn't run: mark task "pending" (incomplete build)

  3. Handle orphan detection:
     - If EXECUTING but no completion signals and build_started_at is stale (>30 min):
       - Display warning: "Stale EXECUTING state detected. Build may have been interrupted."
       - Offer: "Continue anyway? (yes / rollback to git checkpoint)"
       - If rollback: run `git reset --hard {last_checkpoint}` and set state="READY"
     - If EXECUTING with recent build_started_at but no outputs:
       - Display: "Build appears to still be running. Wait or force continue with --force."

If state != "EXECUTING":
  - Normal continue flow (no build to reconcile)

**Step 2: Update State (Full Reconciliation)** (new step, absorbs logic from build Step 6)
- Mark tasks completed/failed based on detection
- Extract learnings from build output (was build Step 7a)
- Log errors if any detected (was build Step 6)
- Update spawn_outcomes (was build Step 6)
- Emit FEEDBACK pheromone (was build Step 7b)
- Emit REDIRECT if flagged_patterns exist (was build Step 7b)
- Clean expired pheromones (was build Step 7c)
- Advance current_phase
- Set state="READY"
- Set workers to "idle"
- Write COLONY_STATE.json

**Step 3: Display Result** (simplify existing Step 8)
- Display CONTINUE banner
- Phase completion summary (condensed)
- Learnings extracted
- Auto-emitted pheromones
- Next phase preview
- Next commands

**Keep existing but simplify:**
- Step 1.5: Auto-Continue Loop (--all mode)
- Step 2.5: Tech Debt Report (project completion)
- Step 2.5b: Promote Learnings (project completion)
- Step 2.5c: Completion message (project completion)

**REMOVE:**
- Step 3: Phase Completion Summary (redundant, absorbed into Step 3 display)
- Step 4: Extract Phase Learnings (moved to Step 2)
- Step 4.5: Auto-Emit Pheromones (moved to Step 2)
- Step 5: Clean Expired Pheromones (moved to Step 2)
- Step 6: Write Events (absorbed into Step 2)
- Step 7: Update Colony State (absorbed into Step 2)
- Step 9: Persistence Confirmation (remove entirely)
  </action>
  <verify>
- File exists at .claude/commands/ant/continue.md
- Line count is under 180 lines (check with `wc -l`)
- Contains "SUMMARY.md" existence check
- Contains orphan state handling (stale EXECUTING detection)
- Contains learning extraction (moved from build)
- Contains pheromone emission (moved from build)
- Does NOT contain "Step 9: Persistence Confirmation"
  </verify>
  <done>continue.md restructured with detection and reconciliation logic</done>
</task>

<task type="auto">
  <name>Task 2: Implement output-as-state detection pattern</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
In Step 1, implement the SIMP-07 "output-as-state" detection pattern:

**Primary Completion Signal:**
```
Check: Does `.planning/phases/{current_phase}-*/SUMMARY.md` exist?
- Use Glob tool or bash ls to check
- If SUMMARY.md exists AND is non-empty: phase is complete
- If SUMMARY.md missing: phase may be incomplete or build failed
```

**Secondary Signals (for task-level detection):**
```
For each task in plan.phases[N].tasks:
  - Extract expected output file from task description (if mentioned)
  - Check if that file exists
  - If exists: task completed
  - If missing: task incomplete
```

**Edge Case Handling (per RESEARCH.md):**
```
- Empty SUMMARY.md: Treat as incomplete (file exists but no content)
- Build crashed mid-write: Check git status for uncommitted changes as signal
- No build_started_at field: Legacy state, proceed with normal continue
```

Add clear comments explaining the detection logic so future maintainers understand the pattern.
  </action>
  <verify>
- continue.md Step 1 contains SUMMARY.md existence check
- continue.md handles empty SUMMARY.md case
- continue.md handles missing build_started_at (legacy compatibility)
  </verify>
  <done>Output-as-state detection pattern implemented with edge case handling</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `wc -l .claude/commands/ant/continue.md` - should be under 180 lines
2. Verify continue.md has detection logic in Step 1
3. Verify continue.md handles orphan EXECUTING state
4. Verify continue.md includes learning extraction and pheromone emission
5. Verify no persistence confirmation step
</verification>

<success_criteria>
- continue.md reduced from 534 lines to under 180 lines
- Detects completed work via SUMMARY.md existence
- Reconciles task status based on output file detection
- Extracts learnings (functionality moved from build.md)
- Emits pheromones (functionality moved from build.md)
- Handles orphan EXECUTING state gracefully
- Advances phase and sets state to READY
</success_criteria>

<output>
After completion, create `.planning/phases/34-core-command-rewrite/34-02-SUMMARY.md`
</output>
