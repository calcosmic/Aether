---
phase: 09-caste-model-assignment
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - bin/lib/model-profiles.js
  - bin/lib/proxy-health.js
  - bin/cli.js
  - .claude/commands/ant/verify-castes.md
autonomous: true
must_haves:
  truths:
    - Proxy health check returns healthy/unhealthy status with latency
    - `aether caste-models list` shows proxy health indicator
    - `/ant:verify-castes` command exists and runs verification
    - Test spawn verification confirms model routing works end-to-end
  artifacts:
    - path: bin/lib/proxy-health.js
      provides: "Proxy health checking utilities"
      exports: ["checkProxyHealth", "verifyModelRouting"]
    - path: bin/lib/model-profiles.js
      provides: "Model verification functions"
      exports: ["verifyCasteModel"]
    - path: .claude/commands/ant/verify-castes.md
      provides: "Interactive verification command"
      contains: "verify-castes"
  key_links:
    - from: bin/lib/proxy-health.js
      to: http://localhost:4000/health
      via: "fetch with timeout"
      pattern: "fetch.*health"
    - from: .claude/commands/ant/verify-castes.md
      to: bin/cli.js
      via: "aether caste-models list"
      pattern: "aether caste-models"
---

<objective>
Implement proxy health verification and end-to-end model routing verification. Create proxy-health.js library, integrate health checks into CLI, and create `/ant:verify-castes` slash command.

Purpose: Verify that the LiteLLM proxy is healthy and that model routing actually works by spawning test workers.
Output: Working health checks and verification command that confirms model assignments are functional.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-caste-model-assignment/09-RESEARCH.md
@.planning/phases/09-caste-model-assignment/09-CONTEXT.md
@.planning/phases/09-caste-model-assignment/09-01-PLAN.md
@.planning/phases/09-caste-model-assignment/09-02-PLAN.md
@/Users/callumcowie/repos/Aether/.aether/model-profiles.yaml
</context>

<tasks>

<task type="auto">
  <name>Create proxy-health.js library</name>
  <files>bin/lib/proxy-health.js</files>
  <action>
    Create bin/lib/proxy-health.js with the following exports:

    1. checkProxyHealth(endpoint, timeoutMs = 5000) - Check proxy health endpoint
       - Makes fetch request to ${endpoint}/health
       - Uses AbortSignal.timeout for timeout handling
       - Returns: {
           healthy: boolean,
           status: number,
           latency: number,
           error: string|null,
           models: string[]|null  // from /models endpoint if available
         }
       - On timeout: returns {healthy: false, error: 'Timeout after Xms'}
       - On network error: returns {healthy: false, error: error.message}

    2. verifyModelRouting(endpoint, model) - Verify a specific model is routable
       - Checks if model exists in proxy's /models list
       - Returns: {available: boolean, found: boolean, model: string}

    3. getProxyModels(endpoint) - Fetch available models from proxy
       - Calls ${endpoint}/models
       - Returns array of model IDs or null on error

    4. formatProxyStatus(health) - Format health status for display
       - Returns colored/formatted string: "âœ“ Healthy (45ms)" or "âœ— Unhealthy: error"

    Use node-fetch or native fetch (Node 18+). Handle errors gracefully.
    Follow error handling patterns from bin/lib/errors.js.
  </action>
  <verify>node -e "const ph = require('./bin/lib/proxy-health'); console.log(Object.keys(ph))"</verify>
  <done>Library exports all 4 functions</done>
</task>

<task type="auto">
  <name>Integrate proxy health into caste-models list command</name>
  <files>bin/cli.js</files>
  <action>
    Enhance the `aether caste-models list` command to include proxy health:

    1. Import proxy-health functions:
       ```javascript
       const { checkProxyHealth, formatProxyStatus } = require('./lib/proxy-health');
       ```

    2. Before displaying the table:
       - Read proxy endpoint from model-profiles.yaml (profiles.proxy.endpoint)
       - Call checkProxyHealth(endpoint)
       - Display proxy status line:
         ```
         Proxy: âœ“ Healthy (45ms) @ http://localhost:4000
         ```
         or
         ```
         Proxy: âœ— Unhealthy: Connection refused
         Warning: Using default model (kimi-k2.5) for all castes
         ```

    3. For each caste in the table:
       - Add status indicator based on proxy health
       - If proxy healthy: show âœ“
       - If proxy unhealthy: show âš  (warning)

    4. Add `--verify` flag to list command:
       - When --verify is passed, also check each model is available on proxy
       - Query /models endpoint and verify each assigned model exists
       - Show âœ“ if model available, âœ— if not

    Update the table format to include verification status column:
    ```
    Caste      Model        Provider  Context  Verify  Status
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ”¨ Builder  kimi-k2.5    kimi      256K     âœ“       âœ“
    ```
  </action>
  <verify>node bin/cli.js caste-models list</verify>
  <done>list command shows proxy health status and verification column</done>
</task>

<task type="auto">
  <name>Create /ant:verify-castes slash command</name>
  <files>.claude/commands/ant/verify-castes.md</files>
  <action>
    Create .claude/commands/ant/verify-castes.md for interactive verification:

    ```markdown
    ---
    name: ant:verify-castes
    description: "Verify model routing is working for all castes"
    ---

    You are the **Queen**. Verify that model routing is active and working.

    ### Step 1: Check Proxy Health

    Run: `node bin/cli.js caste-models list`

    Capture the proxy status line. If proxy is unhealthy:
    - Display warning about proxy not running
    - Show instructions to start LiteLLM proxy
    - Continue with verification anyway (will show failures)

    ### Step 2: Verify Each Caste Assignment

    For each caste in [prime, builder, watcher, oracle, scout, chaos, architect, archaeologist, colonizer, route_setter]:

    1. Get assigned model: `bash .aether/aether-utils.sh model-profile get {caste}`
    2. Verify model is not "default" (should be specific model from profiles)
    3. Log result with checkmark or X

    Display results in a table:
    ```
    Caste Verification:
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âœ“ prime: glm-5 (z_ai)
    âœ“ builder: kimi-k2.5 (kimi)
    âœ“ watcher: kimi-k2.5 (kimi)
    ...
    ```

    ### Step 3: Test Spawn Verification (Optional but Recommended)

    If proxy is healthy, spawn a test worker to verify model routing actually works:

    1. Create a temporary test script that:
       - Reports which ANTHROPIC_MODEL it sees
       - Reports ANTHROPIC_BASE_URL
       - Exits successfully

    2. Spawn test worker via Task tool with builder caste

    3. Capture output and verify:
       - Model environment variable is set correctly
       - Base URL points to proxy

    4. Display result:
       ```
       Test Spawn (builder):
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Model: kimi-k2.5 âœ“
       Base URL: http://localhost:4000 âœ“
       ```

    ### Step 4: Summary Report

    Display final verification report:
    ```
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Verification Complete
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Proxy Health: âœ“ Healthy
    Caste Assignments: 10/10 verified
    Test Spawn: âœ“ Working

    Status: All systems operational
    ```

    Or if issues found:
    ```
    Issues Detected:
    - Proxy unhealthy (not running)
    - 3 castes using default model

    Recommendations:
    1. Start LiteLLM proxy: litellm --config proxy.yaml
    2. Run `aether caste-models set <caste>=<model>` for missing assignments
    ```
    ```

    Follow the pattern of other slash commands in .claude/commands/ant/.
    Include clear step-by-step instructions for Claude to execute.
  </action>
  <verify>cat .claude/commands/ant/verify-castes.md | head -5</verify>
  <done>verify-castes.md exists with proper frontmatter and instructions</done>
</task>

</tasks>

<verification>
- `node bin/lib/proxy-health.js` exports all functions and loads without errors
- `aether caste-models list` shows proxy health status
- `aether caste-models list --verify` checks model availability on proxy
- `/ant:verify-castes` command exists and can be invoked
- Proxy health correctly detects running/not running states
</verification>

<success_criteria>
1. proxy-health.js library exists with checkProxyHealth, verifyModelRouting, getProxyModels, formatProxyStatus
2. caste-models list shows proxy health with latency
3. --verify flag checks model availability against proxy
4. verify-castes.md slash command created with full verification flow
5. Health check handles timeouts and connection errors gracefully
6. All proxy health functions have error handling
</success_criteria>

<output>
After completion, create `.planning/phases/09-caste-model-assignment/09-03-SUMMARY.md`
</output>
