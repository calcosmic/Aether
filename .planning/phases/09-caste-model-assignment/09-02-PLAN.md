---
phase: 09-caste-model-assignment
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - bin/cli.js
  - bin/lib/model-profiles.js
autonomous: true
must_haves:
  truths:
    - User can run `aether caste-models list` and see caste-to-model assignments
    - User can run `aether caste-models set <caste>=<model>` to override assignments
    - User can run `aether caste-models reset <caste>` to revert to default
    - Changes persist in model-profiles.yaml user_overrides section
  artifacts:
    - path: bin/cli.js
      provides: "caste-models CLI command with list, set, reset subcommands"
      contains: "caste-models"
    - path: bin/lib/model-profiles.js
      provides: "User override functions"
      exports: ["setModelOverride", "resetModelOverride", "getEffectiveModel"]
  key_links:
    - from: bin/cli.js
      to: bin/lib/model-profiles.js
      via: "require('./lib/model-profiles')"
      pattern: "setModelOverride|resetModelOverride"
    - from: bin/lib/model-profiles.js
      to: .aether/model-profiles.yaml
      via: "fs.writeFileSync with user_overrides"
      pattern: "user_overrides"
---

<objective>
Implement CLI commands for viewing and modifying caste-to-model assignments. Add `aether caste-models list`, `aether caste-models set`, and `aether caste-models reset` commands.

Purpose: Enable users to view current model assignments and override them via CLI, with persistence in the model-profiles.yaml file.
Output: Working CLI commands that read from and write to model-profiles.yaml with user_overrides support.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-caste-model-assignment/09-RESEARCH.md
@.planning/phases/09-caste-model-assignment/09-CONTEXT.md
@.planning/phases/09-caste-model-assignment/09-01-PLAN.md
@/Users/callumcowie/repos/Aether/.aether/model-profiles.yaml
@/Users/callumcowie/repos/Aether/bin/cli.js
@/Users/callumcowie/repos/Aether/bin/lib/model-profiles.js
</context>

<tasks>

<task type="auto">
  <name>Add user override functions to model-profiles.js</name>
  <files>bin/lib/model-profiles.js</files>
  <action>
    Extend bin/lib/model-profiles.js with user override functions:

    1. setModelOverride(repoPath, caste, model) - Sets user override for a caste
       - Validates caste exists in worker_models
       - Validates model exists in model_metadata
       - Reads current YAML, adds/updates user_overrides[caste] = model
       - Writes back with proper YAML formatting
       - Returns {success: true, previous: string|null}
       - Throws ValidationError if caste or model invalid

    2. resetModelOverride(repoPath, caste) - Removes user override for a caste
       - Validates caste exists
       - Reads current YAML, deletes user_overrides[caste] if exists
       - Writes back
       - Returns {success: true, hadOverride: boolean}

    3. getEffectiveModel(profiles, caste) - Returns effective model for caste
       - Checks user_overrides[caste] first
       - Falls back to worker_models[caste]
       - Falls back to 'kimi-k2.5' as final default
       - Returns {model: string, source: 'override'|'default'|'fallback'}

    4. getUserOverrides(profiles) - Returns current user_overrides object

    Follow existing error handling patterns from bin/lib/errors.js.
    Preserve YAML comments and formatting where possible (js-yaml may strip comments, that's acceptable).
  </action>
  <verify>node -e "const mp = require('./bin/lib/model-profiles'); console.log('setModelOverride:', typeof mp.setModelOverride, 'resetModelOverride:', typeof mp.resetModelOverride, 'getEffectiveModel:', typeof mp.getEffectiveModel)"</verify>
  <done>All 4 new functions exported and callable</done>
</task>

<task type="auto">
  <name>Create caste-models CLI command with subcommands</name>
  <files>bin/cli.js</files>
  <action>
    Add the `caste-models` command to bin/cli.js after the verify-models command (around line 1573).

    Structure:
    ```javascript
    const {
      loadModelProfiles,
      getAllAssignments,
      getProviderForModel,
      validateCaste,
      validateModel,
      setModelOverride,
      resetModelOverride,
      getEffectiveModel,
      getUserOverrides
    } = require('./lib/model-profiles');

    // Caste-models parent command
    const casteModelsCmd = program
      .command('caste-models')
      .description('Manage caste-to-model assignments');

    // list subcommand
    casteModelsCmd
      .command('list')
      .description('List current model assignments per caste')
      .action(wrapCommand(async () => {
        const repoPath = process.cwd();
        const profiles = loadModelProfiles(repoPath);

        // Display table with columns: Caste (emoji), Model, Provider, Context Window, Status
        // Include user overrides indicator
        // Show proxy health status
      }));

    // set subcommand
    casteModelsCmd
      .command('set')
      .description('Set model override for a caste')
      .argument('<assignment>', 'caste=model (e.g., builder=glm-5)')
      .action(wrapCommand(async (assignment) => {
        // Parse caste=model format
        // Validate caste and model
        // Call setModelOverride
        // Show success message with previous value if changed
      }));

    // reset subcommand
    casteModelsCmd
      .command('reset')
      .description('Reset caste to default model (remove override)')
      .argument('<caste>', 'caste name (e.g., builder)')
      .action(wrapCommand(async (caste) => {
        // Validate caste
        // Call resetModelOverride
        // Show success message
      }));
    ```

    Table format should match the example from CONTEXT.md:
    ```
    Caste      Model        Provider  Context  Status
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ”¨ Builder  kimi-k2.5    kimi      256K     âœ“
    ```

    Include emojis for castes (builder=ğŸ”¨, watcher=ğŸ‘ï¸, oracle=ğŸ”®, scout=ğŸ”, chaos=ğŸ², prime=ğŸ›ï¸, etc.)
    Show (override) indicator next to models that have user overrides.
  </action>
  <verify>node bin/cli.js caste-models --help</verify>
  <done>caste-models command shows with list, set, reset subcommands</done>
</task>

<task type="auto">
  <name>Create unit tests for override functions</name>
  <files>tests/unit/model-profiles-overrides.test.js</files>
  <action>
    Create unit tests for the override functionality:

    1. setModelOverride tests:
       - Successfully sets override for valid caste/model
       - Throws ValidationError for invalid caste
       - Throws ValidationError for invalid model
       - Returns previous value when updating existing override
       - Creates user_overrides section if not exists

    2. resetModelOverride tests:
       - Successfully removes override
       - Returns hadOverride: false if no override existed
       - Returns hadOverride: true if override was removed
       - Throws ValidationError for invalid caste

    3. getEffectiveModel tests:
       - Returns override model when user_override exists
       - Returns default model when no override
       - Returns fallback when caste not found
       - Correct source field for each case

    4. getUserOverrides tests:
       - Returns empty object when no overrides
       - Returns all overrides when present

    Mock fs for file operations. Use temporary test files.
  </action>
  <verify>npm run test:unit -- tests/unit/model-profiles-overrides.test.js</verify>
  <done>All override tests pass</done>
</task>

</tasks>

<verification>
- `aether caste-models list` displays table with caste assignments
- `aether caste-models set builder=glm-5` sets override and persists to YAML
- `aether caste-models reset builder` removes override from YAML
- User overrides survive between CLI invocations
- Invalid caste/model show helpful error messages with valid options
</verification>

<success_criteria>
1. caste-models CLI command exists with list, set, reset subcommands
2. list shows caste emoji, model, provider, context window, status
3. set validates caste and model before writing
4. set persists to user_overrides section in model-profiles.yaml
5. reset removes from user_overrides section
6. Unit tests cover all override functions
7. Help text explains usage for each subcommand
</success_criteria>

<output>
After completion, create `.planning/phases/09-caste-model-assignment/09-02-SUMMARY.md`
</output>
