---
phase: 05-phase-boundaries
plan: 09
type: execute
wave: 4
depends_on: ["05-02", "05-07"]
files_modified:
  - .claude/commands/ant/focus.md
  - .claude/commands/ant/redirect.md
autonomous: true

must_haves:
  truths:
    - "Emergence occurs within phases (no Queen intervention during EXECUTING state)"
    - "Queen FOCUS/REDIRECT commands blocked during EXECUTING state"
    - "FEEDBACK pheromone allowed during EXECUTING state (Queen can provide feedback without breaking emergence)"
    - "Clear error message shown when Queen intervention blocked"
    - "Queen can only intervene at phase boundaries (VERIFYING state with check-in)"
  artifacts:
    - path: ".claude/commands/ant/focus.md"
      provides: "FOCUS pheromone command with emergence guard"
      contains: "state.*EXECUTING.*blocked"
    - path: ".claude/commands/ant/redirect.md"
      provides: "REDIRECT pheromone command with emergence guard"
      contains: "state.*EXECUTING.*blocked"
  key_links:
    - from: "/ant:focus"
      to: "COLONY_STATE.json"
      via: "Reads colony_status.state before emitting pheromone"
      pattern: "jq -r '.colony_status.state'"
    - from: "/ant:redirect"
      to: "COLONY_STATE.json"
      via: "Reads colony_status.state before emitting pheromone"
      pattern: "jq -r '.colony_status.state'"
    - from: "emergence guard"
      to: "EXECUTING state"
      via: "Blocks FOCUS/REDIRECT during EXECUTING, allows FEEDBACK"
      pattern: "if.*EXECUTING.*blocked"
---

<objective>
Implement emergence guard to prevent Queen intervention during phase execution.

Purpose: Ensure true emergence within phases by blocking Queen FOCUS/REDIRECT commands during EXECUTING state. Queen can only intervene at phase boundaries (VERIFYING state with check-in) or provide FEEDBACK without breaking emergence.

Output: Updated /ant:focus and /ant:redirect commands with emergence guard, clear error messages, FEEDBACK allowed during EXECUTING
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-phase-boundaries/05-RESEARCH.md
@.planning/phases/05-phase-boundaries/05-07-SUMMARY.md
@.claude/commands/ant/focus.md
@.claude/commands/ant/redirect.md
@.claude/commands/ant/feedback.md
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emergence guard to /ant:focus command</name>
  <files>.claude/commands/ant/focus.md</files>
  <action>
Update /ant:focus command to check colony state before emitting pheromone:

**Add emergence guard at the beginning of command (after sourcing dependencies):**

```bash
# Check colony state for emergence guard
COLONY_STATE=".aether/data/COLONY_STATE.json"
if [ -f "$COLONY_STATE" ]; then
    colony_state=$(jq -r '.colony_status.state' "$COLONY_STATE")

    # Block Queen intervention during EXECUTING state (emergence period)
    if [ "$colony_state" = "EXECUTING" ]; then
        echo "⚠️  Colony is EXECUTING - Queen intervention blocked"
        echo ""
        echo "The colony is currently in emergence mode. Worker Ants are working"
        echo "autonomously based on existing pheromone signals."
        echo ""
        echo "Phase boundaries are the only time for direction changes."
        echo ""
        echo "Options:"
        echo "  - Wait for VERIFYING state (phase boundary check-in)"
        echo "  - Use FEEDBACK pheromone: /ant:feedback \"message\" (provides input without breaking emergence)"
        echo "  - Review colony status: /ant:status"
        echo ""
        echo "Current state: EXECUTING"
        exit 1
    fi
fi
```

**Location:** After loading COLONY_STATE, before processing command arguments.

**Behavior:**
- If colony state is EXECUTING, block the FOCUS command
- Display clear error message explaining why blocked
- Suggest alternatives (wait for boundary, use FEEDBACK, review status)
- Exit with error code 1
- If colony state is NOT EXECUTING, proceed with normal FOCUS emission

**Important:** This guard implements Aether's core philosophy - structure at boundaries, pure emergence within. Queen provides signals (pheromones), not commands. During EXECUTING state, Worker Ants work autonomously.

**Note:** The guard should NOT block FEEDBACK pheromone. Queen can provide feedback during execution without breaking emergence. Only FOCUS and REDIRECT are blocked during EXECUTING.
  </action>
  <verify>
```bash
# Test 1: Set colony state to EXECUTING
source .aether/utils/atomic-write.sh
jq '.colony_status.state = "EXECUTING"' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp

# Test 2: Try to emit FOCUS (should be blocked)
if bash .claude/commands/ant/focus.md "test area" 2>&1 | grep -q "Queen intervention blocked"; then
    echo "FOCUS correctly blocked during EXECUTING"
else
    echo "FOCUS should be blocked during EXECUTING"
    exit 1
fi

# Test 3: Set colony state to IDLE
jq '.colony_status.state = "IDLE"' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp

# Test 4: Try to emit FOCUS (should succeed)
if bash .claude/commands/ant/focus.md "test area" 2>&1 | grep -q "Queen intervention blocked"; then
    echo "FOCUS should NOT be blocked during IDLE"
    exit 1
else
    echo "FOCUS correctly allowed during IDLE"
fi

echo "All emergence guard tests for /ant:focus passed"
```
  </verify>
  <done>
/ant:focus blocked during EXECUTING state, allowed during other states, clear error message shown with alternatives
  </done>
</task>

<task type="auto">
  <name>Task 2: Add emergence guard to /ant:redirect command</name>
  <files>.claude/commands/ant/redirect.md</files>
  <action>
Update /ant:redirect command to check colony state before emitting pheromone:

**Add emergence guard at the beginning of command (after sourcing dependencies):**

```bash
# Check colony state for emergence guard
COLONY_STATE=".aether/data/COLONY_STATE.json"
if [ -f "$COLONY_STATE" ]; then
    colony_state=$(jq -r '.colony_status.state' "$COLONY_STATE")

    # Block Queen intervention during EXECUTING state (emergence period)
    if [ "$colony_state" = "EXECUTING" ]; then
        echo "⚠️  Colony is EXECUTING - Queen intervention blocked"
        echo ""
        echo "The colony is currently in emergence mode. Worker Ants are working"
        echo "autonomously based on existing pheromone signals."
        echo ""
        echo "Phase boundaries are the only time for direction changes."
        echo ""
        echo "Options:"
        echo "  - Wait for VERIFYING state (phase boundary check-in)"
        echo "  - Use FEEDBACK pheromone: /ant:feedback \"message\" (provides input without breaking emergence)"
        echo "  - Review colony status: /ant:status"
        echo ""
        echo "Current state: EXECUTING"
        exit 1
    fi
fi
```

**Location:** After loading COLONY_STATE, before processing command arguments.

**Behavior:** Same as /ant:focus guard - block during EXECUTING, allow otherwise, show alternatives.

**Important:** Apply the same guard logic as /ant:focus. Consistency is key - both FOCUS and REDIRECT are direction-changing commands that break emergence if used mid-phase.
  </action>
  <verify>
```bash
# Test 1: Set colony state to EXECUTING
source .aether/utils/atomic-write.sh
jq '.colony_status.state = "EXECUTING"' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp

# Test 2: Try to emit REDIRECT (should be blocked)
if bash .claude/commands/ant/redirect.md "test pattern" 2>&1 | grep -q "Queen intervention blocked"; then
    echo "REDIRECT correctly blocked during EXECUTING"
else
    echo "REDIRECT should be blocked during EXECUTING"
    exit 1
fi

# Test 3: Set colony state to IDLE
jq '.colony_status.state = "IDLE"' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp

# Test 4: Try to emit REDIRECT (should succeed)
if bash .claude/commands/ant/redirect.md "test pattern" 2>&1 | grep -q "Queen intervention blocked"; then
    echo "REDIRECT should NOT be blocked during IDLE"
    exit 1
else
    echo "REDIRECT correctly allowed during IDLE"
fi

echo "All emergence guard tests for /ant:redirect passed"
```
  </verify>
  <done>
/ant:redirect blocked during EXECUTING state, allowed during other states, clear error message shown with alternatives
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify FEEDBACK pheromone allowed during EXECUTING</name>
  <files>.claude/commands/ant/feedback.md</files>
  <action>
Verify that /ant:feedback command does NOT have emergence guard:

**Check /ant:feedback.md structure:**
- Should NOT have colony state check
- Should allow FEEDBACK emission during EXECUTING state
- Queen can provide feedback without breaking emergence

**Why FEEDBACK is allowed:**
- FEEDBACK is informational, not directional
- Worker Ants can choose to respond to FEEDBACK or ignore it
- FEEDBACK doesn't break emergence - it's part of the learning loop
- FOCUS and REDIRECT are directional commands that override autonomy

**Action:** Verify /ant:feedback.md does NOT have emergence guard. If it does, remove it.

**Expected behavior:**
- /ant:feedback works during EXECUTING state
- /ant:feedback works during all states
- FEEDBACK pheromone has 6-hour decay (from Phase 3)
- FEEDBACK is non-blocking - Worker Ants decide how to respond

**If guard exists, remove it:**
```bash
# Remove this section if it exists:
# if [ "$colony_state" = "EXECUTING" ]; then
#     echo "Blocked..."
#     exit 1
# fi
```

**Verification:** Run /ant:feedback during EXECUTING state and confirm it works.
  </action>
  <verify>
```bash
# Test 1: Set colony state to EXECUTING
source .aether/utils/atomic-write.sh
jq '.colony_status.state = "EXECUTING"' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp

# Test 2: Try to emit FEEDBACK (should succeed)
if bash .claude/commands/ant/feedback.md "Good progress" 2>&1 | grep -q "Queen intervention blocked"; then
    echo "FEEDBACK should NOT be blocked during EXECUTING"
    exit 1
else
    echo "FEEDBACK correctly allowed during EXECUTING"
fi

# Test 3: Verify FEEDBACK pheromone created
feedback_count=$(jq -r '.active_pheromones | map(select(.type == "FEEDBACK")) | length' .aether/data/pheromones.json)
if [ "$feedback_count" -ge 1 ]; then
    echo "FEEDBACK pheromone created successfully"
else
    echo "FEEDBACK pheromone not created"
    exit 1
fi

echo "All FEEDBACK allowance tests passed"
```
  </verify>
  <done>
/ant:feedback works during EXECUTING state, no emergence guard, FEEDBACK is informational not directional
  </done>
</task>

</tasks>

<verification>
1. /ant:focus blocked during EXECUTING state
2. /ant:focus shows clear error message with alternatives
3. /ant:focus allowed during IDLE, INIT, PLANNING, VERIFYING, COMPLETED, FAILED states
4. /ant:redirect blocked during EXECUTING state
5. /ant:redirect shows clear error message with alternatives
6. /ant:redirect allowed during non-EXECUTING states
7. /ant:feedback allowed during EXECUTING state (no guard)
8. /ant:feedback allowed during all states
9. Error message explains why blocked (emergence mode)
10. Error message suggests alternatives (wait for boundary, use FEEDBACK, review status)
11. Emergence philosophy implemented: structure at boundaries, emergence within
</verification>

<success_criteria>
1. Emergence guard prevents Queen intervention during EXECUTING state
2. FOCUS and REDIRECT blocked mid-phase (during execution)
3. FEEDBACK allowed during EXECUTING (non-directional, doesn't break emergence)
4. Clear error messages explain why intervention blocked
5. Alternatives provided to Queen (wait, use FEEDBACK, review status)
6. Queen can only intervene at phase boundaries (VERIFYING check-in)
7. Emergence within phases maintained (Worker Ants work autonomously)
8. Aether philosophy enforced: structure at boundaries, pure emergence within
</success_criteria>

<output>
After completion, create `.planning/phases/05-phase-boundaries/05-09-SUMMARY.md` with:
- Emergence guard implementation verified
- FOCUS/REDIRECT blocking tested
- FEEDBACK allowance confirmed
- Aether philosophy enforcement documented
- Files modified
</output>
