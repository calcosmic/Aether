---
phase: 05-phase-boundaries
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - .aether/utils/checkpoint.sh
  - .aether/data/checkpoint.json
  - .aether/data/checkpoints/
autonomous: true

must_haves:
  truths:
    - "Checkpoint saved before each state transition (pre-transition checkpoint)"
    - "Checkpoint saved after each state transition (post-transition checkpoint)"
    - "Checkpoint contains complete colony state (COLONY_STATE, pheromones, worker_ants, memory)"
    - "Checkpoint files stored in .aether/data/checkpoints/ with rotation (max 10)"
    - "Latest checkpoint reference stored in .aether/data/checkpoint.json"
  artifacts:
    - path: ".aether/utils/checkpoint.sh"
      provides: "Checkpoint save/load/verify functions"
      exports: ["save_checkpoint", "load_checkpoint", "list_checkpoints", "rotate_checkpoints"]
      min_lines: 120
    - path: ".aether/data/checkpoint.json"
      provides: "Reference to latest checkpoint"
      contains: "checkpoint_id"
    - path: ".aether/data/checkpoints/"
      provides: "Checkpoint archive directory"
  key_links:
    - from: "save_checkpoint()"
      to: ".aether/data/checkpoints/"
      via: "Atomic write using atomic_write_from_file"
      pattern: "atomic_write_from_file.*checkpoint_.*.json"
    - from: "transition_state()"
      to: "save_checkpoint()"
      via: "Called before and after state transition"
      pattern: "save_checkpoint.*pre_.*post_"
---

<objective>
Implement checkpoint system with pre/post-transition saves, archive rotation, and recovery capability.

Purpose: Enable colony to recover from crashes by saving complete colony state before and after each state transition. Checkpoints provide rollback capability and crash recovery.

Output: checkpoint.sh utility with save/load/rotate functions, checkpoint.json reference file, checkpoints/ archive directory
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-phase-boundaries/05-RESEARCH.md
@.planning/phases/05-phase-boundaries/05-02-SUMMARY.md
@.aether/data/COLONY_STATE.json
@.aether/utils/state-machine.sh
@.aether/utils/atomic-write.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create checkpoint.sh utility with save_checkpoint() function</name>
  <files>.aether/utils/checkpoint.sh</files>
  <action>
Create checkpoint.sh with the following functions:

**Constants at top:**
```bash
CHECKPOINT_DIR=".aether/data/checkpoints"
CHECKPOINT_FILE=".aether/data/checkpoint.json"
COLONY_STATE=".aether/data/COLONY_STATE.json"
PHEROMONES_FILE=".aether/data/pheromones.json"
WORKER_ANTS_FILE=".aether/data/worker_ants.json"
MEMORY_FILE=".aether/data/memory.json"
```

**save_checkpoint() function:**

1. **Args:** label (e.g., "pre_IDLE_to_INIT")

2. **Create checkpoint directory** if not exists:
   ```bash
   mkdir -p "$CHECKPOINT_DIR"
   ```

3. **Generate checkpoint metadata:**
   - timestamp: `date -u +"%Y-%m-%dT%H:%M:%SZ"`
   - checkpoint_num: `get_next_checkpoint_number()` (read from COLONY_STATE.checkpoints.checkpoint_count)
   - checkpoint_file: "checkpoint_${checkpoint_num}.json"

4. **Capture complete colony state** using jq:
   ```bash
   jq --arg label "$label" \
      --arg timestamp "$timestamp" \
      --arg num "$checkpoint_num" \
      '{
        "checkpoint_id": $num,
        "label": $label,
        "timestamp": $timestamp,
        "colony_state": .,
        "pheromones": input,
        "worker_ants": input,
        "memory": input
      }' \
      "$COLONY_STATE" \
      "$PHEROMONES_FILE" \
      "$WORKER_ANTS_FILE" \
      "$MEMORY_FILE" > /tmp/checkpoint.tmp
   ```

5. **Validate JSON integrity:**
   ```bash
   if ! python3 -c "import json; json.load(open('/tmp/checkpoint.tmp'))" 2>/dev/null; then
       echo "Checkpoint validation failed"
       rm -f /tmp/checkpoint.tmp
       return 1
   fi
   ```

6. **Atomic write to checkpoint archive:**
   ```bash
   checkpoint_path="${CHECKPOINT_DIR}/${checkpoint_file}"
   atomic_write_from_file "$checkpoint_path" /tmp/checkpoint.tmp
   rm -f /tmp/checkpoint.tmp
   ```

7. **Update latest checkpoint reference:**
   ```bash
   atomic_write_from_file "$CHECKPOINT_FILE" "$checkpoint_path"
   ```

8. **Update checkpoint count in COLONY_STATE:**
   ```bash
   jq '.checkpoints.latest_checkpoint = $checkpoint | .checkpoints.checkpoint_count += 1' \
      --arg checkpoint "$checkpoint_file" \
      "$COLONY_STATE" > /tmp/state.tmp
   atomic_write_from_file "$COLONY_STATE" /tmp/state.tmp
   rm -f /tmp/state.tmp
   ```

9. **Rotate old checkpoints** (keep last 10) - see rotate_checkpoints() below

10. **Echo confirmation:**
    ```bash
    echo "Checkpoint saved: $checkpoint_path"
    echo "Label: $label"
    ```

**rotate_checkpoints() function:**
```bash
rotate_checkpoints() {
    # Keep only 10 most recent checkpoints
    ls -t "$CHECKPOINT_DIR"/checkpoint_*.json 2>/dev/null | \
        tail -n +11 | \
        xargs rm -f
}
```

**list_checkpoints() function:**
```bash
list_checkpoints() {
    echo "Available checkpoints:"
    echo ""
    ls -lh "$CHECKPOINT_DIR"/checkpoint_*.json 2>/dev/null | \
        awk '{print $9, $5, $6, $7, $8}' | \
        while read -r file size date time; do
            local id=$(basename "$file" .json | sed 's/checkpoint_//')
            local label=$(jq -r '.label' "$file" 2>/dev/null || echo "unknown")
            echo "  [$id] $size $date $time - $label"
        done
}
```

**Source dependencies:** atomic-write.sh at top of file
**Export all functions:** export -f save_checkpoint rotate_checkpoints list_checkpoints
  </action>
  <verify>
```bash
# Source dependencies
source .aether/utils/atomic-write.sh
source .aether/utils/checkpoint.sh

# Test 1: Save checkpoint
save_checkpoint "test_checkpoint" || { echo "save_checkpoint failed"; exit 1; }

# Test 2: Checkpoint file exists
[ -f ".aether/data/checkpoint.json" ] || { echo "checkpoint.json not created"; exit 1; }

# Test 3: Checkpoint archive exists
checkpoint_file=$(cat .aether/data/checkpoint.json)
[ -f "$checkpoint_file" ] || { echo "Checkpoint archive not found: $checkpoint_file"; exit 1; }

# Test 4: Checkpoint has valid JSON
python3 -c "import json; json.load(open('$checkpoint_file'))" || { echo "Checkpoint invalid JSON"; exit 1; }

# Test 5: Checkpoint has required fields
checkpoint_id=$(jq -r '.checkpoint_id' "$checkpoint_file")
label=$(jq -r '.label' "$checkpoint_file")
timestamp=$(jq -r '.timestamp' "$checkpoint_file")
[ -n "$checkpoint_id" ] && [ -n "$label" ] && [ -n "$timestamp" ] || { echo "Missing checkpoint fields"; exit 1; }

# Test 6: Checkpoint count incremented
count=$(jq -r '.checkpoints.checkpoint_count' .aether/data/COLONY_STATE.json)
[ "$count" -ge 1 ] || { echo "Checkpoint count not incremented"; exit 1; }

# Test 7: List checkpoints works
list_checkpoints | grep -q "Available checkpoints" || { echo "list_checkpoints failed"; exit 1; }

echo "All checkpoint tests passed"
```
  </verify>
  <done>
save_checkpoint() creates valid checkpoint files with complete colony state, stores in archive, updates reference file, rotates old checkpoints
  </done>
</task>

</tasks>

<verification>
1. save_checkpoint "test_label" creates checkpoint file
2. Checkpoint file has checkpoint_id, label, timestamp fields
3. Checkpoint contains colony_state, pheromones, worker_ants, memory
4. checkpoint.json points to latest checkpoint
5. Checkpoint count increments in COLONY_STATE.json
6. JSON is valid (python3 verification)
7. rotate_checkpoints keeps only 10 most recent
8. list_checkpoints displays all available checkpoints
</verification>

<success_criteria>
1. checkpoint.sh exists with 3 exported functions
2. save_checkpoint() captures complete colony state
3. Checkpoint files stored in .aether/data/checkpoints/
4. Latest checkpoint reference in .aether/data/checkpoint.json
5. Checkpoint rotation limits to 10 files
6. All checkpoints have valid JSON structure
</success_criteria>

<output>
After completion, create `.planning/phases/05-phase-boundaries/05-03-SUMMARY.md` with:
- save_checkpoint() implementation verified
- Checkpoint structure documented
- Rotation behavior tested
- Files created/modified
</output>
