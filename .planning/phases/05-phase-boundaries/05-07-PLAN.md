---
phase: 05-phase-boundaries
plan: 07
type: execute
wave: 3
depends_on: ["05-02", "05-04"]
files_modified:
  - .aether/utils/state-machine.sh
  - .claude/commands/ant/phase.md
  - .aether/data/pheromones.json
autonomous: true

must_haves:
  truths:
    - "At phase boundaries (EXECUTING ‚Üí VERIFYING), Queen check-in occurs"
    - "CHECKIN pheromone emitted when phase boundary detected"
    - "Colony pauses in VERIFYING state awaiting Queen decision"
    - "Queen can review phase via /ant:phase command"
    - "Queen has options: /ant:continue, /ant:adjust, /ant:retry"
  artifacts:
    - path: ".aether/utils/state-machine.sh"
      provides: "check_phase_boundary() and emit_checkin_pheromone() functions"
      exports: ["check_phase_boundary", "emit_checkin_pheromone"]
      contains: "check_phase_boundary()|emit_checkin_pheromone()"
    - path: ".aether/data/pheromones.json"
      provides: "CHECKIN pheromone type for Queen notification"
      contains: "CHECKIN"
    - path: ".claude/commands/ant/phase.md"
      provides: "Enhanced phase command with check-in status"
  key_links:
    - from: "check_phase_boundary()"
      to: "emit_checkin_pheromone()"
      via: "Emits CHECKIN pheromone at phase boundary"
      pattern: "emit_checkin_pheromone.*\$current_phase"
    - from: "emit_checkin_pheromone()"
      to: ".aether/data/pheromones.json"
      via: "Adds CHECKIN pheromone to active_pheromones array"
      pattern: "active_pheromones += \[\{.*type.*CHECKIN.*\}\]"
    - from: "/ant:phase"
      to: "COLONY_STATE.json"
      via: "Reads queen_checkin status and displays check-in indicator"
      pattern: "queen_checkin.status.*awaiting_review"
---

<objective>
Implement phase boundary Queen check-in with CHECKIN pheromone and colony pause.

Purpose: At phase boundaries (EXECUTING ‚Üí VERIFYING transition), colony pauses and emits CHECKIN pheromone to notify Queen for review. Queen can review phase results and decide to continue, adjust, or retry.

Output: check_phase_boundary() function, emit_checkin_pheromone() function, enhanced /ant:phase command with check-in status
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-phase-boundaries/05-RESEARCH.md
@.planning/phases/05-phase-boundaries/05-02-SUMMARY.md
@.claude/commands/ant/phase.md
@.aether/utils/state-machine.sh
@.aether/utils/atomic-write.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emit_checkin_pheromone() to state-machine.sh</name>
  <files>.aether/utils/state-machine.sh</files>
  <action>
Add emit_checkin_pheromone() function to state-machine.sh:

**Function signature:**
```bash
emit_checkin_pheromone() {
    local phase="$1"
    # ... implementation
}
```

**Implementation:**

1. **Generate CHECKIN pheromone metadata:**
   ```bash
   local pheromone_id="checkin_$(date +%s)"
   local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
   local pheromones_file=".aether/data/pheromones.json"
   ```

2. **Add CHECKIN pheromone to pheromones.json:**
   ```bash
   jq --arg id "$pheromone_id" \
      --arg phase "$phase" \
      --arg timestamp "$timestamp" \
      --arg context "Phase boundary - awaiting Queen review" \
      '.active_pheromones += [{
        "id": $id,
        "type": "CHECKIN",
        "strength": 1.0,
        "created_at": $timestamp,
        "decay_rate": null,
        "metadata": {
          "source": "colony",
          "phase": $phase,
          "context": $context
        }
      }]' "$pheromones_file" > /tmp/pheromones.tmp
   ```

3. **Atomic write:**
   ```bash
   atomic_write_from_file "$pheromones_file" /tmp/pheromones.tmp
   rm -f /tmp/pheromones.tmp
   ```

4. **Echo confirmation:**
   ```bash
   echo "CHECKIN pheromone emitted for phase $phase"
   ```

**Important:**
- CHECKIN pheromone has decay_rate: null (persists until Queen decision)
- strength: 1.0 (maximum priority for Queen attention)
- Export function: export -f emit_checkin_pheromone
  </action>
  <verify>
```bash
# Source dependencies
source .aether/utils/atomic-write.sh
source .aether/utils/state-machine.sh

# Test 1: Emit CHECKIN pheromone
emit_checkin_pheromone "5" || { echo "emit_checkin_pheromone failed"; exit 1; }

# Test 2: Verify CHECKIN pheromone exists
checkin_count=$(jq -r '.active_pheromones | map(select(.type == "CHECKIN")) | length' .aether/data/pheromones.json)
[ "$checkin_count" -ge 1 ] || { echo "CHECKIN pheromone not found"; exit 1; }

# Test 3: Verify CHECKIN pheromone has correct fields
last_checkin=$(jq -r '.active_pheromones[] | select(.type == "CHECKIN") | last' .aether/data/pheromones.json)
echo "$last_checkin" | jq -e '.type == "CHECKIN"' >/dev/null || { echo "Wrong type"; exit 1; }
echo "$last_checkin" | jq -e '.decay_rate == null' >/dev/null || { echo "CHECKIN should not decay"; exit 1; }
echo "$last_checkin" | jq -e '.metadata.phase == "5"' >/dev/null || { echo "Phase not recorded"; exit 1; }

echo "All emit_checkin_pheromone tests passed"
```
  </verify>
  <done>
emit_checkin_pheromone() creates CHECKIN pheromone with null decay (persists until Queen decision), includes phase and context metadata
  </done>
</task>

<task type="auto">
  <name>Task 2: Add check_phase_boundary() to state-machine.sh</name>
  <files>.aether/utils/state-machine.sh</files>
  <action>
Add check_phase_boundary() function to state-machine.sh:

**Function signature:**
```bash
check_phase_boundary() {
    # ... implementation
}
```

**Implementation:**

1. **Read current state and phase:**
   ```bash
   local current_state=$(jq -r '.colony_status.state' "$COLONY_STATE")
   local current_phase=$(jq -r '.colony_status.current_phase' "$COLONY_STATE")
   ```

2. **Check if phase boundary condition met:**
   - Phase boundary = EXECUTING ‚Üí VERIFYING transition
   - Trigger: All phase tasks complete

   ```bash
   if [ "$current_state" = "EXECUTING" ]; then
       # Check if phase tasks are complete
       # For now, assume phase boundary is triggered manually or by pheromone
       # In full implementation, this would check phase.task_status

       # For Phase 5, we'll trigger on transition to VERIFYING state
       # The actual trigger will be in Worker Ant logic (later phases)
       return 1  # Not at boundary
   fi
   ```

3. **If at boundary, emit CHECKIN pheromone:**
   ```bash
   if phase_tasks_complete; then
       # Emit CHECKIN pheromone
       emit_checkin_pheromone "$current_phase"

       # Transition to VERIFYING state
       transition_state "VERIFYING" "phase_boundary_checkin"

       # Pause for Queen review
       await_queen_decision "$current_phase"
   fi
   ```

4. **await_queen_decision() helper:**
   ```bash
   await_queen_decision() {
       local phase="$1"
       local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

       # Set queen_checkin status
       jq --arg phase "$phase" \
          --arg timestamp "$timestamp" \
          '.colony_status.queen_checkin = {
            "phase": $phase,
            "status": "awaiting_review",
            "timestamp": $timestamp,
            "queen_decision": null
          }' "$COLONY_STATE" > /tmp/state.tmp

       atomic_write_from_file "$COLONY_STATE" /tmp/state.tmp
       rm -f /tmp/state.tmp

       # Display check-in message
       echo ""
       echo "üêú COLONY CHECK-IN: Phase $phase complete"
       echo "   Review with: /ant:phase $phase"
       echo "   Options: /ant:continue, /ant:adjust, /ant:retry"
       echo ""
   }
   ```

**Important:** For Phase 5, check_phase_boundary() is a placeholder. Actual phase boundary detection will be implemented in Phase 6+ when Worker Ants execute phases. For now, the function provides the structure for Queen check-ins.

**Export functions:** export -f check_phase_boundary await_queen_decision
  </action>
  <verify>
```bash
# Source dependencies
source .aether/utils/atomic-write.sh
source .aether/utils/state-machine.sh

# Test 1: Function exists
type check_phase_boundary >/dev/null 2>&1 || { echo "check_phase_boundary not found"; exit 1; }
type await_queen_decision >/dev/null 2>&1 || { echo "await_queen_decision not found"; exit 1; }

# Test 2: await_queen_decision sets queen_checkin status
await_queen_decision "5" || { echo "await_queen_decision failed"; exit 1; }

# Test 3: Verify queen_checkin status set
checkin_status=$(jq -r '.colony_status.queen_checkin.status' .aether/data/COLONY_STATE.json)
[ "$checkin_status" = "awaiting_review" ] || { echo "Status not set: $checkin_status"; exit 1; }

# Test 4: Verify phase recorded
checkin_phase=$(jq -r '.colony_status.queen_checkin.phase' .aether/data/COLONY_STATE.json)
[ "$checkin_phase" = "5" ] || { echo "Phase not recorded: $checkin_phase"; exit 1; }

echo "All check_phase_boundary tests passed"
```
  </verify>
  <done>
check_phase_boundary() detects EXECUTING‚ÜíVERIFYING transition, emits CHECKIN pheromone, updates queen_checkin status, displays Queen options
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance /ant:phase command with check-in status</name>
  <files>.claude/commands/ant/phase.md</files>
  <action>
Update /ant:phase command to display check-in status when colony is paused:

**Add check-in status display after phase details:**

```bash
# After showing phase name, goal, caste, tasks...

# Check for Queen check-in
checkin_status=$(jq -r '.colony_status.queen_checkin.status // "none"' "$COLONY_STATE")

if [ "$checkin_status" = "awaiting_review" ]; then
    echo ""
    echo "‚ö†Ô∏è  QUEEN CHECK-IN REQUIRED"
    echo ""
    echo "Colony is paused at phase boundary, awaiting your review."
    echo ""
    echo "Options:"
    echo "  /ant:continue     - Approve and continue to next phase"
    echo "  /ant:adjust       - Adjust pheromones before continuing"
    echo "  /ant:retry [phase] - Retry this phase with different approach"
    echo ""

    # Show phase summary
    checkin_phase=$(jq -r '.colony_status.queen_checkin.phase' "$COLONY_STATE")
    echo "Phase Summary:"
    echo "  Phase: $checkin_phase"

    # Show tasks completed (if available)
    task_count=$(jq -r ".phases.roadmap[$checkin_phase-1].tasks | length" "$COLONY_STATE")
    if [ "$task_count" != "null" ] && [ "$task_count" -gt 0 ]; then
        echo "  Tasks completed: $task_count"
    fi

    # Show state history
    transitions=$(jq -r '.state_machine.transitions_count' "$COLONY_STATE")
    echo "  State transitions: $transitions"

    # Show latest checkpoint
    latest_checkpoint=$(jq -r '.checkpoints.latest_checkpoint' "$COLONY_STATE")
    if [ "$latest_checkpoint" != "null" ]; then
        echo "  Latest checkpoint: $latest_checkpoint"
    fi
fi
```

**Important:** Only show check-in status when queen_checkin.status is "awaiting_review". Normal phase display should not include check-in section.

**Error handling:** Handle cases where phase may not exist (null checks):
```bash
if [ "$checkin_phase" != "null" ]; then
    # Display phase-specific info
fi
```
  </action>
  <verify>
```bash
# Test 1: Set queen_checkin status
source .aether/utils/atomic-write.sh
source .aether/utils/state-machine.sh
await_queen_decision "5"

# Test 2: Run /ant:phase command
bash .claude/commands/ant/phase.md 5 2>&1 | grep -q "QUEEN CHECK-IN REQUIRED" || { echo "Check-in status not shown"; exit 1; }

# Test 3: Verify options displayed
bash .claude/commands/ant/phase.md 5 2>&1 | grep -q "/ant:continue" || { echo "Options not shown"; exit 1; }

# Test 4: Clear queen_checkin status and verify no check-in shown
jq '.colony_status.queen_checkin = null' .aether/data/COLONY_STATE.json > /tmp/state.tmp
atomic_write_from_file .aether/data/COLONY_STATE.json /tmp/state.tmp
bash .claude/commands/ant/phase.md 5 2>&1 | grep -q "QUEEN CHECK-IN REQUIRED" && { echo "Check-in shown when shouldn't be"; exit 1; }

echo "All /ant:phase check-in status tests passed"
```
  </verify>
  <done>
/ant:phase displays check-in status when queen_checkin.status is "awaiting_review", shows phase summary and Queen options, normal display without check-in when not paused
  </done>
</task>

</tasks>

<verification>
1. emit_checkin_pheromone() creates CHECKIN pheromone in pheromones.json
2. CHECKIN pheromone has decay_rate: null (persists indefinitely)
3. CHECKIN pheromone includes phase and context metadata
4. check_phase_boundary() function exists and is callable
5. await_queen_decision() sets queen_checkin.status to "awaiting_review"
6. queen_checkin recorded in COLONY_STATE.json with phase, status, timestamp
7. /ant:phase displays "QUEEN CHECK-IN REQUIRED" when status is "awaiting_review"
8. /ant:phase shows options: /ant:continue, /ant:adjust, /ant:retry
9. /ant:phase shows phase summary (tasks, transitions, checkpoint)
</verification>

<success_criteria>
1. CHECKIN pheromone type exists in pheromone system
2. Phase boundary detection emits CHECKIN pheromone
3. Colony pauses at phase boundaries (VERIFYING state)
4. Queen check-in status tracked in colony state
5. /ant:phase shows check-in status and options
6. Queen has clear next steps (continue, adjust, retry)
7. Check-in mechanism follows Aether philosophy (Queen at boundaries only)
</success_criteria>

<output>
After completion, create `.planning/phases/05-phase-boundaries/05-07-SUMMARY.md` with:
- CHECKIN pheromone implementation verified
- Phase boundary detection tested
- Queen check-in workflow documented
- Files modified
</output>
