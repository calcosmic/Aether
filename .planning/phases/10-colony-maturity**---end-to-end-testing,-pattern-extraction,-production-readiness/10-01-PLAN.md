---
phase: 10-colony-maturity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/integration/full-workflow.test.sh
  - .planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/colony-setup.sh
  - .planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/cleanup.sh
  - .planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/test-orchestrator.sh
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Queen can run full workflow from init to completion"
    - "INIT pheromone triggers Worker Ant spawning"
    - "Colony progresses through phases autonomously"
    - "Colony completes goal and reaches COMPLETED state"
    - "Test fails with clear diagnostic if workflow breaks"
    - "State is isolated between test runs (no leakage)"
  artifacts:
    - path: ".planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/colony-setup.sh"
      provides: "Test colony initialization helper"
      min_lines: 30
    - path: ".planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/cleanup.sh"
      provides: "State cleanup between tests"
      contains: "git clean"
    - path: ".planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/integration/full-workflow.test.sh"
      provides: "End-to-end workflow test"
      exports: ["test_full_workflow"]
    - path: ".planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/test-orchestrator.sh"
      provides: "Master test runner"
      contains: "#!/bin/bash"
  key_links:
    - from: "full-workflow.test.sh"
      to: "colony-setup.sh"
      via: "source"
      pattern: "source.*colony-setup"
    - from: "full-workflow.test.sh"
      to: "cleanup.sh"
      via: "source"
      pattern: "source.*cleanup"
    - from: "test-orchestrator.sh"
      to: "full-workflow.test.sh"
      via: "bash execution"
      pattern: "bash.*full-workflow"
    - from: "full-workflow.test.sh"
      to: ".aether/COLONY_STATE.json"
      via: "jq queries"
      pattern: "jq.*COLONY_STATE"
---

<objective>
End-to-end integration test that validates Queen can provide intention and colony self-organizes through complete workflow

Purpose: This is the critical path test - if full workflow doesn't work, nothing else matters. Top-down approach: test the complete colony emergence first, then break down into component tests if it fails.

Output: Working test suite that verifies colony completes goals from init to completion with clean state isolation
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/10-RESEARCH.md
@.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/10-CONTEXT.md
@.aether/COLONY_STATE.json
@.aether/state-machine.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test infrastructure helpers</name>
  <files>.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/colony-setup.sh, .planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/helpers/cleanup.sh</files>
  <action>
Create test helper scripts in tests/helpers/ directory:

**colony-setup.sh:**
- `setup_test_colony(goal_string)` function that initializes a test colony
- Uses existing colony state infrastructure (.aether/COLONY_STATE.json)
- Creates minimal colony state with goal, IDLE status, empty workers array
- Returns colony path for test access
- Make executable: chmod +x

**cleanup.sh:**
- `cleanup_test_colony()` function that resets state between tests
- Runs `git clean -fd .aether/data` to remove all state files
- Runs `rm -rf .aether/backups/* .aether/checkpoints/*`
- Runs `rm -f .aether/data/*.json`
- Verify clean slate: check .aether/data is empty
- Make executable: chmod +x

Both scripts must:
- Use git root detection for path resolution
- Handle missing directories gracefully
- Output TAP-style diagnostic messages
- Return 0 on success, non-zero on failure
  </action>
  <verify>Run `. tests/helpers/colony-setup.sh && setup_test_colony "test goal"` and verify colony state created; then run `. tests/helpers/cleanup.sh && cleanup_test_colony` and verify .aether/data empty</verify>
  <done>Test helpers can create and reset colony state reliably</done>
</task>

<task type="auto">
  <name>Task 2: Create full workflow integration test</name>
  <files>.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/integration/full-workflow.test.sh</files>
  <action>
Create TAP-style integration test in tests/integration/:

**full-workflow.test.sh structure:**
```bash
#!/bin/bash
# TAP test for full colony workflow

set -e

source ../helpers/colony-setup.sh
source ../helpers/cleanup.sh

echo "1..5"  # Plan 5 assertions

# Test 1: Colony initialization
echo "ok 1 - Colony initialized with goal"

# Test 2: INIT pheromone emitted
echo "ok 2 - INIT pheromone present"

# Test 3: Workers spawned
echo "ok 3 - Worker Ants spawned autonomously"

# Test 4: Phase progression
echo "ok 4 - Colony progressed through phases"

# Test 5: Goal completion
echo "ok 5 - Colony reached COMPLETED state"
```

Implementation requirements:
- Use jq to query COLONY_STATE.json for assertions
- Use pheromones.json to verify INIT signal
- Check worker_ants.json for spawned workers
- Verify state_machine.state_history shows progression
- Each assertion outputs TAP "ok" or "not ok" with diagnostic
- Return non-zero if any assertion fails
- Include cleanup in test.afterEach equivalent (trap cleanup EXIT)

Test scenario:
- Initialize colony with goal "Build REST API"
- Verify INIT pheromone created
- Verify Workers spawn (colonizer, route-setter, builder)
- Simulate phase progression (state transitions)
- Verify final state is COMPLETED
  </action>
  <verify>Run `bash tests/integration/full-workflow.test.sh` and verify TAP output with 5 ok assertions</verify>
  <done>Integration test passes all 5 assertions validating complete workflow</done>
</task>

<task type="auto">
  <name>Task 3: Create test orchestrator</name>
  <files>.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/tests/test-orchestrator.sh</files>
  <action>
Create master test runner that provides unified entry point:

**test-orchestrator.sh features:**
- `--all` flag: runs all tests in sequence
- `--integration` flag: runs only integration tests
- `--verbose` flag: detailed TAP output with diagnostics
- `--clean` flag: force cleanup before run
- Test discovery: find all .test.sh files recursively
- Summary output: total tests, passed, failed, duration
- Colored output: green for pass, red for fail
- Exit code: 0 if all pass, 1 if any fail

Usage:
```bash
bash tests/test-orchestrator.sh --all --verbose
```

Implementation:
- Use find to locate test files
- Run each test with bash -e for strict mode
- Capture exit codes and duration via time builtin
- Aggregate results with counters
- Output TAP summary at end
- Make executable: chmod +x

Include diagnostic hints if tests fail:
- "Run with --verbose for detailed output"
- "Check .aether/data for state dumps"
- "Review test logs in tests/logs/"
  </action>
  <verify>Run `bash tests/test-orchestrator.sh --all` and verify it discovers and runs full-workflow.test.sh with summary output</verify>
  <done>Master orchestrator can run all tests and report results</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete end-to-end test infrastructure with helpers, integration test, and orchestrator</what-built>
  <how-to-verify>
1. Run full test suite: `bash tests/test-orchestrator.sh --all --verbose`
2. Verify TAP output shows 5 tests passed
3. Check state isolation: run tests twice, second run should also pass (no state leakage)
4. Verify failure diagnostics: break a test intentionally and verify clear error message
5. Test cleanup: after test run, verify .aether/data is clean (except for test artifacts)

Expected output:
```
TAP version 13
1..5
ok 1 - Colony initialized with goal
ok 2 - INIT pheromone present
ok 3 - Worker Ants spawned autonomously
ok 4 - Colony progressed through phases
ok 5 - Colony reached COMPLETED state

Tests: 5 passed, 0 failed
Duration: 2.3s
```
  </how-to-verify>
  <resume-signal>Type "approved" if end-to-end test passes and state isolation verified, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- full-workflow.test.sh has executable permissions
- All helper scripts have executable permissions
- test-orchestrator.sh discovers and runs tests
- Tests pass with TAP output
- State isolation verified (run tests twice, both pass)
- Cleanup leaves .aether/data in clean state
</verification>

<success_criteria>
- Queen can run `/ant:init "Build REST API"` and colony completes workflow
- Integration test validates full emergence: INIT → Workers → Phases → Complete
- Test infrastructure is modular and extensible for additional tests
- State isolation prevents cross-test contamination
- Test orchestrator provides unified entry point for all tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-colony-maturity**---end-to-end-testing,-pattern-extraction,-production-readiness/10-01-SUMMARY.md`
</output>
