---
phase: 28-ux-friction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/colonize.md
autonomous: true

must_haves:
  truths:
    - "After /ant:build completes, output ends with a safe-to-clear confirmation message"
    - "After /ant:continue completes, output ends with a safe-to-clear confirmation message"
    - "After /ant:colonize completes, output suggests specific pheromone injections based on colonization findings"
    - "After /ant:colonize completes, output ends with a safe-to-clear confirmation message"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Safe-to-clear message after Step 7e Next block"
      contains: "Safe to /clear"
    - path: ".claude/commands/ant/continue.md"
      provides: "Safe-to-clear message after Step 8 Next Steps block"
      contains: "Safe to /clear"
    - path: ".claude/commands/ant/colonize.md"
      provides: "Pheromone suggestions in Step 6 + safe-to-clear after Step 7"
      contains: "Suggested Pheromone Injections"
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: "aether-utils.sh validate-state"
      via: "Bash tool call before safe-to-clear message"
      pattern: "validate-state all"
    - from: ".claude/commands/ant/colonize.md"
      to: "colonizer ant report"
      via: "Step 6 instructions to analyze findings"
      pattern: "colonizer.*report|findings"
---

<objective>
Add safe-to-clear persistence confirmation to build, continue, and colonize commands, and enhance colonize with pheromone-first suggestions.

Purpose: Users currently lose work by /clearing context at the wrong time because there is no confirmation that state has been persisted. After colonization, users skip pheromone injection because the output only shows generic command references instead of specific suggestions based on actual findings.

Output: Three modified command prompt files with safe-to-clear messages and colonize pheromone suggestions.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-ux-friction/28-RESEARCH.md
@.claude/commands/ant/build.md
@.claude/commands/ant/continue.md
@.claude/commands/ant/colonize.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safe-to-clear messages to build.md and continue.md</name>
  <files>.claude/commands/ant/build.md, .claude/commands/ant/continue.md</files>
  <action>
**build.md -- Add to the END of Step 7e (after the existing "Next:" block on line ~726-729):**

Append a new section after the closing triple-backtick of the Next block. Add these lines:

```
After displaying the "Next:" block above, run state validation:

Use the Bash tool to run: `bash .aether/aether-utils.sh validate-state all`

If the result contains `"pass":true`:
```
---
All state persisted. Safe to /clear context if needed.
  State: .aether/data/ (6 files validated)
  Resume: /ant:resume-colony
```

If the result contains `"pass":false`:
```
---
WARNING: State validation issue detected. Check /ant:status before clearing.
```
```

This goes AFTER the final triple-backtick block that ends build.md currently (after line 729). Do NOT put it inside the existing code block -- it is a new instruction section.

**continue.md -- Add to the END of Step 8 (after the existing "Next Steps:" block on line ~314-318):**

Append after the closing triple-backtick of the current Step 8 display block:

```
After displaying the result above, add a state persistence confirmation:

```
---
All state persisted. Safe to /clear context if needed.
  State: .aether/data/ (6 files validated)
  Resume: /ant:resume-colony
```
```

For continue.md, skip the validate-state call since continue.md just finished writing all state in Steps 6-7 (the writes are the last operations before display). The message is unconditional.

**Important constraints:**
- Do NOT modify any existing steps -- only APPEND new content after the final display blocks
- Do NOT change the structure or wording of existing "Next:" / "Next Steps:" blocks
- The safe-to-clear section is a separate instruction block, not part of the existing code fences
  </action>
  <verify>
Verify build.md contains "Safe to /clear" AND "validate-state all" after the "Next:" block.
Verify continue.md contains "Safe to /clear" AND "Resume: /ant:resume-colony" after the "Next Steps:" block.
Verify build.md line count is approximately 750 (was 729, adding ~20 lines).
Verify continue.md line count is approximately 330 (was 319, adding ~12 lines).
Run: `grep -n "Safe to /clear" .claude/commands/ant/build.md .claude/commands/ant/continue.md` -- both files should match.
  </verify>
  <done>build.md ends with a validate-state call followed by conditional safe-to-clear or warning message. continue.md ends with an unconditional safe-to-clear message. Neither file has any changes to existing steps.</done>
</task>

<task type="auto">
  <name>Task 2: Add pheromone-first suggestions and safe-to-clear to colonize.md</name>
  <files>.claude/commands/ant/colonize.md</files>
  <action>
**colonize.md -- Replace the Step 6 display content (lines ~146-163) with an enhanced version:**

Keep the Step 6 heading "### Step 6: Display Results" and replace the content below it with:

```markdown
### Step 6: Display Results

Display the ant's findings, then analyze the findings to suggest specific pheromones:

```
ðŸ‘‘ CODEBASE COLONIZED

  Goal: "{goal}"

{ant's report â€” structure, tech stack, architecture, conventions, recommendations}

  Findings saved to memory.json

Suggested Pheromone Injections:
  Based on colonization findings:

  /ant:focus "<specific area identified from the ant's report>"
    Why: <concrete reason derived from the analysis â€” reference actual finding>

  {if the ant identified problematic patterns, anti-patterns, or risks:}
  /ant:redirect "<specific pattern to avoid based on the ant's findings>"
    Why: <concrete reason derived from the analysis â€” reference actual finding>

  Skip these if you want the colony to plan without guidance.

Next:
  /ant:plan              Generate project plan
  /ant:focus "<area>"    Inject focus before planning
  /ant:redirect "<pat>"  Inject constraint before planning
```

**CRITICAL:** The pheromone suggestions MUST be derived from the ACTUAL colonizer ant report returned in Step 4. Analyze the ant's specific findings â€” its tech stack observations, architectural patterns, code quality issues, conventions detected â€” and formulate 1-2 concrete focus/redirect suggestions that reference those findings. Do NOT output generic boilerplate like "consider focusing on important areas."

If the ant's report contains no clear focus areas or problematic patterns, display:

```
  No specific pheromone injections suggested â€” analysis was clean.
  You can still inject guidance manually if you have preferences.
```

**colonize.md -- Add safe-to-clear after Step 7 (the final step):**

After the existing Step 7 content (line ~170), append:

```markdown
### Step 8: Persistence Confirmation

After resetting state in Step 7, display:

```
---
All state persisted. Safe to /clear context if needed.
  State: .aether/data/ (6 files validated)
  Resume: /ant:resume-colony
```
```

**Important constraints:**
- Keep colonize.md's overall structure (Steps 1-7 + new Step 8)
- The "Suggested Pheromone Injections" block is INSIDE the Step 6 display template, not a separate instruction
- Do NOT change Steps 1-5 or Step 7 content
  </action>
  <verify>
Verify colonize.md contains "Suggested Pheromone Injections" in Step 6.
Verify colonize.md contains "Safe to /clear" in a new Step 8.
Verify colonize.md contains instruction about analyzing the "ant's report" or "ant's findings" for pheromone suggestions.
Verify colonize.md does NOT contain the old generic "Next:" block without pheromone suggestions.
Run: `grep -n "Suggested Pheromone" .claude/commands/ant/colonize.md` -- should match.
Run: `grep -n "Safe to /clear" .claude/commands/ant/colonize.md` -- should match.
Verify colonize.md line count is approximately 200 (was 170, adding ~30 lines).
  </verify>
  <done>colonize.md Step 6 shows specific pheromone suggestions derived from the colonizer ant's actual findings. colonize.md has a new Step 8 with safe-to-clear confirmation. The pheromone suggestions instruction explicitly requires analysis of the ant's report, not generic boilerplate.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -c "Safe to /clear" .claude/commands/ant/build.md` returns 1
2. `grep -c "Safe to /clear" .claude/commands/ant/continue.md` returns 1
3. `grep -c "Safe to /clear" .claude/commands/ant/colonize.md` returns 1
4. `grep -c "Suggested Pheromone Injections" .claude/commands/ant/colonize.md` returns 1
5. `grep -c "validate-state all" .claude/commands/ant/build.md` returns at least 1 (the new one)
6. All three files parse as valid markdown (no broken code fences)
7. Existing step structure preserved -- Step numbers in build.md (1-7e), continue.md (1-8), colonize.md (1-8) are intact
</verification>

<success_criteria>
- UX-01: All three commands (build, continue, colonize) end with "safe to /clear" message confirming state persistence
- FLOW-01: Colonize output includes specific pheromone injection suggestions derived from the actual colonizer ant's findings, not generic boilerplate
- No existing functionality broken -- all prior steps in all three files unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/28-ux-friction/28-01-SUMMARY.md`
</output>
