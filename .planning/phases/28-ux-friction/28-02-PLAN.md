---
phase: 28-ux-friction
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "Running /ant:continue --all executes remaining phases sequentially without user approval"
    - "Auto-continue builds each phase before advancing (does not just increment the counter)"
    - "Auto-continue halts if a watcher score drops below 4/10"
    - "After auto-continue completes, the output shows a cumulative summary of all phases built"
  artifacts:
    - path: ".claude/commands/ant/continue.md"
      provides: "Argument parsing for --all flag and auto-continue loop"
      contains: "--all"
    - path: ".claude/commands/ant/continue.md"
      provides: "Task tool delegation to build each phase"
      contains: "Task tool"
    - path: ".claude/commands/ant/continue.md"
      provides: "Halt conditions for auto-continue"
      contains: "quality_score"
  key_links:
    - from: ".claude/commands/ant/continue.md"
      to: ".claude/commands/ant/build.md"
      via: "Task tool spawning build execution per phase"
      pattern: "build\\.md|ant:build|build.*phase"
    - from: ".claude/commands/ant/continue.md"
      to: "quality_score halt check"
      via: "Watcher score threshold comparison"
      pattern: "quality_score.*<.*4|score.*4"
---

<objective>
Add auto-continue mode to /ant:continue via --all flag that builds and advances through all remaining phases without manual approval.

Purpose: Multi-phase colony builds currently require the user to manually run /ant:build and /ant:continue for each phase. The --all flag automates this entire pipeline, only halting on critical quality failures.

Output: Modified continue.md with argument parsing, auto-continue loop using Task tool delegation, halt conditions, and cumulative display.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-ux-friction/28-RESEARCH.md
@.planning/phases/28-ux-friction/28-01-SUMMARY.md
@.claude/commands/ant/continue.md
@.claude/commands/ant/build.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add argument parsing and auto-continue loop to continue.md</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Read continue.md (which was modified by Plan 01 to include safe-to-clear at the end of Step 8). Add two new sections: Step 0 (argument parsing) before Step 1, and Step 1.5 (auto-continue loop) after Step 1.

**Add Step 0 BEFORE the existing Step 1 (insert before line 10 "### Step 1: Read State"):**

```markdown
### Step 0: Parse Arguments

Check if `$ARGUMENTS` contains `--all` or `all`.

- If `--all` or `all` is present: set `auto_mode = true`
- Otherwise: set `auto_mode = false`

Proceed to Step 1.
```

**Add Step 1.5 AFTER Step 1 and BEFORE Step 2 (insert after the Step 1 error handling, before "### Step 2: Determine Next Phase"):**

```markdown
### Step 1.5: Auto-Continue Loop (only if auto_mode is true)

If `auto_mode` is false, skip this step entirely and proceed to Step 2 (normal single-phase flow).

If `auto_mode` is true:

Read `PROJECT_PLAN.json` to determine how many phases remain. Calculate `remaining_phases` as all phases with status NOT equal to `"completed"`.

If no phases remain, output "All phases already complete." and proceed to Step 8.

Display:
```
+=====================================================+
|  üëë AETHER COLONY :: AUTO-CONTINUE                   |
+=====================================================+

Running all remaining phases automatically.
Halt conditions: watcher score < 4, or 2 consecutive failures.
Phases remaining: <count>
```

Initialize: `consecutive_failures = 0`, `phase_results = []`

**For each remaining phase (in order):**

1. Display: `"\n--- Auto-Continue: Phase <N>/<total> - <phase_name> ---\n"`

2. **Build the phase** using the **Task tool** with `subagent_type="general-purpose"`:
   ```
   You are executing /ant:build <phase_number> as part of an auto-continue run.

   Read the file .claude/commands/ant/build.md using the Read tool.
   Follow ALL instructions from Step 1 through Step 7e exactly,
   with $ARGUMENTS = "<phase_number>".

   IMPORTANT: In auto-continue mode, auto-approve the Phase Lead's plan
   in Step 5b WITHOUT asking the user. Skip the "Proceed with this plan?"
   prompt and proceed directly to Step 5c.

   Execute all steps. Return your result including:
   - The watcher quality_score (number 1-10)
   - The watcher recommendation ("approve" or "request_changes")
   - A one-line summary of what was built
   ```

3. **Check halt conditions** after build returns:
   - Extract `quality_score` from the Task result
   - If `quality_score < 4`:
     - Display: `"AUTO-CONTINUE HALTED: Phase <N> scored <score>/10. Manual review needed."`
     - Display: `"Run /ant:status to inspect, then /ant:build <N> to retry manually."`
     - Break out of the loop and proceed to the cumulative display
   - If build reported failure (no quality_score returned or task errored):
     - Increment `consecutive_failures`
     - If `consecutive_failures >= 2`:
       - Display: `"AUTO-CONTINUE HALTED: 2 consecutive phase failures."`
       - Break out of the loop
     - Otherwise: continue to next phase
   - If `quality_score >= 4`:
     - Reset `consecutive_failures = 0`

4. **Run continue logic** for this phase: Execute Steps 3-7 of this command (phase completion summary, extract learnings, auto-emit pheromones, clean pheromones, write events, update colony state) for the just-completed phase.

5. **Record phase result:**
   - Append to `phase_results`: `{phase: <N>, name: "<name>", score: <quality_score>, status: "COMPLETE" or "FAILED"}`
   - Display condensed summary:
     ```
     Phase <N>: <name> -- <COMPLETE|FAILED> (quality: <score>/10)
     ```

**After the loop completes (or halts), display cumulative results:**

```
+=====================================================+
|  AUTO-CONTINUE COMPLETE                              |
+=====================================================+

Phases processed: <count>
  {for each phase_result:}
  {‚úÖ or ‚ùå} Phase <N>: <name> (quality: <score>/10)

{if halted:}
Halted at: Phase <N> ‚Äî <reason>
{/if}
```

Then proceed to Step 8 to display the normal result (showing the NEXT unbuilt phase, or "all complete" if done).
```

**Update Step 8 display to account for auto_mode:**

In Step 8, after the step progress block, add a note:

```markdown
{if auto_mode was true, the step progress should show:}
```
  ‚úì Step 0: Parse Arguments (--all mode)
  ‚úì Step 1: Read State
  ‚úì Step 1.5: Auto-Continue Loop (<N> phases)
  ‚úì Step 8: Display Result
```
{Steps 2-7 are executed per-phase inside the loop, not shown individually}
```

**Important constraints:**
- Do NOT modify Steps 2-7 content. The auto-continue loop CALLS Steps 3-7 internally per phase, it does not change them.
- Do NOT inline build.md logic. The build is delegated via Task tool.
- The Task tool prompt MUST tell the build agent to read build.md itself (not paste 730 lines into the prompt).
- The auto-approve instruction MUST be explicit: "Skip Step 5b user prompt."
- Keep the safe-to-clear message (added by Plan 01) at the end of Step 8 -- it applies to both normal and auto mode.
- continue.md should grow by approximately 80 lines total (from ~330 after Plan 01 to ~410).
  </action>
  <verify>
Verify continue.md contains "### Step 0: Parse Arguments".
Verify continue.md contains "### Step 1.5: Auto-Continue Loop".
Verify continue.md contains "--all" in Step 0.
Verify continue.md contains "Task tool" in Step 1.5 (for build delegation).
Verify continue.md contains "quality_score" and threshold check "< 4" in Step 1.5.
Verify continue.md contains "consecutive_failures" halt logic.
Verify continue.md contains "auto-approve" or "auto_mode" or skip Step 5b instruction.
Verify continue.md still contains "Safe to /clear" (from Plan 01) at the end.
Verify continue.md line count is approximately 400-420.
Run: `grep -c "\-\-all" .claude/commands/ant/continue.md` -- should be >= 2 (Step 0 + references).
Run: `grep -c "Task tool" .claude/commands/ant/continue.md` -- should be >= 1.
  </verify>
  <done>/ant:continue accepts --all flag. When --all is present, it loops through all remaining phases, delegates each build to a Task tool agent that reads build.md, auto-approves plans, checks watcher scores, halts on critical failures, and shows cumulative results. Normal single-phase flow is unchanged when --all is absent.</done>
</task>

</tasks>

<verification>
After task completes:
1. `grep -c "\-\-all" .claude/commands/ant/continue.md` returns >= 2
2. `grep -c "quality_score" .claude/commands/ant/continue.md` returns >= 1
3. `grep -c "Safe to /clear" .claude/commands/ant/continue.md` returns >= 1
4. `grep -c "Step 0" .claude/commands/ant/continue.md` returns >= 1
5. `grep -c "Step 1.5" .claude/commands/ant/continue.md` returns >= 1
6. continue.md still starts with valid YAML frontmatter (name: ant:continue)
7. Step ordering is logical: 0 -> 1 -> 1.5 -> 2 -> 3 -> 4 -> 4.5 -> 5 -> 6 -> 7 -> 8
8. No existing step content modified (Steps 1-8 unchanged except Step 8 auto_mode note)
</verification>

<success_criteria>
- UX-02: `/ant:continue --all` executes remaining phases sequentially without user approval at each boundary
- Auto-continue builds each phase via Task tool delegation (does not skip building)
- Halt conditions: watcher score < 4/10, 2 consecutive failures, or all phases complete
- Cumulative summary displayed after auto-continue completes
- Normal single-phase `/ant:continue` flow completely unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/28-ux-friction/28-02-SUMMARY.md`
</output>
