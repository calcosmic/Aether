---
phase: 33-state-foundation
plan: 04
type: execute
wave: 3
depends_on: ["33-02", "33-03"]
files_modified:
  - .claude/commands/ant/plan.md
  - .claude/commands/ant/colonize.md
  - .claude/commands/ant/organize.md
  - .claude/commands/ant/build.md
  - .claude/commands/ant/continue.md
autonomous: true

must_haves:
  truths:
    - "All 5 commands read from single COLONY_STATE.json"
    - "All 5 commands write to single COLONY_STATE.json"
    - "No references to separate state files anywhere in these commands"
  artifacts:
    - path: ".claude/commands/ant/plan.md"
      provides: "Project planning"
    - path: ".claude/commands/ant/colonize.md"
      provides: "Codebase analysis"
    - path: ".claude/commands/ant/organize.md"
      provides: "Hygiene reporting"
    - path: ".claude/commands/ant/build.md"
      provides: "Phase execution"
    - path: ".claude/commands/ant/continue.md"
      provides: "Phase continuation"
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Read state, update during execution, write state"
      pattern: "COLONY_STATE"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Read state, update phase status, write state"
      pattern: "COLONY_STATE"
---

<objective>
Update remaining complex commands to use consolidated COLONY_STATE.json.

Purpose: Complete the state consolidation by updating the remaining 5 commands. These are more complex than the previous batch but follow the same pattern: replace multiple file reads/writes with single COLONY_STATE.json access.

Note: Phase 34 will REWRITE build.md and continue.md from scratch. For this phase, only change the state file references - do not simplify the command logic yet.

Output:
- Updated plan.md, colonize.md, organize.md, build.md, continue.md
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-state-foundation/33-RESEARCH.md
@.planning/phases/33-state-foundation/33-01-SUMMARY.md
@.planning/phases/33-state-foundation/33-02-SUMMARY.md
@.planning/phases/33-state-foundation/33-03-SUMMARY.md

# Commands to update
@.claude/commands/ant/plan.md
@.claude/commands/ant/colonize.md
@.claude/commands/ant/organize.md
@.claude/commands/ant/build.md
@.claude/commands/ant/continue.md

# State format reference
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plan.md and colonize.md</name>
  <files>.claude/commands/ant/plan.md, .claude/commands/ant/colonize.md</files>
  <action>
**plan.md:**
1. Read state step: Read only `.aether/data/COLONY_STATE.json`
   - Extract goal from top level
   - Extract signals from `signals` array
   - Extract current plan from `plan.phases` (for context)

2. Write plan step: Write back to `.aether/data/COLONY_STATE.json`
   - Update `plan.phases` array
   - Update `plan.generated_at` timestamp
   - Update `state` to appropriate value
   - Append event to `events` array as string
   - Write full state back

3. Remove references to:
   - `.aether/data/PROJECT_PLAN.json`
   - `.aether/data/pheromones.json`

**colonize.md:**
1. Read state step: Read only `.aether/data/COLONY_STATE.json`
   - Extract goal, state from top level
   - Extract signals from `signals` array

2. Write colonization results:
   - Update `mode`, `mode_set_at`, `mode_indicators` at top level
   - Append to `memory.decisions` array
   - Append event to `events` array as string
   - Append any new signals to `signals` array
   - Write full state back

3. Remove references to:
   - `.aether/data/pheromones.json`
   - `.aether/data/memory.json`
   - `.aether/data/events.json`
  </action>
  <verify>
`grep -l "PROJECT_PLAN.json\|pheromones.json\|memory.json\|events.json" .claude/commands/ant/plan.md .claude/commands/ant/colonize.md` returns empty
Both commands reference only `.aether/data/COLONY_STATE.json`
  </verify>
  <done>
plan.md and colonize.md use consolidated COLONY_STATE.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Update organize.md</name>
  <files>.claude/commands/ant/organize.md</files>
  <action>
1. Read state step: Read only `.aether/data/COLONY_STATE.json`
   - Extract all relevant fields for hygiene analysis:
     - plan.phases for phase data
     - signals for pheromone data
     - errors.records for error patterns
     - memory for decisions/learnings
     - events for activity

2. organize.md primarily READS state for analysis
   - It spawns architect-ant for report generation
   - Does not typically write state updates
   - May write events for tracking

3. If any state writes exist, consolidate to single COLONY_STATE.json write

4. Remove references to:
   - `.aether/data/PROJECT_PLAN.json`
   - `.aether/data/pheromones.json`
   - `.aether/data/errors.json`
   - `.aether/data/memory.json`
   - `.aether/data/events.json`

Note: organize.md reads `.aether/data/activity.log` - this is CORRECT and should remain separate (not part of state consolidation).
  </action>
  <verify>
`grep -l "PROJECT_PLAN.json\|pheromones.json\|memory.json\|errors.json\|events.json" .claude/commands/ant/organize.md` returns empty
Command references only `.aether/data/COLONY_STATE.json` for JSON state
activity.log reference preserved (separate file)
  </verify>
  <done>
organize.md uses consolidated COLONY_STATE.json
  </done>
</task>

<task type="auto">
  <name>Task 3: Update build.md and continue.md</name>
  <files>.claude/commands/ant/build.md, .claude/commands/ant/continue.md</files>
  <action>
These are the most complex commands. For Phase 33, only change state file references - do NOT simplify the command logic (Phase 34 will rewrite them).

**build.md:**
1. Step 1 (Read State): Read only `.aether/data/COLONY_STATE.json`
   - Extract goal, state, current_phase from top level
   - Extract plan.phases for phase data
   - Extract signals for pheromone guidance
   - Extract errors.records for error context
   - Extract events for recent activity
   - Extract memory for decisions/learnings

2. Throughout execution, writes should update single file:
   - Worker status updates -> update `workers` object
   - Phase status updates -> update `plan.phases[N].status`
   - Error recording -> append to `errors.records`
   - Event logging -> append string to `events` array
   - Learning extraction -> append to `memory.phase_learnings`
   - Decision logging -> append to `memory.decisions`
   - Signal updates -> update `signals` array

3. Remove ALL references to:
   - `.aether/data/PROJECT_PLAN.json`
   - `.aether/data/pheromones.json`
   - `.aether/data/errors.json`
   - `.aether/data/memory.json`
   - `.aether/data/events.json`

**continue.md:**
1. Step 1 (Read State): Read only `.aether/data/COLONY_STATE.json`
   - Extract all relevant fields from consolidated structure

2. State writes should update single file:
   - Phase advancement -> update `current_phase`, `plan.phases[N].status`
   - Learning extraction -> append to `memory.phase_learnings`
   - Signal updates -> update `signals` array
   - Event logging -> append string to `events` array

3. Remove ALL references to:
   - `.aether/data/PROJECT_PLAN.json`
   - `.aether/data/pheromones.json`
   - `.aether/data/memory.json`
   - `.aether/data/events.json`

Important: Keep all existing logic, step structure, and functionality. Only change WHERE state is read from and written to.
  </action>
  <verify>
`grep -l "PROJECT_PLAN.json\|pheromones.json\|memory.json\|errors.json\|events.json" .claude/commands/ant/build.md .claude/commands/ant/continue.md` returns empty
Both commands reference only `.aether/data/COLONY_STATE.json` for state
Existing command logic preserved (not simplified)
  </verify>
  <done>
build.md and continue.md use consolidated COLONY_STATE.json
  </done>
</task>

</tasks>

<verification>
1. `grep -r "PROJECT_PLAN.json\|pheromones.json\|memory.json\|errors.json\|events.json" .claude/commands/ant/plan.md .claude/commands/ant/colonize.md .claude/commands/ant/organize.md .claude/commands/ant/build.md .claude/commands/ant/continue.md` returns empty
2. All 5 commands reference `.aether/data/COLONY_STATE.json`
3. Event strings use pipe-delimited format where events are written
4. activity.log handling preserved in organize.md
</verification>

<success_criteria>
- All 5 remaining commands use consolidated COLONY_STATE.json
- No references to old separate state files
- Command logic preserved (simplification deferred to Phase 34)
- build.md and continue.md functional with new state format
</success_criteria>

<output>
After completion, create `.planning/phases/33-state-foundation/33-04-SUMMARY.md`
</output>
