---
phase: 33-state-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/data/COLONY_STATE.json
  - .claude/commands/ant/migrate-state.md
autonomous: true

must_haves:
  truths:
    - "Migration script converts 6-file state to consolidated format without data loss"
    - "New COLONY_STATE.json contains all data from original 6 files"
    - "Version field distinguishes new format from old"
  artifacts:
    - path: ".claude/commands/ant/migrate-state.md"
      provides: "One-time migration command"
      contains: "version.*2.0"
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Consolidated state after migration"
      contains: "\"version\": \"2.0\""
  key_links:
    - from: "migrate-state.md"
      to: ".aether/data/COLONY_STATE.json"
      via: "Read all 6 files, write consolidated"
      pattern: "Write.*COLONY_STATE"
---

<objective>
Create the consolidated COLONY_STATE.json schema and migration command.

Purpose: Establish the new single-file state format that all commands will use. The migration command converts existing 6-file state to the new format, preserving all data.

Output:
- Migration command at `.claude/commands/ant/migrate-state.md`
- Migrated `.aether/data/COLONY_STATE.json` in new v2.0 format
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-state-foundation/33-RESEARCH.md

# Current state files to merge
@.aether/data/COLONY_STATE.json
@.aether/data/PROJECT_PLAN.json
@.aether/data/pheromones.json
@.aether/data/memory.json
@.aether/data/errors.json
@.aether/data/events.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration command</name>
  <files>.claude/commands/ant/migrate-state.md</files>
  <action>
Create a new Claude Code command `/ant:migrate-state` that:

1. Reads all 6 current state files from `.aether/data/`:
   - COLONY_STATE.json
   - PROJECT_PLAN.json
   - pheromones.json
   - memory.json
   - errors.json
   - events.json

2. Constructs the consolidated v2.0 format per RESEARCH.md schema:
```json
{
  "version": "2.0",
  "goal": "<from COLONY_STATE>",
  "state": "<from COLONY_STATE>",
  "current_phase": "<from COLONY_STATE>",
  "session_id": "<from COLONY_STATE>",
  "initialized_at": "<from COLONY_STATE>",
  "mode": "<from COLONY_STATE>",
  "mode_set_at": "<from COLONY_STATE>",
  "mode_indicators": "<from COLONY_STATE>",
  "workers": "<from COLONY_STATE>",
  "spawn_outcomes": "<from COLONY_STATE>",
  "plan": {
    "generated_at": "<from PROJECT_PLAN>",
    "phases": "<from PROJECT_PLAN>"
  },
  "signals": "<from pheromones.signals>",
  "memory": {
    "phase_learnings": "<from memory>",
    "decisions": "<from memory>",
    "patterns": "<from memory>"
  },
  "errors": {
    "records": "<from errors.errors>",
    "flagged_patterns": "<from errors.flagged_patterns>"
  },
  "events": ["<converted to strings>"]
}
```

3. Converts events from structured objects to pipe-delimited strings:
   - Old: `{"id":"evt_123","type":"colony_initialized","source":"init","content":"msg","timestamp":"2026-..."}`
   - New: `"2026-... | colony_initialized | init | msg"`

4. Creates backup directory `.aether/data/backup-v1/` and moves old files there

5. Writes the new consolidated COLONY_STATE.json

6. Displays migration summary showing what was migrated

Command should check if already migrated (version field exists) and skip if so.
  </action>
  <verify>
File exists: `.claude/commands/ant/migrate-state.md`
File contains: version 2.0 schema, event string conversion, backup logic
  </verify>
  <done>
Migration command created with full schema, event conversion, and backup logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Run migration on current state</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
Execute the migration by:

1. Read all 6 current state files
2. Construct the consolidated format
3. Create backup at `.aether/data/backup-v1/`
4. Write new COLONY_STATE.json with version: "2.0"

Since the current state files are mostly empty (IDLE state, no events, few errors), this migration should result in a clean v2.0 file.

Note: The test errors in errors.json should be preserved in errors.records.
  </action>
  <verify>
`.aether/data/COLONY_STATE.json` contains `"version": "2.0"`
`.aether/data/backup-v1/` directory exists with old files
All data from original files present in consolidated format
  </verify>
  <done>
Current state migrated to v2.0 format, old files backed up
  </done>
</task>

</tasks>

<verification>
1. `grep -l "version.*2.0" .aether/data/COLONY_STATE.json` returns the file
2. `.aether/data/backup-v1/` contains: COLONY_STATE.json, PROJECT_PLAN.json, pheromones.json, memory.json, errors.json, events.json
3. New COLONY_STATE.json contains: version, goal, state, plan, signals, memory, errors, events fields
4. Old separate files (PROJECT_PLAN.json, pheromones.json, etc.) no longer exist in `.aether/data/` root
</verification>

<success_criteria>
- Migration command exists and can convert 6-file state to single-file format
- Current project state is migrated to v2.0 format
- All existing data preserved (especially the 4 error records)
- Old files backed up, not deleted
- New format matches RESEARCH.md schema
</success_criteria>

<output>
After completion, create `.planning/phases/33-state-foundation/33-01-SUMMARY.md`
</output>
