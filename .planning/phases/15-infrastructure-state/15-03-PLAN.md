---
phase: 15-infrastructure-state
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/focus.md
  - .claude/commands/ant/redirect.md
  - .claude/commands/ant/feedback.md
autonomous: true

must_haves:
  truths:
    - "Running /ant:continue extracts phase learnings from errors.json, events.json, and PROJECT_PLAN.json and stores them in memory.json"
    - "Phase learnings are specific and actionable, not generic boilerplate"
    - "continue.md writes phase_advanced and learnings_extracted events to events.json"
    - "Running /ant:focus logs a decision record to memory.json decisions array"
    - "Running /ant:redirect logs a decision record to memory.json decisions array"
    - "Running /ant:feedback logs a decision record to memory.json decisions array"
    - "All three pheromone commands write pheromone_emitted events to events.json"
    - "memory.json phase_learnings capped at 20, decisions capped at 30"
  artifacts:
    - path: ".claude/commands/ant/continue.md"
      provides: "Phase learning extraction and event writing"
      contains: "memory.json"
    - path: ".claude/commands/ant/focus.md"
      provides: "Decision logging and event writing"
      contains: "memory.json"
    - path: ".claude/commands/ant/redirect.md"
      provides: "Decision logging and event writing"
      contains: "memory.json"
    - path: ".claude/commands/ant/feedback.md"
      provides: "Decision logging and event writing"
      contains: "memory.json"
  key_links:
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/data/memory.json"
      via: "Write tool in Step 3"
      pattern: "memory\\.json"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/data/events.json"
      via: "Write tool in Step 5"
      pattern: "events\\.json"
    - from: ".claude/commands/ant/focus.md"
      to: ".aether/data/memory.json"
      via: "Write tool in Step 4"
      pattern: "memory\\.json"
    - from: ".claude/commands/ant/focus.md"
      to: ".aether/data/events.json"
      via: "Write tool in Step 5"
      pattern: "events\\.json"
---

<objective>
Integrate memory extraction into continue.md and decision logging + event writing into focus.md, redirect.md, and feedback.md.

Purpose: Phase learnings captured at boundaries ensure the colony remembers what worked and what failed across phases. Decision logging in pheromone commands creates a record of user guidance that workers and the dashboard can reference. Event writing creates an audit trail for all state-changing pheromone operations.

Output: Modified continue.md (7 steps with learning extraction and events), modified focus.md, redirect.md, feedback.md (6 steps each with decision logging and events).
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-infrastructure-state/15-RESEARCH.md
@.claude/commands/ant/continue.md
@.claude/commands/ant/focus.md
@.claude/commands/ant/redirect.md
@.claude/commands/ant/feedback.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add learning extraction and event writing to continue.md</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
Modify `.claude/commands/ant/continue.md`. The current flow is:

```
Step 1: Read State
Step 2: Determine Next Phase
Step 3: Clean Expired Pheromones
Step 4: Update Colony State
Step 5: Display Result
```

The new flow must be:

```
Step 1: Read State (expanded)
Step 2: Determine Next Phase (unchanged)
Step 3: Extract Phase Learnings (NEW)
Step 4: Clean Expired Pheromones (renumbered from 3)
Step 5: Write Events (NEW)
Step 6: Update Colony State (renumbered from 4)
Step 7: Display Result (renumbered from 5, updated progress)
```

**Step 1: Read State** -- Add 3 files to the parallel Read calls. The step should now read 6 files:
- `.aether/data/COLONY_STATE.json`
- `.aether/data/pheromones.json`
- `.aether/data/PROJECT_PLAN.json`
- `.aether/data/errors.json`
- `.aether/data/memory.json`
- `.aether/data/events.json`

Keep all existing validation logic unchanged.

**Step 3: Extract Phase Learnings** -- Insert between current Step 2 (Determine Next Phase) and current Step 3 (Clean Pheromones). Content:

```markdown
### Step 3: Extract Phase Learnings

Review the completed phase by analyzing:
- Tasks completed in this phase (from PROJECT_PLAN.json -- look at the current phase's tasks)
- Errors encountered during this phase (from errors.json -- filter by `phase` field matching current phase)
- Events that occurred (from events.json -- recent events related to this phase)
- Flagged patterns (from errors.json `flagged_patterns` array)

Read `.aether/data/memory.json`. Append a phase learning entry to the `phase_learnings` array:

```json
{
  "id": "learn_<unix_timestamp>_<4_random_hex>",
  "phase": <current_phase_number>,
  "phase_name": "<phase name from PROJECT_PLAN.json>",
  "learnings": [
    "<specific thing learned -- what worked, what didn't, what to remember>",
    "<another specific learning>"
  ],
  "errors_encountered": <count of errors with this phase number>,
  "timestamp": "<ISO-8601 UTC>"
}
```

Learnings must be SPECIFIC and ACTIONABLE. Good: "TypeScript strict mode caught 12 type errors early." Bad: "Phase completed successfully." Draw from actual task outcomes, errors, and events -- not boilerplate.

If the `phase_learnings` array exceeds 20 entries, remove the oldest entries to keep only 20.

Use the Write tool to write the updated memory.json.
```

**Step 5: Write Events** -- Insert after renumbered Step 4 (Clean Expired Pheromones). Content:

```markdown
### Step 5: Write Events

Read `.aether/data/events.json`. Append two events to the `events` array:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "learnings_extracted",
  "source": "continue",
  "content": "Extracted <N> learnings from Phase <id>: <name>",
  "timestamp": "<ISO-8601 UTC>"
}
```

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "phase_advanced",
  "source": "continue",
  "content": "Advanced from Phase <current> to Phase <next>",
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `events` array exceeds 100 entries, remove the oldest entries to keep only 100.

Use the Write tool to write the updated events.json.
```

**Step 7: Display Result** -- Update the step progress to show 7 steps:

```
  ✓ Step 1: Read State
  ✓ Step 2: Determine Next Phase
  ✓ Step 3: Extract Phase Learnings
  ✓ Step 4: Clean Expired Pheromones
  ✓ Step 5: Write Events
  ✓ Step 6: Update Colony State
  ✓ Step 7: Display Result
```

After the existing display output (phase advancement info), add a learnings section:

```
  Learnings Extracted:
    - <learning 1>
    - <learning 2>
```

Keep the box-drawing header unchanged:
```
+=====================================================+
|  AETHER COLONY :: CONTINUE                           |
+=====================================================+
```
  </action>
  <verify>
Read the modified continue.md and verify:
1. File has 7 numbered steps (Step 1 through Step 7)
2. Step 1 reads 6 files (COLONY_STATE, pheromones, PROJECT_PLAN, errors, memory, events)
3. Step 3 extracts phase learnings with the correct schema (id, phase, phase_name, learnings, errors_encountered, timestamp)
4. Step 3 has 20-entry retention limit for phase_learnings
5. Step 3 emphasizes specific/actionable learnings (not boilerplate)
6. Step 5 writes learnings_extracted and phase_advanced events
7. Step 5 has 100-entry retention limit for events
8. Step 7 step progress lists all 7 steps
9. Step 7 display includes learnings section
10. Box-drawing header preserved
11. All original logic preserved (determine next phase, clean pheromones, update state)
  </verify>
  <done>continue.md has 7 steps. Reads all 6 state files. Extracts specific learnings at phase boundaries. Writes learnings_extracted and phase_advanced events. Step progress shows 7 steps. Retention limits enforced.</done>
</task>

<task type="auto">
  <name>Task 2: Add decision logging and event writing to focus.md, redirect.md, and feedback.md</name>
  <files>.claude/commands/ant/focus.md, .claude/commands/ant/redirect.md, .claude/commands/ant/feedback.md</files>
  <action>
Modify all three pheromone commands with the same pattern. Each currently has 4 steps:

```
Step 1: Validate Input
Step 2: Read State
Step 3: Append Signal
Step 4: Display Result
```

The new flow for each must be:

```
Step 1: Validate Input (unchanged)
Step 2: Read State (unchanged)
Step 3: Append Signal (unchanged -- FOCUS/REDIRECT/FEEDBACK)
Step 4: Log Decision (NEW)
Step 5: Write Event (NEW)
Step 6: Display Result (renumbered from 4, unchanged content)
```

**For all three files, add Step 4: Log Decision** after the existing Step 3 (Append Signal):

```markdown
### Step 4: Log Decision

Read `.aether/data/memory.json`. Append a decision record to the `decisions` array:

```json
{
  "id": "dec_<unix_timestamp>_<4_random_hex>",
  "type": "<focus|redirect|feedback>",
  "content": "<the pheromone content/area/pattern/message>",
  "context": "Phase <current_phase> -- <colony state>",
  "phase": <current_phase from COLONY_STATE.json>,
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `decisions` array exceeds 30 entries, remove the oldest entries to keep only 30.

Use the Write tool to write the updated memory.json.
```

**For all three files, add Step 5: Write Event** after Step 4:

```markdown
### Step 5: Write Event

Read `.aether/data/events.json`. Append to the `events` array:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "pheromone_emitted",
  "source": "<focus|redirect|feedback>",
  "content": "<FOCUS|REDIRECT|FEEDBACK>: <content> (strength <strength>, half-life <half_life_description>)",
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `events` array exceeds 100 entries, remove the oldest entries to keep only 100.

Use the Write tool to write the updated events.json.
```

**Specific values per file:**

| File | decision type | event source | signal TYPE | strength | half-life desc |
|------|--------------|-------------|-------------|----------|----------------|
| focus.md | "focus" | "focus" | "FOCUS" | 0.7 | "1hr" |
| redirect.md | "redirect" | "redirect" | "REDIRECT" | 0.9 | "24hr" |
| feedback.md | "feedback" | "feedback" | "FEEDBACK" | 0.5 | "6hr" |

**Step 6: Display Result** -- Renumber from Step 4. Keep all display content unchanged (the colony response table, next steps, etc.).

IMPORTANT: Do NOT change any existing step content. Only insert the two new steps and renumber Step 4 -> Step 6.
  </action>
  <verify>
Read all three modified files and verify for each:
1. File has 6 numbered steps (Step 1 through Step 6)
2. Step 4 logs a decision to memory.json with correct schema (id, type, content, context, phase, timestamp)
3. Step 4 has 30-entry retention limit for decisions
4. Step 5 writes a pheromone_emitted event to events.json with correct schema (id, type, source, content, timestamp)
5. Step 5 has 100-entry retention limit for events
6. Step 6 display content is unchanged from original Step 4
7. Decision type matches the command (focus/redirect/feedback)
8. Event source matches the command (focus/redirect/feedback)
9. All existing functionality preserved

Verify file-specific:
- focus.md: type="focus", source="focus", FOCUS, strength 0.7, half-life 1hr
- redirect.md: type="redirect", source="redirect", REDIRECT, strength 0.9, half-life 24hr
- feedback.md: type="feedback", source="feedback", FEEDBACK, strength 0.5, half-life 6hr
  </verify>
  <done>focus.md, redirect.md, feedback.md each have 6 steps. Step 4 logs decisions to memory.json. Step 5 writes pheromone_emitted events to events.json. Retention limits enforced (30 decisions, 100 events). All existing display content preserved.</done>
</task>

</tasks>

<verification>
- Read all 4 modified files end to end
- continue.md: 7 steps, reads 6 files, extracts learnings, writes 2 events
- focus.md: 6 steps, logs focus decision, writes pheromone_emitted event
- redirect.md: 6 steps, logs redirect decision, writes pheromone_emitted event
- feedback.md: 6 steps, logs feedback decision, writes pheromone_emitted event
- All event records have exactly 5 fields: id, type, source, content, timestamp
- All decision records have exactly 6 fields: id, type, content, context, phase, timestamp
- Learning records have exactly 6 fields: id, phase, phase_name, learnings, errors_encountered, timestamp
- Retention limits: phase_learnings 20, decisions 30, events 100
- Box-drawing headers preserved in continue.md
- No existing functionality broken in any file
</verification>

<success_criteria>
- continue.md extracts specific learnings from completed phase data
- continue.md writes learnings_extracted and phase_advanced events
- focus.md, redirect.md, feedback.md log decisions to memory.json
- All three pheromone commands write pheromone_emitted events to events.json
- Retention limits enforced across all files
- All existing command functionality preserved
- Step counts correct: continue=7, focus/redirect/feedback=6
</success_criteria>

<output>
After completion, create `.planning/phases/15-infrastructure-state/15-03-SUMMARY.md`
</output>
