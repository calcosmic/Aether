---
phase: 15-infrastructure-state
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "When build encounters a failure, the error is recorded in errors.json with category, severity, description, root_cause, phase, task_id, timestamp"
    - "After 3 errors of the same category accumulate, the pattern is flagged in errors.json flagged_patterns array"
    - "Build writes a phase_started event to events.json when it sets state to EXECUTING"
    - "Build writes a phase_completed or phase_failed event to events.json after recording outcome"
    - "Build writes error_logged events when errors are appended"
    - "Build writes pattern_flagged events when patterns are detected"
    - "errors.json never exceeds 50 error entries (oldest trimmed)"
    - "events.json never exceeds 100 event entries (oldest trimmed)"
  artifacts:
    - path: ".claude/commands/ant/build.md"
      provides: "Error logging, pattern flagging, and event writing"
      contains: "errors.json"
  key_links:
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/errors.json"
      via: "Read + Write in Step 6"
      pattern: "errors\\.json"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/data/events.json"
      via: "Read + Write in Steps 4 and 6"
      pattern: "events\\.json"
---

<objective>
Integrate error logging, pattern flagging, and event writing into build.md.

Purpose: When builds encounter failures, errors are captured in structured records that enable pattern detection (3+ occurrences of same category triggers a flag). Events create an audit trail of phase execution for workers and the dashboard. This is the core error tracking and event logging for the colony.

Output: Modified build.md with error/event reads in Step 2, phase_started event in Step 4, and error logging + pattern flagging + event writing in Step 6.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-infrastructure-state/15-RESEARCH.md
@.claude/commands/ant/build.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state file reads and phase_started event to build.md</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify `.claude/commands/ant/build.md` Steps 2 and 4.

**Step 2: Read State** -- Add two files to the parallel Read calls:
- `.aether/data/errors.json`
- `.aether/data/events.json`

The step should now read 5 files in parallel: COLONY_STATE.json, pheromones.json, PROJECT_PLAN.json, errors.json, events.json. Keep all existing validation logic unchanged.

**Step 4: Update State** -- After the existing logic (set state to EXECUTING, set phase to in_progress), add event writing:

```markdown
Read `.aether/data/events.json` (if not already in memory from Step 2). Append to the `events` array:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "phase_started",
  "source": "build",
  "content": "Phase <id>: <name> started",
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `events` array exceeds 100 entries, remove the oldest entries to keep only 100.

Use the Write tool to write the updated events.json.
```

Do NOT change Steps 1, 3, 5, or 7. Step numbering stays the same (7 steps).
  </action>
  <verify>
Read build.md and verify:
1. Step 2 reads 5 files (COLONY_STATE.json, pheromones.json, PROJECT_PLAN.json, errors.json, events.json)
2. Step 4 writes a phase_started event to events.json after setting state to EXECUTING
3. Steps 1, 3, 5, 7 are unchanged
4. Step numbering is still 1-7
  </verify>
  <done>build.md Step 2 reads errors.json and events.json. Step 4 writes phase_started event.</done>
</task>

<task type="auto">
  <name>Task 2: Add error logging, pattern flagging, and outcome events to build.md Step 6</name>
  <files>.claude/commands/ant/build.md</files>
  <action>
Modify `.claude/commands/ant/build.md` Step 6 (Record Outcome). Keep existing logic (update PROJECT_PLAN.json, update COLONY_STATE.json) and add error logging, pattern flagging, and event writing AFTER the existing logic.

Add the following sections to Step 6, after the existing COLONY_STATE.json update:

```markdown
**Log Errors:** If the ant reported any failures or issues in its report:

Read `.aether/data/errors.json`. For each failure, append an error record to the `errors` array:

```json
{
  "id": "err_<unix_timestamp>_<4_random_hex>",
  "category": "<one of: syntax, import, runtime, type, spawning, phase, verification, api, file, logic, performance, security>",
  "severity": "<one of: critical, high, medium, low>",
  "description": "<what went wrong>",
  "root_cause": "<why it happened, if apparent from the ant's report>",
  "phase": <phase_number>,
  "task_id": "<task_id if applicable, otherwise null>",
  "timestamp": "<ISO-8601 UTC>"
}
```

**Check Pattern Flagging:** Count errors in the `errors` array by `category`. If any category has 3 or more errors and is not already in `flagged_patterns`, add:

```json
{
  "category": "<the category>",
  "count": <total count>,
  "first_seen": "<timestamp of earliest error in this category>",
  "last_seen": "<timestamp of latest error in this category>",
  "flagged_at": "<current ISO-8601 UTC>",
  "description": "Recurring <category> errors -- <count> occurrences detected"
}
```

If the category already exists in `flagged_patterns`, update its `count`, `last_seen`, and `description`.

If the `errors` array exceeds 50 entries, remove the oldest entries to keep only 50.

Use the Write tool to write the updated errors.json.

For each error logged, also append an `error_logged` event to events.json:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "error_logged",
  "source": "build",
  "content": "<category>/<severity>: <description>",
  "timestamp": "<ISO-8601 UTC>"
}
```

For each newly flagged pattern, append a `pattern_flagged` event:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "pattern_flagged",
  "source": "build",
  "content": "Pattern flagged: <category> errors -- <count> occurrences",
  "timestamp": "<ISO-8601 UTC>"
}
```

**Write Outcome Event:** Append to events.json:

```json
{
  "id": "evt_<unix_timestamp>_<4_random_hex>",
  "type": "<phase_completed or phase_failed>",
  "source": "build",
  "content": "Phase <id>: <name> <completed|failed> (<completed_count>/<total_count> tasks done)",
  "timestamp": "<ISO-8601 UTC>"
}
```

If the `events` array exceeds 100 entries, remove the oldest entries to keep only 100.

Use the Write tool to write the updated events.json.
```

IMPORTANT: Keep all existing Step 6 content (PROJECT_PLAN.json update, COLONY_STATE.json update). The error/event logic is APPENDED, not replacing.

Do NOT change the Step 7 display or step progress -- it remains 7 steps with the same names.
  </action>
  <verify>
Read build.md and verify:
1. Step 6 still updates PROJECT_PLAN.json and COLONY_STATE.json (existing logic preserved)
2. Step 6 now includes error logging with the 7-field error record schema (id, category, severity, description, root_cause, phase, task_id, timestamp)
3. Step 6 includes pattern flagging logic (count by category, flag at 3+, update existing patterns)
4. Step 6 includes 50-entry retention limit for errors
5. Step 6 writes error_logged, pattern_flagged, phase_completed/phase_failed events
6. Step 6 includes 100-entry retention limit for events
7. Error categories list matches research (12 categories)
8. build.md is approximately 260 lines total
9. Step 7 step progress is unchanged (still 7 steps)
  </verify>
  <done>build.md Step 6 logs errors to errors.json, flags patterns at 3+ occurrences, writes error_logged/pattern_flagged/phase_completed/phase_failed events to events.json. Retention limits enforced (50 errors, 100 events).</done>
</task>

</tasks>

<verification>
- Read the full modified `.claude/commands/ant/build.md`
- Confirm Step 2 reads 5 files
- Confirm Step 4 writes phase_started event
- Confirm Step 6 has: existing PROJECT_PLAN + COLONY_STATE updates, error logging, pattern flagging, event writing
- Confirm error record has exactly 8 fields: id, category, severity, description, root_cause, phase, task_id, timestamp
- Confirm pattern flag record has 6 fields: category, count, first_seen, last_seen, flagged_at, description
- Confirm retention limits: 50 errors, 100 events
- Confirm 12 error categories listed: syntax, import, runtime, type, spawning, phase, verification, api, file, logic, performance, security
- Confirm 4 event types written: phase_started, error_logged, pattern_flagged, phase_completed/phase_failed
- Confirm all event records have exactly 5 fields: id, type, source, content, timestamp
- Confirm step progress in Step 7 is unchanged
- Confirm file is approximately 250-270 lines
</verification>

<success_criteria>
- build.md reads errors.json and events.json at Step 2
- build.md writes phase_started event at Step 4
- build.md logs errors with correct 8-field schema at Step 6
- build.md flags patterns when category count reaches 3+
- build.md writes error_logged, pattern_flagged, phase_completed/phase_failed events
- Retention limits enforced (50 errors, 100 events)
- All existing build functionality preserved (validate, pheromones, spawn, display)
- Step count and progress display unchanged (7 steps)
</success_criteria>

<output>
After completion, create `.planning/phases/15-infrastructure-state/15-02-SUMMARY.md`
</output>
