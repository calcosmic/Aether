---
phase: 08-colony-learning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .aether/utils/bayesian-confidence.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Bayesian confidence library exists with alpha/beta calculation functions"
    - "Confidence calculation uses bc for floating-point precision (scale=6)"
    - "Beta distribution prior starts at alpha=1, beta=1 (confidence=0.5)"
    - "Sample size weighting prevents overconfidence from small samples"
    - "Functions exported for use by spawn-outcome-tracker.sh"
  artifacts:
    - path: ".aether/utils/bayesian-confidence.sh"
      provides: "Beta distribution confidence calculation library"
      min_lines: 150
      exports: ["update_bayesian_parameters", "calculate_confidence", "calculate_weighted_confidence", "get_confidence_stats"]
  key_links:
    - from: ".aether/utils/bayesian-confidence.sh"
      to: "bc command"
      via: "Floating-point arithmetic with scale=6"
      pattern: "echo \"scale=6.*\" | bc"
    - from: ".aether/utils/bayesian-confidence.sh"
      to: ".aether/utils/spawn-outcome-tracker.sh"
      via: "Source and function export"
      pattern: "source .aether/utils/bayesian-confidence.sh"
---

<objective>
Create Bayesian confidence calculation library using Beta distribution for statistically sound confidence scoring

Purpose: Replace Phase 6's heuristic +0.1/-0.15 arithmetic with mathematically principled Bayesian inference. Beta(α,β) distribution prevents overconfidence from small samples and provides natural asymmetric penalty (failures hurt more than successes help).

Output: bayesian-confidence.sh library with alpha/beta parameter updating, confidence calculation, and sample size weighting
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-colony-learning/08-RESEARCH.md
@.planning/STATE.md
@.planning/ROADMAP.md

@.aether/utils/spawn-outcome-tracker.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Bayesian confidence library with Beta distribution</name>
  <files>.aether/utils/bayesian-confidence.sh</files>
  <action>
Create new file .aether/utils/bayesian-confidence.sh with the following functions:

1. **update_bayesian_parameters(alpha, beta, outcome)**
   - Returns new alpha/beta based on outcome
   - Success: alpha_new = alpha + 1, beta_new = beta
   - Failure: alpha_new = alpha, beta_new = beta + 1
   - Uses bc for arithmetic

2. **calculate_confidence(alpha, beta)**
   - Returns alpha / (alpha + beta)
   - Uses bc with scale=6 for 6 decimal precision
   - Formula: echo "scale=6; $alpha / ($alpha + $beta)" | bc

3. **calculate_weighted_confidence(alpha, beta)**
   - Calculates raw confidence first
   - Calculates sample size weight: weight = min(1.0, (alpha + beta - 2) / 10)
   - Applies weighting: weighted = raw * (0.5 + 0.5 * weight)
   - Prevents overconfidence from small samples
   - Uses bc for all calculations

4. **get_confidence_stats(alpha, beta)**
   - Returns JSON object with:
     - alpha, beta (counts)
     - confidence (raw, not weighted)
     - weighted_confidence (with sample size adjustment)
     - total_spawns (alpha + beta - 2)
     - successful_spawns (alpha - 1)
     - failed_spawns (beta - 1)
     - sample_size_weight (0.0 to 1.0)

5. **initialize_bayesian_prior()**
   - Returns JSON string: {"alpha": 1, "beta": 1, "confidence": 0.5}
   - Beta(1,1) represents uniform prior (no prior knowledge)

**File structure:**
- Shebang: #!/bin/bash
- Source atomic-write.sh and file-lock.sh using AETHER_ROOT detection
- Configuration: COLONY_STATE_FILE path
- Comments explaining Beta distribution Bayesian inference
- All functions exported at bottom
- Constants: PRIOR_ALPHA=1, PRIOR_BETA=1, MIN_SAMPLES_FOR_WEIGHT=10, BC_SCALE=6

**IMPORTANT:**
- Use bc for ALL floating-point arithmetic (bash doesn't support floats natively)
- Always use scale=6 for 6 decimal precision
- Use awk for comparisons (bc doesn't have ternary operator)
- Follow atomic-write pattern from Phase 1
- Use file locking for concurrent operations
  </action>
  <verify>
Check file exists and has correct structure:
```bash
test -f .aether/utils/bayesian-confidence.sh
source .aether/utils/bayesian-confidence.sh
declare -f update_bayesian_parameters
declare -f calculate_confidence
declare -f calculate_weighted_confidence
declare -f get_confidence_stats
declare -f initialize_bayesian_prior
```

Test Beta distribution calculations:
```bash
# Test 1: Prior (alpha=1, beta=1) → confidence=0.5
result=$(calculate_confidence 1 1)
[[ "$result" == "0.500000" ]]

# Test 2: After 1 success (alpha=2, beta=1) → confidence=0.666667
result=$(calculate_confidence 2 1)
[[ "$result" == "0.666667" ]]

# Test 3: After 1 failure (alpha=1, beta=2) → confidence=0.333333
result=$(calculate_confidence 1 2)
[[ "$result" == "0.333333" ]]

# Test 4: Sample size weighting (1 sample → low weight)
result=$(calculate_weighted_confidence 2 1)
# Raw=0.666667, weight=0.1, weighted≈0.37
```
  </verify>
  <done>
All functions declared and exported. Beta distribution calculations produce correct values with 6 decimal precision. Sample size weighting reduces confidence for small samples (n<10).
  </done>
</task>

</tasks>

<verification>
1. bayesian-confidence.sh exists in .aether/utils/
2. All 5 functions are defined and exported
3. Beta distribution calculations are mathematically correct (α/(α+β))
4. bc is used for all floating-point arithmetic with scale=6
5. Sample size weighting prevents overconfidence (weighted < raw for n<10)
6. Prior initialization returns alpha=1, beta=1, confidence=0.5
</verification>

<success_criteria>
Bayesian confidence library is ready for integration. Functions calculate confidence using Beta distribution formula, handle sample size weighting, and prepare for integration with spawn-outcome-tracker.sh.
</success_criteria>

<output>
After completion, create `.planning/phases/08-colony-learning/08-01-SUMMARY.md`
</output>
