---
phase: 08-colony-learning
plan: 04
type: execute
wave: 4
depends_on: [08-01, 08-02, 08-03]
files_modified:
  - .aether/utils/test-bayesian-learning.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Test suite verifies Bayesian confidence calculations are correct"
    - "Test suite verifies alpha/beta updating after successes and failures"
    - "Test suite verifies sample size weighting prevents overconfidence"
    - "Test suite verifies specialist recommendation uses confidence scores"
    - "All tests pass (100% pass rate)"
    - "Test report documents Bayesian behavior vs Phase 6 simple arithmetic"
  artifacts:
    - path: ".aether/utils/test-bayesian-learning.sh"
      provides: "Comprehensive test suite for Bayesian meta-learning"
      min_lines: 300
  key_links:
    - from: ".aether/utils/test-bayesian-learning.sh"
      to: ".aether/utils/bayesian-confidence.sh"
      via: "Source and function testing"
      pattern: "source .aether/utils/bayesian-confidence.sh"
    - from: ".aether/utils/test-bayesian-learning.sh"
      to: ".aether/utils/spawn-outcome-tracker.sh"
      via: "Spawn outcome recording testing"
      pattern: "record_successful_spawn|record_failed_spawn"
    - from: ".aether/utils/test-bayesian-learning.sh"
      to: ".aether/utils/spawn-decision.sh"
      via: "Specialist recommendation testing"
      pattern: "recommend_specialist_by_confidence"
---

<objective>
Create comprehensive test suite for Bayesian meta-learning system and verify all functionality

Purpose: Validate Bayesian confidence calculations, alpha/beta updating, sample size weighting, and specialist recommendation work correctly. Compare Phase 8 Bayesian approach to Phase 6 simple arithmetic to demonstrate improvements.

Output: test-bayesian-learning.sh test suite with 100% pass rate documenting Bayesian behavior
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-colony-learning/08-RESEARCH.md
@.planning/phases/08-colony-learning/08-01-SUMMARY.md
@.planning/phases/08-colony-learning/08-02-SUMMARY.md
@.planning/phases/08-colony-learning/08-03-SUMMARY.md
@.planning/STATE.md
@.planning/ROADMAP.md

@.aether/utils/bayesian-confidence.sh
@.aether/utils/spawn-outcome-tracker.sh
@.aether/utils/spawn-decision.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Bayesian meta-learning test suite</name>
  <files>.aether/utils/test-bayesian-learning.sh</files>
  <action>
Create .aether/utils/test-bayesian-learning.sh with comprehensive test coverage:

**Test suite structure:**

```bash
#!/bin/bash
# Aether Bayesian Meta-Learning Test Suite
# Tests Beta distribution confidence scoring and specialist recommendation
#
# Usage:
#   .aether/utils/test-bayesian-learning.sh

# Find Aether root
AETHER_ROOT="${AETHER_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)}"

# Source libraries
source "${AETHER_ROOT}/.aether/utils/bayesian-confidence.sh"
source "${AETHER_ROOT}/.aether/utils/spawn-outcome-tracker.sh"
source "${AETHER_ROOT}/.aether/utils/spawn-decision.sh"

# Test counters
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

# Test helper functions
assert_equals() {
    local expected="$1"
    local actual="$2"
    local message="$3"

    TESTS_RUN=$((TESTS_RUN + 1))

    if [ "$expected" == "$actual" ]; then
        TESTS_PASSED=$((TESTS_PASSED + 1))
        echo "  ✓ PASS: $message"
    else
        TESTS_FAILED=$((TESTS_FAILED + 1))
        echo "  ✗ FAIL: $message"
        echo "    Expected: $expected"
        echo "    Got: $actual"
    fi
}

assert_float_equals() {
    local expected="$1"
    local actual="$2"
    local tolerance="${3:-0.000001}"  # Default tolerance: 6 decimal places
    local message="$4"

    TESTS_RUN=$((TESTS_RUN + 1))

    local diff=$(echo "scale=10; $actual - $expected" | bc | tr -d '-')
    local passed=$(echo "$diff < $tolerance" | bc)

    if [ "$passed" -eq 1 ]; then
        TESTS_PASSED=$((TESTS_PASSED + 1))
        echo "  ✓ PASS: $message"
    else
        TESTS_FAILED=$((TESTS_FAILED + 1))
        echo "  ✗ FAIL: $message"
        echo "    Expected: $expected (±$tolerance)"
        echo "    Got: $actual (diff: $diff)"
    fi
}

assert_greater_than() {
    local threshold="$1"
    local value="$2"
    local message="$3"

    TESTS_RUN=$((TESTS_RUN + 1))

    local result=$(echo "$value > $threshold" | bc)
    if [ "$result" -eq 1 ]; then
        TESTS_PASSED=$((TESTS_PASSED + 1))
        echo "  ✓ PASS: $message"
    else
        TESTS_FAILED=$((TESTS_FAILED + 1))
        echo "  ✗ FAIL: $message"
        echo "    Expected: $value > $threshold"
    fi
}

# Test suites
test_beta_distribution_calculations() {
    echo "=== Test Suite 1: Beta Distribution Calculations ==="

    # Test 1.1: Prior (alpha=1, beta=1) → confidence=0.5
    local confidence=$(calculate_confidence 1 1)
    assert_float_equals "0.500000" "$confidence" "0.000001" "Prior confidence = 0.5"

    # Test 1.2: After 1 success (alpha=2, beta=1) → confidence=0.666667
    confidence=$(calculate_confidence 2 1)
    assert_float_equals "0.666667" "$confidence" "0.000001" "After 1 success, confidence = 0.666667"

    # Test 1.3: After 1 failure (alpha=1, beta=2) → confidence=0.333333
    confidence=$(calculate_confidence 1 2)
    assert_float_equals "0.333333" "$confidence" "0.000001" "After 1 failure, confidence = 0.333333"

    # Test 1.4: After 10 successes (alpha=11, beta=1) → confidence=0.916667
    confidence=$(calculate_confidence 11 1)
    assert_float_equals "0.916667" "$confidence" "0.000001" "After 10 successes, confidence = 0.916667"

    # Test 1.5: Asymmetric penalty: success boost < failure drop
    local success_boost=$(echo "0.666667 - 0.5" | bc)
    local failure_drop=$(echo "0.5 - 0.333333" | bc)
    assert_greater_than "$failure_drop" "$success_boost" "Failure impact > success impact (asymmetric)"
}

test_sample_size_weighting() {
    echo ""
    echo "=== Test Suite 2: Sample Size Weighting ==="

    # Test 2.1: 1 sample → low weight (0.1)
    local weighted=$(calculate_weighted_confidence 2 1)
    # raw=0.666667, weight=0.1, weighted≈0.37
    assert_greater_than "0.3" "$weighted" "Weighted confidence > 0.3 for 1 sample"
    assert_greater_than "$weighted" "0.5" "Weighted confidence < 0.5 for 1 sample"

    # Test 2.2: 10 samples → full weight (1.0)
    weighted=$(calculate_weighted_confidence 11 1)
    # raw=0.916667, weight=1.0, weighted≈0.92
    local raw=$(calculate_confidence 11 1)
    local diff=$(echo "scale=6; $weighted - $raw" | bc | tr -d '-')
    assert_greater_than "0.01" "$diff" "Weighted ≈ raw for 10+ samples"

    # Test 2.3: Weighted confidence prevents overconfidence
    weighted=$(calculate_weighted_confidence 2 1)  # 1 success
    assert_greater_than "0.3" "$weighted" "Small sample has moderate weighted confidence"
    assert_greater_than "$weighted" "0.7" "Small sample weighted < 0.7"
}

test_alpha_beta_updating() {
    echo ""
    echo "=== Test Suite 3: Alpha/Beta Updating ==="

    # Test 3.1: Success increments alpha
    local new_alpha=$(update_bayesian_parameters 1 1 "success")
    assert_equals "2" "$new_alpha" "Success increments alpha from 1 to 2"

    # Test 3.2: Failure increments beta
    local new_beta=$(update_bayesian_parameters 1 1 "failure")
    assert_equals "2" "$new_beta" "Failure increments beta from 1 to 2"

    # Test 3.3: Multiple outcomes accumulate correctly
    new_alpha=$(update_bayesian_parameters 2 1 "success")
    assert_equals "3" "$new_alpha" "Second success increments alpha from 2 to 3"
}

test_spawn_outcome_recording() {
    echo ""
    echo "=== Test Suite 4: Spawn Outcome Recording ==="

    # Backup COLONY_STATE.json
    cp "${AETHER_ROOT}/.aether/data/COLONY_STATE.json" "${AETHER_ROOT}/.aether/data/COLONY_STATE.json.test_backup"

    # Test 4.1: Record successful spawn updates alpha
    record_successful_spawn "test_specialist" "test_task" "test_spawn_1"
    local alpha=$(jq -r '.meta_learning.specialist_confidence.test_specialist.test_task.alpha' "${AETHER_ROOT}/.aether/data/COLONY_STATE.json")
    assert_equals "2" "$alpha" "Successful spawn increments alpha to 2"

    # Test 4.2: Record failed spawn updates beta
    record_failed_spawn "test_specialist" "test_task" "test_spawn_2" "Test failure"
    local beta=$(jq -r '.meta_learning.specialist_confidence.test_specialist.test_task.beta' "${AETHER_ROOT}/.aether/data/COLONY_STATE.json")
    assert_equals "2" "$beta" "Failed spawn increments beta to 2"

    # Test 4.3: Confidence recalculated after outcome
    local confidence=$(jq -r '.meta_learning.specialist_confidence.test_specialist.test_task.confidence' "${AETHER_ROOT}/.aether/data/COLONY_STATE.json")
    assert_float_equals "0.500000" "$confidence" "0.000001" "Confidence = 0.5 after 1 success, 1 failure"

    # Test 4.4: Spawn outcomes logged
    local outcome_count=$(jq -r '[.meta_learning.spawn_outcomes[] | select(.specialist == "test_specialist")] | length' "${AETHER_ROOT}/.aether/data/COLONY_STATE.json")
    assert_greater_than "1" "$outcome_count" "Spawn outcomes logged in history"

    # Restore COLONY_STATE.json
    mv "${AETHER_ROOT}/.aether/data/COLONY_STATE.json.test_backup" "${AETHER_ROOT}/.aether/data/COLONY_STATE.json"
}

test_specialist_recommendation() {
    echo ""
    echo "=== Test Suite 5: Specialist Recommendation ==="

    # Backup COLONY_STATE.json
    cp "${AETHER_ROOT}/.aether/data/COLONY_STATE.json" "${AETHER_ROOT}/.aether/data/COLONY_STATE.json.test_backup"

    # Set up test data: specialist_a has high confidence, specialist_b has low
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    jq "
        .meta_learning.specialist_confidence.specialist_a.database = {
            \"alpha\": 10,
            \"beta\": 2,
            \"confidence\": 0.833333,
            \"total_spawns\": 10,
            \"successful_spawns\": 9,
            \"failed_spawns\": 1,
            \"last_updated\": \"$timestamp\"
        } |
        .meta_learning.specialist_confidence.specialist_b.database = {
            \"alpha\": 3,
            \"beta\": 5,
            \"confidence\": 0.375000,
            \"total_spawns\": 6,
            \"successful_spawns\": 2,
            \"failed_spawns\": 4,
            \"last_updated\": \"$timestamp\"
        }
    " "${AETHER_ROOT}/.aether/data/COLONY_STATE.json" | atomic_write "${AETHER_ROOT}/.aether/data/COLONY_STATE.json"

    # Test 5.1: Recommend highest confidence specialist
    local recommendation=$(recommend_specialist_by_confidence "database" 0.7 5)
    local specialist=$(echo "$recommendation" | cut -d'|' -f1)
    local confidence=$(echo "$recommendation" | cut -d'|' -f2)
    assert_equals "specialist_a" "$specialist" "Recommends specialist_a (higher confidence)"
    assert_float_equals "0.833333" "$confidence" "0.000001" "Recommended confidence matches specialist_a"

    # Test 5.2: No recommendation if below threshold
    recommendation=$(recommend_specialist_by_confidence "database" 0.9 5)
    specialist=$(echo "$recommendation" | cut -d'|' -f1)
    assert_equals "none" "$specialist" "No recommendation when confidence < threshold"

    # Test 5.3: No recommendation if insufficient samples
    recommendation=$(recommend_specialist_by_confidence "database" 0.7 20)
    specialist=$(echo "$recommendation" | cut -d'|' -f1)
    assert_equals "none" "$specialist" "No recommendation when samples < minimum"

    # Restore COLONY_STATE.json
    mv "${AETHER_ROOT}/.aether/data/COLONY_STATE.json.test_backup" "${AETHER_ROOT}/.aether/data/COLONY_STATE.json"
}

test_phase_8_vs_phase_6_comparison() {
    echo ""
    echo "=== Test Suite 6: Phase 8 Bayesian vs Phase 6 Simple Arithmetic ==="

    # Test 6.1: Phase 6: 1 success → confidence = 0.5 + 0.1 = 0.6
    local phase_6_confidence=$(echo "0.5 + 0.1" | bc)
    assert_float_equals "0.600000" "$phase_6_confidence" "0.000001" "Phase 6: 1 success → 0.6"

    # Test 6.2: Phase 8: 1 success → confidence = 2/(2+1) = 0.666667
    local phase_8_confidence=$(calculate_confidence 2 1)
    assert_float_equals "0.666667" "$phase_8_confidence" "0.000001" "Phase 8: 1 success → 0.666667"

    # Test 6.3: Phase 8 more conservative for small samples (with weighting)
    local weighted=$(calculate_weighted_confidence 2 1)
    assert_greater_than "$phase_8_confidence" "$weighted" "Weighted confidence < raw confidence for small samples"

    # Test 6.4: Asymmetric penalty comparison
    # Phase 6: failure = 0.5 - 0.15 = 0.35
    phase_6_confidence=$(echo "0.5 - 0.15" | bc)
    # Phase 8: 1 failure → 1/(1+2) = 0.333333
    phase_8_confidence=$(calculate_confidence 1 2)
    echo "  ℹ INFO: Phase 6 failure penalty: 0.5 → 0.35 (-0.15)"
    echo "  ℹ INFO: Phase 8 failure penalty: 0.5 → 0.333333 (automatic asymmetry)"
}

# Run all tests
main() {
    echo "====================================="
    echo "Aether Bayesian Meta-Learning Tests"
    echo "====================================="
    echo ""

    test_beta_distribution_calculations
    test_sample_size_weighting
    test_alpha_beta_updating
    test_spawn_outcome_recording
    test_specialist_recommendation
    test_phase_8_vs_phase_6_comparison

    echo ""
    echo "====================================="
    echo "Test Results"
    echo "====================================="
    echo "Tests Run: $TESTS_RUN"
    echo "Tests Passed: $TESTS_PASSED"
    echo "Tests Failed: $TESTS_FAILED"
    echo "Pass Rate: $(echo "scale=2; $TESTS_PASSED * 100 / $TESTS_RUN" | bc)%"
    echo ""

    if [ $TESTS_FAILED -eq 0 ]; then
        echo "✓ All tests passed!"
        exit 0
    else
        echo "✗ Some tests failed"
        exit 1
    fi
}

# Run main if script is executed directly
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
```

**IMPORTANT:**
- Use atomic-write.sh for COLONY_STATE.json test modifications
- Backup/restore COLONY_STATE.json in tests that modify it
- Test Phase 8 vs Phase 6 behavior to document improvements
- Include informational output explaining Bayesian advantages
- All tests should be idempotent (can run multiple times)
  </action>
  <verify>
Run test suite:
```bash
chmod +x .aether/utils/test-bayesian-learning.sh
.aether/utils/test-bayesian-learning.sh
```

Expected output:
- All 6 test suites run
- Pass rate: 100%
- Final message: "✓ All tests passed!"
- Exit code: 0
  </verify>
  <done>
test-bayesian-learning.sh created with 6 test suites covering Beta distribution calculations, sample size weighting, alpha/beta updating, spawn outcome recording, specialist recommendation, and Phase 8 vs Phase 6 comparison. All tests pass (100% pass rate).
  </done>
</task>

</tasks>

<verification>
1. test-bayesian-learning.sh exists in .aether/utils/
2. Test suite sources bayesian-confidence.sh, spawn-outcome-tracker.sh, spawn-decision.sh
3. 6 test suites cover all Bayesian functionality
4. All tests pass (100% pass rate)
5. Test output documents Phase 8 Bayesian advantages vs Phase 6 simple arithmetic
6. Tests are idempotent (backup/restore COLONY_STATE.json)
7. Exit code 0 on success, 1 on failure
</verification>

<success_criteria>
Bayesian meta-learning system fully tested and verified. Test suite validates Beta distribution calculations, alpha/beta updating, sample size weighting, specialist recommendation, and demonstrates improvements over Phase 6 approach.
</success_criteria>

<output>
After completion, create `.planning/phases/08-colony-learning/08-04-SUMMARY.md`
</output>
