---
phase: 08-colony-learning
plan: 03
type: execute
wave: 3
depends_on: [08-02]
files_modified:
  - .aether/utils/spawn-decision.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "spawn-decision.sh uses Bayesian confidence for specialist recommendation"
    - "recommend_specialist_by_confidence() finds highest confidence specialist for task type"
    - "Sample size weighting prevents over-reliance on sparse data (min 5 samples required)"
    - "map_gap_to_specialist() enhanced to consult meta-learning before falling back to semantic analysis"
    - "Confidence threshold (0.7) filters out low-confidence recommendations"
  artifacts:
    - path: ".aether/utils/spawn-decision.sh"
      provides: "Spawn decision logic with Bayesian confidence integration"
      min_lines: 400
      exports: ["recommend_specialist_by_confidence", "get_weighted_specialist_scores"]
  key_links:
    - from: ".aether/utils/spawn-decision.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq queries to meta_learning.specialist_confidence"
      pattern: "jq '.meta_learning.specialist_confidence.*.*'"
    - from: ".aether/utils/spawn-decision.sh"
      to: ".aether/utils/bayesian-confidence.sh"
      via: "Source and sample size weighting"
      pattern: "source .aether/utils/bayesian-confidence.sh"
    - from: ".aether/utils/spawn-decision.sh/map_gap_to_specialist"
      to: ".aether/utils/spawn-outcome-tracker.sh/get_specialist_confidence"
      via: "Function call for confidence-based ranking"
      pattern: "get_specialist_confidence|recommend_specialist_by_confidence"
---

<objective>
Integrate Bayesian confidence scoring into spawn-decision.sh for intelligent specialist recommendation

Purpose: Enhance specialist selection to prefer historically successful specialists for task types. Use Bayesian confidence scores with sample size weighting to avoid premature strong recommendations from sparse data.

Output: Enhanced spawn-decision.sh with recommend_specialist_by_confidence() and meta-learning integration in map_gap_to_specialist()
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-colony-learning/08-RESEARCH.md
@.planning/phases/08-colony-learning/08-02-SUMMARY.md
@.planning/STATE.md
@.planning/ROADMAP.md

@.aether/utils/spawn-decision.sh
@.aether/utils/spawn-outcome-tracker.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bayesian confidence recommendation functions to spawn-decision.sh</name>
  <files>.aether/utils/spawn-decision.sh</files>
  <action>
Add Bayesian confidence-based recommendation functions to .aether/utils/spawn-decision.sh:

**New functions to add:**

1. **recommend_specialist_by_confidence(task_type, min_confidence, min_samples)**
   - Find specialist with highest Bayesian confidence for task type
   - Filter by min_confidence (default 0.7) and min_samples (default 5)
   - Return "specialist_caste|confidence" or "none|0.0" if no confident recommendation
   - Use jq to query COLONY_STATE.json meta_learning.specialist_confidence

**Implementation:**
```bash
recommend_specialist_by_confidence() {
    local task_type="$1"
    local min_confidence="${2:-0.7}"  # Default 70%
    local min_samples="${3:-5}"        # Default 5 spawns

    # Find best specialist for this task type
    local best=$(jq -r "
        .meta_learning.specialist_confidence |
        to_entries[] |
        select(.value | has(\"$task_type\")) |
        select(.value.\"$task_type\".total_spawns >= $min_samples) |
        select(.value.\"$task_type\".confidence >= $min_confidence) |
        \"\(.key)|\(.value.\"$task_type\".confidence)\" |
        @csv
    " "$COLONY_STATE_FILE" | sort -t',' -k2 -nr | head -1)

    if [ -n "$best" ]; then
        local specialist=$(echo "$best" | cut -d',' -f1 | tr -d '"')
        local confidence=$(echo "$best" | cut -d',' -f2)
        echo "$specialist|$confidence"
    else
        echo "none|0.0"
    fi
}
```

2. **get_weighted_specialist_scores(task_type)**
   - Get all specialists with confidence scores for task type
   - Apply sample size weighting (using bayesian-confidence.sh)
   - Return ranked list with scores
   - Useful for debugging and alternative recommendation strategies

**Implementation:**
```bash
get_weighted_specialist_scores() {
    local task_type="$1"

    # Get all specialists with this task type
    jq -r "
        .meta_learning.specialist_confidence |
        to_entries[] |
        select(.value | has(\"$task_type\")) |
        \"\(.key)|\(.value.\"$task_type\".alpha)|\(.value.\"$task_type\".beta)|\(.value.\"$task_type\".confidence)|\(.value.\"$task_type\".total_spawns)\"
    " "$COLONY_STATE_FILE" | while IFS='|' read -r specialist alpha beta confidence total_spawns; do
        # Calculate sample size weight
        local weight=$(echo "scale=6; $total_spawns / 10" | bc)
        if (( $(echo "$weight > 1.0" | bc -l) )); then
            weight=1.0
        fi

        # Apply weighting: weighted = raw * (0.5 + 0.5 * weight)
        local weighted=$(echo "scale=6; $confidence * (0.5 + 0.5 * $weight)" | bc)

        echo "$specialist|$alpha|$beta|$confidence|$total_spawns|$weight|$weighted"
    done | sort -t'|' -k7 -nr  # Sort by weighted confidence descending
}
```

3. **Enhance map_gap_to_specialist()**:
   - Add meta-learning lookup BEFORE semantic analysis
   - Call recommend_specialist_by_confidence() for task type
   - If confident recommendation found, use it
   - Otherwise, fall back to existing semantic analysis

**Updated implementation:**
```bash
map_gap_to_specialist() {
    local gaps="$1"
    local task_description="$2"

    # Convert to lowercase for matching
    local task_lower=$(echo "$task_description" | tr '[:upper:]' '[:lower:]')

    # Determine primary task type from gaps
    local primary_task_type=""
    if [ -n "$gaps" ]; then
        primary_task_type=$(echo "$gaps" | jq -r '.[0]' 2>/dev/null || echo "general")
    else
        primary_task_type="general"
    fi

    # Try Bayesian meta-learning recommendation first
    local meta_learning_result=$(recommend_specialist_by_confidence "$primary_task_type" 0.7 5)
    local specialist_caste=$(echo "$meta_learning_result" | cut -d'|' -f1)
    local confidence=$(echo "$meta_learning_result" | cut -d'|' -f2)

    if [ "$specialist_caste" != "none" ] && (( $(echo "$confidence >= 0.7" | bc -l) )); then
        # Use meta-learning recommendation
        local specialization="$primary_task_type specialist (confidence: $confidence)"
        # Build result JSON
        local result=$(jq -n \
            --arg caste "$specialist_caste" \
            --arg specialization "$specialization" \
            --argjson confidence "$confidence" \
            --arg source "meta_learning" \
            '{caste: $caste, specialization: $specialization, confidence: $confidence, source: $source}')
        echo "$result"
        return 0
    fi

    # Fallback to semantic analysis (existing logic)
    # ... (rest of existing semantic analysis code) ...

    # Add source="semantic_analysis" to result JSON
    local result=$(jq -n \
        --arg caste "$specialist_caste" \
        --arg specialization "$specialization" \
        --arg source "semantic_analysis" \
        '{caste: $caste, specialization: $specialization, source: $source}')

    echo "$result"
}
```

**Configuration constants to add:**
```bash
# Meta-learning configuration
MIN_CONFIDENCE_FOR_RECOMMENDATION=0.7  # 70%
MIN_SAMPLES_FOR_RECOMMENDATION=5
META_LEARNING_ENABLED=true
```

**IMPORTANT:**
- Source bayesian-confidence.sh for sample size weighting functions
- Keep existing semantic analysis as fallback
- Add source field to result JSON for debugging (meta_learning vs semantic_analysis)
- Update function documentation
- Export new functions
  </action>
  <verify>
Test Bayesian recommendation:
```bash
source .aether/utils/spawn-decision.sh

# Test 1: Recommend specialist for known task type
result=$(recommend_specialist_by_confidence "database" 0.7 5)
# Should return "specialist_caste|confidence" or "none|0.0"

# Test 2: Get weighted scores
get_weighted_specialist_scores "database"
# Should list all specialists with alpha/beta/confidence/weight/weighted

# Test 3: Map gap uses meta-learning first
gaps='["database"]'
task_desc="Database schema migration"
result=$(map_gap_to_specialist "$gaps" "$task_desc")
source=$(echo "$result" | jq -r '.source')
# If confidence >= 0.7 and samples >= 5, source should be "meta_learning"
# Otherwise source should be "semantic_analysis"
```
  </verify>
  <done>
spawn-decision.sh has Bayesian confidence recommendation. recommend_specialist_by_confidence() finds highest confidence specialist for task type. map_gap_to_specialist() consults meta-learning before semantic analysis. Sample size weighting and confidence thresholds prevent over-reliance on sparse data.
  </done>
</task>

</tasks>

<verification>
1. spawn-decision.sh sources bayesian-confidence.sh
2. recommend_specialist_by_confidence() function defined and exported
3. get_weighted_specialist_scores() function defined and exported
4. map_gap_to_specialist() calls recommend_specialist_by_confidence() before semantic analysis
5. Meta-learning recommendation requires min_confidence=0.7 and min_samples=5
6. Result JSON includes source field (meta_learning vs semantic_analysis)
7. Fallback to semantic analysis works when no confident recommendation
</verification>

<success_criteria>
Spawn decision logic uses Bayesian meta-learning for intelligent specialist selection. Colony prefers historically successful specialists for task types while avoiding premature strong recommendations from sparse data.
</success_criteria>

<output>
After completion, create `.planning/phases/08-colony-learning/08-03-SUMMARY.md`
</output>
