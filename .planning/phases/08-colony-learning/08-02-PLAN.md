---
phase: 08-colony-learning
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - .aether/data/COLONY_STATE.json
  - .aether/utils/spawn-outcome-tracker.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "COLONY_STATE.json meta_learning.specialist_confidence schema includes alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns"
    - "spawn-outcome-tracker.sh uses Bayesian alpha/beta updating instead of simple +0.1/-0.15 arithmetic"
    - "record_successful_spawn increments alpha, recalculates confidence via bayesian-confidence.sh"
    - "record_failed_spawn increments beta, recalculates confidence via bayesian-confidence.sh"
    - "get_specialist_confidence returns Bayesian confidence from COLONY_STATE.json"
    - "Function signatures unchanged (backward compatible with Phase 6)"
  artifacts:
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Meta-learning state storage with Bayesian parameters"
      contains: ".meta_learning.specialist_confidence.*.alpha"
      contains: ".meta_learning.specialist_confidence.*.beta"
    - path: ".aether/utils/spawn-outcome-tracker.sh"
      provides: "Enhanced spawn outcome tracking with Bayesian updating"
      min_lines: 250
  key_links:
    - from: ".aether/utils/spawn-outcome-tracker.sh"
      to: ".aether/utils/bayesian-confidence.sh"
      via: "Source and function calls"
      pattern: "source .aether/utils/bayesian-confidence.sh"
    - from: ".aether/utils/spawn-outcome-tracker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq updates with alpha/beta parameters"
      pattern: "jq \".meta_learning.specialist_confidence.* = {alpha:.*, beta:.*, confidence:.*}\""
---

<objective>
Update COLONY_STATE.json schema and enhance spawn-outcome-tracker.sh to use Bayesian Beta distribution confidence scoring

Purpose: Enhance Phase 6's simple confidence arithmetic with statistically principled Bayesian inference. Replace +0.1/-0.15 heuristic with alpha/beta parameter updating while maintaining backward compatibility (same function names).

Output: Updated COLONY_STATE.json schema with alpha/beta fields, enhanced spawn-outcome-tracker.sh using bayesian-confidence.sh
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-colony-learning/08-RESEARCH.md
@.planning/phases/08-colony-learning/08-01-SUMMARY.md
@.planning/STATE.md
@.planning/ROADMAP.md

@.aether/utils/bayesian-confidence.sh
@.aether/utils/spawn-outcome-tracker.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update COLONY_STATE.json meta_learning schema for Bayesian parameters</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
Update COLONY_STATE.json meta_learning.specialist_confidence schema to include Bayesian parameters:

**Current schema (Phase 6):**
```json
"specialist_confidence": {
  "database_specialist": {
    "database": 0.45
  }
}
```

**New schema (Phase 8):**
```json
"specialist_confidence": {
  "database_specialist": {
    "database": {
      "alpha": 1,
      "beta": 1,
      "confidence": 0.5,
      "total_spawns": 0,
      "successful_spawns": 0,
      "failed_spawns": 0,
      "last_updated": "2026-02-02T00:00:00Z"
    }
  }
}
```

**Migration strategy:**
1. Check if existing entries use old format (float instead of object)
2. If old format: migrate float confidence to alpha/beta estimate
   - confidence 0.5 → {alpha: 1, beta: 1}
   - confidence < 0.5 → estimate lower alpha (keep beta=1, solve for alpha)
   - confidence > 0.5 → estimate higher beta (keep alpha=1, solve for beta)
3. Update schema to new format
4. Add last_updated timestamp field

**jq migration command:**
```bash
jq '
  .meta_learning.specialist_confidence |= with_entries(
    .value |= with_entries(
      if (.value | type) == "number" then
        .value = {
          alpha: 1,
          beta: 1,
          confidence: .value,
          total_spawns: 0,
          successful_spawns: 0,
          failed_spawns: 0,
          last_updated: "2026-02-02T00:00:00Z"
        }
      else
        .
      end
    )
  )
' .aether/data/COLONY_STATE.json | atomic_write .aether/data/COLONY_STATE.json
```

**IMPORTANT:**
- Use atomic-write.sh for safe updates
- Handle both old and existing new formats
- Preserve existing data during migration
- Add comments explaining Bayesian parameters
  </action>
  <verify>
Check schema updated correctly:
```bash
# Verify specialist_confidence has nested structure
jq '.meta_learning.specialist_confidence.database_specialist.database | has("alpha")' .aether/data/COLONY_STATE.json
# Should return: true

# Verify all Bayesian fields present
jq '.meta_learning.specialist_confidence[][] | keys' .aether/data/COLONY_STATE.json
# Should include: alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns, last_updated

# Verify confidence calculation
alpha=$(jq '.meta_learning.specialist_confidence.database_specialist.database.alpha' .aether/data/COLONY_STATE.json)
beta=$(jq '.meta_learning.specialist_confidence.database_specialist.database.beta' .aether/data/COLONY_STATE.json)
confidence=$(echo "scale=6; $alpha / ($alpha + $beta)" | bc)
jq_confidence=$(jq '.meta_learning.specialist_confidence.database_specialist.database.confidence' .aether/data/COLONY_STATE.json)
# $confidence should match $jq_confidence
```
  </verify>
  <done>
COLONY_STATE.json meta_learning.specialist_confidence uses new Bayesian schema with alpha/beta parameters. Old float entries migrated to object format. All entries include alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns, last_updated fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance spawn-outcome-tracker.sh with Bayesian updating</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Enhance .aether/utils/spawn-outcome-tracker.sh to use Bayesian alpha/beta updating:

**Changes:**

1. **Source bayesian-confidence.sh** (after file-lock.sh sourcing):
```bash
# Source Bayesian confidence library
if [ -f "$AETHER_ROOT/.aether/utils/bayesian-confidence.sh" ]; then
    source "$AETHER_ROOT/.aether/utils/bayesian-confidence.sh"
else
    source ".aether/utils/bayesian-confidence.sh"
fi
```

2. **Update record_successful_spawn()**:
   - Get current alpha/beta (default to 1,1 if not exists)
   - Use update_bayesian_parameters() to increment alpha
   - Use calculate_confidence() to get new confidence
   - Update COLONY_STATE.json with full Bayesian object
   - Keep function signature unchanged (backward compatible)

**New implementation:**
```bash
record_successful_spawn() {
    local specialist_type="$1"
    local task_type="$2"
    local spawn_id="$3"

    # Acquire lock
    if ! acquire_lock "$LOCK_FILE"; then
        echo "Cannot acquire lock to record successful spawn" >&2
        return 1
    fi

    local timestamp=$(get_timestamp)

    # Get current alpha/beta (default to prior 1,1)
    local current=$(jq -r "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\"
        // {\"alpha\": 1, \"beta\": 1, \"confidence\": 0.5}
    " "$COLONY_STATE_FILE")

    local alpha=$(echo "$current" | jq -r '.alpha // 1')
    local beta=$(echo "$current" | jq -r '.beta // 1')

    # Update Bayesian parameters: increment alpha for success
    local new_alpha=$(update_bayesian_parameters "$alpha" "$beta" "success")
    local new_beta=$beta

    # Calculate new confidence
    local new_confidence=$(calculate_confidence "$new_alpha" "$new_beta")

    # Calculate derived stats
    local total_spawns=$(echo "$new_alpha + $new_beta - 2" | bc)
    local successful_spawns=$(echo "$new_alpha - 1" | bc)
    local failed_spawns=$(echo "$new_beta - 1" | bc)

    # Update state atomically with full Bayesian object
    local updated_state
    updated_state=$(jq "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\" = {
            \"alpha\": $new_alpha,
            \"beta\": $new_beta,
            \"confidence\": $new_confidence,
            \"total_spawns\": $total_spawns,
            \"successful_spawns\": $successful_spawns,
            \"failed_spawns\": $failed_spawns,
            \"last_updated\": \"$timestamp\"
        } |
        .meta_learning.spawn_outcomes += [{
            \"spawn_id\": \"$spawn_id\",
            \"specialist\": \"$specialist_type\",
            \"task_type\": \"$task_type\",
            \"outcome\": \"success\",
            \"timestamp\": \"$timestamp\"
        }] |
        .meta_learning.last_updated = \"$timestamp\"
    " "$COLONY_STATE_FILE")

    if ! atomic_write "$COLONY_STATE_FILE" "$updated_state"; then
        echo "Failed to record successful spawn" >&2
        release_lock
        return 1
    fi

    # Release lock
    release_lock

    return 0
}
```

3. **Update record_failed_spawn()** similarly (increment beta, not alpha)

4. **Update get_specialist_confidence()**:
   - Read confidence from Bayesian object
   - Return confidence value (or full object if requested)

5. **Update get_meta_learning_stats()**:
   - Display alpha/beta for each specialist-task pairing
   - Show total_spawns, successful_spawns, failed_spawns
   - Format: "database_specialist → database: α=2, β=1, confidence=0.67, total=1, successes=1, failures=0"

6. **Remove old constants** (SUCCESS_INCREMENT, FAILURE_DECREMENT):
   - No longer needed (Bayesian updating handles asymmetry automatically)
   - Keep DEFAULT_CONFIDENCE=0.5 (matches prior)
   - Keep MAX/MIN confidence constants (for display/comparison only)

**IMPORTANT:**
- Keep function names and signatures unchanged (backward compatible)
- Use bayesian-confidence.sh functions for calculations
- Maintain file locking and atomic write patterns
- Update comments to explain Bayesian approach
- Add "Enhanced with Bayesian Beta distribution" comment at top
  </action>
  <verify>
Test enhanced functions:
```bash
source .aether/utils/spawn-outcome-tracker.sh

# Test 1: Record successful spawn increments alpha
record_successful_spawn "database_specialist" "database" "test_spawn_1"
alpha=$(jq '.meta_learning.specialist_confidence.database_specialist.database.alpha' .aether/data/COLONY_STATE.json)
# alpha should be 2 (prior 1 + 1 success)

# Test 2: Record failed spawn increments beta
record_failed_spawn "database_specialist" "database" "test_spawn_2" "Test failure"
beta=$(jq '.meta_learning.specialist_confidence.database_specialist.database.beta' .aether/data/COLONY_STATE.json)
# beta should be 2 (prior 1 + 1 failure)

# Test 3: Confidence recalculated correctly
confidence=$(jq '.meta_learning.specialist_confidence.database_specialist.database.confidence' .aether/data/COLONY_STATE.json)
# confidence should match alpha/(alpha+beta)

# Test 4: Get confidence returns correct value
retrieved=$(get_specialist_confidence "database_specialist" "database")
# should match COLONY_STATE.json confidence
```
  </verify>
  <done>
spawn-outcome-tracker.sh enhanced with Bayesian alpha/beta updating. record_successful_spawn increments alpha, record_failed_spawn increments beta, confidence recalculated using Beta distribution formula. Function signatures unchanged (backward compatible). Old constants removed, new comments explain Bayesian approach.
  </done>
</task>

</tasks>

<verification>
1. COLONY_STATE.json meta_learning.specialist_confidence uses new schema with alpha/beta/confidence/counts
2. spawn-outcome-tracker.sh sources bayesian-confidence.sh
3. record_successful_spawn increments alpha, recalculates confidence via Beta distribution
4. record_failed_spawn increments beta, recalculates confidence via Beta distribution
5. get_specialist_confidence returns Bayesian confidence from state
6. Function signatures unchanged (backward compatible with Phase 6)
7. Old constants SUCCESS_INCREMENT/FAILURE_DECREMENT removed
8. Meta-learning stats display alpha/beta/counts
</verification>

<success_criteria>
Meta-learning infrastructure uses Bayesian Beta distribution confidence scoring. Colony tracks spawns with alpha/beta parameters, confidence calculated via α/(α+β), asymmetric penalty automatic (failures increment β, successes increment α).
</success_criteria>

<output>
After completion, create `.planning/phases/08-colony-learning/08-02-SUMMARY.md`
</output>
