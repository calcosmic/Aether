---
phase: 08-colony-learning
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - .aether/data/COLONY_STATE.json
  - .aether/utils/spawn-outcome-tracker.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "COLONY_STATE.json meta_learning.specialist_confidence schema includes alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns"
    - "spawn-outcome-tracker.sh uses Bayesian alpha/beta updating instead of simple +0.1/-0.15 arithmetic"
    - "record_successful_spawn increments alpha, recalculates confidence via bayesian-confidence.sh"
    - "record_failed_spawn increments beta, recalculates confidence via bayesian-confidence.sh"
    - "get_specialist_confidence returns Bayesian confidence from COLONY_STATE.json"
    - "Function signatures unchanged (backward compatible with Phase 6)"
  artifacts:
    - path: ".aether/data/COLONY_STATE.json"
      provides: "Meta-learning state storage with Bayesian parameters"
      contains: ".meta_learning.specialist_confidence.*.alpha"
      contains: ".meta_learning.specialist_confidence.*.beta"
    - path: ".aether/utils/spawn-outcome-tracker.sh"
      provides: "Enhanced spawn outcome tracking with Bayesian updating"
      min_lines: 250
  key_links:
    - from: ".aether/utils/spawn-outcome-tracker.sh"
      to: ".aether/utils/bayesian-confidence.sh"
      via: "Source and function calls"
      pattern: "source .aether/utils/bayesian-confidence.sh"
    - from: ".aether/utils/spawn-outcome-tracker.sh"
      to: ".aether/data/COLONY_STATE.json"
      via: "jq updates with alpha/beta parameters"
      pattern: "jq \".meta_learning.specialist_confidence.* = {alpha:.*, beta:.*, confidence:.*}\""
---

<objective>
Update COLONY_STATE.json schema and enhance spawn-outcome-tracker.sh to use Bayesian Beta distribution confidence scoring

Purpose: Enhance Phase 6's simple confidence arithmetic with statistically principled Bayesian inference. Replace +0.1/-0.15 heuristic with alpha/beta parameter updating while maintaining backward compatibility (same function names).

Output: Updated COLONY_STATE.json schema with alpha/beta fields, enhanced spawn-outcome-tracker.sh using bayesian-confidence.sh
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-colony-learning/08-RESEARCH.md
@.planning/phases/08-colony-learning/08-01-SUMMARY.md
@.planning/STATE.md
@.planning/ROADMAP.md

@.aether/utils/bayesian-confidence.sh
@.aether/utils/spawn-outcome-tracker.sh
@.aether/data/COLONY_STATE.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update COLONY_STATE.json meta_learning schema for Bayesian parameters</name>
  <files>.aether/data/COLONY_STATE.json</files>
  <action>
Update COLONY_STATE.json meta_learning.specialist_confidence schema to include Bayesian parameters:

**Current schema (Phase 6):**
```json
"specialist_confidence": {
  "database_specialist": {
    "database": 0.45
  }
}
```

**New schema (Phase 8):**
```json
"specialist_confidence": {
  "database_specialist": {
    "database": {
      "alpha": 1,
      "beta": 1,
      "confidence": 0.5,
      "total_spawns": 0,
      "successful_spawns": 0,
      "failed_spawns": 0,
      "last_updated": "2026-02-02T00:00:00Z"
    }
  }
}
```

**Migration strategy:**
1. Check if existing entries use old format (float instead of object)
2. If old format: migrate float confidence to alpha/beta estimate
   - confidence 0.5 → {alpha: 1, beta: 1}
   - confidence < 0.5 → estimate lower alpha (keep beta=1, solve for alpha)
   - confidence > 0.5 → estimate higher beta (keep alpha=1, solve for beta)
3. Update schema to new format
4. Add last_updated timestamp field

**jq migration command:**
```bash
jq '
  .meta_learning.specialist_confidence |= with_entries(
    .value |= with_entries(
      if (.value | type) == "number" then
        .value = {
          alpha: 1,
          beta: 1,
          confidence: .value,
          total_spawns: 0,
          successful_spawns: 0,
          failed_spawns: 0,
          last_updated: "2026-02-02T00:00:00Z"
        }
      else
        .
      end
    )
  )
' .aether/data/COLONY_STATE.json | atomic_write .aether/data/COLONY_STATE.json
```

**IMPORTANT:**
- Use atomic-write.sh for safe updates
- Handle both old and existing new formats
- Preserve existing data during migration
- Add comments explaining Bayesian parameters
  </action>
  <verify>
Check schema updated correctly:
```bash
# Verify specialist_confidence has nested structure
jq '.meta_learning.specialist_confidence.database_specialist.database | has("alpha")' .aether/data/COLONY_STATE.json
# Should return: true

# Verify all Bayesian fields present
jq '.meta_learning.specialist_confidence[][] | keys' .aether/data/COLONY_STATE.json
# Should include: alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns, last_updated

# Verify confidence calculation
alpha=$(jq '.meta_learning.specialist_confidence.database_specialist.database.alpha' .aether/data/COLONY_STATE.json)
beta=$(jq '.meta_learning.specialist_confidence.database_specialist.database.beta' .aether/data/COLONY_STATE.json)
confidence=$(echo "scale=6; $alpha / ($alpha + $beta)" | bc)
jq_confidence=$(jq '.meta_learning.specialist_confidence.database_specialist.database.confidence' .aether/data/COLONY_STATE.json)
# $confidence should match $jq_confidence
```
  </verify>
  <done>
COLONY_STATE.json meta_learning.specialist_confidence uses new Bayesian schema with alpha/beta parameters. Old float entries migrated to object format. All entries include alpha, beta, confidence, total_spawns, successful_spawns, failed_spawns, last_updated fields.
  </done>
</task>

<task type="auto">
  <name>Task 2a: Source Bayesian library in spawn-outcome-tracker.sh</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Add source statement for bayesian-confidence.sh in .aether/utils/spawn-outcome-tracker.sh:

**Location:** After file-lock.sh sourcing (around line 20-30)

**Add this code:**
```bash
# Source Bayesian confidence library
if [ -f "$AETHER_ROOT/.aether/utils/bayesian-confidence.sh" ]; then
    source "$AETHER_ROOT/.aether/utils/bayesian-confidence.sh"
else
    source ".aether/utils/bayesian-confidence.sh"
fi
```

**IMPORTANT:**
- Use AETHER_ROOT variable for path detection
- Provide fallback to relative path
- Place after existing source statements
- Add comment explaining Bayesian integration
  </action>
  <verify>
Check source statement exists:
```bash
grep -n "bayesian-confidence.sh" .aether/utils/spawn-outcome-tracker.sh
# Should show source statement with AETHER_ROOT detection
```
  </verify>
  <done>
spawn-outcome-tracker.sh sources bayesian-confidence.sh with AETHER_ROOT detection and fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2b: Update record_successful_spawn with Bayesian alpha updating</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Update record_successful_spawn() in .aether/utils/spawn-outcome-tracker.sh to use Bayesian alpha incrementing:

**New implementation:**
```bash
record_successful_spawn() {
    local specialist_type="$1"
    local task_type="$2"
    local spawn_id="$3"

    # Acquire lock
    if ! acquire_lock "$LOCK_FILE"; then
        echo "Cannot acquire lock to record successful spawn" >&2
        return 1
    fi

    local timestamp=$(get_timestamp)

    # Get current alpha/beta (default to prior 1,1)
    local current=$(jq -r "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\"
        // {\"alpha\": 1, \"beta\": 1, \"confidence\": 0.5}
    " "$COLONY_STATE_FILE")

    local alpha=$(echo "$current" | jq -r '.alpha // 1')
    local beta=$(echo "$current" | jq -r '.beta // 1')

    # Update Bayesian parameters: increment alpha for success
    local new_alpha=$(update_bayesian_parameters "$alpha" "$beta" "success")
    local new_beta=$beta

    # Calculate new confidence
    local new_confidence=$(calculate_confidence "$new_alpha" "$new_beta")

    # Calculate derived stats
    local total_spawns=$(echo "$new_alpha + $new_beta - 2" | bc)
    local successful_spawns=$(echo "$new_alpha - 1" | bc)
    local failed_spawns=$(echo "$new_beta - 1" | bc)

    # Update state atomically with full Bayesian object
    local updated_state
    updated_state=$(jq "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\" = {
            \"alpha\": $new_alpha,
            \"beta\": $new_beta,
            \"confidence\": $new_confidence,
            \"total_spawns\": $total_spawns,
            \"successful_spawns\": $successful_spawns,
            \"failed_spawns\": $failed_spawns,
            \"last_updated\": \"$timestamp\"
        } |
        .meta_learning.spawn_outcomes += [{
            \"spawn_id\": \"$spawn_id\",
            \"specialist\": \"$specialist_type\",
            \"task_type\": \"$task_type\",
            \"outcome\": \"success\",
            \"timestamp\": \"$timestamp\"
        }] |
        .meta_learning.last_updated = \"$timestamp\"
    " "$COLONY_STATE_FILE")

    if ! atomic_write "$COLONY_STATE_FILE" "$updated_state"; then
        echo "Failed to record successful spawn" >&2
        release_lock
        return 1
    fi

    # Release lock
    release_lock

    return 0
}
```

**IMPORTANT:**
- Keep function signature unchanged (backward compatible)
- Use update_bayesian_parameters() from bayesian-confidence.sh
- Use calculate_confidence() from bayesian-confidence.sh
- Maintain file locking and atomic write patterns
- Update comments to explain Bayesian approach
  </action>
  <verify>
Test successful spawn increments alpha:
```bash
source .aether/utils/spawn-outcome-tracker.sh
record_successful_spawn "test_specialist" "test_task" "test_spawn_1"
alpha=$(jq '.meta_learning.specialist_confidence.test_specialist.test_task.alpha' .aether/data/COLONY_STATE.json)
# alpha should be 2 (prior 1 + 1 success)
```
  </verify>
  <done>
record_successful_spawn() increments alpha via update_bayesian_parameters(), recalculates confidence via Beta distribution formula.
  </done>
</task>

<task type="auto">
  <name>Task 2c: Update record_failed_spawn with Bayesian beta updating</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Update record_failed_spawn() in .aether/utils/spawn-outcome-tracker.sh to use Bayesian beta incrementing:

**New implementation:**
```bash
record_failed_spawn() {
    local specialist_type="$1"
    local task_type="$2"
    local spawn_id="$3"
    local failure_reason="$4"

    # Acquire lock
    if ! acquire_lock "$LOCK_FILE"; then
        echo "Cannot acquire lock to record failed spawn" >&2
        return 1
    fi

    local timestamp=$(get_timestamp)

    # Get current alpha/beta (default to prior 1,1)
    local current=$(jq -r "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\"
        // {\"alpha\": 1, \"beta\": 1, \"confidence\": 0.5}
    " "$COLONY_STATE_FILE")

    local alpha=$(echo "$current" | jq -r '.alpha // 1')
    local beta=$(echo "$current" | jq -r '.beta // 1')

    # Update Bayesian parameters: increment beta for failure
    local new_alpha=$alpha
    local new_beta=$(update_bayesian_parameters "$alpha" "$beta" "failure")

    # Calculate new confidence
    local new_confidence=$(calculate_confidence "$new_alpha" "$new_beta")

    # Calculate derived stats
    local total_spawns=$(echo "$new_alpha + $new_beta - 2" | bc)
    local successful_spawns=$(echo "$new_alpha - 1" | bc)
    local failed_spawns=$(echo "$new_beta - 1" | bc)

    # Update state atomically with full Bayesian object
    local updated_state
    updated_state=$(jq "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\" = {
            \"alpha\": $new_alpha,
            \"beta\": $new_beta,
            \"confidence\": $new_confidence,
            \"total_spawns\": $total_spawns,
            \"successful_spawns\": $successful_spawns,
            \"failed_spawns\": $failed_spawns,
            \"last_updated\": \"$timestamp\"
        } |
        .meta_learning.spawn_outcomes += [{
            \"spawn_id\": \"$spawn_id\",
            \"specialist\": \"$specialist_type\",
            \"task_type\": \"$task_type\",
            \"outcome\": \"failure\",
            \"reason\": \"$failure_reason\",
            \"timestamp\": \"$timestamp\"
        }] |
        .meta_learning.last_updated = \"$timestamp\"
    " "$COLONY_STATE_FILE")

    if ! atomic_write "$COLONY_STATE_FILE" "$updated_state"; then
        echo "Failed to record failed spawn" >&2
        release_lock
        return 1
    fi

    # Release lock
    release_lock

    return 0
}
```

**IMPORTANT:**
- Keep function signature unchanged (backward compatible)
- Use update_bayesian_parameters() with "failure" outcome
- Increment beta (not alpha) for failures
- Include failure_reason in spawn_outcomes log
- Maintain file locking and atomic write patterns
  </action>
  <verify>
Test failed spawn increments beta:
```bash
source .aether/utils/spawn-outcome-tracker.sh
record_failed_spawn "test_specialist" "test_task" "test_spawn_2" "Test failure"
beta=$(jq '.meta_learning.specialist_confidence.test_specialist.test_task.beta' .aether/data/COLONY_STATE.json)
# beta should be 2 (prior 1 + 1 failure)
```
  </verify>
  <done>
record_failed_spawn() increments beta via update_bayesian_parameters(), recalculates confidence via Beta distribution formula.
  </done>
</task>

<task type="auto">
  <name>Task 2d: Update get_specialist_confidence and get_meta_learning_stats</name>
  <files>.aether/utils/spawn-outcome-tracker.sh</files>
  <action>
Update getter functions in .aether/utils/spawn-outcome-tracker.sh to work with Bayesian schema:

**1. Update get_specialist_confidence():**
```bash
get_specialist_confidence() {
    local specialist_type="$1"
    local task_type="$2"
    local full_object="${3:-false}"

    local result=$(jq -r "
        .meta_learning.specialist_confidence.\"$specialist_type\".\"$task_type\"
        // {\"alpha\": 1, \"beta\": 1, \"confidence\": 0.5}
    " "$COLONY_STATE_FILE")

    if [ "$full_object" = "true" ]; then
        echo "$result"
    else
        echo "$result" | jq -r '.confidence // 0.5'
    fi
}
```

**2. Update get_meta_learning_stats():**
```bash
get_meta_learning_stats() {
    echo "Meta-Learning Statistics (Bayesian Beta Distribution)"
    echo "======================================================"

    jq -r '
        .meta_learning.specialist_confidence |
        to_entries[] |
        .key as $specialist |
        .value |
        to_entries[] |
        "\($specialist) → \(.key): α=\(.value.alpha), β=\(.value.beta), confidence=\(.value.confidence), total=\(.value.total_spawns), successes=\(.value.successful_spawns), failures=\(.value.failed_spawns)"
    ' "$COLONY_STATE_FILE" | while IFS= read -r line; do
        echo "  $line"
    done

    echo ""
    echo "  Confidence formula: α / (α + β)"
    echo "  Prior: α=1, β=1 (confidence=0.5)"
    echo "  Success: increment α, Failure: increment β"
}
```

**3. Remove old constants:**
```bash
# Remove these lines (no longer needed with Bayesian approach):
# SUCCESS_INCREMENT=0.1
# FAILURE_DECREMENT=0.15
```

**Keep these constants (for display/comparison):**
```bash
DEFAULT_CONFIDENCE=0.5
MAX_CONFIDENCE=1.0
MIN_CONFIDENCE=0.0
```

**4. Add comment at top of file:**
```bash
# Enhanced with Bayesian Beta distribution confidence scoring
# Phase 8: Replaces simple +0.1/-0.15 arithmetic with α/(α+β) formula
```

**IMPORTANT:**
- Keep function names and signatures unchanged (backward compatible)
- Add optional full_object parameter to get_specialist_confidence()
- Display alpha/beta in stats output
- Update comments to explain Bayesian approach
  </action>
  <verify>
Test getter functions:
```bash
source .aether/utils/spawn-outcome-tracker.sh

# Test 1: Get confidence value
retrieved=$(get_specialist_confidence "database_specialist" "database")
# should match COLONY_STATE.json confidence

# Test 2: Get full Bayesian object
full=$(get_specialist_confidence "database_specialist" "database" "true")
# should be JSON object with alpha, beta, confidence, etc.

# Test 3: Get meta-learning stats
get_meta_learning_stats
# should display α, β, confidence, totals
```
  </verify>
  <done>
get_specialist_confidence() returns Bayesian confidence from state. get_meta_learning_stats() displays alpha/beta/counts. Old constants SUCCESS_INCREMENT/FAILURE_DECREMENT removed. Comments explain Bayesian approach.
  </done>
</task>

</tasks>

<verification>
1. COLONY_STATE.json meta_learning.specialist_confidence uses new schema with alpha/beta/confidence/counts
2. spawn-outcome-tracker.sh sources bayesian-confidence.sh
3. record_successful_spawn increments alpha, recalculates confidence via Beta distribution
4. record_failed_spawn increments beta, recalculates confidence via Beta distribution
5. get_specialist_confidence returns Bayesian confidence from state
6. Function signatures unchanged (backward compatible with Phase 6)
7. Old constants SUCCESS_INCREMENT/FAILURE_DECREMENT removed
8. Meta-learning stats display alpha/beta/counts
</verification>

<success_criteria>
Meta-learning infrastructure uses Bayesian Beta distribution confidence scoring. Colony tracks spawns with alpha/beta parameters, confidence calculated via α/(α+β), asymmetric penalty automatic (failures increment β, successes increment α).
</success_criteria>

<output>
After completion, create `.planning/phases/08-colony-learning/08-02-SUMMARY.md`
</output>
