---
phase: 07-core-reliability-state-guards-update-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/state-guard.js
  - tests/unit/state-guard.test.js
autonomous: true

must_haves:
  truths:
    - Phase advancement requires fresh verification evidence (STATE-01)
    - Idempotency check prevents rebuilding completed phases (STATE-02)
    - State lock acquired during all phase transitions (STATE-03)
    - Iron Law violations throw structured errors with recovery info
  artifacts:
    - path: "bin/lib/state-guard.js"
      provides: "StateGuard class with Iron Law enforcement"
      exports: ["StateGuard", "StateGuardError"]
      min_lines: 200
    - path: "tests/unit/state-guard.test.js"
      provides: "Unit tests for StateGuard"
      min_tests: 10
  key_links:
    - from: "StateGuard.advancePhase()"
      to: "FileLock.acquire()"
      via: "lock before read"
    - from: "StateGuard.hasFreshEvidence()"
      to: "state.memory.phase_learnings"
      via: "evidence validation"
    - from: "StateGuard.transitionState()"
      to: "state.events.push()"
      via: "audit trail"
---

<objective>
Create StateGuard class that enforces the Iron Law: phase advancement requires fresh verification evidence, with idempotency checks and file locking.

Purpose: Prevent phase advancement loops by requiring proof of work before allowing transitions.
Output: StateGuard module with Iron Law enforcement, idempotency checks, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-reliability-state-guards-update-system/07-RESEARCH.md
@.aether/data/COLONY_STATE.json
@bin/lib/errors.js
</context>

<tasks>

<task type="auto">
  <name>Create StateGuardError class and StateGuard foundation</name>
  <files>bin/lib/state-guard.js</files>
  <action>
Create bin/lib/state-guard.js with StateGuardError and StateGuard classes:

1. StateGuardError class (extends Error):
   - constructor(code, message, details = {}, recovery = null)
   - Codes: E_IRON_LAW_VIOLATION, E_IDEMPOTENCY_CHECK, E_LOCK_TIMEOUT, E_INVALID_TRANSITION
   - toJSON() method for structured output
   - toString() method for display

2. StateGuard class:
   - constructor(stateFilePath, options = {})
     - stateFile: path to COLONY_STATE.json
     - lock: FileLock instance (created internally or passed)
     - locked: boolean tracking lock state

3. acquireLock() method:
   - Uses FileLock to acquire lock on state file
   - Throws StateGuardError(E_LOCK_TIMEOUT) on failure
   - Sets this.locked = true

4. releaseLock() method:
   - Releases FileLock
   - Sets this.locked = false
   - Safe to call even if not locked

5. loadState() method:
   - Reads and parses COLONY_STATE.json
   - Validates basic structure (version, current_phase, events array)
   - Throws StateGuardError if file missing or invalid

6. saveState(state) method:
   - Updates last_updated timestamp
   - Writes state atomically (write to temp, rename)
   - Returns Promise or sync based on implementation

7. Export: module.exports = { StateGuard, StateGuardError };

Reference patterns from 07-RESEARCH.md "Pattern 1: State Guard with Iron Law Enforcement".
  </action>
  <verify>node -e "const {StateGuard, StateGuardError} = require('./bin/lib/state-guard.js'); console.log('Loaded:', typeof StateGuard, typeof StateGuardError)"</verify>
  <done>StateGuardError and StateGuard classes exist with core methods</done>
</task>

<task type="auto">
  <name>Implement Iron Law enforcement and idempotency checks</name>
  <files>bin/lib/state-guard.js</files>
  <action>
Extend bin/lib/state-guard.js with Iron Law enforcement methods:

1. hasFreshEvidence(state, phase, evidence) method:
   - Validate evidence object has required fields:
     - checkpoint_hash: SHA-256 of checkpoint
     - test_results: boolean or object with test outcomes
     - timestamp: ISO 8601 date string
   - Check evidence.timestamp > state.initialized_at (freshness)
   - Check evidence is from current session (not inherited)
   - Return true if all checks pass, false otherwise

2. enforceIronLaw(state, phase, evidence) method:
   - Calls hasFreshEvidence()
   - If false, throw StateGuardError(E_IRON_LAW_VIOLATION) with:
     - message: "Phase {phase} advancement requires fresh verification evidence"
     - details: { missing: [...], provided: Object.keys(evidence) }
     - recovery: "Provide verification evidence: checkpoint_hash, test_results, timestamp"

3. checkIdempotency(state, fromPhase) method:
   - If state.current_phase > fromPhase:
     - Return { canProceed: false, reason: 'already_complete', currentPhase: state.current_phase }
   - If state.current_phase < fromPhase:
     - Return { canProceed: false, reason: 'previous_incomplete', currentPhase: state.current_phase }
   - Return { canProceed: true }

4. validateTransition(fromPhase, toPhase) method:
   - Ensure toPhase === fromPhase + 1 (sequential only)
   - Throw StateGuardError(E_INVALID_TRANSITION) if invalid

5. advancePhase(fromPhase, toPhase, evidence) async method:
   - Full implementation of phase advancement with guards:
     a. Acquire lock
     b. Load state
     c. Check idempotency (STATE-02)
     d. Validate transition
     e. Enforce Iron Law (STATE-01)
     f. Transition state
     g. Add audit event (placeholder for STATE-04)
     h. Save state
     i. Release lock
   - Returns result object: { status: 'transitioned'|'already_complete', from, to }
   - Always releases lock in finally block

Reference the Iron Law enforcement example in 07-RESEARCH.md lines 374-403.
  </action>
  <verify>node -e "const sg = require('./bin/lib/state-guard.js'); console.log('Methods:', Object.getOwnPropertyNames(sg.StateGuard.prototype))"</verify>
  <done>All StateGuard methods implemented including advancePhase with Iron Law</done>
</task>

<task type="auto">
  <name>Create comprehensive unit tests for StateGuard</name>
  <files>tests/unit/state-guard.test.js</files>
  <action>
Create tests/unit/state-guard.test.js with tests using sinon + proxyquire:

1. Test setup:
   - Mock fs module
   - Mock FileLock from bin/lib/file-lock.js
   - Load StateGuard via proxyquire
   - Create valid state fixture matching COLONY_STATE.json structure

2. Test: advancePhase succeeds with valid evidence
   - Setup: state at phase 5, valid evidence with fresh timestamp
   - Call: advancePhase(5, 6, evidence)
   - Assert: returns { status: 'transitioned', from: 5, to: 6 }
   - Assert: saveState called with updated phase
   - Assert: lock acquired and released

3. Test: advancePhase throws without evidence (Iron Law)
   - Setup: state at phase 5, evidence = null
   - Call: advancePhase(5, 6, null)
   - Assert: throws StateGuardError with code E_IRON_LAW_VIOLATION
   - Assert: error.recovery contains required fields

4. Test: advancePhase throws with stale evidence
   - Setup: state initialized_at = "2026-02-14T10:00:00Z"
   - Evidence timestamp = "2026-02-13T09:00:00Z" (before init)
   - Call: advancePhase(5, 6, evidence)
   - Assert: throws E_IRON_LAW_VIOLATION with "stale" message

5. Test: idempotency prevents rebuilding completed phase
   - Setup: state.current_phase = 6
   - Call: advancePhase(5, 6, validEvidence)
   - Assert: returns { status: 'already_complete', phase: 6 }
   - Assert: no state modification

6. Test: idempotency prevents skipping phases
   - Setup: state.current_phase = 4
   - Call: advancePhase(5, 6, validEvidence)
   - Assert: throws with reason 'previous_incomplete'

7. Test: validates sequential transitions only
   - Call: advancePhase(5, 7, validEvidence) (skipping 6)
   - Assert: throws E_INVALID_TRANSITION

8. Test: releases lock even on error
   - Setup: evidence null (will throw)
   - Call: advancePhase(5, 6, null)
   - Assert: throws error
   - Assert: FileLock.release() called

9. Test: hasFreshEvidence validates all required fields
   - Test missing checkpoint_hash
   - Test missing test_results
   - Test missing timestamp
   - Each should return false

10. Test: StateGuardError toJSON structure
    - Create error with all fields
    - Assert toJSON() returns expected structure

Use test.serial() for all tests (commander.js pattern).
  </action>
  <verify>npm test -- tests/unit/state-guard.test.js</verify>
  <done>All 10+ StateGuard tests pass</done>
</task>

</tasks>

<verification>
- StateGuard class loads without errors
- All unit tests pass (npm test -- tests/unit/state-guard.test.js)
- Iron Law enforcement verified (no advancement without evidence)
- Idempotency checks verified (completed phases skipped)
- Lock acquisition/releases verified
</verification>

<success_criteria>
1. StateGuard class exists with Iron Law enforcement (STATE-01)
2. Idempotency checks prevent rebuilding completed phases (STATE-02)
3. File locking during phase transitions (STATE-03)
4. 10+ unit tests covering all scenarios
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-reliability-state-guards-update-system/07-02-SUMMARY.md`
</output>
