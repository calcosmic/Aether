---
phase: 07-core-reliability-state-guards-update-system
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - bin/lib/update-transaction.js
  - bin/cli.js
  - tests/unit/update-transaction.test.js
autonomous: true

must_haves:
  truths:
    - Update creates checkpoint before file sync (UPDATE-01)
    - Two-phase commit: backup → sync → verify → update version (UPDATE-02)
    - Automatic rollback on sync failure (UPDATE-03)
    - Recovery commands displayed prominently on failure (UPDATE-04)
  artifacts:
    - path: "bin/lib/update-transaction.js"
      provides: "UpdateTransaction class with two-phase commit"
      exports: ["UpdateTransaction", "UpdateError"]
      min_lines: 250
    - path: "bin/cli.js"
      provides: "Integrated update command using UpdateTransaction"
      modifies: ["updateRepo function", "update command"]
    - path: "tests/unit/update-transaction.test.js"
      provides: "Unit tests for UpdateTransaction"
      min_tests: 10
  key_links:
    - from: "UpdateTransaction.execute()"
      to: "checkpoint create"
      via: "createCheckpoint() helper"
    - from: "UpdateTransaction.rollback()"
      to: "checkpoint restore"
      via: "restoreCheckpoint() helper"
    - from: "UpdateError"
      to: "error.recovery commands"
      via: "getRecoveryCommands()"
---

<objective>
Implement two-phase commit for updates with automatic rollback capability, integrating with the checkpoint system from Phase 6.

Purpose: Make updates reliable and recoverable, preventing partial update corruption.
Output: UpdateTransaction class with full two-phase commit and comprehensive tests.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-reliability-state-guards-update-system/07-RESEARCH.md
@bin/cli.js
@bin/lib/errors.js
</context>

<tasks>

<task type="auto">
  <name>Create UpdateError class and UpdateTransaction foundation</name>
  <files>bin/lib/update-transaction.js</files>
  <action>
Create bin/lib/update-transaction.js with UpdateError and UpdateTransaction classes:

1. UpdateError class (extends Error):
   - constructor(code, message, details = {}, recoveryCommands = [])
   - Codes: E_UPDATE_FAILED, E_CHECKPOINT_FAILED, E_SYNC_FAILED, E_VERIFY_FAILED, E_ROLLBACK_FAILED
   - recoveryCommands: array of shell commands to recover
   - toJSON() includes recoveryCommands
   - toString() displays recovery commands prominently

2. UpdateTransaction class:
   - constructor(repoPath, options = {})
     - repoPath: path to repository being updated
     - sourceVersion: version to update to
     - state: 'pending' | 'preparing' | 'syncing' | 'verifying' | 'committing' | 'committed' | 'rolling_back' | 'rolled_back'
     - checkpoint: null | checkpoint object
     - syncResult: null | sync results

3. createCheckpoint() method:
   - Call existing checkpoint create command via execSync
   - Capture checkpoint ID from output
   - Store in this.checkpoint
   - Return checkpoint object: { id, stashRef, timestamp }
   - Throw UpdateError(E_CHECKPOINT_FAILED) on failure

4. syncFiles(sourceVersion, dryRun = false) method:
   - Use existing syncDirWithCleanup from cli.js
   - Copy files from hub to repo
   - Return { copied: [], removed: [], unchanged: [] }
   - Set this.state = 'syncing' during operation

5. verifyIntegrity() method:
   - Verify all synced files exist
   - Verify file hashes match expected (use hashFileSync)
   - Return { valid: boolean, errors: string[] }
   - Set this.state = 'verifying' during operation

6. updateVersion(sourceVersion) method:
   - Update version.json in repo
   - Set this.state = 'committed'

7. rollback() method:
   - Set this.state = 'rolling_back'
   - If checkpoint exists, restore it via checkpoint restore command
   - Set this.state = 'rolled_back'
   - Return success/failure

8. getRecoveryCommands() method:
   - Build array of recovery commands based on transaction state:
     - If stash created: `cd {repoPath} && git stash pop {stashRef}`
     - If checkpoint exists: `aether checkpoint restore {checkpoint.id}`
     - Manual fallback: `git reset --hard HEAD`
   - Return array of command strings

9. Export: module.exports = { UpdateTransaction, UpdateError };

Reference 07-RESEARCH.md "Pattern 2: Two-Phase Commit for Updates" (lines 140-189).
Reference existing updateRepo() in cli.js lines 783-885.
  </action>
  <verify>node -e "const ut = require('./bin/lib/update-transaction.js'); console.log('Loaded:', typeof ut.UpdateTransaction, typeof ut.UpdateError)"</verify>
  <done>UpdateTransaction and UpdateError classes created with all core methods</done>
</task>

<task type="auto">
  <name>Implement execute() method with two-phase commit</name>
  <files>bin/lib/update-transaction.js</files>
  <action>
Extend bin/lib/update-transaction.js with the main execute method:

1. async execute(sourceVersion, options = {}) method:
   - options: { dryRun: boolean }
   - Full two-phase commit flow:

   Phase 1: Prepare
   - this.state = 'preparing'
   - Call this.createCheckpoint()
   - Log: "Created checkpoint {id} for rollback safety"

   Phase 2: Sync
   - this.state = 'syncing'
   - Call this.syncFiles(sourceVersion, dryRun)
   - Store result in this.syncResult

   Phase 3: Verify (skip if dryRun)
   - If !dryRun:
     - this.state = 'verifying'
     - Call this.verifyIntegrity()
     - If !verification.valid:
       - Throw UpdateError(E_VERIFY_FAILED, 'Verification failed', { errors: verification.errors })

   Phase 4: Commit (skip if dryRun)
   - If !dryRun:
     - this.state = 'committing'
     - Call this.updateVersion(sourceVersion)
     - this.state = 'committed'

   Return result object:
   {
     success: true,
     status: dryRun ? 'dry-run' : 'updated',
     checkpoint_id: this.checkpoint.id,
     files_synced: this.syncResult.copied.length,
     files_removed: this.syncResult.removed.length
   }

2. Error handling in execute():
   - Wrap entire flow in try/catch
   - On any error:
     - Attempt automatic rollback
     - If rollback succeeds: enhance error with recovery commands
     - If rollback fails: add rollback failure to error details
     - Re-throw UpdateError with full context

3. Example error output format:
   ```
   Update failed: E_SYNC_FAILED - File sync encountered errors

   Recovery commands:
     cd /path/to/repo && git stash pop stash@{0}
     aether checkpoint restore chk_20260214_143015

   Or manually:
     git reset --hard HEAD
   ```

4. State tracking:
   - Ensure state transitions are logged
   - State should be queryable for debugging

Reference two-phase commit example in 07-RESEARCH.md lines 405-463.
  </action>
  <verify>node -e "const ut = require('./bin/lib/update-transaction.js'); const tx = new UpdateTransaction('.'); console.log('State:', tx.state, 'Methods:', typeof tx.execute, typeof tx.rollback)"</verify>
  <done>execute() method implemented with full two-phase commit flow</done>
</task>

<task type="auto">
  <name>Integrate UpdateTransaction into CLI update command</name>
  <files>bin/cli.js</files>
  <action>
Modify bin/cli.js to use UpdateTransaction for the update command:

1. Import UpdateTransaction at top:
   - const { UpdateTransaction } = require('./lib/update-transaction');

2. Refactor updateRepo() function (around line 783):
   - Replace existing implementation with UpdateTransaction usage
   - Keep existing validation (dirty file detection) at start
   - Create UpdateTransaction instance
   - Call transaction.execute(sourceVersion, { dryRun })
   - Handle UpdateError specifically:
     - Display error.message
     - Display recovery commands prominently
     - Exit with appropriate code
   - Return result on success

3. Preserve existing behaviors:
   - Keep dirty file detection using isGitTracked()
   - Keep git stash for dirty files
   - Keep dry-run mode support
   - Keep quiet mode support

4. Add prominent recovery command display:
   - On any update failure, show:
     ```
     ========================================
     UPDATE FAILED - RECOVERY REQUIRED
     ========================================

     Error: {message}

     To recover your workspace:
     {recovery commands listed here}

     ========================================
     ```

5. Update error handling:
   - Ensure UpdateError is caught and formatted properly
   - Include checkpoint ID in error output if available

Test the integration by verifying the update command still works (dry-run mode).
  </action>
  <verify>node bin/cli.js update --dry-run 2>&1 | head -20</verify>
  <done>CLI update command refactored to use UpdateTransaction</done>
</task>

<task type="auto">
  <name>Create comprehensive unit tests for UpdateTransaction</name>
  <files>tests/unit/update-transaction.test.js</files>
  <action>
Create tests/unit/update-transaction.test.js with comprehensive tests:

1. Test setup:
   - Mock child_process.execSync for git/checkpoint commands
   - Mock fs module for file operations
   - Mock syncDirWithCleanup from cli.js
   - Load UpdateTransaction via proxyquire

2. Test: execute succeeds with two-phase commit
   - Setup: valid source version, successful checkpoint
   - Call: transaction.execute('1.1.0')
   - Assert: state transitions through all phases
   - Assert: checkpoint created
   - Assert: files synced
   - Assert: version updated
   - Assert: returns success result

3. Test: execute performs dry-run without changes
   - Call: transaction.execute('1.1.0', { dryRun: true })
   - Assert: checkpoint still created (for safety)
   - Assert: files synced but not written
   - Assert: version not updated
   - Assert: returns dry-run status

4. Test: automatic rollback on sync failure (UPDATE-03)
   - Setup: sync fails with error
   - Call: transaction.execute('1.1.0')
   - Assert: throws UpdateError
   - Assert: rollback() called
   - Assert: checkpoint restore attempted

5. Test: automatic rollback on verification failure
   - Setup: sync succeeds but verification fails
   - Call: transaction.execute('1.1.0')
   - Assert: throws UpdateError with E_VERIFY_FAILED
   - Assert: rollback() called

6. Test: recovery commands displayed on failure (UPDATE-04)
   - Setup: sync fails
   - Catch error
   - Assert: error.recoveryCommands exists
   - Assert: commands include git stash pop
   - Assert: commands include checkpoint restore

7. Test: UpdateError formats recovery commands prominently
   - Create UpdateError with recovery commands
   - Assert: toString() includes formatted commands
   - Assert: toJSON() includes recoveryCommands array

8. Test: createCheckpoint handles failure
   - Setup: checkpoint command fails
   - Call: transaction.createCheckpoint()
   - Assert: throws UpdateError with E_CHECKPOINT_FAILED

9. Test: rollback handles checkpoint restore failure
   - Setup: checkpoint exists but restore fails
   - Call: transaction.rollback()
   - Assert: handles gracefully, reports failure

10. Test: state tracking through transaction lifecycle
    - Monitor state property through execute()
    - Assert: states follow sequence: preparing → syncing → verifying → committing → committed

Use test.serial() for all tests.
  </action>
  <verify>npm test -- tests/unit/update-transaction.test.js</verify>
  <done>All 10+ UpdateTransaction tests pass</done>
</task>

</tasks>

<verification>
- UpdateTransaction class loads without errors
- CLI update command works (test with --dry-run)
- All unit tests pass
- Recovery commands displayed on failure
</verification>

<success_criteria>
1. UpdateTransaction class implements two-phase commit (UPDATE-02)
2. Pre-update checkpoint creation works (UPDATE-01)
3. Automatic rollback on failure works (UPDATE-03)
4. Recovery commands displayed prominently (UPDATE-04)
5. 10+ unit tests covering all scenarios
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-reliability-state-guards-update-system/07-04-SUMMARY.md`
</output>
