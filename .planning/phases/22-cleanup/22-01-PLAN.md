---
phase: 22-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/plan.md
  - .claude/commands/ant/pause-colony.md
  - .claude/commands/ant/resume-colony.md
  - .claude/commands/ant/colonize.md
  - .aether/aether-utils.sh
autonomous: true

must_haves:
  truths:
    - "plan.md Step 3 calls pheromone-batch instead of inline decay formula"
    - "pause-colony.md Step 2 calls pheromone-batch instead of inline decay formula"
    - "resume-colony.md Step 2 calls pheromone-batch instead of inline decay formula"
    - "colonize.md Step 2 calls pheromone-batch instead of inline decay formula"
    - "pheromone-combine, memory-token-count, memory-search, error-dedup no longer exist in aether-utils.sh"
    - "aether-utils.sh help output lists exactly 11 subcommands"
  artifacts:
    - path: ".claude/commands/ant/plan.md"
      provides: "Pheromone-batch call in Step 3"
      contains: "aether-utils.sh pheromone-batch"
    - path: ".claude/commands/ant/pause-colony.md"
      provides: "Pheromone-batch call in Step 2"
      contains: "aether-utils.sh pheromone-batch"
    - path: ".claude/commands/ant/resume-colony.md"
      provides: "Pheromone-batch call in Step 2"
      contains: "aether-utils.sh pheromone-batch"
    - path: ".claude/commands/ant/colonize.md"
      provides: "Pheromone-batch call in Step 2"
      contains: "aether-utils.sh pheromone-batch"
    - path: ".aether/aether-utils.sh"
      provides: "Clean utility layer with no orphaned subcommands"
      contains: "pheromone-batch"
  key_links:
    - from: ".claude/commands/ant/plan.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool pheromone-batch call"
      pattern: "bash .aether/aether-utils.sh pheromone-batch"
    - from: ".claude/commands/ant/colonize.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool pheromone-batch call"
      pattern: "bash .aether/aether-utils.sh pheromone-batch"
---

<objective>
Wire pheromone-batch into 4 command files and remove 4 dead subcommands from aether-utils.sh.

Purpose: Eliminate inline decay formulas (CLEAN-01) and dead code (CLEAN-05) so every aether-utils.sh subcommand is either consumed or removed.
Output: 4 command files using pheromone-batch, aether-utils.sh trimmed from 15 to 11 subcommands.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cleanup/22-RESEARCH.md

@.claude/commands/ant/build.md (reference implementation -- see Step 3, lines 42-50 for the pheromone-batch call pattern to copy)
@.claude/commands/ant/status.md (secondary reference -- also uses pheromone-batch)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire pheromone-batch into plan.md, pause-colony.md, resume-colony.md, colonize.md (CLEAN-01)</name>
  <files>
    .claude/commands/ant/plan.md
    .claude/commands/ant/pause-colony.md
    .claude/commands/ant/resume-colony.md
    .claude/commands/ant/colonize.md
  </files>
  <action>
Replace the inline decay formula in each file with a pheromone-batch Bash call. Use build.md Step 3 (lines 42-50) as the reference pattern.

**plan.md** -- Replace lines 29-36 (Step 3: Compute Active Pheromones). The inline formula block:
```
For each signal in `pheromones.json`:
1. If `half_life_seconds` is null, persists at original strength
2. Otherwise: `current_strength = strength * e^(-0.693 * elapsed_seconds / half_life_seconds)`
3. Filter out signals where `current_strength < 0.05`
```
Replace with:
```markdown
### Step 3: Compute Active Pheromones

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-batch
```

This returns JSON: `{"ok":true,"result":[...signals with current_strength...]}`. Parse the `result` array. Filter out signals where `current_strength < 0.05`.

If the command fails, treat as "no active pheromones."
```
KEEP the existing "Format:" block below (lines 37-42) unchanged. It references `current_strength` which is still present in the pheromone-batch result objects.

**pause-colony.md** -- Replace lines 19-24 (Step 2: Compute Pheromone Decay). The inline formula block:
```
For each signal in `pheromones.json`, compute current strength:
1. If `half_life_seconds` is null -> persists at original strength
2. Otherwise: `current_strength = strength * e^(-0.693 * elapsed_seconds / half_life_seconds)`
3. Note which signals are still active (strength >= 0.05)
```
Replace with:
```markdown
### Step 2: Compute Pheromone Decay

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-batch
```

This returns JSON: `{"ok":true,"result":[...signals with current_strength...]}`. Parse the `result` array. Signals with `current_strength >= 0.05` are still active.

If the command fails, treat as "no active pheromones."
```

**resume-colony.md** -- Replace lines 28-33 (Step 2: Compute Pheromone Decay). Same inline formula as pause-colony.md. Replace with identical pheromone-batch pattern as pause-colony.md above.

**colonize.md** -- Replace lines 27-33 (Step 2: Compute Active Pheromones). Same inline formula as plan.md. Replace with:
```markdown
### Step 2: Compute Active Pheromones

Use the Bash tool to run:
```
bash .aether/aether-utils.sh pheromone-batch
```

This returns JSON: `{"ok":true,"result":[...signals with current_strength...]}`. Parse the `result` array. Filter out signals where `current_strength < 0.05`.

If the command fails, treat as "no active pheromones."
```
KEEP the existing "Format:" block below unchanged.

**Anti-patterns to avoid:**
- Do NOT delete the "Format:" display blocks below the computation sections. Only the computation method changes, not the display format.
- Do NOT change step numbering or reorder steps.
- Do NOT modify any other steps in these files.
  </action>
  <verify>
Grep each file for the old inline formula pattern and the new pheromone-batch pattern:
```
grep -c "e\^(-0.693" .claude/commands/ant/plan.md .claude/commands/ant/pause-colony.md .claude/commands/ant/resume-colony.md .claude/commands/ant/colonize.md
```
Expected: all counts are 0 (no inline formulas remain).

```
grep -c "aether-utils.sh pheromone-batch" .claude/commands/ant/plan.md .claude/commands/ant/pause-colony.md .claude/commands/ant/resume-colony.md .claude/commands/ant/colonize.md
```
Expected: all counts are 1 (each file has exactly one pheromone-batch call).

Confirm display format blocks are preserved:
```
grep -c "ACTIVE PHEROMONES" .claude/commands/ant/plan.md .claude/commands/ant/colonize.md
```
Expected: both counts are 1.
  </verify>
  <done>All 4 command files call `aether-utils.sh pheromone-batch` for decay calculation. No inline `e^(-0.693...)` formulas remain. Display format blocks are preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Remove 4 orphaned subcommands from aether-utils.sh (CLEAN-05)</name>
  <files>.aether/aether-utils.sh</files>
  <action>
Remove these 4 case blocks from aether-utils.sh:

1. **pheromone-combine** (lines 76-83): The entire `pheromone-combine)` case block including the `;;` terminator.

2. **memory-token-count** (lines 160-163): The entire `memory-token-count)` case block including the `;;` terminator.

3. **memory-search** (lines 181-192): The entire `memory-search)` case block including the `;;` terminator.

4. **error-dedup** (lines 222-237): The entire `error-dedup)` case block including the `;;` terminator.

**Also update the help text** on line 38. Change the commands array from:
```
["help","version","pheromone-decay","pheromone-effective","pheromone-batch","pheromone-cleanup","pheromone-combine","validate-state","memory-token-count","memory-compress","memory-search","error-add","error-pattern-check","error-summary","error-dedup"]
```
To:
```
["help","version","pheromone-decay","pheromone-effective","pheromone-batch","pheromone-cleanup","validate-state","memory-compress","error-add","error-pattern-check","error-summary"]
```

That is: remove `pheromone-combine`, `memory-token-count`, `memory-search`, `error-dedup` from the array.

**Do NOT remove** any other subcommands. The remaining 11 subcommands all have active consumers.
  </action>
  <verify>
Verify removed subcommands are gone:
```
grep -c "pheromone-combine\|memory-token-count\|memory-search\|error-dedup" .aether/aether-utils.sh
```
Expected: 0

Verify remaining subcommands still exist:
```
grep -c "pheromone-batch\|pheromone-cleanup\|pheromone-decay\|pheromone-effective\|validate-state\|memory-compress\|error-add\|error-pattern-check\|error-summary" .aether/aether-utils.sh
```
Expected: >= 9 (each subcommand appears at least once in its case block)

Verify help text is correct:
```
bash .aether/aether-utils.sh help
```
Expected: JSON with exactly 11 commands listed, none of the 4 removed ones present.

Verify the script still runs without errors:
```
bash .aether/aether-utils.sh version
```
Expected: `{"ok":true,"result":"0.1.0"}`
  </verify>
  <done>4 orphaned subcommands removed. Help text lists exactly 11 subcommands. `bash .aether/aether-utils.sh help` and `version` both succeed.</done>
</task>

</tasks>

<verification>
1. No file contains inline decay formulas: `grep -r "e\^(-0.693" .claude/commands/ant/` returns 0 matches
2. All 4 command files contain pheromone-batch call: `grep -l "aether-utils.sh pheromone-batch" .claude/commands/ant/{plan,pause-colony,resume-colony,colonize}.md` returns all 4 files
3. aether-utils.sh has no orphaned subcommands: `bash .aether/aether-utils.sh help` lists exactly 11 commands
4. aether-utils.sh still works: `bash .aether/aether-utils.sh version` returns 0.1.0
</verification>

<success_criteria>
- CLEAN-01 satisfied: plan.md, pause-colony.md, resume-colony.md, colonize.md all call pheromone-batch
- CLEAN-05 satisfied: pheromone-combine, memory-token-count, memory-search, error-dedup removed from aether-utils.sh
- No regressions: remaining 11 subcommands work, display format blocks preserved in command files
</success_criteria>

<output>
After completion, create `.planning/phases/22-cleanup/22-01-SUMMARY.md`
</output>
