---
phase: 22-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/ant/continue.md
  - .claude/commands/ant/build.md
autonomous: true

must_haves:
  truths:
    - "continue.md calls memory-compress instead of manual array truncation"
    - "build.md calls error-pattern-check instead of manual error categorization"
    - "continue.md calls error-summary instead of manual error counting"
    - "build.md calls error-summary for structured error counts in the display"
  artifacts:
    - path: ".claude/commands/ant/continue.md"
      provides: "memory-compress and error-summary calls"
      contains: "aether-utils.sh memory-compress"
    - path: ".claude/commands/ant/build.md"
      provides: "error-pattern-check and error-summary calls"
      contains: "aether-utils.sh error-pattern-check"
  key_links:
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool memory-compress call"
      pattern: "bash .aether/aether-utils.sh memory-compress"
    - from: ".claude/commands/ant/continue.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool error-summary call"
      pattern: "bash .aether/aether-utils.sh error-summary"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool error-pattern-check call"
      pattern: "bash .aether/aether-utils.sh error-pattern-check"
    - from: ".claude/commands/ant/build.md"
      to: ".aether/aether-utils.sh"
      via: "Bash tool error-summary call"
      pattern: "bash .aether/aether-utils.sh error-summary"
---

<objective>
Wire memory-compress, error-pattern-check, and error-summary into continue.md and build.md, replacing manual inline logic.

Purpose: Eliminate remaining inline duplicates of deterministic logic (CLEAN-02, CLEAN-03, CLEAN-04) so all utility subcommands are consumed by commands.
Output: continue.md and build.md using utility calls instead of manual computation.
</objective>

<execution_context>
@~/.claude/cosmic-dev-system/workflows/execute-plan.md
@~/.claude/cosmic-dev-system/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cleanup/22-RESEARCH.md

@.aether/aether-utils.sh (subcommand interfaces -- memory-compress, error-pattern-check, error-summary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire memory-compress into continue.md (CLEAN-02)</name>
  <files>.claude/commands/ant/continue.md</files>
  <action>
In continue.md Step 4 (Extract Phase Learnings), replace the manual array truncation logic with a memory-compress call.

**Find** (lines 111-113):
```markdown
If the `phase_learnings` array exceeds 20 entries, remove the oldest entries to keep only 20.

Use the Write tool to write the updated memory.json.
```

**Replace with:**
```markdown
Use the Write tool to write the updated memory.json.

Then use the Bash tool to run:
```
bash .aether/aether-utils.sh memory-compress
```

This enforces retention limits (phase_learnings <= 20, decisions <= 30) and compresses if over token threshold. Returns `{"ok":true,"result":{"compressed":true,"tokens":N}}`.

If the command fails, the Write tool already saved the data -- no action needed.
```

**Critical: Do NOT touch** the events.json truncation on line 169 ("If the `events` array exceeds 100 entries..."). That is separate from memory-compress and must remain as manual truncation.

**Also do NOT modify:**
- Step 4.5 (Auto-Emit Pheromones)
- Step 5 (Clean Expired Pheromones -- already uses pheromone-cleanup)
- Any other step in continue.md
  </action>
  <verify>
Verify memory-compress call exists:
```
grep -c "aether-utils.sh memory-compress" .claude/commands/ant/continue.md
```
Expected: 1

Verify manual truncation logic is gone:
```
grep -c "exceeds 20 entries" .claude/commands/ant/continue.md
```
Expected: 0

Verify events.json truncation is preserved:
```
grep -c "exceeds 100 entries" .claude/commands/ant/continue.md
```
Expected: >= 1 (events.json truncation still present)
  </verify>
  <done>continue.md calls memory-compress for array truncation. Manual "exceeds 20 entries" logic removed. Events.json truncation preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Wire error-pattern-check and error-summary into build.md and continue.md (CLEAN-03, CLEAN-04)</name>
  <files>
    .claude/commands/ant/build.md
    .claude/commands/ant/continue.md
  </files>
  <action>
**CLEAN-03: Replace manual error categorization in build.md Step 6.**

Find the "Check Pattern Flagging" section (lines 274-288):
```markdown
**Check Pattern Flagging:** Count errors in the `errors` array by `category`. If any category has 3 or more errors and is not already in `flagged_patterns`, add:

{JSON block for flagged pattern}

If the category already exists in `flagged_patterns`, update its `count`, `last_seen`, and `description`.
```

Replace the "Count errors in the `errors` array by `category`. If any category has 3 or more errors" manual logic with an error-pattern-check call:
```markdown
**Check Pattern Flagging:** Use the Bash tool to run:
```
bash .aether/aether-utils.sh error-pattern-check
```

This returns JSON: `{"ok":true,"result":[{"category":"...","count":N,"first_seen":"...","last_seen":"..."},...]}`

For each category in the result that is not already in `flagged_patterns`, add:
```

Keep the JSON template block for `flagged_patterns` entries that follows -- just change the source from manual counting to the error-pattern-check result. Keep the "If the category already exists" update logic.

**Do NOT touch** the `error-add` Bash calls above this section (lines 249-260). Those are already wired and must remain.

**CLEAN-04a: Wire error-summary into continue.md Step 3.**

Find the manual error counting section in Step 3 (lines 56-70):
```markdown
  Errors:
    <count> errors encountered
    (list severity counts: N critical, N high, N medium, N low)
...
Get error data from `errors.json` -- filter the `errors` array by `phase` field matching the current phase number. Count by severity level.
```

Replace the manual counting instruction with an error-summary call:
```markdown
  Errors:
    <count> errors encountered
    (list severity counts: N critical, N high, N medium, N low)

Use the Bash tool to run:
```
bash .aether/aether-utils.sh error-summary
```

This returns JSON: `{"ok":true,"result":{"total":N,"by_category":{...},"by_severity":{...}}}`. Use the `by_severity` counts for the display above.

For phase-specific error counts, also filter `errors.json` entries where `phase` matches the current phase number.

If the command fails, fall back to showing "Errors: Unable to compute".
```

Note: error-summary returns global totals. The phase-specific filtering instruction is kept as a manual supplement because the utility does not support phase filtering.

**CLEAN-04b: Wire error-summary into build.md Step 6.**

After the error-add calls and pattern flagging in Step 6, add an error-summary call to provide structured counts for Step 7 display. Insert before the "Write the updated errors.json" instruction:

```markdown
**Get Error Summary:** Use the Bash tool to run:
```
bash .aether/aether-utils.sh error-summary
```

This returns JSON: `{"ok":true,"result":{"total":N,"by_category":{...},"by_severity":{...}}}`. Use these counts for the issue summary in Step 7 display.

If the command fails, derive counts manually from the errors.json data already in memory.
```

**Anti-patterns to avoid:**
- Do NOT delete the error-add calls in build.md. Only the pattern-flagging counting and the display counting are replaced.
- Do NOT remove the events.json truncation in continue.md.
- Do NOT change the display format templates -- only change where the data comes from.
  </action>
  <verify>
Verify error-pattern-check call in build.md:
```
grep -c "aether-utils.sh error-pattern-check" .claude/commands/ant/build.md
```
Expected: 1

Verify error-summary call in continue.md:
```
grep -c "aether-utils.sh error-summary" .claude/commands/ant/continue.md
```
Expected: 1

Verify error-summary call in build.md:
```
grep -c "aether-utils.sh error-summary" .claude/commands/ant/build.md
```
Expected: 1

Verify error-add calls still present in build.md:
```
grep -c "aether-utils.sh error-add" .claude/commands/ant/build.md
```
Expected: >= 2 (error-add calls preserved)

Verify manual "Count errors" pattern is gone from build.md:
```
grep -c "Count errors in the" .claude/commands/ant/build.md
```
Expected: 0

Verify manual "Count by severity" pattern is gone from continue.md:
```
grep -c "Count by severity level" .claude/commands/ant/continue.md
```
Expected: 0
  </verify>
  <done>build.md calls error-pattern-check for pattern flagging and error-summary for counts. continue.md calls error-summary for severity counts. All error-add calls preserved. Display format unchanged.</done>
</task>

</tasks>

<verification>
1. continue.md has memory-compress call: `grep "aether-utils.sh memory-compress" .claude/commands/ant/continue.md` returns match
2. continue.md has error-summary call: `grep "aether-utils.sh error-summary" .claude/commands/ant/continue.md` returns match
3. build.md has error-pattern-check call: `grep "aether-utils.sh error-pattern-check" .claude/commands/ant/build.md` returns match
4. build.md has error-summary call: `grep "aether-utils.sh error-summary" .claude/commands/ant/build.md` returns match
5. build.md error-add calls preserved: `grep -c "aether-utils.sh error-add" .claude/commands/ant/build.md` >= 2
6. continue.md events.json truncation preserved: `grep "exceeds 100 entries" .claude/commands/ant/continue.md` returns match
7. No manual inline formulas remain: `grep "Count errors in the" .claude/commands/ant/build.md` returns 0 matches
</verification>

<success_criteria>
- CLEAN-02 satisfied: continue.md calls memory-compress instead of manual truncation
- CLEAN-03 satisfied: build.md calls error-pattern-check instead of manual categorization
- CLEAN-04 satisfied: continue.md and build.md both call error-summary instead of manual counting
- No regressions: error-add calls preserved, events.json truncation preserved, display formats unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/22-cleanup/22-02-SUMMARY.md`
</output>
