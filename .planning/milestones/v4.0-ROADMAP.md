# Milestone v4.0: Hybrid Foundation

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 19-21
**Total Plans:** 9

## Overview

Add a thin shell utility layer for deterministic operations and fix all 11 audit-identified issues. The system becomes hybrid: prompts reason and decide, shell scripts compute and validate. This makes pheromone math, state validation, memory management, and error tracking reliable instead of LLM-approximated.

## Phases

### Phase 19: Audit Fixes + Utility Scaffold

**Goal**: The existing system is stable and correct -- all audit issues are resolved, state fields are canonical, and the utility script scaffold is ready for module implementation.
**Depends on**: Phase 17 (v3.0 complete)
**Plans**: 3 plans

Plans:
- [x] 19-01: Canonicalize v3 state schema and verify command field paths
- [x] 19-02: Harden atomic-write backup dir/rotation, add pheromone cleanup and validation guidance
- [x] 19-03: Create aether-utils.sh scaffold and document colony system

**Details:**
- Committed canonical v3 flat-schema state files (COLONY_STATE.json + pheromones.json)
- Fixed continue.md auto-emit pheromone templates (emitted_at -> created_at, added id fields)
- Fixed backup directory (.aether/backups/ -> .aether/data/backups/) and rotation limit (5 -> 3)
- Added lazy pheromone garbage collection on status reads
- Created aether-utils.sh scaffold with subcommand dispatch, JSON output helpers
- Documented colony lifecycle and pheromone system in ant.md and init.md
- Resolved all 11 audit fixes (FIX-01 through FIX-11)

---

### Phase 20: Utility Modules

**Goal**: All deterministic operations that LLMs get wrong -- pheromone decay math, state schema validation, memory token management, and error pattern detection -- are handled by shell functions that produce correct, reproducible results.
**Depends on**: Phase 19
**Plans**: 4 plans

Plans:
- [x] 20-01: Pheromone math (decay, effective, batch, cleanup, combine)
- [x] 20-02: State validation (colony, pheromones, errors, memory, events, all)
- [x] 20-03: Memory operations (token-count, compress, search)
- [x] 20-04: Error tracking (add, pattern-check, summary, dedup)

**Details:**
- 18 total subcommands implemented in 241 lines of bash+jq
- Exponential decay formula verified: 1 half-life yields exactly 0.5
- jq-based schema validation for all 5 JSON state files
- Token approximation via word count × 1.3 with two-pass compression
- Error pattern detection (3+ occurrences), deduplication (60s window)
- All 18 subcommands verified end-to-end with valid JSON output

---

### Phase 21: Command Integration

**Goal**: Command prompts delegate deterministic operations to aether-utils.sh instead of asking the LLM to compute them -- pheromone decay, error logging, state validation, and cleanup happen via shell calls that produce reliable results.
**Depends on**: Phase 20
**Plans**: 2 plans

Plans:
- [x] 21-01: Integrate pheromone-batch, pheromone-cleanup, error-add, and validate-state into core commands
- [x] 21-02: Replace inline pheromone math with pheromone-effective in all 6 worker specs

**Details:**
- status.md delegates pheromone decay to pheromone-batch, cleanup to pheromone-cleanup
- build.md delegates pheromone decay to pheromone-batch, error logging to error-add
- continue.md delegates pheromone cleanup to pheromone-cleanup
- init.md validates all state files via validate-state all after initialization
- All 6 worker specs use pheromone-effective for deterministic signal computation

---

## Milestone Summary

**Key Decisions:**
- Hybrid architecture: prompts for reasoning, shell for deterministic ops
- Single wrapper script (aether-utils.sh) with subcommand dispatch
- All subcommands output JSON to stdout for prompt consumption
- Total utility code stays under 300 lines (delivered at 241)
- Fix all 11 audit issues before building new modules
- Pattern flagging stays inline in build.md (LLM responsibility)
- validate-state inserted as Step 6.5 in init.md

**Issues Resolved:**
- file-lock.sh dependency chain broken (FIX-01)
- 3 "goal" fields and 2 "current_phase" fields consolidated to single canonical paths (FIX-02, FIX-03)
- Race conditions from temp file creation (FIX-04)
- Silent jq failures (FIX-05)
- Missing state file backups (FIX-06)
- Pheromone schema field name mismatches (FIX-07)
- No state integrity validation on load (FIX-08)
- Inconsistent worker status casing (FIX-09)
- No expired pheromone cleanup (FIX-10)
- Colony mode undocumented (FIX-11)

**Issues Deferred:**
- 8 orphaned subcommands with no current consumers (pheromone-decay, pheromone-combine, memory-token-count, memory-compress, memory-search, error-pattern-check, error-summary, error-dedup)
- 4 commands retain inline decay formulas (plan.md, pause-colony.md, resume-colony.md, colonize.md)
- Double-source of file-lock.sh (harmless but wasteful)

**Technical Debt Incurred:**
- Orphaned subcommands are functional infrastructure waiting for integration
- Inline LLM duplicates of memory-compress and error-pattern-check in continue.md and build.md
- 4 non-core commands still compute pheromone decay inline instead of delegating

---

_For current project status, see .planning/ROADMAP.md_
