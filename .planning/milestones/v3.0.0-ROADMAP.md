# Milestone v3.0.0: Bug Fixes & Update System Repair

**Status:** ✅ SHIPPED 2026-02-14
**Phases:** 6-8
**Total Plans:** 14

## Overview

Critical bug fixes and reliability improvements for the v1.0 infrastructure. This milestone addresses five critical bugs discovered during v1.0 usage: phase advancement loops wasting compute, overly broad git checkpoints risking user data loss (documented near-loss of 1,145 lines), missing deterministic builds, and misleading output timing from background task execution.

The approach prioritizes infrastructure hardening over feature additions — fix the foundation before building higher.

## Phases

### Phase 6: Foundation — Safe Checkpoints & Testing Infrastructure

**Goal**: Establish safe checkpoint system that never captures user data, and build testing infrastructure for deterministic verification
**Depends on**: None (foundation phase)
**Plans**: 6 plans in 3 waves

Plans:

- [x] 06-01: Install test dependencies (sinon + proxyquire) and create mock-fs helper
- [x] 06-02: Implement safe checkpoint command with create/list/restore/verify
- [x] 06-03: Create unit tests for hashFileSync function
- [x] 06-04: Create unit tests for generateManifest and validateManifest
- [x] 06-05: Create unit tests for syncDirWithCleanup with idempotency tests
- [x] 06-06: Commit package-lock.json and verify checkpoint system end-to-end

**Details:**

Requirements:
| ID | Requirement |
|----|-------------|
| SAFE-01 | Git checkpoint system only captures Aether-managed files (never user data) |
| SAFE-02 | Explicit allowlist for checkpoint files |
| SAFE-03 | User data explicitly excluded: TO-DOs.md, .aether/data/, .aether/dreams/, .aether/oracle/ |
| SAFE-04 | Checkpoint metadata includes file hashes for integrity verification |
| TEST-01 | package-lock.json committed for deterministic builds |
| TEST-02 | Unit tests for syncDirWithCleanup function |
| TEST-03 | Unit tests for hashFileSync function |
| TEST-04 | Unit tests for generateManifest function |
| TEST-05 | Mock filesystem using sinon + proxyquire |
| TEST-06 | Idempotency property tests for sync operations |

Status: Complete ✓
Completed: 2026-02-14
Verification: 06-VERIFICATION.md (10/10 must-haves verified)

---

### Phase 7: Core Reliability — State Guards & Update System

**Goal**: Prevent phase advancement loops and implement reliable cross-repo synchronization with automatic rollback
**Depends on**: Phase 6 (requires safe checkpoint system for rollback capability, testing infrastructure for verification)
**Plans**: 6 plans in 3 waves

Plans:

- [x] 07-01: FileLock class with stale detection
- [x] 07-02: Iron Law Enforcement: StateGuard class with evidence validation
- [x] 07-03: Audit trail system with event sourcing
- [x] 07-04: Two-Phase Commit for Updates: UpdateTransaction with rollback
- [x] 07-05: Error handling improvements for dirty repos, network failures, partial updates
- [x] 07-06: Initialization & Integration: New repo init, integration tests, E2E test

**Wave Structure:**
- Wave 1: 07-01, 07-02 (parallel - independent foundations)
- Wave 2: 07-03, 07-04 (parallel - depends on Wave 1)
- Wave 3: 07-05, 07-06 (parallel - depends on Wave 2)

**Details:**

Requirements:
| ID | Requirement |
|----|-------------|
| STATE-01 | Phase advancement requires fresh verification evidence (Iron Law enforcement) |
| STATE-02 | Idempotency check prevents re-building already-completed phases |
| STATE-03 | State lock acquired during phase transitions (prevents concurrent modification) |
| STATE-04 | Phase transition audit trail in COLONY_STATE.json events |
| UPDATE-01 | Update command uses safe checkpoint before file sync |
| UPDATE-02 | Two-phase commit: backup → sync → verify → update version |
| UPDATE-03 | Automatic rollback on sync failure |
| UPDATE-04 | Stash recovery commands displayed prominently on failure |
| UPDATE-05 | Better error handling for dirty repos, network failures, partial updates |
| INIT-01 | `aether init` copies system files from hub to repo |
| INIT-02 | `aether init` registers repo in global registry for `update --all` |
| INIT-03 | `aether init` creates version.json with hub version |

Status: Complete ✓
Completed: 2026-02-14
Verification: 07-VERIFICATION.md (12/12 must-haves verified)

---

### Phase 8: Build Polish — Output Timing & Integration

**Goal**: Fix misleading output timing and verify all fixes work together through integration testing
**Depends on**: Phase 7 (requires state management fixes to be in place for integration)
**Plans**: 2 plans in 2 waves

Plans:

- [x] 08-01: Fix build.md timing: Remove run_in_background from worker spawns
- [x] 08-02: Integration testing: E2E test for checkpoint → update → build workflow

**Wave Structure:**
- Wave 1: 08-01 (build timing fix)
- Wave 2: 08-02 (integration testing - depends on Wave 1)

**Details:**

Requirements:
| ID | Requirement |
|----|-------------|
| BUILD-01 | Remove run_in_background from build.md worker spawns |
| BUILD-02 | Output timing fixed — summary displays after all agent notifications complete |
| BUILD-03 | Foreground Task calls with blocking TaskOutput collection |

Status: Complete ✓
Completed: 2026-02-14
Verification: 08-VERIFICATION.md (8/8 must-haves verified)

---

## Milestone Summary

**Key Decisions:**

- Checkpoint allowlist approach — Never risk user data; explicit allowlist vs dangerous blocklist
- sinon + proxyquire for testing — Industry standard, enables mocking fs module for cli.js tests
- Iron Law requires fresh verification evidence — checkpoint_hash, test_results, timestamp all required
- Four-phase update with explicit state tracking — preparing → syncing → verifying → committing
- Foreground Task execution for build workers — Removes misleading output timing
- Init copies from hub and auto-registers — Ensures repos are ready for update --all

**Issues Resolved:**

- Fixed context overflow at 100+ phases (decimal phase numbering)
- Fixed phase advancement loops (Iron Law enforcement)
- Fixed data loss risk from git stash (explicit allowlist)
- Fixed misleading build output timing (foreground execution)
- Fixed update system reliability (two-phase commit with rollback)
- Fixed init not copying system files (now syncs from hub + registers)

**Issues Deferred:**

- Version-aware update notifications (NOTIFY-01) — defer to v1.2
- Checkpoint recovery tracking (RECOVER-01) — defer to v1.2
- Update metrics (METRICS-01) — defer to v1.2

**Technical Debt Incurred:**

- 4 pre-existing test failures in validate-state tests (unrelated to v3.0.0)

---

_For current project status, see .planning/PROJECT.md_
