# Requirements Archive: v4.0 Hybrid Foundation

**Archived:** 2026-02-03
**Status:** ✅ SHIPPED

This is the archived requirements specification for v4.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v4.0 Requirements

Requirements for adding a thin shell utility layer and fixing all audit-identified issues. The system becomes hybrid: prompts for reasoning, shell for deterministic operations.

### Utility Layer

- [x] **UTIL-01**: `aether-utils.sh` exists as a single entry point with subcommand dispatch
- [x] **UTIL-02**: Utility script sources `file-lock.sh` and `atomic-write.sh` for shared infrastructure
- [x] **UTIL-03**: All subcommands output JSON to stdout for prompt consumption
- [x] **UTIL-04**: All subcommands return non-zero exit code on error with JSON error message

### Pheromone Math

- [x] **PHER-01**: `pheromone-decay` computes current strength using exponential decay formula
- [x] **PHER-02**: `pheromone-effective` computes effective signal (sensitivity × strength)
- [x] **PHER-03**: `pheromone-batch` reads pheromones.json and outputs all signals with current computed strengths
- [x] **PHER-04**: `pheromone-cleanup` removes expired signals (strength < 0.05) from pheromones.json
- [x] **PHER-05**: `pheromone-combine` computes combination effect for conflicting signals

### State Validation

- [x] **VALID-01**: `validate-state colony` validates COLONY_STATE.json against expected schema
- [x] **VALID-02**: `validate-state pheromones` validates pheromones.json
- [x] **VALID-03**: `validate-state errors` validates errors.json
- [x] **VALID-04**: `validate-state memory` validates memory.json
- [x] **VALID-05**: `validate-state events` validates events.json
- [x] **VALID-06**: `validate-state all` runs all validators and reports aggregate pass/fail

### Memory Operations

- [x] **MEM-01**: `memory-token-count` approximates token count of memory.json
- [x] **MEM-02**: `memory-compress` removes oldest entries when token count exceeds threshold
- [x] **MEM-03**: `memory-search` finds memory entries matching keyword across all arrays

### Error Tracking

- [x] **ERR-01**: `error-add` appends error with timestamp and auto-increment ID
- [x] **ERR-02**: `error-pattern-check` detects categories with 3+ occurrences
- [x] **ERR-03**: `error-summary` outputs counts by category and severity
- [x] **ERR-04**: `error-dedup` removes duplicate errors within 60 seconds

### Audit Fixes — Critical

- [x] **FIX-01**: atomic-write.sh sources file-lock.sh so acquire_lock/release_lock are available
- [x] **FIX-02**: COLONY_STATE.json uses single canonical path for goal and current_phase
- [x] **FIX-03**: All commands read/write using canonical field paths consistently

### Audit Fixes — High Priority

- [x] **FIX-04**: Temp files use unique suffixes (PID + timestamp)
- [x] **FIX-05**: All jq operations check exit code and report errors
- [x] **FIX-06**: State file backups created before critical updates (rotate last 3)
- [x] **FIX-07**: Pheromone schema uses consistent field names
- [x] **FIX-08**: State files validated on load

### Audit Fixes — Medium Priority

- [x] **FIX-09**: Worker ant status uses consistent casing
- [x] **FIX-10**: Expired pheromones cleaned up automatically
- [x] **FIX-11**: Colony mode documented in init.md and ant.md help text

### Command Integration

- [x] **INT-01**: status.md calls `aether-utils pheromone-batch` for decay bar rendering
- [x] **INT-02**: build.md calls `aether-utils error-add` when logging errors
- [x] **INT-03**: continue.md calls `aether-utils pheromone-cleanup` at phase boundaries
- [x] **INT-04**: Worker specs document `aether-utils pheromone-effective` for signal computation
- [x] **INT-05**: init.md calls `aether-utils validate-state all` after state file creation

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| UTIL-01 through UTIL-04 | Phase 19 | Complete |
| FIX-01 through FIX-11 | Phase 19 | Complete |
| PHER-01 through PHER-05 | Phase 20 | Complete |
| VALID-01 through VALID-06 | Phase 20 | Complete |
| MEM-01 through MEM-03 | Phase 20 | Complete |
| ERR-01 through ERR-04 | Phase 20 | Complete |
| INT-01 through INT-05 | Phase 21 | Complete |

**Coverage:** 38/38 requirements satisfied

---

## Milestone Summary

**Shipped:** 38 of 38 v4.0 requirements
**Adjusted:** None — all requirements delivered as specified
**Dropped:** None

**Deferred to v4.x:**
- ADV-01: spawn-recommend (Bayesian analysis)
- ADV-02: context-budget (token usage tracking)
- ADV-03: state-diff (state change tracking)
- ADV-04: pheromone-simulate (strength projection)

---
*Archived: 2026-02-03 as part of v4.0 milestone completion*
